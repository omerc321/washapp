{"file_contents":{"client/src/components/ui/command.tsx":{"content":"import * as React from \"react\"\nimport { type DialogProps } from \"@radix-ui/react-dialog\"\nimport { Command as CommandPrimitive } from \"cmdk\"\nimport { Search } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Dialog, DialogContent } from \"@/components/ui/dialog\"\n\nconst Command = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nCommand.displayName = CommandPrimitive.displayName\n\nconst CommandDialog = ({ children, ...props }: DialogProps) => {\n  return (\n    <Dialog {...props}>\n      <DialogContent className=\"overflow-hidden p-0 shadow-lg\">\n        <Command className=\"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5\">\n          {children}\n        </Command>\n      </DialogContent>\n    </Dialog>\n  )\n}\n\nconst CommandInput = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Input>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>\n>(({ className, ...props }, ref) => (\n  <div className=\"flex items-center border-b px-3\" cmdk-input-wrapper=\"\">\n    <Search className=\"mr-2 h-4 w-4 shrink-0 opacity-50\" />\n    <CommandPrimitive.Input\n      ref={ref}\n      className={cn(\n        \"flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    />\n  </div>\n))\n\nCommandInput.displayName = CommandPrimitive.Input.displayName\n\nconst CommandList = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.List\n    ref={ref}\n    className={cn(\"max-h-[300px] overflow-y-auto overflow-x-hidden\", className)}\n    {...props}\n  />\n))\n\nCommandList.displayName = CommandPrimitive.List.displayName\n\nconst CommandEmpty = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Empty>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>\n>((props, ref) => (\n  <CommandPrimitive.Empty\n    ref={ref}\n    className=\"py-6 text-center text-sm\"\n    {...props}\n  />\n))\n\nCommandEmpty.displayName = CommandPrimitive.Empty.displayName\n\nconst CommandGroup = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Group>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Group\n    ref={ref}\n    className={cn(\n      \"overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandGroup.displayName = CommandPrimitive.Group.displayName\n\nconst CommandSeparator = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nCommandSeparator.displayName = CommandPrimitive.Separator.displayName\n\nconst CommandItem = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandItem.displayName = CommandPrimitive.Item.displayName\n\nconst CommandShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nCommandShortcut.displayName = \"CommandShortcut\"\n\nexport {\n  Command,\n  CommandDialog,\n  CommandInput,\n  CommandList,\n  CommandEmpty,\n  CommandGroup,\n  CommandItem,\n  CommandShortcut,\n  CommandSeparator,\n}\n","path":null,"size_bytes":4885,"size_tokens":null},"client/src/components/ui/skeleton.tsx":{"content":"import { cn } from \"@/lib/utils\"\n\nfunction Skeleton({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) {\n  return (\n    <div\n      className={cn(\"animate-pulse rounded-md bg-muted\", className)}\n      {...props}\n    />\n  )\n}\n\nexport { Skeleton }\n","path":null,"size_bytes":261,"size_tokens":null},"client/src/components/ui/dialog.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as DialogPrimitive from \"@radix-ui/react-dialog\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Dialog = DialogPrimitive.Root\n\nconst DialogTrigger = DialogPrimitive.Trigger\n\nconst DialogPortal = DialogPrimitive.Portal\n\nconst DialogClose = DialogPrimitive.Close\n\nconst DialogOverlay = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Overlay\n    ref={ref}\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogOverlay.displayName = DialogPrimitive.Overlay.displayName\n\nconst DialogContent = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DialogPortal>\n    <DialogOverlay />\n    <DialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <DialogPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </DialogPrimitive.Close>\n    </DialogPrimitive.Content>\n  </DialogPortal>\n))\nDialogContent.displayName = DialogPrimitive.Content.displayName\n\nconst DialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-1.5 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogHeader.displayName = \"DialogHeader\"\n\nconst DialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogFooter.displayName = \"DialogFooter\"\n\nconst DialogTitle = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogTitle.displayName = DialogPrimitive.Title.displayName\n\nconst DialogDescription = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDialogDescription.displayName = DialogPrimitive.Description.displayName\n\nexport {\n  Dialog,\n  DialogPortal,\n  DialogOverlay,\n  DialogClose,\n  DialogTrigger,\n  DialogContent,\n  DialogHeader,\n  DialogFooter,\n  DialogTitle,\n  DialogDescription,\n}\n","path":null,"size_bytes":3848,"size_tokens":null},"client/src/components/ui/textarea.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Textarea = React.forwardRef<\n  HTMLTextAreaElement,\n  React.ComponentProps<\"textarea\">\n>(({ className, ...props }, ref) => {\n  return (\n    <textarea\n      className={cn(\n        \"flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  )\n})\nTextarea.displayName = \"Textarea\"\n\nexport { Textarea }\n","path":null,"size_bytes":689,"size_tokens":null},"client/src/components/theme-toggle.tsx":{"content":"import { Moon, Sun } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { useTheme } from \"./theme-provider\";\n\nexport function ThemeToggle() {\n  const { theme, toggleTheme } = useTheme();\n\n  return (\n    <Button\n      variant=\"ghost\"\n      size=\"icon\"\n      onClick={toggleTheme}\n      data-testid=\"button-theme-toggle\"\n    >\n      {theme === \"light\" ? (\n        <Moon className=\"h-5 w-5\" />\n      ) : (\n        <Sun className=\"h-5 w-5\" />\n      )}\n    </Button>\n  );\n}\n","path":null,"size_bytes":496,"size_tokens":null},"vite.config.ts":{"content":"import { defineConfig } from \"vite\";\nimport react from \"@vitejs/plugin-react\";\nimport path from \"path\";\nimport runtimeErrorOverlay from \"@replit/vite-plugin-runtime-error-modal\";\n\nexport default defineConfig({\n  plugins: [\n    react(),\n    runtimeErrorOverlay(),\n    ...(process.env.NODE_ENV !== \"production\" &&\n    process.env.REPL_ID !== undefined\n      ? [\n          await import(\"@replit/vite-plugin-cartographer\").then((m) =>\n            m.cartographer(),\n          ),\n          await import(\"@replit/vite-plugin-dev-banner\").then((m) =>\n            m.devBanner(),\n          ),\n        ]\n      : []),\n  ],\n  resolve: {\n    alias: {\n      \"@\": path.resolve(import.meta.dirname, \"client\", \"src\"),\n      \"@shared\": path.resolve(import.meta.dirname, \"shared\"),\n      \"@assets\": path.resolve(import.meta.dirname, \"attached_assets\"),\n    },\n  },\n  root: path.resolve(import.meta.dirname, \"client\"),\n  build: {\n    outDir: path.resolve(import.meta.dirname, \"dist/public\"),\n    emptyOutDir: true,\n  },\n  server: {\n    fs: {\n      strict: true,\n      deny: [\"**/.*\"],\n    },\n  },\n});\n","path":null,"size_bytes":1080,"size_tokens":null},"client/src/main.tsx":{"content":"import { createRoot } from \"react-dom/client\";\nimport App from \"./App\";\nimport \"./index.css\";\nimport { initNotificationSoundListener } from \"./lib/notification-sound\";\n\nif ('serviceWorker' in navigator) {\n  window.addEventListener('load', () => {\n    navigator.serviceWorker.register('/sw.js')\n      .then((registration) => {\n        console.log('SW registered:', registration);\n        initNotificationSoundListener();\n      })\n      .catch((error) => {\n        console.log('SW registration failed:', error);\n      });\n  });\n}\n\ncreateRoot(document.getElementById(\"root\")!).render(<App />);\n","path":null,"size_bytes":591,"size_tokens":null},"client/src/pages/login.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Button } from \"@/components/ui/button\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { Loader2 } from \"lucide-react\";\nimport logoUrl from \"@assets/IMG_2508_1762619079711.png\";\n\nexport default function LoginPage() {\n  const { signIn, loading, currentUser } = useAuth();\n  const [, setLocation] = useLocation();\n  const [formData, setFormData] = useState({ email: \"\", password: \"\" });\n  const [submitting, setSubmitting] = useState(false);\n\n  // Redirect based on user role after successful login\n  useEffect(() => {\n    if (currentUser) {\n      switch (currentUser.role) {\n        case \"cleaner\":\n          setLocation(\"/cleaner\");\n          break;\n        case \"company_admin\":\n          setLocation(\"/company\");\n          break;\n        case \"admin\":\n          setLocation(\"/admin\");\n          break;\n        default:\n          setLocation(\"/customer\");\n      }\n    }\n  }, [currentUser, setLocation]);\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    setSubmitting(true);\n    \n    try {\n      await signIn(formData.email, formData.password);\n      // Navigation handled by auth state change\n    } catch (error) {\n      // Error shown by toast in auth context\n    } finally {\n      setSubmitting(false);\n    }\n  };\n\n  if (loading) {\n    return (\n      <div className=\"h-screen flex items-center justify-center bg-background\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-background flex items-center justify-center p-4\">\n      <Card className=\"w-full max-w-md\">\n        <CardHeader className=\"text-center space-y-2\">\n          <div className=\"flex items-center justify-center mb-4\">\n            <img src={logoUrl} alt=\"Washapp.ae\" className=\"h-24 w-auto\" data-testid=\"img-logo\" />\n          </div>\n          <CardDescription className=\"text-base\">\n            Sign in to access your dashboard\n          </CardDescription>\n        </CardHeader>\n        <form onSubmit={handleSubmit}>\n          <CardContent className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"email\">Email</Label>\n              <Input\n                id=\"email\"\n                type=\"email\"\n                placeholder=\"your@email.com\"\n                value={formData.email}\n                onChange={(e) => setFormData({ ...formData, email: e.target.value })}\n                required\n                data-testid=\"input-email\"\n              />\n            </div>\n            \n            <div className=\"space-y-2\">\n              <div className=\"flex items-center justify-between\">\n                <Label htmlFor=\"password\">Password</Label>\n                <button\n                  type=\"button\"\n                  className=\"text-xs text-primary hover:underline\"\n                  onClick={() => setLocation(\"/forgot-password\")}\n                  data-testid=\"link-forgot-password\"\n                >\n                  Forgot password?\n                </button>\n              </div>\n              <Input\n                id=\"password\"\n                type=\"password\"\n                placeholder=\"••••••••\"\n                value={formData.password}\n                onChange={(e) => setFormData({ ...formData, password: e.target.value })}\n                required\n                data-testid=\"input-password\"\n              />\n            </div>\n          </CardContent>\n          \n          <CardFooter className=\"flex flex-col gap-4\">\n            <Button\n              type=\"submit\"\n              className=\"w-full\"\n              size=\"lg\"\n              disabled={submitting}\n              data-testid=\"button-signin\"\n            >\n              {submitting ? (\n                <>\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                  Signing in...\n                </>\n              ) : (\n                \"Sign In\"\n              )}\n            </Button>\n            \n            <div className=\"text-center text-sm space-y-2\">\n              <Button\n                type=\"button\"\n                variant=\"ghost\"\n                className=\"text-muted-foreground p-0\"\n                onClick={() => setLocation(\"/register/cleaner\")}\n                data-testid=\"link-register-cleaner\"\n              >\n                Register as Cleaner\n              </Button>\n              <span className=\"text-muted-foreground mx-2\">|</span>\n              <Button\n                type=\"button\"\n                variant=\"ghost\"\n                className=\"text-muted-foreground p-0\"\n                onClick={() => setLocation(\"/register/company\")}\n                data-testid=\"link-register-company\"\n              >\n                Register Company\n              </Button>\n            </div>\n            \n            <Button\n              type=\"button\"\n              variant=\"ghost\"\n              onClick={() => setLocation(\"/\")}\n              data-testid=\"button-back-home\"\n            >\n              Back to Home\n            </Button>\n          </CardFooter>\n        </form>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":5376,"size_tokens":null},"client/src/hooks/use-mobile.tsx":{"content":"import * as React from \"react\"\n\nconst MOBILE_BREAKPOINT = 768\n\nexport function useIsMobile() {\n  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)\n\n  React.useEffect(() => {\n    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)\n    const onChange = () => {\n      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    }\n    mql.addEventListener(\"change\", onChange)\n    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    return () => mql.removeEventListener(\"change\", onChange)\n  }, [])\n\n  return !!isMobile\n}\n","path":null,"size_bytes":565,"size_tokens":null},"client/src/components/ui/hover-card.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as HoverCardPrimitive from \"@radix-ui/react-hover-card\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst HoverCard = HoverCardPrimitive.Root\n\nconst HoverCardTrigger = HoverCardPrimitive.Trigger\n\nconst HoverCardContent = React.forwardRef<\n  React.ElementRef<typeof HoverCardPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof HoverCardPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <HoverCardPrimitive.Content\n    ref={ref}\n    align={align}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 w-64 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-hover-card-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nHoverCardContent.displayName = HoverCardPrimitive.Content.displayName\n\nexport { HoverCard, HoverCardTrigger, HoverCardContent }\n","path":null,"size_bytes":1251,"size_tokens":null},"client/src/App.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { Switch, Route, Redirect } from \"wouter\";\nimport { queryClient } from \"./lib/queryClient\";\nimport { QueryClientProvider } from \"@tanstack/react-query\";\nimport { Toaster } from \"@/components/ui/toaster\";\nimport { TooltipProvider } from \"@/components/ui/tooltip\";\nimport { AuthProvider, useAuth } from \"@/lib/auth-context\";\nimport { ThemeProvider } from \"@/components/theme-provider\";\nimport { ThemeToggle } from \"@/components/theme-toggle\";\nimport { BottomNav } from \"@/components/bottom-nav\";\nimport { Footer } from \"@/components/footer\";\nimport { PWAInstallPrompt } from \"@/components/pwa-install-prompt\";\nimport { SplashScreen } from \"@/components/splash-screen\";\nimport NotFound from \"@/pages/not-found\";\nimport LoginPage from \"@/pages/login\";\nimport ForgotPasswordPage from \"@/pages/forgot-password\";\nimport ResetPasswordPage from \"@/pages/reset-password\";\nimport RegisterCleanerPage from \"@/pages/register-cleaner\";\nimport RegisterCompanyPage from \"@/pages/register-company\";\nimport RegisterAdminPage from \"@/pages/register-admin\";\nimport CustomerHome from \"@/pages/customer-home\";\nimport CustomerBooking from \"@/pages/customer-booking\";\nimport CustomerQRPayment from \"@/pages/customer-qr-payment\";\nimport SelectCompany from \"@/pages/select-company\";\nimport Checkout from \"@/pages/checkout\";\nimport CustomerJobs from \"@/pages/customer-jobs\";\nimport CustomerTrack from \"@/pages/customer-track\";\nimport CustomerComplaint from \"@/pages/customer-complaint\";\nimport CleanerDashboard from \"@/pages/cleaner-dashboard\";\nimport CleanerShiftHistory from \"@/pages/cleaner-shift-history\";\nimport CleanerTips from \"@/pages/cleaner-tips\";\nimport AdminDashboard from \"@/pages/admin-dashboard\";\nimport AdminSettings from \"@/pages/admin-settings\";\nimport AdminComplaints from \"@/pages/admin-complaints\";\nimport CompanyDashboard from \"@/pages/company-dashboard\";\nimport CompanyFinancials from \"@/pages/company-financials\";\nimport CompanyLiveReport from \"@/pages/company-live-report\";\nimport CompanyShiftHistory from \"@/pages/company-shift-history\";\nimport CompanyComplaints from \"@/pages/company-complaints\";\nimport CompanyOfflineJobs from \"@/pages/company-offline-jobs\";\nimport About from \"@/pages/about\";\nimport Terms from \"@/pages/terms\";\nimport Privacy from \"@/pages/privacy\";\nimport { UserRole } from \"@shared/schema\";\n\nfunction ProtectedRoute({ \n  component: Component, \n  allowedRoles \n}: { \n  component: React.ComponentType; \n  allowedRoles?: UserRole[] \n}) {\n  const { currentUser, loading } = useAuth();\n\n  if (loading) {\n    return (\n      <div className=\"h-screen flex items-center justify-center\">\n        <div className=\"animate-spin w-8 h-8 border-4 border-primary border-t-transparent rounded-full\" aria-label=\"Loading\"/>\n      </div>\n    );\n  }\n\n  if (!currentUser) {\n    return <Redirect to=\"/login\" />;\n  }\n\n  if (allowedRoles && !allowedRoles.includes(currentUser.role as UserRole)) {\n    return <Redirect to=\"/login\" />;\n  }\n\n  return <Component />;\n}\n\nfunction Router() {\n  return (\n    <div className=\"relative min-h-screen flex flex-col\">\n      {/* Theme Toggle - Fixed in top right */}\n      <div className=\"fixed top-4 right-4 z-50\">\n        <ThemeToggle />\n      </div>\n\n      <div className=\"flex-1\">\n        <Switch>\n          {/* Auth Routes */}\n          <Route path=\"/login\" component={LoginPage} />\n          <Route path=\"/forgot-password\" component={ForgotPasswordPage} />\n          <Route path=\"/reset-password\" component={ResetPasswordPage} />\n          <Route path=\"/register/cleaner\" component={RegisterCleanerPage} />\n          <Route path=\"/register/company\" component={RegisterCompanyPage} />\n          <Route path=\"/register/admin\" component={RegisterAdminPage} />\n\n          {/* Customer Routes - No auth required */}\n          <Route path=\"/customer\" component={CustomerBooking} />\n          <Route path=\"/customer/booking\" component={CustomerBooking} />\n          <Route path=\"/customer/pay/:token\" component={CustomerQRPayment} />\n          <Route path=\"/customer/home\" component={CustomerHome} />\n          <Route path=\"/customer/select-company\" component={SelectCompany} />\n          <Route path=\"/customer/checkout\" component={Checkout} />\n          <Route path=\"/customer/jobs\" component={CustomerJobs} />\n          <Route path=\"/customer/complaint/:jobId\" component={CustomerComplaint} />\n          <Route path=\"/customer/track\" component={CustomerTrack} />\n          <Route path=\"/customer/track/:plateNumber\" component={CustomerTrack} />\n\n          {/* Public Info Pages - No auth required */}\n          <Route path=\"/about\" component={About} />\n          <Route path=\"/terms\" component={Terms} />\n          <Route path=\"/privacy\" component={Privacy} />\n\n          {/* Cleaner Routes - Auth required */}\n          <Route path=\"/cleaner\">\n            {() => <ProtectedRoute component={CleanerDashboard} allowedRoles={[UserRole.CLEANER]} />}\n          </Route>\n          <Route path=\"/cleaner/shift-history\">\n            {() => <ProtectedRoute component={CleanerShiftHistory} allowedRoles={[UserRole.CLEANER]} />}\n          </Route>\n          <Route path=\"/cleaner/tips\">\n            {() => <ProtectedRoute component={CleanerTips} allowedRoles={[UserRole.CLEANER]} />}\n          </Route>\n\n          {/* Company Routes - Auth required */}\n          <Route path=\"/company\">\n            {() => <ProtectedRoute component={CompanyDashboard} allowedRoles={[UserRole.COMPANY_ADMIN]} />}\n          </Route>\n          <Route path=\"/company/financials\">\n            {() => <ProtectedRoute component={CompanyFinancials} allowedRoles={[UserRole.COMPANY_ADMIN]} />}\n          </Route>\n          <Route path=\"/company/live-report\">\n            {() => <ProtectedRoute component={CompanyLiveReport} allowedRoles={[UserRole.COMPANY_ADMIN]} />}\n          </Route>\n          <Route path=\"/company/shift-history\">\n            {() => <ProtectedRoute component={CompanyShiftHistory} allowedRoles={[UserRole.COMPANY_ADMIN]} />}\n          </Route>\n          <Route path=\"/company/complaints\">\n            {() => <ProtectedRoute component={CompanyComplaints} allowedRoles={[UserRole.COMPANY_ADMIN]} />}\n          </Route>\n          <Route path=\"/company/offline-jobs\">\n            {() => <ProtectedRoute component={CompanyOfflineJobs} allowedRoles={[UserRole.COMPANY_ADMIN]} />}\n          </Route>\n\n          {/* Admin Routes - Auth required */}\n          <Route path=\"/admin\">\n            {() => <ProtectedRoute component={AdminDashboard} allowedRoles={[UserRole.ADMIN]} />}\n          </Route>\n          <Route path=\"/admin/settings\">\n            {() => <ProtectedRoute component={AdminSettings} allowedRoles={[UserRole.ADMIN]} />}\n          </Route>\n          <Route path=\"/admin/complaints\">\n            {() => <ProtectedRoute component={AdminComplaints} allowedRoles={[UserRole.ADMIN]} />}\n          </Route>\n\n          {/* Default Route - New customer booking flow */}\n          <Route path=\"/\" component={CustomerBooking} />\n\n          {/* 404 */}\n          <Route component={NotFound} />\n        </Switch>\n\n        <BottomNav />\n      </div>\n\n      <Footer />\n    </div>\n  );\n}\n\nfunction App() {\n  const [showSplash, setShowSplash] = useState(true);\n  const [splashComplete, setSplashComplete] = useState(false);\n\n  useEffect(() => {\n    const hasSeenSplash = sessionStorage.getItem('splashShown');\n    if (hasSeenSplash) {\n      setShowSplash(false);\n      setSplashComplete(true);\n    }\n  }, []);\n\n  const handleSplashComplete = () => {\n    sessionStorage.setItem('splashShown', 'true');\n    setSplashComplete(true);\n  };\n\n  return (\n    <QueryClientProvider client={queryClient}>\n      <ThemeProvider>\n        <AuthProvider>\n          <TooltipProvider>\n            {showSplash && !splashComplete && (\n              <SplashScreen onComplete={handleSplashComplete} />\n            )}\n            <Toaster />\n            <PWAInstallPrompt />\n            <Router />\n          </TooltipProvider>\n        </AuthProvider>\n      </ThemeProvider>\n    </QueryClientProvider>\n  );\n}\n\nexport default App;\n","path":null,"size_bytes":8068,"size_tokens":null},"client/src/lib/utils.ts":{"content":"import { clsx, type ClassValue } from \"clsx\"\nimport { twMerge } from \"tailwind-merge\"\n\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs))\n}\n","path":null,"size_bytes":166,"size_tokens":null},"client/src/pages/customer-home.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { Card } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Button } from \"@/components/ui/button\";\nimport { Car, Phone, Building2, MapPin, AlertCircle, Loader2, ArrowLeft, Search, LogIn } from \"lucide-react\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport LocationPicker from \"@/components/location-picker\";\nimport logoUrl from \"@assets/IMG_2508_1762619079711.png\";\n\ntype GeolocationStatus = 'idle' | 'requesting' | 'success' | 'denied' | 'error';\n\nexport default function CustomerHome() {\n  const { currentUser } = useAuth();\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  \n  const [formData, setFormData] = useState({\n    carPlateNumber: \"\",\n    locationAddress: \"\",\n    locationLatitude: 0,\n    locationLongitude: 0,\n    parkingNumber: \"\",\n    customerPhone: \"\",\n    requestedCleanerEmail: \"\",\n  });\n  \n  const [showMap, setShowMap] = useState(false);\n  const [geolocationStatus, setGeolocationStatus] = useState<GeolocationStatus>('idle');\n  const [showLocationConsent, setShowLocationConsent] = useState(false);\n  const [isSubmitting, setIsSubmitting] = useState(false);\n\n  // Progressive geolocation: Show consent modal when needed\n  useEffect(() => {\n    if (geolocationStatus === 'idle' && !formData.locationAddress) {\n      setShowLocationConsent(true);\n    }\n  }, [geolocationStatus, formData.locationAddress]);\n\n  // Request geolocation with consent\n  const requestGeolocation = async () => {\n    setShowLocationConsent(false);\n    setGeolocationStatus('requesting');\n    \n    if (!navigator.geolocation) {\n      setGeolocationStatus('error');\n      toast({\n        title: \"Location Not Supported\",\n        description: \"Your browser doesn't support geolocation. Please select your location manually.\",\n        variant: \"destructive\",\n      });\n      setShowMap(true);\n      return;\n    }\n    \n    navigator.geolocation.getCurrentPosition(\n      async (position) => {\n        const { latitude, longitude } = position.coords;\n        \n        // Reverse geocode to get address\n        try {\n          const response = await fetch(\n            `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`\n          );\n          const data = await response.json();\n          const address = data.display_name || `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;\n          \n          // Use functional updater to prevent losing concurrent form edits\n          setFormData(prev => ({\n            ...prev,\n            locationAddress: address,\n            locationLatitude: latitude,\n            locationLongitude: longitude,\n          }));\n          setGeolocationStatus('success');\n        } catch (error) {\n          console.error('Reverse geocoding failed:', error);\n          // Still use coordinates even if reverse geocoding fails\n          setFormData(prev => ({\n            ...prev,\n            locationAddress: `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`,\n            locationLatitude: latitude,\n            locationLongitude: longitude,\n          }));\n          setGeolocationStatus('success');\n        }\n      },\n      (error) => {\n        console.error('Geolocation error:', error);\n        if (error.code === error.PERMISSION_DENIED) {\n          setGeolocationStatus('denied');\n        } else {\n          setGeolocationStatus('error');\n        }\n        // Don't auto-show map on error, let user click \"Change Location\"\n      },\n      {\n        enableHighAccuracy: true,\n        timeout: 10000,\n        maximumAge: 0,\n      }\n    );\n  };\n\n  const handleLocationSelect = (location: {\n    address: string;\n    latitude: number;\n    longitude: number;\n  }) => {\n    setFormData({\n      ...formData,\n      locationAddress: location.address,\n      locationLatitude: location.latitude,\n      locationLongitude: location.longitude,\n    });\n    setShowMap(false);\n    setGeolocationStatus('success'); // Manual selection also counts as success\n  };\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    // Prevent duplicate submits\n    if (isSubmitting) return;\n    \n    // Validation\n    if (!formData.locationAddress || formData.locationLatitude === 0) {\n      toast({\n        title: \"Location Required\",\n        description: \"Please select your location on the map\",\n        variant: \"destructive\",\n      });\n      setShowMap(true);\n      return;\n    }\n    \n    if (!formData.customerPhone) {\n      toast({\n        title: \"Phone Required\",\n        description: \"Please enter your phone number\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    \n    setIsSubmitting(true);\n    \n    try {\n      // Validate cleaner email if provided\n      let forcedCompanyId = null;\n      let cleanerInfo = null;\n      \n      if (formData.requestedCleanerEmail && formData.requestedCleanerEmail.trim()) {\n        try {\n          const cleanerResponse = await fetch(\n            `/api/cleaners/lookup?email=${encodeURIComponent(formData.requestedCleanerEmail.trim())}&lat=${formData.locationLatitude}&lon=${formData.locationLongitude}`\n          );\n          \n          if (!cleanerResponse.ok) {\n            const errorData = await cleanerResponse.json();\n            if (cleanerResponse.status === 404) {\n              toast({\n                title: \"Cleaner Not Found\",\n                description: \"No cleaner found with this email address\",\n                variant: \"destructive\",\n              });\n            } else if (cleanerResponse.status === 403) {\n              toast({\n                title: \"Cleaner Unavailable\",\n                description: errorData.message || \"This cleaner is not currently available\",\n                variant: \"destructive\",\n              });\n            } else {\n              toast({\n                title: \"Validation Error\",\n                description: \"Unable to validate cleaner email\",\n                variant: \"destructive\",\n              });\n            }\n            setIsSubmitting(false);\n            return;\n          }\n          \n          cleanerInfo = await cleanerResponse.json();\n          forcedCompanyId = cleanerInfo.companyId;\n          \n          toast({\n            title: \"Cleaner Found\",\n            description: `Request will be sent to ${cleanerInfo.name}`,\n          });\n        } catch (error) {\n          console.error(\"Cleaner lookup error:\", error);\n          toast({\n            title: \"Validation Error\",\n            description: \"Unable to validate cleaner email. Please try again.\",\n            variant: \"destructive\",\n          });\n          setIsSubmitting(false);\n          return;\n        }\n      }\n      \n      // Create or get customer profile\n      const customerResponse = await fetch(\"/api/customer/login\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ phoneNumber: formData.customerPhone }),\n      });\n      \n      if (!customerResponse.ok) {\n        throw new Error(\"Failed to create customer profile\");\n      }\n      \n      const customer = await customerResponse.json();\n      \n      const jobData = {\n        ...formData,\n        companyId: forcedCompanyId || \"\", // Pre-set if cleaner was validated\n        customerId: customer.id,\n        forcedCompanyId: forcedCompanyId, // Flag to lock company selection\n        cleanerName: cleanerInfo?.name || null, // For display\n      };\n      \n      // Store in session for next step\n      sessionStorage.setItem(\"pendingJob\", JSON.stringify(jobData));\n      setLocation(\"/customer/select-company\");\n    } catch (error: any) {\n      toast({\n        title: \"Error\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsSubmitting(false);\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-background flex flex-col\">\n      {/* Header - Vibrant and modern */}\n      <div className=\"border-b bg-background/95 backdrop-blur-sm sticky top-0 z-10 shadow-sm\">\n        <div className=\"max-w-md mx-auto px-3 py-2.5\">\n          <div className=\"flex items-center justify-between gap-2\">\n            {/* Action Buttons */}\n            <div className=\"flex items-center gap-1.5\">\n              <img src={logoUrl} alt=\"Washapp.ae\" className=\"h-10 w-auto\" data-testid=\"img-logo\" />\n              \n              {/* Track Button - Vibrant Blue */}\n              <Button \n                variant=\"default\"\n                size=\"sm\"\n                onClick={() => setLocation('/customer/track')}\n                data-testid=\"button-track\"\n                className=\"bg-gradient-to-r from-primary to-blue-600 hover:from-primary/90 hover:to-blue-600/90 text-white font-medium shadow-md hover:shadow-lg transition-all\"\n              >\n                <Search className=\"h-4 w-4 mr-1.5\" />\n                Track\n              </Button>\n              \n              {/* Staff Login Button - Brand Colors */}\n              <Button \n                variant=\"default\"\n                size=\"sm\"\n                onClick={() => setLocation(\"/login\")}\n                data-testid=\"button-staff-login\"\n                className=\"bg-gradient-to-r from-primary/90 to-primary hover:from-primary hover:to-primary/90 text-white font-medium shadow-md hover:shadow-lg transition-all\"\n              >\n                <LogIn className=\"h-4 w-4 mr-1.5\" />\n                Staff\n              </Button>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      {/* Content */}\n      <div className=\"flex-1 max-w-md mx-auto w-full px-4 py-4\">\n        {/* Booking Form - All inputs first, map last */}\n        <form onSubmit={handleSubmit} className=\"space-y-4 pb-20\">\n            {/* Car Plate and Parking Number - Same line */}\n            <div className=\"grid grid-cols-2 gap-3\">\n              <div>\n                <Label htmlFor=\"carPlateNumber\" className=\"text-base font-medium mb-2 block\">\n                  Car Plate\n                </Label>\n                <Input\n                  id=\"carPlateNumber\"\n                  data-testid=\"input-plate-number\"\n                  placeholder=\"ABC-1234\"\n                  value={formData.carPlateNumber}\n                  onChange={(e) =>\n                    setFormData({ ...formData, carPlateNumber: e.target.value.toUpperCase() })\n                  }\n                  required\n                  className=\"h-12 text-lg\"\n                  autoFocus\n                />\n              </div>\n              \n              <div>\n                <Label htmlFor=\"parkingNumber\" className=\"text-base font-medium mb-2 block\">\n                  Parking <span className=\"text-muted-foreground text-xs font-normal\">(Optional)</span>\n                </Label>\n                <Input\n                  id=\"parkingNumber\"\n                  data-testid=\"input-parking\"\n                  placeholder=\"P2-45\"\n                  value={formData.parkingNumber}\n                  onChange={(e) =>\n                    setFormData({ ...formData, parkingNumber: e.target.value })\n                  }\n                  className=\"h-12 text-lg\"\n                />\n              </div>\n            </div>\n\n            {/* Phone Number */}\n            <div>\n              <Label htmlFor=\"customerPhone\" className=\"text-base font-medium mb-2 block\">\n                Phone Number\n              </Label>\n              <Input\n                id=\"customerPhone\"\n                data-testid=\"input-phone\"\n                type=\"text\"\n                placeholder=\"Your contact number\"\n                value={formData.customerPhone}\n                onChange={(e) =>\n                  setFormData({ ...formData, customerPhone: e.target.value })\n                }\n                required\n                className=\"h-12 text-lg\"\n              />\n              <p className=\"text-sm text-muted-foreground mt-2\">\n                We'll share this with your cleaner\n              </p>\n            </div>\n\n            {/* Cleaner Email - Optional */}\n            <div>\n              <Label htmlFor=\"cleanerEmail\" className=\"text-base font-medium mb-2 block\">\n                Cleaner Email <span className=\"text-muted-foreground text-xs font-normal\">(Optional)</span>\n              </Label>\n              <Input\n                id=\"cleanerEmail\"\n                data-testid=\"input-cleaner-email\"\n                type=\"email\"\n                placeholder=\"Request specific cleaner\"\n                value={formData.requestedCleanerEmail || \"\"}\n                onChange={(e) =>\n                  setFormData({ ...formData, requestedCleanerEmail: e.target.value })\n                }\n                className=\"h-12 text-lg\"\n              />\n              <p className=\"text-sm text-muted-foreground mt-2\">\n                If on-duty and within 50m, they'll be auto-assigned\n              </p>\n            </div>\n\n            {/* Location Picker - Now at the bottom */}\n            <div>\n              <Label className=\"text-base font-medium mb-2 block\">\n                Car Location\n              </Label>\n              {!showMap && formData.locationAddress ? (\n                <div className=\"border rounded-lg p-4 bg-card\">\n                  <p className=\"text-sm mb-3\" data-testid=\"text-selected-location\">\n                    {formData.locationAddress}\n                  </p>\n                  <Button\n                    type=\"button\"\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={() => setShowMap(true)}\n                    data-testid=\"button-change-location\"\n                    className=\"h-9\"\n                  >\n                    Change Location\n                  </Button>\n                </div>\n              ) : (\n                <LocationPicker\n                  onLocationSelect={handleLocationSelect}\n                  initialPosition={\n                    formData.locationLatitude !== 0\n                      ? [formData.locationLatitude, formData.locationLongitude]\n                      : undefined\n                  }\n                />\n              )}\n            </div>\n          </form>\n      </div>\n\n      {/* Geolocation Status Banner */}\n      {(geolocationStatus === 'denied' || geolocationStatus === 'error') && (\n        <div className=\"max-w-md mx-auto w-full px-4 mb-4\">\n          <Alert variant=\"destructive\" data-testid=\"alert-location-error\">\n            <AlertCircle className=\"h-4 w-4\" />\n            <AlertDescription className=\"flex items-center justify-between\">\n              <span>\n                {geolocationStatus === 'denied'\n                  ? \"Location access was denied. Please enable location or select manually.\"\n                  : \"Unable to get your location. Please select manually.\"}\n              </span>\n              <Button\n                variant=\"ghost\"\n                size=\"sm\"\n                onClick={() => {\n                  setGeolocationStatus('idle');\n                  setShowLocationConsent(true);\n                }}\n                data-testid=\"button-retry-location\"\n              >\n                Retry\n              </Button>\n            </AlertDescription>\n          </Alert>\n        </div>\n      )}\n\n      {/* Sticky Bottom CTA */}\n      <div className=\"fixed bottom-0 left-0 right-0 bg-background border-t p-4 z-[1200]\">\n        <div className=\"max-w-md mx-auto\">\n          <Button\n            type=\"submit\"\n            className=\"w-full h-12 text-base\"\n            onClick={handleSubmit}\n            data-testid=\"button-continue\"\n            disabled={geolocationStatus === 'requesting' || isSubmitting}\n          >\n            {geolocationStatus === 'requesting' ? (\n              <>\n                <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                Getting Location...\n              </>\n            ) : isSubmitting ? (\n              <>\n                <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                Validating...\n              </>\n            ) : (\n              'Continue'\n            )}\n          </Button>\n        </div>\n      </div>\n\n      {/* Location Consent Modal */}\n      <Dialog open={showLocationConsent} onOpenChange={setShowLocationConsent}>\n        <DialogContent data-testid=\"dialog-location-consent\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <MapPin className=\"h-5 w-5\" />\n              We'll use your location\n            </DialogTitle>\n            <DialogDescription>\n              To find car wash cleaners nearby, we need to know where your car is parked. \n              You can change this location anytime.\n            </DialogDescription>\n          </DialogHeader>\n          <DialogFooter className=\"flex-col sm:flex-row gap-2\">\n            <Button\n              variant=\"outline\"\n              onClick={() => {\n                setShowLocationConsent(false);\n                setShowMap(true); // Open manual map picker instead\n              }}\n              data-testid=\"button-select-manually\"\n            >\n              Select Manually\n            </Button>\n            <Button\n              onClick={requestGeolocation}\n              data-testid=\"button-allow-location\"\n            >\n              Allow Location Access\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":17656,"size_tokens":null},"client/src/components/ui/tabs.tsx":{"content":"import * as React from \"react\"\nimport * as TabsPrimitive from \"@radix-ui/react-tabs\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Tabs = TabsPrimitive.Root\n\nconst TabsList = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.List\n    ref={ref}\n    className={cn(\n      \"inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsList.displayName = TabsPrimitive.List.displayName\n\nconst TabsTrigger = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsTrigger.displayName = TabsPrimitive.Trigger.displayName\n\nconst TabsContent = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsContent.displayName = TabsPrimitive.Content.displayName\n\nexport { Tabs, TabsList, TabsTrigger, TabsContent }\n","path":null,"size_bytes":1883,"size_tokens":null},"client/src/lib/queryClient.ts":{"content":"import { QueryClient, QueryFunction } from \"@tanstack/react-query\";\n\nasync function throwIfResNotOk(res: Response) {\n  if (!res.ok) {\n    const text = (await res.text()) || res.statusText;\n    throw new Error(`${res.status}: ${text}`);\n  }\n}\n\nexport async function apiRequest(\n  method: string,\n  url: string,\n  data?: unknown | undefined,\n): Promise<Response> {\n  const res = await fetch(url, {\n    method,\n    headers: data ? { \"Content-Type\": \"application/json\" } : {},\n    body: data ? JSON.stringify(data) : undefined,\n    credentials: \"include\",\n  });\n\n  await throwIfResNotOk(res);\n  return res;\n}\n\ntype UnauthorizedBehavior = \"returnNull\" | \"throw\";\nexport const getQueryFn: <T>(options: {\n  on401: UnauthorizedBehavior;\n}) => QueryFunction<T> =\n  ({ on401: unauthorizedBehavior }) =>\n  async ({ queryKey }) => {\n    const res = await fetch(queryKey.join(\"/\") as string, {\n      credentials: \"include\",\n    });\n\n    if (unauthorizedBehavior === \"returnNull\" && res.status === 401) {\n      return null;\n    }\n\n    await throwIfResNotOk(res);\n    return await res.json();\n  };\n\nexport const queryClient = new QueryClient({\n  defaultOptions: {\n    queries: {\n      queryFn: getQueryFn({ on401: \"throw\" }),\n      refetchInterval: false,\n      refetchOnWindowFocus: false,\n      staleTime: 0,\n      gcTime: 0,\n      retry: false,\n    },\n    mutations: {\n      retry: false,\n    },\n  },\n});\n","path":null,"size_bytes":1393,"size_tokens":null},"client/src/components/ui/avatar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as AvatarPrimitive from \"@radix-ui/react-avatar\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Avatar = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Root\n    ref={ref}\n    className={cn(`\n      after:content-[''] after:block after:absolute after:inset-0 after:rounded-full after:pointer-events-none after:border after:border-black/10 dark:after:border-white/10\n      relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full`,\n      className\n    )}\n    {...props}\n  />\n))\nAvatar.displayName = AvatarPrimitive.Root.displayName\n\nconst AvatarImage = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Image>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Image\n    ref={ref}\n    className={cn(\"aspect-square h-full w-full\", className)}\n    {...props}\n  />\n))\nAvatarImage.displayName = AvatarPrimitive.Image.displayName\n\nconst AvatarFallback = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Fallback>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Fallback\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full items-center justify-center rounded-full bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatarFallback.displayName = AvatarPrimitive.Fallback.displayName\n\nexport { Avatar, AvatarImage, AvatarFallback }\n","path":null,"size_bytes":1592,"size_tokens":null},"client/src/pages/cleaner-dashboard.tsx":{"content":"import { useState, useEffect, useRef } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Link } from \"wouter\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Car, MapPin, Phone, Building2, Upload, CheckCircle2, Clock, Navigation, History, Timer, User, MessageCircle, Banknote, DollarSign, Star, Bell, BellOff, Volume2, VolumeX, QrCode, Copy, PlusCircle, Edit, Wallet } from \"lucide-react\";\nimport { Job, Cleaner, CleanerStatus, JobStatus, OfflineJob } from \"@shared/schema\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useWebSocket } from \"@/hooks/use-websocket\";\nimport { Input } from \"@/components/ui/input\";\nimport { usePushNotifications } from \"@/hooks/use-push-notifications\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Label } from \"@/components/ui/label\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogFooter } from \"@/components/ui/dialog\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport QRCodeComponent from \"react-qr-code\";\n\nconst UAE_EMIRATES = [\n  \"Abu Dhabi\",\n  \"Dubai\",\n  \"Sharjah\",\n  \"Ajman\",\n  \"Umm Al Quwain\",\n  \"Ras Al Khaimah\",\n  \"Fujairah\"\n];\n\nconst PLATE_CODES = [\n  ...Array.from({ length: 26 }, (_, i) => String.fromCharCode(65 + i)),\n  ...Array.from({ length: 13 }, (_, i) => {\n    const char = String.fromCharCode(65 + i);\n    return char + char;\n  }),\n  ...Array.from({ length: 50 }, (_, i) => (i + 1).toString())\n];\n\nexport default function CleanerDashboard() {\n  const { currentUser } = useAuth();\n  const { toast } = useToast();\n  const [selectedFile, setSelectedFile] = useState<File | null>(null);\n  const [uploadingJobId, setUploadingJobId] = useState<string | null>(null);\n  const [showQRModal, setShowQRModal] = useState(false);\n  const [paymentQRData, setPaymentQRData] = useState<{ token: string; expiresAt: string } | null>(null);\n  \n  // Offline jobs state\n  const [showOfflineJobModal, setShowOfflineJobModal] = useState(false);\n  const [offlineJobForm, setOfflineJobForm] = useState({\n    carPlateEmirate: '',\n    carPlateCode: '',\n    carPlateNumber: '',\n    notes: '',\n  });\n  \n  // Edit plate state (for QR-paid anonymous jobs)\n  const [showEditPlateModal, setShowEditPlateModal] = useState(false);\n  const [editingJobId, setEditingJobId] = useState<number | null>(null);\n  const [editPlateForm, setEditPlateForm] = useState({\n    carPlateEmirate: '',\n    carPlateCode: '',\n    carPlateNumber: '',\n  });\n  \n  // Push notifications for cleaners\n  const {\n    permission,\n    isSubscribed,\n    soundEnabled,\n    isLoading: notificationLoading,\n    isSupported,\n    subscribe,\n    unsubscribe,\n    toggleSound,\n  } = usePushNotifications({ userId: currentUser?.id });\n\n  // Consolidated dashboard query - fetches all data in one call\n  const { data: dashboardData, isLoading: loadingDashboard } = useQuery<{\n    cleaner: Cleaner;\n    activeShift: any;\n    myJobs: Job[];\n    availableJobs: Job[];\n  }>({\n    queryKey: [\"/api/cleaner/dashboard\"],\n    enabled: !!currentUser,\n    refetchOnWindowFocus: true,\n    // Only poll for available jobs when on duty\n    refetchInterval: (query) => {\n      const data = query.state.data;\n      return data?.cleaner?.status === CleanerStatus.ON_DUTY ? 30000 : false;\n    },\n    staleTime: 0,\n  });\n\n  // Derive individual pieces of data from dashboard\n  const cleaner = dashboardData?.cleaner;\n  const shiftData = dashboardData ? { activeShift: dashboardData.activeShift, cleaner: dashboardData.cleaner } : undefined;\n  const activeJobs = dashboardData?.myJobs || [];\n  const availableJobs = dashboardData?.availableJobs || [];\n  const loadingCleaner = loadingDashboard;\n  const loadingJobs = loadingDashboard;\n\n  // Query for offline jobs\n  const { data: offlineJobs = [], isLoading: loadingOfflineJobs } = useQuery<OfflineJob[]>({\n    queryKey: [\"/api/cleaner/offline-jobs\"],\n    enabled: !!currentUser,\n  });\n\n  useWebSocket({\n    onMessage: (data) => {\n      if (data.type === 'job_update' && cleaner) {\n        queryClient.invalidateQueries({ queryKey: [\"/api/cleaner/dashboard\"] });\n        \n        if (data.job && data.job.status === JobStatus.PAID) {\n          toast({\n            title: \"New Job Available\",\n            description: `New car wash for ${data.job.carPlateNumber}`,\n          });\n        }\n      }\n    },\n  });\n\n  const startShift = useMutation({\n    mutationFn: async () => {\n      return await apiRequest(\"POST\", \"/api/cleaner/start-shift\", {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/cleaner/dashboard\"] });\n      toast({\n        title: \"Shift Started\",\n        description: \"You are now on duty\",\n      });\n    },\n  });\n\n  const endShift = useMutation({\n    mutationFn: async () => {\n      return await apiRequest(\"POST\", \"/api/cleaner/end-shift\", {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/cleaner/dashboard\"] });\n      toast({\n        title: \"Shift Ended\",\n        description: \"You are now off duty\",\n      });\n    },\n  });\n\n  const toggleAvailability = useMutation({\n    mutationFn: async (status: CleanerStatus) => {\n      return await apiRequest(\"POST\", \"/api/cleaner/toggle-status\", { \n        status\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/cleaner/dashboard\"] });\n      toast({\n        title: \"Status Updated\",\n        description: \"Your availability status has been updated\",\n      });\n    },\n  });\n\n  const acceptJob = useMutation({\n    mutationFn: async (jobId: string) => {\n      return await apiRequest(\"POST\", `/api/cleaner/accept-job/${jobId}`, {\n        userId: currentUser?.id\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/cleaner/dashboard\"] });\n      toast({\n        title: \"Job Accepted\",\n        description: \"You have accepted the job\",\n      });\n    },\n  });\n\n  const startJob = useMutation({\n    mutationFn: async (jobId: string) => {\n      return await apiRequest(\"POST\", `/api/cleaner/start-job/${jobId}`, {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/cleaner/dashboard\"] });\n    },\n  });\n\n  const completeJob = useMutation({\n    mutationFn: async ({ jobId, photoURL }: { jobId: string; photoURL: string }) => {\n      return await apiRequest(\"POST\", `/api/cleaner/complete-job/${jobId}`, { \n        proofPhotoURL: photoURL,\n        userId: currentUser?.id\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/cleaner/dashboard\"] });\n      setSelectedFile(null);\n      setUploadingJobId(null);\n      toast({\n        title: \"Job Completed\",\n        description: \"The job has been marked as completed\",\n      });\n    },\n  });\n\n  const updateLocation = useMutation({\n    mutationFn: async ({ latitude, longitude }: { latitude: number; longitude: number }) => {\n      return await apiRequest(\"POST\", \"/api/cleaner/update-location\", {\n        latitude,\n        longitude,\n      });\n    },\n  });\n\n  const generateQRToken = useMutation({\n    mutationFn: async () => {\n      const response = await apiRequest(\"POST\", \"/api/cleaner/generate-qr-token\", {});\n      return await response.json();\n    },\n    onSuccess: (data) => {\n      setPaymentQRData(data);\n      setShowQRModal(true);\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to generate payment QR code\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const createOfflineJob = useMutation({\n    mutationFn: async (data: typeof offlineJobForm) => {\n      const response = await apiRequest(\"POST\", \"/api/cleaner/create-offline-job\", data);\n      return await response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/cleaner/dashboard\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/cleaner/offline-jobs\"] });\n      setShowOfflineJobModal(false);\n      setOfflineJobForm({\n        carPlateEmirate: '',\n        carPlateCode: '',\n        carPlateNumber: '',\n        notes: '',\n      });\n      toast({\n        title: \"Job Created\",\n        description: \"Job started - upload photo when complete\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to create offline job\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const [completingOfflineJobId, setCompletingOfflineJobId] = useState<number | null>(null);\n  const [offlineJobPhoto, setOfflineJobPhoto] = useState<File | null>(null);\n\n  const completeOfflineJob = useMutation({\n    mutationFn: async ({ offlineJobId, photo }: { offlineJobId: number; photo: File }) => {\n      const formData = new FormData();\n      formData.append('photo', photo);\n      \n      const response = await fetch(`/api/cleaner/complete-offline-job/${offlineJobId}`, {\n        method: 'POST',\n        body: formData,\n        credentials: 'include',\n      });\n      \n      if (!response.ok) {\n        throw new Error('Failed to complete job');\n      }\n      \n      return await response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/cleaner/dashboard\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/cleaner/offline-jobs\"] });\n      setCompletingOfflineJobId(null);\n      setOfflineJobPhoto(null);\n      toast({\n        title: \"Job Completed\",\n        description: \"Cash job has been completed successfully\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to complete job\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateJobPlate = useMutation({\n    mutationFn: async ({ jobId, ...data }: { jobId: number; carPlateEmirate: string; carPlateCode: string; carPlateNumber: string }) => {\n      const response = await apiRequest(\"PATCH\", `/api/cleaner/update-job-plate/${jobId}`, data);\n      return await response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/cleaner/dashboard\"] });\n      setShowEditPlateModal(false);\n      setEditingJobId(null);\n      setEditPlateForm({\n        carPlateEmirate: '',\n        carPlateCode: '',\n        carPlateNumber: '',\n      });\n      toast({\n        title: \"Plate Updated\",\n        description: \"Car plate number has been updated\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to update car plate\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleCopyPaymentLink = () => {\n    if (!paymentQRData) return;\n    \n    const paymentURL = `${window.location.origin}/customer/pay/${paymentQRData.token}`;\n    navigator.clipboard.writeText(paymentURL);\n    \n    toast({\n      title: \"Link Copied\",\n      description: \"Payment link copied to clipboard\",\n    });\n  };\n\n  const locationIntervalRef = useRef<NodeJS.Timeout | null>(null);\n\n  const updateCurrentLocation = () => {\n    if (!navigator.geolocation) {\n      console.log(\"Geolocation is not supported\");\n      return;\n    }\n\n    navigator.geolocation.getCurrentPosition(\n      (position) => {\n        updateLocation.mutate({\n          latitude: position.coords.latitude,\n          longitude: position.coords.longitude,\n        });\n      },\n      (error) => {\n        console.error(\"Error getting location:\", error);\n      }\n    );\n  };\n\n  useEffect(() => {\n    const isOnDuty = shiftData?.activeShift || cleaner?.status === CleanerStatus.ON_DUTY;\n\n    if (locationIntervalRef.current) {\n      clearInterval(locationIntervalRef.current);\n      locationIntervalRef.current = null;\n    }\n\n    if (isOnDuty) {\n      updateCurrentLocation();\n      \n      locationIntervalRef.current = setInterval(() => {\n        updateCurrentLocation();\n      }, 5 * 60 * 1000);\n    }\n\n    return () => {\n      if (locationIntervalRef.current) {\n        clearInterval(locationIntervalRef.current);\n        locationIntervalRef.current = null;\n      }\n    };\n  }, [shiftData?.activeShift, cleaner?.status]);\n\n  const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>, jobId: string) => {\n    if (e.target.files && e.target.files[0]) {\n      setSelectedFile(e.target.files[0]);\n      setUploadingJobId(jobId);\n    }\n  };\n\n  const handleUploadProof = async (jobId: string) => {\n    if (!selectedFile) return;\n\n    try {\n      const formData = new FormData();\n      formData.append('proofPhoto', selectedFile);\n      \n      const uploadRes = await fetch('/api/upload/proof-photo', {\n        method: 'POST',\n        body: formData,\n      });\n      \n      if (!uploadRes.ok) {\n        throw new Error('File upload failed');\n      }\n      \n      const { url } = await uploadRes.json();\n      \n      completeJob.mutate({ jobId, photoURL: url });\n    } catch (error) {\n      toast({\n        title: \"Upload Failed\",\n        description: \"Failed to upload proof photo. Please try again.\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  if (loadingCleaner) {\n    return (\n      <div className=\"h-screen flex items-center justify-center\">\n        <div className=\"animate-spin w-8 h-8 border-4 border-primary border-t-transparent rounded-full\" aria-label=\"Loading\"/>\n      </div>\n    );\n  }\n\n  if (!cleaner) {\n    return (\n      <div className=\"min-h-screen bg-background p-4 flex items-center justify-center\">\n        <Card className=\"max-w-md w-full text-center p-6\">\n          <p className=\"text-muted-foreground\">Cleaner profile not found</p>\n        </Card>\n      </div>\n    );\n  }\n\n  const isOnDuty = shiftData?.activeShift || cleaner.status === CleanerStatus.ON_DUTY;\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-b from-primary/5 to-background pb-20\">\n      <div className=\"max-w-2xl mx-auto\">\n        {/* Compact Header */}\n        <motion.div \n          initial={{ opacity: 0, y: -20 }}\n          animate={{ opacity: 1, y: 0 }}\n          className={`sticky top-0 z-10 ${isOnDuty ? 'bg-gradient-to-r from-green-500 to-green-600' : 'bg-gradient-to-r from-muted to-muted/80'} shadow-lg`}\n        >\n          <div className=\"p-3 pr-16 space-y-2\">\n            {/* Header Info */}\n            <div className=\"flex items-center justify-between gap-2\">\n              <div className=\"flex-1 min-w-0\">\n                <h1 className={`text-base font-bold truncate ${isOnDuty ? 'text-white' : 'text-foreground'}`}>\n                  {currentUser?.displayName}\n                </h1>\n                <p className={`text-xs ${isOnDuty ? 'text-white/90' : 'text-muted-foreground'}`}>\n                  {isOnDuty ? \"● On Duty\" : \"○ Off Duty\"}\n                </p>\n              </div>\n              <div className=\"flex flex-col items-end gap-1\">\n                {/* Star Rating */}\n                <div className={`flex items-center gap-1 ${isOnDuty ? 'text-white' : 'text-foreground'}`}>\n                  <Star className=\"h-4 w-4 fill-yellow-400 text-yellow-400\" />\n                  <span className=\"text-sm font-bold\">\n                    {cleaner?.rating ? Number(cleaner.rating).toFixed(1) : \"0.0\"}\n                  </span>\n                  <span className={`text-xs ${isOnDuty ? 'text-white/70' : 'text-muted-foreground'}`}>\n                    ({cleaner?.totalRatings || 0})\n                  </span>\n                </div>\n                {/* Shift History Button */}\n                <Link href=\"/cleaner/shift-history\">\n                  <Button \n                    variant=\"ghost\" \n                    size=\"sm\"\n                    className={`h-7 ${isOnDuty ? 'text-white hover:bg-white/20' : ''}`}\n                    data-testid=\"button-shift-history\"\n                  >\n                    <History className=\"h-3 w-3 mr-1\" />\n                    <span className=\"text-xs\">Shift History</span>\n                  </Button>\n                </Link>\n              </div>\n            </div>\n\n            {/* Shift Control Button */}\n            {shiftData?.activeShift ? (\n              <Button\n                variant=\"outline\"\n                size=\"lg\"\n                onClick={() => endShift.mutate()}\n                disabled={endShift.isPending}\n                className=\"w-full bg-white/90 hover:bg-white border-2 text-green-600 border-white/50 min-h-12\"\n                data-testid=\"button-stop-shift\"\n              >\n                <Clock className=\"h-4 w-4 mr-2\" />\n                <div className=\"flex items-center justify-between flex-1\">\n                  <span className=\"font-bold\">Stop Shift</span>\n                  <span className=\"text-xs opacity-80\">\n                    {new Date(shiftData.activeShift.startedAt).toLocaleTimeString('en-AE', { hour: '2-digit', minute: '2-digit', timeZone: 'Asia/Dubai' })}\n                  </span>\n                </div>\n              </Button>\n            ) : (\n              <Button\n                size=\"lg\"\n                onClick={() => startShift.mutate()}\n                disabled={startShift.isPending}\n                className=\"w-full bg-gradient-to-r from-primary to-primary/80 text-white min-h-12 shadow-lg hover:shadow-xl\"\n                data-testid=\"button-start-shift\"\n              >\n                <Clock className=\"h-4 w-4 mr-2\" />\n                <span className=\"font-bold\">Start Shift</span>\n              </Button>\n            )}\n\n            {/* Action Buttons Row */}\n            <div className=\"grid grid-cols-2 gap-2\">\n              {/* Payment QR Code Button */}\n              <Button\n                variant=\"outline\"\n                size=\"lg\"\n                onClick={() => generateQRToken.mutate()}\n                disabled={generateQRToken.isPending}\n                className=\"border-2 min-h-12\"\n                data-testid=\"button-generate-qr\"\n              >\n                <QrCode className=\"h-4 w-4 mr-1\" />\n                <span className=\"font-semibold text-sm\">Payment QR</span>\n              </Button>\n\n              {/* Record Cash Payment Button */}\n              <Button\n                variant=\"outline\"\n                size=\"lg\"\n                onClick={() => setShowOfflineJobModal(true)}\n                className=\"border-2 min-h-12\"\n                data-testid=\"button-record-cash\"\n              >\n                <Wallet className=\"h-4 w-4 mr-1\" />\n                <span className=\"font-semibold text-sm\">Record Cash</span>\n              </Button>\n            </div>\n          </div>\n        </motion.div>\n\n        {/* Notification Settings */}\n        {isSupported && (\n          <motion.div\n            initial={{ opacity: 0, y: -10 }}\n            animate={{ opacity: 1, y: 0 }}\n            transition={{ delay: 0.1 }}\n            className=\"p-4 pb-0\"\n          >\n            <Card className=\"border-2\">\n              <CardHeader className=\"pb-3\">\n                <div className=\"flex items-center justify-between\">\n                  <div className=\"flex items-center gap-2\">\n                    {isSubscribed ? (\n                      <Bell className=\"h-5 w-5 text-primary\" />\n                    ) : (\n                      <BellOff className=\"h-5 w-5 text-muted-foreground\" />\n                    )}\n                    <CardTitle className=\"text-base\">Job Notifications</CardTitle>\n                  </div>\n                  <Switch\n                    checked={isSubscribed}\n                    onCheckedChange={async (checked) => {\n                      if (checked) {\n                        await subscribe();\n                      } else {\n                        await unsubscribe();\n                      }\n                    }}\n                    disabled={notificationLoading}\n                    data-testid=\"switch-notifications\"\n                  />\n                </div>\n                <CardDescription className=\"text-xs\">\n                  {isSubscribed\n                    ? \"You'll receive notifications when new jobs are available\"\n                    : \"Enable to get instant alerts for new jobs\"}\n                </CardDescription>\n              </CardHeader>\n              {isSubscribed && (\n                <CardContent className=\"pt-0\">\n                  <div className=\"flex items-center justify-between p-3 rounded-lg bg-muted/50\">\n                    <div className=\"flex items-center gap-2\">\n                      {soundEnabled ? (\n                        <Volume2 className=\"h-4 w-4 text-primary\" />\n                      ) : (\n                        <VolumeX className=\"h-4 w-4 text-muted-foreground\" />\n                      )}\n                      <Label htmlFor=\"sound-toggle\" className=\"text-sm cursor-pointer\">\n                        Notification Sound\n                      </Label>\n                    </div>\n                    <Switch\n                      id=\"sound-toggle\"\n                      checked={soundEnabled}\n                      onCheckedChange={toggleSound}\n                      disabled={notificationLoading}\n                      data-testid=\"switch-sound\"\n                    />\n                  </div>\n                </CardContent>\n              )}\n            </Card>\n          </motion.div>\n        )}\n\n        {/* Jobs Tabs */}\n        <div className=\"p-4\">\n          <Tabs defaultValue=\"available\" className=\"w-full\">\n            <TabsList className=\"grid w-full grid-cols-3 h-12\">\n              <TabsTrigger value=\"available\" className=\"text-sm\" data-testid=\"tab-available\">\n                Available <Badge variant=\"secondary\" className=\"ml-1\">{availableJobs.length}</Badge>\n              </TabsTrigger>\n              <TabsTrigger value=\"active\" className=\"text-sm\" data-testid=\"tab-active\">\n                My Jobs <Badge variant=\"secondary\" className=\"ml-1\">{activeJobs.length}</Badge>\n              </TabsTrigger>\n              <TabsTrigger value=\"offline\" className=\"text-sm\" data-testid=\"tab-offline\">\n                Cash Jobs <Badge variant=\"secondary\" className=\"ml-1\">{offlineJobs.length}</Badge>\n              </TabsTrigger>\n            </TabsList>\n\n            {/* Available Jobs */}\n            <TabsContent value=\"available\" className=\"space-y-4 mt-4\">\n              <AnimatePresence mode=\"popLayout\">\n                {loadingJobs ? (\n                  <>\n                    {[1, 2].map((i) => (\n                      <motion.div\n                        key={i}\n                        initial={{ opacity: 0, scale: 0.95 }}\n                        animate={{ opacity: 1, scale: 1 }}\n                      >\n                        <Card>\n                          <CardHeader>\n                            <Skeleton className=\"h-6 w-1/2\" />\n                          </CardHeader>\n                          <CardContent>\n                            <Skeleton className=\"h-4 w-full mb-2\" />\n                            <Skeleton className=\"h-4 w-3/4\" />\n                          </CardContent>\n                        </Card>\n                      </motion.div>\n                    ))}\n                  </>\n                ) : availableJobs.length === 0 ? (\n                  <motion.div\n                    initial={{ opacity: 0, y: 20 }}\n                    animate={{ opacity: 1, y: 0 }}\n                  >\n                    <Card className=\"p-8 text-center border-dashed\">\n                      <Clock className=\"h-16 w-16 mx-auto text-muted-foreground mb-4 opacity-50\" />\n                      <p className=\"text-muted-foreground font-medium\">No available jobs at the moment</p>\n                      <p className=\"text-sm text-muted-foreground mt-2\">New jobs will appear here automatically</p>\n                    </Card>\n                  </motion.div>\n                ) : (\n                  availableJobs.map((job, index) => (\n                    <motion.div\n                      key={job.id}\n                      initial={{ opacity: 0, x: -20 }}\n                      animate={{ opacity: 1, x: 0 }}\n                      exit={{ opacity: 0, x: 20 }}\n                      transition={{ delay: index * 0.1 }}\n                      layout\n                    >\n                      <JobCard\n                        job={job}\n                        action={\n                          <Button\n                            size=\"lg\"\n                            className=\"w-full min-h-14 bg-gradient-to-r from-primary to-primary/80 text-white shadow-lg hover:shadow-xl\"\n                            onClick={() => acceptJob.mutate(String(job.id))}\n                            disabled={acceptJob.isPending}\n                            data-testid={`button-accept-${job.id}`}\n                          >\n                            <CheckCircle2 className=\"h-5 w-5 mr-2\" />\n                            <span className=\"font-bold text-lg\">Accept Job</span>\n                          </Button>\n                        }\n                      />\n                    </motion.div>\n                  ))\n                )}\n              </AnimatePresence>\n            </TabsContent>\n\n            {/* Active Jobs */}\n            <TabsContent value=\"active\" className=\"space-y-4 mt-4\">\n              <AnimatePresence mode=\"popLayout\">\n                {activeJobs.length === 0 ? (\n                  <motion.div\n                    initial={{ opacity: 0, y: 20 }}\n                    animate={{ opacity: 1, y: 0 }}\n                  >\n                    <Card className=\"p-8 text-center border-dashed\">\n                      <CheckCircle2 className=\"h-16 w-16 mx-auto text-muted-foreground mb-4 opacity-50\" />\n                      <p className=\"text-muted-foreground font-medium\">No active jobs</p>\n                      <p className=\"text-sm text-muted-foreground mt-2\">Accepted jobs will appear here</p>\n                    </Card>\n                  </motion.div>\n                ) : (\n                  activeJobs.map((job, index) => (\n                    <motion.div\n                      key={job.id}\n                      initial={{ opacity: 0, x: -20 }}\n                      animate={{ opacity: 1, x: 0 }}\n                      exit={{ opacity: 0, x: 20 }}\n                      transition={{ delay: index * 0.1 }}\n                      layout\n                    >\n                      <JobCard\n                        job={job}\n                        onEditPlate={(jobId) => {\n                          setEditingJobId(jobId);\n                          setShowEditPlateModal(true);\n                        }}\n                        action={\n                          job.status === JobStatus.ASSIGNED ? (\n                            <Button\n                              size=\"lg\"\n                              className=\"w-full min-h-14 bg-gradient-to-r from-primary to-primary/80 text-white shadow-lg hover:shadow-xl\"\n                              onClick={() => startJob.mutate(String(job.id))}\n                              data-testid={`button-start-${job.id}`}\n                            >\n                              <Timer className=\"h-5 w-5 mr-2\" />\n                              <span className=\"font-bold text-lg\">Start Cleaning</span>\n                            </Button>\n                          ) : job.status === JobStatus.IN_PROGRESS ? (\n                            <div className=\"space-y-3\">\n                              <Input\n                                type=\"file\"\n                                accept=\"image/*\"\n                                capture=\"environment\"\n                                onChange={(e) => handleFileSelect(e, String(job.id))}\n                                className=\"min-h-12\"\n                                data-testid={`input-photo-${job.id}`}\n                              />\n                              <Button\n                                size=\"lg\"\n                                className=\"w-full min-h-14 bg-gradient-to-r from-green-500 to-green-600 text-white shadow-lg hover:shadow-xl\"\n                                onClick={() => handleUploadProof(String(job.id))}\n                                disabled={!selectedFile || uploadingJobId !== String(job.id) || completeJob.isPending}\n                                data-testid={`button-complete-${job.id}`}\n                              >\n                                <Upload className=\"h-5 w-5 mr-2\" />\n                                <span className=\"font-bold text-lg\">Upload & Complete</span>\n                              </Button>\n                            </div>\n                          ) : (\n                            <Badge variant=\"outline\" className=\"w-full py-3 text-base justify-center\">\n                              <CheckCircle2 className=\"h-4 w-4 mr-2\" />\n                              Completed\n                            </Badge>\n                          )\n                        }\n                      />\n                    </motion.div>\n                  ))\n                )}\n              </AnimatePresence>\n            </TabsContent>\n\n            {/* Offline/Cash Jobs */}\n            <TabsContent value=\"offline\" className=\"space-y-4 mt-4\">\n              <AnimatePresence mode=\"popLayout\">\n                {loadingOfflineJobs ? (\n                  <>\n                    {[1, 2].map((i) => (\n                      <motion.div\n                        key={i}\n                        initial={{ opacity: 0, scale: 0.95 }}\n                        animate={{ opacity: 1, scale: 1 }}\n                      >\n                        <Card>\n                          <CardHeader>\n                            <Skeleton className=\"h-6 w-1/2\" />\n                          </CardHeader>\n                          <CardContent>\n                            <Skeleton className=\"h-4 w-full mb-2\" />\n                            <Skeleton className=\"h-4 w-3/4\" />\n                          </CardContent>\n                        </Card>\n                      </motion.div>\n                    ))}\n                  </>\n                ) : offlineJobs.length === 0 ? (\n                  <motion.div\n                    initial={{ opacity: 0, y: 20 }}\n                    animate={{ opacity: 1, y: 0 }}\n                  >\n                    <Card className=\"p-8 text-center border-dashed\">\n                      <Wallet className=\"h-16 w-16 mx-auto text-muted-foreground mb-4 opacity-50\" />\n                      <p className=\"text-muted-foreground font-medium\">No cash jobs recorded</p>\n                      <p className=\"text-sm text-muted-foreground mt-2\">Use \"Record Cash\" to start a manual payment job</p>\n                    </Card>\n                  </motion.div>\n                ) : (\n                  offlineJobs.map((job, index) => (\n                    <motion.div\n                      key={job.id}\n                      initial={{ opacity: 0, x: -20 }}\n                      animate={{ opacity: 1, x: 0 }}\n                      exit={{ opacity: 0, x: 20 }}\n                      transition={{ delay: index * 0.1 }}\n                      layout\n                    >\n                      <Card data-testid={`card-offline-job-${job.id}`}>\n                        <CardHeader className=\"pb-2\">\n                          <div className=\"flex items-center justify-between gap-2\">\n                            <div className=\"flex items-center gap-2\">\n                              <Car className=\"h-5 w-5 text-primary\" />\n                              <CardTitle className=\"text-lg\">\n                                {job.carPlateEmirate && job.carPlateCode \n                                  ? `${job.carPlateEmirate} ${job.carPlateCode} ${job.carPlateNumber}`\n                                  : job.carPlateNumber}\n                              </CardTitle>\n                            </div>\n                            <div className=\"flex items-center gap-2\">\n                              <Badge variant=\"secondary\" className=\"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-100\">\n                                <Banknote className=\"h-3 w-3 mr-1\" />\n                                Cash\n                              </Badge>\n                              {job.status === 'in_progress' ? (\n                                <Badge variant=\"secondary\" className=\"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-100\">\n                                  <Timer className=\"h-3 w-3 mr-1\" />\n                                  In Progress\n                                </Badge>\n                              ) : (\n                                <Badge variant=\"secondary\" className=\"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-100\">\n                                  <CheckCircle2 className=\"h-3 w-3 mr-1\" />\n                                  Completed\n                                </Badge>\n                              )}\n                            </div>\n                          </div>\n                        </CardHeader>\n                        <CardContent className=\"space-y-3\">\n                          <div className=\"flex items-center justify-between text-sm\">\n                            <span className=\"text-muted-foreground\">Service Price:</span>\n                            <span className=\"font-medium\">{job.servicePrice} AED</span>\n                          </div>\n                          <div className=\"flex items-center justify-between text-sm\">\n                            <span className=\"text-muted-foreground\">VAT (5%):</span>\n                            <span className=\"font-medium\">{job.vatAmount} AED</span>\n                          </div>\n                          <div className=\"flex items-center justify-between text-sm border-t pt-2\">\n                            <span className=\"font-medium\">Total:</span>\n                            <span className=\"font-bold text-primary\">{job.totalAmount} AED</span>\n                          </div>\n                          {job.notes && (\n                            <div className=\"text-sm text-muted-foreground border-t pt-2\">\n                              <MessageCircle className=\"h-4 w-4 inline mr-1\" />\n                              {job.notes}\n                            </div>\n                          )}\n                          <div className=\"text-xs text-muted-foreground border-t pt-2\">\n                            <Clock className=\"h-3 w-3 inline mr-1\" />\n                            {new Date(job.createdAt).toLocaleString('en-AE', { \n                              timeZone: 'Asia/Dubai',\n                              dateStyle: 'medium',\n                              timeStyle: 'short'\n                            })}\n                          </div>\n                          \n                          {/* Photo upload for in-progress jobs */}\n                          {job.status === 'in_progress' && (\n                            <div className=\"border-t pt-3 mt-3\">\n                              {completingOfflineJobId === job.id ? (\n                                <div className=\"space-y-3\">\n                                  <div className=\"flex items-center gap-2\">\n                                    <input\n                                      type=\"file\"\n                                      accept=\"image/*\"\n                                      capture=\"environment\"\n                                      className=\"hidden\"\n                                      id={`offline-photo-${job.id}`}\n                                      onChange={(e) => setOfflineJobPhoto(e.target.files?.[0] || null)}\n                                    />\n                                    <label\n                                      htmlFor={`offline-photo-${job.id}`}\n                                      className=\"flex-1 flex items-center justify-center gap-2 p-3 border-2 border-dashed rounded-lg cursor-pointer hover:bg-muted/50 transition-colors\"\n                                    >\n                                      <Upload className=\"h-4 w-4\" />\n                                      <span className=\"text-sm\">\n                                        {offlineJobPhoto ? offlineJobPhoto.name : \"Select completion photo\"}\n                                      </span>\n                                    </label>\n                                  </div>\n                                  <div className=\"flex gap-2\">\n                                    <Button\n                                      variant=\"outline\"\n                                      size=\"sm\"\n                                      className=\"flex-1\"\n                                      onClick={() => {\n                                        setCompletingOfflineJobId(null);\n                                        setOfflineJobPhoto(null);\n                                      }}\n                                      data-testid={`button-cancel-complete-${job.id}`}\n                                    >\n                                      Cancel\n                                    </Button>\n                                    <Button\n                                      size=\"sm\"\n                                      className=\"flex-1\"\n                                      disabled={!offlineJobPhoto || completeOfflineJob.isPending}\n                                      onClick={() => {\n                                        if (offlineJobPhoto) {\n                                          completeOfflineJob.mutate({ offlineJobId: job.id, photo: offlineJobPhoto });\n                                        }\n                                      }}\n                                      data-testid={`button-submit-complete-${job.id}`}\n                                    >\n                                      {completeOfflineJob.isPending ? \"Completing...\" : \"Complete Job\"}\n                                    </Button>\n                                  </div>\n                                </div>\n                              ) : (\n                                <Button\n                                  onClick={() => setCompletingOfflineJobId(job.id)}\n                                  className=\"w-full\"\n                                  data-testid={`button-complete-offline-${job.id}`}\n                                >\n                                  <Upload className=\"h-4 w-4 mr-2\" />\n                                  Upload Photo to Complete\n                                </Button>\n                              )}\n                            </div>\n                          )}\n                          \n                          {/* Show completion photo for completed jobs */}\n                          {job.status === 'completed' && job.completionPhotoUrl && (\n                            <div className=\"border-t pt-3 mt-3\">\n                              <p className=\"text-xs text-muted-foreground mb-2\">Completion Photo:</p>\n                              <img \n                                src={job.completionPhotoUrl} \n                                alt=\"Completion\" \n                                className=\"w-full h-32 object-cover rounded-lg\"\n                              />\n                              {job.completedAt && (\n                                <p className=\"text-xs text-muted-foreground mt-2\">\n                                  Completed: {new Date(job.completedAt).toLocaleString('en-AE', { \n                                    timeZone: 'Asia/Dubai',\n                                    dateStyle: 'medium',\n                                    timeStyle: 'short'\n                                  })}\n                                </p>\n                              )}\n                            </div>\n                          )}\n                        </CardContent>\n                      </Card>\n                    </motion.div>\n                  ))\n                )}\n              </AnimatePresence>\n            </TabsContent>\n          </Tabs>\n        </div>\n      </div>\n\n      {/* QR Code Payment Modal */}\n      <Dialog open={showQRModal} onOpenChange={setShowQRModal}>\n        <DialogContent className=\"max-w-md\">\n          <DialogHeader>\n            <DialogTitle>Payment QR Code</DialogTitle>\n            <DialogDescription>\n              Customers can scan this QR code to pay and auto-assign the job to you\n            </DialogDescription>\n          </DialogHeader>\n          \n          {paymentQRData && (\n            <div className=\"space-y-4\">\n              <div className=\"flex justify-center p-6 bg-white rounded-lg\">\n                <QRCodeComponent \n                  value={`${window.location.origin}/customer/pay/${paymentQRData.token}`}\n                  size={256}\n                  data-testid=\"qr-code\"\n                />\n              </div>\n              \n              <div className=\"space-y-2\">\n                <div className=\"flex items-center justify-between p-3 rounded-lg bg-muted/50\">\n                  <span className=\"text-sm text-muted-foreground\">Expires:</span>\n                  <span className=\"text-sm font-medium\">\n                    {new Date(paymentQRData.expiresAt).toLocaleString('en-AE', { \n                      timeZone: 'Asia/Dubai',\n                      dateStyle: 'short',\n                      timeStyle: 'short'\n                    })}\n                  </span>\n                </div>\n                \n                <Button\n                  onClick={handleCopyPaymentLink}\n                  variant=\"outline\"\n                  className=\"w-full\"\n                  data-testid=\"button-copy-link\"\n                >\n                  <Copy className=\"h-4 w-4 mr-2\" />\n                  Copy Payment Link\n                </Button>\n              </div>\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n\n      {/* Offline Job Modal */}\n      <Dialog open={showOfflineJobModal} onOpenChange={setShowOfflineJobModal}>\n        <DialogContent className=\"max-w-md\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <Wallet className=\"h-5 w-5 text-primary\" />\n              Start Cash Job\n            </DialogTitle>\n            <DialogDescription>\n              Record a job - upload photo when complete to finish\n            </DialogDescription>\n          </DialogHeader>\n          \n          <div className=\"space-y-4\">\n            {/* Car Plate */}\n            <div className=\"space-y-2\">\n              <Label>Car Plate</Label>\n              <div className=\"grid grid-cols-3 gap-2\">\n                <Select\n                  value={offlineJobForm.carPlateEmirate}\n                  onValueChange={(value) => setOfflineJobForm(prev => ({ ...prev, carPlateEmirate: value }))}\n                >\n                  <SelectTrigger data-testid=\"select-emirate-offline\">\n                    <SelectValue placeholder=\"Emirate\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {UAE_EMIRATES.map((emirate) => (\n                      <SelectItem key={emirate} value={emirate}>{emirate}</SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n                <Select\n                  value={offlineJobForm.carPlateCode}\n                  onValueChange={(value) => setOfflineJobForm(prev => ({ ...prev, carPlateCode: value }))}\n                >\n                  <SelectTrigger data-testid=\"select-code-offline\">\n                    <SelectValue placeholder=\"Code\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {PLATE_CODES.map((code) => (\n                      <SelectItem key={code} value={code}>{code}</SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n                <Input\n                  placeholder=\"Number\"\n                  value={offlineJobForm.carPlateNumber}\n                  onChange={(e) => setOfflineJobForm(prev => ({ ...prev, carPlateNumber: e.target.value }))}\n                  data-testid=\"input-number-offline\"\n                />\n              </div>\n            </div>\n\n            {/* Notes */}\n            <div className=\"space-y-2\">\n              <Label>Notes (optional)</Label>\n              <Textarea\n                placeholder=\"Any additional notes...\"\n                value={offlineJobForm.notes}\n                onChange={(e) => setOfflineJobForm(prev => ({ ...prev, notes: e.target.value }))}\n                data-testid=\"input-notes-offline\"\n              />\n            </div>\n          </div>\n\n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={() => setShowOfflineJobModal(false)}\n              data-testid=\"button-cancel-offline\"\n            >\n              Cancel\n            </Button>\n            <Button\n              onClick={() => createOfflineJob.mutate(offlineJobForm)}\n              disabled={!offlineJobForm.carPlateEmirate || !offlineJobForm.carPlateCode || !offlineJobForm.carPlateNumber || createOfflineJob.isPending}\n              data-testid=\"button-submit-offline\"\n            >\n              {createOfflineJob.isPending ? \"Starting...\" : \"Start Job\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Edit Plate Modal (for QR-paid jobs) */}\n      <Dialog open={showEditPlateModal} onOpenChange={setShowEditPlateModal}>\n        <DialogContent className=\"max-w-md\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <Edit className=\"h-5 w-5 text-primary\" />\n              Update Car Plate\n            </DialogTitle>\n            <DialogDescription>\n              Enter the actual car plate number for this QR-scanned job\n            </DialogDescription>\n          </DialogHeader>\n          \n          <div className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label>Car Plate</Label>\n              <div className=\"grid grid-cols-3 gap-2\">\n                <Select\n                  value={editPlateForm.carPlateEmirate}\n                  onValueChange={(value) => setEditPlateForm(prev => ({ ...prev, carPlateEmirate: value }))}\n                >\n                  <SelectTrigger data-testid=\"select-emirate-edit\">\n                    <SelectValue placeholder=\"Emirate\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"Dubai\">Dubai</SelectItem>\n                    <SelectItem value=\"Abu Dhabi\">Abu Dhabi</SelectItem>\n                    <SelectItem value=\"Sharjah\">Sharjah</SelectItem>\n                    <SelectItem value=\"Ajman\">Ajman</SelectItem>\n                    <SelectItem value=\"RAK\">RAK</SelectItem>\n                    <SelectItem value=\"Fujairah\">Fujairah</SelectItem>\n                    <SelectItem value=\"UAQ\">UAQ</SelectItem>\n                  </SelectContent>\n                </Select>\n                <Input\n                  placeholder=\"Code\"\n                  value={editPlateForm.carPlateCode}\n                  onChange={(e) => setEditPlateForm(prev => ({ ...prev, carPlateCode: e.target.value.toUpperCase() }))}\n                  data-testid=\"input-code-edit\"\n                />\n                <Input\n                  placeholder=\"Number\"\n                  value={editPlateForm.carPlateNumber}\n                  onChange={(e) => setEditPlateForm(prev => ({ ...prev, carPlateNumber: e.target.value }))}\n                  data-testid=\"input-number-edit\"\n                />\n              </div>\n            </div>\n          </div>\n\n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={() => setShowEditPlateModal(false)}\n            >\n              Cancel\n            </Button>\n            <Button\n              onClick={() => editingJobId && updateJobPlate.mutate({\n                jobId: editingJobId,\n                ...editPlateForm,\n              })}\n              disabled={!editPlateForm.carPlateNumber || updateJobPlate.isPending}\n              data-testid=\"button-submit-edit-plate\"\n            >\n              {updateJobPlate.isPending ? \"Updating...\" : \"Update Plate\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n\nfunction JobCard({ job, action, onEditPlate }: { job: Job; action: React.ReactNode; onEditPlate?: (jobId: number) => void }) {\n  const isQRScannedJob = job.carPlateNumber?.startsWith('QR-ANON') || job.carPlateNumber?.startsWith('QR_SCAN');\n  const getProgressStage = (status: JobStatus) => {\n    switch (status) {\n      case JobStatus.PAID:\n        return 1;\n      case JobStatus.ASSIGNED:\n        return 2;\n      case JobStatus.IN_PROGRESS:\n        return 3;\n      case JobStatus.COMPLETED:\n        return 4;\n      default:\n        return 0;\n    }\n  };\n\n  const getStatusColor = (status: JobStatus) => {\n    switch (status) {\n      case JobStatus.PAID:\n        return \"bg-blue-500\";\n      case JobStatus.ASSIGNED:\n        return \"bg-yellow-500\";\n      case JobStatus.IN_PROGRESS:\n        return \"bg-orange-500\";\n      case JobStatus.COMPLETED:\n        return \"bg-green-500\";\n      default:\n        return \"bg-muted\";\n    }\n  };\n\n  const getStatusLabel = (status: JobStatus) => {\n    switch (status) {\n      case JobStatus.PAID:\n        return \"New Job\";\n      case JobStatus.ASSIGNED:\n        return \"Assigned\";\n      case JobStatus.IN_PROGRESS:\n        return \"In Progress\";\n      case JobStatus.COMPLETED:\n        return \"Completed\";\n      default:\n        return status;\n    }\n  };\n\n  const stage = getProgressStage(job.status as JobStatus);\n  const stages = [\n    { id: 1, label: \"New\", icon: Car },\n    { id: 2, label: \"Assigned\", icon: User },\n    { id: 3, label: \"Cleaning\", icon: Timer },\n    { id: 4, label: \"Done\", icon: CheckCircle2 },\n  ];\n\n  const formatPhoneForWhatsApp = (phone: string) => {\n    const cleaned = phone.replace(/\\D/g, '');\n    return cleaned.startsWith('971') ? cleaned : `971${cleaned}`;\n  };\n\n  return (\n    <Card className=\"overflow-hidden border-primary/20 shadow-lg\">\n      {/* Payout Banner - Most Prominent */}\n      <div className=\"bg-gradient-to-r from-primary to-primary/80 p-6 text-white\">\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center gap-3\">\n            <div className=\"h-14 w-14 rounded-full bg-white/20 flex items-center justify-center backdrop-blur-sm\">\n              <DollarSign className=\"h-7 w-7\" />\n            </div>\n            <div>\n              <p className=\"text-sm opacity-90\">Your Earnings</p>\n              <motion.p \n                initial={{ scale: 0.8 }}\n                animate={{ scale: 1 }}\n                className=\"text-4xl font-bold\"\n              >\n                {(parseFloat(job.price) + parseFloat(job.tipAmount || \"0\")).toFixed(2)} AED\n              </motion.p>\n              {parseFloat(job.tipAmount || \"0\") > 0 && (\n                <p className=\"text-xs opacity-80 mt-1\">\n                  Base: {job.price} AED + Tip: {job.tipAmount} AED\n                </p>\n              )}\n            </div>\n          </div>\n          <Badge \n            className={`${getStatusColor(job.status as JobStatus)} text-white border-0 px-3 py-2 text-sm shadow-lg`}\n          >\n            {getStatusLabel(job.status as JobStatus)}\n          </Badge>\n        </div>\n      </div>\n\n      {/* Progress Indicator */}\n      <div className=\"bg-gradient-to-r from-primary/10 to-primary/5 p-4\">\n        <div className=\"relative\">\n          <div className=\"absolute top-5 left-0 right-0 h-1 bg-muted rounded-full\">\n            <motion.div \n              initial={{ width: 0 }}\n              animate={{ width: `${((stage - 1) / 3) * 100}%` }}\n              transition={{ duration: 0.5 }}\n              className=\"h-full bg-primary rounded-full\"\n            />\n          </div>\n\n          <div className=\"relative flex justify-between\">\n            {stages.map((s) => {\n              const Icon = s.icon;\n              const isActive = stage >= s.id;\n              const isCurrent = stage === s.id;\n              \n              return (\n                <div key={s.id} className=\"flex flex-col items-center gap-2\">\n                  <motion.div\n                    initial={{ scale: 0.8, opacity: 0 }}\n                    animate={{ scale: 1, opacity: 1 }}\n                    transition={{ delay: s.id * 0.1 }}\n                    className={`h-10 w-10 rounded-full flex items-center justify-center transition-all ${\n                      isActive\n                        ? \"bg-primary text-white shadow-lg\"\n                        : \"bg-muted text-muted-foreground\"\n                    } ${isCurrent ? \"ring-4 ring-primary/30 scale-110\" : \"\"}`}\n                  >\n                    <Icon className=\"h-5 w-5\" />\n                  </motion.div>\n                  <span className={`text-xs font-medium ${isActive ? \"text-foreground\" : \"text-muted-foreground\"}`}>\n                    {s.label}\n                  </span>\n                </div>\n              );\n            })}\n          </div>\n        </div>\n      </div>\n\n      <CardContent className=\"space-y-4 pt-6\">\n        {/* Car Info */}\n        <div className=\"flex items-center gap-3 p-3 rounded-lg bg-muted/50\">\n          <div className=\"h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center\">\n            <Car className=\"h-5 w-5 text-primary\" />\n          </div>\n          <div className=\"flex-1\">\n            <p className=\"text-xs text-muted-foreground\">Car Plate</p>\n            <p className=\"font-bold text-lg\">{job.carPlateNumber}</p>\n          </div>\n          {isQRScannedJob && onEditPlate && (\n            <Button\n              size=\"sm\"\n              variant=\"outline\"\n              onClick={() => onEditPlate(job.id)}\n              className=\"shrink-0\"\n              data-testid={`button-edit-plate-${job.id}`}\n            >\n              <Edit className=\"h-4 w-4 mr-1\" />\n              Update\n            </Button>\n          )}\n        </div>\n\n        {/* Location with Navigation */}\n        <div className=\"space-y-2\">\n          <div className=\"flex items-start gap-3 p-3 rounded-lg bg-muted/50\">\n            <div className=\"h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center shrink-0\">\n              <MapPin className=\"h-5 w-5 text-primary\" />\n            </div>\n            <div className=\"flex-1\">\n              <p className=\"text-xs text-muted-foreground\">Location</p>\n              <p className=\"font-medium\">{job.locationAddress}</p>\n            </div>\n          </div>\n          {job.locationLatitude && job.locationLongitude && (\n            <Button\n              size=\"lg\"\n              variant=\"outline\"\n              className=\"w-full min-h-12 border-2 border-primary/20 hover:bg-primary/5\"\n              onClick={() => {\n                const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${job.locationLatitude},${job.locationLongitude}`;\n                window.open(googleMapsUrl, \"_blank\");\n              }}\n              data-testid={`button-navigate-${job.id}`}\n            >\n              <Navigation className=\"h-5 w-5 mr-2 text-primary\" />\n              <span className=\"font-bold\">Navigate with Google Maps</span>\n            </Button>\n          )}\n        </div>\n\n        {/* Parking */}\n        {job.parkingNumber && (\n          <div className=\"flex items-center gap-3 p-3 rounded-lg bg-muted/50\">\n            <div className=\"h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center\">\n              <Building2 className=\"h-5 w-5 text-primary\" />\n            </div>\n            <div className=\"flex-1\">\n              <p className=\"text-xs text-muted-foreground\">Parking Number</p>\n              <p className=\"font-bold text-lg\">{job.parkingNumber}</p>\n            </div>\n          </div>\n        )}\n\n        {/* Customer Contact */}\n        <div className=\"space-y-2\">\n          <div className=\"flex items-center gap-3 p-3 rounded-lg bg-muted/50\">\n            <div className=\"h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center\">\n              <Phone className=\"h-5 w-5 text-primary\" />\n            </div>\n            <div className=\"flex-1\">\n              <p className=\"text-xs text-muted-foreground\">Customer Phone</p>\n              <p className=\"font-bold\">{job.customerPhone}</p>\n            </div>\n          </div>\n          \n          {/* Contact Buttons */}\n          <div className=\"grid grid-cols-2 gap-2\">\n            <Button\n              size=\"lg\"\n              variant=\"outline\"\n              className=\"min-h-12 border-2 border-primary/20 hover:bg-primary/5\"\n              onClick={() => {\n                window.location.href = `tel:${job.customerPhone}`;\n              }}\n              data-testid={`button-call-${job.id}`}\n            >\n              <Phone className=\"h-4 w-4 mr-2\" />\n              <span className=\"font-bold\">Call</span>\n            </Button>\n            <Button\n              size=\"lg\"\n              variant=\"outline\"\n              className=\"min-h-12 border-2 border-green-500/20 hover:bg-green-500/5\"\n              onClick={() => {\n                if (!job.customerPhone) return;\n                const whatsappNumber = formatPhoneForWhatsApp(job.customerPhone);\n                const message = encodeURIComponent(`Hi, I'm your car cleaner for ${job.carPlateNumber}. I'll be there soon!`);\n                window.open(`https://wa.me/${whatsappNumber}?text=${message}`, \"_blank\");\n              }}\n              data-testid={`button-whatsapp-${job.id}`}\n            >\n              <MessageCircle className=\"h-4 w-4 mr-2 text-green-600\" />\n              <span className=\"font-bold text-green-600\">WhatsApp</span>\n            </Button>\n          </div>\n        </div>\n      </CardContent>\n      \n      <CardFooter className=\"bg-muted/30 p-4\">\n        {action}\n      </CardFooter>\n    </Card>\n  );\n}\n","path":null,"size_bytes":58184,"size_tokens":null},"client/src/components/ui/switch.tsx":{"content":"import * as React from \"react\"\nimport * as SwitchPrimitives from \"@radix-ui/react-switch\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Switch = React.forwardRef<\n  React.ElementRef<typeof SwitchPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>\n>(({ className, ...props }, ref) => (\n  <SwitchPrimitives.Root\n    className={cn(\n      \"peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  >\n    <SwitchPrimitives.Thumb\n      className={cn(\n        \"pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0\"\n      )}\n    />\n  </SwitchPrimitives.Root>\n))\nSwitch.displayName = SwitchPrimitives.Root.displayName\n\nexport { Switch }\n","path":null,"size_bytes":1139,"size_tokens":null},"server/routes.ts":{"content":"import type { Express, Request, Response } from \"express\";\nimport { createServer, type Server } from \"http\";\nimport express from \"express\";\nimport Stripe from \"stripe\";\nimport multer from \"multer\";\nimport path from \"path\";\nimport { mkdir, mkdirSync, existsSync, createReadStream } from \"fs\";\nimport crypto from \"crypto\";\nimport ExcelJS from \"exceljs\";\nimport bcrypt from \"bcryptjs\";\nimport PDFDocument from \"pdfkit\";\nimport passport from \"./auth\";\nimport { storage } from \"./storage\";\nimport { sessionStore } from \"./session-store\";\nimport { requireAuth, requireRole, optionalAuth, requireActiveCleaner } from \"./middleware\";\nimport { sendEmail } from \"./lib/resend\";\nimport { broadcastJobUpdate } from \"./websocket\";\nimport { createJobFinancialRecord, calculateJobFees } from \"./financialUtils\";\nimport { PushNotificationService } from \"./push-service\";\nimport { generateReceipt, generateReceiptNumber } from \"./utils/receiptGenerator\";\nimport { \n  JobStatus, \n  CleanerStatus, \n  UserRole,\n  type Company,\n  type Cleaner,\n  type Job,\n} from \"@shared/schema\";\n\n// Configure multer for file uploads\nconst uploadDir = path.join(process.cwd(), \"uploads\");\n\nconst storageConfig = multer.diskStorage({\n  destination: (req, file, cb) => {\n    let subDir = \"proofs\";\n    if (file.fieldname === \"tradeLicense\") {\n      subDir = \"licenses\";\n    } else if (file.fieldname === \"logo\") {\n      subDir = \"logos\";\n    } else if (file.fieldname === \"file\" && req.path.includes(\"invoice\")) {\n      subDir = \"invoices\";\n    }\n    const fullPath = path.join(uploadDir, subDir);\n    mkdirSync(fullPath, { recursive: true });\n    cb(null, fullPath);\n  },\n  filename: (req, file, cb) => {\n    const uniqueSuffix = `${Date.now()}-${Math.round(Math.random() * 1E9)}`;\n    cb(null, `${uniqueSuffix}-${file.originalname}`);\n  },\n});\n\nconst upload = multer({ \n  storage: storageConfig,\n  limits: {\n    fileSize: 5 * 1024 * 1024, // 5MB limit\n  },\n  fileFilter: (req, file, cb) => {\n    const allowedTypes = [\"image/jpeg\", \"image/png\", \"image/webp\", \"application/pdf\"];\n    if (allowedTypes.includes(file.mimetype)) {\n      cb(null, true);\n    } else {\n      cb(new Error(\"Invalid file type. Only JPEG, PNG, WebP, and PDF are allowed.\"));\n    }\n  },\n});\n\n// Stripe setup\nif (!process.env.STRIPE_SECRET_KEY) {\n  throw new Error('Missing required Stripe secret: STRIPE_SECRET_KEY');\n}\nconst stripe = new Stripe(process.env.STRIPE_SECRET_KEY, {\n  apiVersion: \"2025-10-29.clover\",\n});\n\n// Helper function: Point in polygon algorithm (ray casting)\nfunction isPointInPolygon(lat: number, lon: number, polygon: Array<[number, number]>): boolean {\n  let inside = false;\n  const n = polygon.length;\n  \n  for (let i = 0, j = n - 1; i < n; j = i++) {\n    const [lat1, lon1] = polygon[i];\n    const [lat2, lon2] = polygon[j];\n    \n    const intersect = ((lon1 > lon) !== (lon2 > lon)) &&\n      (lat < (lat2 - lat1) * (lon - lon1) / (lon2 - lon1) + lat1);\n    \n    if (intersect) {\n      inside = !inside;\n    }\n  }\n  \n  return inside;\n}\n\n// Helper function: Generate email HTML for job status updates\nfunction generateJobStatusEmailHTML(params: {\n  carPlateNumber: string;\n  status: string;\n  jobId: number;\n  companyName: string;\n  cleanerName?: string;\n  completedAt?: Date;\n}): string {\n  const { carPlateNumber, status, jobId, companyName, cleanerName, completedAt } = params;\n\n  const statusMessages: Record<string, { title: string; message: string; color: string }> = {\n    paid: {\n      title: '✅ Payment Confirmed',\n      message: 'Your payment has been received. We\\'re finding a cleaner for you!',\n      color: '#10B981'\n    },\n    assigned: {\n      title: '👨‍🔧 Cleaner Assigned',\n      message: cleanerName\n        ? `${cleanerName} has been assigned to your car wash.`\n        : 'A cleaner has been assigned to your car wash.',\n      color: '#3B82F6'\n    },\n    in_progress: {\n      title: '🚿 Wash in Progress',\n      message: cleanerName\n        ? `${cleanerName} is now washing your car.`\n        : 'Your car wash is in progress.',\n      color: '#8B5CF6'\n    },\n    completed: {\n      title: '✨ Wash Completed',\n      message: 'Your car wash is complete! Thank you for using Washapp.ae. Your receipt is attached.',\n      color: '#059669'\n    },\n    refunded: {\n      title: '💰 Refund Processed',\n      message: 'Your payment has been refunded. We apologize for any inconvenience.',\n      color: '#DC2626'\n    }\n  };\n\n  const statusInfo = statusMessages[status] || {\n    title: 'Job Update',\n    message: `Your car wash status has been updated to: ${status}`,\n    color: '#6B7280'\n  };\n\n  return `\n    <!DOCTYPE html>\n    <html>\n    <head>\n      <meta charset=\"utf-8\">\n      <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n      <title>${statusInfo.title}</title>\n    </head>\n    <body style=\"margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6;\">\n      <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background-color: #f3f4f6; padding: 40px 20px;\">\n        <tr>\n          <td align=\"center\">\n            <table width=\"600\" cellpadding=\"0\" cellspacing=\"0\" style=\"background-color: #ffffff; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);\">\n              <tr>\n                <td style=\"background: linear-gradient(135deg, #1E40AF 0%, #3B82F6 100%); padding: 40px 30px; text-align: center;\">\n                  <h1 style=\"margin: 0; color: #ffffff; font-size: 32px; font-weight: bold;\">Washapp.ae</h1>\n                </td>\n              </tr>\n              <tr>\n                <td style=\"padding: 30px 30px 20px 30px; text-align: center;\">\n                  <div style=\"display: inline-block; background-color: ${statusInfo.color}; color: #ffffff; padding: 12px 24px; border-radius: 24px; font-size: 18px; font-weight: 600;\">\n                    ${statusInfo.title}\n                  </div>\n                </td>\n              </tr>\n              <tr>\n                <td style=\"padding: 0 30px 30px 30px; text-align: center;\">\n                  <p style=\"margin: 0; font-size: 16px; color: #4b5563; line-height: 1.6;\">\n                    ${statusInfo.message}\n                  </p>\n                </td>\n              </tr>\n              <tr>\n                <td style=\"padding: 0 30px 30px 30px;\">\n                  <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background-color: #f9fafb; border-radius: 8px; padding: 20px;\">\n                    <tr>\n                      <td style=\"padding: 8px 0;\">\n                        <span style=\"color: #6b7280; font-size: 14px;\">Job ID:</span>\n                        <span style=\"color: #111827; font-size: 14px; font-weight: 600; float: right;\">#${jobId}</span>\n                      </td>\n                    </tr>\n                    <tr>\n                      <td style=\"padding: 8px 0; border-top: 1px solid #e5e7eb;\">\n                        <span style=\"color: #6b7280; font-size: 14px;\">Car Plate:</span>\n                        <span style=\"color: #111827; font-size: 14px; font-weight: 600; float: right;\">${carPlateNumber}</span>\n                      </td>\n                    </tr>\n                    <tr>\n                      <td style=\"padding: 8px 0; border-top: 1px solid #e5e7eb;\">\n                        <span style=\"color: #6b7280; font-size: 14px;\">Company:</span>\n                        <span style=\"color: #111827; font-size: 14px; font-weight: 600; float: right;\">${companyName}</span>\n                      </td>\n                    </tr>\n                    ${completedAt ? `\n                    <tr>\n                      <td style=\"padding: 8px 0; border-top: 1px solid #e5e7eb;\">\n                        <span style=\"color: #6b7280; font-size: 14px;\">Completed At:</span>\n                        <span style=\"color: #111827; font-size: 14px; font-weight: 600; float: right;\">${new Date(completedAt).toLocaleString('en-AE')}</span>\n                      </td>\n                    </tr>\n                    ` : ''}\n                  </table>\n                </td>\n              </tr>\n              <tr>\n                <td style=\"padding: 30px; text-align: center; border-top: 1px solid #e5e7eb;\">\n                  <p style=\"margin: 0; font-size: 14px; color: #6b7280;\">\n                    Thank you for choosing Washapp.ae\n                  </p>\n                  <p style=\"margin: 10px 0 0 0; font-size: 12px; color: #9ca3af;\">\n                    This is an automated email. Please do not reply.\n                  </p>\n                </td>\n              </tr>\n            </table>\n          </td>\n        </tr>\n      </table>\n    </body>\n    </html>\n  `;\n}\n\n// Helper function: Send job status email notification\nasync function sendJobStatusEmail(job: Job, company: Company, status: string, cleanerName?: string) {\n  if (!job.customerEmail) {\n    return; // Skip if no email provided\n  }\n\n  try {\n    const fullPlateNumber = job.carPlateEmirate && job.carPlateCode\n      ? `${job.carPlateEmirate} ${job.carPlateCode} ${job.carPlateNumber}`\n      : job.carPlateNumber;\n\n    const emailHTML = generateJobStatusEmailHTML({\n      carPlateNumber: fullPlateNumber,\n      status,\n      jobId: job.id,\n      companyName: company.name,\n      cleanerName,\n      completedAt: job.completedAt || undefined,\n    });\n\n    const statusTitles: Record<string, string> = {\n      paid: 'Payment Confirmed',\n      assigned: 'Cleaner Assigned',\n      in_progress: 'Wash in Progress',\n      completed: 'Wash Completed',\n      refunded: 'Refund Processed'\n    };\n\n    const subject = `${statusTitles[status] || 'Job Update'} - ${fullPlateNumber}`;\n\n    // If completed, attach the receipt\n    let attachments = undefined;\n    if (status === 'completed' && job.receiptNumber) {\n      const receiptPath = path.join(process.cwd(), 'uploads', 'receipts', `receipt-${job.receiptNumber}.pdf`);\n      attachments = [\n        {\n          filename: `receipt-${job.receiptNumber}.pdf`,\n          path: receiptPath,\n        }\n      ];\n    }\n\n    await sendEmail(job.customerEmail, subject, emailHTML, attachments);\n  } catch (error) {\n    console.error('Failed to send job status email:', error);\n  }\n}\n\nexport async function registerRoutes(app: Express): Promise<Server> {\n  \n  // Global middleware: Add no-cache headers to ALL API responses\n  app.use('/api/*', (req: Request, res: Response, next) => {\n    res.set('Cache-Control', 'no-store, no-cache, must-revalidate, proxy-revalidate');\n    res.set('Pragma', 'no-cache');\n    res.set('Expires', '0');\n    res.set('Surrogate-Control', 'no-store');\n    next();\n  });\n  \n  // Ensure upload directory exists\n  mkdirSync(uploadDir, { recursive: true });\n  \n  // Serve uploaded files statically\n  app.use(\"/uploads\", express.static(uploadDir));\n  \n  // ===== FILE UPLOAD ROUTES =====\n  \n  // Upload trade license document (requires company admin auth)\n  app.post(\"/api/upload/trade-license\", requireRole(UserRole.COMPANY_ADMIN), upload.single(\"tradeLicense\"), async (req: Request, res: Response) => {\n    try {\n      if (!req.file) {\n        return res.status(400).json({ message: \"No file uploaded\" });\n      }\n      \n      const fileUrl = `/uploads/licenses/${req.file.filename}`;\n      res.json({ url: fileUrl });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n  \n  // Upload job completion proof photo (requires cleaner auth)\n  app.post(\"/api/upload/proof-photo\", requireRole(UserRole.CLEANER), upload.single(\"proofPhoto\"), async (req: Request, res: Response) => {\n    try {\n      if (!req.file) {\n        return res.status(400).json({ message: \"No file uploaded\" });\n      }\n      \n      const fileUrl = `/uploads/proofs/${req.file.filename}`;\n      res.json({ url: fileUrl });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n  \n  // Upload platform logo (requires admin auth)\n  app.post(\"/api/upload/logo\", requireRole(UserRole.ADMIN), upload.single(\"logo\"), async (req: Request, res: Response) => {\n    try {\n      if (!req.file) {\n        return res.status(400).json({ message: \"No file uploaded\" });\n      }\n      \n      const fileUrl = `/uploads/logos/${req.file.filename}`;\n      res.json({ url: fileUrl });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n  \n  // Upload invoice for withdrawal request (requires company admin auth)\n  app.post(\"/api/upload-invoice\", requireRole(UserRole.COMPANY_ADMIN), upload.single(\"file\"), async (req: Request, res: Response) => {\n    try {\n      if (!req.file) {\n        return res.status(400).json({ message: \"No file uploaded\" });\n      }\n      \n      const fileUrl = `/uploads/invoices/${req.file.filename}`;\n      res.json({ url: fileUrl });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n  \n  // ===== LOCATION SEARCH ROUTES =====\n  \n  // Serve dynamic PWA manifest with uploaded logo (public endpoint)\n  app.get(\"/manifest.json\", async (req: Request, res: Response) => {\n    try {\n      const settings = await storage.getAllPlatformSettings();\n      const platformSettings = settings[0] || {\n        companyName: 'Washapp.ae',\n        logoUrl: null,\n      };\n\n      // Default icons (always available as fallback)\n      const defaultIcons = [\n        {\n          src: \"/icon-192.png\",\n          sizes: \"192x192\",\n          type: \"image/png\",\n          purpose: \"any maskable\"\n        },\n        {\n          src: \"/icon-512.png\",\n          sizes: \"512x512\",\n          type: \"image/png\",\n          purpose: \"any maskable\"\n        }\n      ];\n\n      // If a custom logo is uploaded, use it for all icon sizes\n      // Otherwise, fall back to default icons\n      const icons = platformSettings.logoUrl ? [\n        {\n          src: platformSettings.logoUrl,\n          sizes: \"192x192\",\n          type: \"image/png\",\n          purpose: \"any maskable\"\n        },\n        {\n          src: platformSettings.logoUrl,\n          sizes: \"512x512\",\n          type: \"image/png\",\n          purpose: \"any maskable\"\n        }\n      ] : defaultIcons;\n\n      const manifest = {\n        name: platformSettings.companyName || \"Washapp.ae\",\n        short_name: platformSettings.companyName || \"Washapp.ae\",\n        description: \"Professional car wash booking platform - Book cleaners, manage jobs, track payments\",\n        start_url: \"/\",\n        display: \"standalone\",\n        background_color: \"#ffffff\",\n        theme_color: \"#000000\",\n        orientation: \"portrait\",\n        icons,\n        categories: [\"business\", \"productivity\"],\n        screenshots: []\n      };\n\n      res.set('Content-Type', 'application/manifest+json');\n      res.json(manifest);\n    } catch (error: any) {\n      console.error(\"Error generating manifest:\", error);\n      \n      // On error, return a valid manifest with default icons\n      const fallbackManifest = {\n        name: \"Washapp.ae\",\n        short_name: \"Washapp.ae\",\n        description: \"Professional car wash booking platform - Book cleaners, manage jobs, track payments\",\n        start_url: \"/\",\n        display: \"standalone\",\n        background_color: \"#ffffff\",\n        theme_color: \"#000000\",\n        orientation: \"portrait\",\n        icons: [\n          {\n            src: \"/icon-192.png\",\n            sizes: \"192x192\",\n            type: \"image/png\",\n            purpose: \"any maskable\"\n          },\n          {\n            src: \"/icon-512.png\",\n            sizes: \"512x512\",\n            type: \"image/png\",\n            purpose: \"any maskable\"\n          }\n        ],\n        categories: [\"business\", \"productivity\"],\n        screenshots: []\n      };\n      \n      res.set('Content-Type', 'application/manifest+json');\n      res.json(fallbackManifest);\n    }\n  });\n\n  // Search locations using Nominatim API (public endpoint)\n  app.get(\"/api/location/search\", async (req: Request, res: Response) => {\n    try {\n      const { q } = req.query;\n      \n      if (!q || typeof q !== 'string' || q.trim().length === 0) {\n        return res.status(400).json({ message: \"Search query 'q' is required\" });\n      }\n\n      // Make request to Nominatim API with English language\n      const nominatimUrl = `https://nominatim.openstreetmap.org/search?` + \n        `format=json&` +\n        `q=${encodeURIComponent(q.trim())}&` +\n        `limit=10&` +\n        `addressdetails=1&` +\n        `accept-language=en`;\n\n      const response = await fetch(nominatimUrl, {\n        headers: {\n          'User-Agent': 'Washapp.ae/1.0',\n          'Accept-Language': 'en',\n        },\n      });\n\n      if (!response.ok) {\n        throw new Error(`Nominatim API error: ${response.statusText}`);\n      }\n\n      const data = await response.json();\n      res.json(data);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n  \n  // ===== AUTHENTICATION ROUTES =====\n  \n  // Login\n  app.post(\"/api/auth/login\", (req, res, next) => {\n    passport.authenticate(\"local\", (err: any, user: any, info: any) => {\n      if (err) {\n        return res.status(500).json({ message: err.message });\n      }\n      if (!user) {\n        return res.status(401).json({ message: info?.message || \"Invalid credentials\" });\n      }\n      req.logIn(user, (err) => {\n        if (err) {\n          return res.status(500).json({ message: err.message });\n        }\n        return res.json({ user });\n      });\n    })(req, res, next);\n  });\n  \n  // Logout (with auto shift end for cleaners)\n  app.post(\"/api/auth/logout\", async (req, res) => {\n    try {\n      // End active shift if user is a cleaner\n      if (req.user && req.user.role === UserRole.CLEANER) {\n        const cleaner = await storage.getCleanerByUserId(req.user.id);\n        if (cleaner) {\n          const activeShift = await storage.getActiveShift(cleaner.id);\n          if (activeShift) {\n            await storage.endShift(cleaner.id);\n          }\n        }\n      }\n      \n      req.logout((err) => {\n        if (err) {\n          return res.status(500).json({ message: err.message });\n        }\n        res.json({ success: true });\n      });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n  \n  // Get current user\n  app.get(\"/api/auth/me\", (req, res) => {\n    if (req.isAuthenticated()) {\n      res.json({ user: req.user });\n    } else {\n      res.json({ user: null });\n    }\n  });\n  \n  // Password reset - Request reset\n  app.post(\"/api/auth/forgot-password\", async (req: Request, res: Response) => {\n    try {\n      const { email } = req.body;\n      \n      if (!email) {\n        return res.status(400).json({ message: \"Email is required\" });\n      }\n      \n      // Find user by email\n      const user = await storage.getUserByEmail(email);\n      \n      // Don't reveal if user exists or not (security best practice)\n      if (!user) {\n        return res.json({ message: \"If an account exists with this email, you will receive a password reset link.\" });\n      }\n      \n      // Generate secure random token\n      const crypto = await import('crypto');\n      const token = crypto.randomBytes(32).toString('hex');\n      \n      // Token expires in 1 hour\n      const expiresAt = new Date(Date.now() + 60 * 60 * 1000);\n      \n      // Store token in database\n      await storage.createPasswordResetToken(user.id, token, expiresAt);\n      \n      // Get reset URL (use frontend URL)\n      const resetUrl = `${req.protocol}://${req.get('host')}/reset-password?token=${token}`;\n      \n      // Send email with reset link\n      const emailHtml = `\n        <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;\">\n          <h2 style=\"color: #0ea5e9;\">Password Reset Request</h2>\n          <p>Hello ${user.displayName},</p>\n          <p>We received a request to reset your password. Click the button below to create a new password:</p>\n          <div style=\"text-align: center; margin: 30px 0;\">\n            <a href=\"${resetUrl}\" style=\"background-color: #0ea5e9; color: white; padding: 12px 30px; text-decoration: none; border-radius: 6px; display: inline-block;\">Reset Password</a>\n          </div>\n          <p>This link will expire in 1 hour.</p>\n          <p>If you didn't request this password reset, you can safely ignore this email.</p>\n          <p style=\"color: #64748b; font-size: 12px; margin-top: 30px;\">\n            If the button doesn't work, copy and paste this link into your browser:<br>\n            ${resetUrl}\n          </p>\n        </div>\n      `;\n      \n      await sendEmail(\n        user.email,\n        \"Password Reset Request - Washapp.ae\",\n        emailHtml\n      );\n      \n      res.json({ message: \"If an account exists with this email, you will receive a password reset link.\" });\n    } catch (error: any) {\n      console.error(\"Forgot password error:\", error);\n      res.status(500).json({ message: \"Failed to process password reset request\" });\n    }\n  });\n  \n  // Password reset - Verify token\n  app.get(\"/api/auth/verify-reset-token/:token\", async (req: Request, res: Response) => {\n    try {\n      const { token } = req.params;\n      \n      const resetToken = await storage.getPasswordResetToken(token);\n      \n      if (!resetToken) {\n        return res.status(400).json({ valid: false, message: \"Invalid or expired reset token\" });\n      }\n      \n      // Check if token is expired\n      if (new Date() > resetToken.expiresAt) {\n        await storage.deletePasswordResetToken(token);\n        return res.status(400).json({ valid: false, message: \"Reset token has expired\" });\n      }\n      \n      res.json({ valid: true });\n    } catch (error: any) {\n      console.error(\"Verify token error:\", error);\n      res.status(500).json({ valid: false, message: \"Failed to verify reset token\" });\n    }\n  });\n  \n  // Password reset - Reset password\n  app.post(\"/api/auth/reset-password\", async (req: Request, res: Response) => {\n    try {\n      const { token, newPassword } = req.body;\n      \n      if (!token || !newPassword) {\n        return res.status(400).json({ message: \"Token and new password are required\" });\n      }\n      \n      if (newPassword.length < 6) {\n        return res.status(400).json({ message: \"Password must be at least 6 characters long\" });\n      }\n      \n      // Verify token\n      const resetToken = await storage.getPasswordResetToken(token);\n      \n      if (!resetToken) {\n        return res.status(400).json({ message: \"Invalid or expired reset token\" });\n      }\n      \n      // Check if token is expired\n      if (new Date() > resetToken.expiresAt) {\n        await storage.deletePasswordResetToken(token);\n        return res.status(400).json({ message: \"Reset token has expired\" });\n      }\n      \n      // Update user password\n      await storage.updateUserPassword(resetToken.userId, newPassword);\n      \n      // Delete the used token\n      await storage.deletePasswordResetToken(token);\n      \n      // Clean up any other expired tokens\n      await storage.deleteExpiredPasswordResetTokens();\n      \n      // Get user details for confirmation email\n      const user = await storage.getUser(resetToken.userId);\n      \n      if (user) {\n        // Send confirmation email\n        const emailHtml = `\n          <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;\">\n            <h2 style=\"color: #0ea5e9;\">Password Changed Successfully</h2>\n            <p>Hello ${user.displayName},</p>\n            <p>Your password has been successfully changed.</p>\n            <p>If you didn't make this change, please contact support immediately.</p>\n            <p style=\"color: #64748b; margin-top: 30px;\">\n              Thank you,<br>\n              Washapp.ae Team\n            </p>\n          </div>\n        `;\n        \n        await sendEmail(\n          user.email,\n          \"Password Changed - Washapp.ae\",\n          emailHtml\n        );\n      }\n      \n      res.json({ message: \"Password reset successful\" });\n    } catch (error: any) {\n      console.error(\"Reset password error:\", error);\n      res.status(500).json({ message: \"Failed to reset password\" });\n    }\n  });\n  \n  // ===== REGISTRATION ROUTES =====\n  \n  // Register platform admin\n  app.post(\"/api/auth/register/admin\", async (req: Request, res: Response) => {\n    try {\n      const { email, password, displayName } = req.body;\n      \n      // Check if user already exists\n      const existing = await storage.getUserByEmail(email);\n      if (existing) {\n        return res.status(400).json({ message: \"Email already registered\" });\n      }\n      \n      // Create admin user (password hashing handled by storage layer)\n      const user = await storage.createUser({\n        email,\n        password,\n        displayName,\n        role: UserRole.ADMIN,\n      });\n      \n      // Log in the user\n      req.login(user, (err) => {\n        if (err) {\n          return res.status(500).json({ message: err.message });\n        }\n        const { passwordHash, ...userWithoutPassword } = user;\n        res.json({ user: userWithoutPassword });\n      });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n  \n  // Register company admin (creates user + company)\n  app.post(\"/api/auth/register/company\", async (req: Request, res: Response) => {\n    try {\n      const { \n        email,\n        password,\n        displayName, \n        phoneNumber,\n        companyName, \n        companyDescription, \n        pricePerWash,\n        tradeLicenseNumber,\n        tradeLicenseDocumentURL,\n        packageType,\n        subscriptionCleanerSlots\n      } = req.body;\n      \n      // Check if user already exists\n      const existing = await storage.getUserByEmail(email);\n      if (existing) {\n        return res.status(400).json({ message: \"Email already registered\" });\n      }\n      \n      // Use transaction to ensure atomicity\n      const result = await storage.createCompanyWithAdmin({\n        email,\n        password,\n        displayName,\n        phoneNumber,\n        companyName,\n        companyDescription,\n        pricePerWash: parseFloat(pricePerWash),\n        tradeLicenseNumber,\n        tradeLicenseDocumentURL,\n        packageType,\n        subscriptionCleanerSlots,\n      });\n      \n      // Log in the user\n      req.login(result.user, (err) => {\n        if (err) {\n          return res.status(500).json({ message: err.message });\n        }\n        const { passwordHash, ...userWithoutPassword } = result.user;\n        res.json({ user: userWithoutPassword, company: result.company });\n      });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n  \n  // Validate cleaner phone number (step 1 of registration)\n  app.post(\"/api/auth/validate-cleaner-phone\", async (req: Request, res: Response) => {\n    try {\n      const { phoneNumber } = req.body;\n      \n      // Check if phone number has a pending invitation\n      const invitation = await storage.getInvitationByPhone(phoneNumber);\n      \n      if (!invitation) {\n        return res.status(400).json({ message: \"Phone number not invited\" });\n      }\n      \n      if (invitation.status !== \"pending\") {\n        return res.status(400).json({ message: \"Invitation already used or revoked\" });\n      }\n      \n      // Get company details\n      const company = await storage.getCompany(invitation.companyId);\n      if (!company) {\n        return res.status(400).json({ message: \"Company not found\" });\n      }\n      \n      res.json({ \n        valid: true, \n        companyId: invitation.companyId,\n        companyName: company.name\n      });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Register cleaner (step 2 - requires valid phone invitation)\n  app.post(\"/api/auth/register/cleaner\", async (req: Request, res: Response) => {\n    try {\n      const { \n        email,\n        password,\n        displayName, \n        phoneNumber,\n      } = req.body;\n      \n      // Validate phone number invitation again\n      const invitation = await storage.getInvitationByPhone(phoneNumber);\n      if (!invitation || invitation.status !== \"pending\") {\n        return res.status(400).json({ message: \"Invalid or expired invitation\" });\n      }\n      \n      // Check if user already exists\n      const existing = await storage.getUserByEmail(email);\n      if (existing) {\n        return res.status(400).json({ message: \"Email already registered\" });\n      }\n      \n      // Use transaction to ensure atomicity\n      const result = await storage.createCleanerWithUser({\n        email,\n        password,\n        displayName,\n        phoneNumber,\n        companyId: invitation.companyId,\n      });\n      \n      // Transfer geofence assignments from invitation to cleaner\n      await storage.transferInvitationGeofencesToCleaner(invitation.id, result.cleaner.id);\n      \n      // Consume the invitation\n      await storage.consumeInvitation(phoneNumber);\n      \n      // Log in the user\n      req.login(result.user, (err) => {\n        if (err) {\n          return res.status(500).json({ message: err.message });\n        }\n        const { passwordHash, ...userWithoutPassword } = result.user;\n        res.json({ user: userWithoutPassword, cleaner: result.cleaner });\n      });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n  \n  // ===== CUSTOMER ROUTES (ANONYMOUS) =====\n\n  // Customer email-based login/registration\n  app.post(\"/api/customer/login\", async (req: Request, res: Response) => {\n    try {\n      const { email, displayName, phoneNumber } = req.body;\n      console.log('[DEBUG] /api/customer/login received:', { email, displayName, phoneNumber, body: req.body });\n      \n      if (!email) {\n        console.log('[DEBUG] Email missing in request');\n        return res.status(400).json({ message: \"Email is required\" });\n      }\n      \n      const customer = await storage.createOrGetCustomer(email, displayName, phoneNumber);\n      console.log('[DEBUG] Customer created/found:', customer);\n      res.json(customer);\n    } catch (error: any) {\n      console.error('[DEBUG] Error in /api/customer/login:', error);\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Create or get customer by phone number (for QR payments)\n  app.post(\"/api/customer/by-phone\", async (req: Request, res: Response) => {\n    try {\n      const { phoneNumber } = req.body;\n      \n      if (!phoneNumber) {\n        return res.status(400).json({ message: \"Phone number is required\" });\n      }\n\n      // Try to get existing customer\n      let customer = await storage.getCustomerByPhone(phoneNumber);\n      \n      // If no customer exists, create one with phone only\n      if (!customer) {\n        // Generate a temporary email from phone\n        const tempEmail = `${phoneNumber.replace(/[^0-9]/g, '')}@temp.washapp.ae`;\n        customer = await storage.createOrGetCustomer(tempEmail, undefined, phoneNumber);\n      }\n\n      res.json(customer);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Get customer profile by phone\n  app.get(\"/api/customer/profile/:phoneNumber\", async (req: Request, res: Response) => {\n    try {\n      const customer = await storage.getCustomerByPhone(req.params.phoneNumber);\n      if (!customer) {\n        return res.status(404).json({ message: \"Customer not found\" });\n      }\n      res.json(customer);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Get car history by car plate (returns previous bookings for this specific plate)\n  app.get(\"/api/customer/car-history/:emirate/:code/:number\", async (req: Request, res: Response) => {\n    try {\n      const { emirate, code, number } = req.params;\n      \n      if (!emirate || !code || !number) {\n        return res.status(400).json({ message: \"Car plate details are required\" });\n      }\n\n      // Get history for this specific car plate\n      const history = await storage.getCarHistoryByPlate(emirate, code, number);\n      \n      res.json({ history });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n\n  // Get customer's previous cars (unique car plates from booking history)\n  app.get(\"/api/customer/history/:phoneNumber\", async (req: Request, res: Response) => {\n    try {\n      const { phoneNumber } = req.params;\n      \n      // Get customer first\n      const customer = await storage.getCustomerByPhone(phoneNumber);\n      if (!customer) {\n        return res.json({ cars: [] });\n      }\n\n      // Get all jobs for this customer\n      const jobsResult = await storage.getJobsByCustomer(customer.id, 1, 1000); // Get first 1000 jobs for history\n      const jobs = jobsResult.data;\n      \n      // Extract unique cars (car plate + email combinations)\n      const carsMap = new Map();\n      for (const job of jobs) {\n        const key = `${job.carPlateEmirate}-${job.carPlateCode}-${job.carPlateNumber}`;\n        if (!carsMap.has(key)) {\n          carsMap.set(key, {\n            carPlateEmirate: job.carPlateEmirate,\n            carPlateCode: job.carPlateCode,\n            carPlateNumber: job.carPlateNumber,\n            customerEmail: job.customerEmail,\n            parkingNumber: job.parkingNumber || \"\",\n            lastUsed: job.createdAt,\n          });\n        } else {\n          // Update if this job is more recent\n          const existing = carsMap.get(key);\n          if (new Date(job.createdAt) > new Date(existing.lastUsed)) {\n            carsMap.set(key, {\n              ...existing,\n              customerEmail: job.customerEmail,\n              parkingNumber: job.parkingNumber || \"\",\n              lastUsed: job.createdAt,\n            });\n          }\n        }\n      }\n\n      // Convert to array and sort by most recent\n      const cars = Array.from(carsMap.values()).sort(\n        (a, b) => new Date(b.lastUsed).getTime() - new Date(a.lastUsed).getTime()\n      );\n\n      res.json({ cars });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Get customer's most recent car by email (for auto-fill after email verification)\n  app.get(\"/api/customer/recent-car-by-email/:email\", async (req: Request, res: Response) => {\n    try {\n      const { email } = req.params;\n      \n      // Get customer by email\n      const customer = await storage.getCustomerByEmail(email);\n      if (!customer) {\n        return res.json({ car: null });\n      }\n\n      // Get most recent job for this customer\n      const jobsResult = await storage.getJobsByCustomer(customer.id, 1, 1);\n      const jobs = jobsResult.data;\n      \n      if (jobs.length === 0) {\n        return res.json({ car: null });\n      }\n\n      const mostRecentJob = jobs[0];\n      res.json({\n        car: {\n          carPlateEmirate: mostRecentJob.carPlateEmirate,\n          carPlateCode: mostRecentJob.carPlateCode,\n          carPlateNumber: mostRecentJob.carPlateNumber,\n          parkingNumber: mostRecentJob.parkingNumber || \"\",\n        }\n      });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Get payment token details for customer\n  app.get(\"/api/customer/payment-token/:token\", async (req: Request, res: Response) => {\n    try {\n      const { token } = req.params;\n      \n      const paymentToken = await storage.getCleanerPaymentToken(token);\n      \n      if (!paymentToken) {\n        return res.status(404).json({ message: \"Invalid payment token\" });\n      }\n\n      if (paymentToken.isUsed) {\n        return res.status(400).json({ message: \"This token has already been used\" });\n      }\n\n      if (!paymentToken.expiresAt || new Date(paymentToken.expiresAt) < new Date()) {\n        return res.status(400).json({ message: \"This token has expired\" });\n      }\n\n      const cleaner = await storage.getCleaner(paymentToken.cleanerId);\n      const company = await storage.getCompany(paymentToken.companyId);\n      \n      if (!cleaner || !company) {\n        return res.status(404).json({ message: \"Cleaner or company not found\" });\n      }\n\n      const cleanerUser = await storage.getUser(cleaner.userId);\n\n      res.json({\n        token: paymentToken.token,\n        companyId: company.id,\n        companyName: company.name,\n        cleanerId: cleaner.id,\n        cleanerName: cleanerUser?.displayName || \"Unknown\",\n        expiresAt: paymentToken.expiresAt,\n      });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n  \n  // Get all companies (for registration dropdown)\n  app.get(\"/api/companies/all\", async (req: Request, res: Response) => {\n    try {\n      const companies = await storage.getAllCompanies();\n      res.json(companies);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n  \n  // Get companies whose geofences contain the customer location\n  // IMPORTANT: This must come BEFORE /api/companies/:id to avoid route matching issues\n  app.get(\"/api/companies/nearby\", async (req: Request, res: Response) => {\n    try {\n      const lat = parseFloat(req.query.lat as string);\n      const lon = parseFloat(req.query.lon as string);\n      \n      if (isNaN(lat) || isNaN(lon)) {\n        return res.status(400).json({ message: \"Invalid latitude or longitude\" });\n      }\n\n      const companiesWithCleaners = await storage.getNearbyCompanies(lat, lon);\n      res.json(companiesWithCleaners);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Get company by ID\n  // IMPORTANT: This parameterized route must come AFTER specific routes like /nearby\n  app.get(\"/api/companies/:id\", async (req: Request, res: Response) => {\n    try {\n      const company = await storage.getCompany(parseInt(req.params.id));\n      if (!company) {\n        return res.status(404).json({ message: \"Company not found\" });\n      }\n      res.json(company);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Get cleaner by ID (public endpoint for customer tracking)\n  app.get(\"/api/cleaners/:id\", async (req: Request, res: Response) => {\n    try {\n      const cleanerId = parseInt(req.params.id);\n      if (isNaN(cleanerId)) {\n        return res.status(400).json({ message: \"Invalid cleaner ID\" });\n      }\n\n      const cleaner = await storage.getCleaner(cleanerId);\n      if (!cleaner) {\n        return res.status(404).json({ message: \"Cleaner not found\" });\n      }\n\n      // Get user info to include phone number and name\n      const user = await storage.getUser(cleaner.userId);\n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n\n      // Return cleaner info with phone number\n      res.json({\n        ...cleaner,\n        phoneNumber: user.phoneNumber,\n        displayName: user.displayName,\n        email: user.email,\n      });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Lookup cleaner by email with geofence validation (public endpoint for checkout validation)\n  app.get(\"/api/cleaners/lookup\", async (req: Request, res: Response) => {\n    try {\n      const email = req.query.email as string;\n      const lat = parseFloat(req.query.lat as string);\n      const lon = parseFloat(req.query.lon as string);\n      \n      if (!email || typeof email !== 'string') {\n        return res.status(400).json({ message: \"Email parameter is required\" });\n      }\n      \n      if (isNaN(lat) || isNaN(lon)) {\n        return res.status(400).json({ message: \"Valid latitude and longitude are required\" });\n      }\n      \n      // Find user by email\n      const user = await storage.getUserByEmail(email);\n      if (!user || user.role !== UserRole.CLEANER) {\n        return res.status(404).json({ message: \"Cleaner not found\" });\n      }\n      \n      // Get cleaner profile\n      const cleaner = await storage.getCleanerByUserId(user.id);\n      if (!cleaner) {\n        return res.status(404).json({ message: \"Cleaner profile not found\" });\n      }\n      \n      // Check if cleaner is active\n      if (cleaner.isActive !== 1) {\n        return res.status(403).json({ message: \"This cleaner is not active\" });\n      }\n      \n      // Get company info\n      const company = await storage.getCompany(cleaner.companyId);\n      if (!company) {\n        return res.status(404).json({ message: \"Company not found\" });\n      }\n      \n      if (company.isActive !== 1) {\n        return res.status(403).json({ message: \"This cleaner's company is not active\" });\n      }\n      \n      // Validate that customer location is within company's service area (geofence)\n      const isInServiceArea = await storage.isLocationInCompanyGeofence(cleaner.companyId, lat, lon);\n      if (!isInServiceArea) {\n        return res.status(403).json({ \n          message: \"This cleaner's company does not service your location. Please select your location on the map and choose from available companies.\" \n        });\n      }\n      \n      res.json({\n        cleanerId: cleaner.id,\n        email: user.email,\n        displayName: user.displayName,\n        companyId: company.id,\n        companyName: company.name,\n        isActive: true,\n      });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Create payment intent and job\n  app.post(\"/api/create-payment-intent\", async (req: Request, res: Response) => {\n    try {\n      const jobData = req.body;\n      const tipAmount = Number(jobData.tipAmount || 0);\n      const basePrice = Number(jobData.price);\n      \n      // Debug: Log the raw value\n      console.log('[DEBUG] requestedCleanerEmail RAW:', JSON.stringify(jobData.requestedCleanerEmail), 'type:', typeof jobData.requestedCleanerEmail);\n      \n      // Normalize requestedCleanerEmail to avoid treating empty/whitespace as valid\n      const requestedCleanerEmail = typeof jobData.requestedCleanerEmail === \"string\" \n        ? jobData.requestedCleanerEmail.trim() \n        : \"\";\n      \n      console.log('[DEBUG] requestedCleanerEmail NORMALIZED:', JSON.stringify(requestedCleanerEmail), 'length:', requestedCleanerEmail.length);\n      \n      // Get company to retrieve platform fee and fee package type\n      const company = await storage.getCompany(parseInt(jobData.companyId));\n      if (!company) {\n        return res.status(400).json({ message: \"Invalid company\" });\n      }\n      const platformFee = Number(company.platformFee || 3.00);\n      const feePackageType = company.feePackageType || 'custom';\n      \n      // Security: Validate requested cleaner belongs to selected company (only if email is provided)\n      if (requestedCleanerEmail) {\n        const user = await storage.getUserByEmail(requestedCleanerEmail);\n        if (!user || user.role !== UserRole.CLEANER) {\n          return res.status(400).json({ message: \"Invalid cleaner email\" });\n        }\n        \n        const cleaner = await storage.getCleanerByUserId(user.id);\n        if (!cleaner || cleaner.companyId !== parseInt(jobData.companyId)) {\n          return res.status(403).json({ message: \"Requested cleaner does not belong to selected company\" });\n        }\n        \n        if (cleaner.isActive !== 1) {\n          return res.status(403).json({ message: \"Requested cleaner is not active\" });\n        }\n      }\n      \n      // Calculate fees and total amount with company-specific platform fee and package type\n      const fees = await calculateJobFees(basePrice, tipAmount, platformFee, 'pay_per_wash', feePackageType);\n      \n      // Create payment intent with total amount (including tip)\n      const paymentIntent = await stripe.paymentIntents.create({\n        amount: Math.round(fees.totalAmount * 100), // Convert to fils (AED subunits)\n        currency: \"aed\",\n        metadata: {\n          carPlateNumber: jobData.carPlateNumber,\n          locationAddress: jobData.locationAddress,\n          companyId: jobData.companyId,\n          tipAmount: tipAmount.toString(),\n          requestedCleanerEmail: requestedCleanerEmail || '',\n        },\n      });\n\n      // Create job in database with pending payment status\n      const job = await storage.createJob({\n        customerId: jobData.customerId ? parseInt(jobData.customerId) : undefined,\n        companyId: parseInt(jobData.companyId),\n        carPlateNumber: jobData.carPlateNumber,\n        carPlateEmirate: jobData.carPlateEmirate || null,\n        carPlateCode: jobData.carPlateCode || null,\n        locationAddress: jobData.locationAddress,\n        locationLatitude: jobData.locationLatitude,\n        locationLongitude: jobData.locationLongitude,\n        parkingNumber: jobData.parkingNumber,\n        customerPhone: jobData.customerPhone,\n        customerEmail: jobData.customerEmail || null,\n        price: basePrice.toString(),\n        tipAmount: tipAmount.toString(),\n        totalAmount: fees.totalAmount.toString(),\n        stripePaymentIntentId: paymentIntent.id,\n        status: JobStatus.PENDING_PAYMENT,\n        requestedCleanerEmail: requestedCleanerEmail || null,\n        assignmentMode: requestedCleanerEmail ? 'direct' : 'pool',\n      });\n\n      res.json({ \n        clientSecret: paymentIntent.client_secret, \n        jobId: job.id,\n        fees // Include full fee breakdown for accurate frontend display\n      });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Update payment intent with new tip amount\n  app.patch(\"/api/payment-intents/:paymentIntentId\", async (req: Request, res: Response) => {\n    try {\n      const { paymentIntentId } = req.params;\n      const { tipAmount } = req.body;\n      \n      // Find the existing job to get the stored base price (prevent tampering)\n      const job = await storage.getJobByPaymentIntent(paymentIntentId);\n      if (!job) {\n        return res.status(404).json({ message: \"Job not found\" });\n      }\n      \n      // Validate job is still in pending payment state\n      if (job.status !== JobStatus.PENDING_PAYMENT) {\n        return res.status(400).json({ message: \"Payment already processed\" });\n      }\n      \n      // Validate tip amount\n      const tip = Number(tipAmount || 0);\n      if (tip < 0) {\n        return res.status(400).json({ message: \"Tip amount cannot be negative\" });\n      }\n      if (tip > 1000) {\n        return res.status(400).json({ message: \"Tip amount too large\" });\n      }\n      \n      // Use the stored base price from the job (not from client)\n      const basePrice = Number(job.price);\n      \n      // Get company to retrieve platform fee and fee package type\n      const company = await storage.getCompany(job.companyId);\n      if (!company) {\n        return res.status(400).json({ message: \"Company not found\" });\n      }\n      const platformFee = Number(company.platformFee || 3.00);\n      const feePackageType = company.feePackageType || 'custom';\n      \n      // Recalculate fees with new tip amount\n      const fees = await calculateJobFees(basePrice, tip, platformFee, 'pay_per_wash', feePackageType);\n      \n      // Update the Stripe PaymentIntent with new amount\n      const paymentIntent = await stripe.paymentIntents.update(paymentIntentId, {\n        amount: Math.round(fees.totalAmount * 100), // Convert to fils\n        metadata: {\n          tipAmount: tip.toString(),\n        },\n      });\n      \n      // Update the job with new tip and total\n      await storage.updateJob(job.id, {\n        tipAmount: tip.toString(),\n        totalAmount: fees.totalAmount.toString(),\n      });\n      \n      // Return updated fees for frontend display\n      res.json({\n        ...fees,\n        clientSecret: paymentIntent.client_secret,\n      });\n    } catch (error: any) {\n      console.error('Payment intent update error:', error);\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Stripe webhook endpoint with signature verification\n  app.post(\"/api/stripe-webhook\", express.raw({ type: 'application/json' }), async (req: Request, res: Response) => {\n    const sig = req.headers['stripe-signature'];\n    const webhookSecret = process.env.STRIPE_WEBHOOK_SECRET;\n\n    if (!sig) {\n      return res.status(400).send('Missing stripe-signature header');\n    }\n\n    let event: Stripe.Event;\n\n    try {\n      // Verify webhook signature\n      if (webhookSecret) {\n        event = stripe.webhooks.constructEvent(req.rawBody as Buffer, sig, webhookSecret);\n      } else {\n        console.warn('No STRIPE_WEBHOOK_SECRET - skipping signature verification');\n        event = req.body;\n      }\n\n      if (event.type === \"payment_intent.succeeded\") {\n        const paymentIntent = event.data.object as Stripe.PaymentIntent;\n        \n        // Find job by payment intent ID\n        const job = await storage.getJobByPaymentIntent(paymentIntent.id);\n\n        if (job) {\n          let assignedCleanerId: number | null = null;\n          let finalStatus = JobStatus.PAID;\n          let finalAssignmentMode = job.assignmentMode;\n          \n          // Handle direct assignment if requested\n          if (job.assignmentMode === 'direct' && job.requestedCleanerEmail) {\n            try {\n              // Find the requested cleaner\n              const user = await storage.getUserByEmail(job.requestedCleanerEmail);\n              if (user && user.role === UserRole.CLEANER) {\n                const cleaner = await storage.getCleanerByUserId(user.id);\n                \n                // Validate cleaner belongs to the job's company and is available\n                if (cleaner && \n                    cleaner.isActive === 1 && \n                    cleaner.companyId === job.companyId &&\n                    cleaner.status === CleanerStatus.ON_DUTY) {\n                  \n                  // Directly assign to the cleaner immediately\n                  assignedCleanerId = cleaner.id;\n                  finalStatus = JobStatus.ASSIGNED;\n                  await storage.updateJob(job.id, {\n                    status: JobStatus.ASSIGNED,\n                    cleanerId: cleaner.id,\n                    assignedAt: new Date(),\n                    directAssignmentAt: new Date(),\n                  });\n                  \n                  // Update cleaner status to busy\n                  await storage.updateCleaner(cleaner.id, {\n                    status: CleanerStatus.BUSY,\n                  });\n                } else {\n                  // Fall back to pool if cleaner not available\n                  const reason = !cleaner ? 'not found' :\n                                cleaner.isActive !== 1 ? 'not active' :\n                                cleaner.companyId !== job.companyId ? 'wrong company' :\n                                cleaner.status === CleanerStatus.BUSY ? 'already busy' :\n                                'off duty';\n                  console.log(`Requested cleaner ${reason}, falling back to pool`);\n                  finalAssignmentMode = 'pool';\n                  await storage.updateJob(job.id, {\n                    status: JobStatus.PAID,\n                    assignmentMode: 'pool',\n                    requestedCleanerEmail: null,\n                  });\n                }\n              } else {\n                // Fall back to pool if cleaner not found\n                console.log('Requested cleaner not found, falling back to pool');\n                finalAssignmentMode = 'pool';\n                await storage.updateJob(job.id, {\n                  status: JobStatus.PAID,\n                  assignmentMode: 'pool',\n                  requestedCleanerEmail: null,\n                });\n              }\n            } catch (directAssignError) {\n              console.error('Direct assignment error, falling back to pool:', directAssignError);\n              finalAssignmentMode = 'pool';\n              await storage.updateJob(job.id, {\n                status: JobStatus.PAID,\n                assignmentMode: 'pool',\n                requestedCleanerEmail: null,\n              });\n            }\n          } else {\n            // Pool mode - just mark as PAID\n            await storage.updateJob(job.id, {\n              status: JobStatus.PAID,\n            });\n          }\n          \n          // Generate and store receipt number (atomic operation to prevent duplicates)\n          const generatedReceipt = generateReceiptNumber();\n          const receiptNumber = await storage.atomicSetReceipt(job.id, generatedReceipt, new Date());\n          \n          // Get company to retrieve platform fee\n          const company = await storage.getCompany(job.companyId);\n          const platformFee = company ? Number(company.platformFee || 3.00) : 3.00;\n          \n          // Create financial record for this job\n          await createJobFinancialRecord(\n            job.id,\n            job.companyId,\n            assignedCleanerId, // Pass cleaner ID if directly assigned\n            Number(job.price),\n            Number(job.tipAmount || 0),\n            new Date(),\n            platformFee\n          );\n          \n          // Create transaction record for customer payment\n          await storage.createTransaction({\n            referenceNumber: paymentIntent.id,\n            type: 'customer_payment',\n            direction: 'credit',\n            jobId: job.id,\n            companyId: job.companyId,\n            amount: (Number(job.price) + Number(job.tipAmount || 0)).toString(),\n            currency: 'AED',\n            description: `Customer payment for job ${job.id} - ${job.carPlateNumber}`,\n          });\n          \n          // Broadcast update to relevant parties\n          const updatedJob = await storage.getJob(job.id);\n          if (updatedJob) {\n            \n            // Send push notification based on final status\n            if (finalStatus === JobStatus.ASSIGNED && assignedCleanerId) {\n              // Notify customer that cleaner is assigned\n              const cleaner = await storage.getCleaner(assignedCleanerId);\n              const cleanerUser = cleaner ? await storage.getUser(cleaner.userId) : null;\n              \n              PushNotificationService.notifyJobStatusChange(updatedJob.id, JobStatus.ASSIGNED, {\n                carPlateNumber: updatedJob.carPlateNumber,\n                cleanerName: cleanerUser?.displayName,\n                customerId: updatedJob.customerId || undefined,\n              }).catch(err => console.error('Push notification failed:', err));\n              \n              // Send email notification if customer provided email\n              if (company) {\n                await sendJobStatusEmail(updatedJob, company, 'assigned', cleanerUser?.displayName);\n              }\n              \n              // Only broadcast to the assigned cleaner\n              broadcastJobUpdate(updatedJob);\n            } else {\n              // Notify customer that payment is confirmed (pool mode)\n              PushNotificationService.notifyJobStatusChange(updatedJob.id, JobStatus.PAID, {\n                carPlateNumber: updatedJob.carPlateNumber,\n                customerId: updatedJob.customerId || undefined,\n              }).catch(err => console.error('Push notification failed:', err));\n              \n              // Send email notification if customer provided email\n              if (company) {\n                await sendJobStatusEmail(updatedJob, company, 'paid');\n              }\n              \n              // Broadcast to all on-duty cleaners (pool mode)\n              broadcastJobUpdate(updatedJob);\n              \n              // Send push notifications to all eligible on-duty cleaners\n              PushNotificationService.notifyOnDutyCleaners(updatedJob.id, updatedJob.companyId, {\n                carPlateNumber: updatedJob.carPlateNumber,\n                locationAddress: updatedJob.locationAddress || 'Location provided',\n                price: Number(updatedJob.price),\n                locationLat: Number(updatedJob.locationLatitude),\n                locationLng: Number(updatedJob.locationLongitude),\n              }).catch(err => console.error('Push notification to cleaners failed:', err));\n            }\n          }\n        }\n      }\n\n      res.json({ received: true });\n    } catch (error: any) {\n      console.error('Webhook error:', error);\n      res.status(400).send(`Webhook Error: ${error.message}`);\n    }\n  });\n\n  // Manual payment confirmation endpoint (for development when webhooks don't fire)\n  app.post(\"/api/confirm-payment/:paymentIntentId\", async (req: Request, res: Response) => {\n    try {\n      const { paymentIntentId } = req.params;\n      const { paymentToken } = req.body;\n      \n      // Verify payment with Stripe\n      const paymentIntent = await stripe.paymentIntents.retrieve(paymentIntentId);\n      \n      if (paymentIntent.status !== 'succeeded') {\n        return res.status(400).json({ message: \"Payment not successful\" });\n      }\n      \n      // Find job by payment intent ID\n      const job = await storage.getJobByPaymentIntent(paymentIntentId);\n\n      if (!job) {\n        return res.status(404).json({ message: \"Job not found\" });\n      }\n      \n      // Handle QR code payment token if provided\n      let cleanerIdToAssign: number | null = null;\n      if (paymentToken) {\n        const token = await storage.getCleanerPaymentToken(paymentToken);\n        \n        if (token && !token.isUsed && token.expiresAt && new Date(token.expiresAt) > new Date()) {\n          cleanerIdToAssign = token.cleanerId;\n          \n          // Mark token as used\n          await storage.markTokenAsUsed(token.id);\n        }\n      }\n      \n      // Only update status if not already PAID\n      if (job.status === JobStatus.PENDING_PAYMENT) {\n        const updateData: any = {\n          status: cleanerIdToAssign ? JobStatus.ASSIGNED : JobStatus.PAID,\n        };\n        \n        // Auto-assign to cleaner if token was provided\n        if (cleanerIdToAssign) {\n          updateData.cleanerId = cleanerIdToAssign;\n        }\n        \n        await storage.updateJob(job.id, updateData);\n      }\n      \n      // Always ensure receipt exists (atomic operation to prevent duplicates)\n      const generatedReceipt = generateReceiptNumber();\n      const receiptNumber = await storage.atomicSetReceipt(job.id, generatedReceipt, new Date());\n      \n      // If job was already confirmed and has receipt, we can skip financial record creation\n      if (job.status !== JobStatus.PENDING_PAYMENT && job.receiptNumber) {\n        return res.json({ message: \"Job already confirmed\", job });\n      }\n      \n      // Get company to retrieve platform fee\n      const company = await storage.getCompany(job.companyId);\n      if (!company) {\n        return res.status(400).json({ message: \"Company not found\" });\n      }\n      const platformFee = Number(company.platformFee || 3.00);\n      \n      // Create financial record for this job\n      await createJobFinancialRecord(\n        job.id,\n        job.companyId,\n        job.cleanerId, // Pass actual cleaner if assigned\n        Number(job.price),\n        Number(job.tipAmount || 0),\n        new Date(),\n        platformFee\n      );\n      \n      // Broadcast update to all on-duty cleaners\n      const updatedJob = await storage.getJob(job.id);\n      if (updatedJob) {\n        broadcastJobUpdate(updatedJob);\n        \n        // Send email notification if customer provided email\n        if (company && updatedJob.customerEmail) {\n          await sendJobStatusEmail(updatedJob, company, 'paid');\n        }\n        \n        // Send push notification\n        PushNotificationService.notifyJobStatusChange(updatedJob.id, JobStatus.PAID, {\n          carPlateNumber: updatedJob.carPlateNumber,\n          customerId: updatedJob.customerId || undefined,\n        }).catch(err => console.error('Push notification failed:', err));\n      }\n      \n      return res.json({ message: \"Payment confirmed - job available for cleaners\", job: updatedJob });\n    } catch (error: any) {\n      console.error('Payment confirmation error:', error);\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Get customer's jobs\n  app.get(\"/api/customer/jobs/:customerId?\", async (req: Request, res: Response) => {\n    try {\n      const customerIdParam = req.params.customerId || req.query.customerId;\n      if (!customerIdParam) {\n        return res.status(400).json({ message: \"Customer ID is required\" });\n      }\n      const customerId = parseInt(customerIdParam as string);\n      const page = req.query.page ? parseInt(req.query.page as string) : 1;\n      const pageSize = req.query.pageSize ? parseInt(req.query.pageSize as string) : 20;\n      \n      const result = await storage.getJobsByCustomer(customerId, page, pageSize);\n      res.json(result);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Get jobs by car plate number (for tracking)\n  app.get(\"/api/jobs/track/:plateNumber\", async (req: Request, res: Response) => {\n    try {\n      const { plateNumber } = req.params;\n      if (!plateNumber) {\n        return res.status(400).json({ message: \"Plate number is required\" });\n      }\n      \n      const page = req.query.page ? parseInt(req.query.page as string) : 1;\n      const pageSize = req.query.pageSize ? parseInt(req.query.pageSize as string) : 20;\n      \n      // Disable caching completely for real-time updates\n      res.set({\n        'Cache-Control': 'no-store, no-cache, must-revalidate, proxy-revalidate',\n        'Pragma': 'no-cache',\n        'Expires': '0',\n        'Surrogate-Control': 'no-store'\n      });\n      \n      const result = await storage.getJobsByPlateNumber(plateNumber, page, pageSize);\n      res.json(result);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Get jobs by phone number (for tracking)\n  app.get(\"/api/jobs/track-by-phone/:phoneNumber\", async (req: Request, res: Response) => {\n    try {\n      const { phoneNumber } = req.params;\n      if (!phoneNumber) {\n        return res.status(400).json({ message: \"Phone number is required\" });\n      }\n      \n      const page = req.query.page ? parseInt(req.query.page as string) : 1;\n      const pageSize = req.query.pageSize ? parseInt(req.query.pageSize as string) : 20;\n      \n      // Disable caching completely for real-time updates\n      res.set({\n        'Cache-Control': 'no-store, no-cache, must-revalidate, proxy-revalidate',\n        'Pragma': 'no-cache',\n        'Expires': '0',\n        'Surrogate-Control': 'no-store'\n      });\n      \n      const result = await storage.getJobsByPhoneNumber(phoneNumber, page, pageSize);\n      res.json(result);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Get single job by ID (for complaint submission)\n  app.get(\"/api/jobs/:id\", async (req: Request, res: Response) => {\n    try {\n      const jobId = parseInt(req.params.id);\n      if (isNaN(jobId)) {\n        return res.status(400).json({ message: \"Invalid job ID\" });\n      }\n      \n      const job = await storage.getJob(jobId);\n      if (!job) {\n        return res.status(404).json({ message: \"Job not found\" });\n      }\n      \n      res.json(job);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Rate a completed job\n  app.post(\"/api/jobs/:jobId/rate\", async (req: Request, res: Response) => {\n    try {\n      const jobId = parseInt(req.params.jobId);\n      const { rating, review } = req.body;\n      \n      if (!rating || rating < 1 || rating > 5) {\n        return res.status(400).json({ message: \"Rating must be between 1 and 5\" });\n      }\n      \n      const job = await storage.getJob(jobId);\n      if (!job) {\n        return res.status(404).json({ message: \"Job not found\" });\n      }\n      \n      if (job.status !== JobStatus.COMPLETED) {\n        return res.status(400).json({ message: \"Job must be completed before rating\" });\n      }\n      \n      if (job.rating) {\n        return res.status(400).json({ message: \"Job has already been rated\" });\n      }\n\n      if (!job.cleanerId) {\n        return res.status(400).json({ message: \"Job has no assigned cleaner\" });\n      }\n      \n      // Update job with rating\n      await storage.updateJob(jobId, {\n        rating: parseFloat(rating).toString(),\n        review: review || null,\n        ratedAt: new Date(),\n      });\n\n      // Update cleaner's aggregate rating\n      const cleaner = await storage.getCleaner(job.cleanerId);\n      if (cleaner) {\n        // Get all rated jobs for this cleaner\n        const cleanerJobs = await storage.getJobsByCleaner(job.cleanerId);\n        const ratedJobs = cleanerJobs.filter(j => j.rating);\n        \n        // Calculate new average rating\n        const totalRatings = ratedJobs.length;\n        const averageRating = ratedJobs.reduce((sum, j) => sum + parseFloat(j.rating!), 0) / totalRatings;\n        \n        // Update cleaner's rating\n        await storage.updateCleaner(job.cleanerId, {\n          rating: averageRating.toFixed(2),\n          totalRatings,\n        });\n      }\n      \n      res.json({ message: \"Rating submitted successfully\" });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Download receipt as PDF for completed jobs\n  app.get(\"/api/jobs/:jobId/receipt\", async (req: Request, res: Response) => {\n    try {\n      const jobId = parseInt(req.params.jobId);\n      const job = await storage.getJob(jobId);\n      \n      if (!job) {\n        return res.status(404).json({ message: \"Job not found\" });\n      }\n      \n      if (job.status !== JobStatus.COMPLETED) {\n        return res.status(400).json({ message: \"Job must be completed\" });\n      }\n      \n      // Only online jobs have receipts\n      if (!job.stripePaymentIntentId) {\n        return res.status(400).json({ message: \"No receipt available for this job\" });\n      }\n\n      // Always regenerate receipt on download to ensure correct data\n      try {\n        const platformSettings = await storage.getAllPlatformSettings();\n        const settings = platformSettings[0] || {\n          id: 1,\n          companyName: 'Washapp.ae',\n          companyAddress: 'Dubai, United Arab Emirates',\n          vatRegistrationNumber: '',\n          createdAt: new Date(),\n          updatedAt: new Date(),\n        };\n\n        // Use customer email from job record\n        const customerEmail = job.customerEmail || undefined;\n\n        // Construct plate number correctly - only include emirate and code if both exist\n        const fullPlateNumber = (job.carPlateEmirate && job.carPlateCode)\n          ? `${job.carPlateEmirate} ${job.carPlateCode} ${job.carPlateNumber}`\n          : (job.carPlateNumber || '');\n\n        // Get actual financial data from job_financials table\n        const jobFinancials = await storage.getJobFinancialsByJobId(job.id);\n        \n        let baseJobAmount: number;\n        let platformFeeAmount: number;\n        let tipAmount: number;\n        let vatAmount: number;\n        \n        if (jobFinancials) {\n          baseJobAmount = Number(jobFinancials.baseJobAmount);\n          platformFeeAmount = Number(jobFinancials.platformFeeAmount);\n          tipAmount = Number(jobFinancials.tipAmount);\n          vatAmount = Number(jobFinancials.taxAmount);\n        } else {\n          baseJobAmount = Number(job.price);\n          tipAmount = Number(job.tipAmount || 0);\n          vatAmount = Number(job.taxAmount || 0);\n          const totalAmount = Number(job.totalAmount);\n          platformFeeAmount = Number((totalAmount - baseJobAmount - vatAmount - tipAmount).toFixed(2));\n          if (platformFeeAmount < 0) platformFeeAmount = 0;\n        }\n        \n        const totalAmount = Number(job.totalAmount);\n\n        const receiptPath = await generateReceipt({\n          receiptData: {\n            receiptNumber: job.receiptNumber || `RCP-${jobId}`,\n            jobId: job.id,\n            carPlateNumber: fullPlateNumber,\n            customerPhone: job.customerPhone || 'N/A',\n            customerEmail: customerEmail,\n            locationAddress: job.locationAddress,\n            servicePrice: baseJobAmount,\n            platformFee: platformFeeAmount,\n            tipAmount,\n            vatAmount,\n            totalAmount,\n            paymentMethod: job.paymentMethod || 'card',\n            completedAt: job.completedAt || job.createdAt,\n          },\n          platformSettings: settings,\n        });\n\n        res.setHeader(\"Content-Type\", \"application/pdf\");\n        res.setHeader(\"Content-Disposition\", `attachment; filename=\"receipt-${jobId}.pdf\"`);\n        const fileStream = createReadStream(receiptPath);\n        fileStream.pipe(res);\n      } catch (generateError) {\n        console.error('Failed to generate receipt:', generateError);\n        res.status(500).json({ message: \"Failed to generate receipt\" });\n      }\n    } catch (error: any) {\n      console.error('Receipt download error:', error);\n      if (!res.headersSent) {\n        res.status(500).json({ message: \"Failed to download receipt\" });\n      }\n    }\n  });\n\n  // ===== CLEANER ROUTES =====\n\n  // Consolidated dashboard endpoint - combines profile, shift, and jobs in one call\n  app.get(\"/api/cleaner/dashboard\", requireRole(UserRole.CLEANER), requireActiveCleaner(storage), async (req: Request, res: Response) => {\n    try {\n      res.set('Cache-Control', 'no-store, must-revalidate');\n      res.set('Pragma', 'no-cache');\n\n      const cleaner = await storage.getCleanerByUserId(req.user!.id);\n      if (!cleaner) {\n        return res.status(404).json({ message: \"Cleaner profile not found\" });\n      }\n\n      // Fetch all data in parallel\n      const [activeShift, myJobs, availableJobsData] = await Promise.all([\n        storage.getActiveShift(cleaner.id),\n        storage.getJobsByCleaner(cleaner.id),\n        (async () => {\n          const allJobs = await storage.getJobsByCompany(cleaner.companyId, JobStatus.PAID);\n          const assignedToAll = await storage.isCleanerAssignedToAllGeofences(cleaner.id);\n          \n          if (assignedToAll) {\n            return allJobs;\n          }\n          \n          const assignedGeofences = await storage.getCleanerGeofenceAssignments(cleaner.id);\n          if (assignedGeofences.length === 0) {\n            return [];\n          }\n          \n          return allJobs.filter(job => {\n            const lat = Number(job.locationLatitude);\n            const lon = Number(job.locationLongitude);\n            return assignedGeofences.some(geofence => {\n              const polygon = geofence.polygon as Array<[number, number]>;\n              if (!polygon || !Array.isArray(polygon) || polygon.length < 3) {\n                return false;\n              }\n              return isPointInPolygon(lat, lon, polygon);\n            });\n          });\n        })(),\n      ]);\n\n      res.json({\n        cleaner,\n        activeShift,\n        myJobs,\n        availableJobs: availableJobsData,\n      });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Get cleaner profile\n  app.get(\"/api/cleaner/profile\", requireRole(UserRole.CLEANER), requireActiveCleaner(storage), async (req: Request, res: Response) => {\n    try {\n      const cleaner = await storage.getCleanerByUserId(req.user!.id);\n      if (!cleaner) {\n        return res.status(404).json({ message: \"Cleaner profile not found\" });\n      }\n      res.json(cleaner);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Get cleaner tips with date filtering\n  app.get(\"/api/cleaner/tips\", requireRole(UserRole.CLEANER), requireActiveCleaner(storage), async (req: Request, res: Response) => {\n    try {\n      const cleaner = await storage.getCleanerByUserId(req.user!.id);\n      if (!cleaner) {\n        return res.status(404).json({ message: \"Cleaner profile not found\" });\n      }\n\n      const { startDate, endDate, page, pageSize } = req.query;\n      \n      const filters: { startDate?: Date; endDate?: Date; page?: number; pageSize?: number } = {};\n      if (startDate && typeof startDate === 'string') {\n        filters.startDate = new Date(startDate);\n      }\n      if (endDate && typeof endDate === 'string') {\n        // Set to end of day\n        const end = new Date(endDate);\n        end.setHours(23, 59, 59, 999);\n        filters.endDate = end;\n      }\n      if (page) filters.page = parseInt(page as string);\n      if (pageSize) filters.pageSize = parseInt(pageSize as string);\n\n      const result = await storage.getCleanerTips(cleaner.id, filters);\n      \n      // Calculate totals\n      const totalTips = result.data.reduce((sum, t) => sum + Number(t.tipAmount), 0);\n      const totalStripeFees = result.data.reduce((sum, t) => sum + Number(t.cleanerStripeFeeShare), 0);\n      const totalReceived = result.data.reduce((sum, t) => sum + Number(t.remainingTip), 0);\n\n      res.json({\n        tips: result.data,\n        total: result.total,\n        summary: {\n          totalTips,\n          totalStripeFees,\n          totalReceived,\n          count: result.data.length,\n        },\n      });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Start shift\n  app.post(\"/api/cleaner/start-shift\", requireRole(UserRole.CLEANER), requireActiveCleaner(storage), async (req: Request, res: Response) => {\n    try {\n      const cleaner = await storage.getCleanerByUserId(req.user!.id);\n      if (!cleaner) {\n        return res.status(404).json({ message: \"Cleaner profile not found\" });\n      }\n      \n      const { latitude, longitude } = req.body;\n      const shift = await storage.startShift(cleaner.id, latitude, longitude);\n      \n      // Automatically set cleaner status to ON_DUTY when starting shift\n      await storage.updateCleaner(cleaner.id, { status: CleanerStatus.ON_DUTY });\n      \n      res.json(shift);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // End shift\n  app.post(\"/api/cleaner/end-shift\", requireRole(UserRole.CLEANER), requireActiveCleaner(storage), async (req: Request, res: Response) => {\n    try {\n      const cleaner = await storage.getCleanerByUserId(req.user!.id);\n      if (!cleaner) {\n        return res.status(404).json({ message: \"Cleaner profile not found\" });\n      }\n      \n      const { latitude, longitude } = req.body;\n      await storage.endShift(cleaner.id, latitude, longitude);\n      \n      // Automatically set cleaner status to OFF_DUTY when ending shift\n      await storage.updateCleaner(cleaner.id, { status: CleanerStatus.OFF_DUTY });\n      \n      res.json({ message: \"Shift ended successfully\" });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Get active shift\n  app.get(\"/api/cleaner/shift-status\", requireRole(UserRole.CLEANER), requireActiveCleaner(storage), async (req: Request, res: Response) => {\n    try {\n      res.set('Cache-Control', 'no-store, must-revalidate');\n      res.set('Pragma', 'no-cache');\n      \n      const cleaner = await storage.getCleanerByUserId(req.user!.id);\n      if (!cleaner) {\n        return res.status(404).json({ message: \"Cleaner profile not found\" });\n      }\n      \n      const activeShift = await storage.getActiveShift(cleaner.id);\n      res.json({ activeShift, cleaner });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Get shift history\n  app.get(\"/api/cleaner/shift-history\", requireRole(UserRole.CLEANER), requireActiveCleaner(storage), async (req: Request, res: Response) => {\n    try {\n      res.set('Cache-Control', 'no-store, must-revalidate');\n      res.set('Pragma', 'no-cache');\n      \n      const cleaner = await storage.getCleanerByUserId(req.user!.id);\n      if (!cleaner) {\n        return res.status(404).json({ message: \"Cleaner profile not found\" });\n      }\n      \n      const filters: any = {};\n      \n      if (req.query.startDate) {\n        filters.startDate = new Date(req.query.startDate as string);\n      }\n      \n      if (req.query.endDate) {\n        filters.endDate = new Date(req.query.endDate as string);\n      }\n      \n      if (req.query.limit) {\n        filters.limit = parseInt(req.query.limit as string);\n      } else {\n        filters.limit = 100;\n      }\n      \n      const history = await storage.getCleanerShiftHistory(cleaner.id, filters);\n      res.json(history);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Accept job (single cleaner can accept with locking)\n  app.post(\"/api/cleaner/accept-job/:jobId\", requireRole(UserRole.CLEANER), async (req: Request, res: Response) => {\n    try {\n      const cleaner = await storage.getCleanerByUserId(req.user!.id);\n      if (!cleaner) {\n        return res.status(404).json({ message: \"Cleaner profile not found\" });\n      }\n      \n      const jobId = parseInt(req.params.jobId);\n      const accepted = await storage.acceptJob(jobId, cleaner.id);\n      \n      if (!accepted) {\n        return res.status(409).json({ message: \"Job already assigned or not available\" });\n      }\n      \n      const job = await storage.getJob(jobId);\n      \n      // Send push notification\n      if (job) {\n        PushNotificationService.notifyJobStatusChange(jobId, JobStatus.ASSIGNED, {\n          carPlateNumber: job.carPlateNumber,\n          cleanerName: req.user?.displayName,\n          customerId: job.customerId || undefined,\n        }).catch(err => console.error('Push notification failed:', err));\n        \n        // Send email notification if customer provided email\n        const company = await storage.getCompany(job.companyId);\n        if (company && job.customerEmail) {\n          await sendJobStatusEmail(job, company, 'assigned', req.user?.displayName);\n        }\n        \n        // Broadcast update via WebSocket\n        broadcastJobUpdate(job);\n      }\n      \n      res.json({ message: \"Job accepted successfully\", job });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Toggle cleaner availability\n  app.post(\"/api/cleaner/toggle-status\", requireRole(UserRole.CLEANER), requireActiveCleaner(storage), async (req: Request, res: Response) => {\n    try {\n      const { status } = req.body;\n      const cleaner = await storage.getCleanerByUserId(req.user!.id);\n\n      if (cleaner) {\n        await storage.updateCleaner(cleaner.id, { status });\n        res.json({ success: true });\n      } else {\n        res.status(404).json({ message: \"Cleaner not found\" });\n      }\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Update cleaner location\n  app.post(\"/api/cleaner/update-location\", requireRole(UserRole.CLEANER), requireActiveCleaner(storage), async (req: Request, res: Response) => {\n    try {\n      const { latitude, longitude } = req.body;\n      const cleaner = await storage.getCleanerByUserId(req.user!.id);\n\n      if (cleaner) {\n        await storage.updateCleaner(cleaner.id, { \n          currentLatitude: latitude.toString(),\n          currentLongitude: longitude.toString(),\n          lastLocationUpdate: new Date(),\n        });\n        res.json({ success: true });\n      } else {\n        res.status(404).json({ message: \"Cleaner not found\" });\n      }\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Generate payment QR token for cleaner\n  app.post(\"/api/cleaner/generate-qr-token\", requireRole(UserRole.CLEANER), requireActiveCleaner(storage), async (req: Request, res: Response) => {\n    try {\n      const cleaner = await storage.getCleanerByUserId(req.user!.id);\n\n      if (!cleaner) {\n        return res.status(404).json({ message: \"Cleaner not found\" });\n      }\n\n      const token = crypto.randomBytes(16).toString('hex');\n      const expiresAt = new Date(Date.now() + 24 * 60 * 60 * 1000);\n\n      await storage.createCleanerPaymentToken(cleaner.id, cleaner.companyId, token, expiresAt);\n\n      res.json({ token, expiresAt });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Get available jobs for cleaner\n  app.get(\"/api/cleaner/available-jobs\", requireRole(UserRole.CLEANER), requireActiveCleaner(storage), async (req: Request, res: Response) => {\n    try {\n      res.set('Cache-Control', 'no-store, must-revalidate');\n      res.set('Pragma', 'no-cache');\n      \n      const cleaner = await storage.getCleanerByUserId(req.user!.id);\n\n      if (!cleaner) {\n        return res.json([]);\n      }\n\n      // Get paid jobs for this company without a cleaner assigned\n      const allJobs = await storage.getJobsByCompany(cleaner.companyId, JobStatus.PAID);\n      \n      // Check if cleaner is assigned to all geofences\n      const assignedToAll = await storage.isCleanerAssignedToAllGeofences(cleaner.id);\n      \n      if (assignedToAll) {\n        return res.json(allJobs);\n      }\n      \n      // Get cleaner's assigned geofences\n      const assignedGeofences = await storage.getCleanerGeofenceAssignments(cleaner.id);\n      \n      // If no geofences assigned, show no jobs\n      if (assignedGeofences.length === 0) {\n        return res.json([]);\n      }\n      \n      // Filter jobs by geofence assignment\n      const filteredJobs = allJobs.filter(job => {\n        const lat = Number(job.locationLatitude);\n        const lon = Number(job.locationLongitude);\n        \n        // Check if job location is within any assigned geofence\n        return assignedGeofences.some(geofence => {\n          const polygon = geofence.polygon as Array<[number, number]>;\n          if (!polygon || !Array.isArray(polygon) || polygon.length < 3) {\n            return false;\n          }\n          return isPointInPolygon(lat, lon, polygon);\n        });\n      });\n      \n      res.json(filteredJobs);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Get cleaner's active jobs\n  app.get(\"/api/cleaner/my-jobs\", requireRole(UserRole.CLEANER), requireActiveCleaner(storage), async (req: Request, res: Response) => {\n    try {\n      res.set('Cache-Control', 'no-store, must-revalidate');\n      res.set('Pragma', 'no-cache');\n      \n      const cleaner = await storage.getCleanerByUserId(req.user!.id);\n\n      if (!cleaner) {\n        return res.json([]);\n      }\n\n      const jobs = await storage.getJobsByCleaner(cleaner.id);\n      res.json(jobs);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Accept job (uses transactional locking)\n  app.post(\"/api/cleaner/accept-job/:jobId\", requireRole(UserRole.CLEANER), requireActiveCleaner(storage), async (req: Request, res: Response) => {\n    try {\n      const cleaner = await storage.getCleanerByUserId(req.user!.id);\n      if (!cleaner) {\n        return res.status(404).json({ message: \"Cleaner profile not found\" });\n      }\n      \n      const jobId = parseInt(req.params.jobId);\n      const accepted = await storage.acceptJob(jobId, cleaner.id);\n      \n      if (!accepted) {\n        return res.status(409).json({ message: \"Job already assigned or not available\" });\n      }\n      \n      const job = await storage.getJob(jobId);\n      \n      // Send push notification\n      if (job) {\n        PushNotificationService.notifyJobStatusChange(jobId, JobStatus.ASSIGNED, {\n          carPlateNumber: job.carPlateNumber,\n          cleanerName: req.user?.displayName,\n          customerId: job.customerId || undefined,\n        }).catch(err => console.error('Push notification failed:', err));\n        \n        // Send email notification if customer provided email\n        const company = await storage.getCompany(job.companyId);\n        if (company && job.customerEmail) {\n          await sendJobStatusEmail(job, company, 'assigned', req.user?.displayName);\n        }\n        \n        // Broadcast update via WebSocket\n        broadcastJobUpdate(job);\n      }\n      \n      res.json({ message: \"Job accepted successfully\", job });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Start job\n  app.post(\"/api/cleaner/start-job/:jobId\", requireRole(UserRole.CLEANER), requireActiveCleaner(storage), async (req: Request, res: Response) => {\n    try {\n      const { jobId } = req.params;\n\n      await storage.updateJob(parseInt(jobId), {\n        status: JobStatus.IN_PROGRESS,\n        startedAt: new Date(),\n      });\n      \n      const startedJob = await storage.getJob(parseInt(jobId));\n      \n      // Send push notification\n      if (startedJob) {\n        PushNotificationService.notifyJobStatusChange(parseInt(jobId), JobStatus.IN_PROGRESS, {\n          carPlateNumber: startedJob.carPlateNumber,\n          cleanerName: req.user?.displayName,\n          customerId: startedJob.customerId || undefined,\n        }).catch(err => console.error('Push notification failed:', err));\n        \n        // Send email notification if customer provided email\n        const company = await storage.getCompany(startedJob.companyId);\n        if (company && startedJob.customerEmail) {\n          await sendJobStatusEmail(startedJob, company, 'in_progress', req.user?.displayName);\n        }\n        \n        // Broadcast job start\n        broadcastJobUpdate(startedJob);\n      }\n\n      res.json({ success: true });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Update estimated times for job\n  app.patch(\"/api/cleaner/update-estimated-times/:jobId\", requireRole(UserRole.CLEANER), requireActiveCleaner(storage), async (req: Request, res: Response) => {\n    try {\n      const { jobId } = req.params;\n      const { estimatedStartTime, estimatedFinishTime } = req.body;\n\n      // Validate job ID\n      if (!jobId || isNaN(parseInt(jobId))) {\n        return res.status(400).json({ message: \"Invalid job ID\" });\n      }\n\n      // Validate request body - at least one time should be provided\n      if (!estimatedStartTime && !estimatedFinishTime) {\n        return res.status(400).json({ message: \"At least one estimated time must be provided\" });\n      }\n\n      const job = await storage.getJob(parseInt(jobId));\n      if (!job) {\n        return res.status(404).json({ message: \"Job not found\" });\n      }\n\n      // Verify the cleaner owns this job\n      const cleaner = await storage.getCleanerByUserId(req.user!.id);\n      if (!cleaner) {\n        return res.status(403).json({ message: \"Cleaner profile not found\" });\n      }\n      \n      if (job.cleanerId !== cleaner.id) {\n        return res.status(403).json({ message: \"Not authorized to update this job\" });\n      }\n\n      // Validate dates are in the future\n      const now = new Date();\n      if (estimatedStartTime && new Date(estimatedStartTime) < now) {\n        return res.status(400).json({ message: \"Estimated start time must be in the future\" });\n      }\n      if (estimatedFinishTime && new Date(estimatedFinishTime) < now) {\n        return res.status(400).json({ message: \"Estimated finish time must be in the future\" });\n      }\n\n      await storage.updateJob(parseInt(jobId), {\n        estimatedStartTime: estimatedStartTime ? new Date(estimatedStartTime) : undefined,\n        estimatedFinishTime: estimatedFinishTime ? new Date(estimatedFinishTime) : undefined,\n      });\n\n      const updatedJob = await storage.getJob(parseInt(jobId));\n      \n      // Broadcast update via WebSocket\n      if (updatedJob) {\n        broadcastJobUpdate(updatedJob);\n      }\n\n      res.json({ success: true, job: updatedJob });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Complete job with proof\n  app.post(\"/api/cleaner/complete-job/:jobId\", requireRole(UserRole.CLEANER), requireActiveCleaner(storage), async (req: Request, res: Response) => {\n    try {\n      const { jobId } = req.params;\n      const { proofPhotoURL } = req.body;\n\n      const job = await storage.getJob(parseInt(jobId));\n      if (!job) {\n        return res.status(404).json({ message: \"Job not found\" });\n      }\n\n      // Atomic idempotency check - prevent duplicate completion using storage layer\n      const receiptNumber = generateReceiptNumber();\n      const completedAt = new Date();\n      \n      const result = await storage.completeJobIfNotCompleted(parseInt(jobId), {\n        proofPhotoURL,\n        receiptNumber,\n        completedAt,\n      });\n\n      // If job was already completed, return success without processing\n      if (!result.updated) {\n        console.log(`[Job Complete] Job ${jobId} already completed - ignoring duplicate request`);\n        return res.json({ success: true, message: \"Job already completed\" });\n      }\n      \n      const completedJob = result.job;\n      \n      // Generate receipt PDF\n      if (completedJob) {\n        try {\n          const platformSettings = await storage.getAllPlatformSettings();\n          const settings = platformSettings[0] || {\n            id: 1,\n            companyName: 'Washapp.ae',\n            companyAddress: 'Dubai, United Arab Emirates',\n            vatRegistrationNumber: '',\n            createdAt: new Date(),\n            updatedAt: new Date(),\n          };\n\n          const fullPlateNumber = completedJob.carPlateEmirate && completedJob.carPlateCode\n            ? `${completedJob.carPlateEmirate} ${completedJob.carPlateCode} ${completedJob.carPlateNumber}`\n            : completedJob.carPlateNumber;\n\n          // Get actual financial data from job_financials table\n          const jobFinancials = await storage.getJobFinancialsByJobId(completedJob.id);\n          \n          // Use actual amounts from financials, or fallback to calculated values\n          let baseJobAmount: number;\n          let platformFeeAmount: number;\n          let tipAmount: number;\n          let vatAmount: number;\n          \n          if (jobFinancials) {\n            // Use actual values from financial record\n            baseJobAmount = Number(jobFinancials.baseJobAmount);\n            platformFeeAmount = Number(jobFinancials.platformFeeAmount);\n            tipAmount = Number(jobFinancials.tipAmount);\n            vatAmount = Number(jobFinancials.taxAmount);\n          } else {\n            // Fallback for legacy jobs: use stored values from job record\n            baseJobAmount = Number(completedJob.price);\n            tipAmount = Number(completedJob.tipAmount || 0);\n            vatAmount = Number(completedJob.taxAmount || 0);\n            \n            // Derive platform fee from total\n            // total = service + VAT + tip\n            // service = carWash + platformFee\n            // platformFee = total - carWash - VAT - tip\n            const totalAmount = Number(completedJob.totalAmount);\n            platformFeeAmount = Number((totalAmount - baseJobAmount - vatAmount - tipAmount).toFixed(2));\n            \n            // Ensure platform fee is non-negative (guard against data inconsistencies)\n            if (platformFeeAmount < 0) platformFeeAmount = 0;\n          }\n          \n          const totalAmount = Number(completedJob.totalAmount);\n\n          await generateReceipt({\n            receiptData: {\n              receiptNumber,\n              jobId: completedJob.id,\n              carPlateNumber: fullPlateNumber,\n              customerPhone: completedJob.customerPhone,\n              customerEmail: completedJob.customerEmail || undefined,\n              locationAddress: completedJob.locationAddress,\n              servicePrice: baseJobAmount,\n              platformFee: platformFeeAmount,\n              tipAmount,\n              vatAmount,\n              totalAmount,\n              paymentMethod: completedJob.paymentMethod || 'card',\n              completedAt,\n            },\n            platformSettings: settings,\n          });\n        } catch (receiptError) {\n          console.error('Failed to generate receipt:', receiptError);\n        }\n        \n        // Send push notification\n        PushNotificationService.notifyJobStatusChange(parseInt(jobId), JobStatus.COMPLETED, {\n          carPlateNumber: completedJob.carPlateNumber,\n          cleanerName: req.user?.displayName,\n          customerId: completedJob.customerId || undefined,\n        }).catch(err => console.error('Push notification failed:', err));\n        \n        // Send email notification with receipt\n        const company = await storage.getCompany(completedJob.companyId);\n        if (company) {\n          await sendJobStatusEmail(completedJob, company, 'completed', req.user?.displayName);\n        }\n        \n        // Broadcast job completion\n        broadcastJobUpdate(completedJob);\n      }\n\n      // Update cleaner status back to on-duty\n      const cleaner = await storage.getCleanerByUserId(req.user!.id);\n      if (cleaner) {\n        await storage.updateCleaner(cleaner.id, {\n          status: CleanerStatus.ON_DUTY,\n          totalJobsCompleted: cleaner.totalJobsCompleted + 1,\n        });\n\n        // Update company stats\n        const company = await storage.getCompany(job.companyId);\n        if (company) {\n          await storage.updateCompany(company.id, {\n            totalJobsCompleted: company.totalJobsCompleted + 1,\n            totalRevenue: (parseFloat(company.totalRevenue as any) + parseFloat(job.price as any)).toString(),\n          });\n        }\n      }\n\n      res.json({ success: true });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Update car plate on QR-paid anonymous job\n  app.patch(\"/api/cleaner/update-job-plate/:jobId\", requireRole(UserRole.CLEANER), requireActiveCleaner(storage), async (req: Request, res: Response) => {\n    try {\n      const { jobId } = req.params;\n      const { carPlateEmirate, carPlateCode, carPlateNumber } = req.body;\n\n      const cleaner = await storage.getCleanerByUserId(req.user!.id);\n      if (!cleaner) {\n        return res.status(404).json({ message: \"Cleaner not found\" });\n      }\n\n      const job = await storage.getJob(parseInt(jobId));\n      if (!job) {\n        return res.status(404).json({ message: \"Job not found\" });\n      }\n\n      // Verify job belongs to this cleaner\n      if (job.cleanerId !== cleaner.id) {\n        return res.status(403).json({ message: \"Not authorized to update this job\" });\n      }\n\n      // Only allow updating plate if it's currently anonymous (QR_SCAN or QR-ANON prefix)\n      if (!job.carPlateNumber?.startsWith('QR-ANON') && !job.carPlateNumber?.startsWith('QR_SCAN')) {\n        return res.status(400).json({ message: \"Can only update plate for QR-scanned anonymous jobs\" });\n      }\n\n      // Validate plate info\n      if (!carPlateNumber) {\n        return res.status(400).json({ message: \"Car plate number is required\" });\n      }\n\n      await storage.updateJob(parseInt(jobId), {\n        carPlateEmirate: carPlateEmirate || null,\n        carPlateCode: carPlateCode || null,\n        carPlateNumber,\n      });\n\n      const updatedJob = await storage.getJob(parseInt(jobId));\n      res.json({ success: true, job: updatedJob });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Create offline/manual job (for cash payments)\n  app.post(\"/api/cleaner/create-offline-job\", requireRole(UserRole.CLEANER), requireActiveCleaner(storage), async (req: Request, res: Response) => {\n    try {\n      const { carPlateEmirate, carPlateCode, carPlateNumber, notes } = req.body;\n\n      const cleaner = await storage.getCleanerByUserId(req.user!.id);\n      if (!cleaner) {\n        return res.status(404).json({ message: \"Cleaner not found\" });\n      }\n\n      if (!carPlateNumber) {\n        return res.status(400).json({ message: \"Car plate number is required\" });\n      }\n\n      if (!carPlateEmirate) {\n        return res.status(400).json({ message: \"Emirate is required\" });\n      }\n\n      if (!carPlateCode) {\n        return res.status(400).json({ message: \"Plate code is required\" });\n      }\n\n      // Get company's service price\n      const company = await storage.getCompany(cleaner.companyId);\n      if (!company) {\n        return res.status(404).json({ message: \"Company not found\" });\n      }\n\n      // Calculate VAT (5%) based on company's price\n      const price = parseFloat(company.pricePerWash);\n      const vatAmount = (price * 0.05).toFixed(2);\n      const totalAmount = (price + parseFloat(vatAmount)).toFixed(2);\n\n      const offlineJob = await storage.createOfflineJob({\n        cleanerId: cleaner.id,\n        companyId: cleaner.companyId,\n        carPlateNumber,\n        carPlateEmirate,\n        carPlateCode,\n        servicePrice: price.toFixed(2),\n        vatAmount,\n        totalAmount,\n        notes: notes || undefined,\n      });\n\n      res.json({ success: true, offlineJob });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Complete offline job with photo proof\n  app.post(\"/api/cleaner/complete-offline-job/:jobId\", requireRole(UserRole.CLEANER), requireActiveCleaner(storage), upload.single(\"photo\"), async (req: Request, res: Response) => {\n    try {\n      const { jobId } = req.params;\n\n      if (!req.file) {\n        return res.status(400).json({ message: \"Proof photo is required\" });\n      }\n\n      const allowedImageTypes = [\"image/jpeg\", \"image/png\", \"image/webp\"];\n      if (!allowedImageTypes.includes(req.file.mimetype)) {\n        return res.status(400).json({ message: \"Only image files (JPEG, PNG, WebP) are allowed\" });\n      }\n\n      const cleaner = await storage.getCleanerByUserId(req.user!.id);\n      if (!cleaner) {\n        return res.status(404).json({ message: \"Cleaner not found\" });\n      }\n\n      const offlineJob = await storage.getOfflineJob(parseInt(jobId));\n      if (!offlineJob) {\n        return res.status(404).json({ message: \"Offline job not found\" });\n      }\n\n      if (offlineJob.cleanerId !== cleaner.id) {\n        return res.status(403).json({ message: \"Not authorized to complete this job\" });\n      }\n\n      if (offlineJob.status === \"completed\") {\n        return res.json({ success: true, message: \"Job already completed\" });\n      }\n\n      const photoUrl = `/uploads/proofs/${req.file.filename}`;\n      await storage.completeOfflineJob(parseInt(jobId), photoUrl);\n\n      res.json({ success: true });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Get cleaner's offline jobs\n  app.get(\"/api/cleaner/offline-jobs\", requireRole(UserRole.CLEANER), requireActiveCleaner(storage), async (req: Request, res: Response) => {\n    try {\n      const cleaner = await storage.getCleanerByUserId(req.user!.id);\n      if (!cleaner) {\n        return res.status(404).json({ message: \"Cleaner not found\" });\n      }\n\n      const jobs = await storage.getCompanyOfflineJobs(cleaner.companyId, {\n        cleanerId: cleaner.id,\n      });\n\n      res.json(jobs);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // ===== COMPANY ADMIN ROUTES =====\n\n  // Get company analytics\n  app.get(\"/api/company/analytics\", requireRole(UserRole.COMPANY_ADMIN), async (req: Request, res: Response) => {\n    try {\n      res.set('Cache-Control', 'no-store, must-revalidate');\n      res.set('Pragma', 'no-cache');\n      \n      if (!req.user?.companyId) {\n        return res.status(400).json({ message: \"No company associated with user\" });\n      }\n\n      const analytics = await storage.getCompanyAnalytics(req.user.companyId);\n      res.json(analytics);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Get company cleaners\n  app.get(\"/api/company/cleaners\", requireRole(UserRole.COMPANY_ADMIN), async (req: Request, res: Response) => {\n    try {\n      if (!req.user?.companyId) {\n        return res.status(400).json({ message: \"No company associated with user\" });\n      }\n\n      const cleaners = await storage.getCompanyCleaners(req.user.companyId);\n      \n      // Fetch geofence assignments for each cleaner\n      const cleanersWithGeofences = await Promise.all(\n        cleaners.map(async (cleaner) => {\n          const geofences = await storage.getCleanerGeofenceAssignments(cleaner.id);\n          const isAssignedAll = await storage.isCleanerAssignedToAllGeofences(cleaner.id);\n          \n          return {\n            ...cleaner,\n            assignedGeofences: geofences,\n            isAssignedToAll: isAssignedAll,\n          };\n        })\n      );\n      \n      res.json(cleanersWithGeofences);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Get company shift history\n  app.get(\"/api/company/shift-history\", requireRole(UserRole.COMPANY_ADMIN), async (req: Request, res: Response) => {\n    try {\n      res.set('Cache-Control', 'no-store, must-revalidate');\n      res.set('Pragma', 'no-cache');\n      \n      if (!req.user?.companyId) {\n        return res.status(400).json({ message: \"No company associated with user\" });\n      }\n\n      const filters: any = {};\n      \n      if (req.query.cleanerId) {\n        filters.cleanerId = parseInt(req.query.cleanerId as string);\n      }\n      \n      if (req.query.startDate) {\n        filters.startDate = new Date(req.query.startDate as string);\n      }\n      \n      if (req.query.endDate) {\n        filters.endDate = new Date(req.query.endDate as string);\n      }\n      \n      if (req.query.limit) {\n        filters.limit = parseInt(req.query.limit as string);\n      }\n      \n      const shifts = await storage.getCompanyShiftHistory(req.user.companyId, filters);\n      res.json(shifts);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Get company offline jobs report\n  app.get(\"/api/company/offline-jobs\", requireRole(UserRole.COMPANY_ADMIN), async (req: Request, res: Response) => {\n    try {\n      res.set('Cache-Control', 'no-store, must-revalidate');\n      res.set('Pragma', 'no-cache');\n      \n      if (!req.user?.companyId) {\n        return res.status(400).json({ message: \"No company associated with user\" });\n      }\n\n      const filters: any = {};\n      \n      if (req.query.cleanerId) {\n        filters.cleanerId = parseInt(req.query.cleanerId as string);\n      }\n      \n      if (req.query.startDate) {\n        filters.startDate = new Date(req.query.startDate as string);\n      }\n      \n      if (req.query.endDate) {\n        filters.endDate = new Date(req.query.endDate as string);\n      }\n      \n      const report = await storage.getOfflineJobsReport(req.user.companyId, filters);\n      res.json(report);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Deactivate a cleaner\n  app.post(\"/api/company/cleaners/:cleanerId/deactivate\", requireRole(UserRole.COMPANY_ADMIN), async (req: Request, res: Response) => {\n    try {\n      if (!req.user?.companyId) {\n        return res.status(400).json({ message: \"No company associated with user\" });\n      }\n\n      const cleanerId = parseInt(req.params.cleanerId);\n      if (isNaN(cleanerId)) {\n        return res.status(400).json({ message: \"Invalid cleaner ID\" });\n      }\n\n      // Get cleaner to verify it belongs to the company\n      const cleaner = await storage.getCleaner(cleanerId);\n      if (!cleaner) {\n        return res.status(404).json({ message: \"Cleaner not found\" });\n      }\n\n      if (cleaner.companyId !== req.user.companyId) {\n        return res.status(403).json({ message: \"You can only deactivate cleaners from your own company\" });\n      }\n\n      // Deactivate the cleaner and set to off-duty\n      await storage.updateCleaner(cleanerId, { isActive: 0, status: \"off_duty\" });\n\n      // Immediately destroy all sessions for this cleaner to force logout\n      // The requireActiveCleaner middleware will also catch them on next request\n      if (sessionStore.all) {\n        try {\n          const sessions = await new Promise<any[]>((resolve, reject) => {\n            sessionStore.all!((err: any, sessions: any) => {\n              if (err) reject(err);\n              else resolve(sessions || []);\n            });\n          });\n\n          // Find and destroy sessions for this cleaner's user\n          for (const session of sessions) {\n            if (session.passport?.user?.id === cleaner.userId) {\n              sessionStore.destroy(session.sid, (err: any) => {\n                if (err) console.error('Failed to destroy session:', err);\n              });\n            }\n          }\n        } catch (sessionError) {\n          console.error('Failed to destroy sessions:', sessionError);\n          // Continue anyway - middleware will catch them on next request\n        }\n      }\n      \n      res.json({ success: true, message: \"Cleaner deactivated successfully\" });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Reactivate a cleaner\n  app.post(\"/api/company/cleaners/:cleanerId/reactivate\", requireRole(UserRole.COMPANY_ADMIN), async (req: Request, res: Response) => {\n    try {\n      if (!req.user?.companyId) {\n        return res.status(400).json({ message: \"No company associated with user\" });\n      }\n\n      const cleanerId = parseInt(req.params.cleanerId);\n      if (isNaN(cleanerId)) {\n        return res.status(400).json({ message: \"Invalid cleaner ID\" });\n      }\n\n      // Get cleaner to verify it belongs to the company\n      const cleaner = await storage.getCleaner(cleanerId);\n      if (!cleaner) {\n        return res.status(404).json({ message: \"Cleaner not found\" });\n      }\n\n      if (cleaner.companyId !== req.user.companyId) {\n        return res.status(403).json({ message: \"You can only reactivate cleaners from your own company\" });\n      }\n\n      // Reactivate the cleaner\n      await storage.updateCleaner(cleanerId, { isActive: 1 });\n      \n      res.json({ success: true, message: \"Cleaner reactivated successfully\" });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Get company invitations\n  app.get(\"/api/company/invitations\", requireRole(UserRole.COMPANY_ADMIN), async (req: Request, res: Response) => {\n    try {\n      if (!req.user?.companyId) {\n        return res.status(400).json({ message: \"No company associated with user\" });\n      }\n\n      const invitations = await storage.getCompanyInvitations(req.user.companyId);\n      res.json(invitations);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Invite cleaner by phone number\n  app.post(\"/api/company/invite-cleaner\", requireRole(UserRole.COMPANY_ADMIN), async (req: Request, res: Response) => {\n    try {\n      if (!req.user?.companyId) {\n        return res.status(400).json({ message: \"No company associated with user\" });\n      }\n\n      const { phoneNumber, geofenceIds, assignAll } = req.body;\n\n      // Check if phone number already has an invitation\n      const existing = await storage.getInvitationByPhone(phoneNumber);\n      if (existing) {\n        return res.status(400).json({ message: \"Phone number already invited\" });\n      }\n\n      // Check cleaner limit for subscription packages\n      const company = await storage.getCompany(req.user.companyId);\n      if (!company) {\n        return res.status(404).json({ message: \"Company not found\" });\n      }\n\n      if (company.packageType === 'subscription' && company.subscriptionCleanerSlots) {\n        const activeCleaners = await storage.getCompanyCleaners(req.user.companyId);\n        const activeCount = activeCleaners.filter(c => c.isActive === 1).length;\n        const pendingInvitations = await storage.getCompanyInvitations(req.user.companyId);\n        const pendingCount = pendingInvitations.filter(inv => inv.status === 'pending').length;\n        const totalCount = activeCount + pendingCount;\n\n        if (totalCount >= company.subscriptionCleanerSlots) {\n          return res.status(400).json({ \n            message: `Cleaner limit reached. Your subscription allows ${company.subscriptionCleanerSlots} cleaners. You currently have ${activeCount} active cleaners and ${pendingCount} pending invitations. Please upgrade your subscription to invite more cleaners.`\n          });\n        }\n      }\n\n      // Validate geofence IDs if provided\n      if (geofenceIds && Array.isArray(geofenceIds) && geofenceIds.length > 0) {\n        const companyGeofences = await storage.getCompanyGeofences(req.user.companyId);\n        const validGeofenceIds = companyGeofences.map(g => g.id);\n        const invalidIds = geofenceIds.filter(id => !validGeofenceIds.includes(id));\n        \n        if (invalidIds.length > 0) {\n          return res.status(400).json({ message: \"Invalid geofence IDs provided\" });\n        }\n      }\n\n      // Create invitation\n      const invitation = await storage.createInvitation({\n        companyId: req.user.companyId,\n        phoneNumber,\n        invitedBy: req.user.id,\n        status: \"pending\",\n      });\n\n      // Assign geofences to invitation\n      if (assignAll || (geofenceIds && geofenceIds.length > 0)) {\n        await storage.assignGeofencesToInvitation(\n          invitation.id,\n          req.user.companyId,\n          geofenceIds || [],\n          assignAll || false\n        );\n      }\n\n      res.json(invitation);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Get cleaner geofence assignments\n  app.get(\"/api/company/cleaners/:cleanerId/geofences\", requireRole(UserRole.COMPANY_ADMIN), async (req: Request, res: Response) => {\n    try {\n      if (!req.user?.companyId) {\n        return res.status(400).json({ message: \"No company associated with user\" });\n      }\n\n      const cleanerId = parseInt(req.params.cleanerId);\n      if (isNaN(cleanerId)) {\n        return res.status(400).json({ message: \"Invalid cleaner ID\" });\n      }\n\n      const cleaner = await storage.getCleaner(cleanerId);\n      if (!cleaner || cleaner.companyId !== req.user.companyId) {\n        return res.status(404).json({ message: \"Cleaner not found\" });\n      }\n\n      const geofences = await storage.getCleanerGeofenceAssignments(cleanerId);\n      const assignAll = await storage.isCleanerAssignedToAllGeofences(cleanerId);\n      \n      res.json({ geofences, assignAll });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Update cleaner geofence assignments\n  app.put(\"/api/company/cleaners/:cleanerId/geofences\", requireRole(UserRole.COMPANY_ADMIN), async (req: Request, res: Response) => {\n    try {\n      if (!req.user?.companyId) {\n        return res.status(400).json({ message: \"No company associated with user\" });\n      }\n\n      const cleanerId = parseInt(req.params.cleanerId);\n      if (isNaN(cleanerId)) {\n        return res.status(400).json({ message: \"Invalid cleaner ID\" });\n      }\n\n      const { geofenceIds, assignAll } = req.body;\n\n      const cleaner = await storage.getCleaner(cleanerId);\n      if (!cleaner || cleaner.companyId !== req.user.companyId) {\n        return res.status(404).json({ message: \"Cleaner not found\" });\n      }\n\n      if (geofenceIds && Array.isArray(geofenceIds) && geofenceIds.length > 0) {\n        const companyGeofences = await storage.getCompanyGeofences(req.user.companyId);\n        const validGeofenceIds = companyGeofences.map(g => g.id);\n        const invalidIds = geofenceIds.filter(id => !validGeofenceIds.includes(id));\n        \n        if (invalidIds.length > 0) {\n          return res.status(400).json({ message: \"Invalid geofence IDs provided\" });\n        }\n      }\n\n      await storage.assignGeofencesToCleaner(\n        cleanerId,\n        req.user.companyId,\n        geofenceIds || [],\n        assignAll || false\n      );\n\n      res.json({ success: true });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Get invitation geofence assignments\n  app.get(\"/api/company/invitations/:invitationId/geofences\", requireRole(UserRole.COMPANY_ADMIN), async (req: Request, res: Response) => {\n    try {\n      if (!req.user?.companyId) {\n        return res.status(400).json({ message: \"No company associated with user\" });\n      }\n\n      const invitationId = parseInt(req.params.invitationId);\n      if (isNaN(invitationId)) {\n        return res.status(400).json({ message: \"Invalid invitation ID\" });\n      }\n\n      const invitations = await storage.getCompanyInvitations(req.user.companyId);\n      const invitation = invitations.find(inv => inv.id === invitationId);\n      \n      if (!invitation) {\n        return res.status(404).json({ message: \"Invitation not found\" });\n      }\n\n      const geofences = await storage.getInvitationGeofenceAssignments(invitationId);\n      \n      res.json({ geofences });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Update invitation geofence assignments\n  app.put(\"/api/company/invitations/:invitationId/geofences\", requireRole(UserRole.COMPANY_ADMIN), async (req: Request, res: Response) => {\n    try {\n      if (!req.user?.companyId) {\n        return res.status(400).json({ message: \"No company associated with user\" });\n      }\n\n      const invitationId = parseInt(req.params.invitationId);\n      if (isNaN(invitationId)) {\n        return res.status(400).json({ message: \"Invalid invitation ID\" });\n      }\n\n      const { geofenceIds, assignAll } = req.body;\n\n      const invitations = await storage.getCompanyInvitations(req.user.companyId);\n      const invitation = invitations.find(inv => inv.id === invitationId);\n      \n      if (!invitation) {\n        return res.status(404).json({ message: \"Invitation not found\" });\n      }\n\n      if (geofenceIds && Array.isArray(geofenceIds) && geofenceIds.length > 0) {\n        const companyGeofences = await storage.getCompanyGeofences(req.user.companyId);\n        const validGeofenceIds = companyGeofences.map(g => g.id);\n        const invalidIds = geofenceIds.filter(id => !validGeofenceIds.includes(id));\n        \n        if (invalidIds.length > 0) {\n          return res.status(400).json({ message: \"Invalid geofence IDs provided\" });\n        }\n      }\n\n      await storage.assignGeofencesToInvitation(\n        invitationId,\n        req.user.companyId,\n        geofenceIds || [],\n        assignAll || false\n      );\n\n      res.json({ success: true });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Get company geofence\n  app.get(\"/api/company/geofence\", requireRole(UserRole.COMPANY_ADMIN), async (req: Request, res: Response) => {\n    try {\n      if (!req.user?.companyId) {\n        return res.status(400).json({ message: \"No company associated with user\" });\n      }\n\n      const company = await storage.getCompany(req.user.companyId);\n      if (!company) {\n        return res.status(404).json({ message: \"Company not found\" });\n      }\n\n      res.json({ geofenceArea: company.geofenceArea || null });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Update company geofence\n  app.put(\"/api/company/geofence\", requireRole(UserRole.COMPANY_ADMIN), async (req: Request, res: Response) => {\n    try {\n      if (!req.user?.companyId) {\n        return res.status(400).json({ message: \"No company associated with user\" });\n      }\n\n      const { geofenceArea } = req.body;\n\n      // Validate geofenceArea is an array of coordinate pairs\n      if (geofenceArea && (!Array.isArray(geofenceArea) || !geofenceArea.every(coord => \n        Array.isArray(coord) && coord.length === 2 && \n        typeof coord[0] === 'number' && typeof coord[1] === 'number'\n      ))) {\n        return res.status(400).json({ message: \"Invalid geofence format. Expected array of [lat, lng] pairs\" });\n      }\n\n      await storage.updateCompany(req.user.companyId, { geofenceArea });\n      \n      res.json({ success: true, geofenceArea });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // ===== COMPANY GEOFENCES ROUTES (Multiple Geofences) =====\n\n  // Get all company geofences\n  app.get(\"/api/company/geofences\", requireRole(UserRole.COMPANY_ADMIN), async (req: Request, res: Response) => {\n    try {\n      if (!req.user?.companyId) {\n        return res.status(400).json({ message: \"No company associated with user\" });\n      }\n\n      const geofences = await storage.getCompanyGeofences(req.user.companyId);\n      res.json(geofences);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Create a new geofence\n  app.post(\"/api/company/geofences\", requireRole(UserRole.COMPANY_ADMIN), async (req: Request, res: Response) => {\n    try {\n      if (!req.user?.companyId) {\n        return res.status(400).json({ message: \"No company associated with user\" });\n      }\n\n      const { name, polygon } = req.body;\n\n      // Validate name\n      if (!name || typeof name !== 'string' || name.trim().length === 0) {\n        return res.status(400).json({ message: \"Name is required\" });\n      }\n\n      // Validate polygon is an array of coordinate pairs with at least 3 points\n      if (!polygon || !Array.isArray(polygon) || polygon.length < 3) {\n        return res.status(400).json({ message: \"Polygon must have at least 3 points\" });\n      }\n\n      if (!polygon.every((coord: any) => \n        Array.isArray(coord) && coord.length === 2 && \n        typeof coord[0] === 'number' && typeof coord[1] === 'number'\n      )) {\n        return res.status(400).json({ message: \"Invalid polygon format. Expected array of [lat, lng] pairs\" });\n      }\n\n      // Check for duplicate name\n      const existing = await storage.getGeofenceByCompanyAndName(req.user.companyId, name.trim());\n      if (existing) {\n        return res.status(409).json({ message: \"A geofence with this name already exists\" });\n      }\n\n      const geofence = await storage.createGeofence({\n        companyId: req.user.companyId,\n        name: name.trim(),\n        polygon,\n      });\n\n      res.status(201).json(geofence);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Update a geofence (name or polygon)\n  app.patch(\"/api/company/geofences/:geofenceId\", requireRole(UserRole.COMPANY_ADMIN), async (req: Request, res: Response) => {\n    try {\n      if (!req.user?.companyId) {\n        return res.status(400).json({ message: \"No company associated with user\" });\n      }\n\n      const geofenceId = parseInt(req.params.geofenceId);\n      if (isNaN(geofenceId)) {\n        return res.status(400).json({ message: \"Invalid geofence ID\" });\n      }\n\n      // Verify geofence exists and belongs to the company\n      const geofence = await storage.getGeofence(geofenceId);\n      if (!geofence) {\n        return res.status(404).json({ message: \"Geofence not found\" });\n      }\n\n      if (geofence.companyId !== req.user.companyId) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      const { name, polygon } = req.body;\n      const updates: Partial<Pick<typeof geofence, 'name' | 'polygon'>> = {};\n\n      // Validate and add name if provided\n      if (name !== undefined) {\n        if (typeof name !== 'string' || name.trim().length === 0) {\n          return res.status(400).json({ message: \"Name must be a non-empty string\" });\n        }\n\n        // Check for duplicate name (excluding current geofence)\n        const existing = await storage.getGeofenceByCompanyAndName(req.user.companyId, name.trim());\n        if (existing && existing.id !== geofenceId) {\n          return res.status(409).json({ message: \"A geofence with this name already exists\" });\n        }\n\n        updates.name = name.trim();\n      }\n\n      // Validate and add polygon if provided\n      if (polygon !== undefined) {\n        if (!Array.isArray(polygon) || polygon.length < 3) {\n          return res.status(400).json({ message: \"Polygon must have at least 3 points\" });\n        }\n\n        if (!polygon.every((coord: any) => \n          Array.isArray(coord) && coord.length === 2 && \n          typeof coord[0] === 'number' && typeof coord[1] === 'number'\n        )) {\n          return res.status(400).json({ message: \"Invalid polygon format. Expected array of [lat, lng] pairs\" });\n        }\n\n        updates.polygon = polygon;\n      }\n\n      if (Object.keys(updates).length === 0) {\n        return res.status(400).json({ message: \"No updates provided\" });\n      }\n\n      await storage.updateGeofence(geofenceId, updates);\n\n      // Fetch and return updated geofence\n      const updatedGeofence = await storage.getGeofence(geofenceId);\n      res.json(updatedGeofence);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Delete a geofence\n  app.delete(\"/api/company/geofences/:geofenceId\", requireRole(UserRole.COMPANY_ADMIN), async (req: Request, res: Response) => {\n    try {\n      if (!req.user?.companyId) {\n        return res.status(400).json({ message: \"No company associated with user\" });\n      }\n\n      const geofenceId = parseInt(req.params.geofenceId);\n      if (isNaN(geofenceId)) {\n        return res.status(400).json({ message: \"Invalid geofence ID\" });\n      }\n\n      // Verify geofence exists and belongs to the company\n      const geofence = await storage.getGeofence(geofenceId);\n      if (!geofence) {\n        return res.status(404).json({ message: \"Geofence not found\" });\n      }\n\n      if (geofence.companyId !== req.user.companyId) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      await storage.deleteGeofence(geofenceId);\n      res.json({ success: true, message: \"Geofence deleted successfully\" });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // ===== ADMIN ROUTES =====\n\n  // Get platform analytics\n  app.get(\"/api/admin/analytics\", requireRole(UserRole.ADMIN), async (req: Request, res: Response) => {\n    try {\n      res.set('Cache-Control', 'no-store, must-revalidate');\n      res.set('Pragma', 'no-cache');\n      \n      const analytics = await storage.getAdminAnalytics();\n      res.json(analytics);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Get live report for admin (all companies or filtered by company)\n  app.get(\"/api/admin/live-report\", requireRole(UserRole.ADMIN), async (req: Request, res: Response) => {\n    try {\n      res.set('Cache-Control', 'no-store, must-revalidate');\n      res.set('Pragma', 'no-cache');\n      \n      const { companyId } = req.query;\n      const options = companyId ? { companyId: parseInt(companyId as string) } : {};\n      const report = await storage.getLiveReport(options);\n      res.json(report);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Download receipt by job ID (admin)\n  app.get(\"/api/admin/receipt/:jobId\", requireRole(UserRole.ADMIN), async (req: Request, res: Response) => {\n    try {\n      const jobId = parseInt(req.params.jobId);\n      if (isNaN(jobId)) {\n        return res.status(400).json({ message: \"Invalid job ID\" });\n      }\n      \n      const job = await storage.getJob(jobId);\n      if (!job) {\n        return res.status(404).json({ message: \"Job not found\" });\n      }\n      \n      if (!job.receiptNumber) {\n        return res.status(404).json({ message: \"Receipt not available for this job\" });\n      }\n      \n      const receiptPath = path.join(process.cwd(), 'uploads', 'receipts', `receipt-${job.receiptNumber}.pdf`);\n      \n      if (!existsSync(receiptPath)) {\n        return res.status(404).json({ message: \"Receipt file not found\" });\n      }\n      \n      res.download(receiptPath, `receipt-${job.receiptNumber}.pdf`);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Get platform settings\n  app.get(\"/api/admin/platform-settings\", requireRole(UserRole.ADMIN), async (req: Request, res: Response) => {\n    try {\n      res.set('Cache-Control', 'no-store, must-revalidate');\n      res.set('Pragma', 'no-cache');\n      \n      const settings = await storage.getAllPlatformSettings();\n      res.json(settings[0] || {\n        id: 1,\n        companyName: 'Washapp.ae',\n        companyAddress: 'Dubai, United Arab Emirates',\n        vatRegistrationNumber: '',\n        logoUrl: null,\n        createdAt: new Date(),\n        updatedAt: new Date(),\n      });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Update platform settings\n  app.patch(\"/api/admin/platform-settings\", requireRole(UserRole.ADMIN), async (req: Request, res: Response) => {\n    try {\n      const { companyName, companyAddress, vatRegistrationNumber, logoUrl } = req.body;\n      await storage.updatePlatformSettings(1, {\n        companyName,\n        companyAddress,\n        vatRegistrationNumber,\n        logoUrl,\n      });\n      res.json({ success: true });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Get pending companies for approval\n  app.get(\"/api/admin/pending-companies\", requireRole(UserRole.ADMIN), async (req: Request, res: Response) => {\n    try {\n      res.set('Cache-Control', 'no-store, must-revalidate');\n      res.set('Pragma', 'no-cache');\n      \n      const companies = await storage.getPendingCompanies();\n      res.json(companies);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Approve company\n  app.post(\"/api/admin/approve-company/:companyId\", requireRole(UserRole.ADMIN), async (req: Request, res: Response) => {\n    try {\n      const { companyId } = req.params;\n      const { platformFee, feePackageType } = req.body;\n      await storage.approveCompany(parseInt(companyId), platformFee, feePackageType);\n      res.json({ success: true });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Reject company\n  app.post(\"/api/admin/reject-company/:companyId\", requireRole(UserRole.ADMIN), async (req: Request, res: Response) => {\n    try {\n      const { companyId } = req.params;\n      await storage.rejectCompany(parseInt(companyId));\n      res.json({ success: true });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Update company fee structure\n  app.patch(\"/api/admin/company/:companyId/fee-structure\", requireRole(UserRole.ADMIN), async (req: Request, res: Response) => {\n    try {\n      const { companyId } = req.params;\n      const { platformFee, feePackageType } = req.body;\n      \n      const updateData: any = {};\n      if (platformFee !== undefined) {\n        updateData.platformFee = platformFee.toString();\n      }\n      if (feePackageType) {\n        updateData.feePackageType = feePackageType;\n      }\n      \n      await storage.updateCompany(parseInt(companyId), updateData);\n      res.json({ success: true });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // ==== ADMIN FINANCIAL ROUTES ====\n  \n  // Get all companies financial summary\n  app.get(\"/api/admin/financials/companies\", requireRole(UserRole.ADMIN), async (req: Request, res: Response) => {\n    try {\n      const summary = await storage.getAllCompaniesFinancialSummary();\n      res.json(summary);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Get detailed company financials\n  app.get(\"/api/admin/financials/company/:companyId\", requireRole(UserRole.ADMIN), async (req: Request, res: Response) => {\n    try {\n      const { companyId } = req.params;\n      const { page, pageSize } = req.query;\n      \n      const filters: any = {};\n      if (page) filters.page = parseInt(page as string);\n      if (pageSize) filters.pageSize = parseInt(pageSize as string);\n      \n      const summary = await storage.getCompanyFinancialSummary(parseInt(companyId));\n      const jobsResult = await storage.getCompanyFinancials(parseInt(companyId), filters);\n      const withdrawals = await storage.getCompanyWithdrawals(parseInt(companyId));\n      \n      res.json({\n        summary,\n        jobs: jobsResult.data,\n        jobsTotal: jobsResult.total,\n        withdrawals,\n      });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Get all withdrawals (admin)\n  app.get(\"/api/admin/financials/withdrawals\", requireRole(UserRole.ADMIN), async (req: Request, res: Response) => {\n    try {\n      const withdrawals = await storage.getAllWithdrawals();\n      res.json(withdrawals);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Process withdrawal (update status)\n  app.patch(\"/api/admin/financials/withdrawals/:id\", requireRole(UserRole.ADMIN), async (req: Request, res: Response) => {\n    try {\n      const { id } = req.params;\n      const { status, referenceNumber, note } = req.body;\n      \n      const updates: any = { status };\n      if (referenceNumber) updates.referenceNumber = referenceNumber;\n      if (note) updates.note = note;\n      if (status === 'completed') {\n        updates.processedAt = new Date();\n        updates.processedBy = (req.user as any).id;\n      }\n      \n      await storage.updateWithdrawal(parseInt(id), updates);\n      res.json({ success: true });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Get company transactions\n  app.get(\"/api/admin/financials/company/:companyId/transactions\", requireRole(UserRole.ADMIN), async (req: Request, res: Response) => {\n    try {\n      res.setHeader('Cache-Control', 'no-store, must-revalidate');\n      const { companyId } = req.params;\n      const transactions = await storage.getCompanyTransactions(parseInt(companyId));\n      res.json(transactions);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Create admin payout transaction (tracks money paid to company from their revenue)\n  app.post(\"/api/admin/financials/company/:companyId/transactions\", requireRole(UserRole.ADMIN), async (req: Request, res: Response) => {\n    try {\n      const { companyId } = req.params;\n      const { amount, description } = req.body;\n\n      const amountNumber = Number(amount);\n      if (!amountNumber || amountNumber <= 0) {\n        return res.status(400).json({ message: \"Amount must be greater than 0\" });\n      }\n\n      if (!description || description.trim().length === 0) {\n        return res.status(400).json({ message: \"Description is required\" });\n      }\n\n      const summary = await storage.getCompanyFinancialSummary(parseInt(companyId));\n      if (amountNumber > summary.availableBalance) {\n        return res.status(400).json({ message: \"Payout amount exceeds available balance\" });\n      }\n\n      const referenceNumber = `PAY-${Date.now()}-${Math.random().toString(36).substring(7).toUpperCase()}`;\n\n      const transaction = await storage.createTransaction({\n        referenceNumber,\n        type: 'admin_payment',\n        direction: 'debit',\n        companyId: parseInt(companyId),\n        amount: amountNumber.toString(),\n        currency: 'AED',\n        description,\n      });\n\n      res.json(transaction);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // ==== COMPANY FINANCIAL ROUTES ====\n  \n  // Get company financial overview\n  app.get(\"/api/company/financials/overview\", requireRole(UserRole.COMPANY_ADMIN), async (req: Request, res: Response) => {\n    try {\n      const user = req.user as any;\n      const companyId = user.companyId;\n      \n      if (!companyId) {\n        return res.status(400).json({ message: \"Company not found for user\" });\n      }\n      \n      const summary = await storage.getCompanyFinancialSummary(companyId);\n      res.json(summary);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Get company job financials with filters\n  app.get(\"/api/company/financials/jobs\", requireRole(UserRole.COMPANY_ADMIN), async (req: Request, res: Response) => {\n    try {\n      const user = req.user as any;\n      const companyId = user.companyId;\n      \n      if (!companyId) {\n        return res.status(400).json({ message: \"Company not found for user\" });\n      }\n      \n      const { cleanerId, startDate, endDate, page, pageSize } = req.query;\n      \n      const filters: any = {};\n      if (cleanerId) filters.cleanerId = parseInt(cleanerId as string);\n      if (startDate) filters.startDate = new Date(startDate as string);\n      if (endDate) filters.endDate = new Date(endDate as string);\n      if (page) filters.page = parseInt(page as string);\n      if (pageSize) filters.pageSize = parseInt(pageSize as string);\n      \n      const result = await storage.getCompanyFinancials(companyId, filters);\n      res.json(result);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Get company withdrawals\n  app.get(\"/api/company/financials/withdrawals\", requireRole(UserRole.COMPANY_ADMIN), async (req: Request, res: Response) => {\n    try {\n      const user = req.user as any;\n      const companyId = user.companyId;\n      \n      if (!companyId) {\n        return res.status(400).json({ message: \"Company not found for user\" });\n      }\n      \n      const withdrawals = await storage.getCompanyWithdrawals(companyId);\n      res.json(withdrawals);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Get company withdrawal balance (available jobs and tips)\n  app.get(\"/api/company/financials/withdrawal-balance\", requireRole(UserRole.COMPANY_ADMIN), async (req: Request, res: Response) => {\n    try {\n      res.set('Cache-Control', 'no-store, must-revalidate');\n      res.set('Pragma', 'no-cache');\n      \n      const user = req.user as any;\n      const companyId = user.companyId;\n      \n      if (!companyId) {\n        return res.status(400).json({ message: \"Company not found for user\" });\n      }\n      \n      const balance = await storage.getCompanyWithdrawalBalance(companyId);\n      res.json(balance);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Get company live report (with optional cleaner filter)\n  app.get(\"/api/company/live-report\", requireRole(UserRole.COMPANY_ADMIN), async (req: Request, res: Response) => {\n    try {\n      res.set('Cache-Control', 'no-store, must-revalidate');\n      res.set('Pragma', 'no-cache');\n      \n      const user = req.user as any;\n      const companyId = user.companyId;\n      \n      if (!companyId) {\n        return res.status(400).json({ message: \"Company not found for user\" });\n      }\n      \n      const { cleanerId } = req.query;\n      const options: { companyId: number; cleanerId?: number } = { companyId };\n      if (cleanerId) {\n        options.cleanerId = parseInt(cleanerId as string);\n      }\n      \n      const report = await storage.getLiveReport(options);\n      res.json(report);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Download receipt by job ID (company)\n  app.get(\"/api/company/receipt/:jobId\", requireRole(UserRole.COMPANY_ADMIN), async (req: Request, res: Response) => {\n    try {\n      const user = req.user as any;\n      const companyId = user.companyId;\n      \n      if (!companyId) {\n        return res.status(400).json({ message: \"Company not found for user\" });\n      }\n      \n      const jobId = parseInt(req.params.jobId);\n      if (isNaN(jobId)) {\n        return res.status(400).json({ message: \"Invalid job ID\" });\n      }\n      \n      const job = await storage.getJob(jobId);\n      if (!job) {\n        return res.status(404).json({ message: \"Job not found\" });\n      }\n      \n      // Verify job belongs to company\n      if (job.companyId !== companyId) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      if (!job.receiptNumber) {\n        return res.status(404).json({ message: \"Receipt not available for this job\" });\n      }\n      \n      const receiptPath = path.join(process.cwd(), 'uploads', 'receipts', `receipt-${job.receiptNumber}.pdf`);\n      \n      if (!existsSync(receiptPath)) {\n        return res.status(404).json({ message: \"Receipt file not found\" });\n      }\n      \n      res.download(receiptPath, `receipt-${job.receiptNumber}.pdf`);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Request withdrawal with validation\n  app.post(\"/api/company/financials/request-withdrawal\", requireRole(UserRole.COMPANY_ADMIN), async (req: Request, res: Response) => {\n    try {\n      const user = req.user as any;\n      const companyId = user.companyId;\n      \n      if (!companyId) {\n        return res.status(400).json({ message: \"Company not found for user\" });\n      }\n      \n      const { jobCount, tipsAmount, invoiceUrl } = req.body;\n      \n      // Validate input\n      if (!jobCount || jobCount < 1) {\n        return res.status(400).json({ message: \"Invalid job count\" });\n      }\n      \n      if (!invoiceUrl) {\n        return res.status(400).json({ message: \"Invoice upload is required\" });\n      }\n      \n      // Get current balance\n      const balance = await storage.getCompanyWithdrawalBalance(companyId);\n      \n      // Validate against available balance\n      if (jobCount > balance.availableJobs) {\n        return res.status(400).json({ \n          message: `Cannot withdraw more jobs than available. Available: ${balance.availableJobs}` \n        });\n      }\n      \n      const requestedTips = parseFloat(tipsAmount || \"0\");\n      if (requestedTips > balance.availableTips) {\n        return res.status(400).json({ \n          message: `Cannot withdraw more tips than available. Available: ${balance.availableTips.toFixed(2)} AED` \n        });\n      }\n      \n      // Calculate amounts\n      const baseAmount = jobCount * balance.pricePerWash;\n      const vatAmount = baseAmount * 0.05; // 5% VAT on base amount only\n      const totalAmount = baseAmount + vatAmount + requestedTips; // Tips are VAT-exempt\n      \n      // Create withdrawal request\n      const withdrawal = await storage.createWithdrawal({\n        companyId,\n        amount: totalAmount.toFixed(2),\n        status: \"pending\",\n        invoiceUrl,\n        jobCountRequested: jobCount,\n        tipsRequested: requestedTips.toFixed(2),\n        baseAmount: baseAmount.toFixed(2),\n        vatAmount: vatAmount.toFixed(2),\n        note: `Withdrawal request: ${jobCount} jobs @ ${balance.pricePerWash.toFixed(2)} AED + ${vatAmount.toFixed(2)} VAT + ${requestedTips.toFixed(2)} tips`,\n      });\n      \n      res.json({ \n        success: true, \n        withdrawal,\n        breakdown: {\n          jobCount,\n          pricePerWash: balance.pricePerWash,\n          baseAmount,\n          vatAmount,\n          tipsAmount: requestedTips,\n          totalAmount,\n        }\n      });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Get company admin payment transactions\n  app.get(\"/api/company/financials/admin-payouts\", requireRole(UserRole.COMPANY_ADMIN), async (req: Request, res: Response) => {\n    try {\n      const user = req.user as any;\n      const companyId = user.companyId;\n      \n      if (!companyId) {\n        return res.status(400).json({ message: \"Company not found for user\" });\n      }\n      \n      const transactions = await storage.getCompanyTransactions(companyId);\n      const adminPayouts = transactions.filter(t => t.type === 'admin_payment');\n      res.json(adminPayouts);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Get all company transactions (for transaction history)\n  app.get(\"/api/company/financials/transactions\", requireRole(UserRole.COMPANY_ADMIN), async (req: Request, res: Response) => {\n    try {\n      res.setHeader('Cache-Control', 'no-store, must-revalidate');\n      const user = req.user as any;\n      const companyId = user.companyId;\n      \n      if (!companyId) {\n        return res.status(400).json({ message: \"Company not found for user\" });\n      }\n      \n      const transactions = await storage.getCompanyTransactions(companyId);\n      res.json(transactions);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Export financials to Excel\n  app.post(\"/api/company/financials/export\", requireRole(UserRole.COMPANY_ADMIN), async (req: Request, res: Response) => {\n    try {\n      const user = req.user as any;\n      const companyId = user.companyId;\n      \n      if (!companyId) {\n        return res.status(400).json({ message: \"Company not found for user\" });\n      }\n      \n      const { cleanerId, startDate, endDate } = req.body;\n      \n      const filters: any = {};\n      if (cleanerId) filters.cleanerId = parseInt(cleanerId);\n      if (startDate) filters.startDate = new Date(startDate);\n      if (endDate) filters.endDate = new Date(endDate);\n      \n      // Get all jobs (no pagination for Excel export)\n      const jobsResult = await storage.getCompanyFinancials(companyId, { ...filters, page: 1, pageSize: 10000 });\n      const jobs = jobsResult.data;\n      const summary = await storage.getCompanyFinancialSummary(companyId);\n      const company = await storage.getCompany(companyId);\n      \n      const workbook = new ExcelJS.Workbook();\n      const worksheet = workbook.addWorksheet('Financial Report');\n      \n      worksheet.columns = [\n        { header: 'Job ID', key: 'jobId', width: 10 },\n        { header: 'Status', key: 'status', width: 20 },\n        { header: 'Receipt Number', key: 'receiptNumber', width: 20 },\n        { header: 'Stripe Payment ID', key: 'stripePaymentId', width: 30 },\n        { header: 'Stripe Refund ID', key: 'stripeRefundId', width: 30 },\n        { header: 'Paid At', key: 'paidAt', width: 20 },\n        { header: 'Cleaner Name', key: 'cleanerName', width: 20 },\n        { header: 'Base Amount', key: 'baseAmount', width: 12 },\n        { header: 'Base Tax', key: 'baseTax', width: 12 },\n        { header: 'Total Tip', key: 'totalTip', width: 12 },\n        { header: 'Tip VAT', key: 'tipVat', width: 12 },\n        { header: 'Remaining Tip', key: 'remainingTip', width: 15 },\n        { header: 'Platform Fee', key: 'platformFee', width: 12 },\n        { header: 'Platform Tax', key: 'platformTax', width: 12 },\n        { header: 'Stripe Fee', key: 'stripeFee', width: 12 },\n        { header: 'Gross Amount', key: 'grossAmount', width: 15 },\n        { header: 'Net Amount', key: 'netAmount', width: 15 },\n      ];\n      \n      jobs.forEach(job => {\n        const isPackage2 = (job.feePackageType || 'custom').toLowerCase() === 'package2';\n        const tipAmount = parseFloat(job.tipAmount || \"0\");\n        const tipTax = parseFloat(job.tipTax || \"0\");\n        const totalTip = tipAmount + tipTax;\n        const remainingTip = parseFloat(job.remainingTip || \"0\");\n        \n        const jobStatus = (job as any).jobStatus;\n        const statusDisplay = jobStatus === 'refunded_unattended' ? 'Refunded (Unattended)' :\n                            jobStatus === 'refunded' ? 'Refunded (Manual)' :\n                            jobStatus?.toUpperCase() || 'N/A';\n        \n        worksheet.addRow({\n          jobId: job.jobId,\n          status: statusDisplay,\n          receiptNumber: (job as any).receiptNumber || '-',\n          stripePaymentId: (job as any).stripePaymentIntentId || '-',\n          stripeRefundId: (job as any).stripeRefundId || '-',\n          paidAt: new Date(job.paidAt).toLocaleString(),\n          cleanerName: job.cleanerName || 'N/A',\n          baseAmount: parseFloat(job.baseJobAmount || \"0\").toFixed(2),\n          baseTax: parseFloat(job.baseTax || \"0\").toFixed(2),\n          totalTip: totalTip > 0 ? totalTip.toFixed(2) : '-',\n          tipVat: totalTip > 0 ? tipTax.toFixed(2) : '-',\n          remainingTip: totalTip > 0 ? remainingTip.toFixed(2) : '-',\n          platformFee: parseFloat(job.platformFeeAmount || \"0\").toFixed(2),\n          platformTax: parseFloat(job.platformFeeTax || \"0\").toFixed(2),\n          stripeFee: isPackage2 ? parseFloat(job.paymentProcessingFeeAmount || \"0\").toFixed(2) : '-',\n          grossAmount: parseFloat(job.grossAmount || \"0\").toFixed(2),\n          netAmount: parseFloat(job.netPayableAmount || \"0\").toFixed(2),\n        });\n      });\n      \n      worksheet.addRow({});\n      worksheet.addRow({\n        jobId: 'TOTAL',\n        grossAmount: summary.totalRevenue.toFixed(2),\n        platformFee: summary.platformFees.toFixed(2),\n        processingFee: summary.paymentProcessingFees.toFixed(2),\n        netAmount: summary.netEarnings.toFixed(2),\n      });\n      \n      const totalRow = worksheet.lastRow;\n      if (totalRow) {\n        totalRow.font = { bold: true };\n      }\n      \n      res.setHeader('Content-Type', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');\n      res.setHeader('Content-Disposition', `attachment; filename=financials-${company?.name || 'company'}-${Date.now()}.xlsx`);\n      \n      await workbook.xlsx.write(res);\n      res.end();\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // ========== PUSH NOTIFICATION ROUTES ==========\n  \n  app.get(\"/api/push/vapid-public-key\", (_req, res) => {\n    res.json({ publicKey: process.env.VAPID_PUBLIC_KEY || '' });\n  });\n\n  app.post(\"/api/push/subscribe\", async (req, res) => {\n    try {\n      const { endpoint, keys, plateNumber, soundEnabled } = req.body;\n      \n      if (!endpoint || !keys || !keys.p256dh || !keys.auth) {\n        return res.status(400).json({ message: \"Invalid subscription data\" });\n      }\n\n      const userId = req.user?.id;\n      let customerId: number | undefined;\n\n      if (!userId && plateNumber) {\n        const jobs = await storage.getJobsByPlateNumber(plateNumber, 1, 1);\n        if (jobs.data.length > 0 && jobs.data[0].customerId) {\n          customerId = jobs.data[0].customerId;\n        } else {\n          return res.status(404).json({ message: \"No jobs found for this plate number\" });\n        }\n      } else if (!userId) {\n        return res.status(400).json({ message: \"Authentication or plate number required\" });\n      }\n\n      await storage.createPushSubscription({\n        userId: userId || undefined,\n        customerId: customerId || undefined,\n        endpoint,\n        keys,\n        soundEnabled: soundEnabled || 0,\n      });\n\n      res.json({ success: true });\n    } catch (error: any) {\n      console.error(\"Error subscribing to push notifications:\", error);\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.post(\"/api/push/unsubscribe\", async (req, res) => {\n    try {\n      const { endpoint } = req.body;\n      \n      if (!endpoint) {\n        return res.status(400).json({ message: \"Endpoint required\" });\n      }\n\n      await storage.deletePushSubscription(endpoint);\n\n      res.json({ success: true });\n    } catch (error: any) {\n      console.error(\"Error unsubscribing from push notifications:\", error);\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.get(\"/api/push/settings\", async (req, res) => {\n    try {\n      const { endpoint } = req.query;\n      \n      if (!endpoint) {\n        return res.status(400).json({ message: \"Endpoint required\" });\n      }\n\n      const subscription = await storage.getPushSubscriptionByEndpoint(endpoint as string);\n      \n      if (!subscription) {\n        return res.status(404).json({ message: \"Subscription not found\" });\n      }\n\n      res.json({ soundEnabled: subscription.soundEnabled || 0 });\n    } catch (error: any) {\n      console.error(\"Error fetching push notification settings:\", error);\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.post(\"/api/push/update-sound\", async (req, res) => {\n    try {\n      const { endpoint, soundEnabled } = req.body;\n      \n      if (!endpoint || soundEnabled === undefined) {\n        return res.status(400).json({ message: \"Endpoint and soundEnabled required\" });\n      }\n\n      await storage.updatePushSubscriptionSound(endpoint, soundEnabled);\n\n      res.json({ success: true });\n    } catch (error: any) {\n      console.error(\"Error updating push notification sound:\", error);\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // ===== EMAIL OTP ROUTES ===== \n  \n  // Rate limiting map for OTP requests (email -> last request timestamp)\n  const otpRateLimitMap = new Map<string, number>();\n  const OTP_RATE_LIMIT_MS = 60 * 1000; // 60 seconds between requests per email\n  \n  // Send OTP to email (for anonymous complaint submission)\n  app.post(\"/api/otp/send\", async (req: Request, res: Response) => {\n    try {\n      const { email } = req.body;\n      \n      if (!email) {\n        return res.status(400).json({ message: \"Email is required\" });\n      }\n      \n      // Validate email format\n      const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n      if (!emailRegex.test(email)) {\n        return res.status(400).json({ message: \"Invalid email format\" });\n      }\n      \n      // Rate limiting: Check if email requested OTP recently\n      const lastRequestTime = otpRateLimitMap.get(email.toLowerCase());\n      const now = Date.now();\n      if (lastRequestTime && (now - lastRequestTime) < OTP_RATE_LIMIT_MS) {\n        const remainingSeconds = Math.ceil((OTP_RATE_LIMIT_MS - (now - lastRequestTime)) / 1000);\n        return res.status(429).json({ \n          message: `Please wait ${remainingSeconds} seconds before requesting another code`,\n          remainingSeconds \n        });\n      }\n      \n      // Update rate limit timestamp\n      otpRateLimitMap.set(email.toLowerCase(), now);\n      \n      // Generate 6-digit OTP code\n      const code = Math.floor(100000 + Math.random() * 900000).toString();\n      \n      // OTP expires in 10 minutes\n      const expiresAt = new Date(Date.now() + 10 * 60 * 1000);\n      \n      // Save OTP to database (this also deletes any existing unverified OTPs)\n      await storage.createEmailOtp(email, code, expiresAt);\n      \n      // Send OTP email via Resend\n      await sendEmail(\n        email,\n        'Verify Your Email - Washapp.ae',\n        `\n          <h2>Email Verification Code</h2>\n          <p>Your verification code is: <strong style=\"font-size: 24px; color: #0ea5e9;\">${code}</strong></p>\n          <p>This code will expire in 10 minutes.</p>\n          <p>If you didn't request this code, please ignore this email.</p>\n        `\n      );\n      \n      res.json({ success: true, message: \"OTP sent to email\" });\n    } catch (error: any) {\n      console.error(\"Error sending OTP:\", error);\n      res.status(500).json({ message: \"Failed to send OTP\" });\n    }\n  });\n  \n  // Verify OTP code\n  app.post(\"/api/otp/verify\", async (req: Request, res: Response) => {\n    try {\n      const { email, code } = req.body;\n      \n      if (!email || !code) {\n        return res.status(400).json({ message: \"Email and code are required\" });\n      }\n      \n      // Check if unverified OTP exists and is valid\n      const isValid = await storage.checkEmailOtp(email, code);\n      \n      if (!isValid) {\n        return res.status(400).json({ message: \"Invalid or expired OTP code\" });\n      }\n      \n      // Mark OTP as verified\n      await storage.markEmailOtpAsVerified(email, code);\n      \n      // Check if this is a returning customer and fetch their phone number\n      const customer = await storage.getCustomerByEmail(email);\n      const phoneNumber = customer?.phoneNumber || null;\n      \n      res.json({ \n        success: true, \n        verified: true,\n        phoneNumber // Return phone number if customer exists (null for new users)\n      });\n    } catch (error: any) {\n      console.error(\"Error verifying OTP:\", error);\n      res.status(500).json({ message: \"Failed to verify OTP\" });\n    }\n  });\n\n  // ===== COMPLAINT ROUTES =====\n  \n  // Create complaint (Anonymous with Email OTP Verification)\n  app.post(\"/api/complaints\", async (req: Request, res: Response) => {\n    try {\n      const { jobId, type, description, email, otpCode } = req.body;\n      \n      // Validate inputs\n      if (!jobId || !type || !description || !email || !otpCode) {\n        return res.status(400).json({ message: \"Job ID, type, description, email, and OTP code are required\" });\n      }\n      \n      // Validate type\n      if (type !== 'refund_request' && type !== 'general') {\n        return res.status(400).json({ message: \"Invalid complaint type\" });\n      }\n      \n      // Verify that OTP has been verified AND marked as verified for this email\n      const isOtpVerified = await storage.isEmailOtpVerified(email, otpCode);\n      if (!isOtpVerified) {\n        return res.status(403).json({ message: \"Email not verified or OTP already used. Please verify your email again.\" });\n      }\n      \n      // Get job details\n      const job = await storage.getJob(jobId);\n      if (!job) {\n        return res.status(404).json({ message: \"Job not found\" });\n      }\n      \n      // Only allow complaints for completed, cancelled, or refunded jobs\n      if (job.status !== 'completed' && job.status !== 'cancelled' && job.status !== 'refunded') {\n        return res.status(400).json({ message: \"Can only create complaints for completed, cancelled, or refunded jobs\" });\n      }\n      \n      // Invalidate OTP immediately to prevent reuse\n      await storage.invalidateEmailOtp(email, otpCode);\n      \n      // Create complaint\n      const complaint = await storage.createComplaint({\n        jobId,\n        companyId: job.companyId,\n        customerId: job.customerId || null,\n        type,\n        description,\n        status: 'pending',\n        customerEmail: email, // Use the verified email\n        customerPhone: job.customerPhone,\n      });\n      \n      // Send email to company admin\n      try {\n        const company = await storage.getCompany(job.companyId);\n        if (company) {\n          const companyAdmin = await storage.getUser(company.adminId);\n          if (companyAdmin && companyAdmin.email) {\n            const typeLabel = type === 'refund_request' ? 'Refund Request' : 'General Complaint';\n            await sendEmail(\n              companyAdmin.email,\n              `New ${typeLabel} - Job #${job.id}`,\n              `\n                <h2>New Complaint Received</h2>\n                <p><strong>Reference:</strong> ${complaint.referenceNumber}</p>\n                <p><strong>Job ID:</strong> #${job.id}</p>\n                <p><strong>Type:</strong> ${typeLabel}</p>\n                <p><strong>Customer Phone:</strong> ${job.customerPhone}</p>\n                <p><strong>Description:</strong></p>\n                <p>${description}</p>\n                <p><em>Please review and respond to this complaint in your dashboard.</em></p>\n              `\n            );\n          }\n        }\n      } catch (emailError) {\n        console.error('Failed to send complaint notification email:', emailError);\n      }\n      \n      // Send confirmation email to customer (use verified OTP email)\n      if (email) {\n        try {\n          const typeLabel = type === 'refund_request' ? 'Refund Request' : 'Complaint';\n          await sendEmail(\n            email,\n            `${typeLabel} Received - Reference ${complaint.referenceNumber}`,\n            `\n              <h2>We've Received Your ${typeLabel}</h2>\n              <p>Dear Customer,</p>\n              <p>Thank you for contacting us. We've received your ${typeLabel.toLowerCase()} and will review it shortly.</p>\n              <p><strong>Reference Number:</strong> ${complaint.referenceNumber}</p>\n              <p><strong>Job ID:</strong> #${job.id}</p>\n              <p><strong>Car Plate:</strong> ${job.carPlateNumber}</p>\n              <p>You can use this reference number to track the status of your ${typeLabel.toLowerCase()}.</p>\n              <p>We appreciate your patience and will get back to you soon.</p>\n            `\n          );\n        } catch (emailError) {\n          console.error('Failed to send customer confirmation email:', emailError);\n        }\n      }\n      \n      res.json(complaint);\n    } catch (error: any) {\n      console.error(\"Error creating complaint:\", error);\n      res.status(500).json({ message: error.message });\n    }\n  });\n  \n  // Get single complaint\n  app.get(\"/api/complaints/:id\", async (req: Request, res: Response) => {\n    try {\n      const id = parseInt(req.params.id);\n      const complaint = await storage.getComplaint(id);\n      \n      if (!complaint) {\n        return res.status(404).json({ message: \"Complaint not found\" });\n      }\n      \n      res.json(complaint);\n    } catch (error: any) {\n      console.error(\"Error fetching complaint:\", error);\n      res.status(500).json({ message: error.message });\n    }\n  });\n  \n  // Get company complaints\n  app.get(\"/api/company/complaints\", requireAuth, requireRole(UserRole.COMPANY_ADMIN), async (req: Request, res: Response) => {\n    try {\n      const companyId = req.user!.companyId!;\n      const complaints = await storage.getCompanyComplaints(companyId);\n      \n      res.json(complaints);\n    } catch (error: any) {\n      console.error(\"Error fetching company complaints:\", error);\n      res.status(500).json({ message: error.message });\n    }\n  });\n  \n  // Get all complaints (Admin)\n  app.get(\"/api/admin/complaints\", requireAuth, requireRole(UserRole.ADMIN), async (req: Request, res: Response) => {\n    try {\n      const complaints = await storage.getAllComplaints();\n      res.json(complaints);\n    } catch (error: any) {\n      console.error(\"Error fetching complaints:\", error);\n      res.status(500).json({ message: error.message });\n    }\n  });\n  \n  // Update complaint status (Company Admin)\n  app.patch(\"/api/company/complaints/:id\", requireAuth, requireRole(UserRole.COMPANY_ADMIN), async (req: Request, res: Response) => {\n    try {\n      const id = parseInt(req.params.id);\n      const { status, resolution } = req.body;\n      \n      if (!status) {\n        return res.status(400).json({ message: \"Status is required\" });\n      }\n      \n      // Validate status\n      const validStatuses = ['pending', 'in_progress', 'resolved'];\n      if (!validStatuses.includes(status)) {\n        return res.status(400).json({ message: \"Invalid status\" });\n      }\n      \n      // Require resolution for resolved status\n      if (status === 'resolved' && !resolution) {\n        return res.status(400).json({ message: \"Resolution is required when marking as resolved\" });\n      }\n      \n      const complaint = await storage.getComplaint(id);\n      if (!complaint) {\n        return res.status(404).json({ message: \"Complaint not found\" });\n      }\n      \n      // Verify company owns this complaint\n      if (complaint.companyId !== req.user!.companyId) {\n        return res.status(403).json({ message: \"Unauthorized\" });\n      }\n      \n      // Don't allow status updates for refunded complaints\n      if (complaint.status === 'refunded') {\n        return res.status(400).json({ message: \"Cannot update status of refunded complaint\" });\n      }\n      \n      // Update complaint\n      await storage.updateComplaintStatus(id, status, req.user!.id, resolution);\n      \n      // Send resolution email if resolved\n      if (status === 'resolved' && complaint.customerEmail && resolution) {\n        try {\n          const job = await storage.getJob(complaint.jobId);\n          await sendEmail(\n            complaint.customerEmail,\n            `Complaint Resolved - ${complaint.referenceNumber}`,\n            `\n              <h2>Your Complaint Has Been Resolved</h2>\n              <p>Dear Customer,</p>\n              <p>We have reviewed and resolved your complaint.</p>\n              <p><strong>Reference:</strong> ${complaint.referenceNumber}</p>\n              <p><strong>Job ID:</strong> #${complaint.jobId}</p>\n              ${job ? `<p><strong>Car Plate:</strong> ${job.carPlateNumber}</p>` : ''}\n              <p><strong>Resolution:</strong></p>\n              <p>${resolution}</p>\n              <p>Thank you for your patience and for giving us the opportunity to resolve this matter.</p>\n            `\n          );\n        } catch (emailError) {\n          console.error('Failed to send resolution email:', emailError);\n        }\n      }\n      \n      res.json({ success: true });\n    } catch (error: any) {\n      console.error(\"Error updating complaint:\", error);\n      res.status(500).json({ message: error.message });\n    }\n  });\n  \n  // Trigger refund (Admin or Company Admin)\n  app.post(\"/api/complaints/:id/refund\", requireAuth, async (req: Request, res: Response) => {\n    try {\n      // Verify role is admin or company_admin\n      if (req.user!.role !== 'admin' && req.user!.role !== 'company_admin') {\n        return res.status(403).json({ message: \"Unauthorized\" });\n      }\n      \n      const id = parseInt(req.params.id);\n      const complaint = await storage.getComplaint(id);\n      \n      if (!complaint) {\n        return res.status(404).json({ message: \"Complaint not found\" });\n      }\n      \n      // Verify company admin owns this complaint (or user is platform admin)\n      if (req.user.role === 'company_admin' && complaint.companyId !== req.user.companyId) {\n        return res.status(403).json({ message: \"Unauthorized\" });\n      }\n      \n      // Get job\n      const job = await storage.getJob(complaint.jobId);\n      if (!job) {\n        return res.status(404).json({ message: \"Job not found\" });\n      }\n      \n      // Check if job can be refunded\n      if (job.status === 'refunded') {\n        return res.status(400).json({ message: \"Job already refunded\" });\n      }\n      \n      if (!job.stripePaymentIntentId) {\n        return res.status(400).json({ message: \"No payment intent found for this job\" });\n      }\n      \n      // Process Stripe refund\n      let refund;\n      try {\n        refund = await stripe.refunds.create({\n          payment_intent: job.stripePaymentIntentId,\n        });\n      } catch (stripeError: any) {\n        console.error('Stripe refund failed:', stripeError);\n        return res.status(500).json({ message: `Refund failed: ${stripeError.message}` });\n      }\n      \n      // Update job status\n      await storage.updateJob(job.id, {\n        status: 'refunded',\n        refundedAt: new Date(),\n        refundReason: `Complaint refund: ${complaint.description.substring(0, 200)}`,\n        stripeRefundId: refund.id,\n      });\n      \n      // Create refund transaction\n      await storage.createTransaction({\n        referenceNumber: `REF-${Date.now()}-${Math.floor(Math.random() * 10000)}`,\n        type: 'refund',\n        direction: 'debit',\n        jobId: job.id,\n        companyId: job.companyId,\n        amount: job.totalAmount,\n        currency: 'AED',\n        stripeRefundId: refund.id,\n        description: `Refund for complaint ${complaint.referenceNumber}`,\n      });\n      \n      // Update complaint\n      await storage.updateComplaintRefund(id, req.user.id, refund.id);\n      \n      // Send refund email to customer (use complaint email from verified OTP)\n      if (complaint.customerEmail) {\n        try {\n          await sendEmail(\n            complaint.customerEmail,\n            `Refund Processed - ${complaint.referenceNumber}`,\n            `\n              <h2>Your Refund Has Been Processed</h2>\n              <p>Dear Customer,</p>\n              <p>We have processed a full refund for your complaint.</p>\n              <p><strong>Complaint Reference:</strong> ${complaint.referenceNumber}</p>\n              <p><strong>Job ID:</strong> #${job.id}</p>\n              <p><strong>Car Plate:</strong> ${job.carPlateNumber}</p>\n              <p><strong>Refund Amount:</strong> ${Number(job.totalAmount).toFixed(2)} AED</p>\n              <p>The refund will appear in your account within 5-10 business days.</p>\n              <p>We apologize for any inconvenience and thank you for your understanding.</p>\n            `\n          );\n        } catch (emailError) {\n          console.error('Failed to send refund email:', emailError);\n        }\n      }\n      \n      res.json({ success: true, refundId: refund.id });\n    } catch (error: any) {\n      console.error(\"Error processing refund:\", error);\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  return createServer(app);\n}\n\n// Utility function for distance calculation\nfunction calculateDistance(lat1: number, lon1: number, lat2: number, lon2: number): number {\n  const R = 6371e3; // Earth's radius in meters\n  const φ1 = (lat1 * Math.PI) / 180;\n  const φ2 = (lat2 * Math.PI) / 180;\n  const Δφ = ((lat2 - lat1) * Math.PI) / 180;\n  const Δλ = ((lon2 - lon1) * Math.PI) / 180;\n\n  const a =\n    Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +\n    Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ / 2) * Math.sin(Δλ / 2);\n  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\n\n  return R * c; // Distance in meters\n}\n\n// Utility function to check if cleaner is active (on-duty and location updated within last 10 minutes)\nfunction isCleanerActive(cleaner: Cleaner): boolean {\n  if (cleaner.status !== CleanerStatus.ON_DUTY) return false;\n  if (!cleaner.lastLocationUpdate) return false;\n  \n  const tenMinutesAgo = new Date(Date.now() - 10 * 60 * 1000);\n  const lastUpdate = new Date(cleaner.lastLocationUpdate);\n  return lastUpdate >= tenMinutesAgo;\n}\n","path":null,"size_bytes":165044,"size_tokens":null},"shared/schema.ts":{"content":"import { pgTable, serial, varchar, text, numeric, timestamp, pgEnum, integer, jsonb } from \"drizzle-orm/pg-core\";\nimport { relations } from \"drizzle-orm\";\nimport { createInsertSchema, createSelectSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\n\n// PostgreSQL Enums\nexport const userRoleEnum = pgEnum(\"user_role\", [\"customer\", \"cleaner\", \"company_admin\", \"admin\"]);\nexport const jobStatusEnum = pgEnum(\"job_status\", [\"pending_payment\", \"paid\", \"assigned\", \"in_progress\", \"completed\", \"cancelled\", \"refunded\", \"refunded_unattended\"]);\nexport const cleanerStatusEnum = pgEnum(\"cleaner_status\", [\"on_duty\", \"off_duty\", \"busy\"]);\nexport const invitationStatusEnum = pgEnum(\"invitation_status\", [\"pending\", \"consumed\", \"revoked\"]);\nexport const paymentMethodEnum = pgEnum(\"payment_method\", [\"card\", \"cash\", \"bank_transfer\"]);\nexport const withdrawalStatusEnum = pgEnum(\"withdrawal_status\", [\"pending\", \"completed\", \"cancelled\"]);\nexport const transactionTypeEnum = pgEnum(\"transaction_type\", [\"customer_payment\", \"admin_payment\", \"refund\", \"withdrawal\"]);\nexport const transactionDirectionEnum = pgEnum(\"transaction_direction\", [\"credit\", \"debit\"]);\nexport const assignmentModeEnum = pgEnum(\"assignment_mode\", [\"pool\", \"direct\"]);\nexport const companyPackageTypeEnum = pgEnum(\"company_package_type\", [\"pay_per_wash\", \"subscription\"]);\nexport const feePackageTypeEnum = pgEnum(\"fee_package_type\", [\"custom\", \"package1\", \"package2\"]);\nexport const complaintTypeEnum = pgEnum(\"complaint_type\", [\"refund_request\", \"general\"]);\nexport const complaintStatusEnum = pgEnum(\"complaint_status\", [\"pending\", \"in_progress\", \"resolved\", \"refunded\"]);\nexport const offlineJobStatusEnum = pgEnum(\"offline_job_status\", [\"in_progress\", \"completed\"]);\n\n// Users Table\nexport const users = pgTable(\"users\", {\n  id: serial(\"id\").primaryKey(),\n  email: varchar(\"email\", { length: 255 }).notNull().unique(),\n  passwordHash: varchar(\"password_hash\", { length: 255 }).notNull(),\n  displayName: varchar(\"display_name\", { length: 255 }).notNull(),\n  role: userRoleEnum(\"role\").notNull(),\n  photoURL: text(\"photo_url\"),\n  phoneNumber: varchar(\"phone_number\", { length: 50 }),\n  companyId: integer(\"company_id\"),\n  soundEnabled: integer(\"sound_enabled\").notNull().default(1),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\nexport const usersRelations = relations(users, ({ one, many }) => ({\n  company: one(companies, {\n    fields: [users.companyId],\n    references: [companies.id],\n  }),\n  cleaner: one(cleaners, {\n    fields: [users.id],\n    references: [cleaners.userId],\n  }),\n}));\n\n// Customers Table (email-based profiles)\nexport const customers = pgTable(\"customers\", {\n  id: serial(\"id\").primaryKey(),\n  email: varchar(\"email\", { length: 255 }).notNull().unique(),\n  phoneNumber: varchar(\"phone_number\", { length: 50 }),\n  displayName: varchar(\"display_name\", { length: 255 }),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  lastLoginAt: timestamp(\"last_login_at\"),\n});\n\nexport const customersRelations = relations(customers, ({ many }) => ({\n  jobs: many(jobs),\n}));\n\n// Companies Table\nexport const companies = pgTable(\"companies\", {\n  id: serial(\"id\").primaryKey(),\n  name: varchar(\"name\", { length: 255 }).notNull(),\n  description: text(\"description\"),\n  pricePerWash: numeric(\"price_per_wash\", { precision: 10, scale: 2 }).notNull(),\n  platformFee: numeric(\"platform_fee\", { precision: 10, scale: 2 }).notNull().default(\"3.00\"),\n  feePackageType: feePackageTypeEnum(\"fee_package_type\").notNull().default(\"custom\"),\n  packageType: companyPackageTypeEnum(\"package_type\").notNull().default(\"pay_per_wash\"),\n  subscriptionCleanerSlots: integer(\"subscription_cleaner_slots\"),\n  adminId: integer(\"admin_id\").notNull(),\n  tradeLicenseNumber: varchar(\"trade_license_number\", { length: 100 }),\n  tradeLicenseDocumentURL: text(\"trade_license_document_url\"),\n  isActive: integer(\"is_active\").notNull().default(0),\n  totalJobsCompleted: integer(\"total_jobs_completed\").notNull().default(0),\n  totalRevenue: numeric(\"total_revenue\", { precision: 10, scale: 2 }).notNull().default(\"0\"),\n  rating: numeric(\"rating\", { precision: 3, scale: 2 }).notNull().default(\"0\"),\n  totalRatings: integer(\"total_ratings\").notNull().default(0),\n  geofenceArea: jsonb(\"geofence_area\").$type<Array<[number, number]>>(),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\nexport const companiesRelations = relations(companies, ({ one, many }) => ({\n  admin: one(users, {\n    fields: [companies.adminId],\n    references: [users.id],\n  }),\n  cleaners: many(cleaners),\n  jobs: many(jobs),\n  geofences: many(companyGeofences),\n  subscription: one(companySubscriptions, {\n    fields: [companies.id],\n    references: [companySubscriptions.companyId],\n  }),\n}));\n\n// Company Geofences Table\nexport const companyGeofences = pgTable(\"company_geofences\", {\n  id: serial(\"id\").primaryKey(),\n  companyId: integer(\"company_id\").notNull().references(() => companies.id, { onDelete: \"cascade\" }),\n  name: varchar(\"name\", { length: 255 }).notNull(),\n  polygon: jsonb(\"polygon\").$type<Array<[number, number]>>().notNull(),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\nexport const companyGeofencesRelations = relations(companyGeofences, ({ one }) => ({\n  company: one(companies, {\n    fields: [companyGeofences.companyId],\n    references: [companies.id],\n  }),\n}));\n\n// Company Subscriptions Table\nexport const companySubscriptions = pgTable(\"company_subscriptions\", {\n  id: serial(\"id\").primaryKey(),\n  companyId: integer(\"company_id\").notNull().unique().references(() => companies.id, { onDelete: \"cascade\" }),\n  cleanerSlots: integer(\"cleaner_slots\").notNull(),\n  monthlyFee: numeric(\"monthly_fee\", { precision: 10, scale: 2 }).notNull(),\n  billingCycleStart: timestamp(\"billing_cycle_start\").notNull(),\n  billingCycleEnd: timestamp(\"billing_cycle_end\").notNull(),\n  stripeSubscriptionId: varchar(\"stripe_subscription_id\", { length: 255 }),\n  status: varchar(\"status\", { length: 50 }).notNull().default(\"active\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\").notNull().defaultNow(),\n});\n\nexport const companySubscriptionsRelations = relations(companySubscriptions, ({ one }) => ({\n  company: one(companies, {\n    fields: [companySubscriptions.companyId],\n    references: [companies.id],\n  }),\n}));\n\n// Cleaners Table  \nexport const cleaners = pgTable(\"cleaners\", {\n  id: serial(\"id\").primaryKey(),\n  userId: integer(\"user_id\").notNull().unique(),\n  companyId: integer(\"company_id\").notNull(),\n  status: cleanerStatusEnum(\"status\").notNull().default(\"off_duty\"),\n  isActive: integer(\"is_active\").notNull().default(1),\n  currentLatitude: numeric(\"current_latitude\", { precision: 10, scale: 8 }),\n  currentLongitude: numeric(\"current_longitude\", { precision: 11, scale: 8 }),\n  lastLocationUpdate: timestamp(\"last_location_update\"),\n  totalJobsCompleted: integer(\"total_jobs_completed\").notNull().default(0),\n  averageCompletionTime: integer(\"average_completion_time\").notNull().default(0),\n  rating: numeric(\"rating\", { precision: 3, scale: 2 }).notNull().default(\"0\"),\n  totalRatings: integer(\"total_ratings\").notNull().default(0),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\nexport const cleanersRelations = relations(cleaners, ({ one, many }) => ({\n  user: one(users, {\n    fields: [cleaners.userId],\n    references: [users.id],\n  }),\n  company: one(companies, {\n    fields: [cleaners.companyId],\n    references: [companies.id],\n  }),\n  jobs: many(jobs),\n}));\n\n// Cleaner Invitations Table\nexport const cleanerInvitations = pgTable(\"cleaner_invitations\", {\n  id: serial(\"id\").primaryKey(),\n  companyId: integer(\"company_id\").notNull(),\n  phoneNumber: varchar(\"phone_number\", { length: 50 }).notNull().unique(),\n  status: invitationStatusEnum(\"status\").notNull().default(\"pending\"),\n  invitedBy: integer(\"invited_by\").notNull(),\n  invitedAt: timestamp(\"invited_at\").notNull().defaultNow(),\n  consumedAt: timestamp(\"consumed_at\"),\n});\n\nexport const cleanerInvitationsRelations = relations(cleanerInvitations, ({ one }) => ({\n  company: one(companies, {\n    fields: [cleanerInvitations.companyId],\n    references: [companies.id],\n  }),\n  inviter: one(users, {\n    fields: [cleanerInvitations.invitedBy],\n    references: [users.id],\n  }),\n}));\n\n// Cleaner Geofence Assignments Table\nexport const cleanerGeofenceAssignments = pgTable(\"cleaner_geofence_assignments\", {\n  id: serial(\"id\").primaryKey(),\n  companyId: integer(\"company_id\").notNull(),\n  geofenceId: integer(\"geofence_id\"),\n  cleanerId: integer(\"cleaner_id\"),\n  invitationId: integer(\"invitation_id\"),\n  assignAll: integer(\"assign_all\").notNull().default(0),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\nexport const cleanerGeofenceAssignmentsRelations = relations(cleanerGeofenceAssignments, ({ one }) => ({\n  company: one(companies, {\n    fields: [cleanerGeofenceAssignments.companyId],\n    references: [companies.id],\n  }),\n  geofence: one(companyGeofences, {\n    fields: [cleanerGeofenceAssignments.geofenceId],\n    references: [companyGeofences.id],\n  }),\n  cleaner: one(cleaners, {\n    fields: [cleanerGeofenceAssignments.cleanerId],\n    references: [cleaners.id],\n  }),\n  invitation: one(cleanerInvitations, {\n    fields: [cleanerGeofenceAssignments.invitationId],\n    references: [cleanerInvitations.id],\n  }),\n}));\n\n// Cleaner Shifts Table - Track shift start/end times\nexport const cleanerShifts = pgTable(\"cleaner_shifts\", {\n  id: serial(\"id\").primaryKey(),\n  cleanerId: integer(\"cleaner_id\").notNull().references(() => cleaners.id, { onDelete: \"cascade\" }),\n  companyId: integer(\"company_id\").notNull().references(() => companies.id, { onDelete: \"cascade\" }),\n  shiftStart: timestamp(\"shift_start\").notNull(),\n  shiftEnd: timestamp(\"shift_end\"),\n  durationMinutes: integer(\"duration_minutes\"),\n  startLatitude: numeric(\"start_latitude\", { precision: 10, scale: 8 }),\n  startLongitude: numeric(\"start_longitude\", { precision: 11, scale: 8 }),\n  endLatitude: numeric(\"end_latitude\", { precision: 10, scale: 8 }),\n  endLongitude: numeric(\"end_longitude\", { precision: 11, scale: 8 }),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\nexport const cleanerShiftsRelations = relations(cleanerShifts, ({ one }) => ({\n  cleaner: one(cleaners, {\n    fields: [cleanerShifts.cleanerId],\n    references: [cleaners.id],\n  }),\n  company: one(companies, {\n    fields: [cleanerShifts.companyId],\n    references: [companies.id],\n  }),\n}));\n\n// Cleaner Payment Tokens Table - For QR code payment links\nexport const cleanerPaymentTokens = pgTable(\"cleaner_payment_tokens\", {\n  id: serial(\"id\").primaryKey(),\n  cleanerId: integer(\"cleaner_id\").notNull().references(() => cleaners.id, { onDelete: \"cascade\" }),\n  companyId: integer(\"company_id\").notNull().references(() => companies.id, { onDelete: \"cascade\" }),\n  token: varchar(\"token\", { length: 255 }).notNull().unique(),\n  isUsed: integer(\"is_used\").notNull().default(0),\n  usedAt: timestamp(\"used_at\"),\n  expiresAt: timestamp(\"expires_at\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\nexport const cleanerPaymentTokensRelations = relations(cleanerPaymentTokens, ({ one }) => ({\n  cleaner: one(cleaners, {\n    fields: [cleanerPaymentTokens.cleanerId],\n    references: [cleaners.id],\n  }),\n  company: one(companies, {\n    fields: [cleanerPaymentTokens.companyId],\n    references: [companies.id],\n  }),\n}));\n\n// Offline Jobs Table - For manually entered jobs with offline payment\nexport const offlineJobs = pgTable(\"offline_jobs\", {\n  id: serial(\"id\").primaryKey(),\n  cleanerId: integer(\"cleaner_id\").notNull().references(() => cleaners.id, { onDelete: \"cascade\" }),\n  companyId: integer(\"company_id\").notNull().references(() => companies.id, { onDelete: \"cascade\" }),\n  carPlateNumber: varchar(\"car_plate_number\", { length: 50 }).notNull(),\n  carPlateEmirate: varchar(\"car_plate_emirate\", { length: 50 }),\n  carPlateCode: varchar(\"car_plate_code\", { length: 10 }),\n  servicePrice: numeric(\"service_price\", { precision: 10, scale: 2 }).notNull(),\n  vatAmount: numeric(\"vat_amount\", { precision: 10, scale: 2 }).notNull(),\n  totalAmount: numeric(\"total_amount\", { precision: 10, scale: 2 }).notNull(),\n  notes: text(\"notes\"),\n  status: offlineJobStatusEnum(\"status\").notNull().default(\"in_progress\"),\n  completionPhotoUrl: text(\"completion_photo_url\"),\n  completedAt: timestamp(\"completed_at\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\nexport const offlineJobsRelations = relations(offlineJobs, ({ one }) => ({\n  cleaner: one(cleaners, {\n    fields: [offlineJobs.cleanerId],\n    references: [cleaners.id],\n  }),\n  company: one(companies, {\n    fields: [offlineJobs.companyId],\n    references: [companies.id],\n  }),\n}));\n\n// Jobs Table\nexport const jobs = pgTable(\"jobs\", {\n  id: serial(\"id\").primaryKey(),\n  customerId: integer(\"customer_id\"),\n  companyId: integer(\"company_id\").notNull(),\n  cleanerId: integer(\"cleaner_id\"),\n  \n  // Car and location details\n  carPlateNumber: varchar(\"car_plate_number\", { length: 50 }).notNull(),\n  carPlateEmirate: varchar(\"car_plate_emirate\", { length: 50 }),\n  carPlateCode: varchar(\"car_plate_code\", { length: 10 }),\n  locationAddress: text(\"location_address\").notNull(),\n  locationLatitude: numeric(\"location_latitude\", { precision: 10, scale: 8 }).notNull(),\n  locationLongitude: numeric(\"location_longitude\", { precision: 11, scale: 8 }).notNull(),\n  parkingNumber: varchar(\"parking_number\", { length: 50 }),\n  customerEmail: varchar(\"customer_email\", { length: 255 }).notNull(),\n  customerPhone: varchar(\"customer_phone\", { length: 50 }),\n  \n  // Payment and pricing\n  price: numeric(\"price\", { precision: 10, scale: 2 }).notNull(),\n  taxAmount: numeric(\"tax_amount\", { precision: 10, scale: 2 }).notNull().default(\"0\"),\n  tipAmount: numeric(\"tip_amount\", { precision: 10, scale: 2 }).notNull().default(\"0\"),\n  totalAmount: numeric(\"total_amount\", { precision: 10, scale: 2 }).notNull(),\n  stripePaymentIntentId: varchar(\"stripe_payment_intent_id\", { length: 255 }),\n  stripeRefundId: varchar(\"stripe_refund_id\", { length: 255 }),\n  paymentMethod: paymentMethodEnum(\"payment_method\").default(\"card\"),\n  refundedAt: timestamp(\"refunded_at\"),\n  refundReason: text(\"refund_reason\"),\n  receiptNumber: varchar(\"receipt_number\", { length: 50 }).unique(),\n  receiptGeneratedAt: timestamp(\"receipt_generated_at\"),\n  \n  // Job status and timing\n  status: jobStatusEnum(\"status\").notNull().default(\"pending_payment\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  assignedAt: timestamp(\"assigned_at\"),\n  acceptedAt: timestamp(\"accepted_at\"),\n  startedAt: timestamp(\"started_at\"),\n  completedAt: timestamp(\"completed_at\"),\n  estimatedStartTime: timestamp(\"estimated_start_time\"),\n  estimatedFinishTime: timestamp(\"estimated_finish_time\"),\n  \n  // Completion proof\n  proofPhotoURL: text(\"proof_photo_url\"),\n  \n  // Rating and review\n  rating: numeric(\"rating\", { precision: 3, scale: 2 }),\n  review: text(\"review\"),\n  ratingRequestedAt: timestamp(\"rating_requested_at\"),\n  ratedAt: timestamp(\"rated_at\"),\n  \n  // Direct assignment\n  requestedCleanerEmail: varchar(\"requested_cleaner_email\", { length: 255 }),\n  assignmentMode: assignmentModeEnum(\"assignment_mode\").notNull().default(\"pool\"),\n  directAssignmentAt: timestamp(\"direct_assignment_at\"),\n});\n\nexport const jobsRelations = relations(jobs, ({ one }) => ({\n  company: one(companies, {\n    fields: [jobs.companyId],\n    references: [companies.id],\n  }),\n  cleaner: one(cleaners, {\n    fields: [jobs.cleanerId],\n    references: [cleaners.id],\n  }),\n  customer: one(customers, {\n    fields: [jobs.customerId],\n    references: [customers.id],\n  }),\n}));\n\n// Shift Sessions Table (track cleaner work sessions)\nexport const shiftSessions = pgTable(\"shift_sessions\", {\n  id: serial(\"id\").primaryKey(),\n  cleanerId: integer(\"cleaner_id\").notNull(),\n  startedAt: timestamp(\"started_at\").notNull().defaultNow(),\n  endedAt: timestamp(\"ended_at\"),\n  durationMinutes: integer(\"duration_minutes\"),\n});\n\nexport const shiftSessionsRelations = relations(shiftSessions, ({ one }) => ({\n  cleaner: one(cleaners, {\n    fields: [shiftSessions.cleanerId],\n    references: [cleaners.id],\n  }),\n}));\n\n// Device Tokens Table (for push notifications)\nexport const deviceTokens = pgTable(\"device_tokens\", {\n  id: serial(\"id\").primaryKey(),\n  userId: integer(\"user_id\").notNull(),\n  token: text(\"token\").notNull().unique(),\n  platform: varchar(\"platform\", { length: 50 }).notNull(), // 'web', 'ios', 'android'\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  lastUsedAt: timestamp(\"last_used_at\").notNull().defaultNow(),\n});\n\nexport const deviceTokensRelations = relations(deviceTokens, ({ one }) => ({\n  user: one(users, {\n    fields: [deviceTokens.userId],\n    references: [users.id],\n  }),\n}));\n\n// Push Subscriptions Table (Web Push Notifications)\nexport const pushSubscriptions = pgTable(\"push_subscriptions\", {\n  id: serial(\"id\").primaryKey(),\n  userId: integer(\"user_id\"), // For authenticated users (cleaners, company admins, platform admins)\n  customerId: integer(\"customer_id\"), // For anonymous customers\n  endpoint: text(\"endpoint\").notNull().unique(),\n  keys: jsonb(\"keys\").$type<{ p256dh: string; auth: string }>().notNull(),\n  soundEnabled: integer(\"sound_enabled\").notNull().default(0), // 0 = off, 1 = on\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\nexport const pushSubscriptionsRelations = relations(pushSubscriptions, ({ one }) => ({\n  user: one(users, {\n    fields: [pushSubscriptions.userId],\n    references: [users.id],\n  }),\n  customer: one(customers, {\n    fields: [pushSubscriptions.customerId],\n    references: [customers.id],\n  }),\n}));\n\n// Platform Settings Table (company details for receipts)\nexport const platformSettings = pgTable(\"platform_settings\", {\n  id: serial(\"id\").primaryKey(),\n  companyName: varchar(\"company_name\", { length: 255 }).notNull().default(\"Washapp.ae\"),\n  companyAddress: text(\"company_address\").notNull().default(\"Dubai, United Arab Emirates\"),\n  vatRegistrationNumber: varchar(\"vat_registration_number\", { length: 100 }).notNull().default(\"\"),\n  logoUrl: text(\"logo_url\"),\n  updatedAt: timestamp(\"updated_at\").notNull().defaultNow(),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\n// Fee Settings Table (platform and payment processing fees)\nexport const feeSettings = pgTable(\"fee_settings\", {\n  id: serial(\"id\").primaryKey(),\n  platformFeeRate: numeric(\"platform_fee_rate\", { precision: 5, scale: 4 }).notNull().default(\"0.10\"), // 10% default\n  stripePercentRate: numeric(\"stripe_percent_rate\", { precision: 5, scale: 4 }).notNull().default(\"0.029\"), // 2.9%\n  stripeFixedFee: numeric(\"stripe_fixed_fee\", { precision: 10, scale: 2 }).notNull().default(\"0.30\"), // $0.30\n  currency: varchar(\"currency\", { length: 3 }).notNull().default(\"AED\"),\n  effectiveFrom: timestamp(\"effective_from\").notNull().defaultNow(),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\n// Job Financials Table (immutable financial records per job)\nexport const jobFinancials = pgTable(\"job_financials\", {\n  id: serial(\"id\").primaryKey(),\n  jobId: integer(\"job_id\").notNull().unique(),\n  companyId: integer(\"company_id\").notNull(),\n  cleanerId: integer(\"cleaner_id\"),\n  \n  // Financial breakdown\n  baseJobAmount: numeric(\"base_job_amount\", { precision: 10, scale: 2 }).notNull(),\n  baseTax: numeric(\"base_tax\", { precision: 10, scale: 2 }).notNull().default(\"0\"),\n  tipAmount: numeric(\"tip_amount\", { precision: 10, scale: 2 }).notNull().default(\"0\"),\n  tipTax: numeric(\"tip_tax\", { precision: 10, scale: 2 }).notNull().default(\"0\"),\n  platformFeeAmount: numeric(\"platform_fee_amount\", { precision: 10, scale: 2 }).notNull(),\n  platformFeeTax: numeric(\"platform_fee_tax\", { precision: 10, scale: 2 }).notNull().default(\"0\"),\n  paymentProcessingFeeAmount: numeric(\"payment_processing_fee_amount\", { precision: 10, scale: 2 }).notNull(),\n  companyStripeFeeShare: numeric(\"company_stripe_fee_share\", { precision: 10, scale: 2 }).notNull().default(\"0\"),\n  cleanerStripeFeeShare: numeric(\"cleaner_stripe_fee_share\", { precision: 10, scale: 2 }).notNull().default(\"0\"),\n  remainingTip: numeric(\"remaining_tip\", { precision: 10, scale: 2 }).notNull().default(\"0\"),\n  grossAmount: numeric(\"gross_amount\", { precision: 10, scale: 2 }).notNull(),\n  netPayableAmount: numeric(\"net_payable_amount\", { precision: 10, scale: 2 }).notNull(),\n  \n  // Legacy fields (kept for backwards compatibility)\n  taxAmount: numeric(\"tax_amount\", { precision: 10, scale: 2 }).notNull().default(\"0\"),\n  platformRevenue: numeric(\"platform_revenue\", { precision: 10, scale: 2 }).notNull().default(\"0\"),\n  \n  currency: varchar(\"currency\", { length: 3 }).notNull().default(\"AED\"),\n  paidAt: timestamp(\"paid_at\").notNull(),\n  refundedAt: timestamp(\"refunded_at\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\nexport const jobFinancialsRelations = relations(jobFinancials, ({ one }) => ({\n  job: one(jobs, {\n    fields: [jobFinancials.jobId],\n    references: [jobs.id],\n  }),\n  company: one(companies, {\n    fields: [jobFinancials.companyId],\n    references: [companies.id],\n  }),\n  cleaner: one(cleaners, {\n    fields: [jobFinancials.cleanerId],\n    references: [cleaners.id],\n  }),\n}));\n\n// Company Withdrawals Table (track payouts to companies)\nexport const companyWithdrawals = pgTable(\"company_withdrawals\", {\n  id: serial(\"id\").primaryKey(),\n  companyId: integer(\"company_id\").notNull(),\n  amount: numeric(\"amount\", { precision: 10, scale: 2 }).notNull(),\n  status: withdrawalStatusEnum(\"status\").notNull().default(\"pending\"),\n  referenceNumber: varchar(\"reference_number\", { length: 255 }), // Bank transfer reference\n  note: text(\"note\"),\n  \n  // Enhanced withdrawal tracking\n  invoiceUrl: text(\"invoice_url\"), // Uploaded invoice document\n  jobCountRequested: integer(\"job_count_requested\"), // Number of jobs being withdrawn\n  tipsRequested: numeric(\"tips_requested\", { precision: 10, scale: 2 }).default(\"0\"), // Tips amount being withdrawn\n  baseAmount: numeric(\"base_amount\", { precision: 10, scale: 2 }), // Jobs × price per wash\n  vatAmount: numeric(\"vat_amount\", { precision: 10, scale: 2 }), // VAT on base amount (5%)\n  \n  processedAt: timestamp(\"processed_at\"),\n  processedBy: integer(\"processed_by\"), // Admin user ID who processed\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\").notNull().defaultNow(),\n});\n\nexport const companyWithdrawalsRelations = relations(companyWithdrawals, ({ one }) => ({\n  company: one(companies, {\n    fields: [companyWithdrawals.companyId],\n    references: [companies.id],\n  }),\n  processor: one(users, {\n    fields: [companyWithdrawals.processedBy],\n    references: [users.id],\n  }),\n}));\n\n// Transactions Table (unified ledger for all financial transactions)\nexport const transactions = pgTable(\"transactions\", {\n  id: serial(\"id\").primaryKey(),\n  referenceNumber: varchar(\"reference_number\", { length: 100 }).notNull().unique(), // Unique transaction reference\n  type: transactionTypeEnum(\"type\").notNull(),\n  direction: transactionDirectionEnum(\"direction\").notNull().default('debit'),\n  \n  // Related entities\n  jobId: integer(\"job_id\"),\n  companyId: integer(\"company_id\"),\n  withdrawalId: integer(\"withdrawal_id\"),\n  \n  // Financial details\n  amount: numeric(\"amount\", { precision: 10, scale: 2 }).notNull(),\n  currency: varchar(\"currency\", { length: 3 }).notNull().default(\"AED\"),\n  \n  // External references\n  stripePaymentIntentId: varchar(\"stripe_payment_intent_id\", { length: 255 }),\n  stripeRefundId: varchar(\"stripe_refund_id\", { length: 255 }),\n  \n  // Metadata\n  description: text(\"description\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\nexport const transactionsRelations = relations(transactions, ({ one }) => ({\n  job: one(jobs, {\n    fields: [transactions.jobId],\n    references: [jobs.id],\n  }),\n  company: one(companies, {\n    fields: [transactions.companyId],\n    references: [companies.id],\n  }),\n  withdrawal: one(companyWithdrawals, {\n    fields: [transactions.withdrawalId],\n    references: [companyWithdrawals.id],\n  }),\n}));\n\n// Complaints Table\nexport const complaints = pgTable(\"complaints\", {\n  id: serial(\"id\").primaryKey(),\n  referenceNumber: varchar(\"reference_number\", { length: 100 }).notNull().unique(),\n  \n  // Related entities\n  jobId: integer(\"job_id\").notNull(),\n  companyId: integer(\"company_id\").notNull(),\n  customerId: integer(\"customer_id\"),\n  \n  // Complaint details\n  type: complaintTypeEnum(\"type\").notNull(),\n  description: text(\"description\").notNull(),\n  status: complaintStatusEnum(\"status\").notNull().default(\"pending\"),\n  \n  // Resolution\n  resolution: text(\"resolution\"),\n  resolvedAt: timestamp(\"resolved_at\"),\n  resolvedBy: integer(\"resolved_by\"), // Admin or company admin user ID\n  \n  // Refund tracking\n  refundedAt: timestamp(\"refunded_at\"),\n  refundedBy: integer(\"refunded_by\"), // Admin or company admin user ID\n  stripeRefundId: varchar(\"stripe_refund_id\", { length: 255 }),\n  \n  // Contact info (copied from job for reference)\n  customerEmail: varchar(\"customer_email\", { length: 255 }),\n  customerPhone: varchar(\"customer_phone\", { length: 50 }),\n  \n  // Timestamps\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\").notNull().defaultNow(),\n});\n\nexport const complaintsRelations = relations(complaints, ({ one }) => ({\n  job: one(jobs, {\n    fields: [complaints.jobId],\n    references: [jobs.id],\n  }),\n  company: one(companies, {\n    fields: [complaints.companyId],\n    references: [companies.id],\n  }),\n  customer: one(customers, {\n    fields: [complaints.customerId],\n    references: [customers.id],\n  }),\n  resolver: one(users, {\n    fields: [complaints.resolvedBy],\n    references: [users.id],\n  }),\n  refunder: one(users, {\n    fields: [complaints.refundedBy],\n    references: [users.id],\n  }),\n}));\n\n// Drizzle Zod Schemas for validation\nexport const insertUserSchema = createInsertSchema(users).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const selectUserSchema = createSelectSchema(users);\n\nexport const insertCompanySchema = createInsertSchema(companies).omit({\n  id: true,\n  createdAt: true,\n  totalJobsCompleted: true,\n  totalRevenue: true,\n  rating: true,\n  totalRatings: true,\n});\n\nexport const selectCompanySchema = createSelectSchema(companies);\n\nexport const insertCleanerSchema = createInsertSchema(cleaners).omit({\n  id: true,\n  createdAt: true,\n  totalJobsCompleted: true,\n  averageCompletionTime: true,\n  rating: true,\n  totalRatings: true,\n});\n\nexport const selectCleanerSchema = createSelectSchema(cleaners);\n\nexport const insertJobSchema = createInsertSchema(jobs).omit({\n  id: true,\n  createdAt: true,\n  assignedAt: true,\n  startedAt: true,\n  completedAt: true,\n});\n\nexport const selectJobSchema = createSelectSchema(jobs);\n\nexport const insertCleanerInvitationSchema = createInsertSchema(cleanerInvitations).omit({\n  id: true,\n  invitedAt: true,\n  consumedAt: true,\n});\n\nexport const selectCleanerInvitationSchema = createSelectSchema(cleanerInvitations);\n\nexport const insertCompanyGeofenceSchema = createInsertSchema(companyGeofences).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const selectCompanyGeofenceSchema = createSelectSchema(companyGeofences);\n\nexport const insertCompanySubscriptionSchema = createInsertSchema(companySubscriptions).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const selectCompanySubscriptionSchema = createSelectSchema(companySubscriptions);\n\nexport const insertCleanerGeofenceAssignmentSchema = createInsertSchema(cleanerGeofenceAssignments).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const selectCleanerGeofenceAssignmentSchema = createSelectSchema(cleanerGeofenceAssignments);\n\nexport const insertCleanerShiftSchema = createInsertSchema(cleanerShifts).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const selectCleanerShiftSchema = createSelectSchema(cleanerShifts);\n\nexport const insertCleanerPaymentTokenSchema = createInsertSchema(cleanerPaymentTokens).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const selectCleanerPaymentTokenSchema = createSelectSchema(cleanerPaymentTokens);\n\nexport const insertOfflineJobSchema = createInsertSchema(offlineJobs).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const selectOfflineJobSchema = createSelectSchema(offlineJobs);\n\n// TypeScript Types\nexport type User = typeof users.$inferSelect;\nexport type InsertUser = z.infer<typeof insertUserSchema>;\n\nexport type Company = typeof companies.$inferSelect;\nexport type InsertCompany = z.infer<typeof insertCompanySchema>;\n\nexport type Cleaner = typeof cleaners.$inferSelect;\nexport type InsertCleaner = z.infer<typeof insertCleanerSchema>;\n\nexport type Job = typeof jobs.$inferSelect;\nexport type InsertJob = z.infer<typeof insertJobSchema>;\n\nexport type CleanerInvitation = typeof cleanerInvitations.$inferSelect;\nexport type InsertCleanerInvitation = z.infer<typeof insertCleanerInvitationSchema>;\n\nexport type CompanyGeofence = typeof companyGeofences.$inferSelect;\nexport type InsertCompanyGeofence = z.infer<typeof insertCompanyGeofenceSchema>;\n\nexport type CompanySubscription = typeof companySubscriptions.$inferSelect;\nexport type InsertCompanySubscription = z.infer<typeof insertCompanySubscriptionSchema>;\n\nexport type CleanerGeofenceAssignment = typeof cleanerGeofenceAssignments.$inferSelect;\nexport type InsertCleanerGeofenceAssignment = z.infer<typeof insertCleanerGeofenceAssignmentSchema>;\n\nexport type CleanerShift = typeof cleanerShifts.$inferSelect;\nexport type InsertCleanerShift = z.infer<typeof insertCleanerShiftSchema>;\nexport type CleanerPaymentToken = typeof cleanerPaymentTokens.$inferSelect;\nexport type InsertCleanerPaymentToken = z.infer<typeof insertCleanerPaymentTokenSchema>;\n\nexport type OfflineJob = typeof offlineJobs.$inferSelect;\nexport type InsertOfflineJob = z.infer<typeof insertOfflineJobSchema>;\n\nexport const insertCustomerSchema = createInsertSchema(customers).omit({\n  id: true,\n  createdAt: true,\n  lastLoginAt: true,\n});\n\nexport const selectCustomerSchema = createSelectSchema(customers);\n\nexport type Customer = typeof customers.$inferSelect;\nexport type InsertCustomer = z.infer<typeof insertCustomerSchema>;\n\nexport const insertShiftSessionSchema = createInsertSchema(shiftSessions).omit({\n  id: true,\n  startedAt: true,\n  endedAt: true,\n  durationMinutes: true,\n});\n\nexport const selectShiftSessionSchema = createSelectSchema(shiftSessions);\n\nexport type ShiftSession = typeof shiftSessions.$inferSelect;\nexport type InsertShiftSession = z.infer<typeof insertShiftSessionSchema>;\n\nexport const insertDeviceTokenSchema = createInsertSchema(deviceTokens).omit({\n  id: true,\n  createdAt: true,\n  lastUsedAt: true,\n});\n\nexport const selectDeviceTokenSchema = createSelectSchema(deviceTokens);\n\nexport type DeviceToken = typeof deviceTokens.$inferSelect;\nexport type InsertDeviceToken = z.infer<typeof insertDeviceTokenSchema>;\n\nexport const insertPushSubscriptionSchema = createInsertSchema(pushSubscriptions).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const selectPushSubscriptionSchema = createSelectSchema(pushSubscriptions);\n\nexport type PushSubscription = typeof pushSubscriptions.$inferSelect;\nexport type InsertPushSubscription = z.infer<typeof insertPushSubscriptionSchema>;\n\nexport const insertPlatformSettingsSchema = createInsertSchema(platformSettings).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const selectPlatformSettingsSchema = createSelectSchema(platformSettings);\n\nexport type PlatformSetting = typeof platformSettings.$inferSelect;\nexport type InsertPlatformSetting = z.infer<typeof insertPlatformSettingsSchema>;\n\nexport const insertFeeSettingsSchema = createInsertSchema(feeSettings).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const selectFeeSettingsSchema = createSelectSchema(feeSettings);\n\nexport type FeeSetting = typeof feeSettings.$inferSelect;\nexport type InsertFeeSetting = z.infer<typeof insertFeeSettingsSchema>;\n\nexport const insertJobFinancialsSchema = createInsertSchema(jobFinancials).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const selectJobFinancialsSchema = createSelectSchema(jobFinancials);\n\nexport type JobFinancials = typeof jobFinancials.$inferSelect;\nexport type InsertJobFinancials = z.infer<typeof insertJobFinancialsSchema>;\n\nexport const insertCompanyWithdrawalSchema = createInsertSchema(companyWithdrawals).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const selectCompanyWithdrawalSchema = createSelectSchema(companyWithdrawals);\n\nexport type CompanyWithdrawal = typeof companyWithdrawals.$inferSelect;\nexport type InsertCompanyWithdrawal = z.infer<typeof insertCompanyWithdrawalSchema>;\n\nexport const insertTransactionSchema = createInsertSchema(transactions).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const selectTransactionSchema = createSelectSchema(transactions);\n\nexport type Transaction = typeof transactions.$inferSelect;\nexport type InsertTransaction = z.infer<typeof insertTransactionSchema>;\n\nexport const insertComplaintSchema = createInsertSchema(complaints).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n  referenceNumber: true,\n  resolvedAt: true,\n  refundedAt: true,\n});\n\nexport const selectComplaintSchema = createSelectSchema(complaints);\n\nexport type Complaint = typeof complaints.$inferSelect;\nexport type InsertComplaint = z.infer<typeof insertComplaintSchema>;\n\n// Additional validation schemas\nexport const createJobSchema = z.object({\n  carPlateNumber: z.string().min(1, \"Plate number is required\"),\n  carPlateEmirate: z.string().optional(),\n  carPlateCode: z.string().optional(),\n  locationAddress: z.string().min(1, \"Location is required\"),\n  locationLatitude: z.number(),\n  locationLongitude: z.number(),\n  parkingNumber: z.string().optional(),\n  customerPhone: z.string().min(10, \"Valid phone number required\"),\n  customerEmail: z.string().email(\"Valid email required\").optional(),\n  companyId: z.number(),\n});\n\nexport type CreateJob = z.infer<typeof createJobSchema>;\n\n// Analytics Types\nexport const adminAnalyticsSchema = z.object({\n  totalCompanies: z.number(),\n  totalCleaners: z.number(),\n  activeJobs: z.number(),\n  completedJobs: z.number(),\n  totalRevenue: z.number(),\n  totalNetRevenue: z.number(),\n  revenueThisMonth: z.number(),\n  netRevenueThisMonth: z.number(),\n});\n\nexport const companyAnalyticsSchema = z.object({\n  totalJobsCompleted: z.number(),\n  totalRevenue: z.number(),\n  totalNetEarnings: z.number(),\n  averageRating: z.number(),\n  activeCleaners: z.number(),\n  jobsThisMonth: z.number(),\n  revenueThisMonth: z.number(),\n  netEarningsThisMonth: z.number(),\n  shiftRoster: z.array(z.object({\n    cleanerId: z.number(),\n    cleanerName: z.string(),\n    status: z.string(),\n    totalJobsCompleted: z.number(),\n    rating: z.number(),\n    activeShift: z.object({\n      startedAt: z.date(),\n      duration: z.number(),\n    }).nullable(),\n  })).optional(),\n});\n\nexport const cleanerAnalyticsSchema = z.object({\n  totalJobsCompleted: z.number(),\n  averageCompletionTime: z.number(),\n  rating: z.number(),\n  totalRatings: z.number(),\n  earningsThisMonth: z.number(),\n});\n\nexport type AdminAnalytics = z.infer<typeof adminAnalyticsSchema>;\nexport type CompanyAnalytics = z.infer<typeof companyAnalyticsSchema>;\nexport type CleanerAnalytics = z.infer<typeof cleanerAnalyticsSchema>;\n\n// Company with cleaner count (for customer selection)\nexport const companyWithCleanersSchema = selectCompanySchema.extend({\n  onDutyCleanersCount: z.number(),\n  distanceInMeters: z.number().optional(),\n});\n\nexport type CompanyWithCleaners = z.infer<typeof companyWithCleanersSchema>;\n\n// Job Financials with Cleaner Details (for company analytics)\nexport const jobFinancialsWithCleanerSchema = selectJobFinancialsSchema.extend({\n  cleanerName: z.string().nullable(),\n  cleanerEmail: z.string().nullable(),\n  cleanerPhone: z.string().nullable(),\n  feePackageType: z.enum(['custom', 'package1', 'package2']).nullable(),\n});\n\nexport type JobFinancialsWithCleaner = z.infer<typeof jobFinancialsWithCleanerSchema>;\n\n// Enums for TypeScript\nexport enum UserRole {\n  CUSTOMER = \"customer\",\n  CLEANER = \"cleaner\",\n  COMPANY_ADMIN = \"company_admin\",\n  ADMIN = \"admin\"\n}\n\nexport enum JobStatus {\n  PENDING_PAYMENT = \"pending_payment\",\n  PAID = \"paid\",\n  ASSIGNED = \"assigned\",\n  IN_PROGRESS = \"in_progress\",\n  COMPLETED = \"completed\",\n  CANCELLED = \"cancelled\",\n  REFUNDED = \"refunded\"\n}\n\nexport enum OfflineJobStatus {\n  IN_PROGRESS = \"in_progress\",\n  COMPLETED = \"completed\"\n}\n\nexport enum CleanerStatus {\n  ON_DUTY = \"on_duty\",\n  OFF_DUTY = \"off_duty\",\n  BUSY = \"busy\"\n}\n\nexport enum CompanyPackageType {\n  PAY_PER_WASH = \"pay_per_wash\",\n  SUBSCRIPTION = \"subscription\"\n}\n\n// Password Reset Tokens Table\nexport const passwordResetTokens = pgTable(\"password_reset_tokens\", {\n  id: serial(\"id\").primaryKey(),\n  userId: integer(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  token: varchar(\"token\", { length: 255 }).notNull().unique(),\n  expiresAt: timestamp(\"expires_at\").notNull(),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\nexport const selectPasswordResetTokenSchema = createSelectSchema(passwordResetTokens);\nexport const insertPasswordResetTokenSchema = createInsertSchema(passwordResetTokens).omit({ id: true, createdAt: true });\nexport type PasswordResetToken = typeof passwordResetTokens.$inferSelect;\nexport type InsertPasswordResetToken = z.infer<typeof insertPasswordResetTokenSchema>;\n\n// Email OTP Verification Table (for anonymous complaint submission)\nexport const emailOtpVerifications = pgTable(\"email_otp_verifications\", {\n  id: serial(\"id\").primaryKey(),\n  email: varchar(\"email\", { length: 255 }).notNull(),\n  code: varchar(\"code\", { length: 6 }).notNull(),\n  expiresAt: timestamp(\"expires_at\").notNull(),\n  verified: integer(\"verified\").notNull().default(0),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\nexport const selectEmailOtpVerificationSchema = createSelectSchema(emailOtpVerifications);\nexport const insertEmailOtpVerificationSchema = createInsertSchema(emailOtpVerifications).omit({ id: true, createdAt: true, verified: true });\nexport type EmailOtpVerification = typeof emailOtpVerifications.$inferSelect;\nexport type InsertEmailOtpVerification = z.infer<typeof insertEmailOtpVerificationSchema>;\n","path":null,"size_bytes":38486,"size_tokens":null},"client/src/components/ui/chart.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as RechartsPrimitive from \"recharts\"\n\nimport { cn } from \"@/lib/utils\"\n\n// Format: { THEME_NAME: CSS_SELECTOR }\nconst THEMES = { light: \"\", dark: \".dark\" } as const\n\nexport type ChartConfig = {\n  [k in string]: {\n    label?: React.ReactNode\n    icon?: React.ComponentType\n  } & (\n    | { color?: string; theme?: never }\n    | { color?: never; theme: Record<keyof typeof THEMES, string> }\n  )\n}\n\ntype ChartContextProps = {\n  config: ChartConfig\n}\n\nconst ChartContext = React.createContext<ChartContextProps | null>(null)\n\nfunction useChart() {\n  const context = React.useContext(ChartContext)\n\n  if (!context) {\n    throw new Error(\"useChart must be used within a <ChartContainer />\")\n  }\n\n  return context\n}\n\nconst ChartContainer = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    config: ChartConfig\n    children: React.ComponentProps<\n      typeof RechartsPrimitive.ResponsiveContainer\n    >[\"children\"]\n  }\n>(({ id, className, children, config, ...props }, ref) => {\n  const uniqueId = React.useId()\n  const chartId = `chart-${id || uniqueId.replace(/:/g, \"\")}`\n\n  return (\n    <ChartContext.Provider value={{ config }}>\n      <div\n        data-chart={chartId}\n        ref={ref}\n        className={cn(\n          \"flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none\",\n          className\n        )}\n        {...props}\n      >\n        <ChartStyle id={chartId} config={config} />\n        <RechartsPrimitive.ResponsiveContainer>\n          {children}\n        </RechartsPrimitive.ResponsiveContainer>\n      </div>\n    </ChartContext.Provider>\n  )\n})\nChartContainer.displayName = \"Chart\"\n\nconst ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {\n  const colorConfig = Object.entries(config).filter(\n    ([, config]) => config.theme || config.color\n  )\n\n  if (!colorConfig.length) {\n    return null\n  }\n\n  return (\n    <style\n      dangerouslySetInnerHTML={{\n        __html: Object.entries(THEMES)\n          .map(\n            ([theme, prefix]) => `\n${prefix} [data-chart=${id}] {\n${colorConfig\n  .map(([key, itemConfig]) => {\n    const color =\n      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||\n      itemConfig.color\n    return color ? `  --color-${key}: ${color};` : null\n  })\n  .join(\"\\n\")}\n}\n`\n          )\n          .join(\"\\n\"),\n      }}\n    />\n  )\n}\n\nconst ChartTooltip = RechartsPrimitive.Tooltip\n\nconst ChartTooltipContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<typeof RechartsPrimitive.Tooltip> &\n    React.ComponentProps<\"div\"> & {\n      hideLabel?: boolean\n      hideIndicator?: boolean\n      indicator?: \"line\" | \"dot\" | \"dashed\"\n      nameKey?: string\n      labelKey?: string\n    }\n>(\n  (\n    {\n      active,\n      payload,\n      className,\n      indicator = \"dot\",\n      hideLabel = false,\n      hideIndicator = false,\n      label,\n      labelFormatter,\n      labelClassName,\n      formatter,\n      color,\n      nameKey,\n      labelKey,\n    },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    const tooltipLabel = React.useMemo(() => {\n      if (hideLabel || !payload?.length) {\n        return null\n      }\n\n      const [item] = payload\n      const key = `${labelKey || item?.dataKey || item?.name || \"value\"}`\n      const itemConfig = getPayloadConfigFromPayload(config, item, key)\n      const value =\n        !labelKey && typeof label === \"string\"\n          ? config[label as keyof typeof config]?.label || label\n          : itemConfig?.label\n\n      if (labelFormatter) {\n        return (\n          <div className={cn(\"font-medium\", labelClassName)}>\n            {labelFormatter(value, payload)}\n          </div>\n        )\n      }\n\n      if (!value) {\n        return null\n      }\n\n      return <div className={cn(\"font-medium\", labelClassName)}>{value}</div>\n    }, [\n      label,\n      labelFormatter,\n      payload,\n      hideLabel,\n      labelClassName,\n      config,\n      labelKey,\n    ])\n\n    if (!active || !payload?.length) {\n      return null\n    }\n\n    const nestLabel = payload.length === 1 && indicator !== \"dot\"\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl\",\n          className\n        )}\n      >\n        {!nestLabel ? tooltipLabel : null}\n        <div className=\"grid gap-1.5\">\n          {payload.map((item, index) => {\n            const key = `${nameKey || item.name || item.dataKey || \"value\"}`\n            const itemConfig = getPayloadConfigFromPayload(config, item, key)\n            const indicatorColor = color || item.payload.fill || item.color\n\n            return (\n              <div\n                key={item.dataKey}\n                className={cn(\n                  \"flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground\",\n                  indicator === \"dot\" && \"items-center\"\n                )}\n              >\n                {formatter && item?.value !== undefined && item.name ? (\n                  formatter(item.value, item.name, item, index, item.payload)\n                ) : (\n                  <>\n                    {itemConfig?.icon ? (\n                      <itemConfig.icon />\n                    ) : (\n                      !hideIndicator && (\n                        <div\n                          className={cn(\n                            \"shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]\",\n                            {\n                              \"h-2.5 w-2.5\": indicator === \"dot\",\n                              \"w-1\": indicator === \"line\",\n                              \"w-0 border-[1.5px] border-dashed bg-transparent\":\n                                indicator === \"dashed\",\n                              \"my-0.5\": nestLabel && indicator === \"dashed\",\n                            }\n                          )}\n                          style={\n                            {\n                              \"--color-bg\": indicatorColor,\n                              \"--color-border\": indicatorColor,\n                            } as React.CSSProperties\n                          }\n                        />\n                      )\n                    )}\n                    <div\n                      className={cn(\n                        \"flex flex-1 justify-between leading-none\",\n                        nestLabel ? \"items-end\" : \"items-center\"\n                      )}\n                    >\n                      <div className=\"grid gap-1.5\">\n                        {nestLabel ? tooltipLabel : null}\n                        <span className=\"text-muted-foreground\">\n                          {itemConfig?.label || item.name}\n                        </span>\n                      </div>\n                      {item.value && (\n                        <span className=\"font-mono font-medium tabular-nums text-foreground\">\n                          {item.value.toLocaleString()}\n                        </span>\n                      )}\n                    </div>\n                  </>\n                )}\n              </div>\n            )\n          })}\n        </div>\n      </div>\n    )\n  }\n)\nChartTooltipContent.displayName = \"ChartTooltip\"\n\nconst ChartLegend = RechartsPrimitive.Legend\n\nconst ChartLegendContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> &\n    Pick<RechartsPrimitive.LegendProps, \"payload\" | \"verticalAlign\"> & {\n      hideIcon?: boolean\n      nameKey?: string\n    }\n>(\n  (\n    { className, hideIcon = false, payload, verticalAlign = \"bottom\", nameKey },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    if (!payload?.length) {\n      return null\n    }\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"flex items-center justify-center gap-4\",\n          verticalAlign === \"top\" ? \"pb-3\" : \"pt-3\",\n          className\n        )}\n      >\n        {payload.map((item) => {\n          const key = `${nameKey || item.dataKey || \"value\"}`\n          const itemConfig = getPayloadConfigFromPayload(config, item, key)\n\n          return (\n            <div\n              key={item.value}\n              className={cn(\n                \"flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground\"\n              )}\n            >\n              {itemConfig?.icon && !hideIcon ? (\n                <itemConfig.icon />\n              ) : (\n                <div\n                  className=\"h-2 w-2 shrink-0 rounded-[2px]\"\n                  style={{\n                    backgroundColor: item.color,\n                  }}\n                />\n              )}\n              {itemConfig?.label}\n            </div>\n          )\n        })}\n      </div>\n    )\n  }\n)\nChartLegendContent.displayName = \"ChartLegend\"\n\n// Helper to extract item config from a payload.\nfunction getPayloadConfigFromPayload(\n  config: ChartConfig,\n  payload: unknown,\n  key: string\n) {\n  if (typeof payload !== \"object\" || payload === null) {\n    return undefined\n  }\n\n  const payloadPayload =\n    \"payload\" in payload &&\n    typeof payload.payload === \"object\" &&\n    payload.payload !== null\n      ? payload.payload\n      : undefined\n\n  let configLabelKey: string = key\n\n  if (\n    key in payload &&\n    typeof payload[key as keyof typeof payload] === \"string\"\n  ) {\n    configLabelKey = payload[key as keyof typeof payload] as string\n  } else if (\n    payloadPayload &&\n    key in payloadPayload &&\n    typeof payloadPayload[key as keyof typeof payloadPayload] === \"string\"\n  ) {\n    configLabelKey = payloadPayload[\n      key as keyof typeof payloadPayload\n    ] as string\n  }\n\n  return configLabelKey in config\n    ? config[configLabelKey]\n    : config[key as keyof typeof config]\n}\n\nexport {\n  ChartContainer,\n  ChartTooltip,\n  ChartTooltipContent,\n  ChartLegend,\n  ChartLegendContent,\n  ChartStyle,\n}\n","path":null,"size_bytes":10481,"size_tokens":null},"client/src/lib/auth-context.tsx":{"content":"import { createContext, useContext, useEffect, useState } from \"react\";\nimport { User, UserRole } from \"@shared/schema\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\n\ninterface AuthContextType {\n  currentUser: User | null;\n  loading: boolean;\n  signIn: (email: string, password: string) => Promise<void>;\n  registerAdmin: (data: RegisterAdminData) => Promise<void>;\n  registerCompany: (data: RegisterCompanyData) => Promise<void>;\n  registerCleaner: (data: RegisterCleanerData) => Promise<void>;\n  signOut: () => Promise<void>;\n}\n\nexport interface RegisterAdminData {\n  email: string;\n  password: string;\n  displayName: string;\n}\n\nexport interface RegisterCompanyData {\n  email: string;\n  password: string;\n  displayName: string;\n  phoneNumber?: string;\n  companyName: string;\n  companyDescription?: string;\n  pricePerWash: string;\n  tradeLicenseNumber?: string;\n  tradeLicenseDocumentURL?: string;\n  packageType?: string;\n  subscriptionCleanerSlots?: number;\n}\n\nexport interface RegisterCleanerData {\n  email: string;\n  password: string;\n  displayName: string;\n  phoneNumber: string;\n  companyId?: string;\n}\n\nconst AuthContext = createContext<AuthContextType | undefined>(undefined);\n\nexport function useAuth() {\n  const context = useContext(AuthContext);\n  if (!context) {\n    throw new Error(\"useAuth must be used within AuthProvider\");\n  }\n  return context;\n}\n\nexport function AuthProvider({ children }: { children: React.ReactNode }) {\n  const [currentUser, setCurrentUser] = useState<User | null>(null);\n  const [loading, setLoading] = useState(true);\n  const { toast } = useToast();\n\n  // Check auth status on mount\n  useEffect(() => {\n    checkAuthStatus();\n  }, []);\n\n  const checkAuthStatus = async () => {\n    try {\n      const response = await fetch(\"/api/auth/me\", {\n        credentials: \"include\",\n      });\n      \n      if (response.ok) {\n        const data = await response.json();\n        setCurrentUser(data.user);\n      } else {\n        setCurrentUser(null);\n      }\n    } catch (error) {\n      console.error(\"Auth check failed:\", error);\n      setCurrentUser(null);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const signIn = async (email: string, password: string) => {\n    try {\n      const response = await fetch(\"/api/auth/login\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ email, password }),\n        credentials: \"include\",\n      });\n\n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.message || \"Login failed\");\n      }\n\n      const data = await response.json();\n      setCurrentUser(data.user);\n      \n      toast({\n        title: \"Signed In\",\n        description: \"Welcome back!\",\n      });\n    } catch (error: any) {\n      toast({\n        title: \"Sign-in Error\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n      throw error;\n    }\n  };\n\n  const registerAdmin = async (data: RegisterAdminData) => {\n    try {\n      const response = await fetch(\"/api/auth/register/admin\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(data),\n        credentials: \"include\",\n      });\n\n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.message || \"Registration failed\");\n      }\n\n      const result = await response.json();\n      setCurrentUser(result.user);\n      \n      toast({\n        title: \"Registration Successful\",\n        description: \"Admin account created!\",\n      });\n    } catch (error: any) {\n      toast({\n        title: \"Registration Error\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n      throw error;\n    }\n  };\n\n  const registerCompany = async (data: RegisterCompanyData) => {\n    try {\n      const response = await fetch(\"/api/auth/register/company\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(data),\n        credentials: \"include\",\n      });\n\n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.message || \"Registration failed\");\n      }\n\n      const result = await response.json();\n      setCurrentUser(result.user);\n      \n      toast({\n        title: \"Registration Successful\",\n        description: \"Your company has been registered!\",\n      });\n    } catch (error: any) {\n      toast({\n        title: \"Registration Error\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n      throw error;\n    }\n  };\n\n  const registerCleaner = async (data: RegisterCleanerData) => {\n    try {\n      const response = await fetch(\"/api/auth/register/cleaner\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(data),\n        credentials: \"include\",\n      });\n\n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.message || \"Registration failed\");\n      }\n\n      const result = await response.json();\n      setCurrentUser(result.user);\n      \n      toast({\n        title: \"Registration Successful\",\n        description: \"Your cleaner account has been created!\",\n      });\n    } catch (error: any) {\n      toast({\n        title: \"Registration Error\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n      throw error;\n    }\n  };\n\n  const signOut = async () => {\n    try {\n      await fetch(\"/api/auth/logout\", {\n        method: \"POST\",\n        credentials: \"include\",\n      });\n      \n      queryClient.clear();\n      setCurrentUser(null);\n      toast({\n        title: \"Signed Out\",\n        description: \"You have been signed out successfully.\",\n      });\n    } catch (error: any) {\n      toast({\n        title: \"Sign-out Error\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const value = {\n    currentUser,\n    loading,\n    signIn,\n    registerAdmin,\n    registerCompany,\n    registerCleaner,\n    signOut,\n  };\n\n  return <AuthContext.Provider value={value}>{children}</AuthContext.Provider>;\n}\n","path":null,"size_bytes":6228,"size_tokens":null},"design_guidelines.md":{"content":"# Design Guidelines - Mobile-First Car Wash Booking App\n\n## Design Approach\n**Uber-Inspired Professional Theme**: Clean, minimalistic interface with focus on functionality and ease of use.\n\n## Color Palette\n- **Base**: Black and white color scheme\n- **Secondary**: Subtle grays for dividers, backgrounds, and secondary elements\n- **Accent**: Single accent color (sleek blue or green) for primary CTAs and highlights\n- **No color variations needed initially** - maintain strict monochrome with accent\n\n## Typography\n- **Font Family**: Roboto or Helvetica (clean, modern sans-serif)\n- **Hierarchy**:\n  - Large, bold text for key actions and headings\n  - Legible body text optimized for mobile screens\n  - Clear size differentiation between primary, secondary, and body text\n\n## Layout System\n- **Mobile-First**: Design for mobile screens first, expand to larger screens\n- **Spacing**: Use Tailwind units of 4, 6, and 8 for consistent spacing (p-4, m-6, gap-8)\n- **Touch Targets**: Ensure all interactive elements are easily tappable with thumb (minimum 44px height)\n- **Generous spacing** between buttons and interactive elements\n\n## Component Structure\n\n### Cards & Panels\n- Use card-based design for:\n  - Company listings (showing price, distance, on-duty cleaners)\n  - Job requests\n  - Cleaner details\n  - Analytics widgets\n- Clean borders or subtle shadows to separate content\n\n### Buttons\n- **Primary Actions**: Accent color background, white text, prominent placement\n- **Secondary Actions**: White/gray background with dark text or outlined style\n- **Consistent sizing**: Full-width on mobile for primary CTAs\n\n### Icons\n- Simple, minimalist line icons\n- Monochrome to match black-and-white theme\n- Use for: navigation, status indicators, company details, cleaner actions\n\n### Forms & Inputs\n- Clean input fields with clear labels\n- Mobile-optimized keyboard types (tel for phone, text for plates)\n- Clear validation states\n- Google Maps integration for location selection\n- File upload for cleaner's proof photos\n\n### Navigation\n- Bottom navigation bar for main user flows (mobile-first)\n- Simple top bar for context/back actions\n- Role-specific navigation (Customer, Cleaner, Company, Admin)\n\n### Data Display\n- **Analytics Dashboards**: Simple cards with key metrics\n- **Lists**: Scannable company/job listings with essential info\n- **Status Indicators**: Clear visual states for job progress\n\n## Key Screens Structure\n\n### Customer Flow\n1. **Home/Request**: Car plate input, map for location, optional parking number, mobile number\n2. **Company Selection**: Cards showing nearby companies with prices\n3. **Payment**: Stripe integration, clear pricing\n4. **Tracking**: Job status, cleaner contact info\n\n### Cleaner Flow\n1. **Available Jobs**: List of incoming requests from their company\n2. **Job Details**: Customer info, location, plate number\n3. **Complete**: Photo upload with plate visible\n\n### Company Dashboard\n- Jobs overview, cleaner management, earnings\n\n### Admin Dashboard\n- System-wide analytics, company/cleaner management\n\n## Images\n**No hero images needed** - This is a utility-focused mobile app. Focus on functional UI with clean layouts and efficient workflows.\n\n## Animations\nMinimal - only use for:\n- Loading states\n- Success confirmations\n- Smooth transitions between screens\n\n## Mobile-First Priorities\n- Single-column layouts\n- Bottom-anchored primary CTAs\n- Easy thumb reach for all controls\n- Optimized for one-handed use\n- Fast load times\n- Clear visual hierarchy without scrolling","path":null,"size_bytes":3516,"size_tokens":null},"client/src/hooks/use-toast.ts":{"content":"import * as React from \"react\"\n\nimport type {\n  ToastActionElement,\n  ToastProps,\n} from \"@/components/ui/toast\"\n\nconst TOAST_LIMIT = 1\nconst TOAST_REMOVE_DELAY = 1000000\n\ntype ToasterToast = ToastProps & {\n  id: string\n  title?: React.ReactNode\n  description?: React.ReactNode\n  action?: ToastActionElement\n}\n\nconst actionTypes = {\n  ADD_TOAST: \"ADD_TOAST\",\n  UPDATE_TOAST: \"UPDATE_TOAST\",\n  DISMISS_TOAST: \"DISMISS_TOAST\",\n  REMOVE_TOAST: \"REMOVE_TOAST\",\n} as const\n\nlet count = 0\n\nfunction genId() {\n  count = (count + 1) % Number.MAX_SAFE_INTEGER\n  return count.toString()\n}\n\ntype ActionType = typeof actionTypes\n\ntype Action =\n  | {\n      type: ActionType[\"ADD_TOAST\"]\n      toast: ToasterToast\n    }\n  | {\n      type: ActionType[\"UPDATE_TOAST\"]\n      toast: Partial<ToasterToast>\n    }\n  | {\n      type: ActionType[\"DISMISS_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n  | {\n      type: ActionType[\"REMOVE_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n\ninterface State {\n  toasts: ToasterToast[]\n}\n\nconst toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()\n\nconst addToRemoveQueue = (toastId: string) => {\n  if (toastTimeouts.has(toastId)) {\n    return\n  }\n\n  const timeout = setTimeout(() => {\n    toastTimeouts.delete(toastId)\n    dispatch({\n      type: \"REMOVE_TOAST\",\n      toastId: toastId,\n    })\n  }, TOAST_REMOVE_DELAY)\n\n  toastTimeouts.set(toastId, timeout)\n}\n\nexport const reducer = (state: State, action: Action): State => {\n  switch (action.type) {\n    case \"ADD_TOAST\":\n      return {\n        ...state,\n        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),\n      }\n\n    case \"UPDATE_TOAST\":\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === action.toast.id ? { ...t, ...action.toast } : t\n        ),\n      }\n\n    case \"DISMISS_TOAST\": {\n      const { toastId } = action\n\n      // ! Side effects ! - This could be extracted into a dismissToast() action,\n      // but I'll keep it here for simplicity\n      if (toastId) {\n        addToRemoveQueue(toastId)\n      } else {\n        state.toasts.forEach((toast) => {\n          addToRemoveQueue(toast.id)\n        })\n      }\n\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === toastId || toastId === undefined\n            ? {\n                ...t,\n                open: false,\n              }\n            : t\n        ),\n      }\n    }\n    case \"REMOVE_TOAST\":\n      if (action.toastId === undefined) {\n        return {\n          ...state,\n          toasts: [],\n        }\n      }\n      return {\n        ...state,\n        toasts: state.toasts.filter((t) => t.id !== action.toastId),\n      }\n  }\n}\n\nconst listeners: Array<(state: State) => void> = []\n\nlet memoryState: State = { toasts: [] }\n\nfunction dispatch(action: Action) {\n  memoryState = reducer(memoryState, action)\n  listeners.forEach((listener) => {\n    listener(memoryState)\n  })\n}\n\ntype Toast = Omit<ToasterToast, \"id\">\n\nfunction toast({ ...props }: Toast) {\n  const id = genId()\n\n  const update = (props: ToasterToast) =>\n    dispatch({\n      type: \"UPDATE_TOAST\",\n      toast: { ...props, id },\n    })\n  const dismiss = () => dispatch({ type: \"DISMISS_TOAST\", toastId: id })\n\n  dispatch({\n    type: \"ADD_TOAST\",\n    toast: {\n      ...props,\n      id,\n      open: true,\n      onOpenChange: (open) => {\n        if (!open) dismiss()\n      },\n    },\n  })\n\n  return {\n    id: id,\n    dismiss,\n    update,\n  }\n}\n\nfunction useToast() {\n  const [state, setState] = React.useState<State>(memoryState)\n\n  React.useEffect(() => {\n    listeners.push(setState)\n    return () => {\n      const index = listeners.indexOf(setState)\n      if (index > -1) {\n        listeners.splice(index, 1)\n      }\n    }\n  }, [state])\n\n  return {\n    ...state,\n    toast,\n    dismiss: (toastId?: string) => dispatch({ type: \"DISMISS_TOAST\", toastId }),\n  }\n}\n\nexport { useToast, toast }\n","path":null,"size_bytes":3895,"size_tokens":null},"client/src/components/ui/alert.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst alertVariants = cva(\n  \"relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-background text-foreground\",\n        destructive:\n          \"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Alert = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>\n>(({ className, variant, ...props }, ref) => (\n  <div\n    ref={ref}\n    role=\"alert\"\n    className={cn(alertVariants({ variant }), className)}\n    {...props}\n  />\n))\nAlert.displayName = \"Alert\"\n\nconst AlertTitle = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLHeadingElement>\n>(({ className, ...props }, ref) => (\n  <h5\n    ref={ref}\n    className={cn(\"mb-1 font-medium leading-none tracking-tight\", className)}\n    {...props}\n  />\n))\nAlertTitle.displayName = \"AlertTitle\"\n\nconst AlertDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm [&_p]:leading-relaxed\", className)}\n    {...props}\n  />\n))\nAlertDescription.displayName = \"AlertDescription\"\n\nexport { Alert, AlertTitle, AlertDescription }\n","path":null,"size_bytes":1584,"size_tokens":null},"client/src/components/ui/radio-group.tsx":{"content":"import * as React from \"react\"\nimport * as RadioGroupPrimitive from \"@radix-ui/react-radio-group\"\nimport { Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst RadioGroup = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Root\n      className={cn(\"grid gap-2\", className)}\n      {...props}\n      ref={ref}\n    />\n  )\n})\nRadioGroup.displayName = RadioGroupPrimitive.Root.displayName\n\nconst RadioGroupItem = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        \"aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    >\n      <RadioGroupPrimitive.Indicator className=\"flex items-center justify-center\">\n        <Circle className=\"h-2.5 w-2.5 fill-current text-current\" />\n      </RadioGroupPrimitive.Indicator>\n    </RadioGroupPrimitive.Item>\n  )\n})\nRadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName\n\nexport { RadioGroup, RadioGroupItem }\n","path":null,"size_bytes":1467,"size_tokens":null},"client/src/components/ui/input.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Input = React.forwardRef<HTMLInputElement, React.ComponentProps<\"input\">>(\n  ({ className, type, ...props }, ref) => {\n    // h-9 to match icon buttons and default buttons.\n    return (\n      <input\n        type={type}\n        className={cn(\n          \"flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n          className\n        )}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nInput.displayName = \"Input\"\n\nexport { Input }\n","path":null,"size_bytes":844,"size_tokens":null},"client/src/components/bottom-nav.tsx":{"content":"import { Home, Briefcase, BarChart3, LogOut, AlertCircle, DollarSign } from \"lucide-react\";\nimport { useLocation } from \"wouter\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { UserRole } from \"@shared/schema\";\n\nexport function BottomNav() {\n  const [location, navigate] = useLocation();\n  const { currentUser, signOut } = useAuth();\n\n  if (!currentUser) return null;\n\n  const getNavItems = () => {\n    switch (currentUser.role) {\n      case UserRole.CUSTOMER:\n        return [\n          { icon: Home, label: \"Book\", path: \"/customer\", testId: \"nav-home\" },\n          { icon: Briefcase, label: \"Jobs\", path: \"/customer/jobs\", testId: \"nav-jobs\" },\n        ];\n      case UserRole.CLEANER:\n        return [\n          { icon: Home, label: \"Dashboard\", path: \"/cleaner\", testId: \"nav-dashboard\" },\n          { icon: DollarSign, label: \"Tips\", path: \"/cleaner/tips\", testId: \"nav-tips\" },\n        ];\n      case UserRole.COMPANY_ADMIN:\n        return [\n          { icon: BarChart3, label: \"Dashboard\", path: \"/company\", testId: \"nav-dashboard\" },\n          { icon: AlertCircle, label: \"Complaints\", path: \"/company/complaints\", testId: \"nav-complaints\" },\n        ];\n      case UserRole.ADMIN:\n        return [\n          { icon: BarChart3, label: \"Dashboard\", path: \"/admin\", testId: \"nav-dashboard\" },\n          { icon: AlertCircle, label: \"Complaints\", path: \"/admin/complaints\", testId: \"nav-complaints\" },\n        ];\n      default:\n        return [];\n    }\n  };\n\n  const navItems = getNavItems();\n\n  return (\n    <nav className=\"fixed bottom-0 left-0 right-0 bg-card border-t border-border z-50\">\n      <div className=\"max-w-md mx-auto flex items-center justify-around h-16 px-4\">\n        {navItems.map((item) => {\n          const Icon = item.icon;\n          const isActive = location === item.path;\n          return (\n            <button\n              key={item.path}\n              onClick={() => navigate(item.path)}\n              data-testid={item.testId}\n              className={`flex flex-col items-center justify-center gap-1 px-4 py-2 rounded-md transition-colors ${\n                isActive\n                  ? \"text-primary\"\n                  : \"text-muted-foreground hover:text-foreground\"\n              }`}\n            >\n              <Icon className=\"h-5 w-5\" />\n              <span className=\"text-xs font-medium\">{item.label}</span>\n            </button>\n          );\n        })}\n        \n        <button\n          onClick={() => signOut()}\n          data-testid=\"nav-signout\"\n          className=\"flex flex-col items-center justify-center gap-1 px-4 py-2 rounded-md text-muted-foreground hover:text-foreground transition-colors\"\n        >\n          <LogOut className=\"h-5 w-5\" />\n          <span className=\"text-xs font-medium\">Sign Out</span>\n        </button>\n      </div>\n    </nav>\n  );\n}\n","path":null,"size_bytes":2815,"size_tokens":null},"client/src/components/ui/accordion.tsx":{"content":"import * as React from \"react\"\nimport * as AccordionPrimitive from \"@radix-ui/react-accordion\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Accordion = AccordionPrimitive.Root\n\nconst AccordionItem = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <AccordionPrimitive.Item\n    ref={ref}\n    className={cn(\"border-b\", className)}\n    {...props}\n  />\n))\nAccordionItem.displayName = \"AccordionItem\"\n\nconst AccordionTrigger = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Header className=\"flex\">\n    <AccordionPrimitive.Trigger\n      ref={ref}\n      className={cn(\n        \"flex flex-1 items-center justify-between py-4 font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <ChevronDown className=\"h-4 w-4 shrink-0 transition-transform duration-200\" />\n    </AccordionPrimitive.Trigger>\n  </AccordionPrimitive.Header>\n))\nAccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName\n\nconst AccordionContent = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Content\n    ref={ref}\n    className=\"overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down\"\n    {...props}\n  >\n    <div className={cn(\"pb-4 pt-0\", className)}>{children}</div>\n  </AccordionPrimitive.Content>\n))\n\nAccordionContent.displayName = AccordionPrimitive.Content.displayName\n\nexport { Accordion, AccordionItem, AccordionTrigger, AccordionContent }\n","path":null,"size_bytes":1977,"size_tokens":null},"client/src/components/ui/menubar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as MenubarPrimitive from \"@radix-ui/react-menubar\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nfunction MenubarMenu({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Menu>) {\n  return <MenubarPrimitive.Menu {...props} />\n}\n\nfunction MenubarGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Group>) {\n  return <MenubarPrimitive.Group {...props} />\n}\n\nfunction MenubarPortal({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Portal>) {\n  return <MenubarPrimitive.Portal {...props} />\n}\n\nfunction MenubarRadioGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.RadioGroup>) {\n  return <MenubarPrimitive.RadioGroup {...props} />\n}\n\nfunction MenubarSub({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Sub>) {\n  return <MenubarPrimitive.Sub data-slot=\"menubar-sub\" {...props} />\n}\n\nconst Menubar = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"flex h-10 items-center space-x-1 rounded-md border bg-background p-1\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubar.displayName = MenubarPrimitive.Root.displayName\n\nconst MenubarTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-3 py-1.5 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName\n\nconst MenubarSubTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <MenubarPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </MenubarPrimitive.SubTrigger>\n))\nMenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName\n\nconst MenubarSubContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName\n\nconst MenubarContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Content>\n>(\n  (\n    { className, align = \"start\", alignOffset = -4, sideOffset = 8, ...props },\n    ref\n  ) => (\n    <MenubarPrimitive.Portal>\n      <MenubarPrimitive.Content\n        ref={ref}\n        align={align}\n        alignOffset={alignOffset}\n        sideOffset={sideOffset}\n        className={cn(\n          \"z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n          className\n        )}\n        {...props}\n      />\n    </MenubarPrimitive.Portal>\n  )\n)\nMenubarContent.displayName = MenubarPrimitive.Content.displayName\n\nconst MenubarItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarItem.displayName = MenubarPrimitive.Item.displayName\n\nconst MenubarCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <MenubarPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.CheckboxItem>\n))\nMenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName\n\nconst MenubarRadioItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <MenubarPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.RadioItem>\n))\nMenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName\n\nconst MenubarLabel = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarLabel.displayName = MenubarPrimitive.Label.displayName\n\nconst MenubarSeparator = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nMenubarSeparator.displayName = MenubarPrimitive.Separator.displayName\n\nconst MenubarShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nMenubarShortcut.displayname = \"MenubarShortcut\"\n\nexport {\n  Menubar,\n  MenubarMenu,\n  MenubarTrigger,\n  MenubarContent,\n  MenubarItem,\n  MenubarSeparator,\n  MenubarLabel,\n  MenubarCheckboxItem,\n  MenubarRadioGroup,\n  MenubarRadioItem,\n  MenubarPortal,\n  MenubarSubContent,\n  MenubarSubTrigger,\n  MenubarGroup,\n  MenubarSub,\n  MenubarShortcut,\n}\n","path":null,"size_bytes":8605,"size_tokens":null},"server/lib/resend.ts":{"content":"// Resend email integration - from resend blueprint\nimport { Resend } from 'resend';\nimport { readFileSync } from 'fs';\n\nlet connectionSettings: any;\n\nasync function getCredentials() {\n  // If project-specific API key is set, use it directly\n  if (process.env.RESEND_API_KEY) {\n    return {\n      apiKey: process.env.RESEND_API_KEY,\n      fromEmail: process.env.RESEND_FROM_EMAIL || 'support@washapp.ae'\n    };\n  }\n\n  // Otherwise, use the shared Resend integration\n  const hostname = process.env.REPLIT_CONNECTORS_HOSTNAME;\n  const xReplitToken = process.env.REPL_IDENTITY \n    ? 'repl ' + process.env.REPL_IDENTITY \n    : process.env.WEB_REPL_RENEWAL \n    ? 'depl ' + process.env.WEB_REPL_RENEWAL \n    : null;\n\n  if (!xReplitToken) {\n    throw new Error('X_REPLIT_TOKEN not found for repl/depl');\n  }\n\n  connectionSettings = await fetch(\n    'https://' + hostname + '/api/v2/connection?include_secrets=true&connector_names=resend',\n    {\n      headers: {\n        'Accept': 'application/json',\n        'X_REPLIT_TOKEN': xReplitToken\n      }\n    }\n  ).then(res => res.json()).then(data => data.items?.[0]);\n\n  if (!connectionSettings || (!connectionSettings.settings.api_key)) {\n    throw new Error('Resend not connected');\n  }\n  return {\n    apiKey: connectionSettings.settings.api_key, \n    fromEmail: connectionSettings.settings.from_email\n  };\n}\n\n// WARNING: Never cache this client.\n// Access tokens expire, so a new client must be created each time.\nexport async function getUncachableResendClient() {\n  const credentials = await getCredentials();\n  return {\n    client: new Resend(credentials.apiKey),\n    fromEmail: credentials.fromEmail\n  };\n}\n\nexport async function sendEmail(\n  to: string, \n  subject: string, \n  html: string, \n  attachments?: Array<{ filename: string; path: string }>\n) {\n  try {\n    const { client, fromEmail } = await getUncachableResendClient();\n    const emailData: any = {\n      from: fromEmail,\n      to: [to],\n      subject,\n      html,\n    };\n    \n    // Convert file path attachments to base64 content for Resend\n    if (attachments && attachments.length > 0) {\n      emailData.attachments = attachments.map(att => {\n        try {\n          const fileContent = readFileSync(att.path);\n          return {\n            filename: att.filename,\n            content: fileContent.toString('base64'),\n          };\n        } catch (fileError) {\n          console.error(`Failed to read attachment file ${att.path}:`, fileError);\n          return null;\n        }\n      }).filter(Boolean); // Remove failed attachments\n    }\n    \n    await client.emails.send(emailData);\n    console.log(`Email sent successfully to ${to} - Subject: ${subject}`);\n  } catch (error) {\n    console.error('Failed to send email:', error);\n    // Don't throw - emails are not critical\n  }\n}\n","path":null,"size_bytes":2794,"size_tokens":null},"client/src/pages/register-company.tsx":{"content":"import { useState } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Button } from \"@/components/ui/button\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { Loader2, Check } from \"lucide-react\";\nimport logoUrl from \"@assets/IMG_2508_1762619079711.png\";\nimport { CompanyPackageType } from \"@shared/schema\";\n\nexport default function RegisterCompanyPage() {\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  const { registerCompany } = useAuth();\n  const [packageType, setPackageType] = useState<string>(CompanyPackageType.PAY_PER_WASH);\n  const [cleanerCount, setCleanerCount] = useState(\"\");\n  const [formData, setFormData] = useState({\n    // Admin details\n    email: \"\",\n    password: \"\",\n    displayName: \"\",\n    phoneNumber: \"\",\n    // Company details\n    companyName: \"\",\n    companyDescription: \"\",\n    pricePerWash: \"\",\n    tradeLicenseNumber: \"\",\n  });\n  const [licenseFile, setLicenseFile] = useState<File | null>(null);\n  const [submitting, setSubmitting] = useState(false);\n  \n  const calculateMonthlyFee = () => {\n    if (packageType !== CompanyPackageType.SUBSCRIPTION || !cleanerCount) return 0;\n    const count = parseInt(cleanerCount);\n    if (isNaN(count) || count <= 0) return 0;\n    const slots = Math.ceil(count / 10) * 10;\n    return (slots / 10) * 500;\n  };\n  \n  const monthlyFee = calculateMonthlyFee();\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    setSubmitting(true);\n    \n    try {\n      let tradeLicenseDocumentURL: string | undefined;\n      \n      // Upload license document if provided\n      if (licenseFile) {\n        const uploadData = new FormData();\n        uploadData.append(\"tradeLicense\", licenseFile);\n        \n        const uploadResponse = await fetch(\"/api/upload/trade-license\", {\n          method: \"POST\",\n          body: uploadData,\n        });\n        \n        if (uploadResponse.ok) {\n          const uploadResult = await uploadResponse.json();\n          tradeLicenseDocumentURL = uploadResult.url;\n        }\n      }\n      \n      // Register company and admin user\n      await registerCompany({\n        email: formData.email,\n        password: formData.password,\n        displayName: formData.displayName,\n        phoneNumber: formData.phoneNumber || undefined,\n        companyName: formData.companyName,\n        companyDescription: formData.companyDescription || undefined,\n        pricePerWash: formData.pricePerWash,\n        tradeLicenseNumber: formData.tradeLicenseNumber || undefined,\n        tradeLicenseDocumentURL,\n        packageType,\n        subscriptionCleanerSlots: packageType === CompanyPackageType.SUBSCRIPTION && cleanerCount \n          ? Math.ceil(parseInt(cleanerCount) / 10) * 10 \n          : undefined,\n      });\n      \n      setLocation(\"/company\");\n    } catch (error: any) {\n      // Error is already shown by auth context\n    } finally {\n      setSubmitting(false);\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-background flex items-center justify-center p-4\">\n      <Card className=\"w-full max-w-md\">\n        <CardHeader className=\"text-center space-y-2\">\n          <div className=\"flex items-center justify-center mb-4\">\n            <img src={logoUrl} alt=\"Washapp.ae\" className=\"h-24 w-auto\" data-testid=\"img-logo\" />\n          </div>\n          <CardTitle className=\"text-xl font-bold\">Register Company</CardTitle>\n          <CardDescription className=\"text-base\">\n            Create a car wash company account\n          </CardDescription>\n        </CardHeader>\n        <form onSubmit={handleSubmit}>\n          <CardContent className=\"space-y-4\">\n            <div className=\"border-b pb-4\">\n              <h3 className=\"font-semibold mb-3\">Choose Your Package</h3>\n              \n              <div className=\"space-y-4\">\n                <div className=\"grid grid-cols-1 gap-3\">\n                  <button\n                    type=\"button\"\n                    onClick={() => {\n                      setPackageType(CompanyPackageType.PAY_PER_WASH);\n                      setCleanerCount(\"\");\n                    }}\n                    className={`relative p-4 rounded-lg border-2 text-left transition-all ${\n                      packageType === CompanyPackageType.PAY_PER_WASH\n                        ? \"border-primary bg-primary/5\"\n                        : \"border-border hover-elevate\"\n                    }`}\n                    data-testid=\"button-package-per-wash\"\n                  >\n                    {packageType === CompanyPackageType.PAY_PER_WASH && (\n                      <div className=\"absolute top-3 right-3\">\n                        <Check className=\"h-5 w-5 text-primary\" />\n                      </div>\n                    )}\n                    <div className=\"font-medium mb-1\">Pay Per Wash</div>\n                    <div className=\"text-sm text-muted-foreground\">\n                      2 AED + 5% of total charge per wash\n                    </div>\n                  </button>\n                  \n                  <button\n                    type=\"button\"\n                    onClick={() => setPackageType(CompanyPackageType.SUBSCRIPTION)}\n                    className={`relative p-4 rounded-lg border-2 text-left transition-all ${\n                      packageType === CompanyPackageType.SUBSCRIPTION\n                        ? \"border-primary bg-primary/5\"\n                        : \"border-border hover-elevate\"\n                    }`}\n                    data-testid=\"button-package-subscription\"\n                  >\n                    {packageType === CompanyPackageType.SUBSCRIPTION && (\n                      <div className=\"absolute top-3 right-3\">\n                        <Check className=\"h-5 w-5 text-primary\" />\n                      </div>\n                    )}\n                    <div className=\"font-medium mb-1\">Monthly Subscription</div>\n                    <div className=\"text-sm text-muted-foreground\">\n                      500 AED per 10 cleaners/month + payment processing (1 AED + 2.9% per wash)\n                    </div>\n                  </button>\n                </div>\n                \n                {packageType === CompanyPackageType.SUBSCRIPTION && (\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"cleanerCount\">Number of Cleaners</Label>\n                    <Input\n                      id=\"cleanerCount\"\n                      type=\"number\"\n                      min=\"1\"\n                      placeholder=\"Enter number of cleaners\"\n                      value={cleanerCount}\n                      onChange={(e) => setCleanerCount(e.target.value)}\n                      required\n                      data-testid=\"input-cleaner-count\"\n                    />\n                    {monthlyFee > 0 && (\n                      <div className=\"p-3 bg-muted rounded-md\">\n                        <div className=\"text-sm font-medium\">\n                          Monthly Fee: {monthlyFee} AED\n                        </div>\n                        <div className=\"text-xs text-muted-foreground mt-1\">\n                          Cleaner slots: {Math.ceil(parseInt(cleanerCount) / 10) * 10} (rounded up to nearest 10)\n                        </div>\n                      </div>\n                    )}\n                  </div>\n                )}\n              </div>\n            </div>\n            \n            <div className=\"border-b pb-4\">\n              <h3 className=\"font-semibold mb-3\">Company Details</h3>\n              \n              <div className=\"space-y-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"companyName\">Company Name</Label>\n                  <Input\n                    id=\"companyName\"\n                    placeholder=\"ABC Car Wash\"\n                    value={formData.companyName}\n                    onChange={(e) => setFormData({ ...formData, companyName: e.target.value })}\n                    required\n                    data-testid=\"input-company-name\"\n                  />\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"companyDescription\">Description</Label>\n                  <Textarea\n                    id=\"companyDescription\"\n                    placeholder=\"Professional car wash services...\"\n                    value={formData.companyDescription}\n                    onChange={(e) => setFormData({ ...formData, companyDescription: e.target.value })}\n                    rows={3}\n                    data-testid=\"input-company-description\"\n                  />\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"pricePerWash\">Price per Wash ($)</Label>\n                  <Input\n                    id=\"pricePerWash\"\n                    type=\"number\"\n                    step=\"0.01\"\n                    min=\"0\"\n                    placeholder=\"25.00\"\n                    value={formData.pricePerWash}\n                    onChange={(e) => setFormData({ ...formData, pricePerWash: e.target.value })}\n                    required\n                    data-testid=\"input-price\"\n                  />\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"tradeLicenseNumber\">Trade License Number</Label>\n                  <Input\n                    id=\"tradeLicenseNumber\"\n                    placeholder=\"ABC-12345-2024\"\n                    value={formData.tradeLicenseNumber}\n                    onChange={(e) => setFormData({ ...formData, tradeLicenseNumber: e.target.value })}\n                    data-testid=\"input-trade-license\"\n                  />\n                  <p className=\"text-xs text-muted-foreground\">Optional: Your business trade license number</p>\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"licenseDocument\">Trade License Document</Label>\n                  <Input\n                    id=\"licenseDocument\"\n                    type=\"file\"\n                    accept=\".pdf,.jpg,.jpeg,.png\"\n                    onChange={(e) => setLicenseFile(e.target.files?.[0] || null)}\n                    data-testid=\"input-license-document\"\n                  />\n                  <p className=\"text-xs text-muted-foreground\">Optional: Upload your trade license (PDF, JPG, or PNG)</p>\n                </div>\n              </div>\n            </div>\n\n            <div>\n              <h3 className=\"font-semibold mb-3\">Admin Account</h3>\n              \n              <div className=\"space-y-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"displayName\">Your Name</Label>\n                  <Input\n                    id=\"displayName\"\n                    placeholder=\"John Doe\"\n                    value={formData.displayName}\n                    onChange={(e) => setFormData({ ...formData, displayName: e.target.value })}\n                    required\n                    data-testid=\"input-name\"\n                  />\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"email\">Email</Label>\n                  <Input\n                    id=\"email\"\n                    type=\"email\"\n                    placeholder=\"your@email.com\"\n                    value={formData.email}\n                    onChange={(e) => setFormData({ ...formData, email: e.target.value })}\n                    required\n                    data-testid=\"input-email\"\n                  />\n                </div>\n                \n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"phoneNumber\">Phone Number (Optional)</Label>\n                  <Input\n                    id=\"phoneNumber\"\n                    type=\"tel\"\n                    placeholder=\"+6512345678 (E.164 format)\"\n                    value={formData.phoneNumber}\n                    onChange={(e) => setFormData({ ...formData, phoneNumber: e.target.value })}\n                    data-testid=\"input-phone\"\n                  />\n                  <p className=\"text-xs text-muted-foreground\">Use E.164 format: +[country code][number] (e.g., +6512345678)</p>\n                </div>\n                \n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"password\">Password</Label>\n                  <Input\n                    id=\"password\"\n                    type=\"password\"\n                    placeholder=\"••••••••\"\n                    value={formData.password}\n                    onChange={(e) => setFormData({ ...formData, password: e.target.value })}\n                    required\n                    minLength={6}\n                    data-testid=\"input-password\"\n                  />\n                </div>\n              </div>\n            </div>\n          </CardContent>\n          \n          <CardFooter className=\"flex flex-col gap-4\">\n            <Button\n              type=\"submit\"\n              className=\"w-full\"\n              size=\"lg\"\n              disabled={submitting}\n              data-testid=\"button-register\"\n            >\n              {submitting ? (\n                <>\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                  Creating Company...\n                </>\n              ) : (\n                \"Register Company\"\n              )}\n            </Button>\n            \n            <div className=\"text-center text-sm\">\n              <span className=\"text-muted-foreground\">Already have an account? </span>\n              <Button\n                type=\"button\"\n                variant=\"ghost\"\n                className=\"p-0 h-auto\"\n                onClick={() => setLocation(\"/login\")}\n                data-testid=\"link-login\"\n              >\n                Sign In\n              </Button>\n            </div>\n          </CardFooter>\n        </form>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":14143,"size_tokens":null},"server/vite.ts":{"content":"import express, { type Express } from \"express\";\nimport fs from \"fs\";\nimport path from \"path\";\nimport { createServer as createViteServer, createLogger } from \"vite\";\nimport { type Server } from \"http\";\nimport viteConfig from \"../vite.config\";\nimport { nanoid } from \"nanoid\";\n\nconst viteLogger = createLogger();\n\nexport function log(message: string, source = \"express\") {\n  const formattedTime = new Date().toLocaleTimeString(\"en-US\", {\n    hour: \"numeric\",\n    minute: \"2-digit\",\n    second: \"2-digit\",\n    hour12: true,\n  });\n\n  console.log(`${formattedTime} [${source}] ${message}`);\n}\n\nexport async function setupVite(app: Express, server: Server) {\n  const serverOptions = {\n    middlewareMode: true,\n    hmr: { server },\n    allowedHosts: true as const,\n  };\n\n  const vite = await createViteServer({\n    ...viteConfig,\n    configFile: false,\n    customLogger: {\n      ...viteLogger,\n      error: (msg, options) => {\n        viteLogger.error(msg, options);\n        process.exit(1);\n      },\n    },\n    server: serverOptions,\n    appType: \"custom\",\n  });\n\n  app.use(vite.middlewares);\n  app.use(\"*\", async (req, res, next) => {\n    const url = req.originalUrl;\n\n    try {\n      const clientTemplate = path.resolve(\n        import.meta.dirname,\n        \"..\",\n        \"client\",\n        \"index.html\",\n      );\n\n      // always reload the index.html file from disk incase it changes\n      let template = await fs.promises.readFile(clientTemplate, \"utf-8\");\n      template = template.replace(\n        `src=\"/src/main.tsx\"`,\n        `src=\"/src/main.tsx?v=${nanoid()}\"`,\n      );\n      const page = await vite.transformIndexHtml(url, template);\n      res.status(200).set({ \"Content-Type\": \"text/html\" }).end(page);\n    } catch (e) {\n      vite.ssrFixStacktrace(e as Error);\n      next(e);\n    }\n  });\n}\n\nexport function serveStatic(app: Express) {\n  const distPath = path.resolve(import.meta.dirname, \"public\");\n\n  if (!fs.existsSync(distPath)) {\n    throw new Error(\n      `Could not find the build directory: ${distPath}, make sure to build the client first`,\n    );\n  }\n\n  app.use(express.static(distPath));\n\n  // fall through to index.html if the file doesn't exist\n  app.use(\"*\", (_req, res) => {\n    res.sendFile(path.resolve(distPath, \"index.html\"));\n  });\n}\n","path":null,"size_bytes":2263,"size_tokens":null},"client/src/components/ui/context-menu.tsx":{"content":"import * as React from \"react\"\nimport * as ContextMenuPrimitive from \"@radix-ui/react-context-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ContextMenu = ContextMenuPrimitive.Root\n\nconst ContextMenuTrigger = ContextMenuPrimitive.Trigger\n\nconst ContextMenuGroup = ContextMenuPrimitive.Group\n\nconst ContextMenuPortal = ContextMenuPrimitive.Portal\n\nconst ContextMenuSub = ContextMenuPrimitive.Sub\n\nconst ContextMenuRadioGroup = ContextMenuPrimitive.RadioGroup\n\nconst ContextMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <ContextMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </ContextMenuPrimitive.SubTrigger>\n))\nContextMenuSubTrigger.displayName = ContextMenuPrimitive.SubTrigger.displayName\n\nconst ContextMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuSubContent.displayName = ContextMenuPrimitive.SubContent.displayName\n\nconst ContextMenuContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Portal>\n    <ContextMenuPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"z-50 max-h-[--radix-context-menu-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md animate-in fade-in-80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </ContextMenuPrimitive.Portal>\n))\nContextMenuContent.displayName = ContextMenuPrimitive.Content.displayName\n\nconst ContextMenuItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuItem.displayName = ContextMenuPrimitive.Item.displayName\n\nconst ContextMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <ContextMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.CheckboxItem>\n))\nContextMenuCheckboxItem.displayName =\n  ContextMenuPrimitive.CheckboxItem.displayName\n\nconst ContextMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <ContextMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.RadioItem>\n))\nContextMenuRadioItem.displayName = ContextMenuPrimitive.RadioItem.displayName\n\nconst ContextMenuLabel = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold text-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuLabel.displayName = ContextMenuPrimitive.Label.displayName\n\nconst ContextMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nContextMenuSeparator.displayName = ContextMenuPrimitive.Separator.displayName\n\nconst ContextMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nContextMenuShortcut.displayName = \"ContextMenuShortcut\"\n\nexport {\n  ContextMenu,\n  ContextMenuTrigger,\n  ContextMenuContent,\n  ContextMenuItem,\n  ContextMenuCheckboxItem,\n  ContextMenuRadioItem,\n  ContextMenuLabel,\n  ContextMenuSeparator,\n  ContextMenuShortcut,\n  ContextMenuGroup,\n  ContextMenuPortal,\n  ContextMenuSub,\n  ContextMenuSubContent,\n  ContextMenuSubTrigger,\n  ContextMenuRadioGroup,\n}\n","path":null,"size_bytes":7428,"size_tokens":null},"client/src/components/ui/progress.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ProgressPrimitive from \"@radix-ui/react-progress\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Progress = React.forwardRef<\n  React.ElementRef<typeof ProgressPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>\n>(({ className, value, ...props }, ref) => (\n  <ProgressPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative h-4 w-full overflow-hidden rounded-full bg-secondary\",\n      className\n    )}\n    {...props}\n  >\n    <ProgressPrimitive.Indicator\n      className=\"h-full w-full flex-1 bg-primary transition-all\"\n      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}\n    />\n  </ProgressPrimitive.Root>\n))\nProgress.displayName = ProgressPrimitive.Root.displayName\n\nexport { Progress }\n","path":null,"size_bytes":791,"size_tokens":null},"client/src/components/ui/drawer.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Drawer as DrawerPrimitive } from \"vaul\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Drawer = ({\n  shouldScaleBackground = true,\n  ...props\n}: React.ComponentProps<typeof DrawerPrimitive.Root>) => (\n  <DrawerPrimitive.Root\n    shouldScaleBackground={shouldScaleBackground}\n    {...props}\n  />\n)\nDrawer.displayName = \"Drawer\"\n\nconst DrawerTrigger = DrawerPrimitive.Trigger\n\nconst DrawerPortal = DrawerPrimitive.Portal\n\nconst DrawerClose = DrawerPrimitive.Close\n\nconst DrawerOverlay = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Overlay\n    ref={ref}\n    className={cn(\"fixed inset-0 z-50 bg-black/80\", className)}\n    {...props}\n  />\n))\nDrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName\n\nconst DrawerContent = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DrawerPortal>\n    <DrawerOverlay />\n    <DrawerPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background\",\n        className\n      )}\n      {...props}\n    >\n      <div className=\"mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted\" />\n      {children}\n    </DrawerPrimitive.Content>\n  </DrawerPortal>\n))\nDrawerContent.displayName = \"DrawerContent\"\n\nconst DrawerHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"grid gap-1.5 p-4 text-center sm:text-left\", className)}\n    {...props}\n  />\n)\nDrawerHeader.displayName = \"DrawerHeader\"\n\nconst DrawerFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"mt-auto flex flex-col gap-2 p-4\", className)}\n    {...props}\n  />\n)\nDrawerFooter.displayName = \"DrawerFooter\"\n\nconst DrawerTitle = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDrawerTitle.displayName = DrawerPrimitive.Title.displayName\n\nconst DrawerDescription = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDrawerDescription.displayName = DrawerPrimitive.Description.displayName\n\nexport {\n  Drawer,\n  DrawerPortal,\n  DrawerOverlay,\n  DrawerTrigger,\n  DrawerClose,\n  DrawerContent,\n  DrawerHeader,\n  DrawerFooter,\n  DrawerTitle,\n  DrawerDescription,\n}\n","path":null,"size_bytes":3021,"size_tokens":null},"drizzle.config.ts":{"content":"import { defineConfig } from \"drizzle-kit\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\"DATABASE_URL, ensure the database is provisioned\");\n}\n\nexport default defineConfig({\n  out: \"./migrations\",\n  schema: \"./shared/schema.ts\",\n  dialect: \"postgresql\",\n  dbCredentials: {\n    url: process.env.DATABASE_URL,\n  },\n});\n","path":null,"size_bytes":325,"size_tokens":null},"client/src/pages/select-company.tsx":{"content":"import { useEffect, useState } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardFooter, CardHeader } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { MapPin, Users, Star, UserCheck } from \"lucide-react\";\nimport { CompanyWithCleaners } from \"@shared/schema\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport logoUrl from \"@assets/IMG_2508_1762619079711.png\";\nimport { calculateFees, type FeePackageType } from \"@shared/fee-calculator\";\n\nexport default function SelectCompany() {\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  const [pendingJob, setPendingJob] = useState<any>(null);\n\n  useEffect(() => {\n    const stored = sessionStorage.getItem(\"pendingJob\");\n    if (!stored) {\n      setLocation(\"/customer\");\n      return;\n    }\n    setPendingJob(JSON.parse(stored));\n  }, [setLocation]);\n\n  const { data: allCompanies, isLoading } = useQuery<CompanyWithCleaners[]>({\n    queryKey: [\"/api/companies/nearby\", pendingJob?.locationLatitude, pendingJob?.locationLongitude],\n    enabled: !!pendingJob && \n             typeof pendingJob.locationLatitude === 'number' && \n             typeof pendingJob.locationLongitude === 'number' &&\n             !isNaN(pendingJob.locationLatitude) &&\n             !isNaN(pendingJob.locationLongitude),\n    queryFn: async () => {\n      const params = new URLSearchParams({\n        lat: pendingJob.locationLatitude.toString(),\n        lon: pendingJob.locationLongitude.toString(),\n      });\n      const res = await fetch(`/api/companies/nearby?${params}`);\n      if (!res.ok) throw new Error(\"Failed to fetch companies\");\n      return res.json();\n    },\n  });\n\n  // Filter companies based on forcedCompanyId if present\n  const companies = allCompanies?.filter(company => {\n    if (pendingJob?.forcedCompanyId) {\n      return company.id === pendingJob.forcedCompanyId;\n    }\n    return true;\n  });\n\n  const handleSelectCompany = (company: CompanyWithCleaners) => {\n    const carWashPrice = Number(company.pricePerWash);\n    const feePackageType = (company.feePackageType || \"custom\") as FeePackageType;\n    const platformFee = Number(company.platformFee);\n    \n    const fees = calculateFees({\n      carWashPrice,\n      feePackageType,\n      platformFee,\n    });\n    \n    const updatedJob = {\n      ...pendingJob,\n      companyId: company.id,\n      price: carWashPrice,\n      ...fees,\n    };\n    sessionStorage.setItem(\"pendingJob\", JSON.stringify(updatedJob));\n    setLocation(\"/customer/checkout\");\n  };\n\n  if (!pendingJob) {\n    return (\n      <div className=\"h-screen flex items-center justify-center\">\n        <div className=\"animate-spin w-8 h-8 border-4 border-primary border-t-transparent rounded-full\" aria-label=\"Loading\"/>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-background flex flex-col\">\n      {/* Header - Clean and minimal */}\n      <div className=\"border-b bg-background sticky top-0 z-10\">\n        <div className=\"max-w-md mx-auto px-4 py-3\">\n          <div className=\"flex items-center justify-between gap-3\">\n            <img src={logoUrl} alt=\"Washapp.ae\" className=\"h-10 w-auto\" data-testid=\"img-logo\" />\n            <div className=\"flex-1\">\n              <h1 className=\"text-base font-semibold\">Select Company</h1>\n              <p className=\"text-xs text-muted-foreground\">\n                Available cleaners nearby\n              </p>\n            </div>\n            <Button \n              variant=\"ghost\" \n              size=\"sm\"\n              onClick={() => setLocation(\"/customer\")}\n              data-testid=\"button-back\"\n            >\n              Back\n            </Button>\n          </div>\n        </div>\n      </div>\n\n      {/* Content */}\n      <div className=\"flex-1 max-w-md mx-auto w-full px-4 py-6 pb-24\">\n\n        {/* Cleaner Request Banner */}\n        {pendingJob?.forcedCompanyId && pendingJob?.cleanerName && (\n          <Alert className=\"mb-4 bg-primary/5 border-primary/20\" data-testid=\"alert-forced-company\">\n            <UserCheck className=\"h-4 w-4\" />\n            <AlertDescription>\n              <span className=\"font-medium\">Cleaner requested:</span> {pendingJob.cleanerName}\n              <br />\n              <span className=\"text-xs text-muted-foreground\">\n                Showing their company only\n              </span>\n            </AlertDescription>\n          </Alert>\n        )}\n\n        {/* Loading State */}\n        {isLoading && (\n          <div className=\"space-y-3\">\n            {[1, 2, 3].map((i) => (\n              <div key={i} className=\"border rounded-lg p-4\">\n                <Skeleton className=\"h-5 w-2/3 mb-3\" />\n                <Skeleton className=\"h-4 w-1/2 mb-4\" />\n                <Skeleton className=\"h-10 w-full\" />\n              </div>\n            ))}\n          </div>\n        )}\n\n        {/* Companies List - Modern cards */}\n        {!isLoading && companies && companies.length > 0 && (\n          <div className=\"space-y-3\">\n            {companies.map((company) => (\n              <button\n                key={company.id}\n                onClick={() => handleSelectCompany(company)}\n                data-testid={`button-select-company-${company.id}`}\n                className=\"w-full text-left border rounded-lg p-4 hover-elevate active-elevate-2 transition-all\"\n              >\n                {/* Company Name and Price */}\n                <div className=\"flex items-start justify-between gap-3 mb-3\">\n                  <div className=\"flex-1 min-w-0\">\n                    <h3 className=\"font-semibold text-lg text-foreground truncate\">\n                      {company.name}\n                    </h3>\n                    {company.description && (\n                      <p className=\"text-sm text-muted-foreground mt-0.5 line-clamp-1\">\n                        {company.description}\n                      </p>\n                    )}\n                  </div>\n                  <div className=\"text-right shrink-0\">\n                    <div className=\"text-2xl font-bold text-foreground\">\n                      {(() => {\n                        const carWashPrice = Number(company.pricePerWash);\n                        const feePackageType = (company.feePackageType || \"custom\") as FeePackageType;\n                        const platformFee = Number(company.platformFee);\n                        const fees = calculateFees({\n                          carWashPrice,\n                          feePackageType,\n                          platformFee,\n                        });\n                        return fees.totalAmount.toFixed(2);\n                      })()} AED\n                    </div>\n                    <div className=\"text-xs text-muted-foreground leading-tight\">\n                      {(() => {\n                        const carWashPrice = Number(company.pricePerWash);\n                        const feePackageType = (company.feePackageType || \"custom\") as FeePackageType;\n                        const platformFee = Number(company.platformFee);\n                        const fees = calculateFees({\n                          carWashPrice,\n                          feePackageType,\n                          platformFee,\n                        });\n                        return fees.displayBreakdown;\n                      })()}\n                    </div>\n                  </div>\n                </div>\n\n                {/* Company Info - Compact badges */}\n                <div className=\"flex flex-wrap gap-2 mb-3\">\n                  <Badge variant=\"secondary\" className=\"text-xs\">\n                    <Users className=\"h-3 w-3 mr-1\" />\n                    {company.onDutyCleanersCount} available\n                  </Badge>\n                  \n                  {company.rating && Number(company.rating) > 0 && (\n                    <Badge variant=\"secondary\" className=\"text-xs\">\n                      <Star className=\"h-3 w-3 mr-1 fill-current\" />\n                      {Number(company.rating).toFixed(1)}\n                    </Badge>\n                  )}\n\n                  {company.distanceInMeters !== undefined && (\n                    <Badge variant=\"secondary\" className=\"text-xs\">\n                      <MapPin className=\"h-3 w-3 mr-1\" />\n                      {company.distanceInMeters}m\n                    </Badge>\n                  )}\n                </div>\n\n                {/* Stats */}\n                {company.totalJobsCompleted > 0 && (\n                  <div className=\"text-xs text-muted-foreground\">\n                    {company.totalJobsCompleted} jobs completed\n                  </div>\n                )}\n              </button>\n            ))}\n          </div>\n        )}\n\n        {/* Empty State */}\n        {!isLoading && companies && companies.length === 0 && (\n          <div className=\"text-center py-12\">\n            <Users className=\"h-12 w-12 mx-auto text-muted-foreground mb-4\" />\n            <h3 className=\"text-lg font-semibold mb-2\">No Companies Available</h3>\n            <p className=\"text-muted-foreground text-sm mb-6\">\n              No companies with available cleaners near your location right now.\n            </p>\n            <Button variant=\"outline\" onClick={() => setLocation(\"/customer\")}>\n              Go Back\n            </Button>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":9515,"size_tokens":null},"client/src/components/ui/slider.tsx":{"content":"import * as React from \"react\"\nimport * as SliderPrimitive from \"@radix-ui/react-slider\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Slider = React.forwardRef<\n  React.ElementRef<typeof SliderPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <SliderPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex w-full touch-none select-none items-center\",\n      className\n    )}\n    {...props}\n  >\n    <SliderPrimitive.Track className=\"relative h-2 w-full grow overflow-hidden rounded-full bg-secondary\">\n      <SliderPrimitive.Range className=\"absolute h-full bg-primary\" />\n    </SliderPrimitive.Track>\n    <SliderPrimitive.Thumb className=\"block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50\" />\n  </SliderPrimitive.Root>\n))\nSlider.displayName = SliderPrimitive.Root.displayName\n\nexport { Slider }\n","path":null,"size_bytes":1077,"size_tokens":null},"client/src/components/ui/form.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport {\n  Controller,\n  FormProvider,\n  useFormContext,\n  type ControllerProps,\n  type FieldPath,\n  type FieldValues,\n} from \"react-hook-form\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Label } from \"@/components/ui/label\"\n\nconst Form = FormProvider\n\ntype FormFieldContextValue<\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n> = {\n  name: TName\n}\n\nconst FormFieldContext = React.createContext<FormFieldContextValue>(\n  {} as FormFieldContextValue\n)\n\nconst FormField = <\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n>({\n  ...props\n}: ControllerProps<TFieldValues, TName>) => {\n  return (\n    <FormFieldContext.Provider value={{ name: props.name }}>\n      <Controller {...props} />\n    </FormFieldContext.Provider>\n  )\n}\n\nconst useFormField = () => {\n  const fieldContext = React.useContext(FormFieldContext)\n  const itemContext = React.useContext(FormItemContext)\n  const { getFieldState, formState } = useFormContext()\n\n  const fieldState = getFieldState(fieldContext.name, formState)\n\n  if (!fieldContext) {\n    throw new Error(\"useFormField should be used within <FormField>\")\n  }\n\n  const { id } = itemContext\n\n  return {\n    id,\n    name: fieldContext.name,\n    formItemId: `${id}-form-item`,\n    formDescriptionId: `${id}-form-item-description`,\n    formMessageId: `${id}-form-item-message`,\n    ...fieldState,\n  }\n}\n\ntype FormItemContextValue = {\n  id: string\n}\n\nconst FormItemContext = React.createContext<FormItemContextValue>(\n  {} as FormItemContextValue\n)\n\nconst FormItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const id = React.useId()\n\n  return (\n    <FormItemContext.Provider value={{ id }}>\n      <div ref={ref} className={cn(\"space-y-2\", className)} {...props} />\n    </FormItemContext.Provider>\n  )\n})\nFormItem.displayName = \"FormItem\"\n\nconst FormLabel = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  const { error, formItemId } = useFormField()\n\n  return (\n    <Label\n      ref={ref}\n      className={cn(error && \"text-destructive\", className)}\n      htmlFor={formItemId}\n      {...props}\n    />\n  )\n})\nFormLabel.displayName = \"FormLabel\"\n\nconst FormControl = React.forwardRef<\n  React.ElementRef<typeof Slot>,\n  React.ComponentPropsWithoutRef<typeof Slot>\n>(({ ...props }, ref) => {\n  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()\n\n  return (\n    <Slot\n      ref={ref}\n      id={formItemId}\n      aria-describedby={\n        !error\n          ? `${formDescriptionId}`\n          : `${formDescriptionId} ${formMessageId}`\n      }\n      aria-invalid={!!error}\n      {...props}\n    />\n  )\n})\nFormControl.displayName = \"FormControl\"\n\nconst FormDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => {\n  const { formDescriptionId } = useFormField()\n\n  return (\n    <p\n      ref={ref}\n      id={formDescriptionId}\n      className={cn(\"text-sm text-muted-foreground\", className)}\n      {...props}\n    />\n  )\n})\nFormDescription.displayName = \"FormDescription\"\n\nconst FormMessage = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, children, ...props }, ref) => {\n  const { error, formMessageId } = useFormField()\n  const body = error ? String(error?.message ?? \"\") : children\n\n  if (!body) {\n    return null\n  }\n\n  return (\n    <p\n      ref={ref}\n      id={formMessageId}\n      className={cn(\"text-sm font-medium text-destructive\", className)}\n      {...props}\n    >\n      {body}\n    </p>\n  )\n})\nFormMessage.displayName = \"FormMessage\"\n\nexport {\n  useFormField,\n  Form,\n  FormItem,\n  FormLabel,\n  FormControl,\n  FormDescription,\n  FormMessage,\n  FormField,\n}\n","path":null,"size_bytes":4120,"size_tokens":null},"client/src/index.css":{"content":"@tailwind base;\n@tailwind components;\n@tailwind utilities;\n\n/* LIGHT MODE */\n:root {\n  --button-outline: rgba(0,0,0, .10);\n  --badge-outline: rgba(0,0,0, .05);\n\n  /* Automatic computation of border around primary / danger buttons */\n  --opaque-button-border-intensity: -8; /* In terms of percentages */\n\n  /* Backgrounds applied on top of other backgrounds when hovered/active */\n  --elevate-1: rgba(0,0,0, .03);\n  --elevate-2: rgba(0,0,0, .08);\n\n  --background: 220 15% 99%;\n\n  --foreground: 224 15% 12%;\n\n  --border: 220 13% 88%;\n\n  --card: 0 0% 100%;\n\n  --card-foreground: 224 15% 12%;\n\n  --card-border: 220 13% 92%;\n\n  --sidebar: 220 15% 97%;\n\n  --sidebar-foreground: 224 15% 12%;\n\n  --sidebar-border: 220 13% 90%;\n\n  --sidebar-primary: 221 83% 53%;\n\n  --sidebar-primary-foreground: 0 0% 100%;\n\n  --sidebar-accent: 220 14% 94%;\n\n  --sidebar-accent-foreground: 224 15% 12%;\n\n  --sidebar-ring: 221 83% 53%;\n\n  --popover: 0 0% 98%;\n\n  --popover-foreground: 224 15% 12%;\n\n  --popover-border: 220 13% 90%;\n\n  --primary: 221 83% 53%;\n\n  --primary-foreground: 0 0% 100%;\n\n  --secondary: 220 13% 95%;\n\n  --secondary-foreground: 224 15% 12%;\n\n  --muted: 220 13% 96%;\n\n  --muted-foreground: 220 9% 46%;\n\n  --accent: 268 75% 96%;\n\n  --accent-foreground: 268 75% 25%;\n\n  --destructive: 0 72% 51%;\n\n  --destructive-foreground: 0 0% 100%;\n\n  --input: 220 13% 88%;\n  --ring: 221 83% 53%;\n  --chart-1: 221 83% 53%;\n  --chart-2: 142 71% 45%;\n  --chart-3: 197 87% 45%;\n  --chart-4: 268 75% 60%;\n  --chart-5: 43 96% 50%;\n\n  --font-sans: Roboto, sans-serif;\n  --font-serif: Georgia, serif;\n  --font-mono: Roboto Mono, monospace;\n  --radius: .5rem; /* 8px */\n  --shadow-2xs: 0px 2px 0px 0px hsl(0 0% 0% / 0.02);\n  --shadow-xs: 0px 2px 0px 0px hsl(0 0% 0% / 0.04);\n  --shadow-sm: 0px 2px 0px 0px hsl(0 0% 0% / 0.06), 0px 1px 2px -1px hsl(0 0% 0% / 0.08);\n  --shadow: 0px 2px 0px 0px hsl(0 0% 0% / 0.08), 0px 1px 2px -1px hsl(0 0% 0% / 0.10);\n  --shadow-md: 0px 2px 0px 0px hsl(0 0% 0% / 0.10), 0px 2px 4px -1px hsl(0 0% 0% / 0.12);\n  --shadow-lg: 0px 2px 0px 0px hsl(0 0% 0% / 0.12), 0px 4px 6px -1px hsl(0 0% 0% / 0.14);\n  --shadow-xl: 0px 2px 0px 0px hsl(0 0% 0% / 0.14), 0px 8px 10px -1px hsl(0 0% 0% / 0.16);\n  --shadow-2xl: 0px 2px 0px 0px hsl(0 0% 0% / 0.18);\n  --tracking-normal: 0em;\n  --spacing: 0.25rem;\n\n  /* Automatically computed borders - intensity can be controlled by the user by the --opaque-button-border-intensity setting */\n\n  /* Fallback for older browsers */\n  --sidebar-primary-border: hsl(var(--sidebar-primary));\n  --sidebar-primary-border: hsl(from hsl(var(--sidebar-primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --sidebar-accent-border: hsl(var(--sidebar-accent));\n  --sidebar-accent-border: hsl(from hsl(var(--sidebar-accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --primary-border: hsl(var(--primary));\n  --primary-border: hsl(from hsl(var(--primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --secondary-border: hsl(var(--secondary));\n  --secondary-border: hsl(from hsl(var(--secondary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --muted-border: hsl(var(--muted));\n  --muted-border: hsl(from hsl(var(--muted)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --accent-border: hsl(var(--accent));\n  --accent-border: hsl(from hsl(var(--accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --destructive-border: hsl(var(--destructive));\n  --destructive-border: hsl(from hsl(var(--destructive)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n}\n\n.dark {\n  --button-outline: rgba(255,255,255, .10);\n  --badge-outline: rgba(255,255,255, .05);\n\n  --opaque-button-border-intensity: 9;  /* In terms of percentages */\n\n  /* Backgrounds applied on top of other backgrounds when hovered/active */\n  --elevate-1: rgba(255,255,255, .04);\n  --elevate-2: rgba(255,255,255, .09);\n\n  --background: 224 15% 9%;\n\n  --foreground: 220 15% 97%;\n\n  --border: 224 13% 18%;\n\n  --card: 224 15% 11%;\n\n  --card-foreground: 220 15% 97%;\n\n  --card-border: 224 13% 15%;\n\n  --sidebar: 224 15% 12%;\n\n  --sidebar-foreground: 220 15% 97%;\n\n  --sidebar-border: 224 13% 18%;\n\n  --sidebar-primary: 221 83% 53%;\n\n  --sidebar-primary-foreground: 0 0% 100%;\n\n  --sidebar-accent: 224 13% 16%;\n\n  --sidebar-accent-foreground: 220 15% 97%;\n\n  --sidebar-ring: 221 83% 60%;\n\n  --popover: 224 15% 13%;\n\n  --popover-foreground: 220 15% 97%;\n\n  --popover-border: 224 13% 19%;\n\n  --primary: 221 83% 53%;\n\n  --primary-foreground: 0 0% 100%;\n\n  --secondary: 224 13% 17%;\n\n  --secondary-foreground: 220 15% 97%;\n\n  --muted: 224 13% 15%;\n\n  --muted-foreground: 220 9% 60%;\n\n  --accent: 268 75% 15%;\n\n  --accent-foreground: 268 75% 90%;\n\n  --destructive: 0 72% 51%;\n\n  --destructive-foreground: 0 0% 100%;\n\n  --input: 224 13% 20%;\n  --ring: 221 83% 60%;\n  --chart-1: 221 83% 60%;\n  --chart-2: 142 71% 55%;\n  --chart-3: 197 87% 55%;\n  --chart-4: 268 75% 65%;\n  --chart-5: 43 96% 58%;\n\n  --shadow-2xs: 0px 2px 0px 0px hsl(0 0% 0% / 0.05);\n  --shadow-xs: 0px 2px 0px 0px hsl(0 0% 0% / 0.10);\n  --shadow-sm: 0px 2px 0px 0px hsl(0 0% 0% / 0.15), 0px 1px 2px -1px hsl(0 0% 0% / 0.20);\n  --shadow: 0px 2px 0px 0px hsl(0 0% 0% / 0.20), 0px 1px 2px -1px hsl(0 0% 0% / 0.25);\n  --shadow-md: 0px 2px 0px 0px hsl(0 0% 0% / 0.25), 0px 2px 4px -1px hsl(0 0% 0% / 0.30);\n  --shadow-lg: 0px 2px 0px 0px hsl(0 0% 0% / 0.30), 0px 4px 6px -1px hsl(0 0% 0% / 0.35);\n  --shadow-xl: 0px 2px 0px 0px hsl(0 0% 0% / 0.35), 0px 8px 10px -1px hsl(0 0% 0% / 0.40);\n  --shadow-2xl: 0px 2px 0px 0px hsl(0 0% 0% / 0.45);\n\n  /* Automatically computed borders - intensity can be controlled by the user by the --opaque-button-border-intensity setting */\n\n  /* Fallback for older browsers */\n  --sidebar-primary-border: hsl(var(--sidebar-primary));\n  --sidebar-primary-border: hsl(from hsl(var(--sidebar-primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --sidebar-accent-border: hsl(var(--sidebar-accent));\n  --sidebar-accent-border: hsl(from hsl(var(--sidebar-accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --primary-border: hsl(var(--primary));\n  --primary-border: hsl(from hsl(var(--primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --secondary-border: hsl(var(--secondary));\n  --secondary-border: hsl(from hsl(var(--secondary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --muted-border: hsl(var(--muted));\n  --muted-border: hsl(from hsl(var(--muted)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --accent-border: hsl(var(--accent));\n  --accent-border: hsl(from hsl(var(--accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --destructive-border: hsl(var(--destructive));\n  --destructive-border: hsl(from hsl(var(--destructive)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n}\n\n@layer base {\n  * {\n    @apply border-border;\n  }\n\n  body {\n    @apply font-sans antialiased bg-background text-foreground;\n  }\n}\n\n@layer utilities {\n\n  /* Hide ugly search cancel button in Chrome until we can style it properly */\n  input[type=\"search\"]::-webkit-search-cancel-button {\n    @apply hidden;\n  }\n\n  /* Placeholder styling for contentEditable div */\n  [contenteditable][data-placeholder]:empty::before {\n    content: attr(data-placeholder);\n    color: hsl(var(--muted-foreground));\n    pointer-events: none;\n  }\n\n  .no-default-hover-elevate {}\n\n  .no-default-active-elevate {}\n\n  .toggle-elevate::before,\n  .toggle-elevate-2::before {\n    content: \"\";\n    pointer-events: none;\n    position: absolute;\n    inset: 0px;\n    border-radius: inherit;\n    z-index: -1;\n  }\n\n  .toggle-elevate.toggle-elevated::before {\n    background-color: var(--elevate-2);\n  }\n\n  .border.toggle-elevate::before {\n    inset: -1px;\n  }\n\n  .hover-elevate:not(.no-default-hover-elevate),\n  .active-elevate:not(.no-default-active-elevate),\n  .hover-elevate-2:not(.no-default-hover-elevate),\n  .active-elevate-2:not(.no-default-active-elevate) {\n    position: relative;\n    z-index: 0;\n  }\n\n  .hover-elevate:not(.no-default-hover-elevate)::after,\n  .active-elevate:not(.no-default-active-elevate)::after,\n  .hover-elevate-2:not(.no-default-hover-elevate)::after,\n  .active-elevate-2:not(.no-default-active-elevate)::after {\n    content: \"\";\n    pointer-events: none;\n    position: absolute;\n    inset: 0px;\n    border-radius: inherit;\n    z-index: 999;\n  }\n\n  .hover-elevate:hover:not(.no-default-hover-elevate)::after,\n  .active-elevate:active:not(.no-default-active-elevate)::after {\n    background-color: var(--elevate-1);\n  }\n\n  .hover-elevate-2:hover:not(.no-default-hover-elevate)::after,\n  .active-elevate-2:active:not(.no-default-active-elevate)::after {\n    background-color: var(--elevate-2);\n  }\n\n  .border.hover-elevate:not(.no-hover-interaction-elevate)::after,\n  .border.active-elevate:not(.no-active-interaction-elevate)::after,\n  .border.hover-elevate-2:not(.no-hover-interaction-elevate)::after,\n  .border.active-elevate-2:not(.no-active-interaction-elevate)::after,\n  .border.hover-elevate:not(.no-hover-interaction-elevate)::after {\n    inset: -1px;\n  }\n}","path":null,"size_bytes":9603,"size_tokens":null},"client/src/components/ui/tooltip.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as TooltipPrimitive from \"@radix-ui/react-tooltip\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst TooltipProvider = TooltipPrimitive.Provider\n\nconst Tooltip = TooltipPrimitive.Root\n\nconst TooltipTrigger = TooltipPrimitive.Trigger\n\nconst TooltipContent = React.forwardRef<\n  React.ElementRef<typeof TooltipPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <TooltipPrimitive.Content\n    ref={ref}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-tooltip-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nTooltipContent.displayName = TooltipPrimitive.Content.displayName\n\nexport { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }\n","path":null,"size_bytes":1209,"size_tokens":null},"client/src/components/ui/toggle-group.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ToggleGroupPrimitive from \"@radix-ui/react-toggle-group\"\nimport { type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { toggleVariants } from \"@/components/ui/toggle\"\n\nconst ToggleGroupContext = React.createContext<\n  VariantProps<typeof toggleVariants>\n>({\n  size: \"default\",\n  variant: \"default\",\n})\n\nconst ToggleGroup = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, children, ...props }, ref) => (\n  <ToggleGroupPrimitive.Root\n    ref={ref}\n    className={cn(\"flex items-center justify-center gap-1\", className)}\n    {...props}\n  >\n    <ToggleGroupContext.Provider value={{ variant, size }}>\n      {children}\n    </ToggleGroupContext.Provider>\n  </ToggleGroupPrimitive.Root>\n))\n\nToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName\n\nconst ToggleGroupItem = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> &\n    VariantProps<typeof toggleVariants>\n>(({ className, children, variant, size, ...props }, ref) => {\n  const context = React.useContext(ToggleGroupContext)\n\n  return (\n    <ToggleGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        toggleVariants({\n          variant: context.variant || variant,\n          size: context.size || size,\n        }),\n        className\n      )}\n      {...props}\n    >\n      {children}\n    </ToggleGroupPrimitive.Item>\n  )\n})\n\nToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName\n\nexport { ToggleGroup, ToggleGroupItem }\n","path":null,"size_bytes":1753,"size_tokens":null},"client/src/components/ui/breadcrumb.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Breadcrumb = React.forwardRef<\n  HTMLElement,\n  React.ComponentPropsWithoutRef<\"nav\"> & {\n    separator?: React.ReactNode\n  }\n>(({ ...props }, ref) => <nav ref={ref} aria-label=\"breadcrumb\" {...props} />)\nBreadcrumb.displayName = \"Breadcrumb\"\n\nconst BreadcrumbList = React.forwardRef<\n  HTMLOListElement,\n  React.ComponentPropsWithoutRef<\"ol\">\n>(({ className, ...props }, ref) => (\n  <ol\n    ref={ref}\n    className={cn(\n      \"flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5\",\n      className\n    )}\n    {...props}\n  />\n))\nBreadcrumbList.displayName = \"BreadcrumbList\"\n\nconst BreadcrumbItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentPropsWithoutRef<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    className={cn(\"inline-flex items-center gap-1.5\", className)}\n    {...props}\n  />\n))\nBreadcrumbItem.displayName = \"BreadcrumbItem\"\n\nconst BreadcrumbLink = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentPropsWithoutRef<\"a\"> & {\n    asChild?: boolean\n  }\n>(({ asChild, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      className={cn(\"transition-colors hover:text-foreground\", className)}\n      {...props}\n    />\n  )\n})\nBreadcrumbLink.displayName = \"BreadcrumbLink\"\n\nconst BreadcrumbPage = React.forwardRef<\n  HTMLSpanElement,\n  React.ComponentPropsWithoutRef<\"span\">\n>(({ className, ...props }, ref) => (\n  <span\n    ref={ref}\n    role=\"link\"\n    aria-disabled=\"true\"\n    aria-current=\"page\"\n    className={cn(\"font-normal text-foreground\", className)}\n    {...props}\n  />\n))\nBreadcrumbPage.displayName = \"BreadcrumbPage\"\n\nconst BreadcrumbSeparator = ({\n  children,\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) => (\n  <li\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"[&>svg]:w-3.5 [&>svg]:h-3.5\", className)}\n    {...props}\n  >\n    {children ?? <ChevronRight />}\n  </li>\n)\nBreadcrumbSeparator.displayName = \"BreadcrumbSeparator\"\n\nconst BreadcrumbEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More</span>\n  </span>\n)\nBreadcrumbEllipsis.displayName = \"BreadcrumbElipssis\"\n\nexport {\n  Breadcrumb,\n  BreadcrumbList,\n  BreadcrumbItem,\n  BreadcrumbLink,\n  BreadcrumbPage,\n  BreadcrumbSeparator,\n  BreadcrumbEllipsis,\n}\n","path":null,"size_bytes":2712,"size_tokens":null},"server/index.ts":{"content":"import express, { type Request, Response, NextFunction } from \"express\";\nimport session from \"express-session\";\nimport { registerRoutes } from \"./routes\";\nimport { setupVite, serveStatic, log } from \"./vite\";\nimport passport from \"./auth\";\nimport { sessionStore } from \"./session-store\";\n\nconst app = express();\n\ndeclare module 'http' {\n  interface IncomingMessage {\n    rawBody: unknown\n  }\n}\n\n// Trust proxy if behind a load balancer in production\nif (process.env.NODE_ENV === 'production') {\n  app.set('trust proxy', 1);\n}\n\n// Session configuration - MUST be before Passport\nif (!process.env.SESSION_SECRET) {\n  throw new Error('SESSION_SECRET must be set');\n}\n\napp.use(session({\n  store: sessionStore,\n  secret: process.env.SESSION_SECRET,\n  resave: false,\n  saveUninitialized: false,\n  cookie: {\n    secure: process.env.NODE_ENV === 'production',\n    httpOnly: true,\n    maxAge: 30 * 24 * 60 * 60 * 1000, // 30 days\n    sameSite: process.env.NODE_ENV === 'production' ? 'none' : 'lax',\n  },\n}));\n\n// Initialize Passport and session handling\napp.use(passport.initialize());\napp.use(passport.session());\n\napp.use(express.json({\n  verify: (req, _res, buf) => {\n    req.rawBody = buf;\n  }\n}));\napp.use(express.urlencoded({ extended: false }));\n\napp.use((req, res, next) => {\n  const start = Date.now();\n  const path = req.path;\n  let capturedJsonResponse: Record<string, any> | undefined = undefined;\n\n  const originalResJson = res.json;\n  res.json = function (bodyJson, ...args) {\n    capturedJsonResponse = bodyJson;\n    return originalResJson.apply(res, [bodyJson, ...args]);\n  };\n\n  res.on(\"finish\", () => {\n    const duration = Date.now() - start;\n    if (path.startsWith(\"/api\")) {\n      let logLine = `${req.method} ${path} ${res.statusCode} in ${duration}ms`;\n      if (capturedJsonResponse) {\n        logLine += ` :: ${JSON.stringify(capturedJsonResponse)}`;\n      }\n\n      if (logLine.length > 80) {\n        logLine = logLine.slice(0, 79) + \"…\";\n      }\n\n      log(logLine);\n    }\n  });\n\n  next();\n});\n\n(async () => {\n  const server = await registerRoutes(app);\n  \n  // Update version file for cache busting\n  const { updateVersionFile } = await import(\"./utils/updateVersion\");\n  updateVersionFile();\n  \n  // Ensure admin account exists with correct credentials\n  const { ensureAdminExists } = await import(\"./utils/ensureAdmin\");\n  await ensureAdminExists();\n  \n  // Setup WebSocket server for real-time updates\n  const { setupWebSocket } = await import(\"./websocket\");\n  setupWebSocket(server);\n  \n  // Start auto-refund service for jobs not accepted within 15 minutes\n  const { startAutoRefundService } = await import(\"./autoRefundService\");\n  startAutoRefundService();\n  \n  // Start auto-shift-timeout service to end shifts when location is stale (>10 min)\n  const { startAutoShiftTimeoutService } = await import(\"./autoShiftTimeoutService\");\n  startAutoShiftTimeoutService();\n\n  app.use((err: any, _req: Request, res: Response, _next: NextFunction) => {\n    const status = err.status || err.statusCode || 500;\n    const message = err.message || \"Internal Server Error\";\n\n    res.status(status).json({ message });\n    throw err;\n  });\n\n  // importantly only setup vite in development and after\n  // setting up all the other routes so the catch-all route\n  // doesn't interfere with the other routes\n  if (app.get(\"env\") === \"development\") {\n    await setupVite(app, server);\n  } else {\n    serveStatic(app);\n  }\n\n  // ALWAYS serve the app on the port specified in the environment variable PORT\n  // Other ports are firewalled. Default to 5000 if not specified.\n  // this serves both the API and the client.\n  // It is the only port that is not firewalled.\n  const port = parseInt(process.env.PORT || '5000', 10);\n  server.listen({\n    port,\n    host: \"0.0.0.0\",\n    reusePort: true,\n  }, () => {\n    log(`serving on port ${port}`);\n  });\n})();\n","path":null,"size_bytes":3862,"size_tokens":null},"client/src/components/ui/dropdown-menu.tsx":{"content":"import * as React from \"react\"\nimport * as DropdownMenuPrimitive from \"@radix-ui/react-dropdown-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst DropdownMenu = DropdownMenuPrimitive.Root\n\nconst DropdownMenuTrigger = DropdownMenuPrimitive.Trigger\n\nconst DropdownMenuGroup = DropdownMenuPrimitive.Group\n\nconst DropdownMenuPortal = DropdownMenuPrimitive.Portal\n\nconst DropdownMenuSub = DropdownMenuPrimitive.Sub\n\nconst DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup\n\nconst DropdownMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto\" />\n  </DropdownMenuPrimitive.SubTrigger>\n))\nDropdownMenuSubTrigger.displayName =\n  DropdownMenuPrimitive.SubTrigger.displayName\n\nconst DropdownMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuSubContent.displayName =\n  DropdownMenuPrimitive.SubContent.displayName\n\nconst DropdownMenuContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <DropdownMenuPrimitive.Portal>\n    <DropdownMenuPrimitive.Content\n      ref={ref}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </DropdownMenuPrimitive.Portal>\n))\nDropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName\n\nconst DropdownMenuItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName\n\nconst DropdownMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <DropdownMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.CheckboxItem>\n))\nDropdownMenuCheckboxItem.displayName =\n  DropdownMenuPrimitive.CheckboxItem.displayName\n\nconst DropdownMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.RadioItem>\n))\nDropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName\n\nconst DropdownMenuLabel = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName\n\nconst DropdownMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nDropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName\n\nconst DropdownMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\"ml-auto text-xs tracking-widest opacity-60\", className)}\n      {...props}\n    />\n  )\n}\nDropdownMenuShortcut.displayName = \"DropdownMenuShortcut\"\n\nexport {\n  DropdownMenu,\n  DropdownMenuTrigger,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuCheckboxItem,\n  DropdownMenuRadioItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuShortcut,\n  DropdownMenuGroup,\n  DropdownMenuPortal,\n  DropdownMenuSub,\n  DropdownMenuSubContent,\n  DropdownMenuSubTrigger,\n  DropdownMenuRadioGroup,\n}\n","path":null,"size_bytes":7609,"size_tokens":null},"server/lib/geo-utils.ts":{"content":"// Haversine formula to calculate distance between two points in meters\nexport function calculateDistance(\n  lat1: number,\n  lon1: number,\n  lat2: number,\n  lon2: number\n): number {\n  const R = 6371000; // Earth's radius in meters\n  const dLat = toRad(lat2 - lat1);\n  const dLon = toRad(lon2 - lon1);\n\n  const a =\n    Math.sin(dLat / 2) * Math.sin(dLat / 2) +\n    Math.cos(toRad(lat1)) *\n      Math.cos(toRad(lat2)) *\n      Math.sin(dLon / 2) *\n      Math.sin(dLon / 2);\n\n  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\n  const distance = R * c;\n\n  return Math.round(distance);\n}\n\nfunction toRad(degrees: number): number {\n  return (degrees * Math.PI) / 180;\n}\n","path":null,"size_bytes":673,"size_tokens":null},"server/seed.ts":{"content":"import { storage } from \"./storage\";\nimport { UserRole, CleanerStatus } from \"@shared/schema\";\n\nexport async function seedDatabase() {\n  try {\n    console.log(\"Seeding database with test data...\");\n\n    console.log(\"✓ Database seeded successfully!\");\n    console.log(\"\\nTest credentials:\");\n    console.log(\"Platform Admin: omer.eldirdieri@gmail.com / 12345678\");\n    console.log(\"\\nNote: Register companies and cleaners through the UI\");\n    console.log(\"Admin must approve companies before they become active\");\n    \n  } catch (error) {\n    console.error(\"Error seeding database:\", error);\n    throw error;\n  }\n}\n\nif (require.main === module) {\n  seedDatabase()\n    .then(() => {\n      console.log(\"Seed completed\");\n      process.exit(0);\n    })\n    .catch((error) => {\n      console.error(\"Seed failed:\", error);\n      process.exit(1);\n    });\n}\n","path":null,"size_bytes":852,"size_tokens":null},"client/src/components/ui/input-otp.tsx":{"content":"import * as React from \"react\"\nimport { OTPInput, OTPInputContext } from \"input-otp\"\nimport { Dot } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst InputOTP = React.forwardRef<\n  React.ElementRef<typeof OTPInput>,\n  React.ComponentPropsWithoutRef<typeof OTPInput>\n>(({ className, containerClassName, ...props }, ref) => (\n  <OTPInput\n    ref={ref}\n    containerClassName={cn(\n      \"flex items-center gap-2 has-[:disabled]:opacity-50\",\n      containerClassName\n    )}\n    className={cn(\"disabled:cursor-not-allowed\", className)}\n    {...props}\n  />\n))\nInputOTP.displayName = \"InputOTP\"\n\nconst InputOTPGroup = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"flex items-center\", className)} {...props} />\n))\nInputOTPGroup.displayName = \"InputOTPGroup\"\n\nconst InputOTPSlot = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\"> & { index: number }\n>(({ index, className, ...props }, ref) => {\n  const inputOTPContext = React.useContext(OTPInputContext)\n  const { char, hasFakeCaret, isActive } = inputOTPContext.slots[index]\n\n  return (\n    <div\n      ref={ref}\n      className={cn(\n        \"relative flex h-10 w-10 items-center justify-center border-y border-r border-input text-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md\",\n        isActive && \"z-10 ring-2 ring-ring ring-offset-background\",\n        className\n      )}\n      {...props}\n    >\n      {char}\n      {hasFakeCaret && (\n        <div className=\"pointer-events-none absolute inset-0 flex items-center justify-center\">\n          <div className=\"h-4 w-px animate-caret-blink bg-foreground duration-1000\" />\n        </div>\n      )}\n    </div>\n  )\n})\nInputOTPSlot.displayName = \"InputOTPSlot\"\n\nconst InputOTPSeparator = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ ...props }, ref) => (\n  <div ref={ref} role=\"separator\" {...props}>\n    <Dot />\n  </div>\n))\nInputOTPSeparator.displayName = \"InputOTPSeparator\"\n\nexport { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator }\n","path":null,"size_bytes":2154,"size_tokens":null},"client/src/components/ui/label.tsx":{"content":"import * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst labelVariants = cva(\n  \"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70\"\n)\n\nconst Label = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &\n    VariantProps<typeof labelVariants>\n>(({ className, ...props }, ref) => (\n  <LabelPrimitive.Root\n    ref={ref}\n    className={cn(labelVariants(), className)}\n    {...props}\n  />\n))\nLabel.displayName = LabelPrimitive.Root.displayName\n\nexport { Label }\n","path":null,"size_bytes":710,"size_tokens":null},"client/src/components/ui/calendar.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight } from \"lucide-react\"\nimport { DayPicker } from \"react-day-picker\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nexport type CalendarProps = React.ComponentProps<typeof DayPicker>\n\nfunction Calendar({\n  className,\n  classNames,\n  showOutsideDays = true,\n  ...props\n}: CalendarProps) {\n  return (\n    <DayPicker\n      showOutsideDays={showOutsideDays}\n      className={cn(\"p-3\", className)}\n      classNames={{\n        months: \"flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0\",\n        month: \"space-y-4\",\n        caption: \"flex justify-center pt-1 relative items-center\",\n        caption_label: \"text-sm font-medium\",\n        nav: \"space-x-1 flex items-center\",\n        nav_button: cn(\n          buttonVariants({ variant: \"outline\" }),\n          \"h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100\"\n        ),\n        nav_button_previous: \"absolute left-1\",\n        nav_button_next: \"absolute right-1\",\n        table: \"w-full border-collapse space-y-1\",\n        head_row: \"flex\",\n        head_cell:\n          \"text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]\",\n        row: \"flex w-full mt-2\",\n        cell: \"h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20\",\n        day: cn(\n          buttonVariants({ variant: \"ghost\" }),\n          \"h-9 w-9 p-0 font-normal aria-selected:opacity-100\"\n        ),\n        day_range_end: \"day-range-end\",\n        day_selected:\n          \"bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground\",\n        day_today: \"bg-accent text-accent-foreground\",\n        day_outside:\n          \"day-outside text-muted-foreground aria-selected:bg-accent/50 aria-selected:text-muted-foreground\",\n        day_disabled: \"text-muted-foreground opacity-50\",\n        day_range_middle:\n          \"aria-selected:bg-accent aria-selected:text-accent-foreground\",\n        day_hidden: \"invisible\",\n        ...classNames,\n      }}\n      components={{\n        IconLeft: ({ className, ...props }) => (\n          <ChevronLeft className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n        IconRight: ({ className, ...props }) => (\n          <ChevronRight className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n      }}\n      {...props}\n    />\n  )\n}\nCalendar.displayName = \"Calendar\"\n\nexport { Calendar }\n","path":null,"size_bytes":2695,"size_tokens":null},"client/src/components/ui/button.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst buttonVariants = cva(\n  \"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\" +\n  \" hover-elevate active-elevate-2\",\n  {\n    variants: {\n      variant: {\n        default:\n          \"bg-primary text-primary-foreground border border-primary-border\",\n        destructive:\n          \"bg-destructive text-destructive-foreground border border-destructive-border\",\n        outline:\n          // Shows the background color of whatever card / sidebar / accent background it is inside of.\n          // Inherits the current text color.\n          \" border [border-color:var(--button-outline)]  shadow-xs active:shadow-none \",\n        secondary: \"border bg-secondary text-secondary-foreground border border-secondary-border \",\n        // Add a transparent border so that when someone toggles a border on later, it doesn't shift layout/size.\n        ghost: \"border border-transparent\",\n      },\n      // Heights are set as \"min\" heights, because sometimes Ai will place large amount of content\n      // inside buttons. With a min-height they will look appropriate with small amounts of content,\n      // but will expand to fit large amounts of content.\n      size: {\n        default: \"min-h-9 px-4 py-2\",\n        sm: \"min-h-8 rounded-md px-3 text-xs\",\n        lg: \"min-h-10 rounded-md px-8\",\n        icon: \"h-9 w-9\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  },\n)\n\nexport interface ButtonProps\n  extends React.ButtonHTMLAttributes<HTMLButtonElement>,\n    VariantProps<typeof buttonVariants> {\n  asChild?: boolean\n}\n\nconst Button = React.forwardRef<HTMLButtonElement, ButtonProps>(\n  ({ className, variant, size, asChild = false, ...props }, ref) => {\n    const Comp = asChild ? Slot : \"button\"\n    return (\n      <Comp\n        className={cn(buttonVariants({ variant, size, className }))}\n        ref={ref}\n        {...props}\n      />\n    )\n  },\n)\nButton.displayName = \"Button\"\n\nexport { Button, buttonVariants }\n","path":null,"size_bytes":2359,"size_tokens":null},"client/src/components/ui/pagination.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { ButtonProps, buttonVariants } from \"@/components/ui/button\"\n\nconst Pagination = ({ className, ...props }: React.ComponentProps<\"nav\">) => (\n  <nav\n    role=\"navigation\"\n    aria-label=\"pagination\"\n    className={cn(\"mx-auto flex w-full justify-center\", className)}\n    {...props}\n  />\n)\nPagination.displayName = \"Pagination\"\n\nconst PaginationContent = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    className={cn(\"flex flex-row items-center gap-1\", className)}\n    {...props}\n  />\n))\nPaginationContent.displayName = \"PaginationContent\"\n\nconst PaginationItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li ref={ref} className={cn(\"\", className)} {...props} />\n))\nPaginationItem.displayName = \"PaginationItem\"\n\ntype PaginationLinkProps = {\n  isActive?: boolean\n} & Pick<ButtonProps, \"size\"> &\n  React.ComponentProps<\"a\">\n\nconst PaginationLink = ({\n  className,\n  isActive,\n  size = \"icon\",\n  ...props\n}: PaginationLinkProps) => (\n  <a\n    aria-current={isActive ? \"page\" : undefined}\n    className={cn(\n      buttonVariants({\n        variant: isActive ? \"outline\" : \"ghost\",\n        size,\n      }),\n      className\n    )}\n    {...props}\n  />\n)\nPaginationLink.displayName = \"PaginationLink\"\n\nconst PaginationPrevious = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to previous page\"\n    size=\"default\"\n    className={cn(\"gap-1 pl-2.5\", className)}\n    {...props}\n  >\n    <ChevronLeft className=\"h-4 w-4\" />\n    <span>Previous</span>\n  </PaginationLink>\n)\nPaginationPrevious.displayName = \"PaginationPrevious\"\n\nconst PaginationNext = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to next page\"\n    size=\"default\"\n    className={cn(\"gap-1 pr-2.5\", className)}\n    {...props}\n  >\n    <span>Next</span>\n    <ChevronRight className=\"h-4 w-4\" />\n  </PaginationLink>\n)\nPaginationNext.displayName = \"PaginationNext\"\n\nconst PaginationEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    aria-hidden\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More pages</span>\n  </span>\n)\nPaginationEllipsis.displayName = \"PaginationEllipsis\"\n\nexport {\n  Pagination,\n  PaginationContent,\n  PaginationEllipsis,\n  PaginationItem,\n  PaginationLink,\n  PaginationNext,\n  PaginationPrevious,\n}\n","path":null,"size_bytes":2751,"size_tokens":null},"client/src/pages/admin-dashboard.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Button } from \"@/components/ui/button\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Building2, Users, Briefcase, DollarSign, TrendingUp, CheckCircle2, Check, X, ArrowLeft, Banknote, Settings, Activity, MapPin, RefreshCw, Download } from \"lucide-react\";\nimport { AdminAnalytics, Company, Transaction, CompanyWithdrawal } from \"@shared/schema\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Link } from \"wouter\";\nimport { PaginationControls } from \"@/components/PaginationControls\";\n\ninterface CompanyFinancialSummary {\n  companyId: number;\n  companyName: string;\n  totalRevenue: number;\n  platformFees: number;\n  netEarnings: number;\n  totalWithdrawals: number;\n  availableBalance: number;\n}\n\ninterface JobFinancial {\n  id: number;\n  jobId: number;\n  cleanerId: number | null;\n  baseJobAmount: string;\n  baseTax: string;\n  tipAmount: string;\n  tipTax: string;\n  platformFeeAmount: string;\n  platformFeeTax: string;\n  paymentProcessingFeeAmount: string;\n  companyStripeFeeShare: string;\n  cleanerStripeFeeShare: string;\n  remainingTip: string;\n  grossAmount: string;\n  netPayableAmount: string;\n  taxAmount: string;\n  paidAt: Date;\n  refundedAt: Date | null;\n  cleanerName: string | null;\n  cleanerEmail: string | null;\n  cleanerPhone: string | null;\n  feePackageType: string | null;\n  receiptNumber: string | null;\n  stripePaymentIntentId: string | null;\n  stripeRefundId: string | null;\n  jobStatus: string | null;\n}\n\nfunction FinancialsTab() {\n  const { toast } = useToast();\n  const [selectedCompany, setSelectedCompany] = useState<number | null>(null);\n  const [page, setPage] = useState(1);\n  const [withdrawalDialogOpen, setWithdrawalDialogOpen] = useState(false);\n  const [selectedWithdrawal, setSelectedWithdrawal] = useState<CompanyWithdrawal | null>(null);\n  const [referenceNumber, setReferenceNumber] = useState(\"\");\n  const [note, setNote] = useState(\"\");\n  const [status, setStatus] = useState<'completed' | 'cancelled'>('completed');\n  const [feeStructureDialogOpen, setFeeStructureDialogOpen] = useState(false);\n  const [editFeePackageType, setEditFeePackageType] = useState(\"custom\");\n  const [editPlatformFee, setEditPlatformFee] = useState(\"3.00\");\n\n  const pageSize = 20;\n\n  const { data: companies, isLoading: loadingCompanies } = useQuery<CompanyFinancialSummary[]>({\n    queryKey: [\"/api/admin/financials/companies\"],\n  });\n\n  const { data: companyDetails, isLoading: loadingDetails } = useQuery({\n    queryKey: [\"/api/admin/financials/company\", selectedCompany, page],\n    queryFn: async () => {\n      const params = new URLSearchParams({\n        page: page.toString(),\n        pageSize: pageSize.toString(),\n      });\n      const response = await fetch(`/api/admin/financials/company/${selectedCompany}?${params}`);\n      if (!response.ok) throw new Error('Failed to fetch company details');\n      return response.json();\n    },\n    enabled: !!selectedCompany,\n  });\n\n  useEffect(() => {\n    setPage(1);\n  }, [selectedCompany]);\n\n  const processWithdrawalMutation = useMutation({\n    mutationFn: async (data: { id: number; status: string; referenceNumber?: string; note?: string }) => {\n      return await apiRequest(\"PATCH\", `/api/admin/financials/withdrawals/${data.id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/financials/companies\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/financials/company\", selectedCompany, page] });\n      setWithdrawalDialogOpen(false);\n      setSelectedWithdrawal(null);\n      setReferenceNumber(\"\");\n      setNote(\"\");\n      toast({\n        title: \"Withdrawal Processed\",\n        description: \"The withdrawal has been updated successfully.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateFeeStructureMutation = useMutation({\n    mutationFn: async (data: { platformFee: number; feePackageType: string }) => {\n      return await apiRequest(\"PATCH\", `/api/admin/company/${selectedCompany}/fee-structure`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/financials/companies\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/financials/company\", selectedCompany, page] });\n      setFeeStructureDialogOpen(false);\n      setEditPlatformFee(\"3.00\");\n      setEditFeePackageType(\"custom\");\n      toast({\n        title: \"Fee Structure Updated\",\n        description: \"The company's fee structure has been updated successfully.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  if (selectedCompany && companyDetails) {\n    const jobs = companyDetails.jobs || [];\n    const jobsTotal = companyDetails.jobsTotal || 0;\n    const totalPages = Math.ceil(jobsTotal / pageSize);\n\n    return (\n      <div className=\"space-y-4\">\n        <div className=\"flex justify-between items-center\">\n          <Button variant=\"ghost\" onClick={() => setSelectedCompany(null)} data-testid=\"button-back-to-companies\">\n            <ArrowLeft className=\"h-4 w-4 mr-2\" />\n            Back to Companies\n          </Button>\n          <Button\n            variant=\"outline\"\n            onClick={() => {\n              const company = companies?.find(c => c.companyId === selectedCompany);\n              if (company) {\n                // Fetch company details to get current fee structure\n                fetch(`/api/companies/${selectedCompany}`)\n                  .then(res => res.json())\n                  .then(data => {\n                    setEditFeePackageType(data.feePackageType || \"custom\");\n                    setEditPlatformFee(data.platformFee || \"3.00\");\n                    setFeeStructureDialogOpen(true);\n                  });\n              }\n            }}\n            data-testid=\"button-edit-fee-structure\"\n          >\n            Edit Fee Structure\n          </Button>\n        </div>\n\n        <div className=\"grid gap-4 md:grid-cols-4\">\n          <Card data-testid=\"card-total-revenue\">\n            <CardHeader className=\"pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Total Revenue</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\">{companyDetails.summary.totalRevenue.toFixed(2)} AED</div>\n            </CardContent>\n          </Card>\n          <Card data-testid=\"card-platform-fees\">\n            <CardHeader className=\"pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Platform Fees</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\">{companyDetails.summary.platformFees.toFixed(2)} AED</div>\n            </CardContent>\n          </Card>\n          <Card data-testid=\"card-net-earnings\">\n            <CardHeader className=\"pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Net Earnings</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\">{companyDetails.summary.netEarnings.toFixed(2)} AED</div>\n            </CardContent>\n          </Card>\n          <Card data-testid=\"card-available-balance\">\n            <CardHeader className=\"pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Available Balance</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\">{companyDetails.summary.availableBalance.toFixed(2)} AED</div>\n            </CardContent>\n          </Card>\n        </div>\n\n        <Card>\n          <CardHeader>\n            <CardTitle>Withdrawals</CardTitle>\n            <CardDescription>Company withdrawal history</CardDescription>\n          </CardHeader>\n          <CardContent>\n            {companyDetails.withdrawals.length > 0 ? (\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead>Amount</TableHead>\n                    <TableHead>Status</TableHead>\n                    <TableHead>Reference</TableHead>\n                    <TableHead>Created</TableHead>\n                    <TableHead className=\"text-right\">Actions</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {companyDetails.withdrawals.map((withdrawal: CompanyWithdrawal) => (\n                    <TableRow key={withdrawal.id} data-testid={`withdrawal-${withdrawal.id}`}>\n                      <TableCell className=\"font-medium\">{Number(withdrawal.amount).toFixed(2)} AED</TableCell>\n                      <TableCell>\n                        <span className={`inline-block px-2 py-1 text-xs rounded-full ${\n                          withdrawal.status === 'completed' ? 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-100' :\n                          withdrawal.status === 'pending' ? 'bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-100' :\n                          'bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-100'\n                        }`}>\n                          {withdrawal.status}\n                        </span>\n                      </TableCell>\n                      <TableCell className=\"text-sm\">{withdrawal.referenceNumber || \"—\"}</TableCell>\n                      <TableCell className=\"text-sm\">{new Date(withdrawal.createdAt).toLocaleDateString('en-AE', { year: 'numeric', month: 'short', day: 'numeric', timeZone: 'Asia/Dubai' })}</TableCell>\n                      <TableCell className=\"text-right\">\n                        {withdrawal.status === 'pending' && (\n                          <Button\n                            size=\"sm\"\n                            onClick={() => {\n                              setSelectedWithdrawal(withdrawal);\n                              setWithdrawalDialogOpen(true);\n                            }}\n                            data-testid={`button-process-${withdrawal.id}`}\n                          >\n                            Process\n                          </Button>\n                        )}\n                      </TableCell>\n                    </TableRow>\n                  ))}\n                </TableBody>\n              </Table>\n            ) : (\n              <p className=\"text-center text-muted-foreground py-8\">No withdrawals yet</p>\n            )}\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle>Job History</CardTitle>\n            <CardDescription>All job financials for this company</CardDescription>\n          </CardHeader>\n          <CardContent>\n            {loadingDetails ? (\n              <p className=\"text-center text-muted-foreground py-8\">Loading job history...</p>\n            ) : jobs && jobs.length > 0 ? (\n              <div className=\"space-y-4\">\n                <div className=\"overflow-x-auto\">\n                  <Table>\n                    <TableHeader>\n                      <TableRow>\n                        <TableHead>Job ID</TableHead>\n                        <TableHead>Status</TableHead>\n                        <TableHead>Receipt #</TableHead>\n                        <TableHead>Stripe Ref</TableHead>\n                        <TableHead>Cleaner</TableHead>\n                        <TableHead>Base Amount</TableHead>\n                        <TableHead>Base Tax</TableHead>\n                        <TableHead>Total Tip</TableHead>\n                        <TableHead>Tip VAT</TableHead>\n                        <TableHead>Remaining Tip</TableHead>\n                        <TableHead>Platform Fee</TableHead>\n                        <TableHead>Platform Tax</TableHead>\n                        <TableHead>Stripe Fee</TableHead>\n                        <TableHead>Gross</TableHead>\n                        <TableHead>Net</TableHead>\n                        <TableHead>Date</TableHead>\n                        <TableHead>Actions</TableHead>\n                      </TableRow>\n                    </TableHeader>\n                    <TableBody>\n                      {jobs.map((job: JobFinancial) => {\n                        const isRefunded = job.refundedAt !== null;\n                        const isPackage2 = (job.feePackageType || 'custom').toLowerCase() === 'package2';\n                        const tipAmount = parseFloat(job.tipAmount || \"0\");\n                        const tipTax = parseFloat(job.tipTax || \"0\");\n                        const totalTip = tipAmount + tipTax;\n                        const remainingTip = parseFloat(job.remainingTip || \"0\");\n                        const hasTip = totalTip > 0;\n                        \n                        const statusDisplay = job.jobStatus === 'refunded_unattended' ? 'Refunded (Unattended)' :\n                                            job.jobStatus === 'refunded' ? 'Refunded (Manual)' :\n                                            job.jobStatus?.toUpperCase() || 'N/A';\n                        const statusColor = job.jobStatus?.includes('refunded') ? 'text-red-600 dark:text-red-400' : \n                                          job.jobStatus === 'completed' ? 'text-green-600 dark:text-green-400' :\n                                          'text-muted-foreground';\n                        \n                        return (\n                          <TableRow key={job.id} data-testid={`job-${job.id}`}>\n                            <TableCell className=\"font-medium\">#{job.jobId}</TableCell>\n                            <TableCell className={`min-w-[120px] ${statusColor}`}>{statusDisplay}</TableCell>\n                            <TableCell className=\"font-mono text-xs min-w-[150px]\">{job.receiptNumber || '-'}</TableCell>\n                            <TableCell className=\"font-mono text-xs min-w-[180px]\">\n                              <div className=\"flex flex-col gap-1\">\n                                {job.stripePaymentIntentId && (\n                                  <div className=\"text-green-600 dark:text-green-400\" title=\"Payment Intent ID\">\n                                    Pay: {job.stripePaymentIntentId.substring(0, 20)}...\n                                  </div>\n                                )}\n                                {job.stripeRefundId && (\n                                  <div className=\"text-red-600 dark:text-red-400\" title=\"Refund ID\">\n                                    Ref: {job.stripeRefundId.substring(0, 20)}...\n                                  </div>\n                                )}\n                                {!job.stripePaymentIntentId && !job.stripeRefundId && '-'}\n                              </div>\n                            </TableCell>\n                            <TableCell className=\"min-w-[120px]\">{job.cleanerName || \"Unassigned\"}</TableCell>\n                            <TableCell className=\"min-w-[100px]\">{parseFloat(job.baseJobAmount || \"0\").toFixed(2)} AED</TableCell>\n                            <TableCell className=\"min-w-[80px]\">{parseFloat(job.baseTax || \"0\").toFixed(2)} AED</TableCell>\n                            <TableCell className=\"text-primary font-medium min-w-[100px]\">\n                              {hasTip ? `${totalTip.toFixed(2)} AED` : \"-\"}\n                            </TableCell>\n                            <TableCell className=\"min-w-[80px]\">\n                              {hasTip ? `${tipTax.toFixed(2)} AED` : \"-\"}\n                            </TableCell>\n                            <TableCell className=\"text-green-600 dark:text-green-400 font-medium min-w-[120px]\">\n                              {hasTip ? `${remainingTip.toFixed(2)} AED` : \"-\"}\n                            </TableCell>\n                            <TableCell className=\"min-w-[110px]\">{parseFloat(job.platformFeeAmount || \"0\").toFixed(2)} AED</TableCell>\n                            <TableCell className=\"min-w-[100px]\">{parseFloat(job.platformFeeTax || \"0\").toFixed(2)} AED</TableCell>\n                            <TableCell className=\"min-w-[100px]\">\n                              {isPackage2 ? `${parseFloat(job.paymentProcessingFeeAmount || \"0\").toFixed(2)} AED` : \"-\"}\n                            </TableCell>\n                            <TableCell className=\"font-medium min-w-[100px]\">{parseFloat(job.grossAmount || \"0\").toFixed(2)} AED</TableCell>\n                            <TableCell className={`font-medium min-w-[100px] ${isRefunded ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400'}`}>\n                              {parseFloat(job.netPayableAmount || \"0\").toFixed(2)} AED\n                            </TableCell>\n                            <TableCell className=\"text-sm min-w-[100px]\">{new Date(job.paidAt).toLocaleDateString('en-AE', { year: 'numeric', month: 'short', day: 'numeric', timeZone: 'Asia/Dubai' })}</TableCell>\n                            <TableCell className=\"min-w-[80px]\">\n                              {job.receiptNumber ? (\n                                <Button\n                                  variant=\"ghost\"\n                                  size=\"icon\"\n                                  onClick={() => window.open(`/api/admin/receipt/${job.jobId}`, '_blank')}\n                                  title=\"Download Receipt\"\n                                  data-testid={`button-download-receipt-${job.jobId}`}\n                                >\n                                  <Download className=\"h-4 w-4\" />\n                                </Button>\n                              ) : (\n                                <span className=\"text-muted-foreground\">-</span>\n                              )}\n                            </TableCell>\n                          </TableRow>\n                        );\n                      })}\n                    </TableBody>\n                  </Table>\n                </div>\n                <PaginationControls\n                  currentPage={page}\n                  totalPages={totalPages}\n                  onPageChange={setPage}\n                />\n              </div>\n            ) : (\n              <p className=\"text-center text-muted-foreground py-8\">No job history available</p>\n            )}\n          </CardContent>\n        </Card>\n\n        <Dialog open={withdrawalDialogOpen} onOpenChange={setWithdrawalDialogOpen}>\n          <DialogContent data-testid=\"dialog-process-withdrawal\">\n            <DialogHeader>\n              <DialogTitle>Process Withdrawal</DialogTitle>\n              <DialogDescription>\n                Update the status of this withdrawal request\n              </DialogDescription>\n            </DialogHeader>\n            <div className=\"space-y-4 pt-4\">\n              <div>\n                <Label htmlFor=\"amount\">Amount</Label>\n                <Input\n                  id=\"amount\"\n                  value={`${Number(selectedWithdrawal?.amount || 0).toFixed(2)} AED`}\n                  disabled\n                  data-testid=\"input-amount\"\n                />\n              </div>\n              <div>\n                <Label htmlFor=\"status\">Status</Label>\n                <Select value={status} onValueChange={(v) => setStatus(v as 'completed' | 'cancelled')}>\n                  <SelectTrigger id=\"status\" data-testid=\"select-status\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"completed\">Completed</SelectItem>\n                    <SelectItem value=\"cancelled\">Cancelled</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n              <div>\n                <Label htmlFor=\"reference\">Reference Number</Label>\n                <Input\n                  id=\"reference\"\n                  placeholder=\"Bank transfer reference\"\n                  value={referenceNumber}\n                  onChange={(e) => setReferenceNumber(e.target.value)}\n                  data-testid=\"input-reference\"\n                />\n              </div>\n              <div>\n                <Label htmlFor=\"note\">Note</Label>\n                <Textarea\n                  id=\"note\"\n                  placeholder=\"Optional note\"\n                  value={note}\n                  onChange={(e) => setNote(e.target.value)}\n                  data-testid=\"textarea-note\"\n                />\n              </div>\n              <Button\n                className=\"w-full\"\n                onClick={() => {\n                  if (selectedWithdrawal) {\n                    processWithdrawalMutation.mutate({\n                      id: selectedWithdrawal.id,\n                      status,\n                      referenceNumber: referenceNumber || undefined,\n                      note: note || undefined,\n                    });\n                  }\n                }}\n                disabled={processWithdrawalMutation.isPending}\n                data-testid=\"button-submit-withdrawal\"\n              >\n                Update Withdrawal\n              </Button>\n            </div>\n          </DialogContent>\n        </Dialog>\n\n        <Dialog open={feeStructureDialogOpen} onOpenChange={setFeeStructureDialogOpen}>\n          <DialogContent data-testid=\"dialog-edit-fee-structure\">\n            <DialogHeader>\n              <DialogTitle>Edit Fee Structure</DialogTitle>\n              <DialogDescription>\n                Update the company's pricing package and platform fee\n              </DialogDescription>\n            </DialogHeader>\n            <div className=\"space-y-4 pt-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"edit-feePackageType\">Fee Package</Label>\n                <Select value={editFeePackageType} onValueChange={setEditFeePackageType}>\n                  <SelectTrigger data-testid=\"select-edit-fee-package\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"custom\">Custom Fee</SelectItem>\n                    <SelectItem value=\"package1\">Package 1 (2 AED + 5% of wash)</SelectItem>\n                    <SelectItem value=\"package2\">Package 2 (Offline - No platform fees)</SelectItem>\n                  </SelectContent>\n                </Select>\n                <p className=\"text-sm text-muted-foreground\">\n                  {editFeePackageType === \"custom\" && \"Set a custom platform fee per wash\"}\n                  {editFeePackageType === \"package1\" && \"2 AED base + 5% of car wash price + 5% VAT\"}\n                  {editFeePackageType === \"package2\" && \"Offline mode - Car wash price + VAT only (no platform fees)\"}\n                </p>\n              </div>\n\n              {editFeePackageType === \"custom\" && (\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"edit-platformFee\">Custom Platform Fee (AED per wash)</Label>\n                  <Input\n                    id=\"edit-platformFee\"\n                    type=\"number\"\n                    step=\"0.01\"\n                    min=\"0.01\"\n                    value={editPlatformFee}\n                    onChange={(e) => setEditPlatformFee(e.target.value)}\n                    placeholder=\"3.00\"\n                    data-testid=\"input-edit-platform-fee\"\n                  />\n                  <p className=\"text-sm text-muted-foreground\">\n                    Flat fee charged to customers per wash (in addition to company's base price and 5% VAT).\n                  </p>\n                </div>\n              )}\n\n              <div className=\"flex justify-end space-x-2\">\n                <Button\n                  variant=\"outline\"\n                  onClick={() => setFeeStructureDialogOpen(false)}\n                  disabled={updateFeeStructureMutation.isPending}\n                  data-testid=\"button-cancel-fee-structure\"\n                >\n                  Cancel\n                </Button>\n                <Button\n                  onClick={() => {\n                    let feeToApply = 0;\n                    if (editFeePackageType === \"custom\") {\n                      feeToApply = parseFloat(editPlatformFee);\n                    } else if (editFeePackageType === \"package1\") {\n                      feeToApply = 2;\n                    }\n                    \n                    updateFeeStructureMutation.mutate({\n                      platformFee: feeToApply,\n                      feePackageType: editFeePackageType,\n                    });\n                  }}\n                  disabled={\n                    updateFeeStructureMutation.isPending || \n                    (editFeePackageType === \"custom\" && (!editPlatformFee || parseFloat(editPlatformFee) <= 0))\n                  }\n                  data-testid=\"button-confirm-fee-structure\"\n                >\n                  {updateFeeStructureMutation.isPending ? \"Updating...\" : \"Update Fee Structure\"}\n                </Button>\n              </div>\n            </div>\n          </DialogContent>\n        </Dialog>\n      </div>\n    );\n  }\n\n  return (\n    <Card>\n      <CardHeader>\n        <CardTitle>Company Financials</CardTitle>\n        <CardDescription>View and manage company financial data</CardDescription>\n      </CardHeader>\n      <CardContent>\n        {loadingCompanies ? (\n          <div className=\"space-y-4\">\n            {[1, 2, 3].map((i) => (\n              <Skeleton key={i} className=\"h-16 w-full\" />\n            ))}\n          </div>\n        ) : companies && companies.length > 0 ? (\n          <Table>\n            <TableHeader>\n              <TableRow>\n                <TableHead>Company</TableHead>\n                <TableHead>Revenue</TableHead>\n                <TableHead>Platform Fees</TableHead>\n                <TableHead>Net Earnings</TableHead>\n                <TableHead>Withdrawals</TableHead>\n                <TableHead>Balance</TableHead>\n                <TableHead className=\"text-right\">Actions</TableHead>\n              </TableRow>\n            </TableHeader>\n            <TableBody>\n              {companies.map((company) => (\n                <TableRow key={company.companyId} data-testid={`company-${company.companyId}`}>\n                  <TableCell className=\"font-medium\">{company.companyName}</TableCell>\n                  <TableCell>{company.totalRevenue.toFixed(2)} AED</TableCell>\n                  <TableCell>{company.platformFees.toFixed(2)} AED</TableCell>\n                  <TableCell>{company.netEarnings.toFixed(2)} AED</TableCell>\n                  <TableCell>{company.totalWithdrawals.toFixed(2)} AED</TableCell>\n                  <TableCell className=\"font-medium\">{company.availableBalance.toFixed(2)} AED</TableCell>\n                  <TableCell className=\"text-right\">\n                    <div className=\"flex justify-end\">\n                      <Button\n                        size=\"sm\"\n                        variant=\"outline\"\n                        onClick={() => setSelectedCompany(company.companyId)}\n                        data-testid={`button-view-${company.companyId}`}\n                        className=\"pointer-events-auto\"\n                      >\n                        View Details\n                      </Button>\n                    </div>\n                  </TableCell>\n                </TableRow>\n              ))}\n            </TableBody>\n          </Table>\n        ) : (\n          <p className=\"text-center text-muted-foreground py-8\">No financial data available</p>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n\nfunction AnalyticsTab() {\n  const { toast } = useToast();\n  const [approvalDialogOpen, setApprovalDialogOpen] = useState(false);\n  const [selectedCompanyForApproval, setSelectedCompanyForApproval] = useState<Company | null>(null);\n  const [platformFee, setPlatformFee] = useState(\"3.00\");\n  const [feePackageType, setFeePackageType] = useState(\"custom\");\n  \n  const { data: analytics, isLoading } = useQuery<AdminAnalytics>({\n    queryKey: [\"/api/admin/analytics\"],\n  });\n\n  const { data: pendingCompanies, isLoading: isLoadingPending } = useQuery<Company[]>({\n    queryKey: [\"/api/admin/pending-companies\"],\n  });\n\n  const approveMutation = useMutation({\n    mutationFn: async (data: { companyId: number; platformFee: number; feePackageType: string }) => {\n      return await apiRequest(\"POST\", `/api/admin/approve-company/${data.companyId}`, {\n        platformFee: data.platformFee,\n        feePackageType: data.feePackageType,\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/pending-companies\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/analytics\"] });\n      setApprovalDialogOpen(false);\n      setSelectedCompanyForApproval(null);\n      setPlatformFee(\"3.00\");\n      setFeePackageType(\"custom\");\n      toast({\n        title: \"Company Approved\",\n        description: \"The company has been approved and is now active.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const rejectMutation = useMutation({\n    mutationFn: async (companyId: number) => {\n      return await apiRequest(\"POST\", `/api/admin/reject-company/${companyId}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/pending-companies\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/analytics\"] });\n      toast({\n        title: \"Company Rejected\",\n        description: \"The company has been rejected.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  if (isLoading || !analytics) {\n    return (\n      <div className=\"space-y-4\">\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n          {[1, 2, 3, 4, 5, 6].map((i) => (\n            <Card key={i}>\n              <CardHeader>\n                <Skeleton className=\"h-4 w-24\" />\n              </CardHeader>\n              <CardContent>\n                <Skeleton className=\"h-8 w-32\" />\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      </div>\n    );\n  }\n\n  const metrics = [\n    { title: \"Total Companies\", value: analytics.totalCompanies, icon: Building2, description: \"Registered companies\" },\n    { title: \"Total Cleaners\", value: analytics.totalCleaners, icon: Users, description: \"Active cleaners\" },\n    { title: \"Active Jobs\", value: analytics.activeJobs, icon: Briefcase, description: \"Currently ongoing\" },\n    { title: \"Completed Jobs\", value: analytics.completedJobs, icon: CheckCircle2, description: \"All time\" },\n    { title: \"Total Revenue\", value: `${analytics.totalRevenue.toLocaleString()} AED`, icon: DollarSign, description: \"All time\" },\n    { title: \"Revenue This Month\", value: `${analytics.revenueThisMonth.toLocaleString()} AED`, icon: TrendingUp, description: \"Current month\" },\n  ];\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n        {metrics.map((metric) => {\n          const Icon = metric.icon;\n          return (\n            <Card key={metric.title} data-testid={`metric-${metric.title.toLowerCase().replace(/\\s+/g, '-')}`}>\n              <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n                <CardTitle className=\"text-sm font-medium\">{metric.title}</CardTitle>\n                <Icon className=\"h-4 w-4 text-muted-foreground\" />\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold\">{metric.value}</div>\n                <p className=\"text-xs text-muted-foreground mt-1\">{metric.description}</p>\n              </CardContent>\n            </Card>\n          );\n        })}\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Pending Company Approvals</CardTitle>\n          <CardDescription>Review and approve new company registrations</CardDescription>\n        </CardHeader>\n        <CardContent>\n          {isLoadingPending ? (\n            <div className=\"space-y-4\">\n              {[1, 2, 3].map((i) => (\n                <Skeleton key={i} className=\"h-16 w-full\" />\n              ))}\n            </div>\n          ) : pendingCompanies && pendingCompanies.length > 0 ? (\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>Company Name</TableHead>\n                  <TableHead>Package</TableHead>\n                  <TableHead>Price/Wash</TableHead>\n                  <TableHead>License</TableHead>\n                  <TableHead className=\"text-right\">Actions</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {pendingCompanies.map((company) => (\n                  <TableRow key={company.id} data-testid={`pending-company-${company.id}`}>\n                    <TableCell className=\"font-medium\">{company.name}</TableCell>\n                    <TableCell className=\"text-muted-foreground\">\n                      {company.packageType === 'subscription' \n                        ? `Subscription (${company.subscriptionCleanerSlots} slots)` \n                        : 'Pay Per Wash'}\n                    </TableCell>\n                    <TableCell>{company.pricePerWash} AED</TableCell>\n                    <TableCell className=\"text-sm\">{company.tradeLicenseNumber || \"N/A\"}</TableCell>\n                    <TableCell className=\"text-right space-x-2\">\n                      <Button\n                        size=\"sm\"\n                        variant=\"default\"\n                        onClick={() => {\n                          setSelectedCompanyForApproval(company);\n                          setPlatformFee(\"3.00\");\n                          setFeePackageType(\"custom\");\n                          setApprovalDialogOpen(true);\n                        }}\n                        disabled={approveMutation.isPending || rejectMutation.isPending}\n                        data-testid={`button-approve-${company.id}`}\n                      >\n                        <Check className=\"h-4 w-4 mr-1\" />\n                        Approve\n                      </Button>\n                      <Button\n                        size=\"sm\"\n                        variant=\"destructive\"\n                        onClick={() => rejectMutation.mutate(company.id)}\n                        disabled={approveMutation.isPending || rejectMutation.isPending}\n                        data-testid={`button-reject-${company.id}`}\n                      >\n                        <X className=\"h-4 w-4 mr-1\" />\n                        Reject\n                      </Button>\n                    </TableCell>\n                  </TableRow>\n                ))}\n              </TableBody>\n            </Table>\n          ) : (\n            <p className=\"text-center text-muted-foreground py-8\">No pending companies to review</p>\n          )}\n        </CardContent>\n      </Card>\n      \n      {/* Approval Dialog with Platform Fee */}\n      <Dialog open={approvalDialogOpen} onOpenChange={setApprovalDialogOpen}>\n        <DialogContent data-testid=\"dialog-approve-company\">\n          <DialogHeader>\n            <DialogTitle>Approve Company</DialogTitle>\n            <DialogDescription>\n              Review and approve {selectedCompanyForApproval?.name}\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div className=\"space-y-3 p-4 bg-muted/50 rounded-lg\">\n              <div className=\"flex justify-between\">\n                <span className=\"text-sm font-medium\">Company Name:</span>\n                <span className=\"text-sm text-muted-foreground\">{selectedCompanyForApproval?.name}</span>\n              </div>\n              <div className=\"flex justify-between\">\n                <span className=\"text-sm font-medium\">Package Type:</span>\n                <span className=\"text-sm text-muted-foreground\">\n                  {selectedCompanyForApproval?.packageType === 'subscription' ? 'Monthly Subscription' : 'Pay Per Wash'}\n                </span>\n              </div>\n              {selectedCompanyForApproval?.packageType === 'subscription' && (\n                <>\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-sm font-medium\">Cleaner Slots:</span>\n                    <span className=\"text-sm text-muted-foreground\">{selectedCompanyForApproval.subscriptionCleanerSlots}</span>\n                  </div>\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-sm font-medium\">Monthly Fee:</span>\n                    <span className=\"text-sm font-bold text-primary\">\n                      {((selectedCompanyForApproval.subscriptionCleanerSlots || 0) / 10 * 500).toFixed(2)} AED\n                    </span>\n                  </div>\n                </>\n              )}\n              <div className=\"flex justify-between\">\n                <span className=\"text-sm font-medium\">Price Per Wash:</span>\n                <span className=\"text-sm text-muted-foreground\">{selectedCompanyForApproval?.pricePerWash} AED</span>\n              </div>\n            </div>\n            \n            <div className=\"space-y-2\">\n              <Label htmlFor=\"feePackageType\">Fee Package</Label>\n              <Select value={feePackageType} onValueChange={setFeePackageType}>\n                <SelectTrigger data-testid=\"select-fee-package\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"custom\">Custom Fee</SelectItem>\n                  <SelectItem value=\"package1\">Package 1 (2 AED + 5% of wash)</SelectItem>\n                  <SelectItem value=\"package2\">Package 2 (Offline - No platform fees)</SelectItem>\n                </SelectContent>\n              </Select>\n              <p className=\"text-sm text-muted-foreground\">\n                {feePackageType === \"custom\" && \"Set a custom platform fee per wash\"}\n                {feePackageType === \"package1\" && \"2 AED base + 5% of car wash price + 5% VAT\"}\n                {feePackageType === \"package2\" && \"Offline mode - Car wash price + VAT only (no platform fees)\"}\n              </p>\n            </div>\n\n            {feePackageType === \"custom\" && (\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"platformFee\">Custom Platform Fee (AED per wash)</Label>\n                <Input\n                  id=\"platformFee\"\n                  type=\"number\"\n                  step=\"0.01\"\n                  min=\"0.01\"\n                  value={platformFee}\n                  onChange={(e) => setPlatformFee(e.target.value)}\n                  placeholder=\"3.00\"\n                  data-testid=\"input-platform-fee\"\n                />\n                <p className=\"text-sm text-muted-foreground\">\n                  Flat fee charged to customers per wash (in addition to company's base price and 5% VAT).\n                </p>\n              </div>\n            )}\n            <div className=\"flex justify-end space-x-2\">\n              <Button\n                variant=\"outline\"\n                onClick={() => setApprovalDialogOpen(false)}\n                disabled={approveMutation.isPending}\n                data-testid=\"button-cancel-approval\"\n              >\n                Cancel\n              </Button>\n              <Button\n                onClick={() => {\n                  if (selectedCompanyForApproval) {\n                    let feeToApply = 0;\n                    if (feePackageType === \"custom\") {\n                      feeToApply = parseFloat(platformFee);\n                    } else if (feePackageType === \"package1\") {\n                      feeToApply = 2; // Base fee for package1, actual calculation done by fee-calculator\n                    }\n                    \n                    approveMutation.mutate({\n                      companyId: selectedCompanyForApproval.id,\n                      platformFee: feeToApply,\n                      feePackageType,\n                    });\n                  }\n                }}\n                disabled={\n                  approveMutation.isPending || \n                  (feePackageType === \"custom\" && (!platformFee || parseFloat(platformFee) <= 0))\n                }\n                data-testid=\"button-confirm-approval\"\n              >\n                {approveMutation.isPending ? \"Approving...\" : \"Approve Company\"}\n              </Button>\n            </div>\n          </div>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n\ninterface LiveReportData {\n  liveCleaners: number;\n  activeLocations: number;\n  revenueToday: number;\n  tipsToday: number;\n  netToday: number;\n  completedJobsToday: number;\n  refundedJobsToday: number;\n  pendingJobsToday: number;\n  cleanerDetails: Array<{\n    id: number;\n    name: string;\n    email: string;\n    status: string;\n    currentLocation: { lat: number; lng: number } | null;\n    lastLocationUpdate: Date | null;\n    jobsCompletedToday: number;\n  }>;\n}\n\nfunction LiveReportTab() {\n  const [selectedCompany, setSelectedCompany] = useState<number | null>(null);\n  const [autoRefresh, setAutoRefresh] = useState(false);\n\n  const { data: companies, isLoading: loadingCompanies } = useQuery<{ id: number; name: string }[]>({\n    queryKey: [\"/api/admin/companies\"],\n  });\n\n  const { data: liveReport, isLoading: loadingReport, refetch } = useQuery<LiveReportData>({\n    queryKey: [\"/api/admin/live-report\", selectedCompany],\n    queryFn: async () => {\n      const params = selectedCompany ? `?companyId=${selectedCompany}` : \"\";\n      const response = await fetch(`/api/admin/live-report${params}`);\n      if (!response.ok) throw new Error(\"Failed to fetch live report\");\n      return response.json();\n    },\n    refetchInterval: autoRefresh ? 30000 : false,\n  });\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between\">\n        <div className=\"flex items-center gap-4\">\n          <Select\n            value={selectedCompany?.toString() || \"all\"}\n            onValueChange={(val) => setSelectedCompany(val === \"all\" ? null : parseInt(val))}\n          >\n            <SelectTrigger className=\"w-[200px]\" data-testid=\"select-company-filter\">\n              <SelectValue placeholder=\"All Companies\" />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"all\">All Companies</SelectItem>\n              {companies?.map((company) => (\n                <SelectItem key={company.id} value={company.id.toString()}>\n                  {company.name}\n                </SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n        </div>\n        <div className=\"flex items-center gap-2\">\n          <Button\n            variant=\"outline\"\n            size=\"sm\"\n            onClick={() => refetch()}\n            data-testid=\"button-refresh-report\"\n          >\n            <RefreshCw className=\"h-4 w-4 mr-2\" />\n            Refresh\n          </Button>\n          <Button\n            variant={autoRefresh ? \"default\" : \"outline\"}\n            size=\"sm\"\n            onClick={() => setAutoRefresh(!autoRefresh)}\n            data-testid=\"button-auto-refresh\"\n          >\n            {autoRefresh ? \"Auto-Refresh ON\" : \"Auto-Refresh OFF\"}\n          </Button>\n        </div>\n      </div>\n\n      {loadingReport ? (\n        <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n          {[...Array(8)].map((_, i) => (\n            <Card key={i}>\n              <CardHeader className=\"p-4\">\n                <Skeleton className=\"h-4 w-20\" />\n                <Skeleton className=\"h-6 w-12 mt-2\" />\n              </CardHeader>\n            </Card>\n          ))}\n        </div>\n      ) : liveReport ? (\n        <>\n          <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n            <Card className=\"bg-gradient-to-br from-green-500/10 to-green-600/5 border-green-500/20\">\n              <CardHeader className=\"p-4\">\n                <CardDescription className=\"flex items-center gap-1\">\n                  <Activity className=\"h-4 w-4\" />\n                  Live Cleaners\n                </CardDescription>\n                <CardTitle className=\"text-2xl text-green-600 dark:text-green-400\" data-testid=\"text-live-cleaners\">\n                  {liveReport.liveCleaners}\n                </CardTitle>\n              </CardHeader>\n            </Card>\n            \n            <Card className=\"bg-gradient-to-br from-blue-500/10 to-blue-600/5 border-blue-500/20\">\n              <CardHeader className=\"p-4\">\n                <CardDescription className=\"flex items-center gap-1\">\n                  <MapPin className=\"h-4 w-4\" />\n                  Active Locations\n                </CardDescription>\n                <CardTitle className=\"text-2xl text-blue-600 dark:text-blue-400\" data-testid=\"text-active-locations\">\n                  {liveReport.activeLocations}\n                </CardTitle>\n              </CardHeader>\n            </Card>\n            \n            <Card className=\"bg-gradient-to-br from-emerald-500/10 to-emerald-600/5 border-emerald-500/20\">\n              <CardHeader className=\"p-4\">\n                <CardDescription className=\"flex items-center gap-1\">\n                  <DollarSign className=\"h-4 w-4\" />\n                  Revenue Today\n                </CardDescription>\n                <CardTitle className=\"text-2xl text-emerald-600 dark:text-emerald-400\" data-testid=\"text-revenue-today\">\n                  {liveReport.revenueToday.toFixed(2)} AED\n                </CardTitle>\n              </CardHeader>\n            </Card>\n            \n            <Card className=\"bg-gradient-to-br from-purple-500/10 to-purple-600/5 border-purple-500/20\">\n              <CardHeader className=\"p-4\">\n                <CardDescription className=\"flex items-center gap-1\">\n                  <DollarSign className=\"h-4 w-4\" />\n                  Net (excl. Tips)\n                </CardDescription>\n                <CardTitle className=\"text-2xl text-purple-600 dark:text-purple-400\" data-testid=\"text-net-today\">\n                  {liveReport.netToday.toFixed(2)} AED\n                </CardTitle>\n              </CardHeader>\n            </Card>\n            \n            <Card>\n              <CardHeader className=\"p-4\">\n                <CardDescription>Tips Today</CardDescription>\n                <CardTitle className=\"text-2xl\" data-testid=\"text-tips-today\">\n                  {liveReport.tipsToday.toFixed(2)} AED\n                </CardTitle>\n              </CardHeader>\n            </Card>\n            \n            <Card className=\"bg-gradient-to-br from-green-500/10 to-green-600/5 border-green-500/20\">\n              <CardHeader className=\"p-4\">\n                <CardDescription>Completed Jobs</CardDescription>\n                <CardTitle className=\"text-2xl text-green-600 dark:text-green-400\" data-testid=\"text-completed-jobs\">\n                  {liveReport.completedJobsToday}\n                </CardTitle>\n              </CardHeader>\n            </Card>\n            \n            <Card className=\"bg-gradient-to-br from-yellow-500/10 to-yellow-600/5 border-yellow-500/20\">\n              <CardHeader className=\"p-4\">\n                <CardDescription>Pending Jobs</CardDescription>\n                <CardTitle className=\"text-2xl text-yellow-600 dark:text-yellow-400\" data-testid=\"text-pending-jobs\">\n                  {liveReport.pendingJobsToday}\n                </CardTitle>\n              </CardHeader>\n            </Card>\n            \n            <Card className=\"bg-gradient-to-br from-red-500/10 to-red-600/5 border-red-500/20\">\n              <CardHeader className=\"p-4\">\n                <CardDescription>Refunded Jobs</CardDescription>\n                <CardTitle className=\"text-2xl text-red-600 dark:text-red-400\" data-testid=\"text-refunded-jobs\">\n                  {liveReport.refundedJobsToday}\n                </CardTitle>\n              </CardHeader>\n            </Card>\n          </div>\n\n          <Card>\n            <CardHeader>\n              <CardTitle>Cleaner Activity</CardTitle>\n              <CardDescription>Cleaners and their status today</CardDescription>\n            </CardHeader>\n            <CardContent>\n              {liveReport.cleanerDetails.length === 0 ? (\n                <p className=\"text-muted-foreground text-center py-4\">No cleaner data available</p>\n              ) : (\n                <Table>\n                  <TableHeader>\n                    <TableRow>\n                      <TableHead>Cleaner</TableHead>\n                      <TableHead>Status</TableHead>\n                      <TableHead>Jobs Today</TableHead>\n                      <TableHead>Last Location</TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {liveReport.cleanerDetails.map((cleaner) => (\n                      <TableRow key={cleaner.id} data-testid={`row-cleaner-${cleaner.id}`}>\n                        <TableCell>\n                          <div>\n                            <div className=\"font-medium\">{cleaner.name}</div>\n                            <div className=\"text-sm text-muted-foreground\">{cleaner.email}</div>\n                          </div>\n                        </TableCell>\n                        <TableCell>\n                          <span className={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${\n                            cleaner.status === 'on_duty' \n                              ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-100'\n                              : cleaner.status === 'busy'\n                              ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-100'\n                              : 'bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-100'\n                          }`}>\n                            {cleaner.status.replace('_', ' ')}\n                          </span>\n                        </TableCell>\n                        <TableCell>{cleaner.jobsCompletedToday}</TableCell>\n                        <TableCell>\n                          {cleaner.currentLocation ? (\n                            <a\n                              href={`https://www.google.com/maps?q=${cleaner.currentLocation.lat},${cleaner.currentLocation.lng}`}\n                              target=\"_blank\"\n                              rel=\"noopener noreferrer\"\n                              className=\"text-primary hover:underline\"\n                            >\n                              View Map\n                            </a>\n                          ) : (\n                            <span className=\"text-muted-foreground\">No location</span>\n                          )}\n                        </TableCell>\n                      </TableRow>\n                    ))}\n                  </TableBody>\n                </Table>\n              )}\n            </CardContent>\n          </Card>\n        </>\n      ) : (\n        <Card>\n          <CardContent className=\"p-8 text-center text-muted-foreground\">\n            Failed to load live report data\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n}\n\nexport default function AdminDashboard() {\n  return (\n    <div className=\"min-h-screen bg-background p-4 pb-20\">\n      <div className=\"max-w-6xl mx-auto\">\n        <div className=\"mb-6 pt-4 flex items-start justify-between gap-4\">\n          <div>\n            <h1 className=\"text-2xl font-bold text-foreground mb-1\">Admin Dashboard</h1>\n            <p className=\"text-muted-foreground\">Platform analytics and insights</p>\n          </div>\n          <Link href=\"/admin/settings\">\n            <Button variant=\"outline\" size=\"sm\" data-testid=\"button-admin-settings\">\n              <Settings className=\"h-4 w-4 mr-2\" />\n              Settings\n            </Button>\n          </Link>\n        </div>\n\n        <Tabs defaultValue=\"analytics\" className=\"space-y-6\" data-testid=\"tabs-admin\">\n          <TabsList className=\"grid w-full max-w-lg grid-cols-3\">\n            <TabsTrigger value=\"analytics\" data-testid=\"tab-analytics\">\n              <TrendingUp className=\"h-4 w-4 mr-2\" />\n              Analytics\n            </TabsTrigger>\n            <TabsTrigger value=\"live\" data-testid=\"tab-live\">\n              <Activity className=\"h-4 w-4 mr-2\" />\n              Live\n            </TabsTrigger>\n            <TabsTrigger value=\"financials\" data-testid=\"tab-financials\">\n              <Banknote className=\"h-4 w-4 mr-2\" />\n              Financials\n            </TabsTrigger>\n          </TabsList>\n\n          <TabsContent value=\"analytics\" className=\"space-y-4\">\n            <AnalyticsTab />\n          </TabsContent>\n\n          <TabsContent value=\"live\" className=\"space-y-4\">\n            <LiveReportTab />\n          </TabsContent>\n\n          <TabsContent value=\"financials\" className=\"space-y-4\">\n            <FinancialsTab />\n          </TabsContent>\n        </Tabs>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":53811,"size_tokens":null},"client/src/components/ui/sidebar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, VariantProps } from \"class-variance-authority\"\nimport { PanelLeftIcon } from \"lucide-react\"\n\nimport { useIsMobile } from \"@/hooks/use-mobile\"\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Separator } from \"@/components/ui/separator\"\nimport {\n  Sheet,\n  SheetContent,\n  SheetDescription,\n  SheetHeader,\n  SheetTitle,\n} from \"@/components/ui/sheet\"\nimport { Skeleton } from \"@/components/ui/skeleton\"\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\"\n\nconst SIDEBAR_COOKIE_NAME = \"sidebar_state\"\nconst SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7\nconst SIDEBAR_WIDTH = \"16rem\"\nconst SIDEBAR_WIDTH_MOBILE = \"18rem\"\nconst SIDEBAR_WIDTH_ICON = \"3rem\"\nconst SIDEBAR_KEYBOARD_SHORTCUT = \"b\"\n\ntype SidebarContextProps = {\n  state: \"expanded\" | \"collapsed\"\n  open: boolean\n  setOpen: (open: boolean) => void\n  openMobile: boolean\n  setOpenMobile: (open: boolean) => void\n  isMobile: boolean\n  toggleSidebar: () => void\n}\n\nconst SidebarContext = React.createContext<SidebarContextProps | null>(null)\n\nfunction useSidebar() {\n  const context = React.useContext(SidebarContext)\n  if (!context) {\n    throw new Error(\"useSidebar must be used within a SidebarProvider.\")\n  }\n\n  return context\n}\n\nfunction SidebarProvider({\n  defaultOpen = true,\n  open: openProp,\n  onOpenChange: setOpenProp,\n  className,\n  style,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  defaultOpen?: boolean\n  open?: boolean\n  onOpenChange?: (open: boolean) => void\n}) {\n  const isMobile = useIsMobile()\n  const [openMobile, setOpenMobile] = React.useState(false)\n\n  // This is the internal state of the sidebar.\n  // We use openProp and setOpenProp for control from outside the component.\n  const [_open, _setOpen] = React.useState(defaultOpen)\n  const open = openProp ?? _open\n  const setOpen = React.useCallback(\n    (value: boolean | ((value: boolean) => boolean)) => {\n      const openState = typeof value === \"function\" ? value(open) : value\n      if (setOpenProp) {\n        setOpenProp(openState)\n      } else {\n        _setOpen(openState)\n      }\n\n      // This sets the cookie to keep the sidebar state.\n      document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`\n    },\n    [setOpenProp, open]\n  )\n\n  // Helper to toggle the sidebar.\n  const toggleSidebar = React.useCallback(() => {\n    return isMobile ? setOpenMobile((open) => !open) : setOpen((open) => !open)\n  }, [isMobile, setOpen, setOpenMobile])\n\n  // Adds a keyboard shortcut to toggle the sidebar.\n  React.useEffect(() => {\n    const handleKeyDown = (event: KeyboardEvent) => {\n      if (\n        event.key === SIDEBAR_KEYBOARD_SHORTCUT &&\n        (event.metaKey || event.ctrlKey)\n      ) {\n        event.preventDefault()\n        toggleSidebar()\n      }\n    }\n\n    window.addEventListener(\"keydown\", handleKeyDown)\n    return () => window.removeEventListener(\"keydown\", handleKeyDown)\n  }, [toggleSidebar])\n\n  // We add a state so that we can do data-state=\"expanded\" or \"collapsed\".\n  // This makes it easier to style the sidebar with Tailwind classes.\n  const state = open ? \"expanded\" : \"collapsed\"\n\n  const contextValue = React.useMemo<SidebarContextProps>(\n    () => ({\n      state,\n      open,\n      setOpen,\n      isMobile,\n      openMobile,\n      setOpenMobile,\n      toggleSidebar,\n    }),\n    [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]\n  )\n\n  return (\n    <SidebarContext.Provider value={contextValue}>\n      <TooltipProvider delayDuration={0}>\n        <div\n          data-slot=\"sidebar-wrapper\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH,\n              \"--sidebar-width-icon\": SIDEBAR_WIDTH_ICON,\n              ...style,\n            } as React.CSSProperties\n          }\n          className={cn(\n            \"group/sidebar-wrapper has-data-[variant=inset]:bg-sidebar flex min-h-svh w-full\",\n            className\n          )}\n          {...props}\n        >\n          {children}\n        </div>\n      </TooltipProvider>\n    </SidebarContext.Provider>\n  )\n}\n\nfunction Sidebar({\n  side = \"left\",\n  variant = \"sidebar\",\n  collapsible = \"offcanvas\",\n  className,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  side?: \"left\" | \"right\"\n  variant?: \"sidebar\" | \"floating\" | \"inset\"\n  collapsible?: \"offcanvas\" | \"icon\" | \"none\"\n}) {\n  const { isMobile, state, openMobile, setOpenMobile } = useSidebar()\n\n  if (collapsible === \"none\") {\n    return (\n      <div\n        data-slot=\"sidebar\"\n        className={cn(\n          \"bg-sidebar text-sidebar-foreground flex h-full w-[var(--sidebar-width)] flex-col\",\n          className\n        )}\n        {...props}\n      >\n        {children}\n      </div>\n    )\n  }\n\n  if (isMobile) {\n    return (\n      <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>\n        <SheetContent\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar\"\n          data-mobile=\"true\"\n          className=\"bg-sidebar text-sidebar-foreground w-[var(--sidebar-width)] p-0 [&>button]:hidden\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH_MOBILE,\n            } as React.CSSProperties\n          }\n          side={side}\n        >\n          <SheetHeader className=\"sr-only\">\n            <SheetTitle>Sidebar</SheetTitle>\n            <SheetDescription>Displays the mobile sidebar.</SheetDescription>\n          </SheetHeader>\n          <div className=\"flex h-full w-full flex-col\">{children}</div>\n        </SheetContent>\n      </Sheet>\n    )\n  }\n\n  return (\n    <div\n      className=\"group peer text-sidebar-foreground hidden md:block\"\n      data-state={state}\n      data-collapsible={state === \"collapsed\" ? collapsible : \"\"}\n      data-variant={variant}\n      data-side={side}\n      data-slot=\"sidebar\"\n    >\n      {/* This is what handles the sidebar gap on desktop */}\n      <div\n        data-slot=\"sidebar-gap\"\n        className={cn(\n          \"relative w-[var(--sidebar-width)] bg-transparent transition-[width] duration-200 ease-linear\",\n          \"group-data-[collapsible=offcanvas]:w-0\",\n          \"group-data-[side=right]:rotate-180\",\n          variant === \"floating\" || variant === \"inset\"\n            ? \"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4))]\"\n            : \"group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)]\"\n        )}\n      />\n      <div\n        data-slot=\"sidebar-container\"\n        className={cn(\n          \"fixed inset-y-0 z-10 hidden h-svh w-[var(--sidebar-width)] transition-[left,right,width] duration-200 ease-linear md:flex\",\n          side === \"left\"\n            ? \"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]\"\n            : \"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]\",\n          // Adjust the padding for floating and inset variants.\n          variant === \"floating\" || variant === \"inset\"\n            ? \"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4)+2px)]\"\n            : \"group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)] group-data-[side=left]:border-r group-data-[side=right]:border-l\",\n          className\n        )}\n        {...props}\n      >\n        <div\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar-inner\"\n          className=\"bg-sidebar group-data-[variant=floating]:border-sidebar-border flex h-full w-full flex-col group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:shadow-sm\"\n        >\n          {children}\n        </div>\n      </div>\n    </div>\n  )\n}\n\nfunction SidebarTrigger({\n  className,\n  onClick,\n  ...props\n}: React.ComponentProps<typeof Button>) {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <Button\n      data-sidebar=\"trigger\"\n      data-slot=\"sidebar-trigger\"\n      variant=\"ghost\"\n      size=\"icon\"\n      className={cn(\"h-7 w-7\", className)}\n      onClick={(event) => {\n        onClick?.(event)\n        toggleSidebar()\n      }}\n      {...props}\n    >\n      <PanelLeftIcon />\n      <span className=\"sr-only\">Toggle Sidebar</span>\n    </Button>\n  )\n}\n\nfunction SidebarRail({ className, ...props }: React.ComponentProps<\"button\">) {\n  const { toggleSidebar } = useSidebar()\n\n  // Note: Tailwind v3.4 doesn't support \"in-\" selectors. So the rail won't work perfectly.\n  return (\n    <button\n      data-sidebar=\"rail\"\n      data-slot=\"sidebar-rail\"\n      aria-label=\"Toggle Sidebar\"\n      tabIndex={-1}\n      onClick={toggleSidebar}\n      title=\"Toggle Sidebar\"\n      className={cn(\n        \"hover:after:bg-sidebar-border absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear group-data-[side=left]:-right-4 group-data-[side=right]:left-0 after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] sm:flex\",\n        \"in-data-[side=left]:cursor-w-resize in-data-[side=right]:cursor-e-resize\",\n        \"[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize\",\n        \"hover:group-data-[collapsible=offcanvas]:bg-sidebar group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full\",\n        \"[[data-side=left][data-collapsible=offcanvas]_&]:-right-2\",\n        \"[[data-side=right][data-collapsible=offcanvas]_&]:-left-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInset({ className, ...props }: React.ComponentProps<\"main\">) {\n  return (\n    <main\n      data-slot=\"sidebar-inset\"\n      className={cn(\n        \"bg-background relative flex w-full flex-1 flex-col\",\n        \"md:peer-data-[variant=inset]:m-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow-sm md:peer-data-[variant=inset]:peer-data-[state=collapsed]:ml-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInput({\n  className,\n  ...props\n}: React.ComponentProps<typeof Input>) {\n  return (\n    <Input\n      data-slot=\"sidebar-input\"\n      data-sidebar=\"input\"\n      className={cn(\"bg-background h-8 w-full shadow-none\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarHeader({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-header\"\n      data-sidebar=\"header\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarFooter({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-footer\"\n      data-sidebar=\"footer\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarSeparator({\n  className,\n  ...props\n}: React.ComponentProps<typeof Separator>) {\n  return (\n    <Separator\n      data-slot=\"sidebar-separator\"\n      data-sidebar=\"separator\"\n      className={cn(\"bg-sidebar-border mx-2 w-auto\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarContent({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-content\"\n      data-sidebar=\"content\"\n      className={cn(\n        \"flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroup({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group\"\n      data-sidebar=\"group\"\n      className={cn(\"relative flex w-full min-w-0 flex-col p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupLabel({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"div\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"div\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-label\"\n      data-sidebar=\"group-label\"\n      className={cn(\n        \"text-sidebar-foreground/70 ring-sidebar-ring flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium outline-hidden transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:h-4 [&>svg]:w-4 [&>svg]:shrink-0\",\n        \"group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupAction({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"button\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-action\"\n      data-sidebar=\"group-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground absolute top-3.5 right-3 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupContent({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group-content\"\n      data-sidebar=\"group-content\"\n      className={cn(\"w-full text-sm\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenu({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu\"\n      data-sidebar=\"menu\"\n      className={cn(\"flex w-full min-w-0 flex-col gap-1\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuItem({ className, ...props }: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-item\"\n      data-sidebar=\"menu-item\"\n      className={cn(\"group/menu-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nconst sidebarMenuButtonVariants = cva(\n  \"peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-hidden ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:w-8! group-data-[collapsible=icon]:h-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground\",\n        outline:\n          \"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]\",\n      },\n      size: {\n        default: \"h-8 text-sm\",\n        sm: \"h-7 text-xs\",\n        lg: \"h-12 text-sm group-data-[collapsible=icon]:p-0!\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nfunction SidebarMenuButton({\n  asChild = false,\n  isActive = false,\n  variant = \"default\",\n  size = \"default\",\n  tooltip,\n  className,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  isActive?: boolean\n  tooltip?: string | React.ComponentProps<typeof TooltipContent>\n} & VariantProps<typeof sidebarMenuButtonVariants>) {\n  const Comp = asChild ? Slot : \"button\"\n  const { isMobile, state } = useSidebar()\n\n  const button = (\n    <Comp\n      data-slot=\"sidebar-menu-button\"\n      data-sidebar=\"menu-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(sidebarMenuButtonVariants({ variant, size }), className)}\n      {...props}\n    />\n  )\n\n  if (!tooltip) {\n    return button\n  }\n\n  if (typeof tooltip === \"string\") {\n    tooltip = {\n      children: tooltip,\n    }\n  }\n\n  return (\n    <Tooltip>\n      <TooltipTrigger asChild>{button}</TooltipTrigger>\n      <TooltipContent\n        side=\"right\"\n        align=\"center\"\n        hidden={state !== \"collapsed\" || isMobile}\n        {...tooltip}\n      />\n    </Tooltip>\n  )\n}\n\nfunction SidebarMenuAction({\n  className,\n  asChild = false,\n  showOnHover = false,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  showOnHover?: boolean\n}) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-action\"\n      data-sidebar=\"menu-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer-hover/menu-button:text-sidebar-accent-foreground absolute top-1.5 right-1 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        showOnHover &&\n          \"peer-data-[active=true]/menu-button:text-sidebar-accent-foreground group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 md:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuBadge({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-menu-badge\"\n      data-sidebar=\"menu-badge\"\n      className={cn(\n        \"text-sidebar-foreground pointer-events-none absolute right-1 flex h-5 min-w-5 items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums select-none\",\n        \"peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSkeleton({\n  className,\n  showIcon = false,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  showIcon?: boolean\n}) {\n  // Random width between 50 to 90%.\n  const width = React.useMemo(() => {\n    return `${Math.floor(Math.random() * 40) + 50}%`\n  }, [])\n\n  return (\n    <div\n      data-slot=\"sidebar-menu-skeleton\"\n      data-sidebar=\"menu-skeleton\"\n      className={cn(\"flex h-8 items-center gap-2 rounded-md px-2\", className)}\n      {...props}\n    >\n      {showIcon && (\n        <Skeleton\n          className=\"size-4 rounded-md\"\n          data-sidebar=\"menu-skeleton-icon\"\n        />\n      )}\n      <Skeleton\n        className=\"h-4 max-w-[var(--skeleton-width)] flex-1\"\n        data-sidebar=\"menu-skeleton-text\"\n        style={\n          {\n            \"--skeleton-width\": width,\n          } as React.CSSProperties\n        }\n      />\n    </div>\n  )\n}\n\nfunction SidebarMenuSub({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu-sub\"\n      data-sidebar=\"menu-sub\"\n      className={cn(\n        \"border-sidebar-border mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l px-2.5 py-0.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubItem({\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-sub-item\"\n      data-sidebar=\"menu-sub-item\"\n      className={cn(\"group/menu-sub-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubButton({\n  asChild = false,\n  size = \"md\",\n  isActive = false,\n  className,\n  ...props\n}: React.ComponentProps<\"a\"> & {\n  asChild?: boolean\n  size?: \"sm\" | \"md\"\n  isActive?: boolean\n}) {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-sub-button\"\n      data-sidebar=\"menu-sub-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground active:bg-sidebar-accent active:text-sidebar-accent-foreground [&>svg]:text-sidebar-accent-foreground flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 outline outline-2 outline-transparent outline-offset-2 focus-visible:ring-2 disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n        \"data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground\",\n        size === \"sm\" && \"text-xs\",\n        size === \"md\" && \"text-sm\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nexport {\n  Sidebar,\n  SidebarContent,\n  SidebarFooter,\n  SidebarGroup,\n  SidebarGroupAction,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarHeader,\n  SidebarInput,\n  SidebarInset,\n  SidebarMenu,\n  SidebarMenuAction,\n  SidebarMenuBadge,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarMenuSkeleton,\n  SidebarMenuSub,\n  SidebarMenuSubButton,\n  SidebarMenuSubItem,\n  SidebarProvider,\n  SidebarRail,\n  SidebarSeparator,\n  SidebarTrigger,\n  useSidebar,\n}\n","path":null,"size_bytes":21846,"size_tokens":null},"client/src/components/ui/navigation-menu.tsx":{"content":"import * as React from \"react\"\nimport * as NavigationMenuPrimitive from \"@radix-ui/react-navigation-menu\"\nimport { cva } from \"class-variance-authority\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst NavigationMenu = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative z-10 flex max-w-max flex-1 items-center justify-center\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <NavigationMenuViewport />\n  </NavigationMenuPrimitive.Root>\n))\nNavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName\n\nconst NavigationMenuList = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.List\n    ref={ref}\n    className={cn(\n      \"group flex flex-1 list-none items-center justify-center space-x-1\",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName\n\nconst NavigationMenuItem = NavigationMenuPrimitive.Item\n\nconst navigationMenuTriggerStyle = cva(\n  \"group inline-flex h-10 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[state=open]:text-accent-foreground data-[state=open]:bg-accent/50 data-[state=open]:hover:bg-accent data-[state=open]:focus:bg-accent\"\n)\n\nconst NavigationMenuTrigger = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Trigger\n    ref={ref}\n    className={cn(navigationMenuTriggerStyle(), \"group\", className)}\n    {...props}\n  >\n    {children}{\" \"}\n    <ChevronDown\n      className=\"relative top-[1px] ml-1 h-3 w-3 transition duration-200 group-data-[state=open]:rotate-180\"\n      aria-hidden=\"true\"\n    />\n  </NavigationMenuPrimitive.Trigger>\n))\nNavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName\n\nconst NavigationMenuContent = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto \",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName\n\nconst NavigationMenuLink = NavigationMenuPrimitive.Link\n\nconst NavigationMenuViewport = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>\n>(({ className, ...props }, ref) => (\n  <div className={cn(\"absolute left-0 top-full flex justify-center\")}>\n    <NavigationMenuPrimitive.Viewport\n      className={cn(\n        \"origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  </div>\n))\nNavigationMenuViewport.displayName =\n  NavigationMenuPrimitive.Viewport.displayName\n\nconst NavigationMenuIndicator = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Indicator\n    ref={ref}\n    className={cn(\n      \"top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in\",\n      className\n    )}\n    {...props}\n  >\n    <div className=\"relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md\" />\n  </NavigationMenuPrimitive.Indicator>\n))\nNavigationMenuIndicator.displayName =\n  NavigationMenuPrimitive.Indicator.displayName\n\nexport {\n  navigationMenuTriggerStyle,\n  NavigationMenu,\n  NavigationMenuList,\n  NavigationMenuItem,\n  NavigationMenuContent,\n  NavigationMenuTrigger,\n  NavigationMenuLink,\n  NavigationMenuIndicator,\n  NavigationMenuViewport,\n}\n","path":null,"size_bytes":5128,"size_tokens":null},"client/src/components/ui/checkbox.tsx":{"content":"import * as React from \"react\"\nimport * as CheckboxPrimitive from \"@radix-ui/react-checkbox\"\nimport { Check } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Checkbox = React.forwardRef<\n  React.ElementRef<typeof CheckboxPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <CheckboxPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground\",\n      className\n    )}\n    {...props}\n  >\n    <CheckboxPrimitive.Indicator\n      className={cn(\"flex items-center justify-center text-current\")}\n    >\n      <Check className=\"h-4 w-4\" />\n    </CheckboxPrimitive.Indicator>\n  </CheckboxPrimitive.Root>\n))\nCheckbox.displayName = CheckboxPrimitive.Root.displayName\n\nexport { Checkbox }\n","path":null,"size_bytes":1056,"size_tokens":null},"tailwind.config.ts":{"content":"import type { Config } from \"tailwindcss\";\n\nexport default {\n  darkMode: [\"class\"],\n  content: [\"./client/index.html\", \"./client/src/**/*.{js,jsx,ts,tsx}\"],\n  theme: {\n    extend: {\n      borderRadius: {\n        lg: \".5625rem\", /* 9px */\n        md: \".375rem\", /* 6px */\n        sm: \".1875rem\", /* 3px */\n      },\n      colors: {\n        // Flat / base colors (regular buttons)\n        background: \"hsl(var(--background) / <alpha-value>)\",\n        foreground: \"hsl(var(--foreground) / <alpha-value>)\",\n        border: \"hsl(var(--border) / <alpha-value>)\",\n        input: \"hsl(var(--input) / <alpha-value>)\",\n        card: {\n          DEFAULT: \"hsl(var(--card) / <alpha-value>)\",\n          foreground: \"hsl(var(--card-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--card-border) / <alpha-value>)\",\n        },\n        popover: {\n          DEFAULT: \"hsl(var(--popover) / <alpha-value>)\",\n          foreground: \"hsl(var(--popover-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--popover-border) / <alpha-value>)\",\n        },\n        primary: {\n          DEFAULT: \"hsl(var(--primary) / <alpha-value>)\",\n          foreground: \"hsl(var(--primary-foreground) / <alpha-value>)\",\n          border: \"var(--primary-border)\",\n        },\n        secondary: {\n          DEFAULT: \"hsl(var(--secondary) / <alpha-value>)\",\n          foreground: \"hsl(var(--secondary-foreground) / <alpha-value>)\",\n          border: \"var(--secondary-border)\",\n        },\n        muted: {\n          DEFAULT: \"hsl(var(--muted) / <alpha-value>)\",\n          foreground: \"hsl(var(--muted-foreground) / <alpha-value>)\",\n          border: \"var(--muted-border)\",\n        },\n        accent: {\n          DEFAULT: \"hsl(var(--accent) / <alpha-value>)\",\n          foreground: \"hsl(var(--accent-foreground) / <alpha-value>)\",\n          border: \"var(--accent-border)\",\n        },\n        destructive: {\n          DEFAULT: \"hsl(var(--destructive) / <alpha-value>)\",\n          foreground: \"hsl(var(--destructive-foreground) / <alpha-value>)\",\n          border: \"var(--destructive-border)\",\n        },\n        ring: \"hsl(var(--ring) / <alpha-value>)\",\n        chart: {\n          \"1\": \"hsl(var(--chart-1) / <alpha-value>)\",\n          \"2\": \"hsl(var(--chart-2) / <alpha-value>)\",\n          \"3\": \"hsl(var(--chart-3) / <alpha-value>)\",\n          \"4\": \"hsl(var(--chart-4) / <alpha-value>)\",\n          \"5\": \"hsl(var(--chart-5) / <alpha-value>)\",\n        },\n        sidebar: {\n          ring: \"hsl(var(--sidebar-ring) / <alpha-value>)\",\n          DEFAULT: \"hsl(var(--sidebar) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--sidebar-border) / <alpha-value>)\",\n        },\n        \"sidebar-primary\": {\n          DEFAULT: \"hsl(var(--sidebar-primary) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-primary-foreground) / <alpha-value>)\",\n          border: \"var(--sidebar-primary-border)\",\n        },\n        \"sidebar-accent\": {\n          DEFAULT: \"hsl(var(--sidebar-accent) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-accent-foreground) / <alpha-value>)\",\n          border: \"var(--sidebar-accent-border)\"\n        },\n        status: {\n          online: \"rgb(34 197 94)\",\n          away: \"rgb(245 158 11)\",\n          busy: \"rgb(239 68 68)\",\n          offline: \"rgb(156 163 175)\",\n        },\n      },\n      fontFamily: {\n        sans: [\"var(--font-sans)\"],\n        serif: [\"var(--font-serif)\"],\n        mono: [\"var(--font-mono)\"],\n      },\n      keyframes: {\n        \"accordion-down\": {\n          from: { height: \"0\" },\n          to: { height: \"var(--radix-accordion-content-height)\" },\n        },\n        \"accordion-up\": {\n          from: { height: \"var(--radix-accordion-content-height)\" },\n          to: { height: \"0\" },\n        },\n      },\n      animation: {\n        \"accordion-down\": \"accordion-down 0.2s ease-out\",\n        \"accordion-up\": \"accordion-up 0.2s ease-out\",\n      },\n    },\n  },\n  plugins: [require(\"tailwindcss-animate\"), require(\"@tailwindcss/typography\")],\n} satisfies Config;\n","path":null,"size_bytes":4050,"size_tokens":null},"client/src/pages/customer-jobs.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Car, MapPin, Clock, CheckCircle2, Building2, AlertCircle } from \"lucide-react\";\nimport { Job, JobStatus } from \"@shared/schema\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { useLocation } from \"wouter\";\n\nexport default function CustomerJobs() {\n  const { currentUser } = useAuth();\n  const [, setLocation] = useLocation();\n\n  const { data: jobs = [], isLoading } = useQuery<Job[]>({\n    queryKey: [\"/api/customer/jobs\", currentUser?.id],\n    enabled: !!currentUser,\n  });\n\n  const activeJobs = jobs.filter(j => \n    [JobStatus.PAID, JobStatus.ASSIGNED, JobStatus.IN_PROGRESS].includes(j.status)\n  );\n  const completedJobs = jobs.filter(j => j.status === JobStatus.COMPLETED);\n\n  return (\n    <div className=\"min-h-screen bg-background p-4 pb-20\">\n      <div className=\"max-w-2xl mx-auto\">\n        {/* Header */}\n        <div className=\"mb-6 pt-4\">\n          <div className=\"flex items-start justify-between gap-3 mb-2\">\n            <div>\n              <h1 className=\"text-2xl font-bold text-foreground mb-1\">\n                My Jobs\n              </h1>\n              <p className=\"text-muted-foreground\">\n                Track your car wash bookings\n              </p>\n            </div>\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={() => setLocation(\"/customer/complaint\")}\n              data-testid=\"button-submit-complaint\"\n              className=\"shrink-0\"\n            >\n              <AlertCircle className=\"h-4 w-4 mr-2\" />\n              Report Issue\n            </Button>\n          </div>\n        </div>\n\n        <Tabs defaultValue=\"active\" className=\"w-full\">\n          <TabsList className=\"grid w-full grid-cols-2\">\n            <TabsTrigger value=\"active\" data-testid=\"tab-active-jobs\">\n              Active ({activeJobs.length})\n            </TabsTrigger>\n            <TabsTrigger value=\"completed\" data-testid=\"tab-completed-jobs\">\n              Completed ({completedJobs.length})\n            </TabsTrigger>\n          </TabsList>\n\n          {/* Active Jobs */}\n          <TabsContent value=\"active\" className=\"space-y-4 mt-4\">\n            {isLoading ? (\n              <>\n                {[1, 2].map((i) => (\n                  <Card key={i}>\n                    <CardHeader>\n                      <Skeleton className=\"h-6 w-1/2\" />\n                    </CardHeader>\n                    <CardContent>\n                      <Skeleton className=\"h-4 w-full mb-2\" />\n                      <Skeleton className=\"h-4 w-3/4\" />\n                    </CardContent>\n                  </Card>\n                ))}\n              </>\n            ) : activeJobs.length === 0 ? (\n              <Card className=\"p-8 text-center\">\n                <Clock className=\"h-12 w-12 mx-auto text-muted-foreground mb-4\" />\n                <p className=\"text-muted-foreground\">No active jobs</p>\n              </Card>\n            ) : (\n              activeJobs.map((job) => <JobCard key={job.id} job={job} />)\n            )}\n          </TabsContent>\n\n          {/* Completed Jobs */}\n          <TabsContent value=\"completed\" className=\"space-y-4 mt-4\">\n            {completedJobs.length === 0 ? (\n              <Card className=\"p-8 text-center\">\n                <CheckCircle2 className=\"h-12 w-12 mx-auto text-muted-foreground mb-4\" />\n                <p className=\"text-muted-foreground\">No completed jobs yet</p>\n              </Card>\n            ) : (\n              completedJobs.map((job) => <JobCard key={job.id} job={job} />)\n            )}\n          </TabsContent>\n        </Tabs>\n      </div>\n    </div>\n  );\n}\n\nfunction JobCard({ job }: { job: Job }) {\n  const getStatusBadge = (status: JobStatus) => {\n    const statusConfig = {\n      [JobStatus.PAID]: { label: \"Waiting for Cleaner\", variant: \"secondary\" as const },\n      [JobStatus.ASSIGNED]: { label: \"Assigned\", variant: \"default\" as const },\n      [JobStatus.IN_PROGRESS]: { label: \"In Progress\", variant: \"default\" as const },\n      [JobStatus.COMPLETED]: { label: \"Completed\", variant: \"outline\" as const },\n      [JobStatus.CANCELLED]: { label: \"Cancelled\", variant: \"destructive\" as const },\n      [JobStatus.PENDING_PAYMENT]: { label: \"Pending Payment\", variant: \"secondary\" as const },\n      [JobStatus.REFUNDED]: { label: \"Refunded\", variant: \"outline\" as const },\n    };\n\n    const config = statusConfig[status];\n    return <Badge variant={config.variant}>{config.label}</Badge>;\n  };\n\n  return (\n    <Card data-testid={`job-card-${job.id}`}>\n      <CardHeader>\n        <div className=\"flex items-start justify-between gap-2\">\n          <div>\n            <CardTitle className=\"text-lg\">Job #{job.id}</CardTitle>\n            <CardDescription className=\"mt-1\">\n              {new Date(job.createdAt).toLocaleDateString('en-AE', {\n                year: 'numeric',\n                month: 'long',\n                day: 'numeric',\n                timeZone: 'Asia/Dubai'\n              })}\n            </CardDescription>\n          </div>\n          {getStatusBadge(job.status)}\n        </div>\n      </CardHeader>\n      <CardContent className=\"space-y-3\">\n        <div className=\"flex items-start gap-2\">\n          <Car className=\"h-4 w-4 mt-0.5 text-muted-foreground\" />\n          <div>\n            <p className=\"text-sm text-muted-foreground\">Plate Number</p>\n            <p className=\"font-medium\">{job.carPlateNumber}</p>\n          </div>\n        </div>\n\n        <div className=\"flex items-start gap-2\">\n          <MapPin className=\"h-4 w-4 mt-0.5 text-muted-foreground\" />\n          <div>\n            <p className=\"text-sm text-muted-foreground\">Location</p>\n            <p className=\"font-medium\">{job.locationAddress}</p>\n          </div>\n        </div>\n\n        {job.parkingNumber && (\n          <div className=\"flex items-start gap-2\">\n            <Building2 className=\"h-4 w-4 mt-0.5 text-muted-foreground\" />\n            <div>\n              <p className=\"text-sm text-muted-foreground\">Parking</p>\n              <p className=\"font-medium\">{job.parkingNumber}</p>\n            </div>\n          </div>\n        )}\n\n        <div className=\"pt-2 border-t flex items-center justify-between\">\n          <span className=\"text-sm text-muted-foreground\">Total</span>\n          <span className=\"text-lg font-bold\">${job.price}</span>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n","path":null,"size_bytes":6684,"size_tokens":null},"client/src/components/ui/carousel.tsx":{"content":"import * as React from \"react\"\nimport useEmblaCarousel, {\n  type UseEmblaCarouselType,\n} from \"embla-carousel-react\"\nimport { ArrowLeft, ArrowRight } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\n\ntype CarouselApi = UseEmblaCarouselType[1]\ntype UseCarouselParameters = Parameters<typeof useEmblaCarousel>\ntype CarouselOptions = UseCarouselParameters[0]\ntype CarouselPlugin = UseCarouselParameters[1]\n\ntype CarouselProps = {\n  opts?: CarouselOptions\n  plugins?: CarouselPlugin\n  orientation?: \"horizontal\" | \"vertical\"\n  setApi?: (api: CarouselApi) => void\n}\n\ntype CarouselContextProps = {\n  carouselRef: ReturnType<typeof useEmblaCarousel>[0]\n  api: ReturnType<typeof useEmblaCarousel>[1]\n  scrollPrev: () => void\n  scrollNext: () => void\n  canScrollPrev: boolean\n  canScrollNext: boolean\n} & CarouselProps\n\nconst CarouselContext = React.createContext<CarouselContextProps | null>(null)\n\nfunction useCarousel() {\n  const context = React.useContext(CarouselContext)\n\n  if (!context) {\n    throw new Error(\"useCarousel must be used within a <Carousel />\")\n  }\n\n  return context\n}\n\nconst Carousel = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & CarouselProps\n>(\n  (\n    {\n      orientation = \"horizontal\",\n      opts,\n      setApi,\n      plugins,\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const [carouselRef, api] = useEmblaCarousel(\n      {\n        ...opts,\n        axis: orientation === \"horizontal\" ? \"x\" : \"y\",\n      },\n      plugins\n    )\n    const [canScrollPrev, setCanScrollPrev] = React.useState(false)\n    const [canScrollNext, setCanScrollNext] = React.useState(false)\n\n    const onSelect = React.useCallback((api: CarouselApi) => {\n      if (!api) {\n        return\n      }\n\n      setCanScrollPrev(api.canScrollPrev())\n      setCanScrollNext(api.canScrollNext())\n    }, [])\n\n    const scrollPrev = React.useCallback(() => {\n      api?.scrollPrev()\n    }, [api])\n\n    const scrollNext = React.useCallback(() => {\n      api?.scrollNext()\n    }, [api])\n\n    const handleKeyDown = React.useCallback(\n      (event: React.KeyboardEvent<HTMLDivElement>) => {\n        if (event.key === \"ArrowLeft\") {\n          event.preventDefault()\n          scrollPrev()\n        } else if (event.key === \"ArrowRight\") {\n          event.preventDefault()\n          scrollNext()\n        }\n      },\n      [scrollPrev, scrollNext]\n    )\n\n    React.useEffect(() => {\n      if (!api || !setApi) {\n        return\n      }\n\n      setApi(api)\n    }, [api, setApi])\n\n    React.useEffect(() => {\n      if (!api) {\n        return\n      }\n\n      onSelect(api)\n      api.on(\"reInit\", onSelect)\n      api.on(\"select\", onSelect)\n\n      return () => {\n        api?.off(\"select\", onSelect)\n      }\n    }, [api, onSelect])\n\n    return (\n      <CarouselContext.Provider\n        value={{\n          carouselRef,\n          api: api,\n          opts,\n          orientation:\n            orientation || (opts?.axis === \"y\" ? \"vertical\" : \"horizontal\"),\n          scrollPrev,\n          scrollNext,\n          canScrollPrev,\n          canScrollNext,\n        }}\n      >\n        <div\n          ref={ref}\n          onKeyDownCapture={handleKeyDown}\n          className={cn(\"relative\", className)}\n          role=\"region\"\n          aria-roledescription=\"carousel\"\n          {...props}\n        >\n          {children}\n        </div>\n      </CarouselContext.Provider>\n    )\n  }\n)\nCarousel.displayName = \"Carousel\"\n\nconst CarouselContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { carouselRef, orientation } = useCarousel()\n\n  return (\n    <div ref={carouselRef} className=\"overflow-hidden\">\n      <div\n        ref={ref}\n        className={cn(\n          \"flex\",\n          orientation === \"horizontal\" ? \"-ml-4\" : \"-mt-4 flex-col\",\n          className\n        )}\n        {...props}\n      />\n    </div>\n  )\n})\nCarouselContent.displayName = \"CarouselContent\"\n\nconst CarouselItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { orientation } = useCarousel()\n\n  return (\n    <div\n      ref={ref}\n      role=\"group\"\n      aria-roledescription=\"slide\"\n      className={cn(\n        \"min-w-0 shrink-0 grow-0 basis-full\",\n        orientation === \"horizontal\" ? \"pl-4\" : \"pt-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nCarouselItem.displayName = \"CarouselItem\"\n\nconst CarouselPrevious = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollPrev, canScrollPrev } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute  h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-left-12 top-1/2 -translate-y-1/2\"\n          : \"-top-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollPrev}\n      onClick={scrollPrev}\n      {...props}\n    >\n      <ArrowLeft className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Previous slide</span>\n    </Button>\n  )\n})\nCarouselPrevious.displayName = \"CarouselPrevious\"\n\nconst CarouselNext = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollNext, canScrollNext } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-right-12 top-1/2 -translate-y-1/2\"\n          : \"-bottom-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollNext}\n      onClick={scrollNext}\n      {...props}\n    >\n      <ArrowRight className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Next slide</span>\n    </Button>\n  )\n})\nCarouselNext.displayName = \"CarouselNext\"\n\nexport {\n  type CarouselApi,\n  Carousel,\n  CarouselContent,\n  CarouselItem,\n  CarouselPrevious,\n  CarouselNext,\n}\n","path":null,"size_bytes":6210,"size_tokens":null},"client/src/components/ui/collapsible.tsx":{"content":"\"use client\"\n\nimport * as CollapsiblePrimitive from \"@radix-ui/react-collapsible\"\n\nconst Collapsible = CollapsiblePrimitive.Root\n\nconst CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger\n\nconst CollapsibleContent = CollapsiblePrimitive.CollapsibleContent\n\nexport { Collapsible, CollapsibleTrigger, CollapsibleContent }\n","path":null,"size_bytes":329,"size_tokens":null},"client/src/components/ui/aspect-ratio.tsx":{"content":"import * as AspectRatioPrimitive from \"@radix-ui/react-aspect-ratio\"\n\nconst AspectRatio = AspectRatioPrimitive.Root\n\nexport { AspectRatio }\n","path":null,"size_bytes":140,"size_tokens":null},"client/src/pages/register-cleaner.tsx":{"content":"import { useState } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Button } from \"@/components/ui/button\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { Loader2, CheckCircle, Phone } from \"lucide-react\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport logoUrl from \"@assets/IMG_2508_1762619079711.png\";\n\nexport default function RegisterCleanerPage() {\n  const { registerCleaner } = useAuth();\n  const { toast } = useToast();\n  const [, setLocation] = useLocation();\n  \n  const [step, setStep] = useState<\"phone\" | \"register\">(\"phone\");\n  const [phoneNumber, setPhoneNumber] = useState(\"\");\n  const [validatingPhone, setValidatingPhone] = useState(false);\n  const [companyInfo, setCompanyInfo] = useState<{ companyId: number; companyName: string } | null>(null);\n  \n  const [formData, setFormData] = useState({\n    email: \"\",\n    password: \"\",\n    displayName: \"\",\n  });\n  const [submitting, setSubmitting] = useState(false);\n\n  const handlePhoneValidation = async (e: React.FormEvent) => {\n    e.preventDefault();\n    setValidatingPhone(true);\n    \n    try {\n      const response = await apiRequest(\"POST\", \"/api/auth/validate-cleaner-phone\", { phoneNumber });\n      const data = await response.json();\n      \n      if (data.valid) {\n        setCompanyInfo({\n          companyId: data.companyId,\n          companyName: data.companyName,\n        });\n        setStep(\"register\");\n        toast({\n          title: \"Phone Validated\",\n          description: `You can now register as a cleaner for ${data.companyName}`,\n        });\n      }\n    } catch (error: any) {\n      toast({\n        title: \"Validation Failed\",\n        description: error.message || \"This phone number is not invited to any company\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setValidatingPhone(false);\n    }\n  };\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    setSubmitting(true);\n    \n    try {\n      await registerCleaner({\n        ...formData,\n        phoneNumber,\n      });\n      setLocation(\"/cleaner\");\n    } catch (error) {\n      // Error shown by toast in auth context\n    } finally {\n      setSubmitting(false);\n    }\n  };\n\n  if (step === \"phone\") {\n    return (\n      <div className=\"min-h-screen bg-background flex items-center justify-center p-4\">\n        <Card className=\"w-full max-w-md\">\n          <CardHeader className=\"text-center space-y-2\">\n            <div className=\"flex items-center justify-center mb-4\">\n              <img src={logoUrl} alt=\"Washapp.ae\" className=\"h-24 w-auto\" data-testid=\"img-logo\" />\n            </div>\n            <CardTitle className=\"text-xl font-bold\">Register as Cleaner</CardTitle>\n            <CardDescription className=\"text-base\">\n              Enter your invited phone number\n            </CardDescription>\n          </CardHeader>\n          <form onSubmit={handlePhoneValidation}>\n            <CardContent className=\"space-y-4\">\n              <Alert>\n                <Phone className=\"h-4 w-4\" />\n                <AlertDescription>\n                  You need an invitation from a company to register. Please enter the phone number your company invited.\n                </AlertDescription>\n              </Alert>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"phoneNumber\">Phone Number</Label>\n                <Input\n                  id=\"phoneNumber\"\n                  type=\"tel\"\n                  placeholder=\"+65 1234 5678\"\n                  value={phoneNumber}\n                  onChange={(e) => setPhoneNumber(e.target.value)}\n                  required\n                  data-testid=\"input-phone\"\n                />\n                <p className=\"text-sm text-muted-foreground\">\n                  Enter the exact phone number your company used to invite you\n                </p>\n              </div>\n            </CardContent>\n            <CardFooter className=\"flex flex-col gap-4\">\n              <Button \n                type=\"submit\" \n                className=\"w-full\" \n                disabled={validatingPhone || !phoneNumber}\n                data-testid=\"button-validate-phone\"\n              >\n                {validatingPhone ? (\n                  <>\n                    <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                    Validating...\n                  </>\n                ) : (\n                  \"Continue\"\n                )}\n              </Button>\n              <Button\n                type=\"button\"\n                variant=\"outline\"\n                className=\"w-full\"\n                onClick={() => setLocation(\"/login\")}\n                data-testid=\"button-back-to-login\"\n              >\n                Back to Login\n              </Button>\n            </CardFooter>\n          </form>\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-background flex items-center justify-center p-4\">\n      <Card className=\"w-full max-w-md\">\n        <CardHeader className=\"text-center space-y-2\">\n          <div className=\"flex items-center justify-center mb-4\">\n            <img src={logoUrl} alt=\"Washapp.ae\" className=\"h-24 w-auto\" data-testid=\"img-logo\" />\n          </div>\n          <CardTitle className=\"text-xl font-bold\">Complete Registration</CardTitle>\n          <CardDescription className=\"text-base\">\n            Register for {companyInfo?.companyName}\n          </CardDescription>\n        </CardHeader>\n        <form onSubmit={handleSubmit}>\n          <CardContent className=\"space-y-4\">\n            <Alert>\n              <CheckCircle className=\"h-4 w-4\" />\n              <AlertDescription>\n                Phone number verified: {phoneNumber}\n              </AlertDescription>\n            </Alert>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"displayName\">Full Name</Label>\n              <Input\n                id=\"displayName\"\n                placeholder=\"John Doe\"\n                value={formData.displayName}\n                onChange={(e) => setFormData({ ...formData, displayName: e.target.value })}\n                required\n                data-testid=\"input-name\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"email\">Email</Label>\n              <Input\n                id=\"email\"\n                type=\"email\"\n                placeholder=\"your@email.com\"\n                value={formData.email}\n                onChange={(e) => setFormData({ ...formData, email: e.target.value })}\n                required\n                data-testid=\"input-email\"\n              />\n            </div>\n            \n            <div className=\"space-y-2\">\n              <Label htmlFor=\"password\">Password</Label>\n              <Input\n                id=\"password\"\n                type=\"password\"\n                placeholder=\"••••••••\"\n                value={formData.password}\n                onChange={(e) => setFormData({ ...formData, password: e.target.value })}\n                required\n                minLength={8}\n                data-testid=\"input-password\"\n              />\n              <p className=\"text-sm text-muted-foreground\">\n                Minimum 8 characters\n              </p>\n            </div>\n          </CardContent>\n          <CardFooter className=\"flex flex-col gap-4\">\n            <Button \n              type=\"submit\" \n              className=\"w-full\" \n              disabled={submitting}\n              data-testid=\"button-submit\"\n            >\n              {submitting ? (\n                <>\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                  Creating Account...\n                </>\n              ) : (\n                \"Complete Registration\"\n              )}\n            </Button>\n            <Button\n              type=\"button\"\n              variant=\"outline\"\n              className=\"w-full\"\n              onClick={() => setStep(\"phone\")}\n              data-testid=\"button-back\"\n            >\n              Change Phone Number\n            </Button>\n          </CardFooter>\n        </form>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":8404,"size_tokens":null},"client/src/components/ui/sheet.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SheetPrimitive from \"@radix-ui/react-dialog\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Sheet = SheetPrimitive.Root\n\nconst SheetTrigger = SheetPrimitive.Trigger\n\nconst SheetClose = SheetPrimitive.Close\n\nconst SheetPortal = SheetPrimitive.Portal\n\nconst SheetOverlay = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nSheetOverlay.displayName = SheetPrimitive.Overlay.displayName\n\nconst sheetVariants = cva(\n  \"fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500\",\n  {\n    variants: {\n      side: {\n        top: \"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top\",\n        bottom:\n          \"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom\",\n        left: \"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm\",\n        right:\n          \"inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm\",\n      },\n    },\n    defaultVariants: {\n      side: \"right\",\n    },\n  }\n)\n\ninterface SheetContentProps\n  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,\n    VariantProps<typeof sheetVariants> {}\n\nconst SheetContent = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Content>,\n  SheetContentProps\n>(({ side = \"right\", className, children, ...props }, ref) => (\n  <SheetPortal>\n    <SheetOverlay />\n    <SheetPrimitive.Content\n      ref={ref}\n      className={cn(sheetVariants({ side }), className)}\n      {...props}\n    >\n      {children}\n      <SheetPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </SheetPrimitive.Close>\n    </SheetPrimitive.Content>\n  </SheetPortal>\n))\nSheetContent.displayName = SheetPrimitive.Content.displayName\n\nconst SheetHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetHeader.displayName = \"SheetHeader\"\n\nconst SheetFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetFooter.displayName = \"SheetFooter\"\n\nconst SheetTitle = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold text-foreground\", className)}\n    {...props}\n  />\n))\nSheetTitle.displayName = SheetPrimitive.Title.displayName\n\nconst SheetDescription = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nSheetDescription.displayName = SheetPrimitive.Description.displayName\n\nexport {\n  Sheet,\n  SheetPortal,\n  SheetOverlay,\n  SheetTrigger,\n  SheetClose,\n  SheetContent,\n  SheetHeader,\n  SheetFooter,\n  SheetTitle,\n  SheetDescription,\n}\n","path":null,"size_bytes":4281,"size_tokens":null},"server/storage.ts":{"content":"import { \n  users, \n  companies, \n  cleaners, \n  jobs,\n  cleanerInvitations,\n  customers,\n  shiftSessions,\n  cleanerShifts,\n  cleanerPaymentTokens,\n  offlineJobs,\n  deviceTokens,\n  pushSubscriptions,\n  platformSettings,\n  feeSettings,\n  jobFinancials,\n  companyWithdrawals,\n  companyGeofences,\n  cleanerGeofenceAssignments,\n  transactions,\n  passwordResetTokens,\n  emailOtpVerifications,\n  complaints,\n  type User, \n  type InsertUser,\n  type Company,\n  type InsertCompany,\n  type Cleaner,\n  type InsertCleaner,\n  type Job,\n  type InsertJob,\n  type CleanerInvitation,\n  type InsertCleanerInvitation,\n  type Customer,\n  type InsertCustomer,\n  type ShiftSession,\n  type InsertShiftSession,\n  type CleanerShift,\n  type InsertCleanerShift,\n  type CleanerPaymentToken,\n  type InsertCleanerPaymentToken,\n  type OfflineJob,\n  type InsertOfflineJob,\n  type PlatformSetting,\n  type InsertPlatformSetting,\n  type FeeSetting,\n  type InsertFeeSetting,\n  type JobFinancials,\n  type InsertJobFinancials,\n  type JobFinancialsWithCleaner,\n  type CompanyWithdrawal,\n  type InsertCompanyWithdrawal,\n  type CompanyGeofence,\n  type InsertCompanyGeofence,\n  type CleanerGeofenceAssignment,\n  type InsertCleanerGeofenceAssignment,\n  type Transaction,\n  type InsertTransaction,\n  type PasswordResetToken,\n  type InsertPasswordResetToken,\n  type EmailOtpVerification,\n  type InsertEmailOtpVerification,\n  type Complaint,\n  type InsertComplaint,\n  UserRole,\n  JobStatus,\n  CleanerStatus,\n  type CompanyWithCleaners,\n} from \"@shared/schema\";\nimport { db } from \"./db\";\nimport { eq, and, desc, sql, gte, inArray, isNull, isNotNull, not, ne } from \"drizzle-orm\";\nimport bcrypt from \"bcryptjs\";\nimport { pool } from \"./db\";\n\nexport interface IStorage {\n  // User operations\n  getUser(id: number): Promise<User | undefined>;\n  getUserByEmail(email: string): Promise<User | undefined>;\n  createUser(user: Omit<InsertUser, 'passwordHash'> & { password: string }): Promise<User>;\n  updateUser(id: number, updates: Partial<User>): Promise<void>;\n  updateUserPassword(userId: number, newPassword: string): Promise<void>;\n  \n  // Password reset operations\n  createPasswordResetToken(userId: number, token: string, expiresAt: Date): Promise<void>;\n  getPasswordResetToken(token: string): Promise<{ userId: number; expiresAt: Date } | undefined>;\n  deletePasswordResetToken(token: string): Promise<void>;\n  deleteExpiredPasswordResetTokens(): Promise<void>;\n  \n  // Email OTP operations (for anonymous complaint submission)\n  createEmailOtp(email: string, code: string, expiresAt: Date): Promise<void>;\n  checkEmailOtp(email: string, code: string): Promise<boolean>; // Check unverified OTP for verification\n  isEmailOtpVerified(email: string, code: string): Promise<boolean>; // Check verified OTP for complaint\n  markEmailOtpAsVerified(email: string, code: string): Promise<void>;\n  invalidateEmailOtp(email: string, code: string): Promise<void>;\n  deleteExpiredEmailOtps(): Promise<void>;\n  \n  // Company operations\n  getAllCompanies(): Promise<Company[]>;\n  getPendingCompanies(): Promise<Company[]>;\n  approveCompany(companyId: number, platformFee?: number, feePackageType?: string): Promise<void>;\n  rejectCompany(companyId: number): Promise<void>;\n  getCompany(id: number): Promise<Company | undefined>;\n  createCompany(company: InsertCompany): Promise<Company>;\n  updateCompany(id: number, updates: Partial<Company>): Promise<void>;\n  getNearbyCompanies(lat: number, lon: number, maxDistanceMeters: number): Promise<CompanyWithCleaners[]>;\n  \n  // Transactional company+admin creation\n  createCompanyWithAdmin(data: {\n    email: string;\n    password: string;\n    displayName: string;\n    phoneNumber?: string;\n    companyName: string;\n    companyDescription?: string;\n    pricePerWash: number;\n    tradeLicenseNumber?: string;\n    tradeLicenseDocumentURL?: string;\n  }): Promise<{ user: User; company: Company }>;\n  \n  // Cleaner invitation operations\n  createInvitation(invitation: InsertCleanerInvitation): Promise<CleanerInvitation>;\n  getInvitationByPhone(phoneNumber: string): Promise<CleanerInvitation | undefined>;\n  getCompanyInvitations(companyId: number): Promise<CleanerInvitation[]>;\n  consumeInvitation(phoneNumber: string): Promise<void>;\n  \n  // Cleaner operations\n  getCleaner(id: number): Promise<Cleaner | undefined>;\n  getCleanerByUserId(userId: number): Promise<Cleaner | undefined>;\n  createCleaner(cleaner: InsertCleaner): Promise<Cleaner>;\n  updateCleaner(id: number, updates: Partial<Cleaner>): Promise<void>;\n  getCompanyCleaners(companyId: number, status?: CleanerStatus): Promise<Cleaner[]>;\n  \n  // Transactional cleaner+user creation\n  createCleanerWithUser(data: {\n    email: string;\n    password: string;\n    displayName: string;\n    phoneNumber?: string;\n    companyId: number;\n  }): Promise<{ user: User; cleaner: Cleaner }>;\n  \n  // Job operations\n  createJob(job: InsertJob): Promise<Job>;\n  getJob(id: number): Promise<Job | undefined>;\n  updateJob(id: number, updates: Partial<Job>): Promise<void>;\n  atomicSetReceipt(jobId: number, receiptNumber: string, receiptGeneratedAt: Date): Promise<string>;\n  completeJobIfNotCompleted(jobId: number, data: { proofPhotoURL: string; receiptNumber: string; completedAt: Date }): Promise<{ updated: boolean; job?: Job }>;\n  getJobsByCustomer(customerId: number, page?: number, pageSize?: number): Promise<{ data: Job[]; total: number }>;\n  getJobsByPlateNumber(plateNumber: string, page?: number, pageSize?: number): Promise<{ data: Job[]; total: number }>;\n  getJobsByPhoneNumber(phoneNumber: string, page?: number, pageSize?: number): Promise<{ data: Job[]; total: number }>;\n  getJobsByCleaner(cleanerId: number): Promise<Job[]>;\n  getJobsByCompany(companyId: number, status?: JobStatus): Promise<Job[]>;\n  getJobByPaymentIntent(paymentIntentId: string): Promise<Job | undefined>;\n  acceptJob(jobId: number, cleanerId: number): Promise<boolean>;\n  \n  // Customer operations\n  createOrGetCustomer(email: string, displayName?: string, phoneNumber?: string): Promise<Customer>;\n  getCustomerByEmail(email: string): Promise<Customer | undefined>;\n  getCustomerByPhone(phoneNumber: string): Promise<Customer | undefined>;\n  updateCustomerLastLogin(id: number): Promise<void>;\n  getCarHistoryByPlate(carPlateEmirate: string, carPlateCode: string, carPlateNumber: string): Promise<any[]>;\n  \n  // Shift session operations\n  startShift(cleanerId: number, latitude?: number, longitude?: number): Promise<CleanerShift>;\n  endShift(cleanerId: number, latitude?: number, longitude?: number): Promise<void>;\n  getActiveShift(cleanerId: number): Promise<CleanerShift | undefined>;\n  getCleanerShiftHistory(cleanerId: number, filters?: {\n    startDate?: Date;\n    endDate?: Date;\n    limit?: number;\n  }): Promise<CleanerShift[]>;\n  getCompanyShiftHistory(companyId: number, filters?: {\n    cleanerId?: number;\n    startDate?: Date;\n    endDate?: Date;\n    limit?: number;\n  }): Promise<Array<CleanerShift & { cleanerName: string }>>;\n  \n  // Cleaner payment token operations\n  createCleanerPaymentToken(cleanerId: number, companyId: number, token: string, expiresAt?: Date): Promise<CleanerPaymentToken>;\n  getCleanerPaymentToken(token: string): Promise<CleanerPaymentToken | undefined>;\n  markTokenAsUsed(tokenId: number): Promise<void>;\n  deleteExpiredTokens(): Promise<void>;\n  \n  // Analytics\n  getAdminAnalytics(): Promise<any>;\n  getCompanyAnalytics(companyId: number): Promise<any>;\n  \n  // Device token operations (for push notifications)\n  registerDeviceToken(userId: number, token: string, platform: string): Promise<void>;\n  unregisterDeviceToken(token: string): Promise<void>;\n  getUserDeviceTokens(userId: number): Promise<string[]>;\n  \n  // Push subscription operations (for web push notifications)\n  createPushSubscription(data: { userId?: number; customerId?: number; endpoint: string; keys: { p256dh: string; auth: string }; soundEnabled?: number }): Promise<void>;\n  deletePushSubscription(endpoint: string): Promise<void>;\n  updatePushSubscriptionSound(endpoint: string, soundEnabled: number): Promise<void>;\n  getPushSubscriptionByEndpoint(endpoint: string): Promise<{ soundEnabled: number } | undefined>;\n  getUserPushSubscriptions(userId: number): Promise<Array<{ endpoint: string; keys: { p256dh: string; auth: string }; soundEnabled: number }>>;\n  getCustomerPushSubscriptions(customerId: number): Promise<Array<{ endpoint: string; keys: { p256dh: string; auth: string }; soundEnabled: number }>>;\n  getAllPushSubscriptionsByRole(role: string): Promise<Array<{ endpoint: string; keys: { p256dh: string; auth: string }; soundEnabled: number }>>;  \n  updateTokenLastUsed(token: string): Promise<void>;\n  \n  // Financial operations\n  getCurrentFeeSettings(): Promise<FeeSetting>;\n  createJobFinancials(financials: InsertJobFinancials): Promise<JobFinancials>;\n  getJobFinancialsByJobId(jobId: number): Promise<JobFinancials | undefined>;\n  getCompanyFinancials(companyId: number, filters?: {\n    cleanerId?: number;\n    startDate?: Date;\n    endDate?: Date;\n    page?: number;\n    pageSize?: number;\n  }): Promise<{ data: JobFinancialsWithCleaner[]; total: number }>;\n  getCleanerTips(cleanerId: number, filters?: {\n    startDate?: Date;\n    endDate?: Date;\n    page?: number;\n    pageSize?: number;\n  }): Promise<{ \n    data: Array<{\n      jobId: number;\n      completedAt: Date;\n      carPlateNumber: string;\n      customerEmail: string;\n      tipAmount: number;\n      cleanerStripeFeeShare: number;\n      remainingTip: number;\n      receiptNumber: string | null;\n    }>;\n    total: number;\n  }>;\n  \n  // Company withdrawal operations\n  createWithdrawal(withdrawal: InsertCompanyWithdrawal): Promise<CompanyWithdrawal>;\n  updateWithdrawal(id: number, updates: Partial<CompanyWithdrawal>): Promise<void>;\n  getCompanyWithdrawals(companyId: number): Promise<CompanyWithdrawal[]>;\n  getAllWithdrawals(): Promise<CompanyWithdrawal[]>;\n  \n  // Transaction operations\n  getCompanyTransactions(companyId: number): Promise<Transaction[]>;\n  createTransaction(transaction: InsertTransaction): Promise<Transaction>;\n  \n  // Platform settings operations\n  getAllPlatformSettings(): Promise<PlatformSetting[]>;\n  updatePlatformSettings(id: number, updates: Partial<InsertPlatformSetting>): Promise<void>;\n  \n  // Financial aggregations\n  getCompanyFinancialSummary(companyId: number): Promise<{\n    totalRevenue: number;\n    totalRefunds: number;\n    platformFees: number;\n    paymentProcessingFees: number;\n    taxAmount: number;\n    netEarnings: number;\n    totalWithdrawals: number;\n    pendingWithdrawals: number;\n    availableBalance: number;\n  }>;\n  getAllCompaniesFinancialSummary(): Promise<Array<{\n    companyId: number;\n    companyName: string;\n    totalRevenue: number;\n    platformFees: number;\n    netEarnings: number;\n    totalWithdrawals: number;\n    availableBalance: number;\n  }>>;\n  \n  // Company geofence operations\n  getCompanyGeofences(companyId: number): Promise<CompanyGeofence[]>;\n  getGeofence(id: number): Promise<CompanyGeofence | undefined>;\n  createGeofence(geofence: InsertCompanyGeofence): Promise<CompanyGeofence>;\n  updateGeofence(id: number, updates: Partial<Pick<CompanyGeofence, 'name' | 'polygon'>>): Promise<void>;\n  deleteGeofence(id: number): Promise<void>;\n  getGeofenceByCompanyAndName(companyId: number, name: string): Promise<CompanyGeofence | undefined>;\n  \n  // Cleaner geofence assignment operations\n  assignGeofencesToInvitation(invitationId: number, companyId: number, geofenceIds: number[], assignAll: boolean): Promise<void>;\n  assignGeofencesToCleaner(cleanerId: number, companyId: number, geofenceIds: number[], assignAll: boolean): Promise<void>;\n  transferInvitationGeofencesToCleaner(invitationId: number, cleanerId: number): Promise<void>;\n  getCleanerGeofenceAssignments(cleanerId: number): Promise<CompanyGeofence[]>;\n  getInvitationGeofenceAssignments(invitationId: number): Promise<CompanyGeofence[]>;\n  isCleanerAssignedToGeofence(cleanerId: number, geofenceId: number): Promise<boolean>;\n  isCleanerAssignedToAllGeofences(cleanerId: number): Promise<boolean>;\n  \n  // Complaint operations\n  createComplaint(complaint: InsertComplaint): Promise<Complaint>;\n  getComplaint(id: number): Promise<Complaint | undefined>;\n  getComplaintByReference(referenceNumber: string): Promise<Complaint | undefined>;\n  getJobComplaints(jobId: number): Promise<Complaint[]>;\n  getCompanyComplaints(companyId: number): Promise<Complaint[]>;\n  getAllComplaints(): Promise<Complaint[]>;\n  updateComplaintStatus(id: number, status: string, resolvedBy?: number, resolution?: string): Promise<void>;\n  updateComplaintRefund(id: number, refundedBy: number, stripeRefundId: string): Promise<void>;\n  \n  // Offline job operations (for manually entered jobs with offline payment)\n  createOfflineJob(data: {\n    cleanerId: number;\n    companyId: number;\n    carPlateNumber: string;\n    carPlateEmirate?: string;\n    carPlateCode?: string;\n    servicePrice: string;\n    vatAmount: string;\n    totalAmount: string;\n    notes?: string;\n  }): Promise<OfflineJob>;\n  getCompanyOfflineJobs(companyId: number, filters?: {\n    cleanerId?: number;\n    startDate?: Date;\n    endDate?: Date;\n  }): Promise<Array<OfflineJob & { cleanerName: string }>>;\n  getOfflineJobsReport(companyId: number, filters?: {\n    cleanerId?: number;\n    startDate?: Date;\n    endDate?: Date;\n  }): Promise<{\n    totalJobs: number;\n    totalRevenue: number;\n    totalVat: number;\n    jobs: Array<OfflineJob & { cleanerName: string }>;\n  }>;\n  getOfflineJob(id: number): Promise<OfflineJob | undefined>;\n  completeOfflineJob(id: number, completionPhotoUrl: string): Promise<void>;\n}\n\nexport class DatabaseStorage implements IStorage {\n  // ===== USER OPERATIONS =====\n  \n  async getUser(id: number): Promise<User | undefined> {\n    const [user] = await db.select().from(users).where(eq(users.id, id));\n    return user;\n  }\n\n  async getUserByEmail(email: string): Promise<User | undefined> {\n    const normalizedEmail = email.toLowerCase();\n    const [user] = await db.select().from(users).where(eq(users.email, normalizedEmail));\n    return user;\n  }\n\n  async createUser(userData: Omit<InsertUser, 'passwordHash'> & { password: string }): Promise<User> {\n    const { password, ...userDataWithoutPassword } = userData;\n    const passwordHash = await bcrypt.hash(password, 10);\n    \n    const [user] = await db\n      .insert(users)\n      .values({\n        ...userDataWithoutPassword,\n        passwordHash,\n        email: userDataWithoutPassword.email.toLowerCase(),\n      })\n      .returning();\n    \n    return user;\n  }\n\n  async updateUser(id: number, updates: Partial<User>): Promise<void> {\n    await db\n      .update(users)\n      .set(updates)\n      .where(eq(users.id, id));\n  }\n\n  async updateUserPassword(userId: number, newPassword: string): Promise<void> {\n    const passwordHash = await bcrypt.hash(newPassword, 10);\n    await db\n      .update(users)\n      .set({ passwordHash })\n      .where(eq(users.id, userId));\n  }\n\n  // ===== PASSWORD RESET OPERATIONS =====\n  \n  async createPasswordResetToken(userId: number, token: string, expiresAt: Date): Promise<void> {\n    await db.insert(passwordResetTokens).values({\n      userId,\n      token,\n      expiresAt,\n    });\n  }\n\n  async getPasswordResetToken(token: string): Promise<{ userId: number; expiresAt: Date } | undefined> {\n    const [resetToken] = await db\n      .select()\n      .from(passwordResetTokens)\n      .where(eq(passwordResetTokens.token, token));\n    \n    if (!resetToken) {\n      return undefined;\n    }\n\n    return {\n      userId: resetToken.userId,\n      expiresAt: resetToken.expiresAt,\n    };\n  }\n\n  async deletePasswordResetToken(token: string): Promise<void> {\n    await db.delete(passwordResetTokens).where(eq(passwordResetTokens.token, token));\n  }\n\n  async deleteExpiredPasswordResetTokens(): Promise<void> {\n    const now = new Date();\n    await db.delete(passwordResetTokens).where(sql`${passwordResetTokens.expiresAt} < ${now}`);\n  }\n\n  // ===== EMAIL OTP OPERATIONS =====\n  \n  async createEmailOtp(email: string, code: string, expiresAt: Date): Promise<void> {\n    // Delete any existing unverified OTPs for this email\n    await db.delete(emailOtpVerifications).where(\n      and(\n        eq(emailOtpVerifications.email, email),\n        eq(emailOtpVerifications.verified, 0)\n      )\n    );\n    \n    // Create new OTP\n    await db.insert(emailOtpVerifications).values({\n      email,\n      code,\n      expiresAt,\n    });\n  }\n\n  async checkEmailOtp(email: string, code: string): Promise<boolean> {\n    // Check if unverified OTP exists and is valid (for verification endpoint)\n    const now = new Date();\n    const [otp] = await db\n      .select()\n      .from(emailOtpVerifications)\n      .where(\n        and(\n          eq(emailOtpVerifications.email, email),\n          eq(emailOtpVerifications.code, code),\n          eq(emailOtpVerifications.verified, 0), // Must be unverified\n          gte(emailOtpVerifications.expiresAt, now)\n        )\n      );\n    \n    return !!otp;\n  }\n\n  async isEmailOtpVerified(email: string, code: string): Promise<boolean> {\n    // Check if OTP has been verified (for complaint submission)\n    const now = new Date();\n    const [otp] = await db\n      .select()\n      .from(emailOtpVerifications)\n      .where(\n        and(\n          eq(emailOtpVerifications.email, email),\n          eq(emailOtpVerifications.code, code),\n          eq(emailOtpVerifications.verified, 1), // Must be verified\n          gte(emailOtpVerifications.expiresAt, now)\n        )\n      );\n    \n    return !!otp;\n  }\n  \n  async invalidateEmailOtp(email: string, code: string): Promise<void> {\n    // Delete the OTP after use to prevent reuse\n    await db.delete(emailOtpVerifications).where(\n      and(\n        eq(emailOtpVerifications.email, email),\n        eq(emailOtpVerifications.code, code)\n      )\n    );\n  }\n\n  async markEmailOtpAsVerified(email: string, code: string): Promise<void> {\n    await db\n      .update(emailOtpVerifications)\n      .set({ verified: 1 })\n      .where(\n        and(\n          eq(emailOtpVerifications.email, email),\n          eq(emailOtpVerifications.code, code)\n        )\n      );\n  }\n\n  async deleteExpiredEmailOtps(): Promise<void> {\n    const now = new Date();\n    await db.delete(emailOtpVerifications).where(sql`${emailOtpVerifications.expiresAt} < ${now}`);\n  }\n\n  // ===== COMPANY OPERATIONS =====\n  \n  // Transactional company + admin creation\n  async createCompanyWithAdmin(data: {\n    email: string;\n    password: string;\n    displayName: string;\n    phoneNumber?: string;\n    companyName: string;\n    companyDescription?: string;\n    pricePerWash: number;\n    tradeLicenseNumber?: string;\n    tradeLicenseDocumentURL?: string;\n    packageType?: string;\n    subscriptionCleanerSlots?: number;\n  }): Promise<{ user: User; company: Company }> {\n    const client = await pool.connect();\n    \n    try {\n      await client.query('BEGIN');\n      \n      // Create user\n      const passwordHash = await bcrypt.hash(data.password, 10);\n      const userResult = await client.query(\n        `INSERT INTO users (email, password_hash, display_name, phone_number, role, created_at)\n         VALUES ($1, $2, $3, $4, $5, NOW())\n         RETURNING *`,\n        [data.email.toLowerCase(), passwordHash, data.displayName, data.phoneNumber, UserRole.COMPANY_ADMIN]\n      );\n      const user = userResult.rows[0];\n      \n      // Create company\n      const companyResult = await client.query(\n        `INSERT INTO companies (name, description, price_per_wash, admin_id, trade_license_number, trade_license_document_url, package_type, subscription_cleaner_slots, created_at)\n         VALUES ($1, $2, $3, $4, $5, $6, $7, $8, NOW())\n         RETURNING *`,\n        [\n          data.companyName, \n          data.companyDescription, \n          data.pricePerWash, \n          user.id, \n          data.tradeLicenseNumber, \n          data.tradeLicenseDocumentURL,\n          data.packageType || 'pay_per_wash',\n          data.subscriptionCleanerSlots\n        ]\n      );\n      const company = companyResult.rows[0];\n      \n      // Update user with company_id\n      await client.query(\n        `UPDATE users SET company_id = $1 WHERE id = $2`,\n        [company.id, user.id]\n      );\n      \n      await client.query('COMMIT');\n      \n      // Fetch updated user\n      const updatedUserResult = await client.query('SELECT * FROM users WHERE id = $1', [user.id]);\n      const updatedUser = updatedUserResult.rows[0];\n      \n      return { \n        user: this.mapUserRow(updatedUser), \n        company: this.mapCompanyRow(company) \n      };\n    } catch (error) {\n      await client.query('ROLLBACK');\n      throw error;\n    } finally {\n      client.release();\n    }\n  }\n  \n  async getAllCompanies(): Promise<Company[]> {\n    return await db.select().from(companies);\n  }\n\n  async getPendingCompanies(): Promise<Company[]> {\n    return await db.select().from(companies).where(eq(companies.isActive, 0));\n  }\n\n  async approveCompany(companyId: number, platformFee?: number, feePackageType?: string): Promise<void> {\n    const updateData: any = { isActive: 1 };\n    if (platformFee !== undefined) {\n      updateData.platformFee = platformFee.toString();\n    }\n    if (feePackageType) {\n      updateData.feePackageType = feePackageType;\n    }\n    await db\n      .update(companies)\n      .set(updateData)\n      .where(eq(companies.id, companyId));\n  }\n\n  async rejectCompany(companyId: number): Promise<void> {\n    // For now, just delete the company. In production, you might want to keep a record\n    await db.delete(companies).where(eq(companies.id, companyId));\n  }\n\n  async getCompany(id: number): Promise<Company | undefined> {\n    const [company] = await db.select().from(companies).where(eq(companies.id, id));\n    return company;\n  }\n\n  async createCompany(companyData: InsertCompany): Promise<Company> {\n    const [company] = await db\n      .insert(companies)\n      .values([companyData as any])\n      .returning();\n    \n    return company;\n  }\n\n  async updateCompany(id: number, updates: Partial<Company>): Promise<void> {\n    await db\n      .update(companies)\n      .set(updates)\n      .where(eq(companies.id, id));\n  }\n\n  async getNearbyCompanies(lat: number, lon: number): Promise<CompanyWithCleaners[]> {\n    console.log(`[Geofence] Customer location: lat=${lat}, lon=${lon}`);\n    \n    // Get companies with geofences and their on-duty cleaners\n    const query = `\n      SELECT \n        c.id as company_id,\n        c.name,\n        c.description,\n        c.price_per_wash,\n        c.platform_fee,\n        c.fee_package_type,\n        c.package_type,\n        c.subscription_cleaner_slots,\n        c.total_jobs_completed,\n        c.total_revenue,\n        c.rating,\n        cg.id as geofence_id,\n        cg.polygon,\n        COUNT(DISTINCT cl.id) as cleaner_count\n      FROM companies c\n      INNER JOIN company_geofences cg ON cg.company_id = c.id\n      LEFT JOIN cleaners cl ON cl.company_id = c.id \n        AND cl.status = 'on_duty'\n        AND cl.last_location_update > NOW() - INTERVAL '10 minutes'\n      WHERE c.is_active = 1\n      GROUP BY c.id, c.name, c.description, c.price_per_wash, c.platform_fee, c.fee_package_type, c.package_type, c.subscription_cleaner_slots, c.total_jobs_completed, \n               c.total_revenue, c.rating, cg.id, cg.polygon\n    `;\n    \n    const result = await pool.query(query);\n    const rows = result.rows;\n    console.log(`[Geofence] Found ${rows.length} company-geofence combinations from SQL`);\n\n    // Filter companies whose geofences contain the customer location\n    const companyMap = new Map<number, CompanyWithCleaners>();\n    \n    for (const row of rows) {\n      const polygon = row.polygon as Array<[number, number]>;\n      const cleanerCount = parseInt(row.cleaner_count || '0');\n      \n      console.log(`[Geofence] Company ${row.company_id} \"${row.name}\" geofence ${row.geofence_id}: ${cleanerCount} cleaners, ${polygon?.length || 0} vertices`);\n      \n      // Skip if no on-duty cleaners\n      if (cleanerCount === 0) {\n        console.log(`[Geofence] ❌ Skip: No on-duty cleaners`);\n        continue;\n      }\n      \n      // Validate polygon before checking (minimum 3 vertices)\n      if (!polygon || !Array.isArray(polygon) || polygon.length < 3) {\n        console.warn(`[Geofence] ❌ Skip: Invalid polygon (${polygon?.length || 0} vertices, need 3+)`);\n        continue;\n      }\n      \n      // Check if point is inside polygon using ray casting algorithm\n      const isInside = this.isPointInPolygon(lat, lon, polygon);\n      console.log(`[Geofence] Point-in-polygon check: ${isInside ? '✅ INSIDE' : '❌ OUTSIDE'}`);\n      \n      if (isInside) {\n        const companyId = row.company_id;\n        const existing = companyMap.get(companyId);\n        \n        if (!existing) {\n          companyMap.set(companyId, {\n            id: row.company_id,\n            name: row.name,\n            description: row.description,\n            pricePerWash: row.price_per_wash,\n            platformFee: row.platform_fee || \"3.00\",\n            feePackageType: row.fee_package_type || 'custom',\n            packageType: row.package_type || 'pay_per_wash',\n            subscriptionCleanerSlots: row.subscription_cleaner_slots,\n            adminId: 0,\n            tradeLicenseNumber: null,\n            tradeLicenseDocumentURL: null,\n            isActive: 1,\n            totalJobsCompleted: row.total_jobs_completed,\n            totalRevenue: row.total_revenue,\n            rating: row.rating,\n            totalRatings: 0,\n            geofenceArea: null,\n            createdAt: new Date(),\n            onDutyCleanersCount: cleanerCount,\n          });\n        }\n      }\n    }\n    \n    // Sort by rating and total jobs completed\n    return Array.from(companyMap.values()).sort((a, b) => {\n      // Companies with higher ratings first\n      const ratingA = parseFloat(a.rating || '0');\n      const ratingB = parseFloat(b.rating || '0');\n      if (ratingB !== ratingA) {\n        return ratingB - ratingA;\n      }\n      // Then by total jobs completed\n      return (b.totalJobsCompleted || 0) - (a.totalJobsCompleted || 0);\n    });\n  }\n\n  // Point in polygon algorithm (ray casting)\n  private isPointInPolygon(lat: number, lon: number, polygon: Array<[number, number]>): boolean {\n    let inside = false;\n    const n = polygon.length;\n    \n    for (let i = 0, j = n - 1; i < n; j = i++) {\n      const [lat1, lon1] = polygon[i];\n      const [lat2, lon2] = polygon[j];\n      \n      const intersect = ((lon1 > lon) !== (lon2 > lon)) &&\n        (lat < (lat2 - lat1) * (lon - lon1) / (lon2 - lon1) + lat1);\n      \n      if (intersect) {\n        inside = !inside;\n      }\n    }\n    \n    return inside;\n  }\n\n  // Check if location is within any of company's geofences\n  async isLocationInCompanyGeofence(companyId: number, lat: number, lon: number): Promise<boolean> {\n    const geofences = await this.getCompanyGeofences(companyId);\n    \n    // Check if location is inside any of the company's geofences\n    for (const geofence of geofences) {\n      const polygon = geofence.polygon as Array<[number, number]>;\n      \n      // Validate polygon\n      if (!polygon || !Array.isArray(polygon) || polygon.length < 3) {\n        continue;\n      }\n      \n      if (this.isPointInPolygon(lat, lon, polygon)) {\n        return true;\n      }\n    }\n    \n    return false;\n  }\n\n  // ===== CLEANER INVITATION OPERATIONS =====\n  \n  async createInvitation(invitationData: InsertCleanerInvitation): Promise<CleanerInvitation> {\n    const [invitation] = await db\n      .insert(cleanerInvitations)\n      .values(invitationData)\n      .returning();\n    \n    return invitation;\n  }\n\n  async getInvitationByPhone(phoneNumber: string): Promise<CleanerInvitation | undefined> {\n    const [invitation] = await db\n      .select()\n      .from(cleanerInvitations)\n      .where(eq(cleanerInvitations.phoneNumber, phoneNumber));\n    \n    return invitation;\n  }\n\n  async getCompanyInvitations(companyId: number): Promise<CleanerInvitation[]> {\n    return await db\n      .select()\n      .from(cleanerInvitations)\n      .where(eq(cleanerInvitations.companyId, companyId))\n      .orderBy(desc(cleanerInvitations.invitedAt));\n  }\n\n  async consumeInvitation(phoneNumber: string): Promise<void> {\n    await db\n      .update(cleanerInvitations)\n      .set({ \n        status: \"consumed\",\n        consumedAt: new Date()\n      })\n      .where(eq(cleanerInvitations.phoneNumber, phoneNumber));\n  }\n\n  // ===== CLEANER OPERATIONS =====\n  \n  async getCleaner(id: number): Promise<Cleaner | undefined> {\n    const [cleaner] = await db.select().from(cleaners).where(eq(cleaners.id, id));\n    return cleaner;\n  }\n\n  async getCleanerByUserId(userId: number): Promise<Cleaner | undefined> {\n    const [cleaner] = await db.select().from(cleaners).where(eq(cleaners.userId, userId));\n    return cleaner;\n  }\n\n  async createCleaner(cleanerData: InsertCleaner): Promise<Cleaner> {\n    const [cleaner] = await db\n      .insert(cleaners)\n      .values(cleanerData)\n      .returning();\n    \n    return cleaner;\n  }\n\n  async updateCleaner(id: number, updates: Partial<Cleaner>): Promise<void> {\n    await db\n      .update(cleaners)\n      .set(updates)\n      .where(eq(cleaners.id, id));\n  }\n\n  async getCompanyCleaners(companyId: number, status?: CleanerStatus): Promise<any[]> {\n    const conditions = [eq(cleaners.companyId, companyId)];\n    \n    if (status) {\n      conditions.push(eq(cleaners.status, status));\n    }\n    \n    const results = await db\n      .select({\n        id: cleaners.id,\n        userId: cleaners.userId,\n        companyId: cleaners.companyId,\n        status: cleaners.status,\n        isActive: cleaners.isActive,\n        currentLatitude: cleaners.currentLatitude,\n        currentLongitude: cleaners.currentLongitude,\n        lastLocationUpdate: cleaners.lastLocationUpdate,\n        totalJobsCompleted: cleaners.totalJobsCompleted,\n        averageCompletionTime: cleaners.averageCompletionTime,\n        rating: cleaners.rating,\n        totalRatings: cleaners.totalRatings,\n        createdAt: cleaners.createdAt,\n        displayName: users.displayName,\n        phoneNumber: users.phoneNumber,\n        email: users.email,\n      })\n      .from(cleaners)\n      .leftJoin(users, eq(cleaners.userId, users.id))\n      .where(and(...conditions));\n    \n    return results;\n  }\n  \n  // Transactional cleaner + user creation\n  async createCleanerWithUser(data: {\n    email: string;\n    password: string;\n    displayName: string;\n    phoneNumber?: string;\n    companyId: number;\n  }): Promise<{ user: User; cleaner: Cleaner }> {\n    const client = await pool.connect();\n    \n    try {\n      await client.query('BEGIN');\n      \n      // Create user\n      const passwordHash = await bcrypt.hash(data.password, 10);\n      const userResult = await client.query(\n        `INSERT INTO users (email, password_hash, display_name, phone_number, role, company_id, created_at)\n         VALUES ($1, $2, $3, $4, $5, $6, NOW())\n         RETURNING *`,\n        [data.email.toLowerCase(), passwordHash, data.displayName, data.phoneNumber, UserRole.CLEANER, data.companyId]\n      );\n      const user = userResult.rows[0];\n      \n      // Create cleaner profile\n      const cleanerResult = await client.query(\n        `INSERT INTO cleaners (user_id, company_id, status, created_at)\n         VALUES ($1, $2, $3, NOW())\n         RETURNING *`,\n        [user.id, data.companyId, CleanerStatus.OFF_DUTY]\n      );\n      const cleaner = cleanerResult.rows[0];\n      \n      await client.query('COMMIT');\n      \n      return { \n        user: this.mapUserRow(user), \n        cleaner: this.mapCleanerRow(cleaner) \n      };\n    } catch (error) {\n      await client.query('ROLLBACK');\n      throw error;\n    } finally {\n      client.release();\n    }\n  }\n\n  // ===== JOB OPERATIONS =====\n  \n  async createJob(jobData: InsertJob): Promise<Job> {\n    const [job] = await db\n      .insert(jobs)\n      .values(jobData)\n      .returning();\n    \n    return job;\n  }\n\n  async getJob(id: number): Promise<Job | undefined> {\n    const [job] = await db.select().from(jobs).where(eq(jobs.id, id));\n    return job;\n  }\n\n  async updateJob(id: number, updates: Partial<Job>): Promise<void> {\n    await db\n      .update(jobs)\n      .set(updates)\n      .where(eq(jobs.id, id));\n  }\n\n  async atomicSetReceipt(jobId: number, receiptNumber: string, receiptGeneratedAt: Date): Promise<string> {\n    const result = await db\n      .update(jobs)\n      .set({ receiptNumber, receiptGeneratedAt })\n      .where(and(\n        eq(jobs.id, jobId),\n        isNull(jobs.receiptNumber)\n      ))\n      .returning({ receiptNumber: jobs.receiptNumber });\n    \n    if (result.length > 0 && result[0].receiptNumber) {\n      return result[0].receiptNumber;\n    }\n    \n    // Receipt was already set, fetch the existing one\n    const job = await this.getJob(jobId);\n    return job?.receiptNumber || receiptNumber;\n  }\n\n  async completeJobIfNotCompleted(\n    jobId: number, \n    data: { proofPhotoURL: string; receiptNumber: string; completedAt: Date }\n  ): Promise<{ updated: boolean; job?: Job }> {\n    // Atomic update: only update if job is NOT already completed\n    const result = await db\n      .update(jobs)\n      .set({\n        status: JobStatus.COMPLETED,\n        completedAt: data.completedAt,\n        proofPhotoURL: data.proofPhotoURL,\n        receiptNumber: data.receiptNumber,\n        receiptGeneratedAt: data.completedAt,\n      })\n      .where(\n        and(\n          eq(jobs.id, jobId),\n          ne(jobs.status, JobStatus.COMPLETED)\n        )\n      )\n      .returning();\n\n    // If no rows updated, job was already completed\n    if (result.length === 0) {\n      return { updated: false };\n    }\n\n    return { updated: true, job: result[0] };\n  }\n\n  async getJobsByCustomer(customerId: number, page = 1, pageSize = 20): Promise<{ data: Job[]; total: number }> {\n    // Get total count\n    const [{ count }] = await db\n      .select({ count: sql<number>`count(*)` })\n      .from(jobs)\n      .where(eq(jobs.customerId, customerId));\n\n    // Calculate pagination\n    const offset = (page - 1) * pageSize;\n\n    // Get paginated data\n    const data = await db\n      .select()\n      .from(jobs)\n      .where(eq(jobs.customerId, customerId))\n      .orderBy(desc(jobs.createdAt))\n      .limit(pageSize)\n      .offset(offset);\n\n    return { data, total: Number(count) };\n  }\n\n  async getJobsByPlateNumber(plateNumber: string, page = 1, pageSize = 20): Promise<{ data: Job[]; total: number }> {\n    // Parse the full plate number which is in format \"Emirate Code Number\" \n    // e.g., \"Abu Dhabi A 1\" or just \"1\" for backwards compatibility\n    const parts = plateNumber.trim().split(/\\s+/);\n    \n    let jobWhereClause;\n    let offlineWhereClause;\n    if (parts.length === 1) {\n      // Just a plate number (backwards compatibility)\n      jobWhereClause = eq(jobs.carPlateNumber, parts[0].toUpperCase());\n      offlineWhereClause = eq(offlineJobs.carPlateNumber, parts[0].toUpperCase());\n    } else if (parts.length >= 3) {\n      // Full format: \"Emirate Code Number\" (e.g., \"Abu Dhabi A 1\")\n      // Last part is number, second to last is code, rest is emirate\n      const number = parts[parts.length - 1].toUpperCase();\n      const code = parts[parts.length - 2].toUpperCase();\n      const emirate = parts.slice(0, parts.length - 2).join(' ');\n      \n      jobWhereClause = and(\n        eq(jobs.carPlateNumber, number),\n        eq(jobs.carPlateCode, code),\n        eq(jobs.carPlateEmirate, emirate)\n      );\n      offlineWhereClause = and(\n        eq(offlineJobs.carPlateNumber, number),\n        eq(offlineJobs.carPlateCode, code),\n        eq(offlineJobs.carPlateEmirate, emirate)\n      );\n    } else {\n      // Invalid format, return empty result\n      return { data: [], total: 0 };\n    }\n\n    // Get total count of regular jobs\n    const [{ count: jobCount }] = await db\n      .select({ count: sql<number>`count(*)` })\n      .from(jobs)\n      .where(jobWhereClause);\n\n    // Get total count of offline jobs (completed only)\n    const [{ count: offlineCount }] = await db\n      .select({ count: sql<number>`count(*)` })\n      .from(offlineJobs)\n      .where(and(offlineWhereClause, eq(offlineJobs.status, \"completed\")));\n\n    const totalCount = Number(jobCount) + Number(offlineCount);\n\n    // Get all regular jobs matching the plate\n    const regularJobs = await db\n      .select()\n      .from(jobs)\n      .where(jobWhereClause)\n      .orderBy(desc(jobs.createdAt));\n\n    // Get completed offline jobs matching the plate and transform to Job-like structure\n    const offlineJobsData = await db\n      .select({\n        id: offlineJobs.id,\n        cleanerId: offlineJobs.cleanerId,\n        companyId: offlineJobs.companyId,\n        carPlateNumber: offlineJobs.carPlateNumber,\n        carPlateEmirate: offlineJobs.carPlateEmirate,\n        carPlateCode: offlineJobs.carPlateCode,\n        servicePrice: offlineJobs.servicePrice,\n        completionPhotoUrl: offlineJobs.completionPhotoUrl,\n        completedAt: offlineJobs.completedAt,\n        createdAt: offlineJobs.createdAt,\n      })\n      .from(offlineJobs)\n      .where(and(offlineWhereClause, eq(offlineJobs.status, \"completed\")))\n      .orderBy(desc(offlineJobs.createdAt));\n\n    // Transform offline jobs to match Job structure for display\n    // Using partial Job structure since offline jobs don't have all Job fields\n    const transformedOfflineJobs = offlineJobsData.map(oj => ({\n      id: oj.id + 1000000, // Add offset to avoid ID collision\n      customerId: null,\n      companyId: oj.companyId,\n      cleanerId: oj.cleanerId,\n      status: JobStatus.COMPLETED,\n      carPlateNumber: oj.carPlateNumber || '',\n      carPlateEmirate: oj.carPlateEmirate || null,\n      carPlateCode: oj.carPlateCode || null,\n      locationAddress: 'Cash Payment',\n      locationLatitude: '0',\n      locationLongitude: '0',\n      parkingNumber: null,\n      customerEmail: '',\n      customerPhone: null,\n      price: oj.servicePrice,\n      taxAmount: '0',\n      tipAmount: '0',\n      totalAmount: oj.servicePrice,\n      stripePaymentIntentId: null,\n      stripeRefundId: null,\n      paymentMethod: 'cash' as const,\n      refundedAt: null,\n      refundReason: null,\n      receiptNumber: null,\n      receiptGeneratedAt: null,\n      assignedAt: oj.createdAt,\n      acceptedAt: oj.createdAt,\n      startedAt: oj.createdAt,\n      completedAt: oj.completedAt,\n      estimatedStartTime: null,\n      estimatedFinishTime: null,\n      proofPhotoURL: oj.completionPhotoUrl,\n      rating: null,\n      review: null,\n      ratingRequestedAt: null,\n      ratedAt: null,\n      requestedCleanerEmail: null,\n      directAssignmentAt: null,\n      createdAt: oj.createdAt,\n      isOfflineJob: true, // Custom flag to identify offline jobs\n    })) as unknown as Job[];\n\n    // Combine and sort by createdAt\n    const allJobs = [...regularJobs, ...transformedOfflineJobs].sort(\n      (a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime()\n    );\n\n    // Apply pagination\n    const offset = (page - 1) * pageSize;\n    const paginatedJobs = allJobs.slice(offset, offset + pageSize);\n\n    return { data: paginatedJobs, total: totalCount };\n  }\n\n  async getJobsByPhoneNumber(phoneNumber: string, page = 1, pageSize = 20): Promise<{ data: Job[]; total: number }> {\n    // Get total count\n    const [{ count }] = await db\n      .select({ count: sql<number>`count(*)` })\n      .from(jobs)\n      .where(eq(jobs.customerPhone, phoneNumber));\n\n    // Calculate pagination\n    const offset = (page - 1) * pageSize;\n\n    // Get paginated data\n    const data = await db\n      .select()\n      .from(jobs)\n      .where(eq(jobs.customerPhone, phoneNumber))\n      .orderBy(desc(jobs.createdAt))\n      .limit(pageSize)\n      .offset(offset);\n\n    return { data, total: Number(count) };\n  }\n\n  async getJobsByCleaner(cleanerId: number): Promise<Job[]> {\n    return await db\n      .select()\n      .from(jobs)\n      .where(eq(jobs.cleanerId, cleanerId))\n      .orderBy(desc(jobs.createdAt));\n  }\n\n  async getJobsByCompany(companyId: number, status?: JobStatus): Promise<Job[]> {\n    if (status) {\n      // For PAID status, only return jobs without a cleaner assigned (available jobs)\n      if (status === JobStatus.PAID) {\n        return await db\n          .select()\n          .from(jobs)\n          .where(and(\n            eq(jobs.companyId, companyId),\n            eq(jobs.status, status),\n            isNull(jobs.cleanerId)\n          ))\n          .orderBy(desc(jobs.createdAt));\n      }\n      \n      return await db\n        .select()\n        .from(jobs)\n        .where(and(\n          eq(jobs.companyId, companyId),\n          eq(jobs.status, status)\n        ))\n        .orderBy(desc(jobs.createdAt));\n    }\n    \n    return await db\n      .select()\n      .from(jobs)\n      .where(eq(jobs.companyId, companyId))\n      .orderBy(desc(jobs.createdAt));\n  }\n\n  async getJobByPaymentIntent(paymentIntentId: string): Promise<Job | undefined> {\n    const [job] = await db\n      .select()\n      .from(jobs)\n      .where(eq(jobs.stripePaymentIntentId, paymentIntentId));\n    \n    return job;\n  }\n\n  async acceptJob(jobId: number, cleanerId: number): Promise<boolean> {\n    const result = await db.transaction(async (tx) => {\n      const [job] = await tx\n        .select()\n        .from(jobs)\n        .where(and(\n          eq(jobs.id, jobId),\n          eq(jobs.status, JobStatus.PAID)\n        ))\n        .for('update');\n\n      if (!job || job.cleanerId !== null) {\n        return false;\n      }\n\n      await tx\n        .update(jobs)\n        .set({\n          cleanerId,\n          status: JobStatus.ASSIGNED,\n          assignedAt: new Date(),\n          acceptedAt: new Date(),\n        })\n        .where(eq(jobs.id, jobId));\n\n      await tx\n        .update(cleaners)\n        .set({ status: CleanerStatus.BUSY })\n        .where(eq(cleaners.id, cleanerId));\n\n      // Update job_financials with cleanerId\n      await tx\n        .update(jobFinancials)\n        .set({ cleanerId })\n        .where(eq(jobFinancials.jobId, jobId));\n\n      return true;\n    });\n\n    return result;\n  }\n\n  // ===== CUSTOMER OPERATIONS =====\n\n  async createOrGetCustomer(email: string, displayName?: string, phoneNumber?: string): Promise<Customer> {\n    // Check by email (primary identifier after OTP verification)\n    const existingByEmail = await this.getCustomerByEmail(email);\n    if (existingByEmail) {\n      // Update lastLogin and phone number if provided\n      const updateData: Partial<Customer> = { lastLoginAt: new Date() };\n      if (phoneNumber && phoneNumber !== existingByEmail.phoneNumber) {\n        updateData.phoneNumber = phoneNumber;\n      }\n      \n      const [updated] = await db\n        .update(customers)\n        .set(updateData)\n        .where(eq(customers.id, existingByEmail.id))\n        .returning();\n      \n      return updated;\n    }\n\n    // Email doesn't exist - create new customer\n    // Note: Phone numbers can be duplicated (no unique constraint)\n    const [customer] = await db\n      .insert(customers)\n      .values({\n        email,\n        phoneNumber,\n        displayName,\n      })\n      .returning();\n\n    return customer;\n  }\n\n  async getCustomerByEmail(email: string): Promise<Customer | undefined> {\n    const [customer] = await db\n      .select()\n      .from(customers)\n      .where(eq(customers.email, email));\n    return customer;\n  }\n\n  async getCustomerByPhone(phoneNumber: string): Promise<Customer | undefined> {\n    const [customer] = await db\n      .select()\n      .from(customers)\n      .where(eq(customers.phoneNumber, phoneNumber));\n    return customer;\n  }\n\n  async updateCustomerLastLogin(id: number): Promise<void> {\n    await db\n      .update(customers)\n      .set({ lastLoginAt: new Date() })\n      .where(eq(customers.id, id));\n  }\n\n  async getCarHistoryByPlate(carPlateEmirate: string, carPlateCode: string, carPlateNumber: string): Promise<any[]> {\n    const jobList = await db\n      .select()\n      .from(jobs)\n      .where(\n        and(\n          eq(jobs.carPlateEmirate, carPlateEmirate),\n          eq(jobs.carPlateCode, carPlateCode),\n          eq(jobs.carPlateNumber, carPlateNumber)\n        )\n      )\n      .orderBy(jobs.createdAt);\n\n    // Extract unique customer emails and parking numbers\n    const carsMap = new Map();\n    for (const job of jobList) {\n      const key = job.customerEmail;\n      if (!carsMap.has(key)) {\n        carsMap.set(key, {\n          customerEmail: job.customerEmail,\n          customerPhone: job.customerPhone || \"\",\n          parkingNumber: job.parkingNumber || \"\",\n          lastUsed: job.createdAt,\n        });\n      } else {\n        // Update if this job is more recent\n        const existing = carsMap.get(key);\n        if (new Date(job.createdAt) > new Date(existing.lastUsed)) {\n          carsMap.set(key, {\n            customerEmail: job.customerEmail,\n            customerPhone: job.customerPhone || \"\",\n            parkingNumber: job.parkingNumber || \"\",\n            lastUsed: job.createdAt,\n          });\n        }\n      }\n    }\n\n    // Convert to array and sort by most recent\n    return Array.from(carsMap.values()).sort(\n      (a, b) => new Date(b.lastUsed).getTime() - new Date(a.lastUsed).getTime()\n    );\n  }\n\n  // ===== SHIFT SESSION OPERATIONS =====\n\n  async startShift(cleanerId: number, latitude?: number, longitude?: number): Promise<CleanerShift> {\n    // Close any existing open shifts first\n    await this.endShift(cleanerId);\n\n    // Get cleaner's company ID\n    const cleaner = await this.getCleaner(cleanerId);\n    if (!cleaner) {\n      throw new Error(\"Cleaner not found\");\n    }\n\n    const [shift] = await db\n      .insert(cleanerShifts)\n      .values({ \n        cleanerId,\n        companyId: cleaner.companyId,\n        shiftStart: new Date(),\n        startLatitude: latitude?.toString(),\n        startLongitude: longitude?.toString(),\n      })\n      .returning();\n\n    await db\n      .update(cleaners)\n      .set({ \n        status: CleanerStatus.ON_DUTY,\n        lastLocationUpdate: new Date(),\n      })\n      .where(eq(cleaners.id, cleanerId));\n\n    return shift;\n  }\n\n  async endShift(cleanerId: number, latitude?: number, longitude?: number): Promise<void> {\n    const activeShift = await this.getActiveShift(cleanerId);\n    if (!activeShift) return;\n\n    const shiftEnd = new Date();\n    const durationMinutes = Math.floor(\n      (shiftEnd.getTime() - new Date(activeShift.shiftStart).getTime()) / (1000 * 60)\n    );\n\n    await db\n      .update(cleanerShifts)\n      .set({ \n        shiftEnd, \n        durationMinutes,\n        endLatitude: latitude?.toString(),\n        endLongitude: longitude?.toString(),\n      })\n      .where(eq(cleanerShifts.id, activeShift.id));\n\n    await db\n      .update(cleaners)\n      .set({ status: CleanerStatus.OFF_DUTY })\n      .where(eq(cleaners.id, cleanerId));\n  }\n\n  async getActiveShift(cleanerId: number): Promise<CleanerShift | undefined> {\n    const [shift] = await db\n      .select()\n      .from(cleanerShifts)\n      .where(and(\n        eq(cleanerShifts.cleanerId, cleanerId),\n        sql`${cleanerShifts.shiftEnd} IS NULL`\n      ))\n      .orderBy(desc(cleanerShifts.shiftStart))\n      .limit(1);\n    return shift;\n  }\n\n  async getCleanerShiftHistory(cleanerId: number, filters?: {\n    startDate?: Date;\n    endDate?: Date;\n    limit?: number;\n  }): Promise<CleanerShift[]> {\n    const conditions = [eq(cleanerShifts.cleanerId, cleanerId)];\n    \n    if (filters?.startDate) {\n      conditions.push(gte(cleanerShifts.shiftStart, filters.startDate));\n    }\n    \n    if (filters?.endDate) {\n      // Add 1 day to endDate to include the entire day\n      const endOfDay = new Date(filters.endDate);\n      endOfDay.setDate(endOfDay.getDate() + 1);\n      conditions.push(sql`${cleanerShifts.shiftStart} < ${endOfDay}`);\n    }\n    \n    return await db\n      .select()\n      .from(cleanerShifts)\n      .where(and(...conditions))\n      .orderBy(desc(cleanerShifts.shiftStart))\n      .limit(filters?.limit || 100);\n  }\n\n  async getCompanyShiftHistory(companyId: number, filters?: {\n    cleanerId?: number;\n    startDate?: Date;\n    endDate?: Date;\n    limit?: number;\n  }): Promise<Array<CleanerShift & { cleanerName: string }>> {\n    const conditions = [eq(cleanerShifts.companyId, companyId)];\n    \n    if (filters?.cleanerId) {\n      conditions.push(eq(cleanerShifts.cleanerId, filters.cleanerId));\n    }\n    \n    if (filters?.startDate) {\n      conditions.push(gte(cleanerShifts.shiftStart, filters.startDate));\n    }\n    \n    if (filters?.endDate) {\n      // Add 1 day to endDate to include the entire day\n      const endOfDay = new Date(filters.endDate);\n      endOfDay.setDate(endOfDay.getDate() + 1);\n      conditions.push(sql`${cleanerShifts.shiftStart} < ${endOfDay}`);\n    }\n\n    const results = await db\n      .select({\n        id: cleanerShifts.id,\n        cleanerId: cleanerShifts.cleanerId,\n        companyId: cleanerShifts.companyId,\n        shiftStart: cleanerShifts.shiftStart,\n        shiftEnd: cleanerShifts.shiftEnd,\n        durationMinutes: cleanerShifts.durationMinutes,\n        startLatitude: cleanerShifts.startLatitude,\n        startLongitude: cleanerShifts.startLongitude,\n        endLatitude: cleanerShifts.endLatitude,\n        endLongitude: cleanerShifts.endLongitude,\n        createdAt: cleanerShifts.createdAt,\n        cleanerName: users.displayName,\n      })\n      .from(cleanerShifts)\n      .leftJoin(cleaners, eq(cleanerShifts.cleanerId, cleaners.id))\n      .leftJoin(users, eq(cleaners.userId, users.id))\n      .where(and(...conditions))\n      .orderBy(desc(cleanerShifts.shiftStart))\n      .limit(filters?.limit || 100);\n\n    return results.map(r => ({\n      ...r,\n      cleanerName: r.cleanerName || 'Unknown',\n    }));\n  }\n\n  // ===== CLEANER PAYMENT TOKEN OPERATIONS =====\n  \n  async createCleanerPaymentToken(cleanerId: number, companyId: number, token: string, expiresAt?: Date): Promise<CleanerPaymentToken> {\n    const [paymentToken] = await db\n      .insert(cleanerPaymentTokens)\n      .values({\n        cleanerId,\n        companyId,\n        token,\n        expiresAt: expiresAt || new Date(Date.now() + 24 * 60 * 60 * 1000),\n        isUsed: 0,\n      })\n      .returning();\n    \n    return paymentToken;\n  }\n  \n  async getCleanerPaymentToken(token: string): Promise<CleanerPaymentToken | undefined> {\n    const [paymentToken] = await db\n      .select()\n      .from(cleanerPaymentTokens)\n      .where(eq(cleanerPaymentTokens.token, token));\n    \n    return paymentToken;\n  }\n  \n  async markTokenAsUsed(tokenId: number): Promise<void> {\n    await db\n      .update(cleanerPaymentTokens)\n      .set({\n        isUsed: 1,\n        usedAt: new Date(),\n      })\n      .where(eq(cleanerPaymentTokens.id, tokenId));\n  }\n  \n  async deleteExpiredTokens(): Promise<void> {\n    await db\n      .delete(cleanerPaymentTokens)\n      .where(\n        and(\n          sql`${cleanerPaymentTokens.expiresAt} < NOW()`,\n          eq(cleanerPaymentTokens.isUsed, 0)\n        )\n      );\n  }\n\n  // ===== ANALYTICS =====\n  \n  async getAdminAnalytics(): Promise<any> {\n    const now = new Date();\n    const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);\n    \n    const [totalCompaniesResult] = await db.select({ count: sql<number>`count(*)` }).from(companies);\n    const [totalCleanersResult] = await db.select({ count: sql<number>`count(*)` }).from(cleaners);\n    const [activeJobsResult] = await db.select({ count: sql<number>`count(*)` }).from(jobs)\n      .where(eq(jobs.status, \"in_progress\"));\n    const [completedJobsResult] = await db.select({ count: sql<number>`count(*)` }).from(jobs)\n      .where(eq(jobs.status, \"completed\"));\n    \n    // Calculate platform revenue using job_financials\n    // Gross revenue includes all financial transactions (completed + refunded)\n    // Net revenue only includes completed jobs\n    const [totalRevenueResult] = await db.select({ \n      grossRevenue: sql<string>`COALESCE(SUM(${jobFinancials.grossAmount}), 0)::text`,\n      netRevenue: sql<string>`COALESCE(SUM(CASE WHEN ${jobs.status} = 'completed' THEN ${jobFinancials.netPayableAmount} ELSE 0 END), 0)::text`\n    })\n      .from(jobFinancials)\n      .innerJoin(jobs, eq(jobFinancials.jobId, jobs.id))\n      .where(inArray(jobs.status, ['completed', 'refunded']));\n    \n    const [revenueThisMonthResult] = await db.select({ \n      grossRevenue: sql<string>`COALESCE(SUM(${jobFinancials.grossAmount}), 0)::text`,\n      netRevenue: sql<string>`COALESCE(SUM(CASE WHEN ${jobs.status} = 'completed' THEN ${jobFinancials.netPayableAmount} ELSE 0 END), 0)::text`\n    })\n      .from(jobFinancials)\n      .innerJoin(jobs, eq(jobFinancials.jobId, jobs.id))\n      .where(and(\n        inArray(jobs.status, ['completed', 'refunded']),\n        gte(jobFinancials.createdAt, firstDayOfMonth)\n      ));\n    \n    return {\n      totalCompanies: parseInt(String(totalCompaniesResult.count), 10),\n      totalCleaners: parseInt(String(totalCleanersResult.count), 10),\n      activeJobs: parseInt(String(activeJobsResult.count), 10),\n      completedJobs: parseInt(String(completedJobsResult.count), 10),\n      totalRevenue: parseFloat(totalRevenueResult.grossRevenue || \"0\"),\n      totalNetRevenue: parseFloat(totalRevenueResult.netRevenue || \"0\"),\n      revenueThisMonth: parseFloat(revenueThisMonthResult.grossRevenue || \"0\"),\n      netRevenueThisMonth: parseFloat(revenueThisMonthResult.netRevenue || \"0\"),\n    };\n  }\n\n  async getCompanyAnalytics(companyId: number): Promise<any> {\n    const now = new Date();\n    const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);\n    const tenMinutesAgo = new Date(now.getTime() - 10 * 60 * 1000);\n    \n    const [company] = await db.select().from(companies).where(eq(companies.id, companyId));\n    \n    // Count active cleaners (on_duty + location update within 10 minutes)\n    const [activeCleanersResult] = await db.select({ count: sql<number>`count(*)` }).from(cleaners)\n      .where(and(\n        eq(cleaners.companyId, companyId),\n        eq(cleaners.status, \"on_duty\"),\n        gte(cleaners.lastLocationUpdate, tenMinutesAgo)\n      ));\n    \n    // Count all completed jobs (all time) - includes online jobs\n    const [totalJobsCompletedResult] = await db.select({ count: sql<number>`count(*)` }).from(jobs)\n      .where(and(\n        eq(jobs.companyId, companyId),\n        eq(jobs.status, \"completed\")\n      ));\n    \n    // Count completed offline/cash jobs (all time)\n    const [totalOfflineJobsResult] = await db.select({ count: sql<number>`count(*)` }).from(offlineJobs)\n      .where(and(\n        eq(offlineJobs.companyId, companyId),\n        eq(offlineJobs.status, \"completed\")\n      ));\n    \n    // Count only completed jobs this month (revenue-recognized) - online jobs\n    const [jobsThisMonthResult] = await db.select({ count: sql<number>`count(*)` }).from(jobs)\n      .where(and(\n        eq(jobs.companyId, companyId),\n        eq(jobs.status, \"completed\"),\n        gte(jobs.createdAt, firstDayOfMonth)\n      ));\n    \n    // Count completed offline jobs this month\n    const [offlineJobsThisMonthResult] = await db.select({ count: sql<number>`count(*)` }).from(offlineJobs)\n      .where(and(\n        eq(offlineJobs.companyId, companyId),\n        eq(offlineJobs.status, \"completed\"),\n        gte(offlineJobs.createdAt, firstDayOfMonth)\n      ));\n    \n    // Calculate revenue using net payable amount (what company actually earns)\n    // Gross revenue includes all financial transactions (completed + refunded)\n    // Net revenue only includes completed jobs (revenue recognition)\n    const [totalRevenueResult] = await db.select({ \n      grossRevenue: sql<string>`COALESCE(SUM(${jobFinancials.grossAmount}), 0)::text`,\n      netRevenue: sql<string>`COALESCE(SUM(CASE WHEN ${jobs.status} = 'completed' THEN ${jobFinancials.netPayableAmount} ELSE 0 END), 0)::text`\n    })\n      .from(jobFinancials)\n      .innerJoin(jobs, eq(jobFinancials.jobId, jobs.id))\n      .where(and(\n        eq(jobFinancials.companyId, companyId),\n        inArray(jobs.status, ['completed', 'refunded'])\n      ));\n    \n    // Calculate offline job revenue (all time) - for cash jobs, total amount = net earnings (no platform fee)\n    const [offlineTotalRevenueResult] = await db.select({ \n      totalRevenue: sql<string>`COALESCE(SUM(${offlineJobs.totalAmount}::numeric), 0)::text`\n    })\n      .from(offlineJobs)\n      .where(and(\n        eq(offlineJobs.companyId, companyId),\n        eq(offlineJobs.status, \"completed\")\n      ));\n    \n    const [revenueThisMonthResult] = await db.select({ \n      grossRevenue: sql<string>`COALESCE(SUM(${jobFinancials.grossAmount}), 0)::text`,\n      netRevenue: sql<string>`COALESCE(SUM(CASE WHEN ${jobs.status} = 'completed' THEN ${jobFinancials.netPayableAmount} ELSE 0 END), 0)::text`\n    })\n      .from(jobFinancials)\n      .innerJoin(jobs, eq(jobFinancials.jobId, jobs.id))\n      .where(and(\n        eq(jobFinancials.companyId, companyId),\n        inArray(jobs.status, ['completed', 'refunded']),\n        gte(jobFinancials.createdAt, firstDayOfMonth)\n      ));\n    \n    // Calculate offline job revenue this month\n    const [offlineRevenueThisMonthResult] = await db.select({ \n      totalRevenue: sql<string>`COALESCE(SUM(${offlineJobs.totalAmount}::numeric), 0)::text`\n    })\n      .from(offlineJobs)\n      .where(and(\n        eq(offlineJobs.companyId, companyId),\n        eq(offlineJobs.status, \"completed\"),\n        gte(offlineJobs.createdAt, firstDayOfMonth)\n      ));\n    \n    // Get shift roster with optimized query (joins cleaners + users + active shifts)\n    const shiftRosterData = await db\n      .select({\n        cleanerId: cleaners.id,\n        cleanerName: users.displayName,\n        status: cleaners.status,\n        totalJobsCompleted: cleaners.totalJobsCompleted,\n        rating: cleaners.rating,\n        userId: cleaners.userId,\n      })\n      .from(cleaners)\n      .leftJoin(users, eq(cleaners.userId, users.id))\n      .where(eq(cleaners.companyId, companyId));\n    \n    // Batch fetch active shifts for all cleaners (skip if no cleaners)\n    const cleanerIds = shiftRosterData.map(c => c.cleanerId);\n    const activeShifts = cleanerIds.length > 0 \n      ? await db\n          .select()\n          .from(shiftSessions)\n          .where(and(\n            inArray(shiftSessions.cleanerId, cleanerIds),\n            isNull(shiftSessions.endedAt)\n          ))\n      : [];\n    \n    // Map active shifts by cleanerId for quick lookup\n    const shiftsMap = new Map(activeShifts.map(s => [s.cleanerId, s]));\n    \n    const shiftRoster = shiftRosterData.map(cleaner => {\n      const activeShift = shiftsMap.get(cleaner.cleanerId);\n      return {\n        cleanerId: cleaner.cleanerId,\n        cleanerName: cleaner.cleanerName || 'Unknown',\n        status: cleaner.status,\n        totalJobsCompleted: cleaner.totalJobsCompleted,\n        rating: parseFloat(cleaner.rating as any) || 0,\n        activeShift: activeShift ? {\n          startedAt: activeShift.startedAt,\n          duration: Math.floor((now.getTime() - new Date(activeShift.startedAt).getTime()) / 60000),\n        } : null,\n      };\n    });\n    \n    // Combine online and offline job counts and revenue\n    const onlineJobsTotal = parseInt(String(totalJobsCompletedResult.count), 10);\n    const offlineJobsTotal = parseInt(String(totalOfflineJobsResult.count), 10);\n    const onlineJobsMonth = parseInt(String(jobsThisMonthResult.count), 10);\n    const offlineJobsMonth = parseInt(String(offlineJobsThisMonthResult.count), 10);\n    \n    const onlineRevenue = parseFloat(totalRevenueResult.grossRevenue || \"0\");\n    const offlineRevenue = parseFloat(offlineTotalRevenueResult.totalRevenue || \"0\");\n    const onlineNetEarnings = parseFloat(totalRevenueResult.netRevenue || \"0\");\n    \n    const onlineRevenueMonth = parseFloat(revenueThisMonthResult.grossRevenue || \"0\");\n    const offlineRevenueMonth = parseFloat(offlineRevenueThisMonthResult.totalRevenue || \"0\");\n    const onlineNetEarningsMonth = parseFloat(revenueThisMonthResult.netRevenue || \"0\");\n    \n    return {\n      totalJobsCompleted: onlineJobsTotal + offlineJobsTotal,\n      totalRevenue: onlineRevenue + offlineRevenue,\n      totalNetEarnings: onlineNetEarnings + offlineRevenue, // Offline has no platform fee\n      averageRating: parseFloat(company?.rating as any) || 0,\n      activeCleaners: parseInt(String(activeCleanersResult.count), 10),\n      jobsThisMonth: onlineJobsMonth + offlineJobsMonth,\n      revenueThisMonth: onlineRevenueMonth + offlineRevenueMonth,\n      netEarningsThisMonth: onlineNetEarningsMonth + offlineRevenueMonth, // Offline has no platform fee\n      shiftRoster,\n      // Include breakdown for transparency\n      onlineJobsCompleted: onlineJobsTotal,\n      offlineJobsCompleted: offlineJobsTotal,\n      offlineRevenue: offlineRevenue,\n      offlineRevenueThisMonth: offlineRevenueMonth,\n    };\n  }\n\n  // ===== UTILITY METHODS =====\n  \n  private calculateDistance(lat1: number, lon1: number, lat2: number, lon2: number): number {\n    const R = 6371e3; // Earth's radius in meters\n    const φ1 = (lat1 * Math.PI) / 180;\n    const φ2 = (lat2 * Math.PI) / 180;\n    const Δφ = ((lat2 - lat1) * Math.PI) / 180;\n    const Δλ = ((lon2 - lon1) * Math.PI) / 180;\n\n    const a =\n      Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +\n      Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ / 2) * Math.sin(Δλ / 2);\n    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\n\n    return R * c; // Distance in meters\n  }\n  \n  // Map database rows to TypeScript types\n  // ===== DEVICE TOKEN OPERATIONS =====\n  \n  async registerDeviceToken(userId: number, token: string, platform: string): Promise<void> {\n    // Use upsert to update lastUsedAt if token already exists\n    await db\n      .insert(deviceTokens)\n      .values({ userId, token, platform })\n      .onConflictDoUpdate({\n        target: deviceTokens.token,\n        set: { lastUsedAt: new Date() }\n      });\n  }\n\n  async unregisterDeviceToken(token: string): Promise<void> {\n    await db\n      .delete(deviceTokens)\n      .where(eq(deviceTokens.token, token));\n  }\n\n  async getUserDeviceTokens(userId: number): Promise<string[]> {\n    const tokens = await db\n      .select({ token: deviceTokens.token })\n      .from(deviceTokens)\n      .where(eq(deviceTokens.userId, userId));\n    \n    return tokens.map(t => t.token);\n  }\n\n  async updateTokenLastUsed(token: string): Promise<void> {\n    await db\n      .update(deviceTokens)\n      .set({ lastUsedAt: new Date() })\n      .where(eq(deviceTokens.token, token));\n  }\n\n  // ===== PUSH SUBSCRIPTION OPERATIONS =====\n  \n  async createPushSubscription(data: { \n    userId?: number; \n    customerId?: number; \n    endpoint: string; \n    keys: { p256dh: string; auth: string };\n    soundEnabled?: number;\n  }): Promise<void> {\n    await db\n      .insert(pushSubscriptions)\n      .values({\n        userId: data.userId || null,\n        customerId: data.customerId || null,\n        endpoint: data.endpoint,\n        keys: data.keys,\n        soundEnabled: data.soundEnabled || 0,\n      })\n      .onConflictDoNothing();\n  }\n\n  async deletePushSubscription(endpoint: string): Promise<void> {\n    await db\n      .delete(pushSubscriptions)\n      .where(eq(pushSubscriptions.endpoint, endpoint));\n  }\n\n  async updatePushSubscriptionSound(endpoint: string, soundEnabled: number): Promise<void> {\n    await db\n      .update(pushSubscriptions)\n      .set({ soundEnabled })\n      .where(eq(pushSubscriptions.endpoint, endpoint));\n  }\n\n  async getPushSubscriptionByEndpoint(endpoint: string): Promise<{ soundEnabled: number } | undefined> {\n    const [sub] = await db\n      .select({ soundEnabled: pushSubscriptions.soundEnabled })\n      .from(pushSubscriptions)\n      .where(eq(pushSubscriptions.endpoint, endpoint));\n    \n    return sub ? { soundEnabled: sub.soundEnabled || 0 } : undefined;\n  }\n\n  async getUserPushSubscriptions(userId: number): Promise<Array<{ endpoint: string; keys: { p256dh: string; auth: string }; soundEnabled: number }>> {\n    const subs = await db\n      .select({\n        endpoint: pushSubscriptions.endpoint,\n        keys: pushSubscriptions.keys,\n        soundEnabled: pushSubscriptions.soundEnabled,\n      })\n      .from(pushSubscriptions)\n      .where(eq(pushSubscriptions.userId, userId));\n    \n    return subs.map(s => ({\n      endpoint: s.endpoint,\n      keys: s.keys as { p256dh: string; auth: string },\n      soundEnabled: s.soundEnabled || 0,\n    }));\n  }\n\n  async getCustomerPushSubscriptions(customerId: number): Promise<Array<{ endpoint: string; keys: { p256dh: string; auth: string }; soundEnabled: number }>> {\n    const subs = await db\n      .select({\n        endpoint: pushSubscriptions.endpoint,\n        keys: pushSubscriptions.keys,\n        soundEnabled: pushSubscriptions.soundEnabled,\n      })\n      .from(pushSubscriptions)\n      .where(eq(pushSubscriptions.customerId, customerId));\n    \n    return subs.map(s => ({\n      endpoint: s.endpoint,\n      keys: s.keys as { p256dh: string; auth: string },\n      soundEnabled: s.soundEnabled || 0,\n    }));\n  }\n\n  async getAllPushSubscriptionsByRole(role: string): Promise<Array<{ endpoint: string; keys: { p256dh: string; auth: string }; soundEnabled: number }>> {\n    const subs = await db\n      .select({\n        endpoint: pushSubscriptions.endpoint,\n        keys: pushSubscriptions.keys,\n        soundEnabled: pushSubscriptions.soundEnabled,\n      })\n      .from(pushSubscriptions)\n      .innerJoin(users, eq(pushSubscriptions.userId, users.id))\n      .where(eq(users.role, role as any));\n    \n    return subs.map(s => ({\n      endpoint: s.endpoint,\n      keys: s.keys as { p256dh: string; auth: string },\n      soundEnabled: s.soundEnabled || 0,\n    }));\n  }\n\n  // ===== FINANCIAL OPERATIONS =====\n  \n  async getCurrentFeeSettings(): Promise<FeeSetting> {\n    const [settings] = await db\n      .select()\n      .from(feeSettings)\n      .orderBy(desc(feeSettings.effectiveFrom))\n      .limit(1);\n    \n    if (!settings) {\n      throw new Error(\"Fee settings not found\");\n    }\n    \n    return settings;\n  }\n\n  async createJobFinancials(financials: InsertJobFinancials): Promise<JobFinancials> {\n    const [result] = await db\n      .insert(jobFinancials)\n      .values(financials)\n      .returning();\n    \n    return result;\n  }\n\n  async getJobFinancialsByJobId(jobId: number): Promise<JobFinancials | undefined> {\n    const [result] = await db\n      .select()\n      .from(jobFinancials)\n      .where(eq(jobFinancials.jobId, jobId));\n    \n    return result;\n  }\n\n  async getCompanyFinancials(\n    companyId: number,\n    filters?: {\n      cleanerId?: number;\n      startDate?: Date;\n      endDate?: Date;\n      page?: number;\n      pageSize?: number;\n    }\n  ): Promise<{ data: JobFinancialsWithCleaner[]; total: number }> {\n    const conditions = [eq(jobFinancials.companyId, companyId)];\n\n    if (filters?.cleanerId) {\n      conditions.push(eq(jobFinancials.cleanerId, filters.cleanerId));\n    }\n\n    if (filters?.startDate) {\n      conditions.push(gte(jobFinancials.paidAt, filters.startDate));\n    }\n\n    if (filters?.endDate) {\n      conditions.push(sql`${jobFinancials.paidAt} <= ${filters.endDate}`);\n    }\n\n    // Get total count\n    const [{ count }] = await db\n      .select({ count: sql<number>`count(*)` })\n      .from(jobFinancials)\n      .where(and(...conditions));\n\n    // Calculate pagination\n    const page = filters?.page || 1;\n    const pageSize = filters?.pageSize || 20;\n    const offset = (page - 1) * pageSize;\n\n    // Join with cleaners, users, companies, and jobs to get cleaner details, fee package type, and transaction references\n    const results = await db\n      .select({\n        id: jobFinancials.id,\n        jobId: jobFinancials.jobId,\n        companyId: jobFinancials.companyId,\n        cleanerId: jobFinancials.cleanerId,\n        baseJobAmount: jobFinancials.baseJobAmount,\n        baseTax: jobFinancials.baseTax,\n        tipAmount: jobFinancials.tipAmount,\n        tipTax: jobFinancials.tipTax,\n        platformFeeAmount: jobFinancials.platformFeeAmount,\n        platformFeeTax: jobFinancials.platformFeeTax,\n        paymentProcessingFeeAmount: jobFinancials.paymentProcessingFeeAmount,\n        companyStripeFeeShare: jobFinancials.companyStripeFeeShare,\n        cleanerStripeFeeShare: jobFinancials.cleanerStripeFeeShare,\n        remainingTip: jobFinancials.remainingTip,\n        grossAmount: jobFinancials.grossAmount,\n        netPayableAmount: jobFinancials.netPayableAmount,\n        taxAmount: jobFinancials.taxAmount,\n        platformRevenue: jobFinancials.platformRevenue,\n        currency: jobFinancials.currency,\n        paidAt: jobFinancials.paidAt,\n        refundedAt: jobFinancials.refundedAt,\n        createdAt: jobFinancials.createdAt,\n        cleanerName: users.displayName,\n        cleanerEmail: users.email,\n        cleanerPhone: users.phoneNumber,\n        feePackageType: companies.feePackageType,\n        receiptNumber: jobs.receiptNumber,\n        stripePaymentIntentId: jobs.stripePaymentIntentId,\n        stripeRefundId: jobs.stripeRefundId,\n        jobStatus: jobs.status,\n      })\n      .from(jobFinancials)\n      .leftJoin(jobs, eq(jobFinancials.jobId, jobs.id))\n      .leftJoin(cleaners, eq(jobFinancials.cleanerId, cleaners.id))\n      .leftJoin(users, eq(cleaners.userId, users.id))\n      .leftJoin(companies, eq(jobFinancials.companyId, companies.id))\n      .where(and(...conditions))\n      .orderBy(desc(jobFinancials.paidAt))\n      .limit(pageSize)\n      .offset(offset);\n\n    return { data: results, total: Number(count) };\n  }\n\n  async getCleanerTips(\n    cleanerId: number,\n    filters?: {\n      startDate?: Date;\n      endDate?: Date;\n      page?: number;\n      pageSize?: number;\n    }\n  ): Promise<{ \n    data: Array<{\n      jobId: number;\n      completedAt: Date;\n      carPlateNumber: string;\n      customerEmail: string;\n      tipAmount: number;\n      cleanerStripeFeeShare: number;\n      remainingTip: number;\n      receiptNumber: string | null;\n    }>;\n    total: number;\n  }> {\n    const conditions = [\n      eq(jobFinancials.cleanerId, cleanerId),\n      sql`${jobFinancials.tipAmount} > 0`, // Only jobs with tips\n    ];\n\n    if (filters?.startDate) {\n      conditions.push(gte(jobs.completedAt, filters.startDate));\n    }\n\n    if (filters?.endDate) {\n      conditions.push(sql`${jobs.completedAt} <= ${filters.endDate}`);\n    }\n\n    // Get total count\n    const [{ count }] = await db\n      .select({ count: sql<number>`count(*)` })\n      .from(jobFinancials)\n      .innerJoin(jobs, eq(jobFinancials.jobId, jobs.id))\n      .where(and(...conditions));\n\n    // Calculate pagination\n    const page = filters?.page || 1;\n    const pageSize = filters?.pageSize || 20;\n    const offset = (page - 1) * pageSize;\n\n    const results = await db\n      .select({\n        jobId: jobFinancials.jobId,\n        completedAt: jobs.completedAt,\n        carPlateNumber: jobs.carPlateNumber,\n        customerEmail: jobs.customerEmail,\n        tipAmount: jobFinancials.tipAmount,\n        cleanerStripeFeeShare: jobFinancials.cleanerStripeFeeShare,\n        remainingTip: jobFinancials.remainingTip,\n        receiptNumber: jobs.receiptNumber,\n      })\n      .from(jobFinancials)\n      .innerJoin(jobs, eq(jobFinancials.jobId, jobs.id))\n      .where(and(...conditions))\n      .orderBy(desc(jobs.completedAt))\n      .limit(pageSize)\n      .offset(offset);\n\n    return {\n      data: results.map(r => ({\n        ...r,\n        completedAt: r.completedAt!,\n        tipAmount: Number(r.tipAmount),\n        cleanerStripeFeeShare: Number(r.cleanerStripeFeeShare),\n        remainingTip: Number(r.remainingTip),\n      })),\n      total: Number(count),\n    };\n  }\n\n  // ===== COMPANY WITHDRAWAL OPERATIONS =====\n\n  async createWithdrawal(withdrawal: InsertCompanyWithdrawal): Promise<CompanyWithdrawal> {\n    const [result] = await db\n      .insert(companyWithdrawals)\n      .values(withdrawal)\n      .returning();\n    \n    return result;\n  }\n\n  async updateWithdrawal(id: number, updates: Partial<CompanyWithdrawal>): Promise<void> {\n    await db\n      .update(companyWithdrawals)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(companyWithdrawals.id, id));\n  }\n\n  async getCompanyWithdrawals(companyId: number): Promise<CompanyWithdrawal[]> {\n    return await db\n      .select()\n      .from(companyWithdrawals)\n      .where(eq(companyWithdrawals.companyId, companyId))\n      .orderBy(desc(companyWithdrawals.createdAt));\n  }\n\n  async getAllWithdrawals(): Promise<CompanyWithdrawal[]> {\n    return await db\n      .select()\n      .from(companyWithdrawals)\n      .orderBy(desc(companyWithdrawals.createdAt));\n  }\n\n  // ===== TRANSACTION OPERATIONS =====\n\n  async getCompanyTransactions(companyId: number): Promise<Array<Transaction & { grossAmount?: string; netAmount?: string; taxAmount?: string; cleanerName?: string; cleanerEmail?: string }>> {\n    const results = await db\n      .select({\n        id: transactions.id,\n        referenceNumber: transactions.referenceNumber,\n        companyId: transactions.companyId,\n        jobId: transactions.jobId,\n        type: transactions.type,\n        direction: transactions.direction,\n        amount: transactions.amount,\n        currency: transactions.currency,\n        description: transactions.description,\n        createdAt: transactions.createdAt,\n        stripePaymentIntentId: transactions.stripePaymentIntentId,\n        stripeRefundId: transactions.stripeRefundId,\n        withdrawalId: transactions.withdrawalId,\n        grossAmount: sql<string | null>`${jobFinancials.grossAmount}`,\n        netAmount: sql<string | null>`${jobFinancials.netPayableAmount}`,\n        taxAmount: sql<string | null>`COALESCE(${jobFinancials.baseTax}, 0) + COALESCE(${jobFinancials.tipTax}, 0)`,\n        cleanerName: sql<string | null>`${users.displayName}`,\n        cleanerEmail: sql<string | null>`${users.email}`,\n      })\n      .from(transactions)\n      .leftJoin(jobFinancials, eq(transactions.jobId, jobFinancials.jobId))\n      .leftJoin(cleaners, eq(jobFinancials.cleanerId, cleaners.id))\n      .leftJoin(users, eq(cleaners.userId, users.id))\n      .where(eq(transactions.companyId, companyId))\n      .orderBy(desc(transactions.createdAt));\n    \n    return results.map(r => ({\n      ...r,\n      grossAmount: r.grossAmount ?? undefined,\n      netAmount: r.netAmount ?? undefined,\n      taxAmount: r.taxAmount ?? undefined,\n      cleanerName: r.cleanerName ?? undefined,\n      cleanerEmail: r.cleanerEmail ?? undefined,\n    }));\n  }\n\n  async createTransaction(transaction: InsertTransaction): Promise<Transaction> {\n    const [result] = await db\n      .insert(transactions)\n      .values(transaction)\n      .returning();\n    \n    return result;\n  }\n\n  // ===== PLATFORM SETTINGS OPERATIONS =====\n  \n  async getAllPlatformSettings(): Promise<PlatformSetting[]> {\n    return await db.select().from(platformSettings);\n  }\n\n  async updatePlatformSettings(id: number, updates: Partial<InsertPlatformSetting>): Promise<void> {\n    await db\n      .update(platformSettings)\n      .set({\n        ...updates,\n        updatedAt: new Date(),\n      })\n      .where(eq(platformSettings.id, id));\n  }\n\n  // ===== FINANCIAL AGGREGATIONS =====\n\n  async getCompanyFinancialSummary(companyId: number): Promise<{\n    totalRevenue: number;\n    totalRefunds: number;\n    platformFees: number;\n    paymentProcessingFees: number;\n    taxAmount: number;\n    netEarnings: number;\n    adminPayouts: number;\n    totalWithdrawals: number;\n    pendingWithdrawals: number;\n    availableBalance: number;\n  }> {\n    // Sum job financials including all transactions (completed + refunded)\n    // Gross revenue includes all financial transactions\n    // Platform fees, processing fees, and net earnings only include completed jobs\n    const financialSummary = await db\n      .select({\n        totalRevenue: sql<string>`COALESCE(SUM(${jobFinancials.grossAmount}), 0)::text`,\n        platformFees: sql<string>`COALESCE(SUM(CASE WHEN ${jobs.status} = 'completed' THEN ${jobFinancials.platformFeeAmount}::numeric * 1.05 ELSE 0 END), 0)::text`,\n        paymentProcessingFees: sql<string>`COALESCE(SUM(CASE WHEN ${jobs.status} = 'completed' THEN ${jobFinancials.paymentProcessingFeeAmount} ELSE 0 END), 0)::text`,\n        taxAmount: sql<string>`COALESCE(SUM(CASE WHEN ${jobs.status} = 'completed' THEN ${jobFinancials.baseTax} ELSE 0 END) + SUM(CASE WHEN ${jobs.status} = 'completed' THEN ${jobFinancials.tipTax} ELSE 0 END), 0)::text`,\n        netEarnings: sql<string>`COALESCE(SUM(CASE WHEN ${jobs.status} = 'completed' THEN ${jobFinancials.netPayableAmount} ELSE 0 END), 0)::text`,\n      })\n      .from(jobFinancials)\n      .innerJoin(jobs, eq(jobs.id, jobFinancials.jobId))\n      .where(and(\n        eq(jobFinancials.companyId, companyId),\n        inArray(jobs.status, ['completed', 'refunded'])\n      ));\n\n    // Calculate total refunds including all amounts (base, platform fees, VAT, tips)\n    // Use jobs.totalAmount which is the actual amount refunded by Stripe to customers\n    const refundSummary = await db\n      .select({\n        totalRefunds: sql<string>`COALESCE(SUM(${jobs.totalAmount}), 0)::text`,\n      })\n      .from(jobs)\n      .where(and(\n        eq(jobs.companyId, companyId),\n        eq(jobs.status, 'refunded')\n      ));\n\n    const withdrawalSummary = await db\n      .select({\n        totalWithdrawals: sql<string>`COALESCE(SUM(CASE WHEN ${companyWithdrawals.status} = 'completed' THEN ${companyWithdrawals.amount} ELSE 0 END), 0)::text`,\n        pendingWithdrawals: sql<string>`COALESCE(SUM(CASE WHEN ${companyWithdrawals.status} = 'pending' THEN ${companyWithdrawals.amount} ELSE 0 END), 0)::text`,\n      })\n      .from(companyWithdrawals)\n      .where(eq(companyWithdrawals.companyId, companyId));\n\n    // Sum admin payouts (admin_payment) - money already paid to company from their revenue\n    const adminPayoutsSummary = await db\n      .select({\n        adminPayouts: sql<string>`COALESCE(SUM(${transactions.amount}), 0)::text`,\n      })\n      .from(transactions)\n      .where(and(\n        eq(transactions.companyId, companyId),\n        eq(transactions.type, 'admin_payment')\n      ));\n\n    // Sum refunds only (exclude admin_payment and withdrawal)\n    const refundsSummary = await db\n      .select({\n        refunds: sql<string>`COALESCE(SUM(${transactions.amount}), 0)::text`,\n      })\n      .from(transactions)\n      .where(and(\n        eq(transactions.companyId, companyId),\n        eq(transactions.type, 'refund')\n      ));\n\n    const totalRevenue = Number(financialSummary[0]?.totalRevenue || 0);\n    const platformFees = Number(financialSummary[0]?.platformFees || 0);\n    const paymentProcessingFees = Number(financialSummary[0]?.paymentProcessingFees || 0);\n    const taxAmount = Number(financialSummary[0]?.taxAmount || 0);\n    const netEarnings = Number(financialSummary[0]?.netEarnings || 0);\n    const totalRefunds = Number(refundSummary[0]?.totalRefunds || 0);\n    const totalWithdrawals = Number(withdrawalSummary[0]?.totalWithdrawals || 0);\n    const pendingWithdrawals = Number(withdrawalSummary[0]?.pendingWithdrawals || 0);\n    const adminPayouts = Number(adminPayoutsSummary[0]?.adminPayouts || 0);\n    const refundsFromTransactions = Number(refundsSummary[0]?.refunds || 0);\n    \n    // BALANCE CALCULATION:\n    // netEarnings already EXCLUDES refunded jobs (see WHERE NOT refunded above)\n    // So we only subtract: admin payouts (already paid to company) and withdrawals (requested/completed)\n    // DO NOT subtract refunds again - that would be double-counting!\n    const availableBalance = netEarnings - adminPayouts - totalWithdrawals - pendingWithdrawals;\n\n    return {\n      totalRevenue,\n      totalRefunds,\n      platformFees,\n      paymentProcessingFees,\n      taxAmount,\n      netEarnings,\n      adminPayouts,\n      totalWithdrawals,\n      pendingWithdrawals,\n      availableBalance,\n    };\n  }\n\n  async getAllCompaniesFinancialSummary(): Promise<Array<{\n    companyId: number;\n    companyName: string;\n    totalRevenue: number;\n    platformFees: number;\n    netEarnings: number;\n    totalWithdrawals: number;\n    availableBalance: number;\n  }>> {\n    // Get financial summary for all companies\n    // Gross revenue includes all financial transactions (completed + refunded)\n    // Platform fees and net earnings only include completed jobs\n    const result = await db\n      .select({\n        companyId: companies.id,\n        companyName: companies.name,\n        totalRevenue: sql<string>`COALESCE(SUM(CASE WHEN ${jobs.status} IN ('completed', 'refunded') THEN ${jobFinancials.grossAmount} ELSE 0 END), 0)::text`,\n        platformFees: sql<string>`COALESCE(SUM(CASE WHEN ${jobs.status} = 'completed' THEN ${jobFinancials.platformFeeAmount}::numeric * 1.05 ELSE 0 END), 0)::text`,\n        netEarnings: sql<string>`COALESCE(SUM(CASE WHEN ${jobs.status} = 'completed' THEN ${jobFinancials.netPayableAmount} ELSE 0 END), 0)::text`,\n        totalWithdrawals: sql<string>`COALESCE((\n          SELECT SUM(${companyWithdrawals.amount})\n          FROM ${companyWithdrawals}\n          WHERE ${companyWithdrawals.companyId} = ${companies.id}\n          AND ${companyWithdrawals.status} = 'completed'\n        ), 0)::text`,\n        adminPayouts: sql<string>`COALESCE((\n          SELECT SUM(${transactions.amount})\n          FROM ${transactions}\n          WHERE ${transactions.companyId} = ${companies.id}\n          AND ${transactions.type} = 'admin_payment'\n        ), 0)::text`,\n        refunds: sql<string>`COALESCE((\n          SELECT SUM(${transactions.amount})\n          FROM ${transactions}\n          WHERE ${transactions.companyId} = ${companies.id}\n          AND ${transactions.type} = 'refund'\n        ), 0)::text`,\n      })\n      .from(companies)\n      .leftJoin(jobFinancials, eq(jobFinancials.companyId, companies.id))\n      .leftJoin(jobs, eq(jobs.id, jobFinancials.jobId))\n      .where(eq(companies.isActive, 1))\n      .groupBy(companies.id, companies.name);\n\n    return result.map(row => ({\n      companyId: row.companyId,\n      companyName: row.companyName,\n      totalRevenue: Number(row.totalRevenue || 0),\n      platformFees: Number(row.platformFees || 0),\n      netEarnings: Number(row.netEarnings || 0),\n      totalWithdrawals: Number(row.totalWithdrawals || 0),\n      // Net earnings already excludes refunds, so only subtract admin payouts and withdrawals\n      availableBalance: Number(row.netEarnings || 0) - Number(row.adminPayouts || 0) - Number(row.totalWithdrawals || 0),\n    }));\n  }\n\n  // ===== COMPANY GEOFENCE OPERATIONS =====\n\n  async getCompanyGeofences(companyId: number): Promise<CompanyGeofence[]> {\n    const geofences = await db\n      .select()\n      .from(companyGeofences)\n      .where(eq(companyGeofences.companyId, companyId))\n      .orderBy(desc(companyGeofences.createdAt));\n    return geofences;\n  }\n\n  async getGeofence(id: number): Promise<CompanyGeofence | undefined> {\n    const [geofence] = await db\n      .select()\n      .from(companyGeofences)\n      .where(eq(companyGeofences.id, id));\n    return geofence;\n  }\n\n  async createGeofence(geofence: InsertCompanyGeofence): Promise<CompanyGeofence> {\n    const [newGeofence] = await db\n      .insert(companyGeofences)\n      .values([geofence as any])\n      .returning();\n    return newGeofence;\n  }\n\n  async updateGeofence(id: number, updates: Partial<Pick<CompanyGeofence, 'name' | 'polygon'>>): Promise<void> {\n    await db\n      .update(companyGeofences)\n      .set(updates)\n      .where(eq(companyGeofences.id, id));\n  }\n\n  async deleteGeofence(id: number): Promise<void> {\n    await db\n      .delete(companyGeofences)\n      .where(eq(companyGeofences.id, id));\n  }\n\n  async getGeofenceByCompanyAndName(companyId: number, name: string): Promise<CompanyGeofence | undefined> {\n    const [geofence] = await db\n      .select()\n      .from(companyGeofences)\n      .where(\n        and(\n          eq(companyGeofences.companyId, companyId),\n          eq(companyGeofences.name, name)\n        )\n      );\n    return geofence;\n  }\n\n  // ===== CLEANER GEOFENCE ASSIGNMENT OPERATIONS =====\n\n  async assignGeofencesToInvitation(invitationId: number, companyId: number, geofenceIds: number[], assignAll: boolean): Promise<void> {\n    await db\n      .delete(cleanerGeofenceAssignments)\n      .where(eq(cleanerGeofenceAssignments.invitationId, invitationId));\n\n    if (assignAll) {\n      await db\n        .insert(cleanerGeofenceAssignments)\n        .values({\n          invitationId,\n          companyId,\n          geofenceId: null,\n          cleanerId: null,\n          assignAll: 1,\n        });\n    } else if (geofenceIds.length > 0) {\n      const values = geofenceIds.map(geofenceId => ({\n        invitationId,\n        companyId,\n        geofenceId,\n        cleanerId: null,\n        assignAll: 0,\n      }));\n      await db\n        .insert(cleanerGeofenceAssignments)\n        .values(values);\n    }\n  }\n\n  async assignGeofencesToCleaner(cleanerId: number, companyId: number, geofenceIds: number[], assignAll: boolean): Promise<void> {\n    await db\n      .delete(cleanerGeofenceAssignments)\n      .where(eq(cleanerGeofenceAssignments.cleanerId, cleanerId));\n\n    if (assignAll) {\n      await db\n        .insert(cleanerGeofenceAssignments)\n        .values({\n          cleanerId,\n          companyId,\n          geofenceId: null,\n          invitationId: null,\n          assignAll: 1,\n        });\n    } else if (geofenceIds.length > 0) {\n      const values = geofenceIds.map(geofenceId => ({\n        cleanerId,\n        companyId,\n        geofenceId,\n        invitationId: null,\n        assignAll: 0,\n      }));\n      await db\n        .insert(cleanerGeofenceAssignments)\n        .values(values);\n    }\n  }\n\n  async transferInvitationGeofencesToCleaner(invitationId: number, cleanerId: number): Promise<void> {\n    const invitationAssignments = await db\n      .select()\n      .from(cleanerGeofenceAssignments)\n      .where(eq(cleanerGeofenceAssignments.invitationId, invitationId));\n\n    if (invitationAssignments.length > 0) {\n      const cleaner = await this.getCleaner(cleanerId);\n      if (!cleaner) return;\n\n      const values = invitationAssignments.map(assignment => ({\n        cleanerId,\n        companyId: assignment.companyId,\n        geofenceId: assignment.geofenceId,\n        invitationId: null,\n        assignAll: assignment.assignAll,\n      }));\n\n      await db\n        .insert(cleanerGeofenceAssignments)\n        .values(values);\n\n      await db\n        .delete(cleanerGeofenceAssignments)\n        .where(eq(cleanerGeofenceAssignments.invitationId, invitationId));\n    }\n  }\n\n  async getCleanerGeofenceAssignments(cleanerId: number): Promise<CompanyGeofence[]> {\n    const isAssignedAll = await this.isCleanerAssignedToAllGeofences(cleanerId);\n    \n    if (isAssignedAll) {\n      const cleaner = await this.getCleaner(cleanerId);\n      if (!cleaner) return [];\n      return await this.getCompanyGeofences(cleaner.companyId);\n    }\n\n    const assignments = await db\n      .select({\n        geofence: companyGeofences,\n      })\n      .from(cleanerGeofenceAssignments)\n      .innerJoin(companyGeofences, eq(cleanerGeofenceAssignments.geofenceId, companyGeofences.id))\n      .where(eq(cleanerGeofenceAssignments.cleanerId, cleanerId));\n\n    return assignments.map(a => a.geofence);\n  }\n\n  async getInvitationGeofenceAssignments(invitationId: number): Promise<CompanyGeofence[]> {\n    const [assignment] = await db\n      .select()\n      .from(cleanerGeofenceAssignments)\n      .where(\n        and(\n          eq(cleanerGeofenceAssignments.invitationId, invitationId),\n          eq(cleanerGeofenceAssignments.assignAll, 1)\n        )\n      );\n\n    if (assignment) {\n      return await this.getCompanyGeofences(assignment.companyId);\n    }\n\n    const assignments = await db\n      .select({\n        geofence: companyGeofences,\n      })\n      .from(cleanerGeofenceAssignments)\n      .innerJoin(companyGeofences, eq(cleanerGeofenceAssignments.geofenceId, companyGeofences.id))\n      .where(eq(cleanerGeofenceAssignments.invitationId, invitationId));\n\n    return assignments.map(a => a.geofence);\n  }\n\n  async isCleanerAssignedToGeofence(cleanerId: number, geofenceId: number): Promise<boolean> {\n    const isAssignedAll = await this.isCleanerAssignedToAllGeofences(cleanerId);\n    if (isAssignedAll) return true;\n\n    const [assignment] = await db\n      .select()\n      .from(cleanerGeofenceAssignments)\n      .where(\n        and(\n          eq(cleanerGeofenceAssignments.cleanerId, cleanerId),\n          eq(cleanerGeofenceAssignments.geofenceId, geofenceId)\n        )\n      );\n\n    return !!assignment;\n  }\n\n  async isCleanerAssignedToAllGeofences(cleanerId: number): Promise<boolean> {\n    const [assignment] = await db\n      .select()\n      .from(cleanerGeofenceAssignments)\n      .where(\n        and(\n          eq(cleanerGeofenceAssignments.cleanerId, cleanerId),\n          eq(cleanerGeofenceAssignments.assignAll, 1)\n        )\n      );\n\n    return !!assignment;\n  }\n\n  // ===== HELPER METHODS =====\n\n  // ===== COMPLAINT OPERATIONS =====\n  \n  async createComplaint(complaintData: InsertComplaint): Promise<Complaint> {\n    // Insert complaint first to get the ID\n    const [complaint] = await db\n      .insert(complaints)\n      .values({\n        ...complaintData,\n        referenceNumber: 'TEMP', // Temporary value\n      })\n      .returning();\n    \n    // Update with simplified reference number format: CMP-{id}\n    const referenceNumber = `CMP-${complaint.id}`;\n    const [updatedComplaint] = await db\n      .update(complaints)\n      .set({ referenceNumber })\n      .where(eq(complaints.id, complaint.id))\n      .returning();\n    \n    return updatedComplaint;\n  }\n  \n  async getComplaint(id: number): Promise<Complaint | undefined> {\n    const [complaint] = await db.select().from(complaints).where(eq(complaints.id, id));\n    return complaint;\n  }\n  \n  async getComplaintByReference(referenceNumber: string): Promise<Complaint | undefined> {\n    const [complaint] = await db.select().from(complaints).where(eq(complaints.referenceNumber, referenceNumber));\n    return complaint;\n  }\n  \n  async getJobComplaints(jobId: number): Promise<Complaint[]> {\n    return await db.select().from(complaints).where(eq(complaints.jobId, jobId)).orderBy(desc(complaints.createdAt));\n  }\n  \n  async getCompanyComplaints(companyId: number): Promise<Complaint[]> {\n    return await db.select().from(complaints).where(eq(complaints.companyId, companyId)).orderBy(desc(complaints.createdAt));\n  }\n  \n  async getAllComplaints(): Promise<Complaint[]> {\n    return await db.select().from(complaints).orderBy(desc(complaints.createdAt));\n  }\n  \n  async updateComplaintStatus(id: number, status: string, resolvedBy?: number, resolution?: string): Promise<void> {\n    const updates: any = { \n      status,\n      updatedAt: new Date()\n    };\n    \n    if (status === 'resolved' || status === 'in_progress') {\n      updates.resolvedBy = resolvedBy;\n      if (resolution) {\n        updates.resolution = resolution;\n      }\n      if (status === 'resolved') {\n        updates.resolvedAt = new Date();\n      }\n    }\n    \n    await db\n      .update(complaints)\n      .set(updates)\n      .where(eq(complaints.id, id));\n  }\n  \n  async updateComplaintRefund(id: number, refundedBy: number, stripeRefundId: string): Promise<void> {\n    await db\n      .update(complaints)\n      .set({\n        status: 'refunded',\n        refundedAt: new Date(),\n        refundedBy,\n        stripeRefundId,\n        updatedAt: new Date(),\n      })\n      .where(eq(complaints.id, id));\n  }\n\n  private mapUserRow(row: any): User {\n    return {\n      id: row.id,\n      email: row.email,\n      passwordHash: row.password_hash,\n      displayName: row.display_name,\n      role: row.role,\n      photoURL: row.photo_url,\n      phoneNumber: row.phone_number,\n      companyId: row.company_id,\n      soundEnabled: row.sound_enabled || 0,\n      createdAt: row.created_at,\n    };\n  }\n  \n  private mapCompanyRow(row: any): Company {\n    return {\n      id: row.id,\n      name: row.name,\n      description: row.description,\n      pricePerWash: row.price_per_wash,\n      platformFee: row.platform_fee || \"3.00\",\n      feePackageType: row.fee_package_type || 'custom',\n      packageType: row.package_type || 'pay_per_wash',\n      subscriptionCleanerSlots: row.subscription_cleaner_slots,\n      adminId: row.admin_id,\n      tradeLicenseNumber: row.trade_license_number,\n      tradeLicenseDocumentURL: row.trade_license_document_url,\n      isActive: row.is_active,\n      totalJobsCompleted: row.total_jobs_completed,\n      totalRevenue: row.total_revenue,\n      rating: row.rating,\n      totalRatings: row.total_ratings,\n      geofenceArea: row.geofence_area || null,\n      createdAt: row.created_at,\n    };\n  }\n  \n  private mapCleanerRow(row: any): Cleaner {\n    return {\n      id: row.id,\n      userId: row.user_id,\n      companyId: row.company_id,\n      status: row.status,\n      isActive: row.is_active,\n      currentLatitude: row.current_latitude,\n      currentLongitude: row.current_longitude,\n      lastLocationUpdate: row.last_location_update,\n      totalJobsCompleted: row.total_jobs_completed,\n      averageCompletionTime: row.average_completion_time,\n      rating: row.rating,\n      totalRatings: row.total_ratings,\n      createdAt: row.created_at,\n    };\n  }\n\n  // ===== LIVE REPORT OPERATIONS =====\n\n  async getLiveReport(options?: { companyId?: number; cleanerId?: number }): Promise<{\n    liveCleaners: number;\n    activeLocations: number;\n    revenueToday: number;\n    tipsToday: number;\n    netToday: number;\n    completedJobsToday: number;\n    refundedJobsToday: number;\n    pendingJobsToday: number;\n    cleanerDetails: Array<{\n      id: number;\n      name: string;\n      email: string;\n      status: string;\n      currentLocation: { lat: number; lng: number } | null;\n      lastLocationUpdate: Date | null;\n      jobsCompletedToday: number;\n    }>;\n  }> {\n    const now = new Date();\n    // Get start of today in Dubai timezone (UTC+4)\n    const dubaiOffset = 4 * 60 * 60 * 1000;\n    const dubaiNow = new Date(now.getTime() + dubaiOffset);\n    const startOfDayDubai = new Date(Date.UTC(\n      dubaiNow.getUTCFullYear(),\n      dubaiNow.getUTCMonth(),\n      dubaiNow.getUTCDate(),\n      0, 0, 0, 0\n    ) - dubaiOffset);\n    \n    const tenMinutesAgo = new Date(now.getTime() - 10 * 60 * 1000);\n\n    // Build conditions for cleaners\n    const cleanerConditions = [\n      eq(cleaners.status, \"on_duty\"),\n      eq(cleaners.isActive, 1),\n      gte(cleaners.lastLocationUpdate, tenMinutesAgo)\n    ];\n    if (options?.companyId) {\n      cleanerConditions.push(eq(cleaners.companyId, options.companyId));\n    }\n\n    // Get live cleaners count\n    const [liveCleanersResult] = await db\n      .select({ count: sql<number>`count(DISTINCT ${cleaners.id})` })\n      .from(cleaners)\n      .where(and(...cleanerConditions));\n\n    // Get unique active locations (distinct lat/lng)\n    const [activeLocationsResult] = await db\n      .select({ \n        count: sql<number>`count(DISTINCT CONCAT(ROUND(${cleaners.currentLatitude}::numeric, 3), ',', ROUND(${cleaners.currentLongitude}::numeric, 3)))` \n      })\n      .from(cleaners)\n      .where(and(...cleanerConditions));\n\n    // Build conditions for jobs today\n    const jobConditions = [gte(jobs.createdAt, startOfDayDubai)];\n    if (options?.companyId) {\n      jobConditions.push(eq(jobs.companyId, options.companyId));\n    }\n    if (options?.cleanerId) {\n      jobConditions.push(eq(jobs.cleanerId, options.cleanerId));\n    }\n\n    // Get completed jobs today\n    const [completedJobsResult] = await db\n      .select({ count: sql<number>`count(*)` })\n      .from(jobs)\n      .where(and(...jobConditions, eq(jobs.status, \"completed\")));\n\n    // Get refunded jobs today\n    const [refundedJobsResult] = await db\n      .select({ count: sql<number>`count(*)` })\n      .from(jobs)\n      .where(and(...jobConditions, inArray(jobs.status, [\"refunded\", \"refunded_unattended\"])));\n\n    // Get pending jobs today (paid but not completed)\n    const [pendingJobsResult] = await db\n      .select({ count: sql<number>`count(*)` })\n      .from(jobs)\n      .where(and(...jobConditions, inArray(jobs.status, [\"paid\", \"assigned\", \"in_progress\"])));\n\n    // Get revenue and tips for today (only completed jobs)\n    const financialConditions = [\n      gte(jobFinancials.paidAt, startOfDayDubai),\n      eq(jobs.status, \"completed\")\n    ];\n    if (options?.companyId) {\n      financialConditions.push(eq(jobFinancials.companyId, options.companyId));\n    }\n    if (options?.cleanerId) {\n      financialConditions.push(eq(jobFinancials.cleanerId, options.cleanerId));\n    }\n\n    const [financialsResult] = await db\n      .select({\n        revenue: sql<string>`COALESCE(SUM(${jobFinancials.netPayableAmount}), 0)::text`,\n        tips: sql<string>`COALESCE(SUM(${jobFinancials.tipAmount}), 0)::text`,\n      })\n      .from(jobFinancials)\n      .innerJoin(jobs, eq(jobFinancials.jobId, jobs.id))\n      .where(and(...financialConditions));\n\n    const revenueToday = Number(financialsResult?.revenue || 0);\n    const tipsToday = Number(financialsResult?.tips || 0);\n    const netToday = revenueToday - tipsToday;\n\n    // Get cleaner details with jobs completed today\n    const cleanerDetailsConditions = options?.companyId \n      ? [eq(cleaners.companyId, options.companyId), eq(cleaners.isActive, 1)]\n      : [eq(cleaners.isActive, 1)];\n    \n    if (options?.cleanerId) {\n      cleanerDetailsConditions.push(eq(cleaners.id, options.cleanerId));\n    }\n\n    const cleanerDetails = await db\n      .select({\n        id: cleaners.id,\n        name: users.displayName,\n        email: users.email,\n        status: cleaners.status,\n        currentLatitude: cleaners.currentLatitude,\n        currentLongitude: cleaners.currentLongitude,\n        lastLocationUpdate: cleaners.lastLocationUpdate,\n      })\n      .from(cleaners)\n      .innerJoin(users, eq(cleaners.userId, users.id))\n      .where(and(...cleanerDetailsConditions));\n\n    // Get jobs completed today per cleaner\n    const jobsPerCleaner = await db\n      .select({\n        cleanerId: jobs.cleanerId,\n        count: sql<number>`count(*)`,\n      })\n      .from(jobs)\n      .where(and(\n        gte(jobs.completedAt, startOfDayDubai),\n        eq(jobs.status, \"completed\"),\n        options?.companyId ? eq(jobs.companyId, options.companyId) : sql`1=1`\n      ))\n      .groupBy(jobs.cleanerId);\n\n    const jobsMap = new Map(jobsPerCleaner.map(j => [j.cleanerId, Number(j.count)]));\n\n    return {\n      liveCleaners: Number(liveCleanersResult?.count || 0),\n      activeLocations: Number(activeLocationsResult?.count || 0),\n      revenueToday,\n      tipsToday,\n      netToday,\n      completedJobsToday: Number(completedJobsResult?.count || 0),\n      refundedJobsToday: Number(refundedJobsResult?.count || 0),\n      pendingJobsToday: Number(pendingJobsResult?.count || 0),\n      cleanerDetails: cleanerDetails.map(c => ({\n        id: c.id,\n        name: c.name,\n        email: c.email,\n        status: c.status,\n        currentLocation: c.currentLatitude && c.currentLongitude \n          ? { lat: Number(c.currentLatitude), lng: Number(c.currentLongitude) }\n          : null,\n        lastLocationUpdate: c.lastLocationUpdate,\n        jobsCompletedToday: jobsMap.get(c.id) || 0,\n      })),\n    };\n  }\n\n  // ===== WITHDRAWAL BALANCE OPERATIONS =====\n\n  async getCompanyWithdrawalBalance(companyId: number): Promise<{\n    completedJobs: number;\n    totalJobValue: number;\n    totalTips: number;\n    totalWithdrawn: number;\n    availableJobs: number;\n    availableJobValue: number;\n    availableTips: number;\n    pricePerWash: number;\n    withdrawnJobs: number;\n    withdrawnTips: number;\n    pendingWithdrawals: Array<{\n      id: number;\n      jobCountRequested: number;\n      tipsRequested: number;\n      amount: number;\n      status: string;\n      createdAt: Date;\n    }>;\n  }> {\n    // Get company price per wash\n    const [company] = await db\n      .select({ pricePerWash: companies.pricePerWash })\n      .from(companies)\n      .where(eq(companies.id, companyId));\n\n    const pricePerWash = Number(company?.pricePerWash || 0);\n\n    // Get total completed jobs\n    const [completedJobsResult] = await db\n      .select({ count: sql<number>`count(*)` })\n      .from(jobs)\n      .where(and(\n        eq(jobs.companyId, companyId),\n        eq(jobs.status, \"completed\")\n      ));\n\n    const totalCompletedJobs = Number(completedJobsResult?.count || 0);\n\n    // Get total tips earned from completed jobs\n    const [tipsResult] = await db\n      .select({ tips: sql<string>`COALESCE(SUM(${jobFinancials.tipAmount}), 0)::text` })\n      .from(jobFinancials)\n      .innerJoin(jobs, eq(jobFinancials.jobId, jobs.id))\n      .where(and(\n        eq(jobFinancials.companyId, companyId),\n        eq(jobs.status, \"completed\")\n      ));\n\n    const totalTipsEarned = Number(tipsResult?.tips || 0);\n\n    // Get withdrawn jobs and tips from completed/pending withdrawals\n    const [withdrawnResult] = await db\n      .select({\n        withdrawnJobs: sql<string>`COALESCE(SUM(${companyWithdrawals.jobCountRequested}), 0)::text`,\n        withdrawnTips: sql<string>`COALESCE(SUM(${companyWithdrawals.tipsRequested}), 0)::text`,\n      })\n      .from(companyWithdrawals)\n      .where(and(\n        eq(companyWithdrawals.companyId, companyId),\n        inArray(companyWithdrawals.status, [\"pending\", \"completed\"])\n      ));\n\n    const withdrawnJobs = Number(withdrawnResult?.withdrawnJobs || 0);\n    const withdrawnTips = Number(withdrawnResult?.withdrawnTips || 0);\n\n    // Get pending withdrawals for display\n    const pendingWithdrawals = await db\n      .select({\n        id: companyWithdrawals.id,\n        jobCountRequested: companyWithdrawals.jobCountRequested,\n        tipsRequested: companyWithdrawals.tipsRequested,\n        amount: companyWithdrawals.amount,\n        status: companyWithdrawals.status,\n        createdAt: companyWithdrawals.createdAt,\n      })\n      .from(companyWithdrawals)\n      .where(and(\n        eq(companyWithdrawals.companyId, companyId),\n        eq(companyWithdrawals.status, \"pending\")\n      ))\n      .orderBy(desc(companyWithdrawals.createdAt));\n\n    const availableJobs = totalCompletedJobs - withdrawnJobs;\n    const availableTips = totalTipsEarned - withdrawnTips;\n    \n    return {\n      completedJobs: totalCompletedJobs,\n      totalJobValue: totalCompletedJobs * pricePerWash,\n      totalTips: totalTipsEarned,\n      totalWithdrawn: (withdrawnJobs * pricePerWash) + withdrawnTips,\n      availableJobs,\n      availableJobValue: availableJobs * pricePerWash,\n      availableTips,\n      pricePerWash,\n      withdrawnJobs,\n      withdrawnTips,\n      pendingWithdrawals: pendingWithdrawals.map(w => ({\n        id: w.id,\n        jobCountRequested: w.jobCountRequested || 0,\n        tipsRequested: Number(w.tipsRequested || 0),\n        amount: Number(w.amount),\n        status: w.status,\n        createdAt: w.createdAt,\n      })),\n    };\n  }\n\n  // ===== OFFLINE JOB OPERATIONS =====\n\n  async createOfflineJob(data: {\n    cleanerId: number;\n    companyId: number;\n    carPlateNumber: string;\n    carPlateEmirate?: string;\n    carPlateCode?: string;\n    servicePrice: string;\n    vatAmount: string;\n    totalAmount: string;\n    notes?: string;\n  }): Promise<OfflineJob> {\n    const [offlineJob] = await db\n      .insert(offlineJobs)\n      .values(data)\n      .returning();\n    return offlineJob;\n  }\n\n  async getCompanyOfflineJobs(companyId: number, filters?: {\n    cleanerId?: number;\n    startDate?: Date;\n    endDate?: Date;\n  }): Promise<Array<OfflineJob & { cleanerName: string }>> {\n    const conditions = [eq(offlineJobs.companyId, companyId)];\n    \n    if (filters?.cleanerId) {\n      conditions.push(eq(offlineJobs.cleanerId, filters.cleanerId));\n    }\n    if (filters?.startDate) {\n      conditions.push(gte(offlineJobs.createdAt, filters.startDate));\n    }\n    if (filters?.endDate) {\n      const endOfDay = new Date(filters.endDate);\n      endOfDay.setHours(23, 59, 59, 999);\n      conditions.push(sql`${offlineJobs.createdAt} <= ${endOfDay}`);\n    }\n\n    const results = await db\n      .select({\n        id: offlineJobs.id,\n        cleanerId: offlineJobs.cleanerId,\n        companyId: offlineJobs.companyId,\n        carPlateNumber: offlineJobs.carPlateNumber,\n        carPlateEmirate: offlineJobs.carPlateEmirate,\n        carPlateCode: offlineJobs.carPlateCode,\n        servicePrice: offlineJobs.servicePrice,\n        vatAmount: offlineJobs.vatAmount,\n        totalAmount: offlineJobs.totalAmount,\n        notes: offlineJobs.notes,\n        status: offlineJobs.status,\n        completionPhotoUrl: offlineJobs.completionPhotoUrl,\n        completedAt: offlineJobs.completedAt,\n        createdAt: offlineJobs.createdAt,\n        cleanerName: users.displayName,\n      })\n      .from(offlineJobs)\n      .innerJoin(cleaners, eq(offlineJobs.cleanerId, cleaners.id))\n      .innerJoin(users, eq(cleaners.userId, users.id))\n      .where(and(...conditions))\n      .orderBy(desc(offlineJobs.createdAt));\n\n    return results;\n  }\n\n  async getOfflineJobsReport(companyId: number, filters?: {\n    cleanerId?: number;\n    startDate?: Date;\n    endDate?: Date;\n  }): Promise<{\n    totalJobs: number;\n    totalRevenue: number;\n    totalVat: number;\n    jobs: Array<OfflineJob & { cleanerName: string }>;\n  }> {\n    const jobs = await this.getCompanyOfflineJobs(companyId, filters);\n    \n    const totalJobs = jobs.length;\n    const totalRevenue = jobs.reduce((sum, job) => sum + parseFloat(job.servicePrice), 0);\n    const totalVat = jobs.reduce((sum, job) => sum + parseFloat(job.vatAmount), 0);\n\n    return {\n      totalJobs,\n      totalRevenue,\n      totalVat,\n      jobs,\n    };\n  }\n\n  async getOfflineJob(id: number): Promise<OfflineJob | undefined> {\n    const [job] = await db\n      .select()\n      .from(offlineJobs)\n      .where(eq(offlineJobs.id, id));\n    return job;\n  }\n\n  async completeOfflineJob(id: number, completionPhotoUrl: string): Promise<void> {\n    await db\n      .update(offlineJobs)\n      .set({\n        status: \"completed\",\n        completionPhotoUrl,\n        completedAt: new Date(),\n      })\n      .where(eq(offlineJobs.id, id));\n  }\n}\n\nexport const storage = new DatabaseStorage();\n","path":null,"size_bytes":105991,"size_tokens":null},"client/src/components/ui/card.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Card = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"shadcn-card rounded-xl border bg-card border-card-border text-card-foreground shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n));\nCard.displayName = \"Card\"\n\nconst CardHeader = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex flex-col space-y-1.5 p-6\", className)}\n    {...props}\n  />\n));\nCardHeader.displayName = \"CardHeader\"\n\nconst CardTitle = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"text-2xl font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nCardTitle.displayName = \"CardTitle\"\n\nconst CardDescription = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n));\nCardDescription.displayName = \"CardDescription\"\n\nconst CardContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"p-6 pt-0\", className)} {...props} />\n))\nCardContent.displayName = \"CardContent\"\n\nconst CardFooter = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex items-center p-6 pt-0\", className)}\n    {...props}\n  />\n))\nCardFooter.displayName = \"CardFooter\"\nexport {\n  Card,\n  CardHeader,\n  CardFooter,\n  CardTitle,\n  CardDescription,\n  CardContent,\n}\n","path":null,"size_bytes":1904,"size_tokens":null},"client/src/components/ui/toaster.tsx":{"content":"import { useToast } from \"@/hooks/use-toast\"\nimport {\n  Toast,\n  ToastClose,\n  ToastDescription,\n  ToastProvider,\n  ToastTitle,\n  ToastViewport,\n} from \"@/components/ui/toast\"\n\nexport function Toaster() {\n  const { toasts } = useToast()\n\n  return (\n    <ToastProvider>\n      {toasts.map(function ({ id, title, description, action, ...props }) {\n        return (\n          <Toast key={id} {...props}>\n            <div className=\"grid gap-1\">\n              {title && <ToastTitle>{title}</ToastTitle>}\n              {description && (\n                <ToastDescription>{description}</ToastDescription>\n              )}\n            </div>\n            {action}\n            <ToastClose />\n          </Toast>\n        )\n      })}\n      <ToastViewport />\n    </ToastProvider>\n  )\n}\n","path":null,"size_bytes":772,"size_tokens":null},"client/src/components/ui/alert-dialog.tsx":{"content":"import * as React from \"react\"\nimport * as AlertDialogPrimitive from \"@radix-ui/react-alert-dialog\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nconst AlertDialog = AlertDialogPrimitive.Root\n\nconst AlertDialogTrigger = AlertDialogPrimitive.Trigger\n\nconst AlertDialogPortal = AlertDialogPrimitive.Portal\n\nconst AlertDialogOverlay = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nAlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName\n\nconst AlertDialogContent = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPortal>\n    <AlertDialogOverlay />\n    <AlertDialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    />\n  </AlertDialogPortal>\n))\nAlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName\n\nconst AlertDialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogHeader.displayName = \"AlertDialogHeader\"\n\nconst AlertDialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogFooter.displayName = \"AlertDialogFooter\"\n\nconst AlertDialogTitle = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold\", className)}\n    {...props}\n  />\n))\nAlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName\n\nconst AlertDialogDescription = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nAlertDialogDescription.displayName =\n  AlertDialogPrimitive.Description.displayName\n\nconst AlertDialogAction = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Action>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Action\n    ref={ref}\n    className={cn(buttonVariants(), className)}\n    {...props}\n  />\n))\nAlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName\n\nconst AlertDialogCancel = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Cancel\n    ref={ref}\n    className={cn(\n      buttonVariants({ variant: \"outline\" }),\n      \"mt-2 sm:mt-0\",\n      className\n    )}\n    {...props}\n  />\n))\nAlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName\n\nexport {\n  AlertDialog,\n  AlertDialogPortal,\n  AlertDialogOverlay,\n  AlertDialogTrigger,\n  AlertDialogContent,\n  AlertDialogHeader,\n  AlertDialogFooter,\n  AlertDialogTitle,\n  AlertDialogDescription,\n  AlertDialogAction,\n  AlertDialogCancel,\n}\n","path":null,"size_bytes":4420,"size_tokens":null},"replit.md":{"content":"# Washapp.ae - Mobile-First Car Wash Booking Platform\n\n## Overview\nWashapp.ae is a professional, mobile-first platform for car wash booking, featuring an Uber-style interface. It enables anonymous customer requests, allows companies to manage cleaners, and empowers cleaners to complete jobs with photo verification. The project aims to streamline car wash booking and provide comprehensive management tools, tapping into market potential.\n\n## Recent Changes (November 26, 2025)\n-   **Offline Jobs in Company Reports**: Company analytics now include completed offline/cash jobs in all financial metrics (total jobs, revenue, net earnings). Backend: `getCompanyAnalytics` queries both `jobs` and `offlineJobs` tables, combining counts and revenue. Response includes breakdown fields (`onlineJobsCompleted`, `offlineJobsCompleted`, `offlineRevenue`).\n-   **Offline Jobs in Customer Tracking**: Completed cash jobs now appear in customer tracking when searching by plate number. Backend: `getJobsByPlateNumber` returns combined results from both `jobs` and `offlineJobs` tables, with offline jobs transformed to Job structure. Frontend: Customer tracking page displays cash jobs with special styling (green Cash Payment header instead of map, amber \"Cash\" badge).\n-   **Offline Job Completion Workflow**: Offline (cash) jobs now follow the same completion workflow as regular jobs with photo proof requirement. Cleaners enter car plate details (Emirate/Code dropdowns matching customer booking format), the job is auto-created in \"in_progress\" status using company-configured pricing, then completed by uploading a photo proof. Database: `offlineJobs` table now includes `status` (in_progress/completed), `completionPhotoUrl`, and `completedAt` fields. Backend: `create-offline-job` auto-fetches company service price, `complete-offline-job` requires image upload (JPEG/PNG/WebP only). Frontend: Cash Jobs tab shows status badges, photo upload button for in-progress jobs, and completion photo/timestamp for completed jobs.\n-   **Offline Jobs Display for Cleaners and Companies**: Added \"Cash Jobs\" tab to cleaner dashboard showing all manually recorded offline jobs with plate number, service price, VAT, and total. Created dedicated `/company/offline-jobs` page for company admins with filtering by cleaner and date range, pagination, and revenue/VAT summaries. Cleaners can now see their recorded cash payments immediately after creation. Company dashboard includes \"Cash Jobs\" button for easy access to offline job management.\n\n## Recent Changes (November 24, 2025)\n-   **QR Code Payment Feature**: Implemented fully anonymous QR code payment system for instant on-site bookings. Cleaners generate unique payment tokens with QR codes via their dashboard. Customers scan the QR code and are automatically redirected to checkout with payment summary showing VAT breakdown - no car details or phone number required. After successful payment, the job auto-assigns to the cleaner who generated the token with placeholder car details. Tokens are single-use, expire after 1 hour, and are validated server-side. Database: `cleanerPaymentTokens` table. Backend: POST `/api/cleaner/generate-qr-token`, GET `/api/customer/payment-token/:token`, POST `/api/customer/by-phone` (creates anonymous customer), modified `/api/confirm-payment/:id` for auto-assignment. Frontend: QR generator modal with `react-qr-code`, automatic checkout redirect with anonymous job creation.\n-   **Complaint System Improvements**: Simplified complaint reference format from `CMP-{timestamp}-{random}` to `CMP-{id}` for easier tracking. Added status filter dropdown (All, Pending, In Progress, Resolved, Refunded) and reference number search to both admin and company complaint pages. Filtering is client-side using `useMemo` for optimal performance.\n-   **Team Management Filtering**: Implemented location and name filters for cleaners in company dashboard, with assigned service areas displayed in cleaner summaries. Modified `/api/company/cleaners` endpoint to include geofence assignments (`assignedGeofences` and `isAssignedToAll` fields) for each cleaner.\n-   **Pagination Implementation**: Added comprehensive pagination across all reporting views (company financials, admin dashboard, cleaner tips, customer tracking) with standard page size of 20 items. Created reusable PaginationControls component using shadcn/ui primitives. Storage layer returns {data, total} format with automatic page reset when filters change. Updated tracking endpoints (`getJobsByPlateNumber`, `getJobsByPhoneNumber`) to return paginated format.\n-   **Package 1 Fee Calculation Fix**: Fixed critical bug where `feePackageType` field was missing from `getNearbyCompanies()` API response, causing Package 1 pricing to show incorrect amounts (e.g., 17.00 AED instead of 17.75 AED for 15 AED wash). Fixed by adding `fee_package_type` to SELECT query and company mapping in `server/storage.ts`.\n-   **Post-Payment Tracking Redirect Fix**: Fixed bug where checkout redirected to `/customer/track/{number}` instead of full plate identifier. Updated all redirect locations in `checkout.tsx` to use complete plate format: `${carPlateEmirate} ${carPlateCode} ${carPlateNumber}`. Also fixed car plate display in checkout summary.\n-   **Booking Flow Auto-Fill Fix**: Fixed two issues in customer booking flow: (1) After email verification, customer's most recent car plate details now auto-fill correctly via new `/api/customer/recent-car-by-email/:email` endpoint. (2) Car history popup now only appears when user skips email verification, preventing duplicate suggestions for verified users.\n\n## User Preferences\nI prefer simple language and clear explanations. I want iterative development with frequent, small updates. Ask before making major changes to the architecture or core functionalities. Ensure the code is clean, well-commented, and follows modern React and Node.js best practices. Do not make changes to the `uploads/` folder or modify existing environment variables without explicit confirmation.\n\n## System Architecture\n\n### UI/UX Decisions\n-   **Design**: Mobile-first responsive design, optimized for potential app store wrapping.\n-   **Theme**: Modern vibrant interface with bright blue primary color, gradient accents, and dark mode support.\n-   **Navigation**: Role-based bottom navigation and a footer with legal links. Staff login button in top-right.\n-   **Mapping**: Interactive OpenStreetMap integration with Leaflet for location selection and Nominatim reverse geocoding.\n-   **Booking Flow**: Email/OTP-first 4-step wizard with persistent progress, Framer Motion animations, and mobile-first design. Reuses existing checkout component.\n-   **Legal Pages**: Informational pages for About/How It Works, Terms & Conditions, and Privacy Policy.\n\n### Technical Implementations\n-   **Frontend**: React, Tailwind CSS, shadcn/ui, Roboto font, Framer Motion.\n-   **Backend**: Express.js, Node.js.\n-   **Database**: PostgreSQL with Drizzle ORM.\n-   **Authentication**: Passport.js with bcrypt for staff roles, `connect-pg-simple` for session storage. Auto-admin setup on server startup. Password reset functionality with token-based flow and email notifications. Customer data model uses email as primary identifier.\n-   **Payments**: Stripe integration for AED currency.\n-   **Email**: Resend for notifications.\n-   **Real-time**: WebSocket server for job status updates.\n-   **File Uploads**: Multer for local file storage (job photos, trade licenses).\n-   **Location**: Geofence polygon matching using ray-casting.\n-   **Security**: Session-based authentication, CSRF protection, role-based access control, Stripe webhook verification. Push notification coordinates validated server-side.\n-   **PWA**: Progressive Web App with service worker and manifest for installability.\n-   **Push Notifications**: Web Push API for real-time alerts to customers and cleaners, with four-way geolocation validation for cleaners.\n-   **Performance Optimization**: Consolidated API endpoints, parallel data fetching, single invalidation pattern for mutations, parallel push notification eligibility checks.\n-   **Idempotency Pattern**: Critical mutation endpoints use atomic conditional updates to prevent duplicate submissions.\n-   **Cache Management**: Zero API data caching, automatic version checking with cache invalidation and page reload on deployment updates.\n\n### Feature Specifications\n-   **Customer Booking Flow**: Flexible 4-step wizard at `/customer/booking` including email verification (optional), car details entry (with auto-fill), location and company selection (geofence-based), and payment via existing checkout.\n-   **Customer Flow**: Anonymous booking with car plate entry, map-based location selection, geofence-based company matching, Stripe payment, and job tracking (Paid → Assigned → In Progress → Completed).\n-   **Cleaner Flow**: Invitation-based registration, streamlined shift-based status, job acceptance, Google Maps navigation, photo-based job completion. Continuous GPS tracking and automatic shift timeout.\n-   **Company Admin Flow**: Registration (admin approval required), multiple named geofence management, cleaner invitation management with service area assignment, detailed financial reports (with Excel export), and company settings.\n-   **Admin Flow**: Platform-wide analytics, company approval/rejection with fee package selection, financial oversight, manual withdrawal processing, transaction history, and platform settings.\n-   **Job Acceptance**: Stripe payment triggers PENDING_PAYMENT, webhook confirmation to PAID, job becomes available to eligible on-duty cleaners based on four-criteria geolocation validation. First-come-first-served manual acceptance.\n-   **Geofence Validation**: All customer interactions validate location against company service areas.\n-   **Cleaner Geofence Assignment**: Companies can assign cleaners to specific service areas or all areas during invitation or post-registration.\n\n### System Design Choices\n-   **Data Models**: Comprehensive models for Users, Companies, Cleaners, Jobs, Financials, etc., with email as primary customer identifier.\n-   **Currency**: All transactions in AED (United Arab Emirates Dirham).\n-   **Tax Policy**: 5% VAT on car wash and platform fee; tips are VAT-exempt. Receipts show tips as a separate line item.\n-   **Fee Structure**: Flexible three-tier package system (Custom, Package 1, Package 2 - offline payment) with configurable platform fees and VAT calculation. Admin can change fee structures.\n-   **Transaction Tracking**: All payments, refunds, and withdrawals tracked with unique reference numbers and Stripe IDs. Atomic receipt number generation. Dual-ledger for withdrawals and payment transactions.\n-   **Auto-Refund**: Jobs not accepted within 15 minutes are automatically refunded via Stripe.\n-   **Auto-Shift-Timeout**: Cleaners' shifts automatically end after 10 minutes of no location updates.\n-   **Payment Options**: Card, Apple Pay, and Google Pay via Stripe Payment Request Button.\n-   **API**: RESTful API built with Express.js.\n-   **Transactions**: Database transactions for multi-step operations.\n\n## External Dependencies\n-   **Mapping**: OpenStreetMap (`react-leaflet`), Nominatim, Google Maps.\n-   **Payments**: Stripe.\n-   **Email**: Resend.\n-   **Database**: PostgreSQL.\n-   **Authentication**: Passport.js, bcrypt.\n-   **Session Store**: `connect-pg-simple`.\n-   **File Uploads**: `multer`.","path":null,"size_bytes":11487,"size_tokens":null},"client/src/components/ui/separator.tsx":{"content":"import * as React from \"react\"\nimport * as SeparatorPrimitive from \"@radix-ui/react-separator\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Separator = React.forwardRef<\n  React.ElementRef<typeof SeparatorPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>\n>(\n  (\n    { className, orientation = \"horizontal\", decorative = true, ...props },\n    ref\n  ) => (\n    <SeparatorPrimitive.Root\n      ref={ref}\n      decorative={decorative}\n      orientation={orientation}\n      className={cn(\n        \"shrink-0 bg-border\",\n        orientation === \"horizontal\" ? \"h-[1px] w-full\" : \"h-full w-[1px]\",\n        className\n      )}\n      {...props}\n    />\n  )\n)\nSeparator.displayName = SeparatorPrimitive.Root.displayName\n\nexport { Separator }\n","path":null,"size_bytes":756,"size_tokens":null},"client/src/components/ui/toast.tsx":{"content":"import * as React from \"react\"\nimport * as ToastPrimitives from \"@radix-ui/react-toast\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ToastProvider = ToastPrimitives.Provider\n\nconst ToastViewport = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Viewport>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Viewport\n    ref={ref}\n    className={cn(\n      \"fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]\",\n      className\n    )}\n    {...props}\n  />\n))\nToastViewport.displayName = ToastPrimitives.Viewport.displayName\n\nconst toastVariants = cva(\n  \"group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full\",\n  {\n    variants: {\n      variant: {\n        default: \"border bg-background text-foreground\",\n        destructive:\n          \"destructive group border-destructive bg-destructive text-destructive-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Toast = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &\n    VariantProps<typeof toastVariants>\n>(({ className, variant, ...props }, ref) => {\n  return (\n    <ToastPrimitives.Root\n      ref={ref}\n      className={cn(toastVariants({ variant }), className)}\n      {...props}\n    />\n  )\n})\nToast.displayName = ToastPrimitives.Root.displayName\n\nconst ToastAction = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Action>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Action\n    ref={ref}\n    className={cn(\n      \"inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive\",\n      className\n    )}\n    {...props}\n  />\n))\nToastAction.displayName = ToastPrimitives.Action.displayName\n\nconst ToastClose = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Close>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Close\n    ref={ref}\n    className={cn(\n      \"absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600\",\n      className\n    )}\n    toast-close=\"\"\n    {...props}\n  >\n    <X className=\"h-4 w-4\" />\n  </ToastPrimitives.Close>\n))\nToastClose.displayName = ToastPrimitives.Close.displayName\n\nconst ToastTitle = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Title>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Title\n    ref={ref}\n    className={cn(\"text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nToastTitle.displayName = ToastPrimitives.Title.displayName\n\nconst ToastDescription = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Description>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Description\n    ref={ref}\n    className={cn(\"text-sm opacity-90\", className)}\n    {...props}\n  />\n))\nToastDescription.displayName = ToastPrimitives.Description.displayName\n\ntype ToastProps = React.ComponentPropsWithoutRef<typeof Toast>\n\ntype ToastActionElement = React.ReactElement<typeof ToastAction>\n\nexport {\n  type ToastProps,\n  type ToastActionElement,\n  ToastProvider,\n  ToastViewport,\n  Toast,\n  ToastTitle,\n  ToastDescription,\n  ToastClose,\n  ToastAction,\n}\n","path":null,"size_bytes":4845,"size_tokens":null},"postcss.config.js":{"content":"export default {\n  plugins: {\n    tailwindcss: {},\n    autoprefixer: {},\n  },\n}\n","path":null,"size_bytes":80,"size_tokens":null},"client/src/pages/not-found.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { AlertCircle } from \"lucide-react\";\n\nexport default function NotFound() {\n  return (\n    <div className=\"min-h-screen w-full flex items-center justify-center bg-gray-50\">\n      <Card className=\"w-full max-w-md mx-4\">\n        <CardContent className=\"pt-6\">\n          <div className=\"flex mb-4 gap-2\">\n            <AlertCircle className=\"h-8 w-8 text-red-500\" />\n            <h1 className=\"text-2xl font-bold text-gray-900\">404 Page Not Found</h1>\n          </div>\n\n          <p className=\"mt-4 text-sm text-gray-600\">\n            Did you forget to add the page to the router?\n          </p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":711,"size_tokens":null},"client/src/components/ui/scroll-area.tsx":{"content":"import * as React from \"react\"\nimport * as ScrollAreaPrimitive from \"@radix-ui/react-scroll-area\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ScrollArea = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <ScrollAreaPrimitive.Root\n    ref={ref}\n    className={cn(\"relative overflow-hidden\", className)}\n    {...props}\n  >\n    <ScrollAreaPrimitive.Viewport className=\"h-full w-full rounded-[inherit]\">\n      {children}\n    </ScrollAreaPrimitive.Viewport>\n    <ScrollBar />\n    <ScrollAreaPrimitive.Corner />\n  </ScrollAreaPrimitive.Root>\n))\nScrollArea.displayName = ScrollAreaPrimitive.Root.displayName\n\nconst ScrollBar = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>\n>(({ className, orientation = \"vertical\", ...props }, ref) => (\n  <ScrollAreaPrimitive.ScrollAreaScrollbar\n    ref={ref}\n    orientation={orientation}\n    className={cn(\n      \"flex touch-none select-none transition-colors\",\n      orientation === \"vertical\" &&\n        \"h-full w-2.5 border-l border-l-transparent p-[1px]\",\n      orientation === \"horizontal\" &&\n        \"h-2.5 flex-col border-t border-t-transparent p-[1px]\",\n      className\n    )}\n    {...props}\n  >\n    <ScrollAreaPrimitive.ScrollAreaThumb className=\"relative flex-1 rounded-full bg-border\" />\n  </ScrollAreaPrimitive.ScrollAreaScrollbar>\n))\nScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName\n\nexport { ScrollArea, ScrollBar }\n","path":null,"size_bytes":1642,"size_tokens":null},"client/src/components/ui/badge.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst badgeVariants = cva(\n  // Whitespace-nowrap: Badges should never wrap.\n  \"whitespace-nowrap inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\" +\n  \" hover-elevate \" ,\n  {\n    variants: {\n      variant: {\n        default:\n          \"border-transparent bg-primary text-primary-foreground shadow-xs\",\n        secondary: \"border-transparent bg-secondary text-secondary-foreground\",\n        destructive:\n          \"border-transparent bg-destructive text-destructive-foreground shadow-xs\",\n\n        outline: \" border [border-color:var(--badge-outline)] shadow-xs\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  },\n)\n\nexport interface BadgeProps\n  extends React.HTMLAttributes<HTMLDivElement>,\n    VariantProps<typeof badgeVariants> {}\n\nfunction Badge({ className, variant, ...props }: BadgeProps) {\n  return (\n    <div className={cn(badgeVariants({ variant }), className)} {...props} />\n  );\n}\n\nexport { Badge, badgeVariants }\n","path":null,"size_bytes":1202,"size_tokens":null},"client/src/components/ui/resizable.tsx":{"content":"\"use client\"\n\nimport { GripVertical } from \"lucide-react\"\nimport * as ResizablePrimitive from \"react-resizable-panels\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ResizablePanelGroup = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) => (\n  <ResizablePrimitive.PanelGroup\n    className={cn(\n      \"flex h-full w-full data-[panel-group-direction=vertical]:flex-col\",\n      className\n    )}\n    {...props}\n  />\n)\n\nconst ResizablePanel = ResizablePrimitive.Panel\n\nconst ResizableHandle = ({\n  withHandle,\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {\n  withHandle?: boolean\n}) => (\n  <ResizablePrimitive.PanelResizeHandle\n    className={cn(\n      \"relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 [&[data-panel-group-direction=vertical]>div]:rotate-90\",\n      className\n    )}\n    {...props}\n  >\n    {withHandle && (\n      <div className=\"z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border\">\n        <GripVertical className=\"h-2.5 w-2.5\" />\n      </div>\n    )}\n  </ResizablePrimitive.PanelResizeHandle>\n)\n\nexport { ResizablePanelGroup, ResizablePanel, ResizableHandle }\n","path":null,"size_bytes":1723,"size_tokens":null},"client/src/components/ui/toggle.tsx":{"content":"import * as React from \"react\"\nimport * as TogglePrimitive from \"@radix-ui/react-toggle\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst toggleVariants = cva(\n  \"inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 gap-2\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        outline:\n          \"border border-input bg-transparent hover:bg-accent hover:text-accent-foreground\",\n      },\n      size: {\n        default: \"h-10 px-3 min-w-10\",\n        sm: \"h-9 px-2.5 min-w-9\",\n        lg: \"h-11 px-5 min-w-11\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst Toggle = React.forwardRef<\n  React.ElementRef<typeof TogglePrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, ...props }, ref) => (\n  <TogglePrimitive.Root\n    ref={ref}\n    className={cn(toggleVariants({ variant, size, className }))}\n    {...props}\n  />\n))\n\nToggle.displayName = TogglePrimitive.Root.displayName\n\nexport { Toggle, toggleVariants }\n","path":null,"size_bytes":1527,"size_tokens":null},"client/src/components/theme-provider.tsx":{"content":"import { createContext, useContext, useEffect, useState } from \"react\";\n\ntype Theme = \"light\" | \"dark\";\n\ninterface ThemeContextType {\n  theme: Theme;\n  toggleTheme: () => void;\n}\n\nconst ThemeContext = createContext<ThemeContextType | undefined>(undefined);\n\nexport function useTheme() {\n  const context = useContext(ThemeContext);\n  if (!context) {\n    throw new Error(\"useTheme must be used within ThemeProvider\");\n  }\n  return context;\n}\n\nexport function ThemeProvider({ children }: { children: React.ReactNode }) {\n  const [theme, setTheme] = useState<Theme>(() => {\n    const stored = localStorage.getItem(\"theme\");\n    return (stored as Theme) || \"light\";\n  });\n\n  useEffect(() => {\n    const root = document.documentElement;\n    if (theme === \"dark\") {\n      root.classList.add(\"dark\");\n    } else {\n      root.classList.remove(\"dark\");\n    }\n    localStorage.setItem(\"theme\", theme);\n  }, [theme]);\n\n  const toggleTheme = () => {\n    setTheme((prev) => (prev === \"light\" ? \"dark\" : \"light\"));\n  };\n\n  return (\n    <ThemeContext.Provider value={{ theme, toggleTheme }}>\n      {children}\n    </ThemeContext.Provider>\n  );\n}\n","path":null,"size_bytes":1129,"size_tokens":null},"client/src/pages/company-dashboard.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Link } from \"wouter\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger, DialogFooter } from \"@/components/ui/dialog\";\nimport { AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle, AlertDialogTrigger } from \"@/components/ui/alert-dialog\";\nimport { Users, Briefcase, DollarSign, Star, TrendingUp, UserPlus, AlertCircle, Phone, CheckCircle, Clock, XCircle, FileText, ShieldOff, ShieldCheck, Map, Settings, History, Wallet } from \"lucide-react\";\nimport { CompanyAnalytics, Cleaner, Company, CleanerInvitation } from \"@shared/schema\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Alert, AlertDescription, AlertTitle } from \"@/components/ui/alert\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { formatDistanceToNow, format } from \"date-fns\";\nimport GeofenceEditor from \"@/components/geofence-editor\";\nimport GeofenceManager from \"@/components/geofence-manager\";\n\nexport default function CompanyDashboard() {\n  const { currentUser } = useAuth();\n  const { toast } = useToast();\n  const [isInviteDialogOpen, setIsInviteDialogOpen] = useState(false);\n  const [phoneNumber, setPhoneNumber] = useState(\"\");\n  const [selectedGeofenceIds, setSelectedGeofenceIds] = useState<number[]>([]);\n  const [assignAllGeofences, setAssignAllGeofences] = useState(true);\n  const [editingCleanerId, setEditingCleanerId] = useState<number | null>(null);\n  const [editDialogOpen, setEditDialogOpen] = useState(false);\n  const [editSelectedGeofenceIds, setEditSelectedGeofenceIds] = useState<number[]>([]);\n  const [editAssignAllGeofences, setEditAssignAllGeofences] = useState(false);\n  const [deactivatingCleanerId, setDeactivatingCleanerId] = useState<number | null>(null);\n  const [deactivateDialogOpen, setDeactivateDialogOpen] = useState(false);\n  const [reactivatingCleanerId, setReactivatingCleanerId] = useState<number | null>(null);\n  const [reactivateDialogOpen, setReactivateDialogOpen] = useState(false);\n  const [showGeofence, setShowGeofence] = useState(false);\n  const [nameFilter, setNameFilter] = useState(\"\");\n  const [locationFilter, setLocationFilter] = useState<string>(\"all\");\n\n  // Helper function to check if a cleaner is truly online (active within last 10 minutes)\n  const isCleanerOnline = (cleaner: Cleaner): boolean => {\n    if (cleaner.status !== \"on_duty\" || !cleaner.lastLocationUpdate) {\n      return false;\n    }\n    const lastUpdate = new Date(cleaner.lastLocationUpdate);\n    const now = new Date();\n    const tenMinutesAgo = new Date(now.getTime() - 10 * 60 * 1000);\n    return lastUpdate > tenMinutesAgo;\n  };\n\n  const { data: company, isLoading: isLoadingCompany } = useQuery<Company>({\n    queryKey: [\"/api/companies\", currentUser?.companyId],\n    enabled: !!currentUser?.companyId,\n  });\n\n  const { data: analytics, isLoading } = useQuery<CompanyAnalytics>({\n    queryKey: [\"/api/company/analytics\"],\n    enabled: !!currentUser?.companyId,\n  });\n\n  type CompanyGeofence = {\n    id: number;\n    companyId: number;\n    name: string;\n    polygon: Array<[number, number]>;\n    createdAt: Date;\n  };\n\n  type CleanerWithUser = Cleaner & {\n    displayName: string | null;\n    phoneNumber: string | null;\n    email: string | null;\n    assignedGeofences: CompanyGeofence[];\n    isAssignedToAll: boolean;\n  };\n\n  const { data: cleaners, isLoading: isLoadingCleaners } = useQuery<CleanerWithUser[]>({\n    queryKey: [\"/api/company/cleaners\"],\n    enabled: !!currentUser?.companyId && company?.isActive === 1,\n  });\n\n  const { data: invitations, isLoading: isLoadingInvitations } = useQuery<CleanerInvitation[]>({\n    queryKey: [\"/api/company/invitations\"],\n    enabled: !!currentUser?.companyId && company?.isActive === 1,\n  });\n\n  const { data: geofences = [], isLoading: isLoadingGeofences } = useQuery<CompanyGeofence[]>({\n    queryKey: [\"/api/company/geofences\"],\n    enabled: !!currentUser?.companyId && company?.isActive === 1,\n  });\n\n\n  const inviteCleanerMutation = useMutation({\n    mutationFn: async (data: { phoneNumber: string; geofenceIds?: number[]; assignAll?: boolean }) => {\n      return await apiRequest(\"POST\", \"/api/company/invite-cleaner\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/company/invitations\"] });\n      setIsInviteDialogOpen(false);\n      setPhoneNumber(\"\");\n      setSelectedGeofenceIds([]);\n      setAssignAllGeofences(true);\n      toast({\n        title: \"Invitation Sent\",\n        description: \"The cleaner invitation has been created. They can now register using this phone number.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  type CleanerGeofenceResponse = {\n    geofences: CompanyGeofence[];\n    assignAll: boolean;\n  };\n\n  const { data: cleanerAssignmentData } = useQuery<CleanerGeofenceResponse>({\n    queryKey: [\"/api/company/cleaners\", editingCleanerId, \"geofences\"],\n    enabled: !!editingCleanerId,\n  });\n\n  const updateCleanerGeofencesMutation = useMutation({\n    mutationFn: async (data: { cleanerId: number; geofenceIds?: number[]; assignAll?: boolean }) => {\n      return await apiRequest(\"PUT\", `/api/company/cleaners/${data.cleanerId}/geofences`, {\n        geofenceIds: data.geofenceIds,\n        assignAll: data.assignAll,\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/company/cleaners\", editingCleanerId, \"geofences\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/company/cleaners\"] });\n      setEditDialogOpen(false);\n      setEditingCleanerId(null);\n      setEditSelectedGeofenceIds([]);\n      setEditAssignAllGeofences(false);\n      toast({\n        title: \"Service Areas Updated\",\n        description: \"The cleaner's service area assignments have been updated.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleEditGeofences = (cleanerId: number) => {\n    setEditingCleanerId(cleanerId);\n    setEditDialogOpen(true);\n  };\n\n  useEffect(() => {\n    if (cleanerAssignmentData) {\n      if (cleanerAssignmentData.assignAll) {\n        setEditAssignAllGeofences(true);\n        setEditSelectedGeofenceIds([]);\n      } else {\n        setEditAssignAllGeofences(false);\n        const geofenceIds = cleanerAssignmentData.geofences.map(g => g.id);\n        setEditSelectedGeofenceIds(geofenceIds);\n      }\n    } else if (editingCleanerId) {\n      setEditAssignAllGeofences(false);\n      setEditSelectedGeofenceIds([]);\n    }\n  }, [cleanerAssignmentData, editingCleanerId]);\n\n  const deactivateCleanerMutation = useMutation({\n    mutationFn: async (cleanerId: number) => {\n      return await apiRequest(\"POST\", `/api/company/cleaners/${cleanerId}/deactivate`, {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/company/cleaners\"] });\n      setDeactivateDialogOpen(false);\n      setDeactivatingCleanerId(null);\n      toast({\n        title: \"Cleaner Deactivated\",\n        description: \"The cleaner has been deactivated and logged out.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleDeactivateClick = (cleanerId: number) => {\n    setDeactivatingCleanerId(cleanerId);\n    setDeactivateDialogOpen(true);\n  };\n\n  const handleConfirmDeactivate = () => {\n    if (deactivatingCleanerId !== null) {\n      deactivateCleanerMutation.mutate(deactivatingCleanerId);\n    }\n  };\n\n  const handleCancelDeactivate = () => {\n    setDeactivateDialogOpen(false);\n    setDeactivatingCleanerId(null);\n  };\n\n  const reactivateCleanerMutation = useMutation({\n    mutationFn: async (cleanerId: number) => {\n      return await apiRequest(\"POST\", `/api/company/cleaners/${cleanerId}/reactivate`, {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/company/cleaners\"] });\n      setReactivateDialogOpen(false);\n      setReactivatingCleanerId(null);\n      toast({\n        title: \"Cleaner Reactivated\",\n        description: \"The cleaner has been reactivated and can now login.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleReactivateClick = (cleanerId: number) => {\n    setReactivatingCleanerId(cleanerId);\n    setReactivateDialogOpen(true);\n  };\n\n  const handleConfirmReactivate = () => {\n    if (reactivatingCleanerId !== null) {\n      reactivateCleanerMutation.mutate(reactivatingCleanerId);\n    }\n  };\n\n  const handleCancelReactivate = () => {\n    setReactivateDialogOpen(false);\n    setReactivatingCleanerId(null);\n  };\n\n  // Filter cleaners by name and location\n  const filterCleaners = (cleanersList: CleanerWithUser[] | undefined) => {\n    if (!cleanersList) return [];\n    \n    return cleanersList.filter((cleaner) => {\n      // Filter by name\n      const nameMatch = !nameFilter || \n        (cleaner.displayName && cleaner.displayName.toLowerCase().includes(nameFilter.toLowerCase())) ||\n        (cleaner.phoneNumber && cleaner.phoneNumber.includes(nameFilter));\n      \n      // Filter by location\n      let locationMatch = true;\n      if (locationFilter && locationFilter !== \"all\") {\n        const geofenceId = parseInt(locationFilter);\n        if (cleaner.isAssignedToAll) {\n          locationMatch = true;\n        } else {\n          locationMatch = cleaner.assignedGeofences.some(g => g.id === geofenceId);\n        }\n      }\n      \n      return nameMatch && locationMatch;\n    });\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen bg-background p-4\">\n        <div className=\"max-w-6xl mx-auto\">\n          <div className=\"mb-6 pt-4\">\n            <Skeleton className=\"h-8 w-48 mb-2\" />\n            <Skeleton className=\"h-4 w-64\" />\n          </div>\n          <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n            {[1, 2, 3, 4, 5, 6].map((i) => (\n              <Card key={i}>\n                <CardHeader>\n                  <Skeleton className=\"h-4 w-24\" />\n                </CardHeader>\n                <CardContent>\n                  <Skeleton className=\"h-8 w-32\" />\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  if (!analytics) {\n    return (\n      <div className=\"min-h-screen bg-background p-4 flex items-center justify-center\">\n        <Card className=\"max-w-md w-full text-center p-6\">\n          <p className=\"text-muted-foreground\">Company analytics not available</p>\n        </Card>\n      </div>\n    );\n  }\n\n  const metrics = [\n    {\n      title: \"Jobs Completed\",\n      value: analytics.totalJobsCompleted,\n      icon: Briefcase,\n      description: \"All time\",\n    },\n    {\n      title: \"Active Cleaners\",\n      value: analytics.activeCleaners,\n      icon: Users,\n      description: \"Currently available\",\n    },\n    {\n      title: \"Net Earnings\",\n      value: `${(analytics.totalNetEarnings || 0).toLocaleString()} AED`,\n      icon: DollarSign,\n      description: \"All time (after fees)\",\n    },\n    {\n      title: \"Average Rating\",\n      value: analytics.averageRating.toFixed(1),\n      icon: Star,\n      description: \"Customer satisfaction\",\n    },\n    {\n      title: \"Jobs This Month\",\n      value: analytics.jobsThisMonth,\n      icon: TrendingUp,\n      description: \"Current month\",\n    },\n    {\n      title: \"Net Earnings This Month\",\n      value: `${(analytics.netEarningsThisMonth || 0).toLocaleString()} AED`,\n      icon: DollarSign,\n      description: \"After fees\",\n    },\n  ];\n\n  return (\n    <div className=\"min-h-screen bg-background p-4 pb-20\">\n      <div className=\"max-w-6xl mx-auto\">\n        {/* Header */}\n        <div className=\"mb-6 pt-4 flex items-start justify-between gap-4\">\n          <div>\n            <h1 className=\"text-2xl font-bold text-foreground mb-1\">\n              Company Dashboard\n            </h1>\n            <p className=\"text-muted-foreground\">\n              Company analytics and performance\n            </p>\n          </div>\n          \n          {/* Action Buttons */}\n          <div className=\"flex flex-wrap gap-2\">\n            <Link href=\"/company/financials\">\n              <Button \n                variant=\"outline\"\n                data-testid=\"button-view-financials\"\n                disabled={company?.isActive === 0}\n              >\n                <FileText className=\"mr-2 h-4 w-4\" />\n                View Financials\n              </Button>\n            </Link>\n            \n            <Link href=\"/company/live-report\">\n              <Button \n                variant=\"outline\"\n                data-testid=\"button-live-report\"\n                disabled={company?.isActive === 0}\n              >\n                <TrendingUp className=\"mr-2 h-4 w-4\" />\n                Live Report\n              </Button>\n            </Link>\n            \n            <Button\n              variant=\"outline\"\n              onClick={() => setShowGeofence(!showGeofence)}\n              data-testid=\"button-manage-geofence\"\n            >\n              <Map className=\"mr-2 h-4 w-4\" />\n              {showGeofence ? \"Hide\" : \"Manage\"} Working Area\n            </Button>\n\n            <Link href=\"/company/shift-history\">\n              <Button\n                variant=\"outline\"\n                data-testid=\"button-shift-history\"\n                disabled={company?.isActive === 0}\n              >\n                <History className=\"mr-2 h-4 w-4\" />\n                Shift History\n              </Button>\n            </Link>\n            \n            <Link href=\"/company/offline-jobs\">\n              <Button\n                variant=\"outline\"\n                data-testid=\"button-offline-jobs\"\n                disabled={company?.isActive === 0}\n              >\n                <Wallet className=\"mr-2 h-4 w-4\" />\n                Cash Jobs\n              </Button>\n            </Link>\n            \n            <Dialog open={isInviteDialogOpen} onOpenChange={setIsInviteDialogOpen}>\n              <DialogTrigger asChild>\n                <Button \n                  data-testid=\"button-invite-cleaner\"\n                  disabled={company?.isActive === 0}\n                >\n                  <UserPlus className=\"mr-2 h-4 w-4\" />\n                  Invite Cleaner\n                </Button>\n              </DialogTrigger>\n              <DialogContent>\n                <DialogHeader>\n                  <DialogTitle>Invite Car Washer</DialogTitle>\n                  <DialogDescription>\n                    Invite a cleaner by their phone number. They will be able to register using this number.\n                  </DialogDescription>\n                </DialogHeader>\n                <div className=\"space-y-4\">\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"phoneNumber\">Phone Number</Label>\n                    <Input\n                      id=\"phoneNumber\"\n                      type=\"tel\"\n                      placeholder=\"+65 1234 5678\"\n                      value={phoneNumber}\n                      onChange={(e) => setPhoneNumber(e.target.value)}\n                      data-testid=\"input-phone-number\"\n                    />\n                    <p className=\"text-sm text-muted-foreground\">\n                      The cleaner will use this number to register on the platform\n                    </p>\n                  </div>\n\n                  {geofences.length > 0 && (\n                    <div className=\"space-y-3 pt-2 border-t\">\n                      <Label>Assign to Service Areas</Label>\n                      \n                      <div className=\"flex items-center space-x-2\">\n                        <Checkbox\n                          id=\"assign-all\"\n                          checked={assignAllGeofences}\n                          onCheckedChange={(checked) => {\n                            setAssignAllGeofences(!!checked);\n                            if (checked) {\n                              setSelectedGeofenceIds([]);\n                            }\n                          }}\n                          data-testid=\"checkbox-assign-all-geofences\"\n                        />\n                        <label\n                          htmlFor=\"assign-all\"\n                          className=\"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 cursor-pointer\"\n                        >\n                          All service areas\n                        </label>\n                      </div>\n\n                      {!assignAllGeofences && (\n                        <div className=\"space-y-2 pl-6\">\n                          <p className=\"text-sm text-muted-foreground\">\n                            Select specific service areas:\n                          </p>\n                          {geofences.map((geofence) => (\n                            <div key={geofence.id} className=\"flex items-center space-x-2\">\n                              <Checkbox\n                                id={`geofence-${geofence.id}`}\n                                checked={selectedGeofenceIds.includes(geofence.id)}\n                                onCheckedChange={(checked) => {\n                                  if (checked) {\n                                    setSelectedGeofenceIds([...selectedGeofenceIds, geofence.id]);\n                                  } else {\n                                    setSelectedGeofenceIds(selectedGeofenceIds.filter(id => id !== geofence.id));\n                                  }\n                                }}\n                                data-testid={`checkbox-geofence-${geofence.id}`}\n                              />\n                              <label\n                                htmlFor={`geofence-${geofence.id}`}\n                                className=\"text-sm leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 cursor-pointer\"\n                              >\n                                {geofence.name}\n                              </label>\n                            </div>\n                          ))}\n                        </div>\n                      )}\n                    </div>\n                  )}\n                </div>\n                <DialogFooter>\n                  <Button\n                    onClick={() => {\n                      inviteCleanerMutation.mutate({\n                        phoneNumber,\n                        geofenceIds: assignAllGeofences ? [] : selectedGeofenceIds,\n                        assignAll: assignAllGeofences,\n                      });\n                    }}\n                    disabled={inviteCleanerMutation.isPending || !phoneNumber || (!assignAllGeofences && selectedGeofenceIds.length === 0 && geofences.length > 0)}\n                    data-testid=\"button-submit-invite\"\n                  >\n                    {inviteCleanerMutation.isPending ? \"Inviting...\" : \"Send Invitation\"}\n                  </Button>\n                </DialogFooter>\n              </DialogContent>\n            </Dialog>\n\n            {/* Edit Cleaner Geofences Dialog */}\n            <Dialog open={editDialogOpen} onOpenChange={setEditDialogOpen}>\n              <DialogContent>\n                <DialogHeader>\n                  <DialogTitle>Manage Service Areas</DialogTitle>\n                  <DialogDescription>\n                    Configure which service areas this cleaner can work in.\n                  </DialogDescription>\n                </DialogHeader>\n                <div className=\"space-y-4\">\n                  {geofences.length > 0 ? (\n                    <div className=\"space-y-3\">\n                      <Label>Assign to Service Areas</Label>\n                      \n                      <div className=\"flex items-center space-x-2\">\n                        <Checkbox\n                          id=\"edit-assign-all\"\n                          checked={editAssignAllGeofences}\n                          onCheckedChange={(checked) => {\n                            setEditAssignAllGeofences(!!checked);\n                            if (checked) {\n                              setEditSelectedGeofenceIds([]);\n                            }\n                          }}\n                          data-testid=\"checkbox-edit-assign-all-geofences\"\n                        />\n                        <label\n                          htmlFor=\"edit-assign-all\"\n                          className=\"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 cursor-pointer\"\n                        >\n                          All service areas\n                        </label>\n                      </div>\n\n                      {!editAssignAllGeofences && (\n                        <div className=\"space-y-2 pl-6\">\n                          <p className=\"text-sm text-muted-foreground\">\n                            Select specific service areas:\n                          </p>\n                          {geofences.map((geofence) => (\n                            <div key={geofence.id} className=\"flex items-center space-x-2\">\n                              <Checkbox\n                                id={`edit-geofence-${geofence.id}`}\n                                checked={editSelectedGeofenceIds.includes(geofence.id)}\n                                onCheckedChange={(checked) => {\n                                  if (checked) {\n                                    setEditSelectedGeofenceIds([...editSelectedGeofenceIds, geofence.id]);\n                                  } else {\n                                    setEditSelectedGeofenceIds(editSelectedGeofenceIds.filter(id => id !== geofence.id));\n                                  }\n                                }}\n                                data-testid={`checkbox-edit-geofence-${geofence.id}`}\n                              />\n                              <label\n                                htmlFor={`edit-geofence-${geofence.id}`}\n                                className=\"text-sm leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 cursor-pointer\"\n                              >\n                                {geofence.name}\n                              </label>\n                            </div>\n                          ))}\n                        </div>\n                      )}\n                    </div>\n                  ) : (\n                    <p className=\"text-sm text-muted-foreground\">\n                      No service areas defined. Please create service areas first.\n                    </p>\n                  )}\n                </div>\n                <DialogFooter>\n                  <Button\n                    variant=\"outline\"\n                    onClick={() => {\n                      setEditDialogOpen(false);\n                      setEditingCleanerId(null);\n                      setEditSelectedGeofenceIds([]);\n                      setEditAssignAllGeofences(false);\n                    }}\n                    data-testid=\"button-cancel-edit\"\n                  >\n                    Cancel\n                  </Button>\n                  <Button\n                    onClick={() => {\n                      if (editingCleanerId) {\n                        updateCleanerGeofencesMutation.mutate({\n                          cleanerId: editingCleanerId,\n                          geofenceIds: editAssignAllGeofences ? [] : editSelectedGeofenceIds,\n                          assignAll: editAssignAllGeofences,\n                        });\n                      }\n                    }}\n                    disabled={updateCleanerGeofencesMutation.isPending}\n                    data-testid=\"button-submit-edit\"\n                  >\n                    {updateCleanerGeofencesMutation.isPending ? \"Updating...\" : \"Update\"}\n                  </Button>\n                </DialogFooter>\n              </DialogContent>\n            </Dialog>\n          </div>\n        </div>\n\n        {/* Pending Approval Alert */}\n        {company && company.isActive === 0 && (\n          <Alert className=\"mb-6\" data-testid=\"alert-pending-approval\">\n            <AlertCircle className=\"h-4 w-4\" />\n            <AlertTitle>Pending Approval</AlertTitle>\n            <AlertDescription>\n              Your company registration is pending admin approval. You will be able to add cleaners and accept jobs once your company is approved.\n            </AlertDescription>\n          </Alert>\n        )}\n\n        {/* Subscription Package Info */}\n        {company && company.isActive === 1 && company.packageType === 'subscription' && (\n          <Card className=\"mb-6\" data-testid=\"card-subscription-info\">\n            <CardHeader className=\"pb-3\">\n              <CardTitle className=\"text-lg flex items-center justify-between\">\n                <span>Subscription Package</span>\n                <Badge variant=\"default\">Monthly</Badge>\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-3\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm font-medium text-muted-foreground\">Cleaner Slots</p>\n                  <p className=\"text-2xl font-bold\">\n                    {cleaners?.filter(c => c.isActive === 1).length || 0} / {company.subscriptionCleanerSlots}\n                  </p>\n                </div>\n                <div className=\"text-right\">\n                  <p className=\"text-sm font-medium text-muted-foreground\">Monthly Fee</p>\n                  <p className=\"text-2xl font-bold text-primary\">\n                    {((company.subscriptionCleanerSlots || 0) / 10 * 500).toFixed(0)} AED\n                  </p>\n                </div>\n              </div>\n              \n              {cleaners && invitations && (\n                <>\n                  <div className=\"w-full bg-muted rounded-full h-2\">\n                    <div \n                      className=\"bg-primary h-2 rounded-full transition-all\"\n                      style={{ \n                        width: `${Math.min(100, ((cleaners.filter(c => c.isActive === 1).length + invitations.filter(inv => inv.status === 'pending').length) / (company.subscriptionCleanerSlots || 1)) * 100)}%` \n                      }}\n                    />\n                  </div>\n                  <div className=\"flex items-center justify-between text-sm text-muted-foreground\">\n                    <span>\n                      {cleaners.filter(c => c.isActive === 1).length} active + {invitations.filter(inv => inv.status === 'pending').length} pending\n                    </span>\n                    {(cleaners.filter(c => c.isActive === 1).length + invitations.filter(inv => inv.status === 'pending').length) >= (company.subscriptionCleanerSlots || 0) && (\n                      <span className=\"text-destructive font-medium\">Limit reached</span>\n                    )}\n                  </div>\n                  {(cleaners.filter(c => c.isActive === 1).length + invitations.filter(inv => inv.status === 'pending').length) >= (company.subscriptionCleanerSlots || 0) && (\n                    <Alert variant=\"destructive\">\n                      <AlertCircle className=\"h-4 w-4\" />\n                      <AlertDescription className=\"text-sm\">\n                        You have reached your cleaner limit. To invite more cleaners, please upgrade your subscription.\n                      </AlertDescription>\n                    </Alert>\n                  )}\n                </>\n              )}\n            </CardContent>\n          </Card>\n        )}\n\n        {/* Metrics Grid */}\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n          {metrics.map((metric) => {\n            const Icon = metric.icon;\n            return (\n              <Card key={metric.title} data-testid={`metric-${metric.title.toLowerCase().replace(/\\s+/g, '-')}`}>\n                <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n                  <CardTitle className=\"text-sm font-medium\">\n                    {metric.title}\n                  </CardTitle>\n                  <Icon className=\"h-4 w-4 text-muted-foreground\" />\n                </CardHeader>\n                <CardContent>\n                  <div className=\"text-2xl font-bold\">{metric.value}</div>\n                  <p className=\"text-xs text-muted-foreground mt-1\">\n                    {metric.description}\n                  </p>\n                </CardContent>\n              </Card>\n            );\n          })}\n        </div>\n\n        {/* Geofence Management - Multiple Named Service Areas */}\n        {showGeofence && currentUser?.companyId && (\n          <div className=\"mt-8\">\n            <GeofenceManager companyId={currentUser.companyId} />\n          </div>\n        )}\n\n        {/* Team Management - Unified View */}\n        <div className=\"mt-8\">\n          <Card>\n            <CardHeader>\n              <CardTitle>Team Management</CardTitle>\n              <CardDescription>\n                Your car washers and pending invitations\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              {isLoadingCleaners || isLoadingInvitations ? (\n                <div className=\"space-y-4\">\n                  {[1, 2, 3, 4].map((i) => (\n                    <Skeleton key={i} className=\"h-20 w-full\" />\n                  ))}\n                </div>\n              ) : (\n                <div className=\"space-y-6\">\n                  {/* Filters */}\n                  <div className=\"flex flex-col sm:flex-row gap-3 p-4 bg-muted/50 rounded-lg\">\n                    <div className=\"flex-1\">\n                      <Label htmlFor=\"name-filter\" className=\"text-sm mb-1.5\">Search by Name or Phone</Label>\n                      <Input\n                        id=\"name-filter\"\n                        placeholder=\"Search cleaners...\"\n                        value={nameFilter}\n                        onChange={(e) => setNameFilter(e.target.value)}\n                        data-testid=\"input-name-filter\"\n                        className=\"bg-background\"\n                      />\n                    </div>\n                    <div className=\"flex-1\">\n                      <Label htmlFor=\"location-filter\" className=\"text-sm mb-1.5\">Filter by Location</Label>\n                      <Select value={locationFilter} onValueChange={setLocationFilter}>\n                        <SelectTrigger id=\"location-filter\" data-testid=\"select-location-filter\" className=\"bg-background\">\n                          <SelectValue placeholder=\"All locations\" />\n                        </SelectTrigger>\n                        <SelectContent>\n                          <SelectItem value=\"all\">All locations</SelectItem>\n                          {geofences.map((geofence) => (\n                            <SelectItem key={geofence.id} value={geofence.id.toString()}>\n                              {geofence.name}\n                            </SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                    </div>\n                  </div>\n\n                  {/* Active Cleaners Section */}\n                  {(() => {\n                    const filteredActiveCleaners = filterCleaners(cleaners)?.filter(c => isCleanerOnline(c));\n                    return filteredActiveCleaners && filteredActiveCleaners.length > 0 && (\n                    <div>\n                      <h3 className=\"text-sm font-semibold text-foreground mb-3 flex items-center gap-2\">\n                        <div className=\"h-2 w-2 rounded-full bg-green-500\" />\n                        Active Now ({filteredActiveCleaners.length})\n                      </h3>\n                      <div className=\"space-y-2\">\n                        {filteredActiveCleaners.map((cleaner) => {\n                          const shiftInfo = analytics.shiftRoster?.find(s => s.cleanerId === cleaner.id);\n                          const isThisCleanerBeingDeactivated = deactivatingCleanerId === cleaner.id && deactivateCleanerMutation.isPending;\n                          const locationText = cleaner.isAssignedToAll \n                            ? \"All locations\" \n                            : cleaner.assignedGeofences.map(g => g.name).join(\", \") || \"No location assigned\";\n                          \n                          return (\n                            <div\n                              key={`active-${cleaner.id}`}\n                              className=\"flex items-center justify-between gap-4 p-4 border rounded-lg hover-elevate\"\n                              data-testid={`team-member-active-${cleaner.id}`}\n                            >\n                              <div className=\"flex items-center gap-3 flex-1 min-w-0\">\n                                <div className=\"h-3 w-3 rounded-full bg-green-500 flex-shrink-0\" />\n                                <div className=\"min-w-0 flex-1\">\n                                  <p className=\"font-medium\">{cleaner.displayName || `Car Washer #${cleaner.id}`}</p>\n                                  <p className=\"text-sm text-muted-foreground\">\n                                    {cleaner.phoneNumber || 'No phone'} • {cleaner.totalJobsCompleted} jobs • Rating: {cleaner.rating || \"N/A\"}\n                                    {shiftInfo?.activeShift && ` • On shift: ${shiftInfo.activeShift.duration}m`}\n                                  </p>\n                                  <p className=\"text-xs text-muted-foreground flex items-center gap-1 mt-1\">\n                                    <Map className=\"h-3 w-3\" />\n                                    {locationText}\n                                  </p>\n                                </div>\n                              </div>\n                              <div className=\"flex items-center gap-2\">\n                                <Badge variant=\"default\">Active</Badge>\n                                <Button\n                                  variant=\"ghost\"\n                                  size=\"icon\"\n                                  onClick={() => handleEditGeofences(cleaner.id)}\n                                  data-testid={`button-edit-geofences-${cleaner.id}`}\n                                >\n                                  <Settings className=\"h-4 w-4\" />\n                                </Button>\n                                {cleaner.isActive !== 0 ? (\n                                  <Button\n                                    variant=\"ghost\"\n                                    size=\"icon\"\n                                    disabled={isThisCleanerBeingDeactivated}\n                                    onClick={() => handleDeactivateClick(cleaner.id)}\n                                    data-testid={`button-deactivate-${cleaner.id}`}\n                                  >\n                                    <ShieldOff className=\"h-4 w-4\" />\n                                  </Button>\n                                ) : (\n                                  <Button\n                                    variant=\"ghost\"\n                                    size=\"icon\"\n                                    disabled={reactivatingCleanerId === cleaner.id && reactivateCleanerMutation.isPending}\n                                    onClick={() => handleReactivateClick(cleaner.id)}\n                                    data-testid={`button-reactivate-${cleaner.id}`}\n                                  >\n                                    <ShieldCheck className=\"h-4 w-4 text-green-500\" />\n                                  </Button>\n                                )}\n                              </div>\n                            </div>\n                          );\n                        })}\n                      </div>\n                    </div>\n                  );\n                  })()}\n\n                  {/* Available/Off Duty Cleaners Section */}\n                  {(() => {\n                    const filteredOffDutyCleaners = filterCleaners(cleaners)?.filter(c => !isCleanerOnline(c));\n                    return filteredOffDutyCleaners && filteredOffDutyCleaners.length > 0 && (\n                    <div>\n                      <h3 className=\"text-sm font-semibold text-foreground mb-3 flex items-center gap-2\">\n                        <div className=\"h-2 w-2 rounded-full bg-gray-400\" />\n                        Off Duty ({filteredOffDutyCleaners.length})\n                      </h3>\n                      <div className=\"space-y-2\">\n                        {filteredOffDutyCleaners.map((cleaner) => {\n                          const isThisCleanerBeingDeactivated = deactivatingCleanerId === cleaner.id && deactivateCleanerMutation.isPending;\n                          const locationText = cleaner.isAssignedToAll \n                            ? \"All locations\" \n                            : cleaner.assignedGeofences.map(g => g.name).join(\", \") || \"No location assigned\";\n                          \n                          return (\n                            <div\n                              key={`offline-${cleaner.id}`}\n                              className=\"flex items-center justify-between gap-4 p-4 border rounded-lg hover-elevate\"\n                              data-testid={`team-member-offline-${cleaner.id}`}\n                            >\n                              <div className=\"flex items-center gap-3 flex-1 min-w-0\">\n                                <div className=\"h-3 w-3 rounded-full bg-gray-400 flex-shrink-0\" />\n                                <div className=\"min-w-0 flex-1\">\n                                  <p className=\"font-medium\">{cleaner.displayName || `Car Washer #${cleaner.id}`}</p>\n                                  <p className=\"text-sm text-muted-foreground\">\n                                    {cleaner.phoneNumber || 'No phone'} • {cleaner.totalJobsCompleted} jobs • Rating: {cleaner.rating || \"N/A\"}\n                                  </p>\n                                  <p className=\"text-xs text-muted-foreground flex items-center gap-1 mt-1\">\n                                    <Map className=\"h-3 w-3\" />\n                                    {locationText}\n                                  </p>\n                                </div>\n                              </div>\n                              <div className=\"flex items-center gap-2\">\n                                <Badge variant=\"secondary\">Off Duty</Badge>\n                                <Button\n                                  variant=\"ghost\"\n                                  size=\"icon\"\n                                  onClick={() => handleEditGeofences(cleaner.id)}\n                                  data-testid={`button-edit-geofences-${cleaner.id}`}\n                                >\n                                  <Settings className=\"h-4 w-4\" />\n                                </Button>\n                                {cleaner.isActive !== 0 ? (\n                                  <Button\n                                    variant=\"ghost\"\n                                    size=\"icon\"\n                                    disabled={isThisCleanerBeingDeactivated}\n                                    onClick={() => handleDeactivateClick(cleaner.id)}\n                                    data-testid={`button-deactivate-${cleaner.id}`}\n                                  >\n                                    <ShieldOff className=\"h-4 w-4\" />\n                                  </Button>\n                                ) : (\n                                  <Button\n                                    variant=\"ghost\"\n                                    size=\"icon\"\n                                    disabled={reactivatingCleanerId === cleaner.id && reactivateCleanerMutation.isPending}\n                                    onClick={() => handleReactivateClick(cleaner.id)}\n                                    data-testid={`button-reactivate-${cleaner.id}`}\n                                  >\n                                    <ShieldCheck className=\"h-4 w-4 text-green-500\" />\n                                  </Button>\n                                )}\n                              </div>\n                            </div>\n                          );\n                        })}\n                      </div>\n                    </div>\n                  );\n                  })()}\n\n                  {/* Pending Invitations Section */}\n                  {invitations && invitations.filter(i => i.status === \"pending\").length > 0 && (\n                    <div>\n                      <h3 className=\"text-sm font-semibold text-foreground mb-3 flex items-center gap-2\">\n                        <Clock className=\"h-4 w-4 text-yellow-500\" />\n                        Pending Invitations ({invitations.filter(i => i.status === \"pending\").length})\n                      </h3>\n                      <div className=\"space-y-2\">\n                        {invitations.filter(i => i.status === \"pending\").map((invitation) => (\n                          <div\n                            key={`invitation-${invitation.id}`}\n                            className=\"flex items-center justify-between p-4 border rounded-lg hover-elevate\"\n                            data-testid={`team-invitation-${invitation.id}`}\n                          >\n                            <div className=\"flex items-center gap-3\">\n                              <Phone className=\"h-5 w-5 text-muted-foreground\" />\n                              <div>\n                                <p className=\"font-medium\">{invitation.phoneNumber}</p>\n                                <p className=\"text-sm text-muted-foreground\">\n                                  Invited {new Date(invitation.invitedAt).toLocaleDateString('en-AE', { year: 'numeric', month: 'short', day: 'numeric', timeZone: 'Asia/Dubai' })}\n                                </p>\n                              </div>\n                            </div>\n                            <Badge variant=\"secondary\">\n                              <Clock className=\"h-3 w-3 mr-1\" />\n                              Pending\n                            </Badge>\n                          </div>\n                        ))}\n                      </div>\n                    </div>\n                  )}\n\n                  {/* Empty State */}\n                  {(!cleaners || cleaners.length === 0) && (!invitations || invitations.filter(i => i.status === \"pending\").length === 0) && (\n                    <div className=\"text-center text-muted-foreground py-12\">\n                      <Users className=\"h-16 w-16 mx-auto mb-4 opacity-30\" />\n                      <p className=\"text-lg font-medium\">No team members yet</p>\n                      <p className=\"text-sm mt-2\">\n                        Click \"Invite Cleaner\" to add your first car washer\n                      </p>\n                    </div>\n                  )}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </div>\n\n        {/* Deactivate Confirmation Dialog */}\n        <AlertDialog open={deactivateDialogOpen} onOpenChange={setDeactivateDialogOpen}>\n          <AlertDialogContent>\n            <AlertDialogHeader>\n              <AlertDialogTitle>\n                Deactivate {cleaners?.find(c => c.id === deactivatingCleanerId)?.displayName || `Car Washer #${deactivatingCleanerId}`}?\n              </AlertDialogTitle>\n              <AlertDialogDescription>\n                They'll immediately lose access and be logged out. This action can be reversed by clicking the reactivate button.\n              </AlertDialogDescription>\n            </AlertDialogHeader>\n            <AlertDialogFooter>\n              <AlertDialogCancel\n                onClick={handleCancelDeactivate}\n                disabled={deactivateCleanerMutation.isPending}\n                data-testid=\"button-cancel-deactivate\"\n              >\n                Cancel\n              </AlertDialogCancel>\n              <Button\n                onClick={handleConfirmDeactivate}\n                disabled={deactivateCleanerMutation.isPending}\n                className=\"bg-destructive hover:bg-destructive/90\"\n                data-testid=\"button-confirm-deactivate\"\n              >\n                {deactivateCleanerMutation.isPending ? \"Deactivating...\" : \"Deactivate\"}\n              </Button>\n            </AlertDialogFooter>\n          </AlertDialogContent>\n        </AlertDialog>\n\n        {/* Reactivate Confirmation Dialog */}\n        <AlertDialog open={reactivateDialogOpen} onOpenChange={setReactivateDialogOpen}>\n          <AlertDialogContent>\n            <AlertDialogHeader>\n              <AlertDialogTitle>\n                Reactivate {cleaners?.find(c => c.id === reactivatingCleanerId)?.displayName || `Car Washer #${reactivatingCleanerId}`}?\n              </AlertDialogTitle>\n              <AlertDialogDescription>\n                They'll regain access and be able to login and work again.\n              </AlertDialogDescription>\n            </AlertDialogHeader>\n            <AlertDialogFooter>\n              <AlertDialogCancel\n                onClick={handleCancelReactivate}\n                disabled={reactivateCleanerMutation.isPending}\n                data-testid=\"button-cancel-reactivate\"\n              >\n                Cancel\n              </AlertDialogCancel>\n              <Button\n                onClick={handleConfirmReactivate}\n                disabled={reactivateCleanerMutation.isPending}\n                data-testid=\"button-confirm-reactivate\"\n              >\n                {reactivateCleanerMutation.isPending ? \"Reactivating...\" : \"Reactivate\"}\n              </Button>\n            </AlertDialogFooter>\n          </AlertDialogContent>\n        </AlertDialog>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":46752,"size_tokens":null},"client/src/components/ui/popover.tsx":{"content":"import * as React from \"react\"\nimport * as PopoverPrimitive from \"@radix-ui/react-popover\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Popover = PopoverPrimitive.Root\n\nconst PopoverTrigger = PopoverPrimitive.Trigger\n\nconst PopoverContent = React.forwardRef<\n  React.ElementRef<typeof PopoverPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <PopoverPrimitive.Portal>\n    <PopoverPrimitive.Content\n      ref={ref}\n      align={align}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </PopoverPrimitive.Portal>\n))\nPopoverContent.displayName = PopoverPrimitive.Content.displayName\n\nexport { Popover, PopoverTrigger, PopoverContent }\n","path":null,"size_bytes":1280,"size_tokens":null},"client/src/pages/checkout.tsx":{"content":"// Stripe checkout integration - from javascript_stripe blueprint\nimport { useEffect, useState } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { useStripe, Elements, PaymentElement, useElements, PaymentRequestButtonElement } from '@stripe/react-stripe-js';\nimport { loadStripe, PaymentRequest } from '@stripe/stripe-js';\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Button } from \"@/components/ui/button\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { Car, MapPin, DollarSign, Building2, Phone, LogIn } from \"lucide-react\";\nimport logoUrl from \"@assets/IMG_2508_1762619079711.png\";\nimport { Link } from \"wouter\";\n\nif (!import.meta.env.VITE_STRIPE_PUBLIC_KEY) {\n  throw new Error('Missing required Stripe key: VITE_STRIPE_PUBLIC_KEY');\n}\nconst stripePromise = loadStripe(import.meta.env.VITE_STRIPE_PUBLIC_KEY);\n\nfunction CheckoutForm({ \n  paymentIntentId, \n  clientSecret, \n  jobData, \n  onTipUpdate,\n  paymentToken\n}: { \n  paymentIntentId?: string;\n  clientSecret: string;\n  jobData: any;\n  onTipUpdate: (fees: any) => void;\n  paymentToken?: string | null;\n}) {\n  const stripe = useStripe();\n  const elements = useElements();\n  const { toast } = useToast();\n  const [, setLocation] = useLocation();\n  const [processing, setProcessing] = useState(false);\n  const [paymentRequest, setPaymentRequest] = useState<PaymentRequest | null>(null);\n  const [tipAmount, setTipAmount] = useState(0);\n  const [customTip, setCustomTip] = useState(\"\");\n  const [updatingTip, setUpdatingTip] = useState(false);\n  const [customTipError, setCustomTipError] = useState(\"\");\n\n  // Handle tip update\n  const updateTip = async (newTip: number) => {\n    if (!paymentIntentId) return;\n    \n    setUpdatingTip(true);\n    setCustomTipError(\"\");\n    try {\n      const response = await apiRequest(\"PATCH\", `/api/payment-intents/${paymentIntentId}`, {\n        tipAmount: newTip,\n      });\n      const fees = await response.json();\n      \n      // Update parent component with new fees\n      onTipUpdate(fees);\n      \n      // Update payment request if available\n      if (paymentRequest) {\n        paymentRequest.update({\n          total: {\n            label: 'Car Wash Service',\n            amount: Math.round(fees.totalAmount * 100),\n          },\n        });\n      }\n      \n      setTipAmount(newTip);\n      setCustomTip(\"\"); // Clear custom input after successful update\n    } catch (error) {\n      console.error(\"Failed to update tip:\", error);\n      toast({\n        title: \"Error\",\n        description: \"Failed to update tip amount\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setUpdatingTip(false);\n    }\n  };\n\n  // Setup Payment Request for Apple Pay / Google Pay\n  useEffect(() => {\n    if (!stripe || !jobData) {\n      return;\n    }\n\n    const pr = stripe.paymentRequest({\n      country: 'AE', // United Arab Emirates\n      currency: 'aed',\n      total: {\n        label: 'Car Wash Service',\n        amount: Math.round(jobData.price * 100), // Convert AED to fils (cents)\n      },\n      requestPayerName: true,\n      requestPayerPhone: true,\n    });\n\n    // Check if wallets are available\n    pr.canMakePayment().then(result => {\n      if (result) {\n        setPaymentRequest(pr);\n      }\n    });\n\n    // Handle payment method from wallet\n    pr.on('paymentmethod', async (e) => {\n      try {\n        // Confirm payment with the payment method from the wallet\n        const { error: confirmError } = await stripe.confirmCardPayment(\n          clientSecret,\n          { payment_method: e.paymentMethod.id },\n          { handleActions: false }\n        );\n\n        if (confirmError) {\n          e.complete('fail');\n          toast({\n            title: \"Payment Failed\",\n            description: confirmError.message,\n            variant: \"destructive\",\n          });\n        } else {\n          e.complete('success');\n          \n          // Manually confirm on backend\n          if (paymentIntentId) {\n            const confirmBody = paymentToken ? { paymentToken } : {};\n            await apiRequest(\"POST\", `/api/confirm-payment/${paymentIntentId}`, confirmBody);\n          }\n          \n          toast({\n            title: \"Payment Successful\",\n            description: \"Your car wash has been booked!\",\n          });\n          \n          const fullPlate = `${jobData.carPlateEmirate} ${jobData.carPlateCode} ${jobData.carPlateNumber}`;\n          sessionStorage.removeItem(\"pendingJob\");\n          setTimeout(() => setLocation(`/customer/track/${fullPlate}`), 1000);\n        }\n      } catch (error) {\n        e.complete('fail');\n        console.error(\"Wallet payment error:\", error);\n      }\n    });\n  }, [stripe, jobData, clientSecret, paymentIntentId, toast, setLocation]);\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n\n    if (!stripe || !elements) {\n      return;\n    }\n\n    setProcessing(true);\n\n    const { error } = await stripe.confirmPayment({\n      elements,\n      redirect: \"if_required\",\n    });\n\n    if (error) {\n      toast({\n        title: \"Payment Failed\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n      setProcessing(false);\n    } else {\n      // Payment succeeded - manually confirm on backend for development\n      try {\n        if (paymentIntentId) {\n          const confirmBody = paymentToken ? { paymentToken } : {};\n          await apiRequest(\"POST\", `/api/confirm-payment/${paymentIntentId}`, confirmBody);\n        }\n        \n        toast({\n          title: \"Payment Successful\",\n          description: \"Your car wash has been booked!\",\n        });\n        \n        // Clear pending job and redirect to tracking\n        const fullPlate = `${jobData.carPlateEmirate} ${jobData.carPlateCode} ${jobData.carPlateNumber}`;\n        sessionStorage.removeItem(\"pendingJob\");\n        setTimeout(() => setLocation(`/customer/track/${fullPlate}`), 1000);\n      } catch (confirmError) {\n        console.error(\"Payment confirmation error:\", confirmError);\n        toast({\n          title: \"Payment Processed\",\n          description: \"Confirming your booking...\",\n        });\n        const fullPlate = `${jobData.carPlateEmirate} ${jobData.carPlateCode} ${jobData.carPlateNumber}`;\n        setTimeout(() => setLocation(`/customer/track/${fullPlate}`), 2000);\n      }\n    }\n  };\n\n  const presetTips = [0, 5, 10, 15, 20];\n\n  return (\n    <form onSubmit={handleSubmit} className=\"space-y-6\">\n      {/* Tip Selector */}\n      <div className=\"space-y-3\">\n        <label className=\"text-sm font-medium\">Add a tip for your cleaner (optional)</label>\n        <div className=\"grid grid-cols-3 gap-2\">\n          {presetTips.map((amount) => (\n            <Button\n              key={amount}\n              type=\"button\"\n              variant={tipAmount === amount ? \"default\" : \"outline\"}\n              size=\"sm\"\n              onClick={() => updateTip(amount)}\n              disabled={updatingTip}\n              data-testid={`button-tip-${amount}`}\n            >\n              {amount === 0 ? \"No tip\" : `${amount} AED`}\n            </Button>\n          ))}\n          <div className=\"col-span-3\">\n            <div className=\"flex gap-2\">\n              <div className=\"flex-1\">\n                <input\n                  type=\"number\"\n                  placeholder=\"Custom amount\"\n                  value={customTip}\n                  onChange={(e) => {\n                    setCustomTip(e.target.value);\n                    setCustomTipError(\"\");\n                  }}\n                  className=\"w-full h-9 rounded-md border border-input bg-background px-3 text-sm\"\n                  min=\"0\"\n                  max=\"1000\"\n                  step=\"1\"\n                  data-testid=\"input-custom-tip\"\n                />\n                {customTipError && (\n                  <p className=\"text-xs text-destructive mt-1\">{customTipError}</p>\n                )}\n              </div>\n              <Button\n                type=\"button\"\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={() => {\n                  const amount = parseFloat(customTip) || 0;\n                  if (amount < 0) {\n                    setCustomTipError(\"Tip cannot be negative\");\n                    return;\n                  }\n                  if (amount > 1000) {\n                    setCustomTipError(\"Maximum tip is 1000 AED\");\n                    return;\n                  }\n                  setCustomTipError(\"\");\n                  updateTip(amount);\n                }}\n                disabled={updatingTip || !customTip}\n                data-testid=\"button-apply-custom-tip\"\n              >\n                Apply\n              </Button>\n            </div>\n          </div>\n        </div>\n        {updatingTip && (\n          <p className=\"text-xs text-muted-foreground\">Updating total...</p>\n        )}\n      </div>\n\n      <Separator />\n\n      {/* Apple Pay / Google Pay Button */}\n      {paymentRequest && (\n        <div className=\"space-y-4\">\n          <PaymentRequestButtonElement \n            options={{ paymentRequest }}\n            className=\"w-full\"\n          />\n          <div className=\"relative\">\n            <div className=\"absolute inset-0 flex items-center\">\n              <Separator />\n            </div>\n            <div className=\"relative flex justify-center text-xs uppercase\">\n              <span className=\"bg-background px-2 text-muted-foreground\">\n                Or pay with card\n              </span>\n            </div>\n          </div>\n        </div>\n      )}\n      \n      <PaymentElement />\n      <div className=\"fixed bottom-0 left-0 right-0 bg-background border-t p-4 z-20\">\n        <div className=\"max-w-md mx-auto\">\n          <Button\n            type=\"submit\"\n            className=\"w-full h-12 text-base\"\n            disabled={!stripe || processing}\n            data-testid=\"button-pay\"\n          >\n            {processing ? \"Processing Payment...\" : \"Pay Now\"}\n          </Button>\n        </div>\n      </div>\n    </form>\n  );\n}\n\nexport default function Checkout() {\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  \n  // Get payment token from URL if present (for QR code payments)\n  const urlParams = new URLSearchParams(window.location.search);\n  const paymentToken = urlParams.get('token');\n  \n  const [clientSecret, setClientSecret] = useState(\"\");\n  const [paymentIntentId, setPaymentIntentId] = useState(\"\");\n  const [jobData, setJobData] = useState<any>(null);\n  const [feeBreakdown, setFeeBreakdown] = useState<any>(null);\n\n  useEffect(() => {\n    const stored = sessionStorage.getItem(\"pendingJob\");\n    if (!stored) {\n      setLocation(\"/customer\");\n      return;\n    }\n    \n    const data = JSON.parse(stored);\n    setJobData(data);\n\n    // Create PaymentIntent and get authoritative fees from backend\n    apiRequest(\"POST\", \"/api/create-payment-intent\", data)\n      .then((res) => res.json())\n      .then((responseData) => {\n        setClientSecret(responseData.clientSecret);\n        // Extract payment intent ID from client secret\n        const piId = responseData.clientSecret.split('_secret_')[0];\n        setPaymentIntentId(piId);\n        \n        // Set fee breakdown from backend response (includes platform fee tax!)\n        if (responseData.fees) {\n          setFeeBreakdown({\n            basePrice: responseData.fees.baseJobAmount,\n            taxAmount: responseData.fees.taxAmount,\n            platformFee: responseData.fees.platformFeeAmount,\n            tipAmount: responseData.fees.tipAmount,\n            totalAmount: responseData.fees.totalAmount,\n          });\n        }\n      })\n      .catch((error) => {\n        toast({\n          title: \"Error\",\n          description: \"Failed to initialize payment\",\n          variant: \"destructive\",\n        });\n        console.error(error);\n      });\n  }, [setLocation, toast]);\n\n  const handleTipUpdate = (fees: any) => {\n    setFeeBreakdown(fees);\n  };\n\n  if (!clientSecret || !jobData) {\n    return (\n      <div className=\"h-screen flex items-center justify-center\">\n        <div className=\"animate-spin w-8 h-8 border-4 border-primary border-t-transparent rounded-full\" aria-label=\"Loading\"/>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-background flex flex-col\">\n      {/* Header - Clean and minimal */}\n      <div className=\"border-b bg-background sticky top-0 z-10\">\n        <div className=\"max-w-md mx-auto px-4 py-3\">\n          <div className=\"flex items-center justify-between gap-3\">\n            <img src={logoUrl} alt=\"Washapp.ae\" className=\"h-10 w-auto\" data-testid=\"img-logo\" />\n            <div className=\"flex-1\">\n              <h1 className=\"text-base font-semibold\">Payment</h1>\n              <p className=\"text-xs text-muted-foreground\">\n                Review and complete\n              </p>\n            </div>\n            <Link href=\"/login\">\n              <Button \n                variant=\"ghost\" \n                size=\"sm\"\n                className=\"hover-elevate active-elevate-2\"\n                data-testid=\"button-login\"\n              >\n                <LogIn className=\"h-4 w-4 mr-1\" />\n                Login\n              </Button>\n            </Link>\n          </div>\n        </div>\n      </div>\n\n      {/* Content */}\n      <div className=\"flex-1 max-w-md mx-auto w-full px-4 py-6 pb-32\">\n        {/* Job Summary - Receipt style */}\n        <div className=\"mb-8\">\n          <h2 className=\"text-base font-semibold mb-4\">Booking Summary</h2>\n          <div className=\"border rounded-lg p-4 space-y-4\">\n            <div className=\"flex items-start gap-3\">\n              <Car className=\"h-5 w-5 mt-0.5 text-muted-foreground\" />\n              <div>\n                <p className=\"text-sm text-muted-foreground\">Car Plate</p>\n                <p className=\"font-medium\">{jobData.carPlateEmirate} {jobData.carPlateCode} {jobData.carPlateNumber}</p>\n              </div>\n            </div>\n\n            <div className=\"flex items-start gap-3\">\n              <MapPin className=\"h-5 w-5 mt-0.5 text-muted-foreground\" />\n              <div>\n                <p className=\"text-sm text-muted-foreground\">Location</p>\n                <p className=\"font-medium\">{jobData.locationAddress}</p>\n              </div>\n            </div>\n\n            {jobData.parkingNumber && (\n              <div className=\"flex items-start gap-3\">\n                <Building2 className=\"h-5 w-5 mt-0.5 text-muted-foreground\" />\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Parking</p>\n                  <p className=\"font-medium\">{jobData.parkingNumber}</p>\n                </div>\n              </div>\n            )}\n\n            <div className=\"flex items-start gap-3\">\n              <Phone className=\"h-5 w-5 mt-0.5 text-muted-foreground\" />\n              <div>\n                <p className=\"text-sm text-muted-foreground\">Phone</p>\n                <p className=\"font-medium\">{jobData.customerPhone}</p>\n              </div>\n            </div>\n\n            <Separator />\n\n            {/* Price Breakdown */}\n            <div className=\"space-y-2 pt-2\">\n              <div className=\"flex justify-between text-sm\">\n                <span className=\"text-muted-foreground\">Service Price</span>\n                <span>\n                  {feeBreakdown?.servicePrice?.toFixed(2) || \n                   (jobData.basePrice && jobData.platformFee \n                     ? ((parseFloat(jobData.basePrice) || 0) + (parseFloat(jobData.platformFee) || 0)).toFixed(2)\n                     : (parseFloat(jobData.price) || 0).toFixed(2))} AED\n                </span>\n              </div>\n              <div className=\"flex justify-between text-sm\">\n                <span className=\"text-muted-foreground\">Tax (5%)</span>\n                <span>{feeBreakdown?.taxAmount?.toFixed(2) || ((parseFloat(jobData.price) || 0) * 0.05).toFixed(2)} AED</span>\n              </div>\n              {feeBreakdown?.tipAmount > 0 && (\n                <div className=\"flex justify-between text-sm\">\n                  <span className=\"text-muted-foreground\">Tip for Cleaner</span>\n                  <span className=\"text-primary font-medium\">{feeBreakdown.tipAmount.toFixed(2)} AED</span>\n                </div>\n              )}\n              <Separator />\n              <div className=\"flex items-center justify-between pt-1\">\n                <div className=\"flex items-center gap-2\">\n                  <DollarSign className=\"h-5 w-5 text-muted-foreground\" />\n                  <span className=\"font-semibold\">Total</span>\n                </div>\n                <span className=\"text-2xl font-bold\">{feeBreakdown?.totalAmount?.toFixed(2) || jobData.price} AED</span>\n              </div>\n            </div>\n          </div>\n        </div>\n\n        {/* Payment Form */}\n        <div>\n          <h2 className=\"text-base font-semibold mb-4\">Payment Details</h2>\n          <div className=\"border rounded-lg p-4\">\n            <Elements stripe={stripePromise} options={{ clientSecret }}>\n              <CheckoutForm \n                paymentIntentId={paymentIntentId} \n                clientSecret={clientSecret}\n                jobData={jobData}\n                onTipUpdate={handleTipUpdate}\n                paymentToken={paymentToken}\n              />\n            </Elements>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":17355,"size_tokens":null},"client/src/components/ui/table.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Table = React.forwardRef<\n  HTMLTableElement,\n  React.HTMLAttributes<HTMLTableElement>\n>(({ className, ...props }, ref) => (\n  <div className=\"relative w-full overflow-auto\">\n    <table\n      ref={ref}\n      className={cn(\"w-full caption-bottom text-sm\", className)}\n      {...props}\n    />\n  </div>\n))\nTable.displayName = \"Table\"\n\nconst TableHeader = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <thead ref={ref} className={cn(\"[&_tr]:border-b\", className)} {...props} />\n))\nTableHeader.displayName = \"TableHeader\"\n\nconst TableBody = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tbody\n    ref={ref}\n    className={cn(\"[&_tr:last-child]:border-0\", className)}\n    {...props}\n  />\n))\nTableBody.displayName = \"TableBody\"\n\nconst TableFooter = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tfoot\n    ref={ref}\n    className={cn(\n      \"border-t bg-muted/50 font-medium [&>tr]:last:border-b-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableFooter.displayName = \"TableFooter\"\n\nconst TableRow = React.forwardRef<\n  HTMLTableRowElement,\n  React.HTMLAttributes<HTMLTableRowElement>\n>(({ className, ...props }, ref) => (\n  <tr\n    ref={ref}\n    className={cn(\n      \"border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nTableRow.displayName = \"TableRow\"\n\nconst TableHead = React.forwardRef<\n  HTMLTableCellElement,\n  React.ThHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <th\n    ref={ref}\n    className={cn(\n      \"h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableHead.displayName = \"TableHead\"\n\nconst TableCell = React.forwardRef<\n  HTMLTableCellElement,\n  React.TdHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <td\n    ref={ref}\n    className={cn(\"p-4 align-middle [&:has([role=checkbox])]:pr-0\", className)}\n    {...props}\n  />\n))\nTableCell.displayName = \"TableCell\"\n\nconst TableCaption = React.forwardRef<\n  HTMLTableCaptionElement,\n  React.HTMLAttributes<HTMLTableCaptionElement>\n>(({ className, ...props }, ref) => (\n  <caption\n    ref={ref}\n    className={cn(\"mt-4 text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nTableCaption.displayName = \"TableCaption\"\n\nexport {\n  Table,\n  TableHeader,\n  TableBody,\n  TableFooter,\n  TableHead,\n  TableRow,\n  TableCell,\n  TableCaption,\n}\n","path":null,"size_bytes":2765,"size_tokens":null},"client/src/components/ui/select.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SelectPrimitive from \"@radix-ui/react-select\"\nimport { Check, ChevronDown, ChevronUp } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Select = SelectPrimitive.Root\n\nconst SelectGroup = SelectPrimitive.Group\n\nconst SelectValue = SelectPrimitive.Value\n\nconst SelectTrigger = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex h-9 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <SelectPrimitive.Icon asChild>\n      <ChevronDown className=\"h-4 w-4 opacity-50\" />\n    </SelectPrimitive.Icon>\n  </SelectPrimitive.Trigger>\n))\nSelectTrigger.displayName = SelectPrimitive.Trigger.displayName\n\nconst SelectScrollUpButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollUpButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronUp className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollUpButton>\n))\nSelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName\n\nconst SelectScrollDownButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollDownButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronDown className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollDownButton>\n))\nSelectScrollDownButton.displayName =\n  SelectPrimitive.ScrollDownButton.displayName\n\nconst SelectContent = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>\n>(({ className, children, position = \"popper\", ...props }, ref) => (\n  <SelectPrimitive.Portal>\n    <SelectPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"relative z-50 max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]\",\n        position === \"popper\" &&\n          \"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1\",\n        className\n      )}\n      position={position}\n      {...props}\n    >\n      <SelectScrollUpButton />\n      <SelectPrimitive.Viewport\n        className={cn(\n          \"p-1\",\n          position === \"popper\" &&\n            \"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]\"\n        )}\n      >\n        {children}\n      </SelectPrimitive.Viewport>\n      <SelectScrollDownButton />\n    </SelectPrimitive.Content>\n  </SelectPrimitive.Portal>\n))\nSelectContent.displayName = SelectPrimitive.Content.displayName\n\nconst SelectLabel = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Label\n    ref={ref}\n    className={cn(\"py-1.5 pl-8 pr-2 text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nSelectLabel.displayName = SelectPrimitive.Label.displayName\n\nconst SelectItem = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <SelectPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </SelectPrimitive.ItemIndicator>\n    </span>\n\n    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>\n  </SelectPrimitive.Item>\n))\nSelectItem.displayName = SelectPrimitive.Item.displayName\n\nconst SelectSeparator = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nSelectSeparator.displayName = SelectPrimitive.Separator.displayName\n\nexport {\n  Select,\n  SelectGroup,\n  SelectValue,\n  SelectTrigger,\n  SelectContent,\n  SelectLabel,\n  SelectItem,\n  SelectSeparator,\n  SelectScrollUpButton,\n  SelectScrollDownButton,\n}\n","path":null,"size_bytes":5741,"size_tokens":null},"server/websocket.ts":{"content":"import { WebSocketServer, WebSocket } from \"ws\";\nimport type { Server } from \"http\";\nimport type { Job } from \"@shared/schema\";\n\ninterface WebSocketClient extends WebSocket {\n  isAlive: boolean;\n  userId?: number | string;\n  subscriptions?: Set<string>;\n}\n\nlet wss: WebSocketServer | null = null;\n\nexport function getWebSocketServer(): WebSocketServer | null {\n  return wss;\n}\n\nexport function setupWebSocket(server: Server) {\n  wss = new WebSocketServer({ server, path: \"/ws\" });\n\n  wss.on(\"connection\", (ws: WebSocketClient) => {\n    ws.isAlive = true;\n    ws.subscriptions = new Set();\n\n    ws.on(\"pong\", () => {\n      ws.isAlive = true;\n    });\n\n    ws.on(\"message\", (data: Buffer) => {\n      try {\n        const message = JSON.parse(data.toString());\n\n        // Handle subscription messages\n        if (message.type === \"subscribe\") {\n          // Subscribe to specific job updates\n          if (message.jobId) {\n            ws.subscriptions?.add(`job:${message.jobId}`);\n          }\n          // Subscribe to all jobs for a customer\n          if (message.customerId) {\n            ws.subscriptions?.add(`customer:${message.customerId}`);\n          }\n          // Subscribe to cleaner's jobs\n          if (message.cleanerId) {\n            ws.subscriptions?.add(`cleaner:${message.cleanerId}`);\n          }\n          // Subscribe to company's jobs\n          if (message.companyId) {\n            ws.subscriptions?.add(`company:${message.companyId}`);\n          }\n        }\n\n        // Handle unsubscribe messages\n        if (message.type === \"unsubscribe\") {\n          if (message.jobId) {\n            ws.subscriptions?.delete(`job:${message.jobId}`);\n          }\n          if (message.customerId) {\n            ws.subscriptions?.delete(`customer:${message.customerId}`);\n          }\n          if (message.cleanerId) {\n            ws.subscriptions?.delete(`cleaner:${message.cleanerId}`);\n          }\n          if (message.companyId) {\n            ws.subscriptions?.delete(`company:${message.companyId}`);\n          }\n        }\n      } catch (error) {\n        console.error(\"WebSocket message error:\", error);\n      }\n    });\n\n    ws.on(\"close\", () => {\n      ws.subscriptions?.clear();\n    });\n  });\n\n  // Heartbeat to detect broken connections\n  const interval = setInterval(() => {\n    if (!wss) return;\n    wss.clients.forEach((ws: WebSocket) => {\n      const client = ws as WebSocketClient;\n      if (!client.isAlive) {\n        return client.terminate();\n      }\n      client.isAlive = false;\n      client.ping();\n    });\n  }, 30000);\n\n  wss.on(\"close\", () => {\n    clearInterval(interval);\n  });\n\n  console.log(\"WebSocket server initialized\");\n}\n\n// Broadcast job updates to subscribed clients\nexport function broadcastJobUpdate(job: Job) {\n  if (!wss) {\n    console.log('[WS] broadcastJobUpdate: No WebSocket server');\n    return;\n  }\n\n  console.log('[WS] Broadcasting job update:', {\n    jobId: job.id,\n    status: job.status,\n    carPlate: job.carPlateNumber,\n    customerId: job.customerId,\n    cleanerId: job.cleanerId,\n    companyId: job.companyId,\n  });\n\n  const message = JSON.stringify({\n    type: \"job_update\",\n    job,\n  });\n\n  let sentCount = 0;\n  wss.clients.forEach((ws: WebSocket) => {\n    const client = ws as WebSocketClient;\n    \n    if (ws.readyState === WebSocket.OPEN) {\n      const subscriptions = Array.from(client.subscriptions || []);\n      console.log('[WS] Client subscriptions:', subscriptions);\n      \n      const shouldSend = \n        client.subscriptions?.has(`job:${job.id}`) ||\n        client.subscriptions?.has(`customer:${job.customerId}`) ||\n        client.subscriptions?.has(`cleaner:${job.cleanerId}`) ||\n        client.subscriptions?.has(`company:${job.companyId}`);\n\n      if (shouldSend) {\n        console.log('[WS] Sending job update to client');\n        ws.send(message);\n        sentCount++;\n      }\n    }\n  });\n  \n  console.log('[WS] Broadcast complete. Sent to', sentCount, 'clients');\n}\n\n// Broadcast cleaner status updates\nexport function broadcastCleanerUpdate(cleanerId: number, status: string) {\n  if (!wss) return;\n\n  const message = JSON.stringify({\n    type: \"cleaner_update\",\n    cleanerId,\n    status,\n  });\n\n  wss.clients.forEach((ws: WebSocket) => {\n    const client = ws as WebSocketClient;\n    \n    if (ws.readyState === WebSocket.OPEN) {\n      const shouldSend = client.subscriptions?.has(`cleaner:${cleanerId}`);\n      if (shouldSend) {\n        ws.send(message);\n      }\n    }\n  });\n}\n","path":null,"size_bytes":4457,"size_tokens":null},"server/auth.ts":{"content":"import passport from \"passport\";\nimport { Strategy as LocalStrategy } from \"passport-local\";\nimport bcrypt from \"bcryptjs\";\nimport { db } from \"./db\";\nimport { users } from \"@shared/schema\";\nimport { eq } from \"drizzle-orm\";\nimport type { User } from \"@shared/schema\";\n\n// Passport Local Strategy for email/password authentication\npassport.use(\n  new LocalStrategy(\n    {\n      usernameField: \"email\",\n      passwordField: \"password\",\n    },\n    async (email, password, done) => {\n      try {\n        // Normalize email to lowercase for case-insensitive matching\n        const normalizedEmail = email.toLowerCase();\n        \n        // Find user by email\n        const [user] = await db\n          .select()\n          .from(users)\n          .where(eq(users.email, normalizedEmail))\n          .limit(1);\n\n        if (!user) {\n          return done(null, false, { message: \"Invalid email or password\" });\n        }\n\n        // Verify password\n        const isValidPassword = await bcrypt.compare(password, user.passwordHash);\n        if (!isValidPassword) {\n          return done(null, false, { message: \"Invalid email or password\" });\n        }\n\n        // Return user without password hash\n        const { passwordHash, ...userWithoutPassword } = user;\n        return done(null, userWithoutPassword);\n      } catch (error) {\n        return done(error);\n      }\n    }\n  )\n);\n\n// Serialize user for session storage\npassport.serializeUser((user: any, done) => {\n  done(null, user.id);\n});\n\n// Deserialize user from session\npassport.deserializeUser(async (id: number, done) => {\n  try {\n    const [user] = await db\n      .select()\n      .from(users)\n      .where(eq(users.id, id))\n      .limit(1);\n\n    if (!user) {\n      return done(null, false);\n    }\n\n    // Return user without password hash\n    const { passwordHash, ...userWithoutPassword } = user;\n    done(null, userWithoutPassword);\n  } catch (error) {\n    done(error);\n  }\n});\n\nexport default passport;\n","path":null,"size_bytes":1958,"size_tokens":null},"server/middleware.ts":{"content":"import { Request, Response, NextFunction } from \"express\";\nimport { UserRole } from \"@shared/schema\";\n\n// Extend Express Request type to include user\ndeclare global {\n  namespace Express {\n    interface User {\n      id: number;\n      email: string;\n      displayName: string;\n      role: string;\n      photoURL?: string | null;\n      phoneNumber?: string | null;\n      companyId?: number | null;\n    }\n  }\n}\n\n// Middleware to ensure user is authenticated\nexport function requireAuth(req: Request, res: Response, next: NextFunction) {\n  if (req.isAuthenticated()) {\n    return next();\n  }\n  res.status(401).json({ message: \"Authentication required\" });\n}\n\n// Middleware to require specific role\nexport function requireRole(...roles: UserRole[]) {\n  return (req: Request, res: Response, next: NextFunction) => {\n    if (!req.isAuthenticated()) {\n      return res.status(401).json({ message: \"Authentication required\" });\n    }\n\n    const userRole = req.user?.role as UserRole;\n    if (roles.includes(userRole)) {\n      return next();\n    }\n\n    res.status(403).json({ message: \"Insufficient permissions\" });\n  };\n}\n\n// Middleware for routes that allow anonymous customers OR authenticated users\nexport function optionalAuth(req: Request, res: Response, next: NextFunction) {\n  // Allow through regardless of authentication status\n  next();\n}\n\n// Middleware to check if cleaner is active (must run after requireRole)\nexport function requireActiveCleaner(storage: any) {\n  return async (req: Request, res: Response, next: NextFunction) => {\n    if (!req.isAuthenticated()) {\n      return res.status(401).json({ message: \"Authentication required\" });\n    }\n\n    const userRole = req.user?.role as UserRole;\n    \n    // Only check if user is a cleaner\n    if (userRole === UserRole.CLEANER) {\n      try {\n        const cleaner = await storage.getCleanerByUserId(req.user.id);\n        \n        if (!cleaner) {\n          return res.status(404).json({ message: \"Cleaner profile not found\" });\n        }\n        \n        if (cleaner.isActive === 0) {\n          // Logout the user\n          req.logout((err) => {\n            if (err) console.error('Logout error:', err);\n          });\n          return res.status(403).json({ message: \"Your account has been deactivated. Please contact your company administrator.\" });\n        }\n        \n        return next();\n      } catch (error: any) {\n        return res.status(500).json({ message: error.message });\n      }\n    }\n    \n    // Not a cleaner, allow through\n    next();\n  };\n}\n","path":null,"size_bytes":2517,"size_tokens":null},"server/create-admin.ts":{"content":"import { db } from \"./db\";\nimport { users } from \"@shared/schema\";\nimport { eq } from \"drizzle-orm\";\nimport bcrypt from \"bcryptjs\";\n\nasync function createAdmin() {\n  const email = \"omer.eldirdieri@gmail.com\";\n  const password = \"Network#123\";\n  const displayName = \"Omer Eldirdieri\";\n  \n  // Hash password\n  const hashedPassword = await bcrypt.hash(password, 10);\n  \n  // Check if user already exists\n  const existing = await db.select().from(users).where(eq(users.email, email)).limit(1);\n  \n  if (existing.length > 0) {\n    console.log(\"Admin user already exists\");\n    process.exit(0);\n  }\n  \n  // Create admin user\n  await db.insert(users).values({\n    email,\n    passwordHash: hashedPassword,\n    displayName,\n    role: \"admin\",\n  });\n  \n  console.log(\"Admin user created successfully!\");\n  console.log(\"Email:\", email);\n  console.log(\"Password:\", password);\n  \n  process.exit(0);\n}\n\ncreateAdmin().catch((error) => {\n  console.error(\"Failed to create admin:\", error);\n  process.exit(1);\n});\n","path":null,"size_bytes":996,"size_tokens":null},"client/src/components/location-picker.tsx":{"content":"import { useState, useCallback, useEffect } from \"react\";\nimport { MapContainer, TileLayer, Marker, useMapEvents, useMap } from \"react-leaflet\";\nimport L from \"leaflet\";\nimport \"leaflet/dist/leaflet.css\";\nimport { Card } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Label } from \"@/components/ui/label\";\nimport { MapPin, Loader2 } from \"lucide-react\";\n\n// Fix default marker icon issue with Leaflet + Webpack/Vite\ndelete (L.Icon.Default.prototype as any)._getIconUrl;\nL.Icon.Default.mergeOptions({\n  iconRetinaUrl: \"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-2x.png\",\n  iconUrl: \"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png\",\n  shadowUrl: \"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png\",\n});\n\ninterface LocationPickerProps {\n  onLocationSelect: (location: {\n    address: string;\n    latitude: number;\n    longitude: number;\n  }) => void;\n  initialPosition?: [number, number];\n}\n\nfunction MapClickHandler({ onLocationClick }: { onLocationClick: (lat: number, lng: number) => void }) {\n  useMapEvents({\n    click: (e) => {\n      onLocationClick(e.latlng.lat, e.latlng.lng);\n    },\n  });\n  return null;\n}\n\n// Component to update map view when position changes\nfunction MapViewController({ position }: { position: [number, number] }) {\n  const map = useMap();\n  \n  useEffect(() => {\n    map.setView(position, map.getZoom());\n  }, [map, position]);\n  \n  return null;\n}\n\nexport default function LocationPicker({ onLocationSelect, initialPosition = [25.270360, 55.477580] }: LocationPickerProps) {\n  const [position, setPosition] = useState<[number, number]>(initialPosition);\n  const [address, setAddress] = useState<string>(\"\");\n  const [loading, setLoading] = useState(false);\n\n  const reverseGeocode = useCallback(async (lat: number, lng: number) => {\n    setLoading(true);\n    try {\n      // Use Nominatim (OpenStreetMap's free geocoding service)\n      const response = await fetch(\n        `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&addressdetails=1`,\n        {\n          headers: {\n            \"User-Agent\": \"CarWashPro/1.0\",\n          },\n        }\n      );\n      \n      if (response.ok) {\n        const data = await response.json();\n        const formattedAddress = data.display_name || `${lat.toFixed(6)}, ${lng.toFixed(6)}`;\n        setAddress(formattedAddress);\n        return formattedAddress;\n      }\n    } catch (error) {\n      console.error(\"Geocoding error:\", error);\n    } finally {\n      setLoading(false);\n    }\n    \n    // Fallback: use coordinates as address if geocoding fails\n    const fallbackAddress = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;\n    setAddress(fallbackAddress);\n    return fallbackAddress;\n  }, []);\n\n  const handleMapClick = useCallback(async (lat: number, lng: number) => {\n    setPosition([lat, lng]);\n    await reverseGeocode(lat, lng);\n  }, [reverseGeocode]);\n\n  const handleConfirm = () => {\n    if (address) {\n      onLocationSelect({\n        address,\n        latitude: position[0],\n        longitude: position[1],\n      });\n    }\n  };\n\n  // Get user's current location\n  const handleUseCurrentLocation = useCallback(() => {\n    setLoading(true);\n    if (navigator.geolocation) {\n      navigator.geolocation.getCurrentPosition(\n        async (location) => {\n          const lat = location.coords.latitude;\n          const lng = location.coords.longitude;\n          setPosition([lat, lng]);\n          await reverseGeocode(lat, lng);\n        },\n        (error) => {\n          console.error(\"Geolocation error:\", error);\n          setLoading(false);\n        }\n      );\n    } else {\n      setLoading(false);\n      alert(\"Geolocation is not supported by your browser\");\n    }\n  }, [reverseGeocode]);\n\n  // Initialize location on mount - always use the provided position\n  useEffect(() => {\n    // Immediately reverse geocode the initial position (default or provided)\n    // This ensures the component works in test environments without geolocation\n    // Users can still click \"Current\" button to update to their actual location\n    reverseGeocode(position[0], position[1]);\n  }, []); // Empty deps - only run once on mount\n\n  return (\n    <div className=\"border rounded-lg p-3 space-y-3\">\n      <div className=\"flex items-center justify-between\">\n        <Label className=\"flex items-center gap-2 text-sm\">\n          <MapPin className=\"h-4 w-4\" />\n          {loading && !address ? \"Getting location...\" : \"Tap map to change\"}\n        </Label>\n        <Button\n          type=\"button\"\n          variant=\"ghost\"\n          size=\"sm\"\n          onClick={handleUseCurrentLocation}\n          disabled={loading}\n          data-testid=\"button-use-current-location\"\n          className=\"h-8 text-xs\"\n        >\n          {loading ? (\n            <Loader2 className=\"h-3 w-3 animate-spin\" />\n          ) : (\n            <>\n              <MapPin className=\"h-3 w-3 mr-1\" />\n              Current\n            </>\n          )}\n        </Button>\n      </div>\n\n      <div \n        className=\"relative w-full h-[180px] rounded-md overflow-hidden border\"\n        data-testid=\"map-container\"\n      >\n        <MapContainer\n          center={position}\n          zoom={15}\n          style={{ height: \"100%\", width: \"100%\" }}\n          scrollWheelZoom={true}\n        >\n          <TileLayer\n            attribution='&copy; <a href=\"https://www.openstreetmap.org/copyright\">OpenStreetMap</a> contributors'\n            url=\"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png\"\n          />\n          <Marker position={position} />\n          <MapClickHandler onLocationClick={handleMapClick} />\n          <MapViewController position={position} />\n        </MapContainer>\n      </div>\n\n      <Button\n        type=\"button\"\n        className=\"w-full h-9 text-sm\"\n        onClick={handleConfirm}\n        disabled={!address || loading}\n        data-testid=\"button-confirm-location\"\n      >\n        Confirm Location\n      </Button>\n    </div>\n  );\n}\n","path":null,"size_bytes":6020,"size_tokens":null},"client/src/pages/register-admin.tsx":{"content":"import { useState } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Button } from \"@/components/ui/button\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { UserRole } from \"@shared/schema\";\nimport { Loader2 } from \"lucide-react\";\nimport logoUrl from \"@assets/IMG_2508_1762619079711.png\";\n\nexport default function RegisterAdminPage() {\n  const { registerAdmin } = useAuth();\n  const [, setLocation] = useLocation();\n  const [formData, setFormData] = useState({\n    email: \"\",\n    password: \"\",\n    displayName: \"\",\n  });\n  const [submitting, setSubmitting] = useState(false);\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    setSubmitting(true);\n    \n    try {\n      await registerAdmin(formData);\n      setLocation(\"/admin\");\n    } catch (error) {\n      // Error shown by toast in auth context\n    } finally {\n      setSubmitting(false);\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-background flex items-center justify-center p-4\">\n      <Card className=\"w-full max-w-md\">\n        <CardHeader className=\"text-center space-y-2\">\n          <div className=\"flex items-center justify-center mb-4\">\n            <img src={logoUrl} alt=\"Washapp.ae\" className=\"h-24 w-auto\" data-testid=\"img-logo\" />\n          </div>\n          <CardTitle className=\"text-xl font-bold\">Platform Admin</CardTitle>\n          <CardDescription className=\"text-base\">\n            Create platform administrator account\n          </CardDescription>\n        </CardHeader>\n        <form onSubmit={handleSubmit}>\n          <CardContent className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"displayName\">Full Name</Label>\n              <Input\n                id=\"displayName\"\n                placeholder=\"Admin Name\"\n                value={formData.displayName}\n                onChange={(e) => setFormData({ ...formData, displayName: e.target.value })}\n                required\n                data-testid=\"input-name\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"email\">Email</Label>\n              <Input\n                id=\"email\"\n                type=\"email\"\n                placeholder=\"admin@example.com\"\n                value={formData.email}\n                onChange={(e) => setFormData({ ...formData, email: e.target.value })}\n                required\n                data-testid=\"input-email\"\n              />\n            </div>\n            \n            <div className=\"space-y-2\">\n              <Label htmlFor=\"password\">Password</Label>\n              <Input\n                id=\"password\"\n                type=\"password\"\n                placeholder=\"••••••••\"\n                value={formData.password}\n                onChange={(e) => setFormData({ ...formData, password: e.target.value })}\n                required\n                minLength={6}\n                data-testid=\"input-password\"\n              />\n            </div>\n          </CardContent>\n          \n          <CardFooter className=\"flex flex-col gap-4\">\n            <Button\n              type=\"submit\"\n              className=\"w-full\"\n              size=\"lg\"\n              disabled={submitting}\n              data-testid=\"button-register\"\n            >\n              {submitting ? (\n                <>\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                  Creating Admin...\n                </>\n              ) : (\n                \"Create Admin Account\"\n              )}\n            </Button>\n            \n            <div className=\"text-center text-sm\">\n              <span className=\"text-muted-foreground\">Already have an account? </span>\n              <Button\n                type=\"button\"\n                variant=\"ghost\"\n                className=\"p-0 h-auto\"\n                onClick={() => setLocation(\"/login\")}\n                data-testid=\"link-login\"\n              >\n                Sign In\n              </Button>\n            </div>\n          </CardFooter>\n        </form>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":4276,"size_tokens":null},"server/db.ts":{"content":"import { Pool, neonConfig } from '@neondatabase/serverless';\nimport { drizzle } from 'drizzle-orm/neon-serverless';\nimport ws from \"ws\";\nimport * as schema from \"@shared/schema\";\n\nneonConfig.webSocketConstructor = ws;\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\n    \"DATABASE_URL must be set. Did you forget to provision a database?\",\n  );\n}\n\nexport const pool = new Pool({ connectionString: process.env.DATABASE_URL });\nexport const db = drizzle({ client: pool, schema });\n","path":null,"size_bytes":483,"size_tokens":null},"client/src/pages/customer-track.tsx":{"content":"import { useEffect, useState } from \"react\";\nimport { useRoute, useLocation } from \"wouter\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Car, MapPin, Phone, Building2, Clock, Star, ChevronLeft, AlertCircle, Bell, BellOff, User, Timer, CheckCircle2, Navigation, MessageSquare, Banknote, Download } from \"lucide-react\";\nimport { Job, JobStatus, Cleaner, Company } from \"@shared/schema\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useWebSocket } from \"@/hooks/use-websocket\";\nimport { usePushNotifications } from \"@/hooks/use-push-notifications\";\nimport logoUrl from \"@assets/IMG_2508_1762619079711.png\";\nimport { motion } from \"framer-motion\";\nimport { PaginationControls } from \"@/components/PaginationControls\";\n\n// UAE Emirates list\nconst UAE_EMIRATES = [\n  \"Abu Dhabi\",\n  \"Dubai\",\n  \"Sharjah\",\n  \"Ajman\",\n  \"Umm Al Quwain\",\n  \"Ras Al Khaimah\",\n  \"Fujairah\"\n];\n\n// Plate codes: A-Z, AA-MM, 1-50\nconst PLATE_CODES = [\n  // Single letters A-Z\n  ...Array.from({ length: 26 }, (_, i) => String.fromCharCode(65 + i)),\n  // Double letters AA-MM\n  ...Array.from({ length: 13 }, (_, i) => {\n    const char = String.fromCharCode(65 + i);\n    return char + char;\n  }),\n  // Numbers 1-50\n  ...Array.from({ length: 50 }, (_, i) => (i + 1).toString())\n];\n\n// Extended Cleaner type with user information (phone number, name, email)\ntype CleanerWithContact = Cleaner & {\n  phoneNumber?: string;\n  displayName?: string;\n  email?: string;\n};\n\nexport default function CustomerTrack() {\n  const [, params] = useRoute(\"/customer/track/:plateNumber\");\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  const [selectedJob, setSelectedJob] = useState<Job | null>(null);\n  const [rating, setRating] = useState(0);\n  const [review, setReview] = useState(\"\");\n  const [currentTime, setCurrentTime] = useState(new Date());\n  \n  // Search method selection: \"plate\" or \"phone\"\n  const [searchMethod, setSearchMethod] = useState<\"plate\" | \"phone\">(\"plate\");\n  \n  // Three-field car plate state\n  const [plateEmirate, setPlateEmirate] = useState(\"\");\n  const [plateCode, setPlateCode] = useState(\"\");\n  const [plateNumber, setPlateNumber] = useState(\"\");\n  \n  // Phone number state\n  const [phoneNumber, setPhoneNumber] = useState(\"\");\n\n  // Pagination state\n  const [page, setPage] = useState(1);\n  const pageSize = 20;\n\n  const fullPlateNumber = params?.plateNumber || \"\";\n\n  // Sync search method with URL on mount and when URL changes\n  useEffect(() => {\n    if (fullPlateNumber.startsWith('phone:')) {\n      setSearchMethod('phone');\n      const phone = fullPlateNumber.substring(6);\n      setPhoneNumber(decodeURIComponent(phone));\n    } else if (fullPlateNumber) {\n      setSearchMethod('plate');\n      // Optionally parse and set plate fields here if needed\n    }\n  }, [fullPlateNumber]);\n\n  const handleTrackSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (searchMethod === \"phone\") {\n      if (!phoneNumber.trim()) {\n        toast({\n          title: \"Phone Number Required\",\n          description: \"Please enter your phone number\",\n          variant: \"destructive\",\n        });\n        return;\n      }\n      // Use phone number in URL\n      setLocation(`/customer/track/phone:${encodeURIComponent(phoneNumber)}`);\n    } else {\n      if (!plateEmirate || !plateCode || !plateNumber.trim()) {\n        toast({\n          title: \"Car Plate Required\",\n          description: \"Please complete all car plate fields (emirate, code, and number)\",\n          variant: \"destructive\",\n        });\n        return;\n      }\n      const combinedPlate = `${plateEmirate} ${plateCode} ${plateNumber.trim().toUpperCase()}`;\n      setLocation(`/customer/track/${encodeURIComponent(combinedPlate)}`);\n    }\n  };\n\n  // Determine if we're searching by phone\n  const isPhoneSearch = fullPlateNumber.startsWith('phone:');\n  const searchPhone = isPhoneSearch ? fullPlateNumber.substring(6) : '';\n  const searchPlate = isPhoneSearch ? '' : fullPlateNumber;\n\n  // Reset page to 1 when switching between different tracking modes\n  useEffect(() => {\n    setPage(1);\n  }, [fullPlateNumber]);\n\n  const { data: jobsResponse, isLoading } = useQuery<{data: Job[], total: number}>({\n    queryKey: [\"/api/jobs/track\", fullPlateNumber, page],\n    queryFn: async () => {\n      if (isPhoneSearch) {\n        // Fetch by phone number (searchPhone is already decoded from URL)\n        const res = await fetch(`/api/jobs/track-by-phone/${searchPhone}?page=${page}&pageSize=${pageSize}`, {\n          cache: 'no-store',\n          headers: {\n            'Cache-Control': 'no-cache',\n            'Pragma': 'no-cache',\n          },\n        });\n        if (!res.ok) throw new Error(\"Failed to fetch jobs\");\n        return res.json();\n      } else {\n        // Fetch by plate number\n        const res = await fetch(`/api/jobs/track/${searchPlate}?page=${page}&pageSize=${pageSize}`, {\n          cache: 'no-store',\n          headers: {\n            'Cache-Control': 'no-cache',\n            'Pragma': 'no-cache',\n          },\n        });\n        if (!res.ok) throw new Error(\"Failed to fetch jobs\");\n        return res.json();\n      }\n    },\n    enabled: !!fullPlateNumber,\n    staleTime: 0,\n    gcTime: 0,\n    refetchOnMount: true,\n    refetchOnWindowFocus: true,\n    refetchOnReconnect: true,\n  });\n\n  const jobs = jobsResponse?.data || [];\n  const totalJobs = jobsResponse?.total || 0;\n  const totalPages = Math.ceil(totalJobs / pageSize);\n\n  useEffect(() => {\n    const timer = setInterval(() => {\n      setCurrentTime(new Date());\n    }, 1000);\n    return () => clearInterval(timer);\n  }, []);\n\n  const { permission, isSubscribed, soundEnabled, isLoading: pushLoading, isSupported, subscribe, unsubscribe, toggleSound } = usePushNotifications({\n    plateNumber: fullPlateNumber,\n  });\n\n  const { subscribe: wsSubscribe, isConnected } = useWebSocket({\n    onMessage: (data) => {\n      if (data.type === 'job_update' && data.job) {\n        queryClient.invalidateQueries({ queryKey: [\"/api/jobs/track\", fullPlateNumber] });\n        \n        const statusMessages: Record<JobStatus, string> = {\n          [JobStatus.ASSIGNED]: \"A cleaner has been assigned to your job!\",\n          [JobStatus.IN_PROGRESS]: \"Your car wash is now in progress!\",\n          [JobStatus.COMPLETED]: \"Your car wash is complete!\",\n          [JobStatus.CANCELLED]: \"Your job has been cancelled\",\n          [JobStatus.REFUNDED]: \"Your payment has been refunded\",\n          [JobStatus.PAID]: \"Payment confirmed\",\n          [JobStatus.PENDING_PAYMENT]: \"Waiting for payment\",\n        };\n\n        if (data.job.carPlateNumber === fullPlateNumber && statusMessages[data.job.status as JobStatus]) {\n          toast({\n            title: \"Job Update\",\n            description: statusMessages[data.job.status as JobStatus],\n          });\n        }\n      }\n    },\n  });\n\n  useEffect(() => {\n    if (jobs && jobs.length > 0 && isConnected) {\n      jobs.forEach(job => {\n        wsSubscribe({ jobId: job.id });\n      });\n    }\n  }, [jobs, wsSubscribe, isConnected]);\n\n  const submitRating = useMutation({\n    mutationFn: async () => {\n      if (!selectedJob) return;\n      await apiRequest(\"POST\", `/api/jobs/${selectedJob.id}/rate`, {\n        rating,\n        review: review.trim() || undefined,\n      });\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Rating Submitted\",\n        description: \"Thank you for your feedback!\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/jobs/track\", fullPlateNumber] });\n      setSelectedJob(null);\n      setRating(0);\n      setReview(\"\");\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to submit rating\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Split jobs into active and history\n  // Active: Only show jobs that have been paid and are in progress\n  const activeJobs = jobs?.filter(\n    (job) => job.status === JobStatus.PAID || \n             job.status === JobStatus.ASSIGNED || \n             job.status === JobStatus.IN_PROGRESS\n  );\n\n  // History: Show all completed, cancelled, refunded jobs\n  // Note: PENDING_PAYMENT jobs are excluded entirely (incomplete bookings)\n  const historyJobs = jobs?.filter((job) => \n    job.status === JobStatus.COMPLETED || \n    job.status === JobStatus.CANCELLED || \n    job.status === JobStatus.REFUNDED\n  );\n\n  // Get the most recent active job to show in \"Active Wash\" section\n  const currentJob = activeJobs?.[0];\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-b from-primary/5 to-background flex flex-col\">\n      {/* Header with gradient */}\n      <div className=\"bg-gradient-to-r from-primary to-primary/80 sticky top-0 z-10 shadow-lg\">\n        <div className=\"max-w-md mx-auto px-4 py-4\">\n          <div className=\"flex items-center justify-between gap-3\">\n            <div className=\"flex items-center gap-3 flex-1\">\n              <img src={logoUrl} alt=\"Washapp.ae\" className=\"h-12 w-auto\" data-testid=\"img-logo\" />\n              <div>\n                <h1 className=\"text-white text-lg font-bold\">{fullPlateNumber || \"Track Your Wash\"}</h1>\n                <p className=\"text-white/90 text-xs\">\n                  {fullPlateNumber ? \"Track your car wash\" : \"Enter your plate details\"}\n                </p>\n              </div>\n            </div>\n            <Button \n              variant=\"ghost\" \n              size=\"sm\"\n              onClick={() => setLocation(\"/\")}\n              className=\"text-white hover:bg-white/20\"\n              data-testid=\"button-back\"\n            >\n              <ChevronLeft className=\"h-4 w-4 mr-1\" />\n              Back\n            </Button>\n          </div>\n        </div>\n      </div>\n\n      {/* Content */}\n      <div className=\"flex-1 max-w-md mx-auto w-full px-4 py-6 pb-20\">\n\n        {/* Plate Number Input Form - shown when no plate number in URL */}\n        {!fullPlateNumber && (\n          <motion.div\n            initial={{ opacity: 0, y: 20 }}\n            animate={{ opacity: 1, y: 0 }}\n            className=\"space-y-6\"\n          >\n            <Card className=\"border-primary/20\">\n              <CardHeader>\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"h-12 w-12 rounded-full bg-gradient-to-br from-primary to-primary/80 flex items-center justify-center shadow-lg shadow-primary/30\">\n                    <Car className=\"h-6 w-6 text-white\" />\n                  </div>\n                  <div>\n                    <CardTitle className=\"text-xl\">Track Your Wash</CardTitle>\n                    <CardDescription>Search by phone number or car plate</CardDescription>\n                  </div>\n                </div>\n              </CardHeader>\n              <CardContent>\n                <form onSubmit={handleTrackSubmit} className=\"space-y-5\">\n                  {/* Search Method Toggle */}\n                  <div className=\"flex gap-2 p-1 bg-muted rounded-lg\">\n                    <Button\n                      type=\"button\"\n                      variant={searchMethod === \"phone\" ? \"default\" : \"ghost\"}\n                      className=\"flex-1 h-10\"\n                      onClick={() => setSearchMethod(\"phone\")}\n                      data-testid=\"button-search-phone\"\n                    >\n                      <Phone className=\"h-4 w-4 mr-2\" />\n                      Phone Number\n                    </Button>\n                    <Button\n                      type=\"button\"\n                      variant={searchMethod === \"plate\" ? \"default\" : \"ghost\"}\n                      className=\"flex-1 h-10\"\n                      onClick={() => setSearchMethod(\"plate\")}\n                      data-testid=\"button-search-plate\"\n                    >\n                      <Car className=\"h-4 w-4 mr-2\" />\n                      Car Plate\n                    </Button>\n                  </div>\n\n                  {searchMethod === \"phone\" ? (\n                    <div>\n                      <Label htmlFor=\"phoneNumber\" className=\"text-base font-medium mb-2 block\">\n                        Phone Number\n                      </Label>\n                      <div className=\"relative\">\n                        <Phone className=\"absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-muted-foreground\" />\n                        <Input\n                          id=\"phoneNumber\"\n                          data-testid=\"input-phone-number\"\n                          type=\"tel\"\n                          placeholder=\"Enter your phone number\"\n                          value={phoneNumber}\n                          onChange={(e) => setPhoneNumber(e.target.value)}\n                          className=\"h-12 text-lg pl-11\"\n                          autoFocus\n                        />\n                      </div>\n                      <p className=\"text-sm text-muted-foreground mt-2\">\n                        Enter the phone number you used when booking\n                      </p>\n                    </div>\n                  ) : (\n                    <div>\n                      <Label className=\"text-base font-medium mb-3 block\">\n                        Car Plate Details\n                      </Label>\n                      <div className=\"grid grid-cols-3 gap-3\">\n                        <div>\n                          <Label htmlFor=\"plateEmirate\" className=\"text-sm mb-1.5 block text-muted-foreground\">\n                            Emirate\n                          </Label>\n                          <Select value={plateEmirate} onValueChange={setPlateEmirate}>\n                            <SelectTrigger id=\"plateEmirate\" className=\"h-12\" data-testid=\"select-emirate\">\n                              <SelectValue placeholder=\"Select\" />\n                            </SelectTrigger>\n                            <SelectContent>\n                              {UAE_EMIRATES.map((emirate) => (\n                                <SelectItem key={emirate} value={emirate}>\n                                  {emirate}\n                                </SelectItem>\n                              ))}\n                            </SelectContent>\n                          </Select>\n                        </div>\n                        \n                        <div>\n                          <Label htmlFor=\"plateCode\" className=\"text-sm mb-1.5 block text-muted-foreground\">\n                            Code\n                          </Label>\n                          <Select value={plateCode} onValueChange={setPlateCode}>\n                            <SelectTrigger id=\"plateCode\" className=\"h-12\" data-testid=\"select-code\">\n                              <SelectValue placeholder=\"A-Z\" />\n                            </SelectTrigger>\n                            <SelectContent>\n                              {PLATE_CODES.map((code) => (\n                                <SelectItem key={code} value={code}>\n                                  {code}\n                                </SelectItem>\n                              ))}\n                            </SelectContent>\n                          </Select>\n                        </div>\n                        \n                        <div>\n                          <Label htmlFor=\"plateNumber\" className=\"text-sm mb-1.5 block text-muted-foreground\">\n                            Number\n                          </Label>\n                          <Input\n                            id=\"plateNumber\"\n                            data-testid=\"input-plate-number\"\n                            placeholder=\"12345\"\n                            value={plateNumber}\n                            onChange={(e) => setPlateNumber(e.target.value)}\n                            className=\"h-12 text-lg\"\n                          />\n                        </div>\n                      </div>\n                    </div>\n                  )}\n                  <Button\n                    type=\"submit\"\n                    className=\"w-full bg-primary\"\n                    size=\"lg\"\n                    data-testid=\"button-track-submit\"\n                  >\n                    Track My Wash\n                  </Button>\n                </form>\n              </CardContent>\n            </Card>\n\n            <Card className=\"bg-muted/50 border-muted\">\n              <CardContent className=\"pt-6\">\n                <div className=\"space-y-3\">\n                  <div className=\"flex items-start gap-3\">\n                    <CheckCircle2 className=\"h-5 w-5 text-primary shrink-0 mt-0.5\" />\n                    <div>\n                      <p className=\"font-medium\">Real-time updates</p>\n                      <p className=\"text-sm text-muted-foreground\">Track your wash from booking to completion</p>\n                    </div>\n                  </div>\n                  <div className=\"flex items-start gap-3\">\n                    <Bell className=\"h-5 w-5 text-primary shrink-0 mt-0.5\" />\n                    <div>\n                      <p className=\"font-medium\">Push notifications</p>\n                      <p className=\"text-sm text-muted-foreground\">Get notified when your cleaner is on the way</p>\n                    </div>\n                  </div>\n                  <div className=\"flex items-start gap-3\">\n                    <User className=\"h-5 w-5 text-primary shrink-0 mt-0.5\" />\n                    <div>\n                      <p className=\"font-medium\">Cleaner details</p>\n                      <p className=\"text-sm text-muted-foreground\">View your assigned cleaner's profile and contact info</p>\n                    </div>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          </motion.div>\n        )}\n\n        {/* Push Notification Banner */}\n        {isSupported && !isSubscribed && permission === 'default' && jobs && jobs.length > 0 && (\n          <motion.div\n            initial={{ opacity: 0, y: -20 }}\n            animate={{ opacity: 1, y: 0 }}\n            className=\"mb-4\"\n          >\n            <Card className=\"border-primary/30 bg-gradient-to-r from-primary/10 to-primary/5 overflow-hidden\">\n              <CardContent className=\"p-4\">\n                <div className=\"flex items-start gap-3\">\n                  <div className=\"h-10 w-10 rounded-full bg-primary/20 flex items-center justify-center shrink-0\">\n                    <Bell className=\"h-5 w-5 text-primary\" />\n                  </div>\n                  <div className=\"flex-1\">\n                    <p className=\"font-semibold text-sm\">Get instant updates</p>\n                    <p className=\"text-xs text-muted-foreground mt-1\">\n                      Enable notifications for real-time job alerts\n                    </p>\n                  </div>\n                  <Button\n                    size=\"sm\"\n                    onClick={subscribe}\n                    disabled={pushLoading}\n                    className=\"bg-primary hover:bg-primary/90\"\n                    data-testid=\"button-enable-notifications\"\n                  >\n                    {pushLoading ? 'Enabling...' : 'Enable'}\n                  </Button>\n                </div>\n              </CardContent>\n            </Card>\n          </motion.div>\n        )}\n\n        {/* Notification Status */}\n        {isSubscribed && (\n          <motion.div\n            initial={{ opacity: 0, y: -20 }}\n            animate={{ opacity: 1, y: 0 }}\n            className=\"mb-4\"\n          >\n            <Card className=\"border-green-500/30 bg-gradient-to-r from-green-50 to-green-50/50 dark:from-green-950/20 dark:to-green-950/10\">\n              <CardContent className=\"p-3\">\n                <div className=\"space-y-3\">\n                  <div className=\"flex items-center justify-between gap-3\">\n                    <div className=\"flex items-center gap-2\">\n                      <Bell className=\"h-4 w-4 text-green-600 dark:text-green-400\" />\n                      <p className=\"text-sm font-medium text-green-700 dark:text-green-300\">Notifications enabled</p>\n                    </div>\n                    <Button\n                      size=\"sm\"\n                      variant=\"ghost\"\n                      onClick={unsubscribe}\n                      disabled={pushLoading}\n                      data-testid=\"button-disable-notifications\"\n                    >\n                      <BellOff className=\"h-4 w-4\" />\n                    </Button>\n                  </div>\n                  <div className=\"flex items-center justify-between gap-3 pt-2 border-t border-green-500/20\">\n                    <span className=\"text-sm\">Sound</span>\n                    <Button\n                      size=\"sm\"\n                      variant={soundEnabled ? \"default\" : \"outline\"}\n                      onClick={toggleSound}\n                      disabled={pushLoading}\n                      data-testid=\"button-toggle-sound\"\n                    >\n                      {soundEnabled ? 'On' : 'Off'}\n                    </Button>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          </motion.div>\n        )}\n\n        {isLoading && (\n          <div className=\"space-y-4\">\n            {[1, 2].map((i) => (\n              <Card key={i}>\n                <CardHeader>\n                  <Skeleton className=\"h-6 w-3/4\" />\n                  <Skeleton className=\"h-4 w-1/2 mt-2\" />\n                </CardHeader>\n                <CardContent>\n                  <Skeleton className=\"h-32 w-full\" />\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        )}\n        \n        {!isLoading && fullPlateNumber && (!jobs || jobs.length === 0) && (\n          <motion.div\n            initial={{ opacity: 0, scale: 0.95 }}\n            animate={{ opacity: 1, scale: 1 }}\n          >\n            <Card>\n              <CardContent className=\"pt-6 text-center\">\n                <div className=\"h-20 w-20 rounded-full bg-primary/10 flex items-center justify-center mx-auto mb-4\">\n                  <Car className=\"h-10 w-10 text-primary\" />\n                </div>\n                <h3 className=\"text-lg font-semibold mb-2\">No washes yet</h3>\n                <p className=\"text-muted-foreground text-sm mb-4\">\n                  No car wash history found for <strong>{fullPlateNumber}</strong>\n                </p>\n                <Button\n                  onClick={() => setLocation(\"/\")}\n                  className=\"bg-primary\"\n                  data-testid=\"button-book-wash\"\n                >\n                  Book Your First Wash\n                </Button>\n              </CardContent>\n            </Card>\n          </motion.div>\n        )}\n        \n        {!isLoading && fullPlateNumber && jobs && jobs.length > 0 && (\n          <>\n            {/* Current Active Job */}\n            {currentJob && (\n              <motion.div\n                initial={{ opacity: 0, y: 20 }}\n                animate={{ opacity: 1, y: 0 }}\n                className=\"mb-6\"\n              >\n                <h2 className=\"text-xl font-bold mb-4 flex items-center gap-2\">\n                  <div className=\"h-8 w-8 rounded-full bg-primary/20 flex items-center justify-center\">\n                    <Timer className=\"h-4 w-4 text-primary\" />\n                  </div>\n                  Active Wash\n                </h2>\n                <ActiveJobCard job={currentJob} currentTime={currentTime} onRate={() => setSelectedJob(currentJob)} />\n              </motion.div>\n            )}\n\n            {/* Completed Jobs History */}\n            {historyJobs && historyJobs.length > 0 && (\n              <motion.div\n                initial={{ opacity: 0, y: 20 }}\n                animate={{ opacity: 1, y: 0 }}\n                transition={{ delay: 0.1 }}\n              >\n                <h2 className=\"text-xl font-bold mb-4 flex items-center gap-2\">\n                  <div className=\"h-8 w-8 rounded-full bg-green-100 dark:bg-green-950 flex items-center justify-center\">\n                    <CheckCircle2 className=\"h-4 w-4 text-green-600 dark:text-green-400\" />\n                  </div>\n                  History\n                </h2>\n                <div className=\"space-y-4\">\n                  {historyJobs.map((job, index) => (\n                    <motion.div\n                      key={job.id}\n                      initial={{ opacity: 0, y: 20 }}\n                      animate={{ opacity: 1, y: 0 }}\n                      transition={{ delay: 0.1 + index * 0.05 }}\n                    >\n                      <HistoryJobCard\n                        job={job}\n                        onRate={() => setSelectedJob(job)}\n                      />\n                    </motion.div>\n                  ))}\n                </div>\n                \n                {/* Pagination Controls */}\n                <PaginationControls\n                  currentPage={page}\n                  totalPages={totalPages}\n                  onPageChange={setPage}\n                  className=\"mt-6\"\n                />\n              </motion.div>\n            )}\n          </>\n        )}\n\n        {/* Rating Modal */}\n        {selectedJob && (\n          <div className=\"fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50 backdrop-blur-sm\">\n            <motion.div\n              initial={{ opacity: 0, scale: 0.95 }}\n              animate={{ opacity: 1, scale: 1 }}\n              className=\"w-full max-w-md\"\n            >\n              <Card className=\"border-primary/20\">\n                <CardHeader className=\"bg-gradient-to-r from-primary/10 to-primary/5\">\n                  <CardTitle>Rate Your Car Wash</CardTitle>\n                  <CardDescription>Job #{selectedJob.id}</CardDescription>\n                </CardHeader>\n                <CardContent className=\"space-y-4 pt-6\">\n                  {/* Star Rating */}\n                  <div className=\"flex justify-center gap-2\">\n                    {[1, 2, 3, 4, 5].map((star) => (\n                      <button\n                        key={star}\n                        type=\"button\"\n                        onClick={() => setRating(star)}\n                        className=\"focus:outline-none transition-transform hover:scale-110\"\n                        data-testid={`button-star-${star}`}\n                      >\n                        <Star\n                          className={`h-10 w-10 ${\n                            star <= rating\n                              ? \"fill-yellow-400 text-yellow-400\"\n                              : \"text-muted-foreground\"\n                          }`}\n                        />\n                      </button>\n                    ))}\n                  </div>\n\n                  {/* Review Text */}\n                  <div className=\"space-y-2\">\n                    <label className=\"text-sm font-medium\">\n                      Review (Optional)\n                    </label>\n                    <Textarea\n                      placeholder=\"Tell us about your experience...\"\n                      value={review}\n                      onChange={(e) => setReview(e.target.value)}\n                      rows={4}\n                      data-testid=\"input-review\"\n                    />\n                  </div>\n                </CardContent>\n                <CardFooter className=\"flex gap-2\">\n                  <Button\n                    variant=\"outline\"\n                    onClick={() => {\n                      setSelectedJob(null);\n                      setRating(0);\n                      setReview(\"\");\n                    }}\n                    data-testid=\"button-cancel-rating\"\n                  >\n                    Cancel\n                  </Button>\n                  <Button\n                    className=\"flex-1 bg-primary hover:bg-primary/90\"\n                    disabled={rating === 0 || submitRating.isPending}\n                    onClick={() => submitRating.mutate()}\n                    data-testid=\"button-submit-rating\"\n                  >\n                    {submitRating.isPending ? \"Submitting...\" : \"Submit Rating\"}\n                  </Button>\n                </CardFooter>\n              </Card>\n            </motion.div>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n\nfunction ActiveJobCard({ job, currentTime, onRate }: { job: Job; currentTime: Date; onRate?: () => void }) {\n  const { data: cleaner, isError: cleanerError } = useQuery<CleanerWithContact>({\n    queryKey: [\"/api/cleaners\", job.cleanerId],\n    queryFn: async () => {\n      const res = await fetch(`/api/cleaners/${job.cleanerId}`);\n      if (!res.ok) return null;\n      return res.json();\n    },\n    enabled: !!job.cleanerId,\n    retry: false,\n  });\n\n  const { data: company, isError: companyError } = useQuery<Company>({\n    queryKey: [\"/api/companies\", job.companyId],\n    queryFn: async () => {\n      const res = await fetch(`/api/companies/${job.companyId}`);\n      if (!res.ok) return null;\n      return res.json();\n    },\n    retry: false,\n  });\n\n  const getProgressStage = (status: JobStatus) => {\n    switch (status) {\n      case JobStatus.PENDING_PAYMENT:\n      case JobStatus.PAID:\n        return 1;\n      case JobStatus.ASSIGNED:\n        return 2;\n      case JobStatus.IN_PROGRESS:\n        return 3;\n      case JobStatus.COMPLETED:\n        return 4;\n      default:\n        return 0;\n    }\n  };\n\n  const stage = getProgressStage(job.status as JobStatus);\n\n  const stages = [\n    { id: 1, label: \"Requested\", icon: Car },\n    { id: 2, label: \"Assigned\", icon: User },\n    { id: 3, label: \"In Progress\", icon: Timer },\n    { id: 4, label: \"Completed\", icon: CheckCircle2 },\n  ];\n\n  const getTimeRemaining = (targetTime: Date | null) => {\n    if (!targetTime) return null;\n    const diff = new Date(targetTime).getTime() - currentTime.getTime();\n    if (diff <= 0) return \"Now\";\n    \n    const minutes = Math.floor(diff / 60000);\n    const hours = Math.floor(minutes / 60);\n    \n    if (hours > 0) {\n      return `${hours}h ${minutes % 60}m`;\n    }\n    return `${minutes}m`;\n  };\n\n  return (\n    <Card className=\"border-primary/30 overflow-hidden\" data-testid={`job-card-${job.id}`}>\n      {/* Progress Timeline */}\n      <div className=\"bg-gradient-to-r from-primary/10 to-primary/5 p-6\">\n        <div className=\"relative\">\n          {/* Progress Line */}\n          <div className=\"absolute top-5 left-0 right-0 h-0.5 bg-muted\">\n            <div \n              className=\"h-full bg-primary transition-all duration-500\"\n              style={{ width: `${((stage - 1) / 3) * 100}%` }}\n            />\n          </div>\n\n          {/* Progress Steps */}\n          <div className=\"relative flex justify-between\">\n            {stages.map((s) => {\n              const Icon = s.icon;\n              const isActive = stage >= s.id;\n              const isCurrent = stage === s.id;\n              \n              return (\n                <div key={s.id} className=\"flex flex-col items-center gap-2\">\n                  <motion.div\n                    initial={{ scale: 0.8, opacity: 0 }}\n                    animate={{ scale: 1, opacity: 1 }}\n                    transition={{ delay: s.id * 0.1 }}\n                    className={`h-10 w-10 rounded-full flex items-center justify-center transition-all ${\n                      isActive\n                        ? \"bg-primary text-white shadow-lg\"\n                        : \"bg-muted text-muted-foreground\"\n                    } ${isCurrent ? \"ring-4 ring-primary/30\" : \"\"}`}\n                  >\n                    <Icon className=\"h-5 w-5\" />\n                  </motion.div>\n                  <span className={`text-xs font-medium ${isActive ? \"text-foreground\" : \"text-muted-foreground\"}`}>\n                    {s.label}\n                  </span>\n                </div>\n              );\n            })}\n          </div>\n        </div>\n\n        {/* Estimated Times */}\n        {(job.estimatedStartTime || job.estimatedFinishTime) && (\n          <div className=\"mt-6 grid grid-cols-2 gap-3\">\n            {job.estimatedStartTime && stage < 3 && (\n              <div className=\"bg-white/50 dark:bg-black/20 rounded-lg p-3 border border-primary/20\">\n                <p className=\"text-xs text-muted-foreground mb-1\">Estimated Start</p>\n                <div className=\"flex items-center gap-2\">\n                  <Clock className=\"h-4 w-4 text-primary\" />\n                  <span className=\"font-bold text-primary\">\n                    {getTimeRemaining(job.estimatedStartTime)}\n                  </span>\n                </div>\n              </div>\n            )}\n            {job.estimatedFinishTime && stage >= 3 && (\n              <div className=\"bg-white/50 dark:bg-black/20 rounded-lg p-3 border border-primary/20\">\n                <p className=\"text-xs text-muted-foreground mb-1\">Estimated Finish</p>\n                <div className=\"flex items-center gap-2\">\n                  <Clock className=\"h-4 w-4 text-primary\" />\n                  <span className=\"font-bold text-primary\">\n                    {getTimeRemaining(job.estimatedFinishTime)}\n                  </span>\n                </div>\n              </div>\n            )}\n          </div>\n        )}\n      </div>\n\n      <CardContent className=\"space-y-4 pt-6\">\n        {/* Refund Message */}\n        {job.status === JobStatus.REFUNDED && (\n          <div className=\"bg-green-50 dark:bg-green-950/30 border border-green-200 dark:border-green-800 rounded-lg p-4\">\n            <div className=\"flex items-start gap-3\">\n              <div className=\"h-8 w-8 rounded-full bg-green-100 dark:bg-green-900 flex items-center justify-center shrink-0\">\n                <AlertCircle className=\"h-4 w-4 text-green-600 dark:text-green-400\" />\n              </div>\n              <div className=\"text-sm\">\n                <p className=\"font-bold text-green-900 dark:text-green-100 mb-2\">Full Refund Processed</p>\n                <p className=\"text-green-800 dark:text-green-200\">\n                  No cleaner accepted your job within 15 minutes. \n                  Your payment of <strong>{job.totalAmount} AED</strong> has been fully refunded \n                  and will appear on your card within 10 business days.\n                </p>\n              </div>\n            </div>\n          </div>\n        )}\n\n        {/* Cleaner Assigned Indicator */}\n        {job.cleanerId && job.status !== JobStatus.PAID && job.status !== JobStatus.PENDING_PAYMENT && (\n          <div className=\"bg-gradient-to-r from-primary/5 to-primary/10 border border-primary/20 rounded-lg p-4\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"h-12 w-12 rounded-full bg-primary/20 flex items-center justify-center\">\n                <User className=\"h-6 w-6 text-primary\" />\n              </div>\n              <div>\n                <p className=\"font-semibold\">Cleaner Assigned</p>\n                <p className=\"text-sm text-muted-foreground\">Your cleaner is on the way!</p>\n              </div>\n            </div>\n          </div>\n        )}\n\n        {/* Company */}\n        {company && (\n          <div className=\"flex items-start gap-3\">\n            <div className=\"h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center shrink-0\">\n              <Building2 className=\"h-5 w-5 text-primary\" />\n            </div>\n            <div>\n              <p className=\"text-sm text-muted-foreground\">Company</p>\n              <p className=\"font-semibold\">{company.name}</p>\n            </div>\n          </div>\n        )}\n\n        {/* Location */}\n        <div className=\"flex items-start gap-3\">\n          <div className=\"h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center shrink-0\">\n            <MapPin className=\"h-5 w-5 text-primary\" />\n          </div>\n          <div className=\"flex-1\">\n            <p className=\"text-sm text-muted-foreground\">Location</p>\n            <p className=\"font-medium\">{job.locationAddress}</p>\n            {job.parkingNumber && (\n              <p className=\"text-sm text-muted-foreground mt-1\">\n                Parking: {job.parkingNumber}\n              </p>\n            )}\n          </div>\n        </div>\n\n        {/* Phone */}\n        <div className=\"flex items-start gap-3\">\n          <div className=\"h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center shrink-0\">\n            <Phone className=\"h-5 w-5 text-primary\" />\n          </div>\n          <div>\n            <p className=\"text-sm text-muted-foreground\">Your Phone</p>\n            <p className=\"font-medium\">{job.customerPhone}</p>\n          </div>\n        </div>\n\n        {/* Cleaner Phone */}\n        {cleaner?.phoneNumber && (\n          <div className=\"flex items-start gap-3\">\n            <div className=\"h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center shrink-0\">\n              <Phone className=\"h-5 w-5 text-primary\" />\n            </div>\n            <div>\n              <p className=\"text-sm text-muted-foreground\">Cleaner Phone</p>\n              <a \n                href={`tel:${cleaner.phoneNumber}`} \n                className=\"font-medium text-primary hover:underline\"\n                data-testid=\"link-cleaner-phone\"\n              >\n                {cleaner.phoneNumber}\n              </a>\n            </div>\n          </div>\n        )}\n\n        {/* Completion Photo */}\n        {job.status === JobStatus.COMPLETED && job.proofPhotoURL && (\n          <div className=\"pt-2 border-t\">\n            <p className=\"text-sm text-muted-foreground mb-2\">Completion Photo</p>\n            <img \n              src={job.proofPhotoURL} \n              alt=\"Completed car wash proof\" \n              className=\"w-full h-auto rounded-lg border\"\n              data-testid={`img-proof-${job.id}`}\n            />\n          </div>\n        )}\n\n        {/* Rating Display */}\n        {job.rating && (\n          <div className=\"pt-2 border-t\">\n            <div className=\"flex items-center gap-2 mb-1\">\n              <div className=\"flex\">\n                {[1, 2, 3, 4, 5].map((star) => (\n                  <Star\n                    key={star}\n                    className={`h-4 w-4 ${\n                      star <= Number(job.rating)\n                        ? \"fill-yellow-400 text-yellow-400\"\n                        : \"text-muted-foreground\"\n                    }`}\n                  />\n                ))}\n              </div>\n              <span className=\"text-sm text-muted-foreground\">Your Rating</span>\n            </div>\n            {job.review && (\n              <p className=\"text-sm text-muted-foreground italic mt-2\">{job.review}</p>\n            )}\n          </div>\n        )}\n\n        {/* Price */}\n        <div className=\"flex items-center justify-between pt-4 border-t\">\n          <span className=\"text-muted-foreground\">Total Amount</span>\n          <span className=\"text-2xl font-bold text-primary\">{job.totalAmount} AED</span>\n        </div>\n      </CardContent>\n\n      {/* Rate Button */}\n      {job.status === JobStatus.COMPLETED && !job.rating && onRate && (\n        <CardFooter>\n          <Button\n            className=\"w-full bg-primary hover:bg-primary/90\"\n            onClick={onRate}\n            data-testid={`button-rate-${job.id}`}\n          >\n            <Star className=\"h-4 w-4 mr-2\" />\n            Rate This Wash\n          </Button>\n        </CardFooter>\n      )}\n    </Card>\n  );\n}\n\nfunction HistoryJobCard({ job, onRate }: { job: Job; onRate?: () => void }) {\n  const [, setLocation] = useLocation();\n  const { data: cleaner, isError: cleanerError } = useQuery<CleanerWithContact>({\n    queryKey: [\"/api/cleaners\", job.cleanerId],\n    queryFn: async () => {\n      const res = await fetch(`/api/cleaners/${job.cleanerId}`);\n      if (!res.ok) return null;\n      return res.json();\n    },\n    enabled: !!job.cleanerId,\n    retry: false,\n  });\n\n  const getDuration = () => {\n    if (!job.startedAt || !job.completedAt) return null;\n    const diff = new Date(job.completedAt).getTime() - new Date(job.startedAt).getTime();\n    const minutes = Math.round(diff / 60000);\n    return `${minutes} min`;\n  };\n\n  // Check if this is an offline/cash job\n  // Backend adds isOfflineJob flag, but also check for Cash Payment address as fallback\n  const isCashJob = (job as any).isOfflineJob === true || \n    job.locationAddress === 'Cash Payment' || \n    (job.locationLatitude && job.locationLongitude && \n     parseFloat(job.locationLatitude as string) === 0 && \n     parseFloat(job.locationLongitude as string) === 0);\n\n  const mapUrl = !isCashJob ? `https://www.openstreetmap.org/export/embed.html?bbox=${parseFloat(job.locationLongitude as string) - 0.01},${parseFloat(job.locationLatitude as string) - 0.01},${parseFloat(job.locationLongitude as string) + 0.01},${parseFloat(job.locationLatitude as string) + 0.01}&layer=mapnik&marker=${job.locationLatitude},${job.locationLongitude}` : '';\n\n  return (\n    <Card className=\"hover-elevate overflow-hidden\" data-testid={`job-card-${job.id}`}>\n      {/* Map Thumbnail or Cash Payment Header */}\n      <div className=\"relative h-32 bg-muted\">\n        {isCashJob ? (\n          <div className=\"w-full h-full flex items-center justify-center bg-gradient-to-br from-green-100 to-green-50 dark:from-green-900/30 dark:to-green-800/20\">\n            <div className=\"text-center\">\n              <Banknote className=\"h-10 w-10 text-green-600 dark:text-green-400 mx-auto mb-2\" />\n              <p className=\"text-sm font-medium text-green-700 dark:text-green-300\">Cash Payment</p>\n            </div>\n          </div>\n        ) : (\n          <iframe\n            src={mapUrl}\n            className=\"w-full h-full pointer-events-none\"\n            title=\"Job location\"\n          />\n        )}\n        <div className=\"absolute top-2 right-2 flex gap-1\">\n          {isCashJob && (\n            <Badge className=\"bg-amber-600 text-white font-bold shadow-lg\">\n              Cash\n            </Badge>\n          )}\n          {job.status === JobStatus.REFUNDED ? (\n            <Badge className=\"bg-green-600 text-white font-bold shadow-lg\">\n              Refunded\n            </Badge>\n          ) : job.status === JobStatus.COMPLETED ? (\n            <Badge className=\"bg-green-600 text-white font-bold shadow-lg\">\n              Completed\n            </Badge>\n          ) : (\n            <Badge variant=\"destructive\">Cancelled</Badge>\n          )}\n        </div>\n      </div>\n\n      <CardContent className=\"pt-4 space-y-3\">\n        {/* Header */}\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <p className=\"font-semibold\">Job #{job.id}</p>\n            <p className=\"text-xs text-muted-foreground\">\n              {new Date(job.createdAt).toLocaleDateString('en-AE', {\n                month: 'short',\n                day: 'numeric',\n                year: 'numeric',\n                timeZone: 'Asia/Dubai'\n              })}\n            </p>\n          </div>\n          {getDuration() && (\n            <div className=\"text-right\">\n              <p className=\"text-xs text-muted-foreground\">Duration</p>\n              <p className=\"font-semibold text-primary\">{getDuration()}</p>\n            </div>\n          )}\n        </div>\n\n        {/* Cleaner Info */}\n        {job.cleanerId && job.status === JobStatus.COMPLETED && (\n          <div className=\"bg-primary/5 rounded-lg p-3 space-y-2\">\n            <div className=\"flex items-center gap-2\">\n              <div className=\"h-8 w-8 rounded-full bg-primary/20 flex items-center justify-center\">\n                <User className=\"h-4 w-4 text-primary\" />\n              </div>\n              <div className=\"flex-1\">\n                <p className=\"text-sm font-medium\">Professional Cleaner</p>\n                <p className=\"text-xs text-muted-foreground\">Wash completed successfully</p>\n              </div>\n            </div>\n            {cleaner?.phoneNumber && (\n              <div className=\"flex items-center gap-2 pl-10\">\n                <Phone className=\"h-3 w-3 text-muted-foreground\" />\n                <a \n                  href={`tel:${cleaner.phoneNumber}`} \n                  className=\"text-sm text-primary hover:underline\"\n                  data-testid=\"link-cleaner-phone-history\"\n                >\n                  {cleaner.phoneNumber}\n                </a>\n              </div>\n            )}\n          </div>\n        )}\n\n        {/* Location */}\n        <div className=\"flex items-start gap-2\">\n          <MapPin className=\"h-4 w-4 mt-0.5 text-muted-foreground shrink-0\" />\n          <p className=\"text-sm\">{job.locationAddress}</p>\n        </div>\n\n        {/* Proof Photo */}\n        {job.status === JobStatus.COMPLETED && job.proofPhotoURL && (\n          <div className=\"pt-2 border-t\">\n            <p className=\"text-xs text-muted-foreground mb-2\">Completion Photo</p>\n            <img \n              src={job.proofPhotoURL} \n              alt=\"Completed car wash proof\" \n              className=\"w-full h-auto rounded-lg border\"\n              data-testid={`img-proof-${job.id}`}\n            />\n          </div>\n        )}\n\n        {/* Rating Display */}\n        {job.rating && (\n          <div className=\"pt-2 border-t\">\n            <div className=\"flex items-center gap-2 mb-1\">\n              <div className=\"flex\">\n                {[1, 2, 3, 4, 5].map((star) => (\n                  <Star\n                    key={star}\n                    className={`h-4 w-4 ${\n                      star <= Number(job.rating)\n                        ? \"fill-yellow-400 text-yellow-400\"\n                        : \"text-muted-foreground\"\n                    }`}\n                  />\n                ))}\n              </div>\n              <span className=\"text-sm text-muted-foreground\">Your Rating</span>\n            </div>\n            {job.review && (\n              <p className=\"text-sm text-muted-foreground italic mt-2\">{job.review}</p>\n            )}\n          </div>\n        )}\n\n        {/* Price */}\n        <div className=\"flex items-center justify-between pt-2 border-t\">\n          <span className=\"text-sm text-muted-foreground\">Total Paid</span>\n          <span className=\"text-lg font-bold\">{job.totalAmount} AED</span>\n        </div>\n      </CardContent>\n\n      {/* Action Buttons */}\n      {(job.status === JobStatus.COMPLETED || job.status === JobStatus.CANCELLED || job.status === JobStatus.REFUNDED) && (\n        <CardFooter className=\"flex gap-2 flex-wrap\">\n          {/* Rate Button - only for completed jobs without rating */}\n          {job.status === JobStatus.COMPLETED && !job.rating && onRate && (\n            <Button\n              className=\"flex-1 bg-primary hover:bg-primary/90\"\n              onClick={onRate}\n              data-testid={`button-rate-${job.id}`}\n            >\n              <Star className=\"h-4 w-4 mr-2\" />\n              Rate This Wash\n            </Button>\n          )}\n          \n          {/* Download Receipt Button - only for online (paid) jobs */}\n          {!isCashJob && job.status === JobStatus.COMPLETED && (\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={() => {\n                // Trigger download by fetching receipt\n                fetch(`/api/jobs/${job.id}/receipt`)\n                  .then(res => res.blob())\n                  .then(blob => {\n                    const url = window.URL.createObjectURL(blob);\n                    const a = document.createElement('a');\n                    a.href = url;\n                    a.download = `receipt-${job.id}.pdf`;\n                    document.body.appendChild(a);\n                    a.click();\n                    window.URL.revokeObjectURL(url);\n                    document.body.removeChild(a);\n                  })\n                  .catch(() => {\n                    toast({\n                      title: \"Error\",\n                      description: \"Failed to download receipt\",\n                      variant: \"destructive\",\n                    });\n                  });\n              }}\n              data-testid={`button-download-receipt-${job.id}`}\n            >\n              <Download className=\"h-4 w-4 mr-2\" />\n              Receipt\n            </Button>\n          )}\n          \n          {/* Complaint Button - for all eligible statuses */}\n          <Button\n            variant=\"outline\"\n            className={job.status === JobStatus.COMPLETED && !job.rating ? \"flex-1\" : job.status === JobStatus.COMPLETED && !isCashJob ? \"flex-1\" : \"w-full\"}\n            onClick={() => {\n              // Pass the job ID to complaint page\n              setLocation(`/customer/complaint/${job.id}`);\n            }}\n            data-testid={`button-complaint-${job.id}`}\n          >\n            <MessageSquare className=\"h-4 w-4 mr-2\" />\n            Report Issue\n          </Button>\n        </CardFooter>\n      )}\n    </Card>\n  );\n}\n","path":null,"size_bytes":49113,"size_tokens":null},"client/src/pages/company-financials.tsx":{"content":"import { useState, useMemo } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Link } from \"wouter\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Button } from \"@/components/ui/button\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { DollarSign, TrendingUp, TrendingDown, Download, Filter, ArrowLeft, Banknote, Upload, FileText, Briefcase, Wallet, Car } from \"lucide-react\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Cleaner } from \"@shared/schema\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { PaginationControls } from \"@/components/PaginationControls\";\n\ninterface JobFinancial {\n  id: number;\n  jobId: number;\n  cleanerId: number | null;\n  baseJobAmount: string;\n  baseTax: string;\n  tipAmount: string;\n  tipTax: string;\n  platformFeeAmount: string;\n  platformFeeTax: string;\n  paymentProcessingFeeAmount: string;\n  companyStripeFeeShare: string;\n  cleanerStripeFeeShare: string;\n  remainingTip: string;\n  grossAmount: string;\n  netPayableAmount: string;\n  taxAmount: string;\n  paidAt: Date;\n  refundedAt: Date | null;\n  cleanerName: string | null;\n  cleanerEmail: string | null;\n  cleanerPhone: string | null;\n  feePackageType: string | null;\n  receiptNumber: string | null;\n  stripePaymentIntentId: string | null;\n  stripeRefundId: string | null;\n  jobStatus: string | null;\n}\n\ninterface FinancialSummary {\n  totalRevenue: number;\n  totalRefunds: number;\n  platformFees: number;\n  paymentProcessingFees: number;\n  taxAmount: number;\n  netEarnings: number;\n  adminPayouts: number;\n  totalWithdrawals: number;\n  pendingWithdrawals: number;\n  availableBalance: number;\n}\n\ninterface Transaction {\n  id: number;\n  referenceNumber: string;\n  companyId: number;\n  jobId: number | null;\n  type: string;\n  direction: string;\n  amount: string;\n  currency: string;\n  description: string;\n  createdAt: Date;\n  grossAmount?: string;\n  netAmount?: string;\n  taxAmount?: string;\n  cleanerName?: string;\n  cleanerEmail?: string;\n}\n\ninterface WithdrawalBalance {\n  completedJobs: number;\n  totalJobValue: number;\n  totalTips: number;\n  totalWithdrawn: number;\n  availableJobs: number;\n  availableJobValue: number;\n  availableTips: number;\n  pricePerWash: number;\n  withdrawnJobs: number;\n  withdrawnTips: number;\n}\n\ninterface WithdrawalHistory {\n  id: number;\n  amount: string;\n  status: string;\n  referenceNumber: string | null;\n  note: string | null;\n  invoiceUrl: string | null;\n  jobCountRequested: number | null;\n  tipsRequested: string | null;\n  baseAmount: string | null;\n  vatAmount: string | null;\n  createdAt: Date;\n  processedAt: Date | null;\n}\n\ninterface OfflineJob {\n  id: number;\n  cleanerId: number;\n  companyId: number;\n  carPlateEmirate: string;\n  carPlateCode: string;\n  carPlateNumber: string;\n  locationAddress: string | null;\n  locationLatitude: string | null;\n  locationLongitude: string | null;\n  servicePrice: string;\n  taxAmount: string;\n  totalAmount: string;\n  notes: string | null;\n  createdAt: Date;\n  cleanerName?: string | null;\n}\n\nexport default function CompanyFinancials() {\n  const { toast } = useToast();\n  const [selectedCleanerId, setSelectedCleanerId] = useState<string>(\"all\");\n  const [startDate, setStartDate] = useState<string>(\"\");\n  const [endDate, setEndDate] = useState<string>(\"\");\n  const [page, setPage] = useState(1);\n  const pageSize = 20;\n  \n  const [withdrawalDialogOpen, setWithdrawalDialogOpen] = useState(false);\n  const [jobCount, setJobCount] = useState<number>(0);\n  const [tipsAmount, setTipsAmount] = useState<string>(\"0\");\n  const [invoiceFile, setInvoiceFile] = useState<File | null>(null);\n  const [uploading, setUploading] = useState(false);\n  \n  const [offlineCleanerFilter, setOfflineCleanerFilter] = useState<string>(\"all\");\n  const [offlineStartDate, setOfflineStartDate] = useState<string>(\"\");\n  const [offlineEndDate, setOfflineEndDate] = useState<string>(\"\");\n  const [offlinePage, setOfflinePage] = useState(1);\n\n  const { data: cleaners } = useQuery<Cleaner[]>({\n    queryKey: [\"/api/company/cleaners\"],\n  });\n\n  const { data: summary, isLoading: loadingSummary } = useQuery<FinancialSummary>({\n    queryKey: [\"/api/company/financials/overview\"],\n  });\n\n  const { data: adminPayouts, isLoading: loadingAdminPayouts } = useQuery<Transaction[]>({\n    queryKey: [\"/api/company/financials/admin-payouts\"],\n  });\n\n  const { data: withdrawalBalance } = useQuery<WithdrawalBalance>({\n    queryKey: [\"/api/company/financials/withdrawal-balance\"],\n  });\n\n  const { data: withdrawalHistory } = useQuery<WithdrawalHistory[]>({\n    queryKey: [\"/api/company/financials/withdrawals\"],\n  });\n\n  const offlinePageSize = 20;\n  \n  const offlineQueryString = useMemo(() => {\n    const params = new URLSearchParams();\n    if (offlineCleanerFilter && offlineCleanerFilter !== \"all\") params.append(\"cleanerId\", offlineCleanerFilter);\n    if (offlineStartDate) params.append(\"startDate\", offlineStartDate);\n    if (offlineEndDate) params.append(\"endDate\", offlineEndDate);\n    params.append(\"page\", String(offlinePage));\n    params.append(\"pageSize\", String(offlinePageSize));\n    return params.toString();\n  }, [offlineCleanerFilter, offlineStartDate, offlineEndDate, offlinePage]);\n\n  const { data: offlineJobsResponse, isLoading: loadingOfflineJobs } = useQuery<{ data: OfflineJob[], total: number }>({\n    queryKey: [\"/api/company/offline-jobs\", offlineCleanerFilter, offlineStartDate, offlineEndDate, offlinePage],\n    queryFn: async () => {\n      const response = await apiRequest(\"GET\", `/api/company/offline-jobs?${offlineQueryString}`);\n      return response.json();\n    },\n  });\n\n  const offlineJobs = offlineJobsResponse?.data || [];\n  const offlineTotal = offlineJobsResponse?.total || 0;\n  const offlineTotalPages = Math.ceil(offlineTotal / offlinePageSize);\n\n  const withdrawalMutation = useMutation({\n    mutationFn: async (data: { jobCount: number; tipsAmount: string; invoiceUrl: string }) => {\n      return await apiRequest(\"POST\", \"/api/company/financials/request-withdrawal\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/company/withdrawal-balance\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/company/withdrawals\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/company/financials/overview\"] });\n      setWithdrawalDialogOpen(false);\n      setJobCount(0);\n      setTipsAmount(\"0\");\n      setInvoiceFile(null);\n      toast({\n        title: \"Withdrawal Requested\",\n        description: \"Your withdrawal request has been submitted for processing.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleInvoiceUpload = async (): Promise<string | null> => {\n    if (!invoiceFile) return null;\n    \n    const formData = new FormData();\n    formData.append(\"file\", invoiceFile);\n    \n    const response = await fetch(\"/api/upload-invoice\", {\n      method: \"POST\",\n      credentials: \"include\",\n      body: formData,\n    });\n    \n    if (!response.ok) {\n      throw new Error(\"Failed to upload invoice\");\n    }\n    \n    const result = await response.json();\n    return result.url;\n  };\n\n  const handleWithdrawalSubmit = async () => {\n    if (!invoiceFile) {\n      toast({\n        title: \"Error\",\n        description: \"Please upload an invoice\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    \n    if (jobCount < 1) {\n      toast({\n        title: \"Error\",\n        description: \"Please select at least 1 job to withdraw\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    \n    try {\n      setUploading(true);\n      const invoiceUrl = await handleInvoiceUpload();\n      if (!invoiceUrl) {\n        throw new Error(\"Failed to upload invoice\");\n      }\n      \n      withdrawalMutation.mutate({\n        jobCount,\n        tipsAmount,\n        invoiceUrl,\n      });\n    } catch (error: any) {\n      toast({\n        title: \"Error\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    } finally {\n      setUploading(false);\n    }\n  };\n\n  const calculateWithdrawalTotal = () => {\n    if (!withdrawalBalance) return { baseAmount: 0, vatAmount: 0, tips: 0, total: 0 };\n    const baseAmount = jobCount * withdrawalBalance.pricePerWash;\n    const vatAmount = baseAmount * 0.05;\n    const tips = parseFloat(tipsAmount || \"0\");\n    const total = baseAmount + vatAmount + tips;\n    return { baseAmount, vatAmount, tips, total };\n  };\n\n  const filters: any = {};\n  if (selectedCleanerId && selectedCleanerId !== \"all\") filters.cleanerId = selectedCleanerId;\n  if (startDate) filters.startDate = startDate;\n  if (endDate) filters.endDate = endDate;\n\n  const queryParams = new URLSearchParams();\n  if (selectedCleanerId && selectedCleanerId !== \"all\") queryParams.append(\"cleanerId\", selectedCleanerId);\n  if (startDate) queryParams.append(\"startDate\", startDate);\n  if (endDate) queryParams.append(\"endDate\", endDate);\n  queryParams.append(\"page\", String(page));\n  queryParams.append(\"pageSize\", String(pageSize));\n\n  const { data: jobsResponse, isLoading: loadingJobs } = useQuery<{ data: JobFinancial[], total: number }>({\n    queryKey: [\"/api/company/financials/jobs\", filters, page],\n    queryFn: async () => {\n      const response = await fetch(`/api/company/financials/jobs?${queryParams.toString()}`, {\n        credentials: 'include',\n      });\n      if (!response.ok) throw new Error('Failed to fetch jobs');\n      return response.json();\n    },\n  });\n\n  const jobs = jobsResponse?.data || [];\n  const total = jobsResponse?.total || 0;\n  const totalPages = Math.ceil(total / pageSize);\n\n  const handleExport = async () => {\n    try {\n      const response = await fetch(\"/api/company/financials/export\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        body: JSON.stringify(filters),\n      });\n\n      if (!response.ok) throw new Error(\"Export failed\");\n\n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement(\"a\");\n      a.href = url;\n      a.download = `financials-${Date.now()}.xlsx`;\n      document.body.appendChild(a);\n      a.click();\n      document.body.removeChild(a);\n      window.URL.revokeObjectURL(url);\n\n      toast({\n        title: \"Export Successful\",\n        description: \"Financial report has been downloaded\",\n      });\n    } catch (error: any) {\n      toast({\n        title: \"Export Failed\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  if (loadingSummary || !summary) {\n    return (\n      <div className=\"min-h-screen bg-background p-4 pb-20\">\n        <div className=\"max-w-6xl mx-auto\">\n          <div className=\"mb-6 pt-4\">\n            <Skeleton className=\"h-8 w-48 mb-2\" />\n            <Skeleton className=\"h-4 w-64\" />\n          </div>\n          <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-4\">\n            {[1, 2, 3, 4].map((i) => (\n              <Card key={i}>\n                <CardHeader><Skeleton className=\"h-4 w-24\" /></CardHeader>\n                <CardContent><Skeleton className=\"h-8 w-32\" /></CardContent>\n              </Card>\n            ))}\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-background p-4 pb-20\">\n      <div className=\"max-w-6xl mx-auto\">\n        <Link href=\"/company\">\n          <Button variant=\"ghost\" className=\"mb-4\" data-testid=\"button-back-to-dashboard\">\n            <ArrowLeft className=\"h-4 w-4 mr-2\" />\n            Back to Dashboard\n          </Button>\n        </Link>\n        \n        <div className=\"mb-6\">\n          <h1 className=\"text-2xl font-bold text-foreground mb-1\">Financial Reports</h1>\n          <p className=\"text-muted-foreground\">View revenue breakdown and export data</p>\n        </div>\n\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-4 mb-6\">\n          <Card data-testid=\"card-total-revenue\">\n            <CardHeader className=\"pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Gross Revenue</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\">{Number(summary.totalRevenue).toFixed(2)} AED</div>\n              <p className=\"text-xs text-muted-foreground mt-1\">Before refunds & fees</p>\n            </CardContent>\n          </Card>\n          <Card data-testid=\"card-refunds\">\n            <CardHeader className=\"pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Refunds</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold text-red-600 dark:text-red-400\">-{Number(summary.totalRefunds).toFixed(2)} AED</div>\n              <p className=\"text-xs text-muted-foreground mt-1\">Auto-refunded jobs</p>\n            </CardContent>\n          </Card>\n          <Card data-testid=\"card-platform-fees\">\n            <CardHeader className=\"pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Platform Fees</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold text-red-600 dark:text-red-400\">-{Number(summary.platformFees).toFixed(2)} AED</div>\n              <p className=\"text-xs text-muted-foreground mt-1\">Service fees</p>\n            </CardContent>\n          </Card>\n          <Card data-testid=\"card-net-earnings\">\n            <CardHeader className=\"pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Net Earnings</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold text-green-600 dark:text-green-400\">{Number(summary.netEarnings).toFixed(2)} AED</div>\n              <p className=\"text-xs text-muted-foreground mt-1\">After all deductions</p>\n            </CardContent>\n          </Card>\n        </div>\n        \n        {/* Payment Breakdown Row */}\n        <div className=\"grid gap-4 md:grid-cols-3 mb-6\">\n          <Card data-testid=\"card-admin-payouts\">\n            <CardHeader className=\"pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Admin Payouts</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold text-red-600 dark:text-red-400\">-{Number(summary.adminPayouts).toFixed(2)} AED</div>\n              <p className=\"text-xs text-muted-foreground mt-1\">Already paid to you</p>\n            </CardContent>\n          </Card>\n          <Card data-testid=\"card-tax-collected\">\n            <CardHeader className=\"pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Tax Collected (5%)</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\">{Number(summary.taxAmount).toFixed(2)} AED</div>\n              <p className=\"text-xs text-muted-foreground mt-1\">Included in gross revenue</p>\n            </CardContent>\n          </Card>\n          <Card data-testid=\"card-available-balance\">\n            <CardHeader className=\"pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Available Balance</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className={`text-2xl font-bold ${Number(summary.availableBalance) < 0 ? 'text-red-600 dark:text-red-400' : ''}`}>\n                {Number(summary.availableBalance).toFixed(2)} AED\n              </div>\n              <p className=\"text-xs text-muted-foreground mt-1\">\n                {Number(summary.availableBalance) < 0 ? 'Negative balance' : 'Available for withdrawal'}\n              </p>\n            </CardContent>\n          </Card>\n        </div>\n\n        {/* Admin Payouts Section */}\n        {adminPayouts && adminPayouts.length > 0 && (\n          <Card className=\"mb-6\">\n            <CardHeader>\n              <CardTitle>Admin Payouts</CardTitle>\n              <CardDescription>Payments already made to your company</CardDescription>\n            </CardHeader>\n            <CardContent>\n              {loadingAdminPayouts ? (\n                <div className=\"space-y-4\">\n                  {[1, 2, 3].map((i) => (\n                    <Skeleton key={i} className=\"h-16 w-full\" />\n                  ))}\n                </div>\n              ) : (\n                <div className=\"overflow-x-auto\">\n                  <Table>\n                    <TableHeader>\n                      <TableRow>\n                        <TableHead>Reference</TableHead>\n                        <TableHead>Date</TableHead>\n                        <TableHead>Description</TableHead>\n                        <TableHead className=\"text-right\">Amount</TableHead>\n                      </TableRow>\n                    </TableHeader>\n                    <TableBody>\n                      {adminPayouts.map((payout) => (\n                        <TableRow key={payout.id} data-testid={`payout-${payout.id}`}>\n                          <TableCell className=\"font-medium\">{payout.referenceNumber}</TableCell>\n                          <TableCell>{new Date(payout.createdAt).toLocaleDateString('en-AE', { year: 'numeric', month: 'short', day: 'numeric', timeZone: 'Asia/Dubai' })}</TableCell>\n                          <TableCell>{payout.description}</TableCell>\n                          <TableCell className=\"text-right font-medium text-red-600 dark:text-red-400\">\n                            -{Number(payout.amount).toFixed(2)} {payout.currency}\n                          </TableCell>\n                        </TableRow>\n                      ))}\n                    </TableBody>\n                  </Table>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        )}\n\n        {/* Withdrawal Request Section */}\n        <Card className=\"mb-6\">\n          <CardHeader>\n            <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4\">\n              <div>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <Banknote className=\"h-5 w-5\" />\n                  Request Withdrawal\n                </CardTitle>\n                <CardDescription>Request payment for completed jobs</CardDescription>\n              </div>\n              <Dialog open={withdrawalDialogOpen} onOpenChange={setWithdrawalDialogOpen}>\n                <DialogTrigger asChild>\n                  <Button data-testid=\"button-request-withdrawal\" disabled={!withdrawalBalance || withdrawalBalance.availableJobs < 1}>\n                    <Banknote className=\"h-4 w-4 mr-2\" />\n                    Request Withdrawal\n                  </Button>\n                </DialogTrigger>\n                <DialogContent className=\"max-w-lg\">\n                  <DialogHeader>\n                    <DialogTitle>Request Withdrawal</DialogTitle>\n                    <DialogDescription>\n                      Select jobs and tips to withdraw. Invoice upload is required.\n                    </DialogDescription>\n                  </DialogHeader>\n                  \n                  {withdrawalBalance && (\n                    <div className=\"space-y-4\">\n                      <div className=\"p-4 bg-muted/50 rounded-lg space-y-2\">\n                        <div className=\"flex justify-between text-sm\">\n                          <span>Available Jobs:</span>\n                          <span className=\"font-medium\">{withdrawalBalance.availableJobs}</span>\n                        </div>\n                        <div className=\"flex justify-between text-sm\">\n                          <span>Price per Wash:</span>\n                          <span className=\"font-medium\">{withdrawalBalance.pricePerWash.toFixed(2)} AED</span>\n                        </div>\n                        <div className=\"flex justify-between text-sm\">\n                          <span>Available Job Value:</span>\n                          <span className=\"font-medium\">{withdrawalBalance.availableJobValue.toFixed(2)} AED</span>\n                        </div>\n                        <div className=\"flex justify-between text-sm border-t pt-2\">\n                          <span>Available Tips:</span>\n                          <span className=\"font-medium text-green-600\">{withdrawalBalance.availableTips.toFixed(2)} AED</span>\n                        </div>\n                      </div>\n\n                      <div className=\"space-y-2\">\n                        <Label htmlFor=\"job-count\">Number of Jobs to Withdraw</Label>\n                        <Input\n                          id=\"job-count\"\n                          type=\"number\"\n                          min=\"0\"\n                          max={withdrawalBalance.availableJobs}\n                          value={jobCount}\n                          onChange={(e) => setJobCount(Math.min(parseInt(e.target.value) || 0, withdrawalBalance.availableJobs))}\n                          data-testid=\"input-job-count\"\n                        />\n                        <p className=\"text-xs text-muted-foreground\">\n                          Maximum: {withdrawalBalance.availableJobs} jobs\n                        </p>\n                      </div>\n\n                      <div className=\"space-y-2\">\n                        <Label htmlFor=\"tips-amount\">Tips Amount (AED)</Label>\n                        <Input\n                          id=\"tips-amount\"\n                          type=\"number\"\n                          min=\"0\"\n                          max={withdrawalBalance.availableTips}\n                          step=\"0.01\"\n                          value={tipsAmount}\n                          onChange={(e) => {\n                            const val = parseFloat(e.target.value) || 0;\n                            setTipsAmount(Math.min(val, withdrawalBalance.availableTips).toString());\n                          }}\n                          data-testid=\"input-tips-amount\"\n                        />\n                        <p className=\"text-xs text-muted-foreground\">\n                          Maximum: {withdrawalBalance.availableTips.toFixed(2)} AED (Tips are VAT-exempt)\n                        </p>\n                      </div>\n\n                      <div className=\"space-y-2\">\n                        <Label htmlFor=\"invoice-upload\">Upload Invoice (Required)</Label>\n                        <div className=\"flex items-center gap-2\">\n                          <Input\n                            id=\"invoice-upload\"\n                            type=\"file\"\n                            accept=\".pdf,.png,.jpg,.jpeg\"\n                            onChange={(e) => setInvoiceFile(e.target.files?.[0] || null)}\n                            data-testid=\"input-invoice-upload\"\n                            className=\"flex-1\"\n                          />\n                          {invoiceFile && (\n                            <span className=\"text-xs text-green-600 flex items-center gap-1\">\n                              <FileText className=\"h-3 w-3\" />\n                              {invoiceFile.name}\n                            </span>\n                          )}\n                        </div>\n                        <p className=\"text-xs text-muted-foreground\">\n                          PDF, PNG, or JPG. Max 5MB.\n                        </p>\n                      </div>\n\n                      {/* Calculation Preview */}\n                      {jobCount > 0 && (\n                        <div className=\"p-4 bg-primary/5 rounded-lg border border-primary/20 space-y-2\">\n                          <h4 className=\"font-medium text-sm\">Withdrawal Summary</h4>\n                          <div className=\"flex justify-between text-sm\">\n                            <span>{jobCount} jobs × {withdrawalBalance.pricePerWash.toFixed(2)} AED:</span>\n                            <span>{calculateWithdrawalTotal().baseAmount.toFixed(2)} AED</span>\n                          </div>\n                          <div className=\"flex justify-between text-sm text-muted-foreground\">\n                            <span>VAT (5%):</span>\n                            <span>{calculateWithdrawalTotal().vatAmount.toFixed(2)} AED</span>\n                          </div>\n                          {parseFloat(tipsAmount) > 0 && (\n                            <div className=\"flex justify-between text-sm text-green-600\">\n                              <span>Tips (VAT-exempt):</span>\n                              <span>{parseFloat(tipsAmount).toFixed(2)} AED</span>\n                            </div>\n                          )}\n                          <div className=\"flex justify-between font-bold text-base border-t pt-2\">\n                            <span>Total:</span>\n                            <span>{calculateWithdrawalTotal().total.toFixed(2)} AED</span>\n                          </div>\n                        </div>\n                      )}\n\n                      <div className=\"flex justify-end gap-2 pt-4\">\n                        <Button variant=\"outline\" onClick={() => setWithdrawalDialogOpen(false)}>\n                          Cancel\n                        </Button>\n                        <Button\n                          onClick={handleWithdrawalSubmit}\n                          disabled={uploading || withdrawalMutation.isPending || jobCount < 1 || !invoiceFile}\n                          data-testid=\"button-submit-withdrawal\"\n                        >\n                          {uploading || withdrawalMutation.isPending ? \"Processing...\" : \"Submit Request\"}\n                        </Button>\n                      </div>\n                    </div>\n                  )}\n                </DialogContent>\n              </Dialog>\n            </div>\n          </CardHeader>\n          <CardContent>\n            {withdrawalBalance ? (\n              <div className=\"grid gap-4 md:grid-cols-4\">\n                <div className=\"p-4 bg-muted/50 rounded-lg\">\n                  <div className=\"flex items-center gap-2 text-muted-foreground mb-1\">\n                    <Briefcase className=\"h-4 w-4\" />\n                    <span className=\"text-sm\">Available Jobs</span>\n                  </div>\n                  <div className=\"text-2xl font-bold\" data-testid=\"text-available-jobs\">\n                    {withdrawalBalance.availableJobs}\n                  </div>\n                  <p className=\"text-xs text-muted-foreground mt-1\">\n                    Worth {withdrawalBalance.availableJobValue.toFixed(2)} AED\n                  </p>\n                </div>\n                <div className=\"p-4 bg-muted/50 rounded-lg\">\n                  <div className=\"flex items-center gap-2 text-muted-foreground mb-1\">\n                    <DollarSign className=\"h-4 w-4\" />\n                    <span className=\"text-sm\">Available Tips</span>\n                  </div>\n                  <div className=\"text-2xl font-bold text-green-600 dark:text-green-400\" data-testid=\"text-available-tips\">\n                    {withdrawalBalance.availableTips.toFixed(2)} AED\n                  </div>\n                  <p className=\"text-xs text-muted-foreground mt-1\">\n                    VAT-exempt\n                  </p>\n                </div>\n                <div className=\"p-4 bg-muted/50 rounded-lg\">\n                  <div className=\"flex items-center gap-2 text-muted-foreground mb-1\">\n                    <Briefcase className=\"h-4 w-4\" />\n                    <span className=\"text-sm\">Total Completed</span>\n                  </div>\n                  <div className=\"text-2xl font-bold\">\n                    {withdrawalBalance.completedJobs}\n                  </div>\n                  <p className=\"text-xs text-muted-foreground mt-1\">\n                    All-time jobs\n                  </p>\n                </div>\n                <div className=\"p-4 bg-muted/50 rounded-lg\">\n                  <div className=\"flex items-center gap-2 text-muted-foreground mb-1\">\n                    <Banknote className=\"h-4 w-4\" />\n                    <span className=\"text-sm\">Already Withdrawn</span>\n                  </div>\n                  <div className=\"text-2xl font-bold text-red-600 dark:text-red-400\">\n                    {withdrawalBalance.withdrawnJobs} jobs\n                  </div>\n                  <p className=\"text-xs text-muted-foreground mt-1\">\n                    {withdrawalBalance.totalWithdrawn.toFixed(2)} AED total\n                  </p>\n                </div>\n              </div>\n            ) : (\n              <div className=\"text-center py-8 text-muted-foreground\">\n                <p>Loading withdrawal balance...</p>\n              </div>\n            )}\n\n            {/* Withdrawal History */}\n            {withdrawalHistory && withdrawalHistory.length > 0 && (\n              <div className=\"mt-6\">\n                <h3 className=\"font-medium mb-4\">Withdrawal History</h3>\n                <div className=\"overflow-x-auto\">\n                  <Table>\n                    <TableHeader>\n                      <TableRow>\n                        <TableHead>Date</TableHead>\n                        <TableHead>Jobs</TableHead>\n                        <TableHead>Tips</TableHead>\n                        <TableHead>Total</TableHead>\n                        <TableHead>Status</TableHead>\n                        <TableHead>Invoice</TableHead>\n                      </TableRow>\n                    </TableHeader>\n                    <TableBody>\n                      {withdrawalHistory.map((withdrawal) => (\n                        <TableRow key={withdrawal.id} data-testid={`withdrawal-${withdrawal.id}`}>\n                          <TableCell>\n                            {new Date(withdrawal.createdAt).toLocaleDateString('en-AE', { \n                              year: 'numeric', \n                              month: 'short', \n                              day: 'numeric',\n                              timeZone: 'Asia/Dubai'\n                            })}\n                          </TableCell>\n                          <TableCell>{withdrawal.jobCountRequested || '-'}</TableCell>\n                          <TableCell>{withdrawal.tipsRequested ? `${parseFloat(withdrawal.tipsRequested).toFixed(2)} AED` : '-'}</TableCell>\n                          <TableCell className=\"font-medium\">{parseFloat(withdrawal.amount).toFixed(2)} AED</TableCell>\n                          <TableCell>\n                            <span className={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${\n                              withdrawal.status === 'completed'\n                                ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-100'\n                                : withdrawal.status === 'pending'\n                                ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-100'\n                                : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-100'\n                            }`}>\n                              {withdrawal.status}\n                            </span>\n                          </TableCell>\n                          <TableCell>\n                            {withdrawal.invoiceUrl ? (\n                              <a\n                                href={withdrawal.invoiceUrl}\n                                target=\"_blank\"\n                                rel=\"noopener noreferrer\"\n                                className=\"text-primary hover:underline flex items-center gap-1\"\n                              >\n                                <FileText className=\"h-3 w-3\" />\n                                View\n                              </a>\n                            ) : '-'}\n                          </TableCell>\n                        </TableRow>\n                      ))}\n                    </TableBody>\n                  </Table>\n                </div>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n\n        <Card className=\"mb-6\">\n          <CardHeader>\n            <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4\">\n              <div>\n                <CardTitle>Job Financials</CardTitle>\n                <CardDescription>Filter and export financial data</CardDescription>\n              </div>\n              <Button onClick={handleExport} data-testid=\"button-export\">\n                <Download className=\"h-4 w-4 mr-2\" />\n                Export to Excel\n              </Button>\n            </div>\n          </CardHeader>\n          <CardContent>\n            <div className=\"grid gap-4 md:grid-cols-3 mb-6\">\n              <div>\n                <Label htmlFor=\"cleaner-filter\">Filter by Cleaner</Label>\n                <Select value={selectedCleanerId} onValueChange={setSelectedCleanerId}>\n                  <SelectTrigger id=\"cleaner-filter\" data-testid=\"select-cleaner\">\n                    <SelectValue placeholder=\"All Cleaners\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"all\">All Cleaners</SelectItem>\n                    {cleaners?.map((cleaner) => (\n                      <SelectItem key={cleaner.id} value={String(cleaner.id)}>\n                        Cleaner #{cleaner.id}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n              <div>\n                <Label htmlFor=\"start-date\">Start Date</Label>\n                <Input\n                  id=\"start-date\"\n                  type=\"date\"\n                  value={startDate}\n                  onChange={(e) => setStartDate(e.target.value)}\n                  data-testid=\"input-start-date\"\n                />\n              </div>\n              <div>\n                <Label htmlFor=\"end-date\">End Date</Label>\n                <Input\n                  id=\"end-date\"\n                  type=\"date\"\n                  value={endDate}\n                  onChange={(e) => setEndDate(e.target.value)}\n                  data-testid=\"input-end-date\"\n                />\n              </div>\n            </div>\n\n            {loadingJobs ? (\n              <div className=\"space-y-4\">\n                {[1, 2, 3].map((i) => (\n                  <Skeleton key={i} className=\"h-16 w-full\" />\n                ))}\n              </div>\n            ) : jobs && jobs.length > 0 ? (\n              <>\n                <div className=\"overflow-x-auto\">\n                  <Table>\n                    <TableHeader>\n                      <TableRow>\n                        <TableHead>Job ID</TableHead>\n                        <TableHead>Status</TableHead>\n                        <TableHead>Receipt #</TableHead>\n                        <TableHead>Stripe Ref</TableHead>\n                        <TableHead>Cleaner</TableHead>\n                        <TableHead>Base Amount</TableHead>\n                        <TableHead>Base Tax</TableHead>\n                        <TableHead>Total Tip</TableHead>\n                        <TableHead>Tip VAT</TableHead>\n                        <TableHead>Remaining Tip</TableHead>\n                        <TableHead>Platform Fee</TableHead>\n                        <TableHead>Platform Tax</TableHead>\n                        <TableHead>Stripe Fee</TableHead>\n                        <TableHead>Gross</TableHead>\n                        <TableHead>Net</TableHead>\n                        <TableHead>Date</TableHead>\n                        <TableHead>Actions</TableHead>\n                      </TableRow>\n                    </TableHeader>\n                    <TableBody>\n                      {jobs.map((job) => {\n                        const isRefunded = job.refundedAt !== null;\n                        const isPackage2 = (job.feePackageType || 'custom').toLowerCase() === 'package2';\n                        const tipAmount = parseFloat(job.tipAmount || \"0\");\n                        const tipTax = parseFloat(job.tipTax || \"0\");\n                        const totalTip = tipAmount + tipTax;\n                        const remainingTip = parseFloat(job.remainingTip || \"0\");\n                        const hasTip = totalTip > 0;\n                        \n                        // Format job status for display\n                        const statusDisplay = job.jobStatus === 'refunded_unattended' ? 'Refunded (Unattended)' :\n                                            job.jobStatus === 'refunded' ? 'Refunded (Manual)' :\n                                            job.jobStatus?.toUpperCase() || 'N/A';\n                        const statusColor = job.jobStatus?.includes('refunded') ? 'text-red-600 dark:text-red-400' : \n                                          job.jobStatus === 'completed' ? 'text-green-600 dark:text-green-400' :\n                                          'text-muted-foreground';\n                        \n                        return (\n                          <TableRow key={job.id} data-testid={`job-${job.id}`}>\n                            <TableCell className=\"font-medium\">#{job.jobId}</TableCell>\n                            <TableCell className={`min-w-[120px] ${statusColor}`}>{statusDisplay}</TableCell>\n                            <TableCell className=\"font-mono text-xs min-w-[150px]\">{job.receiptNumber || '-'}</TableCell>\n                            <TableCell className=\"font-mono text-xs min-w-[180px]\">\n                              <div className=\"flex flex-col gap-1\">\n                                {job.stripePaymentIntentId && (\n                                  <div className=\"text-green-600 dark:text-green-400\" title=\"Payment Intent ID\">\n                                    Pay: {job.stripePaymentIntentId.substring(0, 20)}...\n                                  </div>\n                                )}\n                                {job.stripeRefundId && (\n                                  <div className=\"text-red-600 dark:text-red-400\" title=\"Refund ID\">\n                                    Ref: {job.stripeRefundId.substring(0, 20)}...\n                                  </div>\n                                )}\n                                {!job.stripePaymentIntentId && !job.stripeRefundId && '-'}\n                              </div>\n                            </TableCell>\n                            <TableCell className=\"min-w-[120px]\">{job.cleanerName || \"Unassigned\"}</TableCell>\n                            <TableCell className=\"min-w-[100px]\">{parseFloat(job.baseJobAmount || \"0\").toFixed(2)} AED</TableCell>\n                            <TableCell className=\"min-w-[80px]\">{parseFloat(job.baseTax || \"0\").toFixed(2)} AED</TableCell>\n                            <TableCell className=\"text-primary font-medium min-w-[100px]\">\n                              {hasTip ? `${totalTip.toFixed(2)} AED` : \"-\"}\n                            </TableCell>\n                            <TableCell className=\"min-w-[80px]\">\n                              {hasTip ? `${tipTax.toFixed(2)} AED` : \"-\"}\n                            </TableCell>\n                            <TableCell className=\"text-green-600 dark:text-green-400 font-medium min-w-[120px]\">\n                              {hasTip ? `${remainingTip.toFixed(2)} AED` : \"-\"}\n                            </TableCell>\n                            <TableCell className=\"min-w-[110px]\">{parseFloat(job.platformFeeAmount || \"0\").toFixed(2)} AED</TableCell>\n                            <TableCell className=\"min-w-[100px]\">{parseFloat(job.platformFeeTax || \"0\").toFixed(2)} AED</TableCell>\n                            <TableCell className=\"min-w-[100px]\">\n                              {isPackage2 ? `${parseFloat(job.paymentProcessingFeeAmount || \"0\").toFixed(2)} AED` : \"-\"}\n                            </TableCell>\n                            <TableCell className=\"font-medium min-w-[100px]\">{parseFloat(job.grossAmount || \"0\").toFixed(2)} AED</TableCell>\n                            <TableCell className={`font-medium min-w-[100px] ${isRefunded ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400'}`}>\n                              {parseFloat(job.netPayableAmount || \"0\").toFixed(2)} AED\n                            </TableCell>\n                            <TableCell className=\"text-sm min-w-[100px]\">{new Date(job.paidAt).toLocaleDateString('en-AE', { year: 'numeric', month: 'short', day: 'numeric', timeZone: 'Asia/Dubai' })}</TableCell>\n                            <TableCell className=\"min-w-[80px]\">\n                              {job.receiptNumber ? (\n                                <Button\n                                  variant=\"ghost\"\n                                  size=\"icon\"\n                                  onClick={() => window.open(`/api/company/receipt/${job.jobId}`, '_blank')}\n                                  title=\"Download Receipt\"\n                                  data-testid={`button-download-receipt-${job.jobId}`}\n                                >\n                                  <Download className=\"h-4 w-4\" />\n                                </Button>\n                              ) : (\n                                <span className=\"text-muted-foreground\">-</span>\n                              )}\n                            </TableCell>\n                          </TableRow>\n                        );\n                      })}\n                    </TableBody>\n                  </Table>\n                </div>\n                <PaginationControls \n                  currentPage={page}\n                  totalPages={totalPages}\n                  onPageChange={setPage}\n                  className=\"mt-4\"\n                />\n              </>\n            ) : (\n              <p className=\"text-center text-muted-foreground py-8\">No financial data available for the selected filters</p>\n            )}\n          </CardContent>\n        </Card>\n\n        {/* Offline Jobs Section */}\n        <Card className=\"mt-6\">\n          <CardHeader className=\"pb-4\">\n            <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4\">\n              <div className=\"flex items-center gap-2\">\n                <Wallet className=\"h-5 w-5 text-primary\" />\n                <div>\n                  <CardTitle>Offline / Cash Jobs</CardTitle>\n                  <CardDescription>Jobs recorded by cleaners with cash or other offline payments</CardDescription>\n                </div>\n              </div>\n            </div>\n          </CardHeader>\n          <CardContent>\n            <div className=\"grid gap-4 md:grid-cols-3 mb-6\">\n              <div>\n                <Label htmlFor=\"offline-cleaner-filter\">Filter by Cleaner</Label>\n                <Select value={offlineCleanerFilter} onValueChange={(val) => { setOfflineCleanerFilter(val); setOfflinePage(1); }}>\n                  <SelectTrigger id=\"offline-cleaner-filter\" data-testid=\"select-offline-cleaner\">\n                    <SelectValue placeholder=\"All Cleaners\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"all\">All Cleaners</SelectItem>\n                    {cleaners?.map((cleaner) => (\n                      <SelectItem key={cleaner.id} value={String(cleaner.id)}>\n                        Cleaner #{cleaner.id}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n              <div>\n                <Label htmlFor=\"offline-start-date\">Start Date</Label>\n                <Input\n                  id=\"offline-start-date\"\n                  type=\"date\"\n                  value={offlineStartDate}\n                  onChange={(e) => { setOfflineStartDate(e.target.value); setOfflinePage(1); }}\n                  data-testid=\"input-offline-start-date\"\n                />\n              </div>\n              <div>\n                <Label htmlFor=\"offline-end-date\">End Date</Label>\n                <Input\n                  id=\"offline-end-date\"\n                  type=\"date\"\n                  value={offlineEndDate}\n                  onChange={(e) => { setOfflineEndDate(e.target.value); setOfflinePage(1); }}\n                  data-testid=\"input-offline-end-date\"\n                />\n              </div>\n            </div>\n\n            {loadingOfflineJobs ? (\n              <div className=\"space-y-4\">\n                {[1, 2, 3].map((i) => (\n                  <Skeleton key={i} className=\"h-16 w-full\" />\n                ))}\n              </div>\n            ) : offlineJobs && offlineJobs.length > 0 ? (\n              <>\n                <div className=\"overflow-x-auto\">\n                  <Table>\n                    <TableHeader>\n                      <TableRow>\n                        <TableHead>ID</TableHead>\n                        <TableHead>Car Plate</TableHead>\n                        <TableHead>Cleaner</TableHead>\n                        <TableHead>Service Price</TableHead>\n                        <TableHead>VAT (5%)</TableHead>\n                        <TableHead>Total</TableHead>\n                        <TableHead>Notes</TableHead>\n                        <TableHead>Date</TableHead>\n                      </TableRow>\n                    </TableHeader>\n                    <TableBody>\n                      {offlineJobs.map((job) => (\n                        <TableRow key={job.id} data-testid={`offline-job-${job.id}`}>\n                          <TableCell className=\"font-medium\">#{job.id}</TableCell>\n                          <TableCell>\n                            <div className=\"flex items-center gap-2\">\n                              <Car className=\"h-4 w-4 text-muted-foreground\" />\n                              <span>{job.carPlateEmirate} {job.carPlateCode} {job.carPlateNumber}</span>\n                            </div>\n                          </TableCell>\n                          <TableCell>{job.cleanerName || `Cleaner #${job.cleanerId}`}</TableCell>\n                          <TableCell>{parseFloat(job.servicePrice || \"0\").toFixed(2)} AED</TableCell>\n                          <TableCell>{parseFloat(job.taxAmount || \"0\").toFixed(2)} AED</TableCell>\n                          <TableCell className=\"font-semibold text-primary\">{parseFloat(job.totalAmount || \"0\").toFixed(2)} AED</TableCell>\n                          <TableCell className=\"max-w-[150px] truncate\" title={job.notes || ''}>\n                            {job.notes || '-'}\n                          </TableCell>\n                          <TableCell className=\"text-sm\">\n                            {new Date(job.createdAt).toLocaleDateString('en-AE', { \n                              year: 'numeric', \n                              month: 'short', \n                              day: 'numeric', \n                              timeZone: 'Asia/Dubai' \n                            })}\n                          </TableCell>\n                        </TableRow>\n                      ))}\n                    </TableBody>\n                  </Table>\n                </div>\n                <PaginationControls \n                  currentPage={offlinePage}\n                  totalPages={offlineTotalPages}\n                  onPageChange={setOfflinePage}\n                  className=\"mt-4\"\n                />\n              </>\n            ) : (\n              <p className=\"text-center text-muted-foreground py-8\">No offline jobs recorded yet</p>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":47869,"size_tokens":null},"server/financialUtils.ts":{"content":"import { storage } from \"./storage\";\nimport type { InsertJobFinancials } from \"@shared/schema\";\nimport { calculateFees, type FeePackageType } from \"@shared/fee-calculator\";\n\nexport interface FeeCalculation {\n  baseJobAmount: number;       // Company's price per wash (car wash only)\n  basePrice: number;           // Legacy alias for baseJobAmount\n  baseTax: number;             // 5% tax on base amount (DEPRECATED - now part of taxAmount)\n  tipAmount: number;           // Tip amount (goes 100% to cleaner, VAT-exempt)\n  tipTax: number;              // ALWAYS 0 - Tips are VAT-exempt (kept for schema compatibility)\n  platformFeeAmount: number;   // Platform fee (varies by package)\n  platformFee: number;         // Legacy alias for platformFeeAmount\n  platformFeeTax: number;      // 5% tax on platform fee (DEPRECATED - now part of taxAmount)\n  platformFeeToCompany: number; // 95% of platform fee (2.85 AED goes to company)\n  platformRevenue: number;     // 5% of platform fee (0.15 AED deducted from company revenue)\n  servicePrice: number;        // Combined: carWash + platformFee (for customer display)\n  totalAmount: number;         // Total customer pays: service + VAT + tip (no VAT on tip)\n  taxAmount: number;           // Total VAT (5% of servicePrice ONLY - tips are VAT-exempt)\n  grossAmount: number;         // Sum of all amounts before fees/deductions\n  paymentProcessingFeeAmount: number; // Stripe fees (total)\n  companyStripeFeeShare: number;  // Company's portion of Stripe fee (Package 2 only)\n  cleanerStripeFeeShare: number;  // Cleaner's portion of Stripe fee (Package 2 only)\n  netPayableAmount: number;    // What company gets after all deductions\n  remainingTip: number;        // Tip to cleaner (minus Stripe fee share in Package 2)\n}\n\nexport async function calculateJobFees(\n  baseAmount: number, \n  tipAmount: number = 0, \n  platformFee: number = 3.00, \n  packageType: 'pay_per_wash' | 'subscription' = 'pay_per_wash',\n  feePackageType?: FeePackageType\n): Promise<FeeCalculation> {\n  const stripePercentRate = 0.029; // 2.9%\n  const stripeFixedFee = 1.00; // 1 AED\n  const taxRate = 0.05; // 5% VAT\n  \n  // Use shared fee calculator for base pricing\n  const baseFees = calculateFees({\n    carWashPrice: baseAmount,\n    feePackageType: feePackageType || 'custom',\n    platformFee: platformFee,\n  });\n  \n  // Add tip calculations  \n  const tipAmountValue = Number(tipAmount.toFixed(2));\n  // IMPORTANT: Tips are VAT-exempt (no tax on gratuity)\n  // tipTax is kept as 0 and persisted for backwards compatibility with existing schema\n  const tipTax = 0;\n  \n  // Total amount customer pays = service price + VAT + tip (no VAT on tip)\n  const totalAmount = Number((baseFees.totalAmount + tipAmountValue).toFixed(2));\n  \n  // Total tax = VAT on service only (tips are VAT-exempt)\n  const taxAmount = Number(baseFees.vatAmount.toFixed(2));\n  \n  // Determine if Stripe fees should be absorbed by company (package2) or passed to customer (others)\n  const absorbsStripeFee = (feePackageType || '').toLowerCase() === 'package2';\n  \n  // Stripe fees are calculated on the total amount\n  const paymentProcessingFeeAmount = Number(\n    ((totalAmount * stripePercentRate) + stripeFixedFee).toFixed(2)\n  );\n  \n  let platformRevenue: number;\n  let platformFeeToCompany: number;\n  \n  if (packageType === 'subscription') {\n    // Subscription: no platform fees charged to customers\n    platformRevenue = 0;\n    platformFeeToCompany = 0;\n  } else {\n    // All platform fee goes to platform (100% revenue)\n    platformRevenue = baseFees.platformFeeAmount;\n    platformFeeToCompany = 0;\n  }\n  \n  // Platform VAT\n  const platformFeeTax = Number((baseFees.platformFeeAmount * taxRate).toFixed(2));\n  \n  // Gross amount and net payable depend on whether Stripe fee is absorbed\n  let grossAmount: number;\n  let netPayableAmount: number;\n  let companyStripeFeeShare = 0;\n  let cleanerStripeFeeShare = 0;\n  let remainingTip = tipAmountValue; // Tips have no VAT\n  \n  if (absorbsStripeFee) {\n    // Package 2: Customer pays ONLY car wash + VAT + tip (no Stripe fee added to customer)\n    // Company absorbs entire Stripe fee, split proportionally between company and cleaner\n    // For 15 AED wash + 5 tip (package2 has no platform fee):\n    //   - Service price + VAT (company's share) = 15.75\n    //   - Tip (cleaner's share, NO VAT on tip) = 5.00\n    //   - Total = 20.75\n    //   - Stripe fee = 1.60\n    //   - Company's proportion = 15.75 / 20.75 = 0.76\n    //   - Cleaner's proportion = 5.00 / 20.75 = 0.24\n    //   - Company's Stripe fee = 1.60 × 0.76 = 1.22\n    //   - Cleaner's Stripe fee = 1.60 × 0.24 = 0.38\n    //   - Company net = 15.75 - 1.22 = 14.53\n    //   - Cleaner gets (remaining tip) = 5.00 - 0.38 = 4.62\n    \n    grossAmount = totalAmount;  // Customer pays car wash + VAT + tip (no Stripe fee)\n    const companyShare = baseFees.totalAmount;  // Service price + VAT (includes platform fee + VAT)\n    const tipNoVAT = tipAmountValue; // Tips have NO VAT\n    \n    if (tipNoVAT > 0 && totalAmount > 0) {\n      // Calculate proportions with full precision\n      const companyProportion = companyShare / totalAmount;\n      const cleanerProportion = tipNoVAT / totalAmount;\n      \n      // Split Stripe fee proportionally, then round\n      companyStripeFeeShare = Number((paymentProcessingFeeAmount * companyProportion).toFixed(2));\n      cleanerStripeFeeShare = Number((paymentProcessingFeeAmount * cleanerProportion).toFixed(2));\n      \n      // Remaining tip (no VAT) after cleaner's Stripe fee share\n      remainingTip = Number((tipNoVAT - cleanerStripeFeeShare).toFixed(2));\n    } else {\n      // No tip - company absorbs all Stripe fees\n      companyStripeFeeShare = paymentProcessingFeeAmount;\n      cleanerStripeFeeShare = 0;\n      remainingTip = 0;\n    }\n    \n    netPayableAmount = Number((companyShare - companyStripeFeeShare).toFixed(2));\n  } else {\n    // Other packages: Stripe fee is passed to customer, tip goes to cleaner\n    // grossAmount includes service + VAT + tip + Stripe fee (all collected from customer)\n    grossAmount = Number((totalAmount + paymentProcessingFeeAmount).toFixed(2));\n    \n    // Company gets: service - platform fee - platform VAT - Stripe fee (tip excluded, goes to cleaner)\n    // Formula: grossAmount - platformFee - platformVAT - stripeFee - tip\n    // Simplified: (service + VAT + tip + stripe) - platformFee - allVAT + carWashVAT - stripe - tip\n    //           = service - platformFee - platformVAT\n    netPayableAmount = Number(\n      (grossAmount - baseFees.platformFeeAmount - baseFees.vatAmount + (baseFees.carWashPrice * taxRate) - paymentProcessingFeeAmount - tipAmountValue).toFixed(2)\n    );\n    companyStripeFeeShare = 0;\n    cleanerStripeFeeShare = 0;\n    // Cleaner gets full tip (not tracked in netPayableAmount)\n    remainingTip = tipAmountValue;\n  }\n  \n  return {\n    baseJobAmount: baseFees.carWashPrice,\n    basePrice: baseFees.carWashPrice, // Legacy alias\n    baseTax: Number((baseFees.carWashPrice * taxRate).toFixed(2)),\n    tipAmount: tipAmountValue,\n    tipTax,\n    platformFeeAmount: baseFees.platformFeeAmount,\n    platformFee: baseFees.platformFeeAmount, // Legacy alias\n    platformFeeTax: Number((baseFees.platformFeeAmount * taxRate).toFixed(2)),\n    platformFeeToCompany,\n    platformRevenue,\n    servicePrice: baseFees.servicePrice,\n    totalAmount,\n    taxAmount,\n    grossAmount,\n    paymentProcessingFeeAmount,\n    companyStripeFeeShare,\n    cleanerStripeFeeShare,\n    netPayableAmount,\n    remainingTip,\n  };\n}\n\nexport async function createJobFinancialRecord(\n  jobId: number,\n  companyId: number,\n  cleanerId: number | null,\n  baseAmount: number,\n  tipAmount: number,\n  paidAt: Date,\n  platformFee: number = 3.00,\n  feePackageType?: FeePackageType\n): Promise<void> {\n  const existing = await storage.getJobFinancialsByJobId(jobId);\n  if (existing) {\n    return;\n  }\n\n  // Get company to determine package type\n  const company = await storage.getCompany(companyId);\n  const packageType = company?.packageType || 'pay_per_wash';\n  const companyFeePackageType = feePackageType || company?.feePackageType || 'custom';\n\n  const fees = await calculateJobFees(baseAmount, tipAmount, platformFee, packageType, companyFeePackageType);\n  \n  const financialRecord: InsertJobFinancials = {\n    jobId,\n    companyId,\n    cleanerId,\n    baseJobAmount: fees.baseJobAmount.toString(),\n    baseTax: fees.baseTax.toString(),\n    tipAmount: fees.tipAmount.toString(),\n    tipTax: fees.tipTax.toString(),\n    platformFeeAmount: fees.platformFeeAmount.toString(),\n    platformFeeTax: fees.platformFeeTax.toString(),\n    paymentProcessingFeeAmount: fees.paymentProcessingFeeAmount.toString(),\n    companyStripeFeeShare: fees.companyStripeFeeShare.toString(),\n    cleanerStripeFeeShare: fees.cleanerStripeFeeShare.toString(),\n    remainingTip: fees.remainingTip.toString(),\n    grossAmount: fees.grossAmount.toString(),\n    netPayableAmount: fees.netPayableAmount.toString(),\n    taxAmount: fees.taxAmount.toString(),\n    platformRevenue: fees.platformRevenue.toString(),\n    currency: \"AED\",\n    paidAt,\n  };\n  \n  await storage.createJobFinancials(financialRecord);\n}\n\n// Helper to generate unique transaction reference numbers\nexport function generateTransactionReference(type: string, id: number): string {\n  const timestamp = Date.now();\n  const random = Math.random().toString(36).substring(2, 8).toUpperCase();\n  return `${type.toUpperCase()}-${id}-${timestamp}-${random}`;\n}\n","path":null,"size_bytes":9467,"size_tokens":null},"server/autoRefundService.ts":{"content":"import Stripe from \"stripe\";\nimport { db } from \"./db\";\nimport { jobs, transactions } from \"@shared/schema\";\nimport { eq, and, lt } from \"drizzle-orm\";\nimport { getWebSocketServer } from \"./websocket\";\nimport { generateTransactionReference } from \"./financialUtils\";\n\nif (!process.env.STRIPE_SECRET_KEY) {\n  throw new Error('Missing required Stripe secret: STRIPE_SECRET_KEY');\n}\n\nconst stripe = new Stripe(process.env.STRIPE_SECRET_KEY, {\n  apiVersion: \"2025-10-29.clover\",\n});\n\nconst FIFTEEN_MINUTES_MS = 15 * 60 * 1000;\n\nexport async function checkAndRefundExpiredJobs() {\n  try {\n    const fifteenMinutesAgo = new Date(Date.now() - FIFTEEN_MINUTES_MS);\n    \n    // Find all jobs in PAID status that are older than 15 minutes\n    const expiredJobs = await db.select()\n      .from(jobs)\n      .where(\n        and(\n          eq(jobs.status, 'paid'),\n          lt(jobs.createdAt, fifteenMinutesAgo)\n        )\n      );\n\n    if (expiredJobs.length === 0) {\n      return;\n    }\n\n    console.log(`Found ${expiredJobs.length} jobs to auto-refund`);\n\n    for (const job of expiredJobs) {\n      try {\n        if (!job.stripePaymentIntentId) {\n          console.error(`Job ${job.id} has no payment intent ID, skipping refund`);\n          continue;\n        }\n\n        // IMPORTANT: Mark job as 'refunded_unattended' FIRST to prevent cleaners from accepting it\n        await db.update(jobs)\n          .set({\n            status: 'refunded_unattended',\n            refundReason: 'No cleaner accepted within 15 minutes',\n          })\n          .where(eq(jobs.id, job.id));\n\n        console.log(`Job ${job.id} marked as refunded - removed from cleaner availability`);\n\n        // Now issue refund via Stripe\n        const refund = await stripe.refunds.create({\n          payment_intent: job.stripePaymentIntentId,\n          reason: 'requested_by_customer',\n        });\n\n        console.log(`Issued Stripe refund ${refund.id} for job ${job.id}`);\n\n        // Update job with refund details\n        await db.update(jobs)\n          .set({\n            stripeRefundId: refund.id,\n            refundedAt: new Date(),\n          })\n          .where(eq(jobs.id, job.id));\n\n        // Create refund transaction record\n        await db.insert(transactions).values({\n          type: 'refund',\n          direction: 'debit',\n          amount: job.price,\n          currency: 'AED',\n          jobId: job.id,\n          companyId: job.companyId,\n          stripePaymentIntentId: job.stripePaymentIntentId,\n          stripeRefundId: refund.id,\n          referenceNumber: generateTransactionReference('REFUND', job.id),\n          description: `Auto-refund for job ${job.id} - No cleaner accepted within 15 minutes`,\n        });\n\n        console.log(`Created refund transaction record for job ${job.id}`);\n\n        // Send WebSocket notification to all clients\n        const wss = getWebSocketServer();\n        if (wss) {\n          wss.clients.forEach((client: any) => {\n            if (client.readyState === 1) { // OPEN\n              client.send(JSON.stringify({\n                type: 'job_cancelled',\n                jobId: job.id,\n                reason: 'No cleaner accepted within 15 minutes. Full refund issued.',\n              }));\n            }\n          });\n        }\n      } catch (error) {\n        console.error(`Error refunding job ${job.id}:`, error);\n        // Continue with other jobs even if one fails\n      }\n    }\n  } catch (error) {\n    console.error('Error in auto-refund service:', error);\n  }\n}\n\n// Run the check every minute\nexport function startAutoRefundService() {\n  console.log('Auto-refund service started - checking every minute');\n  \n  // Run immediately on startup\n  checkAndRefundExpiredJobs();\n  \n  // Then run every minute\n  setInterval(checkAndRefundExpiredJobs, 60 * 1000);\n}\n","path":null,"size_bytes":3779,"size_tokens":null},"server/session-store.ts":{"content":"import session from \"express-session\";\nimport connectPgSimple from \"connect-pg-simple\";\nimport { pool } from \"./db\";\n\nconst PgSession = connectPgSimple(session);\n\nexport const sessionStore = new PgSession({\n  pool: pool,\n  tableName: 'session',\n  createTableIfMissing: true,\n});\n","path":null,"size_bytes":279,"size_tokens":null},"client/src/components/geofence-editor.tsx":{"content":"import { useState, useCallback, useEffect, useRef } from \"react\";\nimport { MapContainer, TileLayer, Polygon, useMapEvents, useMap } from \"react-leaflet\";\nimport L from \"leaflet\";\nimport \"leaflet/dist/leaflet.css\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { MapPin, Trash2, Save, Navigation, Search, Loader2 } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\n\ndelete (L.Icon.Default.prototype as any)._getIconUrl;\nL.Icon.Default.mergeOptions({\n  iconRetinaUrl: \"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-2x.png\",\n  iconUrl: \"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png\",\n  shadowUrl: \"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png\",\n});\n\ninterface GeofenceEditorProps {\n  initialGeofence?: Array<[number, number]>;\n  onSave: (geofence: Array<[number, number]> | null) => void;\n  centerPosition?: [number, number];\n}\n\nfunction MapClickHandler({ \n  onLocationClick, \n  disabled \n}: { \n  onLocationClick: (lat: number, lng: number) => void;\n  disabled: boolean;\n}) {\n  useMapEvents({\n    click: (e) => {\n      if (!disabled) {\n        onLocationClick(e.latlng.lat, e.latlng.lng);\n      }\n    },\n  });\n  return null;\n}\n\nfunction MapViewController({ position }: { position: [number, number] }) {\n  const map = useMap();\n  \n  useEffect(() => {\n    map.setView(position, map.getZoom());\n  }, [map, position]);\n  \n  return null;\n}\n\ninterface SearchResult {\n  display_name: string;\n  lat: string;\n  lon: string;\n  type: string;\n}\n\nexport default function GeofenceEditor({ \n  initialGeofence, \n  onSave,\n  centerPosition = [25.2048, 55.2708]\n}: GeofenceEditorProps) {\n  const [points, setPoints] = useState<Array<[number, number]>>(initialGeofence || []);\n  const [isDrawing, setIsDrawing] = useState(false);\n  const [isDirty, setIsDirty] = useState(false);\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [searchResults, setSearchResults] = useState<SearchResult[]>([]);\n  const [isSearching, setIsSearching] = useState(false);\n  const [mapCenter, setMapCenter] = useState<[number, number]>(centerPosition);\n  const [isGettingLocation, setIsGettingLocation] = useState(false);\n  const { toast } = useToast();\n  const lastSavedGeofenceRef = useRef<string>();\n  const searchTimeoutRef = useRef<NodeJS.Timeout>();\n\n  useEffect(() => {\n    const currentGeofence = JSON.stringify(initialGeofence);\n    if (!isDirty && currentGeofence !== lastSavedGeofenceRef.current) {\n      lastSavedGeofenceRef.current = currentGeofence;\n      setPoints(initialGeofence || []);\n    }\n  }, [initialGeofence, isDirty]);\n\n  const handleMapClick = useCallback((lat: number, lng: number) => {\n    if (isDrawing) {\n      setPoints(prev => [...prev, [lat, lng]]);\n      setIsDirty(true);\n    }\n  }, [isDrawing]);\n\n  const handleStartDrawing = () => {\n    setPoints([]);\n    setIsDrawing(true);\n    setIsDirty(true);\n    toast({\n      title: \"Drawing Mode Active\",\n      description: \"Click on the map to add points to your geofence area\",\n    });\n  };\n\n  const handleFinishDrawing = () => {\n    if (points.length < 3) {\n      toast({\n        title: \"Not Enough Points\",\n        description: \"Please add at least 3 points to create a geofence area\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    setIsDrawing(false);\n    toast({\n      title: \"Geofence Created\",\n      description: `Geofence area with ${points.length} points created. Click Save to apply changes.`,\n    });\n  };\n\n  const handleClear = () => {\n    setPoints([]);\n    setIsDrawing(false);\n    setIsDirty(true);\n  };\n\n  const handleSave = () => {\n    if (points.length === 0) {\n      onSave(null);\n      setIsDirty(false);\n    } else if (points.length < 3) {\n      toast({\n        title: \"Invalid Geofence\",\n        description: \"Please add at least 3 points or clear the geofence\",\n        variant: \"destructive\",\n      });\n      return;\n    } else {\n      onSave(points);\n      setIsDirty(false);\n    }\n  };\n\n  const handleUndo = () => {\n    if (points.length > 0) {\n      setPoints(prev => prev.slice(0, -1));\n      setIsDirty(true);\n    }\n  };\n\n  const handleSearch = useCallback(async (query: string) => {\n    if (!query.trim()) {\n      setSearchResults([]);\n      return;\n    }\n\n    setIsSearching(true);\n    try {\n      const response = await fetch(`/api/location/search?q=${encodeURIComponent(query)}`);\n      if (!response.ok) {\n        throw new Error(\"Search failed\");\n      }\n      const data = await response.json();\n      setSearchResults(data.slice(0, 5));\n    } catch (error) {\n      toast({\n        title: \"Search Error\",\n        description: \"Failed to search for location\",\n        variant: \"destructive\",\n      });\n      setSearchResults([]);\n    } finally {\n      setIsSearching(false);\n    }\n  }, [toast]);\n\n  const handleSearchInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const query = e.target.value;\n    setSearchQuery(query);\n\n    if (searchTimeoutRef.current) {\n      clearTimeout(searchTimeoutRef.current);\n    }\n\n    searchTimeoutRef.current = setTimeout(() => {\n      handleSearch(query);\n    }, 500);\n  };\n\n  const handleSelectSearchResult = (result: SearchResult) => {\n    const lat = parseFloat(result.lat);\n    const lon = parseFloat(result.lon);\n    setMapCenter([lat, lon]);\n    setSearchQuery(\"\");\n    setSearchResults([]);\n    toast({\n      title: \"Location Found\",\n      description: `Centered on ${result.display_name}`,\n    });\n  };\n\n  const handleGetCurrentLocation = () => {\n    if (!navigator.geolocation) {\n      toast({\n        title: \"Not Supported\",\n        description: \"Geolocation is not supported by your browser\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setIsGettingLocation(true);\n    navigator.geolocation.getCurrentPosition(\n      (position) => {\n        const { latitude, longitude } = position.coords;\n        setMapCenter([latitude, longitude]);\n        setIsGettingLocation(false);\n        toast({\n          title: \"Location Found\",\n          description: \"Map centered on your current location\",\n        });\n      },\n      (error) => {\n        setIsGettingLocation(false);\n        toast({\n          title: \"Location Error\",\n          description: error.message || \"Failed to get your location\",\n          variant: \"destructive\",\n        });\n      },\n      { enableHighAccuracy: true, timeout: 10000 }\n    );\n  };\n\n  return (\n    <Card data-testid=\"card-geofence-editor\">\n      <CardHeader>\n        <CardTitle>Working Area Geofence</CardTitle>\n        <CardDescription>\n          Define your company's service area by clicking points on the map to create a boundary\n        </CardDescription>\n      </CardHeader>\n      <CardContent className=\"space-y-4\">\n        <div className=\"space-y-2\">\n          <div className=\"flex gap-2\">\n            <div className=\"relative flex-1\">\n              <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n              <Input\n                placeholder=\"Search for a location...\"\n                value={searchQuery}\n                onChange={handleSearchInputChange}\n                className=\"pl-10\"\n                data-testid=\"input-location-search\"\n              />\n              {isSearching && (\n                <Loader2 className=\"absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 animate-spin text-muted-foreground\" />\n              )}\n            </div>\n            <Button\n              variant=\"outline\"\n              size=\"icon\"\n              onClick={handleGetCurrentLocation}\n              disabled={isGettingLocation}\n              data-testid=\"button-current-location\"\n            >\n              {isGettingLocation ? (\n                <Loader2 className=\"h-4 w-4 animate-spin\" />\n              ) : (\n                <Navigation className=\"h-4 w-4\" />\n              )}\n            </Button>\n          </div>\n          \n          {searchResults.length > 0 && (\n            <div className=\"border rounded-md overflow-hidden bg-background shadow-lg\">\n              {searchResults.map((result, index) => (\n                <button\n                  key={index}\n                  onClick={() => handleSelectSearchResult(result)}\n                  className=\"w-full text-left px-3 py-2 hover-elevate border-b last:border-b-0\"\n                  data-testid={`search-result-${index}`}\n                >\n                  <p className=\"font-medium text-sm\">{result.display_name}</p>\n                  <p className=\"text-xs text-muted-foreground\">{result.type}</p>\n                </button>\n              ))}\n            </div>\n          )}\n        </div>\n\n        <div className=\"flex flex-wrap gap-2\">\n          {!isDrawing ? (\n            <Button\n              onClick={handleStartDrawing}\n              variant=\"default\"\n              data-testid=\"button-start-drawing\"\n            >\n              <MapPin className=\"w-4 h-4 mr-2\" />\n              {points.length > 0 ? \"Redraw Geofence\" : \"Draw Geofence\"}\n            </Button>\n          ) : (\n            <>\n              <Button\n                onClick={handleFinishDrawing}\n                variant=\"default\"\n                disabled={points.length < 3}\n                data-testid=\"button-finish-drawing\"\n              >\n                Finish Drawing ({points.length} points)\n              </Button>\n              <Button\n                onClick={handleUndo}\n                variant=\"outline\"\n                disabled={points.length === 0}\n                data-testid=\"button-undo\"\n              >\n                Undo Last Point\n              </Button>\n            </>\n          )}\n          \n          {points.length > 0 && !isDrawing && (\n            <>\n              <Button\n                onClick={handleClear}\n                variant=\"outline\"\n                data-testid=\"button-clear\"\n              >\n                <Trash2 className=\"w-4 h-4 mr-2\" />\n                Clear\n              </Button>\n              <Button\n                onClick={handleSave}\n                variant=\"default\"\n                data-testid=\"button-save-geofence\"\n              >\n                <Save className=\"w-4 h-4 mr-2\" />\n                Save Geofence\n              </Button>\n            </>\n          )}\n        </div>\n\n        <div className=\"border rounded-md overflow-hidden\" style={{ height: \"500px\" }}>\n          <MapContainer\n            center={centerPosition}\n            zoom={13}\n            style={{ height: \"100%\", width: \"100%\" }}\n            data-testid=\"map-geofence\"\n          >\n            <TileLayer\n              attribution='&copy; <a href=\"https://www.openstreetmap.org/copyright\">OpenStreetMap</a>'\n              url=\"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png\"\n            />\n            <MapViewController position={mapCenter} />\n            <MapClickHandler onLocationClick={handleMapClick} disabled={!isDrawing} />\n            \n            {points.length > 0 && (\n              <Polygon\n                positions={points}\n                pathOptions={{\n                  color: isDrawing ? \"#3b82f6\" : \"#10b981\",\n                  fillColor: isDrawing ? \"#3b82f6\" : \"#10b981\",\n                  fillOpacity: 0.2,\n                  weight: 2,\n                }}\n              />\n            )}\n          </MapContainer>\n        </div>\n\n        {points.length > 0 && (\n          <p className=\"text-sm text-muted-foreground\" data-testid=\"text-point-count\">\n            Geofence area defined with {points.length} points\n            {points.length < 3 && \" (minimum 3 required)\"}\n          </p>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n","path":null,"size_bytes":11753,"size_tokens":null},"client/src/components/geofence-manager.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { MapPin, Trash2, Plus, Edit } from \"lucide-react\";\nimport GeofenceEditor from \"./geofence-editor\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport type { CompanyGeofence } from \"@shared/schema\";\n\ninterface GeofenceManagerProps {\n  companyId: number;\n}\n\nexport default function GeofenceManager({ companyId }: GeofenceManagerProps) {\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  const [editingGeofence, setEditingGeofence] = useState<CompanyGeofence | null>(null);\n  const [geofenceName, setGeofenceName] = useState(\"\");\n  const [geofencePolygon, setGeofencePolygon] = useState<Array<[number, number]> | null>(null);\n  const { toast } = useToast();\n\n  // Fetch all geofences\n  const { data: geofences, isLoading } = useQuery<CompanyGeofence[]>({\n    queryKey: [\"/api/company/geofences\"],\n  });\n\n  // Create geofence mutation\n  const createMutation = useMutation({\n    mutationFn: async (data: { name: string; polygon: Array<[number, number]> }) => {\n      return await apiRequest(\"POST\", \"/api/company/geofences\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/company/geofences\"] });\n      toast({\n        title: \"Geofence Created\",\n        description: \"The geofence has been created successfully.\",\n      });\n      handleCloseDialog();\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to create geofence\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Update geofence mutation\n  const updateMutation = useMutation({\n    mutationFn: async (data: { id: number; name?: string; polygon?: Array<[number, number]> }) => {\n      const { id, ...updates } = data;\n      return await apiRequest(\"PATCH\", `/api/company/geofences/${id}`, updates);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/company/geofences\"] });\n      toast({\n        title: \"Geofence Updated\",\n        description: \"The geofence has been updated successfully.\",\n      });\n      handleCloseDialog();\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to update geofence\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Delete geofence mutation\n  const deleteMutation = useMutation({\n    mutationFn: async (id: number) => {\n      return await apiRequest(\"DELETE\", `/api/company/geofences/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/company/geofences\"] });\n      toast({\n        title: \"Geofence Deleted\",\n        description: \"The geofence has been deleted successfully.\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to delete geofence\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleOpenCreate = () => {\n    setEditingGeofence(null);\n    setGeofenceName(\"\");\n    setGeofencePolygon(null);\n    setIsDialogOpen(true);\n  };\n\n  const handleOpenEdit = (geofence: CompanyGeofence) => {\n    setEditingGeofence(geofence);\n    setGeofenceName(geofence.name);\n    setGeofencePolygon(geofence.polygon as Array<[number, number]>);\n    setIsDialogOpen(true);\n  };\n\n  const handleCloseDialog = () => {\n    setIsDialogOpen(false);\n    setEditingGeofence(null);\n    setGeofenceName(\"\");\n    setGeofencePolygon(null);\n  };\n\n  const handleSave = () => {\n    if (!geofenceName.trim()) {\n      toast({\n        title: \"Name Required\",\n        description: \"Please enter a name for the geofence\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (!geofencePolygon || geofencePolygon.length < 3) {\n      toast({\n        title: \"Invalid Geofence\",\n        description: \"Please draw a geofence area with at least 3 points\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (editingGeofence) {\n      // Update existing geofence\n      const updates: { id: number; name?: string; polygon?: Array<[number, number]> } = {\n        id: editingGeofence.id,\n      };\n\n      if (geofenceName !== editingGeofence.name) {\n        updates.name = geofenceName;\n      }\n\n      if (JSON.stringify(geofencePolygon) !== JSON.stringify(editingGeofence.polygon)) {\n        updates.polygon = geofencePolygon;\n      }\n\n      if (updates.name || updates.polygon) {\n        updateMutation.mutate(updates);\n      } else {\n        handleCloseDialog();\n      }\n    } else {\n      // Create new geofence\n      createMutation.mutate({\n        name: geofenceName,\n        polygon: geofencePolygon,\n      });\n    }\n  };\n\n  const handleDelete = (id: number) => {\n    if (confirm(\"Are you sure you want to delete this geofence?\")) {\n      deleteMutation.mutate(id);\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <Card>\n        <CardHeader>\n          <CardTitle>Service Areas</CardTitle>\n          <CardDescription>Loading geofences...</CardDescription>\n        </CardHeader>\n      </Card>\n    );\n  }\n\n  return (\n    <div className=\"space-y-4\" data-testid=\"geofence-manager\">\n      <Card>\n        <CardHeader>\n          <div className=\"flex items-center justify-between gap-2\">\n            <div>\n              <CardTitle>Service Areas</CardTitle>\n              <CardDescription>\n                Manage your service areas where cleaners can accept jobs\n              </CardDescription>\n            </div>\n            <Button onClick={handleOpenCreate} size=\"sm\" data-testid=\"button-create-geofence\">\n              <Plus className=\"h-4 w-4 mr-2\" />\n              Add Area\n            </Button>\n          </div>\n        </CardHeader>\n        <CardContent>\n          {!geofences || geofences.length === 0 ? (\n            <div className=\"text-center py-8 text-muted-foreground\">\n              <MapPin className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\n              <p>No service areas defined yet</p>\n              <p className=\"text-sm\">Create your first service area to get started</p>\n            </div>\n          ) : (\n            <div className=\"space-y-2\">\n              {geofences.map((geofence) => (\n                <div\n                  key={geofence.id}\n                  className=\"flex items-center justify-between p-3 border rounded-md hover-elevate\"\n                  data-testid={`geofence-item-${geofence.id}`}\n                >\n                  <div className=\"flex items-center gap-3\">\n                    <MapPin className=\"h-5 w-5 text-muted-foreground\" />\n                    <div>\n                      <p className=\"font-medium\" data-testid={`text-geofence-name-${geofence.id}`}>\n                        {geofence.name}\n                      </p>\n                      <p className=\"text-sm text-muted-foreground\">\n                        {(geofence.polygon as Array<[number, number]>).length} points\n                      </p>\n                    </div>\n                  </div>\n                  <div className=\"flex items-center gap-2\">\n                    <Button\n                      variant=\"outline\"\n                      size=\"sm\"\n                      onClick={() => handleOpenEdit(geofence)}\n                      data-testid={`button-edit-${geofence.id}`}\n                    >\n                      <Edit className=\"h-4 w-4\" />\n                    </Button>\n                    <Button\n                      variant=\"outline\"\n                      size=\"sm\"\n                      onClick={() => handleDelete(geofence.id)}\n                      disabled={deleteMutation.isPending}\n                      data-testid={`button-delete-${geofence.id}`}\n                    >\n                      <Trash2 className=\"h-4 w-4\" />\n                    </Button>\n                  </div>\n                </div>\n              ))}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>\n        <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>\n              {editingGeofence ? \"Edit Service Area\" : \"Create Service Area\"}\n            </DialogTitle>\n            <DialogDescription>\n              {editingGeofence \n                ? \"Update the name or boundaries of your service area\"\n                : \"Define a new service area where your cleaners can accept jobs\"\n              }\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div>\n              <Label htmlFor=\"geofence-name\">Area Name</Label>\n              <Input\n                id=\"geofence-name\"\n                placeholder=\"e.g., Downtown Dubai, Marina District\"\n                value={geofenceName}\n                onChange={(e) => setGeofenceName(e.target.value)}\n                data-testid=\"input-geofence-name\"\n              />\n            </div>\n            <div>\n              <Label>Service Area Boundaries</Label>\n              <div className=\"mt-2\">\n                <GeofenceEditor\n                  initialGeofence={geofencePolygon || undefined}\n                  onSave={setGeofencePolygon}\n                  centerPosition={[25.2048, 55.2708]}\n                />\n              </div>\n            </div>\n            <div className=\"flex justify-end gap-2\">\n              <Button\n                variant=\"outline\"\n                onClick={handleCloseDialog}\n                data-testid=\"button-cancel\"\n              >\n                Cancel\n              </Button>\n              <Button\n                onClick={handleSave}\n                disabled={createMutation.isPending || updateMutation.isPending}\n                data-testid=\"button-save-geofence\"\n              >\n                {createMutation.isPending || updateMutation.isPending ? \"Saving...\" : \"Save\"}\n              </Button>\n            </div>\n          </div>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":10404,"size_tokens":null},"client/src/components/pwa-install-prompt.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Download, X } from \"lucide-react\";\n\ninterface BeforeInstallPromptEvent extends Event {\n  readonly platforms: string[];\n  readonly userChoice: Promise<{\n    outcome: \"accepted\" | \"dismissed\";\n    platform: string;\n  }>;\n  prompt(): Promise<void>;\n}\n\nexport function PWAInstallPrompt() {\n  const [deferredPrompt, setDeferredPrompt] = useState<BeforeInstallPromptEvent | null>(null);\n  const [showPrompt, setShowPrompt] = useState(false);\n  const [isInstalled, setIsInstalled] = useState(false);\n\n  useEffect(() => {\n    if (window.matchMedia('(display-mode: standalone)').matches) {\n      setIsInstalled(true);\n      return;\n    }\n\n    const dismissed = localStorage.getItem('pwa-install-dismissed');\n    if (dismissed) {\n      const dismissedTime = parseInt(dismissed);\n      const daysSinceDismissed = (Date.now() - dismissedTime) / (1000 * 60 * 60 * 24);\n      if (daysSinceDismissed < 7) {\n        return;\n      }\n    }\n\n    const handler = (e: Event) => {\n      e.preventDefault();\n      const promptEvent = e as BeforeInstallPromptEvent;\n      setDeferredPrompt(promptEvent);\n      setShowPrompt(true);\n    };\n\n    window.addEventListener('beforeinstallprompt', handler);\n\n    return () => {\n      window.removeEventListener('beforeinstallprompt', handler);\n    };\n  }, []);\n\n  const handleInstall = async () => {\n    if (!deferredPrompt) return;\n\n    deferredPrompt.prompt();\n    const { outcome } = await deferredPrompt.userChoice;\n\n    if (outcome === 'accepted') {\n      setShowPrompt(false);\n      setIsInstalled(true);\n    }\n    setDeferredPrompt(null);\n  };\n\n  const handleDismiss = () => {\n    setShowPrompt(false);\n    localStorage.setItem('pwa-install-dismissed', Date.now().toString());\n  };\n\n  if (isInstalled || !showPrompt) {\n    return null;\n  }\n\n  return (\n    <div className=\"fixed bottom-4 left-4 right-4 md:left-auto md:right-4 md:max-w-md z-50 animate-in slide-in-from-bottom-5\" data-testid=\"pwa-install-prompt\">\n      <Card className=\"border-2 shadow-lg\">\n        <CardContent className=\"p-4\">\n          <div className=\"flex items-start gap-3\">\n            <div className=\"flex-1\">\n              <h3 className=\"font-semibold text-sm mb-1\" data-testid=\"text-pwa-title\">\n                Install Washapp.ae\n              </h3>\n              <p className=\"text-xs text-muted-foreground mb-3\" data-testid=\"text-pwa-description\">\n                Install our app for a faster experience and easy access from your home screen\n              </p>\n              <div className=\"flex gap-2\">\n                <Button\n                  onClick={handleInstall}\n                  size=\"sm\"\n                  className=\"flex-1\"\n                  data-testid=\"button-install-pwa\"\n                >\n                  <Download className=\"w-4 h-4 mr-2\" />\n                  Install\n                </Button>\n                <Button\n                  onClick={handleDismiss}\n                  variant=\"outline\"\n                  size=\"sm\"\n                  data-testid=\"button-dismiss-pwa\"\n                >\n                  Later\n                </Button>\n              </div>\n            </div>\n            <button\n              onClick={handleDismiss}\n              className=\"text-muted-foreground hover-elevate p-1 rounded-sm\"\n              data-testid=\"button-close-pwa\"\n            >\n              <X className=\"w-4 h-4\" />\n            </button>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":3591,"size_tokens":null},"client/src/hooks/use-websocket.ts":{"content":"import { useEffect, useRef, useState, useCallback } from 'react';\n\ninterface UseWebSocketOptions {\n  onMessage?: (data: any) => void;\n  onOpen?: () => void;\n  onClose?: () => void;\n  onError?: (error: Event) => void;\n  reconnectInterval?: number;\n  maxReconnectAttempts?: number;\n}\n\nexport function useWebSocket(options: UseWebSocketOptions = {}) {\n  const {\n    onMessage,\n    onOpen,\n    onClose,\n    onError,\n    reconnectInterval = 3000,\n    maxReconnectAttempts = 5,\n  } = options;\n\n  const wsRef = useRef<WebSocket | null>(null);\n  const reconnectAttempts = useRef(0);\n  const reconnectTimeoutRef = useRef<NodeJS.Timeout>();\n  const [isConnected, setIsConnected] = useState(false);\n\n  const connect = useCallback(() => {\n    if (wsRef.current?.readyState === WebSocket.OPEN) {\n      return;\n    }\n\n    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';\n    const wsUrl = `${protocol}//${window.location.host}/ws`;\n\n    try {\n      const ws = new WebSocket(wsUrl);\n\n      ws.onopen = () => {\n        setIsConnected(true);\n        reconnectAttempts.current = 0;\n        onOpen?.();\n      };\n\n      ws.onmessage = (event) => {\n        try {\n          const data = JSON.parse(event.data);\n          onMessage?.(data);\n        } catch (error) {\n          console.error('WebSocket message parse error:', error);\n        }\n      };\n\n      ws.onclose = () => {\n        setIsConnected(false);\n        onClose?.();\n\n        if (reconnectAttempts.current < maxReconnectAttempts) {\n          reconnectTimeoutRef.current = setTimeout(() => {\n            reconnectAttempts.current++;\n            connect();\n          }, reconnectInterval);\n        }\n      };\n\n      ws.onerror = (error) => {\n        console.error('WebSocket error:', error);\n        onError?.(error);\n      };\n\n      wsRef.current = ws;\n    } catch (error) {\n      console.error('WebSocket connection error:', error);\n    }\n  }, [onMessage, onOpen, onClose, onError, reconnectInterval, maxReconnectAttempts]);\n\n  const disconnect = useCallback(() => {\n    if (reconnectTimeoutRef.current) {\n      clearTimeout(reconnectTimeoutRef.current);\n    }\n    if (wsRef.current) {\n      wsRef.current.close();\n      wsRef.current = null;\n    }\n    setIsConnected(false);\n  }, []);\n\n  const subscribe = useCallback((subscription: Record<string, any>) => {\n    if (wsRef.current?.readyState === WebSocket.OPEN) {\n      wsRef.current.send(JSON.stringify({ type: 'subscribe', ...subscription }));\n    }\n  }, []);\n\n  const unsubscribe = useCallback((subscription: Record<string, any>) => {\n    if (wsRef.current?.readyState === WebSocket.OPEN) {\n      wsRef.current.send(JSON.stringify({ type: 'unsubscribe', ...subscription }));\n    }\n  }, []);\n\n  useEffect(() => {\n    connect();\n    return () => {\n      disconnect();\n    };\n  }, [connect, disconnect]);\n\n  return {\n    isConnected,\n    subscribe,\n    unsubscribe,\n    reconnect: connect,\n  };\n}\n","path":null,"size_bytes":2915,"size_tokens":null},"client/src/hooks/use-push-notifications.ts":{"content":"import { useState, useEffect, useCallback } from 'react';\nimport { useToast } from './use-toast';\nimport { apiRequest } from '@/lib/queryClient';\n\ninterface UsePushNotificationsOptions {\n  userId?: number;\n  plateNumber?: string;\n  autoSubscribe?: boolean;\n}\n\nexport function usePushNotifications(options: UsePushNotificationsOptions = {}) {\n  const [permission, setPermission] = useState<NotificationPermission>('default');\n  const [isSubscribed, setIsSubscribed] = useState(false);\n  const [soundEnabled, setSoundEnabled] = useState(false);\n  const [isLoading, setIsLoading] = useState(false);\n  const [isSupported, setIsSupported] = useState(false);\n  const { toast } = useToast();\n\n  useEffect(() => {\n    // Check if push notifications are supported\n    const supported = \n      'Notification' in window && \n      'serviceWorker' in navigator && \n      'PushManager' in window;\n    \n    setIsSupported(supported);\n    \n    if (supported) {\n      setPermission(Notification.permission);\n    }\n  }, []);\n\n  useEffect(() => {\n    checkSubscription();\n    fetchSoundPreference();\n  }, []);\n\n  const fetchSoundPreference = useCallback(async () => {\n    if (!('serviceWorker' in navigator) || !('PushManager' in window)) {\n      return;\n    }\n\n    try {\n      const registration = await navigator.serviceWorker.ready;\n      const subscription = await registration.pushManager.getSubscription();\n      \n      if (subscription) {\n        const subscriptionData = subscription.toJSON();\n        const response = await fetch(`/api/push/settings?endpoint=${encodeURIComponent(subscriptionData.endpoint!)}`);\n        \n        if (response.ok) {\n          const data = await response.json();\n          setSoundEnabled(data.soundEnabled === 1);\n        }\n      }\n    } catch (error) {\n      console.error('Error fetching sound preference:', error);\n    }\n  }, []);\n\n  const checkSubscription = useCallback(async () => {\n    if (!('serviceWorker' in navigator) || !('PushManager' in window)) {\n      return;\n    }\n\n    try {\n      const registration = await navigator.serviceWorker.ready;\n      const subscription = await registration.pushManager.getSubscription();\n      setIsSubscribed(!!subscription);\n    } catch (error) {\n      console.error('Error checking subscription:', error);\n    }\n  }, []);\n\n  const subscribe = useCallback(async () => {\n    if (!('serviceWorker' in navigator) || !('PushManager' in window)) {\n      // Detect iOS Safari\n      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);\n      const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);\n      \n      let description = 'Push notifications are not supported in this browser';\n      \n      if (isIOS) {\n        description = 'For iOS: Install this app to your home screen to enable notifications';\n      } else if (isSafari) {\n        description = 'Safari requires installing the app to home screen for notifications';\n      }\n      \n      toast({\n        title: 'Not Supported',\n        description,\n        variant: 'destructive',\n      });\n      return false;\n    }\n\n    setIsLoading(true);\n\n    try {\n      const perm = await Notification.requestPermission();\n      setPermission(perm);\n\n      if (perm !== 'granted') {\n        toast({\n          title: 'Permission Denied',\n          description: 'Please enable notifications to receive updates',\n          variant: 'destructive',\n        });\n        setIsLoading(false);\n        return false;\n      }\n\n      const registration = await navigator.serviceWorker.ready;\n\n      const publicKeyResponse = await fetch('/api/push/vapid-public-key');\n      const { publicKey } = await publicKeyResponse.json();\n\n      const subscription = await registration.pushManager.subscribe({\n        userVisibleOnly: true,\n        applicationServerKey: urlBase64ToUint8Array(publicKey),\n      });\n\n      const subscriptionData = subscription.toJSON();\n\n      await apiRequest('POST', '/api/push/subscribe', {\n        endpoint: subscriptionData.endpoint,\n        keys: subscriptionData.keys,\n        plateNumber: options.plateNumber,\n        soundEnabled: soundEnabled ? 1 : 0,\n      });\n\n      setIsSubscribed(true);\n      \n      // Sync sound preference from backend after subscribing\n      await fetchSoundPreference();\n      \n      toast({\n        title: 'Notifications Enabled',\n        description: \"You'll receive updates about your jobs\",\n      });\n\n      setIsLoading(false);\n      return true;\n    } catch (error) {\n      console.error('Error subscribing to push notifications:', error);\n      toast({\n        title: 'Subscription Failed',\n        description: 'Could not enable push notifications',\n        variant: 'destructive',\n      });\n      setIsLoading(false);\n      return false;\n    }\n  }, [options.plateNumber, soundEnabled, toast, fetchSoundPreference]);\n\n  const unsubscribe = useCallback(async () => {\n    if (!('serviceWorker' in navigator) || !('PushManager' in window)) {\n      return false;\n    }\n\n    setIsLoading(true);\n\n    try {\n      const registration = await navigator.serviceWorker.ready;\n      const subscription = await registration.pushManager.getSubscription();\n\n      if (subscription) {\n        const subscriptionData = subscription.toJSON();\n        \n        await apiRequest('POST', '/api/push/unsubscribe', {\n          endpoint: subscriptionData.endpoint,\n        });\n\n        await subscription.unsubscribe();\n      }\n\n      setIsSubscribed(false);\n      toast({\n        title: 'Notifications Disabled',\n        description: 'You will no longer receive push notifications',\n      });\n\n      setIsLoading(false);\n      return true;\n    } catch (error) {\n      console.error('Error unsubscribing from push notifications:', error);\n      toast({\n        title: 'Unsubscribe Failed',\n        description: 'Could not disable push notifications',\n        variant: 'destructive',\n      });\n      setIsLoading(false);\n      return false;\n    }\n  }, [toast]);\n\n  useEffect(() => {\n    if (options.autoSubscribe && permission === 'default' && !isSubscribed) {\n      subscribe();\n    }\n  }, [options.autoSubscribe, permission, isSubscribed, subscribe]);\n\n  const toggleSound = useCallback(async () => {\n    if (!isSubscribed) {\n      return false;\n    }\n\n    setIsLoading(true);\n\n    try {\n      const registration = await navigator.serviceWorker.ready;\n      const subscription = await registration.pushManager.getSubscription();\n\n      if (subscription) {\n        const subscriptionData = subscription.toJSON();\n        const newSoundEnabled = !soundEnabled;\n        \n        await apiRequest('POST', '/api/push/update-sound', {\n          endpoint: subscriptionData.endpoint,\n          soundEnabled: newSoundEnabled ? 1 : 0,\n        });\n\n        setSoundEnabled(newSoundEnabled);\n        toast({\n          title: newSoundEnabled ? 'Sound Enabled' : 'Sound Disabled',\n          description: newSoundEnabled \n            ? 'You will hear a sound with notifications' \n            : 'Notifications will be silent',\n        });\n      }\n\n      setIsLoading(false);\n      return true;\n    } catch (error) {\n      console.error('Error toggling sound:', error);\n      toast({\n        title: 'Update Failed',\n        description: 'Could not update sound preference',\n        variant: 'destructive',\n      });\n      setIsLoading(false);\n      return false;\n    }\n  }, [isSubscribed, soundEnabled, toast]);\n\n  return {\n    permission,\n    isSubscribed,\n    soundEnabled,\n    isLoading,\n    isSupported,\n    subscribe,\n    unsubscribe,\n    toggleSound,\n  };\n}\n\nfunction urlBase64ToUint8Array(base64String: string): Uint8Array {\n  const padding = '='.repeat((4 - (base64String.length % 4)) % 4);\n  const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');\n\n  const rawData = window.atob(base64);\n  const outputArray = new Uint8Array(rawData.length);\n\n  for (let i = 0; i < rawData.length; ++i) {\n    outputArray[i] = rawData.charCodeAt(i);\n  }\n  return outputArray;\n}\n","path":null,"size_bytes":7947,"size_tokens":null},"server/push-service.ts":{"content":"import webpush from 'web-push';\nimport { storage } from './storage';\nimport { JobStatus } from '@shared/schema';\n\nconst VAPID_PUBLIC_KEY = process.env.VAPID_PUBLIC_KEY || '';\nconst VAPID_PRIVATE_KEY = process.env.VAPID_PRIVATE_KEY || '';\nconst VAPID_SUBJECT = process.env.VAPID_SUBJECT || 'mailto:noreply@carwashpro.com';\n\nwebpush.setVapidDetails(\n  VAPID_SUBJECT,\n  VAPID_PUBLIC_KEY,\n  VAPID_PRIVATE_KEY\n);\n\ninterface PushNotificationPayload {\n  title: string;\n  body: string;\n  icon?: string;\n  badge?: string;\n  data?: any;\n  tag?: string;\n  requireInteraction?: boolean;\n}\n\nexport class PushNotificationService {\n  static async sendToUser(userId: number, payload: PushNotificationPayload): Promise<void> {\n    try {\n      const subscriptions = await storage.getUserPushSubscriptions(userId);\n      console.log(`[Push] User #${userId} has ${subscriptions.length} subscription(s)`);\n      \n      if (subscriptions.length === 0) {\n        console.log(`[Push] No active subscriptions for user #${userId} - notification not sent`);\n        return;\n      }\n      \n      const results = await Promise.allSettled(subscriptions.map(async (sub) => {\n        try {\n          const payloadWithSound = {\n            ...payload,\n            playSound: sub.soundEnabled === 1,\n          };\n          \n          await webpush.sendNotification(\n            {\n              endpoint: sub.endpoint,\n              keys: sub.keys,\n            },\n            JSON.stringify(payloadWithSound)\n          );\n          return { success: true, endpoint: sub.endpoint };\n        } catch (error: any) {\n          // Clean up stale subscriptions (410 Gone, 404 Not Found)\n          if (error.statusCode === 410 || error.statusCode === 404) {\n            console.log(`[Push] Removing stale subscription for user #${userId}: ${error.statusCode}`);\n            await storage.deletePushSubscription(sub.endpoint);\n            return { success: false, endpoint: sub.endpoint, reason: 'stale', statusCode: error.statusCode };\n          }\n          \n          // Log structured error for other failures (network, rate limits, etc.)\n          console.error(`[Push] Failed to send to user #${userId}:`, {\n            endpoint: sub.endpoint.substring(0, 50) + '...',\n            statusCode: error.statusCode,\n            message: error.message,\n            type: error.name,\n          });\n          return { success: false, endpoint: sub.endpoint, reason: 'error', statusCode: error.statusCode };\n        }\n      }));\n\n      // Log delivery summary\n      const successCount = results.filter(r => r.status === 'fulfilled' && r.value.success).length;\n      const staleCount = results.filter(r => r.status === 'fulfilled' && r.value.reason === 'stale').length;\n      const errorCount = results.filter(r => r.status === 'fulfilled' && r.value.reason === 'error').length;\n      \n      console.log(`[Push] Delivery summary for user #${userId}: ${successCount} sent, ${staleCount} stale removed, ${errorCount} failed`);\n    } catch (error) {\n      console.error('[Push] Critical error sending to user:', error);\n    }\n  }\n\n  static async sendToCustomer(customerId: number, payload: PushNotificationPayload): Promise<void> {\n    try {\n      const subscriptions = await storage.getCustomerPushSubscriptions(customerId);\n      console.log(`[Push] Customer #${customerId} has ${subscriptions.length} subscription(s)`);\n      \n      if (subscriptions.length === 0) {\n        console.log(`[Push] No active subscriptions for customer #${customerId} - notification not sent`);\n        return;\n      }\n      \n      const promises = subscriptions.map(async (sub) => {\n        try {\n          const payloadWithSound = {\n            ...payload,\n            playSound: sub.soundEnabled === 1,\n          };\n          \n          await webpush.sendNotification(\n            {\n              endpoint: sub.endpoint,\n              keys: sub.keys,\n            },\n            JSON.stringify(payloadWithSound)\n          );\n        } catch (error: any) {\n          if (error.statusCode === 410 || error.statusCode === 404) {\n            await storage.deletePushSubscription(sub.endpoint);\n          } else {\n            console.error(`Failed to send push notification to endpoint ${sub.endpoint}:`, error);\n          }\n        }\n      });\n\n      await Promise.allSettled(promises);\n    } catch (error) {\n      console.error('Error sending push notification to customer:', error);\n    }\n  }\n\n  static async sendToRole(role: string, payload: PushNotificationPayload): Promise<void> {\n    try {\n      const subscriptions = await storage.getAllPushSubscriptionsByRole(role);\n      \n      const promises = subscriptions.map(async (sub) => {\n        try {\n          const payloadWithSound = {\n            ...payload,\n            playSound: sub.soundEnabled === 1,\n          };\n          \n          await webpush.sendNotification(\n            {\n              endpoint: sub.endpoint,\n              keys: sub.keys,\n            },\n            JSON.stringify(payloadWithSound)\n          );\n        } catch (error: any) {\n          if (error.statusCode === 410 || error.statusCode === 404) {\n            await storage.deletePushSubscription(sub.endpoint);\n          } else {\n            console.error(`Failed to send push notification to endpoint ${sub.endpoint}:`, error);\n          }\n        }\n      });\n\n      await Promise.allSettled(promises);\n    } catch (error) {\n      console.error('Error sending push notification to role:', error);\n    }\n  }\n\n  static async notifyJobStatusChange(jobId: number, newStatus: JobStatus, context: {\n    carPlateNumber?: string;\n    cleanerName?: string;\n    companyName?: string;\n    customerPhone?: string;\n    customerId?: number;\n    cleanerId?: number;\n    userId?: number;\n  }): Promise<void> {\n    console.log(`[Push] Job status change: Job #${jobId} → ${newStatus}, customerId: ${context.customerId || 'none'}`);\n    \n    let payload: PushNotificationPayload | null = null;\n\n    switch (newStatus) {\n      case JobStatus.PAID:\n        payload = {\n          title: 'Payment Received',\n          body: `Your payment for ${context.carPlateNumber} has been confirmed. Looking for available cleaners...`,\n          icon: '/icon-192.png',\n          tag: `job-${jobId}`,\n          data: { jobId, type: 'job_status_change', status: newStatus },\n        };\n        if (context.customerId) {\n          console.log(`[Push] Sending PAID notification to customer #${context.customerId}`);\n          await this.sendToCustomer(context.customerId, payload);\n        } else {\n          console.log(`[Push] Skipping PAID notification - no customerId`);\n        }\n        break;\n\n      case JobStatus.ASSIGNED:\n        payload = {\n          title: 'Cleaner Assigned!',\n          body: `${context.cleanerName} will wash your car ${context.carPlateNumber}`,\n          icon: '/icon-192.png',\n          tag: `job-${jobId}`,\n          data: { jobId, type: 'job_status_change', status: newStatus, url: `/customer/track/${context.carPlateNumber}` },\n          requireInteraction: true,\n        };\n        if (context.customerId) {\n          console.log(`[Push] Sending ASSIGNED notification to customer #${context.customerId}`);\n          await this.sendToCustomer(context.customerId, payload);\n        } else {\n          console.log(`[Push] Skipping ASSIGNED notification - no customerId`);\n        }\n        break;\n\n      case JobStatus.IN_PROGRESS:\n        payload = {\n          title: 'Wash Started',\n          body: `${context.cleanerName} has started washing your car`,\n          icon: '/icon-192.png',\n          tag: `job-${jobId}`,\n          data: { jobId, type: 'job_status_change', status: newStatus, url: `/customer/track/${context.carPlateNumber}` },\n        };\n        if (context.customerId) {\n          console.log(`[Push] Sending IN_PROGRESS notification to customer #${context.customerId}`);\n          await this.sendToCustomer(context.customerId, payload);\n        } else {\n          console.log(`[Push] Skipping IN_PROGRESS notification - no customerId`);\n        }\n        break;\n\n      case JobStatus.COMPLETED:\n        payload = {\n          title: 'Wash Complete!',\n          body: `Your car ${context.carPlateNumber} is ready! Please rate your experience`,\n          icon: '/icon-192.png',\n          tag: `job-${jobId}`,\n          data: { jobId, type: 'job_status_change', status: newStatus, url: `/customer/track/${context.carPlateNumber}` },\n          requireInteraction: true,\n        };\n        if (context.customerId) {\n          console.log(`[Push] Sending COMPLETED notification to customer #${context.customerId}`);\n          await this.sendToCustomer(context.customerId, payload);\n        } else {\n          console.log(`[Push] Skipping COMPLETED notification - no customerId`);\n        }\n        break;\n\n      case JobStatus.CANCELLED:\n        payload = {\n          title: 'Job Cancelled',\n          body: `Your car wash for ${context.carPlateNumber} has been cancelled`,\n          icon: '/icon-192.png',\n          tag: `job-${jobId}`,\n          data: { jobId, type: 'job_status_change', status: newStatus },\n        };\n        if (context.customerId) {\n          console.log(`[Push] Sending CANCELLED notification to customer #${context.customerId}`);\n          await this.sendToCustomer(context.customerId, payload);\n        } else {\n          console.log(`[Push] Skipping CANCELLED notification - no customerId`);\n        }\n        break;\n\n      case JobStatus.REFUNDED:\n        payload = {\n          title: 'Refund Processed',\n          body: 'No cleaner was available. Your payment has been refunded',\n          icon: '/icon-192.png',\n          tag: `job-${jobId}`,\n          data: { jobId, type: 'job_status_change', status: newStatus },\n        };\n        if (context.customerId) {\n          console.log(`[Push] Sending REFUNDED notification to customer #${context.customerId}`);\n          await this.sendToCustomer(context.customerId, payload);\n        } else {\n          console.log(`[Push] Skipping REFUNDED notification - no customerId`);\n        }\n        break;\n    }\n  }\n\n  static async notifyNewJobAvailable(jobId: number, context: {\n    carPlateNumber: string;\n    locationAddress: string;\n    price: number;\n    cleanerId?: number;\n    userId?: number;\n  }): Promise<void> {\n    const payload: PushNotificationPayload = {\n      title: 'New Job Available!',\n      body: `Car wash needed for ${context.carPlateNumber} - ${context.locationAddress}`,\n      icon: '/icon-192.png',\n      tag: `new-job-${jobId}`,\n      data: { jobId, type: 'new_job', url: '/cleaner' },\n      requireInteraction: true,\n    };\n\n    if (context.userId) {\n      await this.sendToUser(context.userId, payload);\n    } else if (context.cleanerId) {\n      const cleaner = await storage.getCleaner(context.cleanerId);\n      if (cleaner?.userId) {\n        await this.sendToUser(cleaner.userId, payload);\n      }\n    }\n  }\n\n  static async notifyOnDutyCleaners(jobId: number, companyId: number, context: {\n    carPlateNumber: string;\n    locationAddress: string;\n    price: number;\n    locationLat: number;\n    locationLng: number;\n  }): Promise<void> {\n    try {\n      // Validate coordinates server-side to prevent abuse\n      // Use Number.isFinite to allow 0.0 while rejecting null/undefined/NaN\n      if (!Number.isFinite(context.locationLat) || !Number.isFinite(context.locationLng) ||\n          context.locationLat < -90 || context.locationLat > 90 ||\n          context.locationLng < -180 || context.locationLng > 180) {\n        console.error('[Push] Invalid job coordinates - rejecting notification broadcast:', {\n          jobId,\n          lat: context.locationLat,\n          lng: context.locationLng,\n        });\n        return;\n      }\n      \n      const { db } = await import('./db');\n      const { cleaners, users } = await import('@shared/schema');\n      const { eq, and } = await import('drizzle-orm');\n      \n      // Get all on-duty cleaners for this company (with full cleaner data including location)\n      const onDutyCleaners = await db\n        .select({\n          id: cleaners.id,\n          userId: cleaners.userId,\n          displayName: users.displayName,\n          currentLatitude: cleaners.currentLatitude,\n          currentLongitude: cleaners.currentLongitude,\n          lastLocationUpdate: cleaners.lastLocationUpdate,\n        })\n        .from(cleaners)\n        .innerJoin(users, eq(cleaners.userId, users.id))\n        .where(\n          and(\n            eq(cleaners.companyId, companyId),\n            eq(cleaners.status, 'on_duty')\n          )\n        );\n\n      console.log(`[Push] Found ${onDutyCleaners.length} on-duty cleaners for company #${companyId}`);\n\n      // Filter cleaners by geofence assignment AND current location in parallel to avoid N+1 queries\n      const eligibilityChecks = await Promise.allSettled(\n        onDutyCleaners.map(async (cleaner) => {\n          try {\n            // Validate cleaner has current location data\n            if (!cleaner.currentLatitude || !cleaner.currentLongitude) {\n              console.log(`[Push] Cleaner #${cleaner.id} has no location data - skipping`);\n              return { cleaner, eligible: false };\n            }\n\n            const cleanerLat = parseFloat(cleaner.currentLatitude);\n            const cleanerLng = parseFloat(cleaner.currentLongitude);\n\n            if (isNaN(cleanerLat) || isNaN(cleanerLng)) {\n              console.log(`[Push] Cleaner #${cleaner.id} has invalid location data - skipping`);\n              return { cleaner, eligible: false };\n            }\n\n            // Check if cleaner's location was updated recently (within 10 minutes)\n            if (cleaner.lastLocationUpdate) {\n              const tenMinutesAgo = new Date(Date.now() - 10 * 60 * 1000);\n              const lastUpdate = new Date(cleaner.lastLocationUpdate);\n              if (lastUpdate < tenMinutesAgo) {\n                console.log(`[Push] Cleaner #${cleaner.id} location is stale (last update: ${lastUpdate.toISOString()}) - skipping`);\n                return { cleaner, eligible: false };\n              }\n            }\n\n            const isAssignedToAll = await storage.isCleanerAssignedToAllGeofences(cleaner.id);\n            \n            // Get cleaner's assigned geofences\n            const assignments = await storage.getCleanerGeofenceAssignments(cleaner.id);\n            \n            // Find geofences that contain the job location\n            const jobGeofences = assignments.filter(geofence => {\n              if (!geofence.polygon) return false;\n              return this.isPointInPolygon(\n                context.locationLat,\n                context.locationLng,\n                geofence.polygon\n              );\n            });\n\n            if (jobGeofences.length === 0 && !isAssignedToAll) {\n              console.log(`[Push] Cleaner #${cleaner.id} not assigned to geofence containing job location`);\n              return { cleaner, eligible: false };\n            }\n\n            // CRITICAL CHECK: Verify cleaner's current location is within the SAME geofence as the job\n            // If assigned to all, check against all geofences; otherwise check against job geofences\n            const geofencesToCheck = isAssignedToAll ? assignments : jobGeofences;\n            \n            const cleanerInJobGeofence = geofencesToCheck.some(geofence => {\n              if (!geofence.polygon) return false;\n              return this.isPointInPolygon(cleanerLat, cleanerLng, geofence.polygon);\n            });\n\n            if (!cleanerInJobGeofence) {\n              console.log(`[Push] Cleaner #${cleaner.id} current location (${cleanerLat}, ${cleanerLng}) is NOT within job geofence - skipping`);\n              return { cleaner, eligible: false };\n            }\n\n            console.log(`[Push] Cleaner #${cleaner.id} is eligible - in geofence and assigned`);\n            return { cleaner, eligible: true };\n          } catch (error) {\n            console.error(`[Push] Error checking eligibility for cleaner #${cleaner.id}:`, error);\n            return { cleaner, eligible: false };\n          }\n        })\n      );\n\n      // Extract eligible cleaners from results\n      const eligibleCleaners = eligibilityChecks\n        .filter(result => result.status === 'fulfilled' && result.value.eligible)\n        .map(result => (result as PromiseFulfilledResult<{ cleaner: any; eligible: boolean }>).value.cleaner);\n\n      console.log(`[Push] ${eligibleCleaners.length}/${onDutyCleaners.length} cleaners are eligible for this job`);\n\n      // Send notifications to eligible cleaners\n      const payload: PushNotificationPayload = {\n        title: 'New Job Available!',\n        body: `Car wash needed for ${context.carPlateNumber}`,\n        icon: '/icon-192.png',\n        tag: `new-job-${jobId}`,\n        data: { jobId, type: 'new_job', url: '/cleaner' },\n        requireInteraction: true,\n      };\n\n      const notificationPromises = eligibleCleaners.map(cleaner => \n        this.sendToUser(cleaner.userId, payload)\n      );\n\n      await Promise.allSettled(notificationPromises);\n      \n      if (eligibleCleaners.length > 0) {\n        console.log(`[Push] Sent new job notifications to ${eligibleCleaners.length} cleaners`);\n      }\n    } catch (error) {\n      console.error('[Push] Error notifying on-duty cleaners:', error);\n    }\n  }\n\n  private static isPointInPolygon(lat: number, lng: number, polygon: Array<[number, number]>): boolean {\n    let inside = false;\n    for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {\n      const xi = polygon[i][0], yi = polygon[i][1];\n      const xj = polygon[j][0], yj = polygon[j][1];\n      \n      const intersect = ((yi > lng) !== (yj > lng))\n        && (lat < (xj - xi) * (lng - yi) / (yj - yi) + xi);\n      if (intersect) inside = !inside;\n    }\n    return inside;\n  }\n\n  static async notifyCleanerShiftChange(userId: number, onDuty: boolean): Promise<void> {\n    const payload: PushNotificationPayload = {\n      title: onDuty ? \"You're On Duty\" : 'Shift Ended',\n      body: onDuty ? \"You'll receive job notifications now\" : \"You're now off-duty. Great work today!\",\n      icon: '/icon-192.png',\n      tag: 'shift-change',\n      data: { type: 'shift_change', onDuty },\n    };\n\n    await this.sendToUser(userId, payload);\n  }\n}\n\nexport const pushService = new PushNotificationService();\n","path":null,"size_bytes":18287,"size_tokens":null},"client/src/lib/notification-sound.ts":{"content":"let audioContext: AudioContext | null = null;\n\nexport function playNotificationSound() {\n  try {\n    if (!audioContext) {\n      audioContext = new (window.AudioContext || (window as any).webkitAudioContext)();\n    }\n\n    const oscillator = audioContext.createOscillator();\n    const gainNode = audioContext.createGain();\n\n    oscillator.connect(gainNode);\n    gainNode.connect(audioContext.destination);\n\n    oscillator.frequency.value = 800;\n    oscillator.type = 'sine';\n\n    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);\n    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);\n\n    oscillator.start(audioContext.currentTime);\n    oscillator.stop(audioContext.currentTime + 0.3);\n  } catch (error) {\n    console.error('Failed to play notification sound:', error);\n  }\n}\n\nexport function initNotificationSoundListener() {\n  if ('serviceWorker' in navigator) {\n    navigator.serviceWorker.addEventListener('message', (event) => {\n      if (event.data && event.data.type === 'PLAY_NOTIFICATION_SOUND') {\n        playNotificationSound();\n      }\n    });\n  }\n}\n","path":null,"size_bytes":1103,"size_tokens":null},"client/public/sw.js":{"content":"const CACHE_NAME = 'carwash-pro-v3';\nconst VERSION_CHECK_INTERVAL = 60000;\nconst urlsToCache = [\n  '/',\n  '/index.html',\n  '/icon-192.png',\n  '/icon-512.png',\n];\n\nlet currentVersion = null;\n\nasync function checkVersion() {\n  try {\n    const response = await fetch('/version.json', { cache: 'no-store' });\n    const data = await response.json();\n    \n    if (currentVersion === null) {\n      currentVersion = data.buildTimestamp;\n      return false;\n    }\n    \n    if (data.buildTimestamp !== currentVersion) {\n      console.log('New version detected, clearing caches and reloading');\n      await clearAllCaches();\n      currentVersion = data.buildTimestamp;\n      \n      const clients = await self.clients.matchAll();\n      clients.forEach(client => {\n        client.postMessage({ type: 'NEW_VERSION_AVAILABLE' });\n      });\n      \n      return true;\n    }\n    \n    return false;\n  } catch (error) {\n    console.error('Version check failed:', error);\n    return false;\n  }\n}\n\nasync function clearAllCaches() {\n  const cacheNames = await caches.keys();\n  await Promise.all(cacheNames.map(name => caches.delete(name)));\n}\n\nsetInterval(checkVersion, VERSION_CHECK_INTERVAL);\n\nself.addEventListener('install', (event) => {\n  event.waitUntil(\n    Promise.all([\n      caches.open(CACHE_NAME).then((cache) => cache.addAll(urlsToCache)),\n      checkVersion()\n    ])\n  );\n  self.skipWaiting();\n});\n\nself.addEventListener('activate', (event) => {\n  event.waitUntil(\n    Promise.all([\n      caches.keys().then((cacheNames) => {\n        return Promise.all(\n          cacheNames.map((cacheName) => {\n            if (cacheName !== CACHE_NAME) {\n              return caches.delete(cacheName);\n            }\n          })\n        );\n      }),\n      checkVersion()\n    ])\n  );\n  self.clients.claim();\n});\n\nself.addEventListener('fetch', (event) => {\n  const url = new URL(event.request.url);\n  \n  // NEVER cache API requests - always fetch fresh data\n  if (url.pathname.startsWith('/api/')) {\n    event.respondWith(fetch(event.request));\n    return;\n  }\n  \n  // NEVER cache WebSocket requests\n  if (url.pathname.startsWith('/ws')) {\n    event.respondWith(fetch(event.request));\n    return;\n  }\n  \n  // Only cache static assets\n  event.respondWith(\n    caches.match(event.request)\n      .then((response) => {\n        if (response) {\n          return response;\n        }\n        return fetch(event.request).then((response) => {\n          if (!response || response.status !== 200 || response.type !== 'basic') {\n            return response;\n          }\n          const responseToCache = response.clone();\n          caches.open(CACHE_NAME)\n            .then((cache) => {\n              cache.put(event.request, responseToCache);\n            });\n          return response;\n        });\n      })\n  );\n});\n\nself.addEventListener('push', (event) => {\n  const data = event.data ? event.data.json() : {};\n  const title = data.title || 'Washapp.ae';\n  const options = {\n    body: data.body || 'You have a new notification',\n    icon: '/icon-192.png',\n    badge: '/icon-192.png',\n    data: data.data || {},\n    tag: data.tag || 'default',\n    requireInteraction: data.requireInteraction || false,\n    silent: !data.playSound,\n  };\n\n  event.waitUntil(\n    Promise.all([\n      self.registration.showNotification(title, options),\n      data.playSound ? playNotificationSound() : Promise.resolve(),\n    ])\n  );\n});\n\nfunction playNotificationSound() {\n  return clients.matchAll({ type: 'window', includeUncontrolled: true })\n    .then((clientList) => {\n      if (clientList.length > 0) {\n        clientList.forEach((client) => {\n          client.postMessage({\n            type: 'PLAY_NOTIFICATION_SOUND',\n          });\n        });\n      }\n    })\n    .catch((error) => {\n      console.error('Error playing notification sound:', error);\n    });\n}\n\nself.addEventListener('notificationclick', (event) => {\n  event.notification.close();\n\n  event.waitUntil(\n    clients.matchAll({ type: 'window', includeUncontrolled: true })\n      .then((clientList) => {\n        const data = event.notification.data || {};\n        const urlToOpen = data.url || '/';\n\n        for (let i = 0; i < clientList.length; i++) {\n          const client = clientList[i];\n          if (client.url === urlToOpen && 'focus' in client) {\n            return client.focus();\n          }\n        }\n\n        if (clients.openWindow) {\n          return clients.openWindow(urlToOpen);\n        }\n      })\n  );\n});\n","path":null,"size_bytes":4434,"size_tokens":null},"client/src/pages/company-shift-history.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Link } from \"wouter\";\nimport { ArrowLeft, Download, Calendar, Clock } from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport ExcelJS from \"exceljs\";\n\ntype CleanerWithUser = {\n  id: number;\n  userId: number;\n  displayName: string | null;\n  email: string | null;\n};\n\ntype ShiftHistoryItem = {\n  id: number;\n  cleanerId: number;\n  companyId: number;\n  shiftStart: string;\n  shiftEnd: string | null;\n  durationMinutes: number | null;\n  cleanerName: string;\n  startLatitude: number | null;\n  startLongitude: number | null;\n  endLatitude: number | null;\n  endLongitude: number | null;\n};\n\nexport default function CompanyShiftHistory() {\n  const { currentUser } = useAuth();\n  const [selectedCleanerId, setSelectedCleanerId] = useState<string>(\"all\");\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [startDate, setStartDate] = useState(\"\");\n  const [endDate, setEndDate] = useState(\"\");\n\n  // Fetch cleaners\n  const { data: cleaners = [] } = useQuery<CleanerWithUser[]>({\n    queryKey: [\"/api/company/cleaners\"],\n    enabled: !!currentUser?.companyId,\n  });\n\n  // Fetch shift history with proper query construction\n  const { data: shiftHistory = [], isLoading } = useQuery<ShiftHistoryItem[]>({\n    queryKey: [\"/api/company/shift-history\", selectedCleanerId, startDate, endDate],\n    queryFn: async () => {\n      const params = new URLSearchParams();\n      if (selectedCleanerId !== \"all\") {\n        params.append(\"cleanerId\", selectedCleanerId);\n      }\n      if (startDate) {\n        params.append(\"startDate\", startDate);\n      }\n      if (endDate) {\n        params.append(\"endDate\", endDate);\n      }\n      \n      const url = `/api/company/shift-history${params.toString() ? `?${params.toString()}` : \"\"}`;\n      const response = await fetch(url, { credentials: \"include\" });\n      if (!response.ok) throw new Error(\"Failed to fetch shift history\");\n      return response.json();\n    },\n    enabled: !!currentUser?.companyId,\n  });\n\n  // Filter by search query (cleaner name)\n  const filteredShifts = shiftHistory.filter(shift => \n    shift.cleanerName.toLowerCase().includes(searchQuery.toLowerCase())\n  );\n\n  // Export to Excel\n  const exportToExcel = async () => {\n    const workbook = new ExcelJS.Workbook();\n    const worksheet = workbook.addWorksheet(\"Shift History\");\n\n    // Define columns\n    worksheet.columns = [\n      { header: \"Cleaner Name\", key: \"cleanerName\", width: 25 },\n      { header: \"Start Date\", key: \"startDate\", width: 20 },\n      { header: \"Start Time\", key: \"startTime\", width: 15 },\n      { header: \"End Date\", key: \"endDate\", width: 20 },\n      { header: \"End Time\", key: \"endTime\", width: 15 },\n      { header: \"Duration (Hours)\", key: \"duration\", width: 18 },\n      { header: \"Status\", key: \"status\", width: 12 },\n    ];\n\n    // Add data\n    filteredShifts.forEach(shift => {\n      const startDate = new Date(shift.shiftStart);\n      const endDate = shift.shiftEnd ? new Date(shift.shiftEnd) : null;\n      const durationHours = shift.durationMinutes ? (shift.durationMinutes / 60).toFixed(2) : \"Ongoing\";\n\n      worksheet.addRow({\n        cleanerName: shift.cleanerName || `Cleaner #${shift.cleanerId}`,\n        startDate: format(startDate, \"PPP\"),\n        startTime: format(startDate, \"p\"),\n        endDate: endDate ? format(endDate, \"PPP\") : \"-\",\n        endTime: endDate ? format(endDate, \"p\") : \"-\",\n        duration: durationHours,\n        status: shift.shiftEnd ? \"Completed\" : \"Ongoing\",\n      });\n    });\n\n    // Style header row\n    worksheet.getRow(1).font = { bold: true };\n    worksheet.getRow(1).fill = {\n      type: \"pattern\",\n      pattern: \"solid\",\n      fgColor: { argb: \"FFE0E0E0\" },\n    };\n\n    // Generate file\n    const buffer = await workbook.xlsx.writeBuffer();\n    const blob = new Blob([buffer], {\n      type: \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\",\n    });\n    const url = window.URL.createObjectURL(blob);\n    const link = document.createElement(\"a\");\n    link.href = url;\n    link.download = `shift-history-${format(new Date(), \"yyyy-MM-dd\")}.xlsx`;\n    link.click();\n    window.URL.revokeObjectURL(url);\n  };\n\n  return (\n    <div className=\"min-h-screen bg-background pb-20\">\n      <div className=\"container mx-auto p-4 max-w-7xl\">\n        {/* Header */}\n        <div className=\"flex items-center gap-4 mb-6\">\n          <Link href=\"/company\">\n            <Button variant=\"ghost\" size=\"icon\" data-testid=\"button-back\">\n              <ArrowLeft className=\"h-5 w-5\" />\n            </Button>\n          </Link>\n          <div className=\"flex-1\">\n            <h1 className=\"text-3xl font-bold\">Shift History</h1>\n            <p className=\"text-muted-foreground\">\n              View and export shift records for your cleaners\n            </p>\n          </div>\n          <Button \n            onClick={exportToExcel}\n            disabled={filteredShifts.length === 0}\n            data-testid=\"button-export-excel\"\n          >\n            <Download className=\"mr-2 h-4 w-4\" />\n            Export to Excel\n          </Button>\n        </div>\n\n        {/* Filters Card */}\n        <Card className=\"mb-6\">\n          <CardHeader>\n            <CardTitle>Filters</CardTitle>\n            <CardDescription>Filter shift history by cleaner, date range, and name</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-4\">\n              {/* Cleaner Select */}\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"cleaner-filter\">Cleaner</Label>\n                <Select value={selectedCleanerId} onValueChange={setSelectedCleanerId}>\n                  <SelectTrigger id=\"cleaner-filter\" data-testid=\"select-cleaner-filter\">\n                    <SelectValue placeholder=\"All Cleaners\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"all\">All Cleaners</SelectItem>\n                    {cleaners.map((cleaner) => (\n                      <SelectItem key={cleaner.id} value={cleaner.id.toString()}>\n                        {cleaner.displayName || cleaner.email || `Cleaner #${cleaner.id}`}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n\n              {/* Start Date */}\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"start-date\">Start Date</Label>\n                <Input\n                  id=\"start-date\"\n                  type=\"date\"\n                  value={startDate}\n                  onChange={(e) => setStartDate(e.target.value)}\n                  data-testid=\"input-start-date\"\n                />\n              </div>\n\n              {/* End Date */}\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"end-date\">End Date</Label>\n                <Input\n                  id=\"end-date\"\n                  type=\"date\"\n                  value={endDate}\n                  onChange={(e) => setEndDate(e.target.value)}\n                  data-testid=\"input-end-date\"\n                />\n              </div>\n\n              {/* Search by Name */}\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"search-name\">Search Name</Label>\n                <Input\n                  id=\"search-name\"\n                  type=\"text\"\n                  placeholder=\"Search cleaner name...\"\n                  value={searchQuery}\n                  onChange={(e) => setSearchQuery(e.target.value)}\n                  data-testid=\"input-search-name\"\n                />\n              </div>\n            </div>\n\n            {/* Clear Filters Button */}\n            <div className=\"mt-4\">\n              <Button\n                variant=\"outline\"\n                onClick={() => {\n                  setSelectedCleanerId(\"all\");\n                  setStartDate(\"\");\n                  setEndDate(\"\");\n                  setSearchQuery(\"\");\n                }}\n                data-testid=\"button-clear-filters\"\n              >\n                Clear All Filters\n              </Button>\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Results Summary */}\n        <div className=\"mb-4 text-sm text-muted-foreground\">\n          Showing {filteredShifts.length} shift{filteredShifts.length !== 1 ? \"s\" : \"\"}\n        </div>\n\n        {/* Shift History Table */}\n        {isLoading ? (\n          <div className=\"space-y-4\">\n            {[1, 2, 3, 4, 5].map((i) => (\n              <Skeleton key={i} className=\"h-16 w-full\" />\n            ))}\n          </div>\n        ) : filteredShifts.length === 0 ? (\n          <Card className=\"p-12 text-center\">\n            <Clock className=\"h-16 w-16 mx-auto text-muted-foreground mb-4\" />\n            <p className=\"text-lg font-medium mb-2\">No Shift History Found</p>\n            <p className=\"text-muted-foreground\">\n              {shiftHistory.length === 0\n                ? \"No shifts have been recorded yet.\"\n                : \"No shifts match your current filters.\"}\n            </p>\n          </Card>\n        ) : (\n          <Card>\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>Date</TableHead>\n                  <TableHead>Cleaner Name</TableHead>\n                  <TableHead>Start Time</TableHead>\n                  <TableHead>End Time</TableHead>\n                  <TableHead>Total Duration</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {filteredShifts.map((shift) => {\n                  const isOngoing = !shift.shiftEnd;\n                  const durationText = shift.durationMinutes != null\n                    ? `${Math.floor(shift.durationMinutes / 60)}h ${shift.durationMinutes % 60}m`\n                    : \"Ongoing\";\n\n                  return (\n                    <TableRow key={shift.id} data-testid={`shift-row-${shift.id}`}>\n                      <TableCell data-testid={`shift-date-${shift.id}`}>\n                        {format(new Date(shift.shiftStart), \"MMM d, yyyy\")}\n                      </TableCell>\n                      <TableCell data-testid={`shift-cleaner-${shift.id}`}>\n                        {shift.cleanerName || `Cleaner #${shift.cleanerId}`}\n                      </TableCell>\n                      <TableCell data-testid={`shift-start-${shift.id}`}>\n                        {format(new Date(shift.shiftStart), \"h:mm a\")}\n                      </TableCell>\n                      <TableCell data-testid={`shift-end-${shift.id}`}>\n                        {shift.shiftEnd ? format(new Date(shift.shiftEnd), \"h:mm a\") : (\n                          <Badge variant=\"default\">Ongoing</Badge>\n                        )}\n                      </TableCell>\n                      <TableCell data-testid={`shift-duration-${shift.id}`}>\n                        {isOngoing ? (\n                          <Badge variant=\"default\">Ongoing</Badge>\n                        ) : (\n                          durationText\n                        )}\n                      </TableCell>\n                    </TableRow>\n                  );\n                })}\n              </TableBody>\n            </Table>\n          </Card>\n        )}\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":11920,"size_tokens":null},"client/src/pages/cleaner-shift-history.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Link } from \"wouter\";\nimport { ArrowLeft, Download, Calendar, Clock, AlertCircle, Timer, CheckCircle2 } from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport ExcelJS from \"exceljs\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\n\ntype ShiftHistoryItem = {\n  id: number;\n  cleanerId: number;\n  companyId: number;\n  shiftStart: string;\n  shiftEnd: string | null;\n  durationMinutes: number | null;\n  startLatitude: number | null;\n  startLongitude: number | null;\n  endLatitude: number | null;\n  endLongitude: number | null;\n};\n\nexport default function CleanerShiftHistory() {\n  const { currentUser } = useAuth();\n  const [startDate, setStartDate] = useState(\"\");\n  const [endDate, setEndDate] = useState(\"\");\n\n  const queryKey = [\"/api/cleaner/shift-history\"];\n  const params = new URLSearchParams();\n  if (startDate) params.append(\"startDate\", startDate);\n  if (endDate) params.append(\"endDate\", endDate);\n  const queryString = params.toString();\n  const fullUrl = queryString ? `${queryKey[0]}?${queryString}` : queryKey[0];\n\n  const { data: shiftHistory = [], isLoading, error } = useQuery<ShiftHistoryItem[]>({\n    queryKey: [fullUrl],\n    enabled: !!currentUser,\n  });\n\n  const exportToExcel = async () => {\n    const workbook = new ExcelJS.Workbook();\n    const worksheet = workbook.addWorksheet(\"My Shift History\");\n\n    worksheet.columns = [\n      { header: \"Start Date\", key: \"startDate\", width: 20 },\n      { header: \"Start Time\", key: \"startTime\", width: 15 },\n      { header: \"End Date\", key: \"endDate\", width: 20 },\n      { header: \"End Time\", key: \"endTime\", width: 15 },\n      { header: \"Duration (Hours)\", key: \"duration\", width: 18 },\n      { header: \"Status\", key: \"status\", width: 12 },\n    ];\n\n    shiftHistory.forEach(shift => {\n      const startDate = new Date(shift.shiftStart);\n      const endDate = shift.shiftEnd ? new Date(shift.shiftEnd) : null;\n      const durationHours = shift.durationMinutes ? (shift.durationMinutes / 60).toFixed(2) : \"Ongoing\";\n\n      worksheet.addRow({\n        startDate: format(startDate, \"PPP\"),\n        startTime: format(startDate, \"p\"),\n        endDate: endDate ? format(endDate, \"PPP\") : \"-\",\n        endTime: endDate ? format(endDate, \"p\") : \"-\",\n        duration: durationHours,\n        status: shift.shiftEnd ? \"Completed\" : \"Ongoing\",\n      });\n    });\n\n    worksheet.getRow(1).font = { bold: true };\n    worksheet.getRow(1).fill = {\n      type: \"pattern\",\n      pattern: \"solid\",\n      fgColor: { argb: \"FFE0E0E0\" },\n    };\n\n    const buffer = await workbook.xlsx.writeBuffer();\n    const blob = new Blob([buffer], {\n      type: \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\",\n    });\n    const url = window.URL.createObjectURL(blob);\n    const link = document.createElement(\"a\");\n    link.href = url;\n    link.download = `my-shift-history-${format(new Date(), \"yyyy-MM-dd\")}.xlsx`;\n    link.click();\n    window.URL.revokeObjectURL(url);\n  };\n\n  const totalDuration = shiftHistory.reduce((acc, shift) => {\n    return acc + (shift.durationMinutes || 0);\n  }, 0);\n\n  const totalHours = Math.floor(totalDuration / 60);\n  const totalMinutes = totalDuration % 60;\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-b from-primary/5 to-background pb-20\">\n      <div className=\"container mx-auto p-4 max-w-4xl\">\n        {/* Header */}\n        <motion.div \n          initial={{ opacity: 0, y: -20 }}\n          animate={{ opacity: 1, y: 0 }}\n          className=\"bg-gradient-to-r from-primary to-primary/80 rounded-xl p-6 mb-6 shadow-lg\"\n        >\n          <div className=\"flex items-center gap-4 mb-4\">\n            <Link href=\"/cleaner\">\n              <Button variant=\"ghost\" size=\"icon\" className=\"text-white hover:bg-white/20\" data-testid=\"button-back\">\n                <ArrowLeft className=\"h-5 w-5\" />\n              </Button>\n            </Link>\n            <div className=\"flex-1\">\n              <h1 className=\"text-3xl font-bold text-white\">Shift History</h1>\n              <p className=\"text-white/90\">\n                Track your work hours and performance\n              </p>\n            </div>\n            <Button \n              onClick={exportToExcel}\n              disabled={shiftHistory.length === 0}\n              className=\"bg-white text-primary hover:bg-white/90 shadow-lg\"\n              data-testid=\"button-export-excel\"\n            >\n              <Download className=\"mr-2 h-4 w-4\" />\n              Export\n            </Button>\n          </div>\n\n          {/* Stats Summary */}\n          {shiftHistory.length > 0 && (\n            <motion.div \n              initial={{ opacity: 0, scale: 0.95 }}\n              animate={{ opacity: 1, scale: 1 }}\n              transition={{ delay: 0.2 }}\n              className=\"grid grid-cols-2 gap-3\"\n            >\n              <div className=\"bg-white/20 backdrop-blur-sm rounded-lg p-4 text-white\">\n                <div className=\"flex items-center gap-2 mb-1\">\n                  <Calendar className=\"h-4 w-4\" />\n                  <p className=\"text-sm opacity-90\">Total Shifts</p>\n                </div>\n                <p className=\"text-3xl font-bold\">{shiftHistory.length}</p>\n              </div>\n              <div className=\"bg-white/20 backdrop-blur-sm rounded-lg p-4 text-white\">\n                <div className=\"flex items-center gap-2 mb-1\">\n                  <Timer className=\"h-4 w-4\" />\n                  <p className=\"text-sm opacity-90\">Total Hours</p>\n                </div>\n                <p className=\"text-3xl font-bold\">{totalHours}h {totalMinutes}m</p>\n              </div>\n            </motion.div>\n          )}\n        </motion.div>\n\n        {/* Filters Card */}\n        <motion.div\n          initial={{ opacity: 0, y: 20 }}\n          animate={{ opacity: 1, y: 0 }}\n          transition={{ delay: 0.1 }}\n        >\n          <Card className=\"mb-6 shadow-md\">\n            <CardHeader>\n              <div className=\"flex items-center gap-2\">\n                <Calendar className=\"h-5 w-5 text-primary\" />\n                <CardTitle>Filter by Date</CardTitle>\n              </div>\n              <CardDescription>Select a date range to view specific shifts</CardDescription>\n            </CardHeader>\n            <CardContent>\n              <div className=\"grid gap-4 md:grid-cols-2\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"start-date\">Start Date</Label>\n                  <Input\n                    id=\"start-date\"\n                    type=\"date\"\n                    value={startDate}\n                    onChange={(e) => setStartDate(e.target.value)}\n                    className=\"h-12\"\n                    data-testid=\"input-start-date\"\n                  />\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"end-date\">End Date</Label>\n                  <Input\n                    id=\"end-date\"\n                    type=\"date\"\n                    value={endDate}\n                    onChange={(e) => setEndDate(e.target.value)}\n                    className=\"h-12\"\n                    data-testid=\"input-end-date\"\n                  />\n                </div>\n              </div>\n\n              {(startDate || endDate) && (\n                <div className=\"mt-4\">\n                  <Button\n                    variant=\"outline\"\n                    onClick={() => {\n                      setStartDate(\"\");\n                      setEndDate(\"\");\n                    }}\n                    data-testid=\"button-clear-filters\"\n                  >\n                    Clear Filters\n                  </Button>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </motion.div>\n\n        {/* Error State */}\n        {error && (\n          <motion.div\n            initial={{ opacity: 0 }}\n            animate={{ opacity: 1 }}\n          >\n            <Alert variant=\"destructive\" className=\"mb-4\">\n              <AlertCircle className=\"h-4 w-4\" />\n              <AlertDescription>\n                Failed to load shift history. Please try again later.\n              </AlertDescription>\n            </Alert>\n          </motion.div>\n        )}\n\n        {/* Shift History Cards */}\n        <AnimatePresence mode=\"popLayout\">\n          {isLoading ? (\n            <div className=\"space-y-4\">\n              {[1, 2, 3, 4, 5].map((i) => (\n                <motion.div\n                  key={i}\n                  initial={{ opacity: 0, scale: 0.95 }}\n                  animate={{ opacity: 1, scale: 1 }}\n                  transition={{ delay: i * 0.05 }}\n                >\n                  <Card>\n                    <CardContent className=\"p-6\">\n                      <Skeleton className=\"h-6 w-1/3 mb-4\" />\n                      <Skeleton className=\"h-4 w-full mb-2\" />\n                      <Skeleton className=\"h-4 w-2/3\" />\n                    </CardContent>\n                  </Card>\n                </motion.div>\n              ))}\n            </div>\n          ) : shiftHistory.length === 0 ? (\n            <motion.div\n              initial={{ opacity: 0, y: 20 }}\n              animate={{ opacity: 1, y: 0 }}\n            >\n              <Card className=\"p-12 text-center border-dashed\">\n                <Clock className=\"h-20 w-20 mx-auto text-muted-foreground mb-4 opacity-50\" />\n                <p className=\"text-xl font-medium mb-2\">No Shift History Found</p>\n                <p className=\"text-muted-foreground\">\n                  No shifts have been recorded yet. Start your first shift to see it here!\n                </p>\n              </Card>\n            </motion.div>\n          ) : (\n            <div className=\"space-y-4\">\n              {shiftHistory.map((shift, index) => {\n                const isOngoing = !shift.shiftEnd;\n                const startDate = new Date(shift.shiftStart);\n                const endDate = shift.shiftEnd ? new Date(shift.shiftEnd) : null;\n                const durationHours = shift.durationMinutes ? Math.floor(shift.durationMinutes / 60) : 0;\n                const durationMinutes = shift.durationMinutes ? shift.durationMinutes % 60 : 0;\n\n                return (\n                  <motion.div\n                    key={shift.id}\n                    initial={{ opacity: 0, x: -20 }}\n                    animate={{ opacity: 1, x: 0 }}\n                    exit={{ opacity: 0, x: 20 }}\n                    transition={{ delay: index * 0.05 }}\n                    layout\n                  >\n                    <Card \n                      className={`overflow-hidden shadow-md hover-elevate ${\n                        isOngoing ? 'border-green-500/50 bg-gradient-to-r from-green-500/5 to-transparent' : ''\n                      }`}\n                      data-testid={`shift-row-${shift.id}`}\n                    >\n                      {/* Status Banner */}\n                      <div className={`p-4 ${isOngoing ? 'bg-gradient-to-r from-green-500 to-green-600' : 'bg-gradient-to-r from-primary to-primary/80'}`}>\n                        <div className=\"flex items-center justify-between text-white\">\n                          <div className=\"flex items-center gap-3\">\n                            <div className=\"h-12 w-12 rounded-full bg-white/20 flex items-center justify-center\">\n                              {isOngoing ? (\n                                <Timer className=\"h-6 w-6 animate-pulse\" />\n                              ) : (\n                                <CheckCircle2 className=\"h-6 w-6\" />\n                              )}\n                            </div>\n                            <div>\n                              <p className=\"text-sm opacity-90\">\n                                {format(startDate, \"EEEE, MMM d, yyyy\")}\n                              </p>\n                              <p className=\"text-2xl font-bold\" data-testid={`shift-date-${shift.id}`}>\n                                {isOngoing ? \"Ongoing Shift\" : `${durationHours}h ${durationMinutes}m`}\n                              </p>\n                            </div>\n                          </div>\n                          <Badge \n                            className={`${\n                              isOngoing \n                                ? 'bg-white text-green-600 animate-pulse' \n                                : 'bg-white/20 text-white border-white/30'\n                            } px-3 py-1.5`}\n                          >\n                            {isOngoing ? \"● Active\" : \"Completed\"}\n                          </Badge>\n                        </div>\n                      </div>\n\n                      <CardContent className=\"p-6\">\n                        <div className=\"grid md:grid-cols-2 gap-4\">\n                          {/* Start Time */}\n                          <div className=\"flex items-center gap-3 p-3 rounded-lg bg-muted/50\">\n                            <div className=\"h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center\">\n                              <Clock className=\"h-5 w-5 text-primary\" />\n                            </div>\n                            <div>\n                              <p className=\"text-xs text-muted-foreground\">Started</p>\n                              <p className=\"font-bold\" data-testid={`shift-start-${shift.id}`}>\n                                {format(startDate, \"h:mm a\")}\n                              </p>\n                            </div>\n                          </div>\n\n                          {/* End Time */}\n                          <div className=\"flex items-center gap-3 p-3 rounded-lg bg-muted/50\">\n                            <div className={`h-10 w-10 rounded-full flex items-center justify-center ${\n                              isOngoing ? 'bg-green-500/10' : 'bg-primary/10'\n                            }`}>\n                              {isOngoing ? (\n                                <Timer className=\"h-5 w-5 text-green-600 animate-pulse\" />\n                              ) : (\n                                <CheckCircle2 className=\"h-5 w-5 text-primary\" />\n                              )}\n                            </div>\n                            <div>\n                              <p className=\"text-xs text-muted-foreground\">\n                                {isOngoing ? \"In Progress\" : \"Ended\"}\n                              </p>\n                              <p className=\"font-bold\" data-testid={`shift-end-${shift.id}`}>\n                                {isOngoing ? (\n                                  <span className=\"text-green-600\">Active Now</span>\n                                ) : (\n                                  endDate && format(endDate, \"h:mm a\")\n                                )}\n                              </p>\n                            </div>\n                          </div>\n                        </div>\n\n                        {/* Duration Summary */}\n                        {!isOngoing && (\n                          <motion.div\n                            initial={{ opacity: 0, y: 10 }}\n                            animate={{ opacity: 1, y: 0 }}\n                            transition={{ delay: 0.2 }}\n                            className=\"mt-4 p-4 rounded-lg bg-primary/5 border border-primary/20\"\n                          >\n                            <div className=\"flex items-center justify-between\">\n                              <div className=\"flex items-center gap-2\">\n                                <Timer className=\"h-5 w-5 text-primary\" />\n                                <span className=\"font-medium\">Total Duration</span>\n                              </div>\n                              <span className=\"text-2xl font-bold text-primary\" data-testid={`shift-duration-${shift.id}`}>\n                                {durationHours}h {durationMinutes}m\n                              </span>\n                            </div>\n                          </motion.div>\n                        )}\n                      </CardContent>\n                    </Card>\n                  </motion.div>\n                );\n              })}\n            </div>\n          )}\n        </AnimatePresence>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":16671,"size_tokens":null},"client/src/components/progress-indicator.tsx":{"content":"import { motion } from \"framer-motion\";\nimport { Check } from \"lucide-react\";\n\ninterface ProgressIndicatorProps {\n  currentStep: number;\n  totalSteps: number;\n  steps: string[];\n}\n\nexport default function ProgressIndicator({ currentStep, totalSteps, steps }: ProgressIndicatorProps) {\n  return (\n    <div className=\"w-full py-4\" data-testid=\"progress-indicator\">\n      <div className=\"max-w-sm sm:max-w-md mx-auto px-3\">\n        {/* Step Indicators */}\n        <div className=\"flex items-center justify-center gap-4 sm:gap-6 mb-2\">\n          {steps.map((_, index) => {\n            const stepNumber = index + 1;\n            const isCompleted = stepNumber < currentStep;\n            const isCurrent = stepNumber === currentStep;\n            \n            return (\n              <div key={stepNumber} className=\"flex items-center\">\n                {/* Step Circle */}\n                <motion.div\n                  initial={false}\n                  animate={{\n                    scale: isCurrent ? 1.1 : 1,\n                  }}\n                  transition={{ duration: 0.3, type: \"spring\" }}\n                  className={`w-10 h-10 rounded-full flex items-center justify-center font-semibold text-sm transition-all ${\n                    isCompleted\n                      ? \"bg-gradient-to-br from-emerald-500 to-teal-600 text-white shadow-lg shadow-emerald-500/30\"\n                      : isCurrent\n                      ? \"bg-gradient-to-br from-blue-500 to-indigo-600 text-white shadow-lg shadow-blue-500/30\"\n                      : \"bg-muted text-muted-foreground\"\n                  }`}\n                  data-testid={`step-indicator-${stepNumber}`}\n                >\n                  {isCompleted ? (\n                    <motion.div\n                      initial={{ scale: 0, rotate: -180 }}\n                      animate={{ scale: 1, rotate: 0 }}\n                      transition={{ duration: 0.4, type: \"spring\" }}\n                    >\n                      <Check className=\"w-5 h-5\" />\n                    </motion.div>\n                  ) : (\n                    stepNumber\n                  )}\n                </motion.div>\n                \n                {/* Connector Line */}\n                {index < totalSteps - 1 && (\n                  <div className=\"w-10 sm:w-16 h-1 mx-2 bg-muted rounded-full overflow-hidden\">\n                    <motion.div\n                      initial={{ scaleX: 0 }}\n                      animate={{ scaleX: isCompleted ? 1 : 0 }}\n                      transition={{ duration: 0.5 }}\n                      className=\"h-full bg-gradient-to-r from-emerald-500 to-teal-600 origin-left\"\n                    />\n                  </div>\n                )}\n              </div>\n            );\n          })}\n        </div>\n        \n        {/* Step Labels */}\n        <div className=\"grid grid-cols-4 gap-1 text-center mb-2\">\n          {steps.map((step, index) => {\n            const stepNumber = index + 1;\n            const isCurrent = stepNumber === currentStep;\n            \n            return (\n              <motion.div\n                key={stepNumber}\n                initial={false}\n                animate={{\n                  opacity: isCurrent ? 1 : 0.5,\n                }}\n              >\n                <p className={`text-xs font-medium ${\n                  isCurrent ? \"text-foreground\" : \"text-muted-foreground\"\n                }`}>\n                  {step}\n                </p>\n              </motion.div>\n            );\n          })}\n        </div>\n        \n        {/* Current Step Text */}\n        <motion.div\n          key={currentStep}\n          initial={{ opacity: 0, y: 10 }}\n          animate={{ opacity: 1, y: 0 }}\n          transition={{ duration: 0.3 }}\n          className=\"mt-3 text-center\"\n        >\n          <p className=\"text-sm text-muted-foreground\" data-testid=\"step-counter\">\n            Step {currentStep} of {totalSteps}\n          </p>\n        </motion.div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":3964,"size_tokens":null},"client/src/pages/customer-booking.tsx":{"content":"import { useState, useEffect, useRef } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { Card } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Button } from \"@/components/ui/button\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Car, Phone, MapPin, CreditCard, Building2, ChevronLeft, Loader2, Check, LogIn, Search, Mail } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Link } from \"wouter\";\nimport LocationPicker from \"@/components/location-picker\";\nimport ProgressIndicator from \"@/components/progress-indicator\";\nimport logoUrl from \"@assets/IMG_2508_1762619079711.png\";\nimport type { CompanyWithCleaners } from \"@shared/schema\";\nimport { calculateFees, type FeePackageType } from \"@shared/fee-calculator\";\n\nconst STEPS = [\"Email Verification\", \"Car Details\", \"Location & Company\", \"Payment\"];\n\ninterface PreviousCar {\n  carPlateEmirate: string;\n  carPlateCode: string;\n  carPlateNumber: string;\n  customerEmail: string;\n  parkingNumber: string;\n  lastUsed: string;\n}\n\ninterface BookingFormData {\n  carPlateNumber: string;\n  carPlateEmirate: string;\n  carPlateCode: string;\n  parkingNumber: string;\n  customerPhone: string;\n  customerEmail: string;\n  requestedCleanerEmail: string;\n}\n\ninterface CustomerHistoryResponse {\n  cars: PreviousCar[];\n}\n\n// UAE Emirates\nconst UAE_EMIRATES = [\n  \"Abu Dhabi\",\n  \"Dubai\",\n  \"Sharjah\",\n  \"Ajman\",\n  \"Umm Al Quwain\",\n  \"Ras Al Khaimah\",\n  \"Fujairah\"\n];\n\n// Generate plate codes: A-Z, AA-MM, 1-50\nconst PLATE_CODES = [\n  // Single letters A-Z\n  ...Array.from({ length: 26 }, (_, i) => String.fromCharCode(65 + i)),\n  // Double letters AA-MM\n  ...Array.from({ length: 13 }, (_, i) => {\n    const char = String.fromCharCode(65 + i);\n    return char + char;\n  }),\n  // Numbers 1-50\n  ...Array.from({ length: 50 }, (_, i) => (i + 1).toString())\n];\n\nexport default function CustomerBooking() {\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  \n  // Get token from URL if present (for QR code payments)\n  const urlParams = new URLSearchParams(window.location.search);\n  const paymentToken = urlParams.get('token');\n  \n  const [currentStep, setCurrentStep] = useState(1); // Start at step 1 for email/OTP entry\n  const checkoutTimeoutRef = useRef<NodeJS.Timeout | null>(null);\n  \n  // Step 1: Email and OTP\n  const [email, setEmail] = useState(\"\");\n  const [otp, setOtp] = useState(\"\");\n  const [otpSent, setOtpSent] = useState(false);\n  const [otpVerified, setOtpVerified] = useState(false);\n  const [emailSkipped, setEmailSkipped] = useState(false); // Track if user skipped email verification\n  const [sendingOtp, setSendingOtp] = useState(false);\n  const [verifyingOtp, setVerifyingOtp] = useState(false);\n  \n  // Step 2: Car Details\n  const [formData, setFormData] = useState<BookingFormData>({\n    carPlateNumber: \"\",\n    carPlateEmirate: \"\",\n    carPlateCode: \"\",\n    parkingNumber: \"\",\n    customerPhone: \"\",\n    customerEmail: \"\",\n    requestedCleanerEmail: \"\",\n  });\n  const [carPlateHistory, setCarPlateHistory] = useState<Array<{ customerEmail: string; parkingNumber: string }>>([]);\n  const [loadingCarHistory, setLoadingCarHistory] = useState(false);\n  const [showCarHistoryOptions, setShowCarHistoryOptions] = useState(false);\n  \n  // Step 3: Location & Company\n  const [locationData, setLocationData] = useState({\n    address: \"\",\n    latitude: 0,\n    longitude: 0,\n  });\n  const [showMap, setShowMap] = useState(false);\n  const [companies, setCompanies] = useState<CompanyWithCleaners[]>([]);\n  const [selectedCompany, setSelectedCompany] = useState<CompanyWithCleaners | null>(null);\n  const [loadingCompanies, setLoadingCompanies] = useState(false);\n  \n  const [isSubmitting, setIsSubmitting] = useState(false);\n  const [isNavigatingToPayment, setIsNavigatingToPayment] = useState(false);\n\n  // Cleanup timeout on unmount\n  useEffect(() => {\n    return () => {\n      if (checkoutTimeoutRef.current) {\n        clearTimeout(checkoutTimeoutRef.current);\n      }\n    };\n  }, []);\n\n  // Auto-load map on step 3 (was step 2)\n  useEffect(() => {\n    if (currentStep === 3 && !locationData.address) {\n      setShowMap(true);\n    }\n  }, [currentStep]);\n\n  // Fetch companies when location is selected on step 3\n  useEffect(() => {\n    if (currentStep === 3 && locationData.latitude !== 0) {\n      fetchCompanies();\n    }\n  }, [locationData, currentStep]);\n\n  // Fetch car plate history when car plate is complete (ONLY if email was skipped)\n  useEffect(() => {\n    const fetchCarPlateHistory = async () => {\n      if (\n        currentStep === 2 &&\n        emailSkipped && // Only show history popup if email was skipped\n        formData.carPlateEmirate &&\n        formData.carPlateCode &&\n        formData.carPlateNumber\n      ) {\n        setLoadingCarHistory(true);\n        try {\n          const res = await fetch(\n            `/api/customer/car-history/${encodeURIComponent(formData.carPlateEmirate)}/${encodeURIComponent(formData.carPlateCode)}/${encodeURIComponent(formData.carPlateNumber)}`\n          );\n          \n          if (res.ok) {\n            const data = await res.json();\n            if (data.history && data.history.length > 0) {\n              setCarPlateHistory(data.history);\n              setShowCarHistoryOptions(true);\n            } else {\n              setCarPlateHistory([]);\n              setShowCarHistoryOptions(false);\n            }\n          } else {\n            setCarPlateHistory([]);\n            setShowCarHistoryOptions(false);\n          }\n        } catch (error) {\n          console.error(\"Failed to fetch car plate history:\", error);\n          setCarPlateHistory([]);\n          setShowCarHistoryOptions(false);\n        } finally {\n          setLoadingCarHistory(false);\n        }\n      }\n    };\n\n    fetchCarPlateHistory();\n  }, [currentStep, emailSkipped, formData.carPlateEmirate, formData.carPlateCode, formData.carPlateNumber]);\n\n  const fetchCompanies = async () => {\n    setLoadingCompanies(true);\n    try {\n      const params = new URLSearchParams({\n        lat: locationData.latitude.toString(),\n        lon: locationData.longitude.toString(),\n      });\n      const res = await fetch(`/api/companies/nearby?${params}`);\n      if (!res.ok) throw new Error(\"Failed to fetch companies\");\n      const data = await res.json();\n      setCompanies(data);\n    } catch (error) {\n      toast({\n        title: \"Error\",\n        description: \"Failed to load nearby companies\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setLoadingCompanies(false);\n    }\n  };\n\n  // Step 1: Send OTP to Email\n  const handleSendOtp = async () => {\n    if (!email || !/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(email)) {\n      toast({\n        title: \"Invalid Email\",\n        description: \"Please enter a valid email address\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setSendingOtp(true);\n    try {\n      const res = await fetch(\"/api/otp/send\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ email }),\n      });\n\n      if (!res.ok) {\n        throw new Error(\"Failed to send OTP\");\n      }\n\n      setOtpSent(true);\n      toast({\n        title: \"OTP Sent\",\n        description: \"Check your email for the verification code\",\n      });\n    } catch (error) {\n      toast({\n        title: \"Error\",\n        description: \"Failed to send OTP. Please try again.\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setSendingOtp(false);\n    }\n  };\n\n  // Step 1: Verify OTP\n  const handleVerifyOtp = async () => {\n    if (!otp || otp.length !== 6) {\n      toast({\n        title: \"Invalid OTP\",\n        description: \"Please enter the 6-digit code\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setVerifyingOtp(true);\n    try {\n      const res = await fetch(\"/api/otp/verify\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ email, code: otp }),\n      });\n\n      if (!res.ok) {\n        throw new Error(\"Invalid OTP\");\n      }\n\n      const data = await res.json();\n      setOtpVerified(true);\n      \n      // Set email in form data\n      setFormData(prev => ({ ...prev, customerEmail: email }));\n      \n      // Set phone number if customer exists (returning user)\n      if (data.phoneNumber) {\n        setFormData(prev => ({ ...prev, customerPhone: data.phoneNumber }));\n      }\n      \n      // Fetch and auto-fill most recent car details for returning customers\n      try {\n        const carRes = await fetch(`/api/customer/recent-car-by-email/${encodeURIComponent(email)}`);\n        if (carRes.ok) {\n          const carData = await carRes.json();\n          if (carData.car) {\n            setFormData(prev => ({\n              ...prev,\n              carPlateEmirate: carData.car.carPlateEmirate,\n              carPlateCode: carData.car.carPlateCode,\n              carPlateNumber: carData.car.carPlateNumber,\n              parkingNumber: carData.car.parkingNumber,\n            }));\n            \n            toast({\n              title: \"Email Verified\",\n              description: \"Your car details have been loaded\",\n            });\n          } else {\n            toast({\n              title: \"Email Verified\",\n              description: \"Proceeding to car details\",\n            });\n          }\n        }\n      } catch (error) {\n        console.error(\"Failed to fetch recent car:\", error);\n        toast({\n          title: \"Email Verified\",\n          description: \"Proceeding to car details\",\n        });\n      }\n\n      // Move to next step after short delay\n      setTimeout(() => {\n        setCurrentStep(2);\n      }, 500);\n    } catch (error) {\n      toast({\n        title: \"Verification Failed\",\n        description: \"Invalid or expired OTP code\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setVerifyingOtp(false);\n    }\n  };\n\n  // Skip email verification\n  const handleSkipEmailVerification = () => {\n    setEmailSkipped(true);\n    setOtpVerified(false); // Not verified since skipped\n    \n    toast({\n      title: \"Email Verification Skipped\",\n      description: \"You can enter your details manually in the next step\",\n    });\n\n    setTimeout(() => {\n      setCurrentStep(2);\n    }, 300);\n  };\n\n  // Step 2: Car Details Submit\n  const handleStep2Submit = () => {\n    if (!formData.carPlateEmirate || !formData.carPlateCode || !formData.carPlateNumber) {\n      toast({\n        title: \"Car Plate Required\",\n        description: \"Please complete all car plate fields (emirate, code, and number)\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    \n    // If email was skipped, validate email field in Step 2\n    if (emailSkipped && !formData.customerEmail) {\n      toast({\n        title: \"Email Required\",\n        description: \"Please enter your email address\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    \n    // If email was verified, it should already be set\n    if (!emailSkipped && !formData.customerEmail) {\n      toast({\n        title: \"Email Missing\",\n        description: \"Email from step 1 is required\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    // Validate email format if entered\n    if (formData.customerEmail && !/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(formData.customerEmail)) {\n      toast({\n        title: \"Invalid Email\",\n        description: \"Please enter a valid email address\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    \n    // Phone number is required (for customer/login API call later)\n    if (!formData.customerPhone || formData.customerPhone.trim() === '') {\n      toast({\n        title: \"Mobile Number Required\",\n        description: \"Please enter your mobile number to proceed\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    \n    setCurrentStep(3);\n  };\n\n  // Step 3: Location & Company Submit\n  const handleStep3Submit = async () => {\n    if (!locationData.address) {\n      toast({\n        title: \"Location Required\",\n        description: \"Please select your car's location\",\n        variant: \"destructive\",\n      });\n      setShowMap(true);\n      return;\n    }\n    \n    if (!selectedCompany) {\n      toast({\n        title: \"Company Required\",\n        description: \"Please select a car wash company\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    \n    setIsNavigatingToPayment(true);\n    \n    try {\n      // Create or get customer profile\n      console.log('[DEBUG] Sending to /api/customer/login:', {\n        email: formData.customerEmail,\n        phoneNumber: formData.customerPhone,\n        formDataFull: formData\n      });\n      \n      const customerResponse = await fetch(\"/api/customer/login\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ \n          email: formData.customerEmail,\n          phoneNumber: formData.customerPhone \n        }),\n      });\n      \n      if (!customerResponse.ok) {\n        throw new Error(\"Failed to create customer profile\");\n      }\n      \n      const customer = await customerResponse.json();\n      \n      // Prepare job data for checkout page\n      const carWashPrice = Number(selectedCompany.pricePerWash);\n      const feePackageType = (selectedCompany.feePackageType || \"custom\") as FeePackageType;\n      const platformFee = Number(selectedCompany.platformFee);\n      \n      const fees = calculateFees({\n        carWashPrice,\n        feePackageType,\n        platformFee,\n      });\n      \n      const jobData = {\n        ...formData,\n        locationAddress: locationData.address,\n        locationLatitude: locationData.latitude,\n        locationLongitude: locationData.longitude,\n        companyId: selectedCompany.id.toString(),\n        customerId: customer.id.toString(),\n        price: carWashPrice,\n        ...fees,\n        tipAmount: 0,\n      };\n      \n      // Store in sessionStorage for checkout page\n      sessionStorage.setItem(\"pendingJob\", JSON.stringify(jobData));\n      \n      // Show Step 4 (payment) transition before navigating to checkout\n      setCurrentStep(4);\n      \n      // Clear any existing timeout before setting a new one\n      if (checkoutTimeoutRef.current) {\n        clearTimeout(checkoutTimeoutRef.current);\n      }\n      \n      // Navigate to checkout after brief animation\n      checkoutTimeoutRef.current = setTimeout(() => {\n        const checkoutUrl = paymentToken \n          ? `/customer/checkout?token=${paymentToken}` \n          : \"/customer/checkout\";\n        setLocation(checkoutUrl);\n      }, 1500);\n    } catch (error: any) {\n      toast({\n        title: \"Error\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n      setIsNavigatingToPayment(false);\n    }\n  };\n\n  const handleLocationSelect = (location: { address: string; latitude: number; longitude: number }) => {\n    setLocationData(location);\n    setShowMap(false);\n    setSelectedCompany(null); // Reset company selection when location changes\n  };\n\n  const goBack = () => {\n    // Clear any pending checkout redirect\n    if (checkoutTimeoutRef.current) {\n      clearTimeout(checkoutTimeoutRef.current);\n      checkoutTimeoutRef.current = null;\n    }\n    \n    // Reset navigation state\n    setIsNavigatingToPayment(false);\n    \n    // Navigate back\n    if (currentStep > 1) {\n      setCurrentStep(currentStep - 1);\n    } else {\n      setLocation(\"/customer\");\n    }\n  };\n\n  const slideVariants = {\n    enter: (direction: number) => ({\n      x: direction > 0 ? 300 : -300,\n      opacity: 0,\n    }),\n    center: {\n      x: 0,\n      opacity: 1,\n    },\n    exit: (direction: number) => ({\n      x: direction < 0 ? 300 : -300,\n      opacity: 0,\n    }),\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-background via-background to-primary/5 flex flex-col\">\n      {/* Header - Vibrant and modern */}\n      <div className=\"border-b bg-background/95 backdrop-blur-sm sticky top-0 z-10 shadow-sm\">\n        <div className=\"max-w-md mx-auto px-3 py-2.5\">\n          <div className=\"flex items-center justify-between gap-2\">\n            {/* Action Buttons */}\n            <div className=\"flex items-center gap-1.5\">\n              <Button\n                variant=\"ghost\"\n                size=\"icon\"\n                onClick={goBack}\n                data-testid=\"button-back\"\n                className=\"h-9 w-9\"\n              >\n                <ChevronLeft className=\"h-5 w-5\" />\n              </Button>\n              \n              {/* Track Button - Vibrant Blue */}\n              <Button \n                variant=\"default\"\n                size=\"sm\"\n                onClick={() => setLocation('/customer/track')}\n                data-testid=\"button-track\"\n                className=\"bg-gradient-to-r from-primary to-blue-600 hover:from-primary/90 hover:to-blue-600/90 text-white font-medium shadow-md hover:shadow-lg transition-all\"\n              >\n                <Search className=\"h-4 w-4 mr-1.5\" />\n                Track\n              </Button>\n              \n              {/* Staff Login Button - Brand Colors */}\n              <Button \n                variant=\"default\"\n                size=\"sm\"\n                onClick={() => setLocation(\"/login\")}\n                data-testid=\"button-staff-login\"\n                className=\"bg-gradient-to-r from-primary/90 to-primary hover:from-primary hover:to-primary/90 text-white font-medium shadow-md hover:shadow-lg transition-all\"\n              >\n                <LogIn className=\"h-4 w-4 mr-1.5\" />\n                Staff\n              </Button>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      {/* Progress Indicator */}\n      <motion.div\n        initial={{ opacity: 0 }}\n        animate={{ opacity: 1 }}\n        transition={{ delay: 0.1 }}\n        className=\"max-w-md mx-auto w-full\"\n      >\n        <ProgressIndicator currentStep={currentStep} totalSteps={4} steps={STEPS} />\n      </motion.div>\n\n      {/* Content */}\n      <div className=\"flex-1 max-w-md mx-auto w-full px-4 pb-24\">\n        <AnimatePresence mode=\"wait\" custom={currentStep}>\n          {/* Step 1: Email & OTP Verification */}\n          {currentStep === 1 && (\n            <Step0EmailOTP\n              key=\"step1\"\n              email={email}\n              setEmail={setEmail}\n              otp={otp}\n              setOtp={setOtp}\n              otpSent={otpSent}\n              onSendOtp={handleSendOtp}\n              onVerifyOtp={handleVerifyOtp}\n              onSkip={handleSkipEmailVerification}\n              sendingOtp={sendingOtp}\n              verifyingOtp={verifyingOtp}\n            />\n          )}\n\n          {/* Step 2: Car Details (with auto-fill from car plate history) */}\n          {currentStep === 2 && (\n            <Step1CarDetails\n              key=\"step2\"\n              formData={formData}\n              setFormData={setFormData}\n              carPlateHistory={carPlateHistory}\n              loadingCarHistory={loadingCarHistory}\n              showCarHistoryOptions={showCarHistoryOptions}\n              setShowCarHistoryOptions={setShowCarHistoryOptions}\n              verifiedEmail={email}\n              emailSkipped={emailSkipped}\n              onSubmit={handleStep2Submit}\n            />\n          )}\n          \n          {/* Step 3: Location & Company */}\n          {currentStep === 3 && (\n            <Step2LocationCompany\n              key=\"step3\"\n              locationData={locationData}\n              showMap={showMap}\n              setShowMap={setShowMap}\n              onLocationSelect={handleLocationSelect}\n              companies={companies}\n              selectedCompany={selectedCompany}\n              setSelectedCompany={setSelectedCompany}\n              loadingCompanies={loadingCompanies}\n              onSubmit={handleStep3Submit}\n              isSubmitting={isSubmitting}\n            />\n          )}\n          \n          {/* Step 4: Payment Loading */}\n          {currentStep === 4 && (\n            <motion.div\n              key=\"step3\"\n              initial={{ opacity: 0, scale: 0.95 }}\n              animate={{ opacity: 1, scale: 1 }}\n              className=\"flex flex-col items-center justify-center py-16 space-y-6\"\n              data-testid=\"step-3-loading\"\n            >\n              <motion.div\n                initial={{ scale: 0 }}\n                animate={{ scale: 1 }}\n                transition={{ type: \"spring\", delay: 0.1 }}\n                className=\"w-20 h-20 rounded-full bg-gradient-to-br from-emerald-500 to-green-600 flex items-center justify-center shadow-lg shadow-emerald-500/30\"\n              >\n                <Check className=\"w-10 h-10 text-white\" />\n              </motion.div>\n              \n              <motion.div\n                initial={{ opacity: 0, y: 10 }}\n                animate={{ opacity: 1, y: 0 }}\n                transition={{ delay: 0.2 }}\n                className=\"text-center space-y-2\"\n              >\n                <h2 className=\"text-2xl font-bold\">All Set!</h2>\n                <p className=\"text-muted-foreground\">Redirecting to payment...</p>\n              </motion.div>\n              \n              <motion.div\n                initial={{ opacity: 0 }}\n                animate={{ opacity: 1 }}\n                transition={{ delay: 0.3 }}\n                className=\"flex gap-1\"\n              >\n                <motion.div\n                  animate={{ scale: [1, 1.2, 1] }}\n                  transition={{ repeat: Infinity, duration: 1, delay: 0 }}\n                  className=\"w-2 h-2 rounded-full bg-primary\"\n                />\n                <motion.div\n                  animate={{ scale: [1, 1.2, 1] }}\n                  transition={{ repeat: Infinity, duration: 1, delay: 0.2 }}\n                  className=\"w-2 h-2 rounded-full bg-primary\"\n                />\n                <motion.div\n                  animate={{ scale: [1, 1.2, 1] }}\n                  transition={{ repeat: Infinity, duration: 1, delay: 0.4 }}\n                  className=\"w-2 h-2 rounded-full bg-primary\"\n                />\n              </motion.div>\n            </motion.div>\n          )}\n        </AnimatePresence>\n      </div>\n\n      {/* Sticky Bottom CTA - Only for steps 2 and 3 (not step 1) */}\n      {currentStep >= 2 && currentStep < 4 && (\n        <motion.div\n          initial={{ y: 100 }}\n          animate={{ y: 0 }}\n          transition={{ type: \"spring\", damping: 20 }}\n          className=\"fixed bottom-0 left-0 right-0 bg-card/95 backdrop-blur-lg border-t p-4 z-40\"\n        >\n          <div className=\"max-w-md mx-auto\">\n            <Button\n              type=\"button\"\n              className=\"w-full h-12 text-base bg-gradient-to-r from-primary to-blue-600 hover:from-primary/90 hover:to-blue-600/90\"\n              onClick={currentStep === 2 ? handleStep2Submit : handleStep3Submit}\n              disabled={isSubmitting || isNavigatingToPayment}\n              data-testid=\"button-continue\"\n            >\n              {isSubmitting || isNavigatingToPayment ? (\n                <>\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                  {isNavigatingToPayment ? \"Proceeding to payment...\" : \"Processing...\"}\n                </>\n              ) : (\n                <>\n                  Continue\n                  <ChevronLeft className=\"ml-2 h-4 w-4 rotate-180\" />\n                </>\n              )}\n            </Button>\n          </div>\n        </motion.div>\n      )}\n    </div>\n  );\n}\n\n// Step 0: Email & OTP Verification Component\nfunction Step0EmailOTP({\n  email,\n  setEmail,\n  otp,\n  setOtp,\n  otpSent,\n  onSendOtp,\n  onVerifyOtp,\n  onSkip,\n  sendingOtp,\n  verifyingOtp,\n}: {\n  email: string;\n  setEmail: (email: string) => void;\n  otp: string;\n  setOtp: (otp: string) => void;\n  otpSent: boolean;\n  onSendOtp: () => void;\n  onVerifyOtp: () => void;\n  onSkip: () => void;\n  sendingOtp: boolean;\n  verifyingOtp: boolean;\n}) {\n  return (\n    <motion.div\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n      exit={{ opacity: 0, y: -20 }}\n      className=\"space-y-6 pt-4\"\n    >\n      <div className=\"text-center space-y-2\">\n        <motion.div\n          initial={{ scale: 0 }}\n          animate={{ scale: 1 }}\n          transition={{ type: \"spring\", delay: 0.1 }}\n          className=\"mx-auto mb-4\"\n        >\n          <motion.img \n            src={logoUrl} \n            alt=\"Washapp.ae\" \n            className=\"h-24 w-auto mx-auto\"\n            animate={{ \n              scale: [1, 1.05, 1],\n            }}\n            transition={{ \n              duration: 2,\n              repeat: Infinity,\n              repeatDelay: 1\n            }}\n            data-testid=\"img-logo-animation\"\n          />\n        </motion.div>\n        <h2 className=\"text-2xl font-bold\">Welcome!</h2>\n        <p className=\"text-muted-foreground\">\n          {otpSent ? \"Enter the verification code\" : \"Enter your email to get started\"}\n        </p>\n      </div>\n\n      <Card className=\"p-6 space-y-5 border-2 hover-elevate\">\n        {!otpSent ? (\n          <>\n            <div>\n              <Label htmlFor=\"email\" className=\"text-base font-medium mb-2 block\">\n                Email Address *\n              </Label>\n              <Input\n                id=\"email\"\n                type=\"email\"\n                placeholder=\"example@email.com\"\n                value={email}\n                onChange={(e) => setEmail(e.target.value)}\n                className=\"h-12 text-lg\"\n                autoFocus\n                data-testid=\"input-email\"\n                onKeyDown={(e) => {\n                  if (e.key === 'Enter') {\n                    e.preventDefault();\n                    e.stopPropagation();\n                    onSendOtp();\n                  }\n                }}\n              />\n              <p className=\"text-sm text-muted-foreground mt-2\">\n                We'll send you a verification code\n              </p>\n            </div>\n\n            <Button\n              type=\"button\"\n              className=\"w-full h-12 text-base bg-gradient-to-r from-primary to-blue-600 hover:from-primary/90 hover:to-blue-600/90\"\n              onClick={onSendOtp}\n              disabled={sendingOtp}\n              data-testid=\"button-send-otp\"\n            >\n              {sendingOtp ? (\n                <>\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                  Sending code...\n                </>\n              ) : (\n                <>\n                  Send Verification Code\n                  <ChevronLeft className=\"ml-2 h-4 w-4 rotate-180\" />\n                </>\n              )}\n            </Button>\n\n            <Button\n              type=\"button\"\n              variant=\"ghost\"\n              className=\"w-full\"\n              onClick={onSkip}\n              data-testid=\"button-skip-verification\"\n            >\n              Skip Verification\n            </Button>\n          </>\n        ) : (\n          <>\n            <div>\n              <Label htmlFor=\"otp\" className=\"text-base font-medium mb-2 block\">\n                Verification Code *\n              </Label>\n              <Input\n                id=\"otp\"\n                type=\"text\"\n                placeholder=\"Enter 6-digit code\"\n                value={otp}\n                onChange={(e) => setOtp(e.target.value.replace(/\\D/g, '').slice(0, 6))}\n                className=\"h-12 text-lg text-center tracking-widest\"\n                autoFocus\n                maxLength={6}\n                data-testid=\"input-otp\"\n                onKeyDown={(e) => {\n                  if (e.key === 'Enter') {\n                    e.preventDefault();\n                    e.stopPropagation();\n                    onVerifyOtp();\n                  }\n                }}\n              />\n              <p className=\"text-sm text-muted-foreground mt-2\">\n                Code sent to {email}\n              </p>\n            </div>\n\n            <Button\n              type=\"button\"\n              className=\"w-full h-12 text-base bg-gradient-to-r from-primary to-blue-600 hover:from-primary/90 hover:to-blue-600/90\"\n              onClick={onVerifyOtp}\n              disabled={verifyingOtp}\n              data-testid=\"button-verify-otp\"\n            >\n              {verifyingOtp ? (\n                <>\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                  Verifying...\n                </>\n              ) : (\n                <>\n                  Verify & Continue\n                  <ChevronLeft className=\"ml-2 h-4 w-4 rotate-180\" />\n                </>\n              )}\n            </Button>\n\n            <Button\n              type=\"button\"\n              variant=\"ghost\"\n              className=\"w-full\"\n              onClick={onSendOtp}\n              disabled={sendingOtp}\n              data-testid=\"button-resend-otp\"\n            >\n              Resend Code\n            </Button>\n          </>\n        )}\n      </Card>\n    </motion.div>\n  );\n}\n\n// Step 1: Car Details Component\nfunction Step1CarDetails({\n  formData,\n  setFormData,\n  carPlateHistory,\n  loadingCarHistory,\n  showCarHistoryOptions,\n  setShowCarHistoryOptions,\n  verifiedEmail,\n  emailSkipped,\n  onSubmit,\n}: {\n  formData: BookingFormData;\n  setFormData: React.Dispatch<React.SetStateAction<BookingFormData>>;\n  carPlateHistory: Array<{ customerEmail: string; parkingNumber: string }>;\n  loadingCarHistory: boolean;\n  showCarHistoryOptions: boolean;\n  setShowCarHistoryOptions: (show: boolean) => void;\n  verifiedEmail: string;\n  emailSkipped: boolean;\n  onSubmit: () => void;\n}) {\n  const handleUseHistory = (history: { customerEmail: string; parkingNumber: string }) => {\n    setFormData(prev => ({\n      ...prev,\n      parkingNumber: history.parkingNumber,\n    }));\n    setShowCarHistoryOptions(false);\n  };\n\n  // Show car details form (either pre-filled from selection or empty for new car)\n  return (\n    <motion.div\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n      exit={{ opacity: 0, y: -20 }}\n      className=\"space-y-6 pt-4\"\n    >\n      <div className=\"text-center space-y-2\">\n        <h2 className=\"text-2xl font-bold\">Car Details</h2>\n        {!emailSkipped && verifiedEmail && (\n          <p className=\"text-sm text-muted-foreground\">Booking for: {verifiedEmail}</p>\n        )}\n      </div>\n\n      <Card className=\"p-6 space-y-5 border-2 hover-elevate relative overflow-hidden\">\n        {/* Animated Logo - Top Right */}\n        <motion.div\n          initial={{ opacity: 0, x: 20 }}\n          animate={{ opacity: 1, x: 0 }}\n          transition={{ type: \"spring\", delay: 0.2 }}\n          className=\"absolute top-4 right-4 z-10\"\n        >\n          <motion.img \n            src={logoUrl} \n            alt=\"Washapp.ae\" \n            className=\"h-12 w-auto\"\n            animate={{ \n              scale: [1, 1.08, 1],\n              rotate: [0, 2, -2, 0]\n            }}\n            transition={{ \n              duration: 3,\n              repeat: Infinity,\n              repeatDelay: 2\n            }}\n            data-testid=\"img-logo-animation\"\n          />\n        </motion.div>\n        <div>\n          <Label className=\"text-base font-medium mb-3 block\">\n            Car Plate Details *\n          </Label>\n          <div className=\"grid grid-cols-3 gap-3\">\n            <div>\n              <Label htmlFor=\"carPlateEmirate\" className=\"text-sm mb-1.5 block text-muted-foreground\">\n                Emirate\n              </Label>\n              <Select value={formData.carPlateEmirate} onValueChange={(value) => setFormData(prev => ({ ...prev, carPlateEmirate: value }))}>\n                <SelectTrigger id=\"carPlateEmirate\" className=\"h-12\" data-testid=\"select-emirate\">\n                  <SelectValue placeholder=\"Select\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {UAE_EMIRATES.map((emirate) => (\n                    <SelectItem key={emirate} value={emirate}>\n                      {emirate}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n            \n            <div>\n              <Label htmlFor=\"carPlateCode\" className=\"text-sm mb-1.5 block text-muted-foreground\">\n                Code\n              </Label>\n              <Select value={formData.carPlateCode} onValueChange={(value) => setFormData(prev => ({ ...prev, carPlateCode: value }))}>\n                <SelectTrigger id=\"carPlateCode\" className=\"h-12\" data-testid=\"select-code\">\n                  <SelectValue placeholder=\"A-Z\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {PLATE_CODES.map((code) => (\n                    <SelectItem key={code} value={code}>\n                      {code}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n            \n            <div>\n              <Label htmlFor=\"carPlateNumber\" className=\"text-sm mb-1.5 block text-muted-foreground\">\n                Number\n              </Label>\n              <Input\n                id=\"carPlateNumber\"\n                data-testid=\"input-plate-number\"\n                placeholder=\"12345\"\n                value={formData.carPlateNumber}\n                onChange={(e) => setFormData(prev => ({ ...prev, carPlateNumber: e.target.value }))}\n                required\n                className=\"h-12 text-lg\"\n                autoFocus\n              />\n            </div>\n          </div>\n        </div>\n\n        {/* Car History Auto-fill Alert */}\n        {showCarHistoryOptions && carPlateHistory.length > 0 && (\n          <motion.div\n            initial={{ opacity: 0, y: -10 }}\n            animate={{ opacity: 1, y: 0 }}\n            className=\"bg-blue-50 dark:bg-blue-950/20 border-2 border-blue-200 dark:border-blue-800 rounded-lg p-4\"\n            data-testid=\"car-history-alert\"\n          >\n            <div className=\"flex items-start gap-3\">\n              <div className=\"h-10 w-10 rounded-full bg-blue-500 flex items-center justify-center flex-shrink-0\">\n                <Car className=\"h-5 w-5 text-white\" />\n              </div>\n              <div className=\"flex-1\">\n                <p className=\"font-medium text-blue-900 dark:text-blue-100 mb-2\">\n                  We found this car's history!\n                </p>\n                <div className=\"space-y-2\">\n                  {carPlateHistory.map((history, index) => (\n                    <div\n                      key={index}\n                      className=\"flex items-center justify-between bg-white dark:bg-gray-900 rounded-lg p-3 border border-blue-100 dark:border-blue-900\"\n                    >\n                      <div className=\"text-sm\">\n                        <p className=\"text-muted-foreground\">Previous parking:</p>\n                        <p className=\"font-semibold\">{history.parkingNumber || \"Not specified\"}</p>\n                      </div>\n                      <Button\n                        size=\"sm\"\n                        onClick={() => handleUseHistory(history)}\n                        data-testid={`button-use-history-${index}`}\n                      >\n                        Use This\n                      </Button>\n                    </div>\n                  ))}\n                </div>\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={() => setShowCarHistoryOptions(false)}\n                  className=\"mt-2\"\n                  data-testid=\"button-dismiss-history\"\n                >\n                  No thanks, I'll enter manually\n                </Button>\n              </div>\n            </div>\n          </motion.div>\n        )}\n\n        {/* Email field - only shown if user skipped email verification */}\n        {emailSkipped && (\n          <div>\n            <Label htmlFor=\"customerEmail\" className=\"text-base font-medium mb-2 block\">\n              Email Address *\n            </Label>\n            <Input\n              id=\"customerEmail\"\n              data-testid=\"input-customer-email\"\n              type=\"email\"\n              placeholder=\"your@email.com\"\n              value={formData.customerEmail}\n              onChange={(e) => setFormData(prev => ({ ...prev, customerEmail: e.target.value }))}\n              className=\"h-12 text-lg\"\n            />\n          </div>\n        )}\n\n        {/* Mobile number field */}\n        <div>\n          <Label htmlFor=\"customerPhone\" className=\"text-base font-medium mb-2 block\">\n            Mobile Number *\n          </Label>\n          <Input\n            id=\"customerPhone\"\n            data-testid=\"input-customer-phone\"\n            type=\"tel\"\n            placeholder=\"+971 50 123 4567\"\n            value={formData.customerPhone}\n            onChange={(e) => setFormData(prev => ({ ...prev, customerPhone: e.target.value }))}\n            className=\"h-12 text-lg\"\n          />\n          {!emailSkipped && formData.customerPhone && (\n            <p className=\"text-sm text-emerald-600 dark:text-emerald-400 mt-2\">\n              ✓ Auto-filled from your profile\n            </p>\n          )}\n        </div>\n        \n        <div>\n          <Label htmlFor=\"parkingNumber\" className=\"text-base font-medium mb-2 block\">\n            Parking <span className=\"text-muted-foreground text-xs font-normal\">(Optional)</span>\n          </Label>\n          <Input\n            id=\"parkingNumber\"\n            data-testid=\"input-parking\"\n            placeholder=\"P2-45\"\n            value={formData.parkingNumber}\n            onChange={(e) => setFormData(prev => ({ ...prev, parkingNumber: e.target.value }))}\n            className=\"h-12 text-lg\"\n          />\n        </div>\n\n\n        <div>\n          <Label htmlFor=\"cleanerEmail\" className=\"text-base font-medium mb-2 block\">\n            Cleaner Email <span className=\"text-muted-foreground text-xs font-normal\">(Optional)</span>\n          </Label>\n          <Input\n            id=\"cleanerEmail\"\n            data-testid=\"input-cleaner-email\"\n            type=\"email\"\n            placeholder=\"Request specific cleaner\"\n            value={formData.requestedCleanerEmail || \"\"}\n            onChange={(e) => setFormData(prev => ({ ...prev, requestedCleanerEmail: e.target.value }))}\n            className=\"h-12 text-lg\"\n          />\n          <p className=\"text-sm text-muted-foreground mt-2\">\n            If on-duty and within 50m, they'll be auto-assigned\n          </p>\n        </div>\n      </Card>\n    </motion.div>\n  );\n}\n\n// Step 2: Location & Company Component\nfunction Step2LocationCompany({\n  locationData,\n  showMap,\n  setShowMap,\n  onLocationSelect,\n  companies,\n  selectedCompany,\n  setSelectedCompany,\n  loadingCompanies,\n  onSubmit,\n  isSubmitting,\n}: any) {\n  return (\n    <motion.div\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n      exit={{ opacity: 0, y: -20 }}\n      className=\"space-y-6 pt-4\"\n    >\n      <div className=\"text-center space-y-2\">\n        <motion.div\n          initial={{ scale: 0 }}\n          animate={{ scale: 1 }}\n          transition={{ type: \"spring\", delay: 0.1 }}\n          className=\"w-16 h-16 rounded-full bg-gradient-to-br from-emerald-500 to-teal-600 mx-auto flex items-center justify-center mb-4 shadow-lg shadow-emerald-500/30\"\n        >\n          <MapPin className=\"w-8 h-8 text-white\" />\n        </motion.div>\n        <h2 className=\"text-2xl font-bold\">Location & Company</h2>\n        <p className=\"text-muted-foreground\">Where is your car parked?</p>\n      </div>\n\n      <Card className=\"p-6 space-y-5 border-2 hover-elevate\">\n        <div>\n          <Label className=\"text-base font-medium mb-2 block\">\n            Car Location *\n          </Label>\n          {!showMap && locationData.address ? (\n            <div className=\"border-2 border-dashed border-primary/30 rounded-lg p-4 bg-primary/5\">\n              <p className=\"text-sm mb-3 flex items-start gap-2\" data-testid=\"text-selected-location\">\n                <MapPin className=\"w-4 h-4 mt-0.5 text-primary flex-shrink-0\" />\n                <span>{locationData.address}</span>\n              </p>\n              <Button\n                type=\"button\"\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={() => setShowMap(true)}\n                data-testid=\"button-change-location\"\n                className=\"hover-elevate\"\n              >\n                Change Location\n              </Button>\n            </div>\n          ) : (\n            <LocationPicker\n              onLocationSelect={onLocationSelect}\n              initialPosition={\n                locationData.latitude !== 0\n                  ? [locationData.latitude, locationData.longitude]\n                  : undefined\n              }\n            />\n          )}\n        </div>\n\n        {locationData.address && !showMap && (\n          <motion.div\n            initial={{ opacity: 0, height: 0 }}\n            animate={{ opacity: 1, height: \"auto\" }}\n            className=\"space-y-3 overflow-hidden\"\n          >\n            <Label className=\"text-base font-medium block\">\n              Select Company *\n            </Label>\n            \n            {loadingCompanies ? (\n              <div className=\"flex items-center justify-center py-8\">\n                <Loader2 className=\"w-6 h-6 animate-spin text-primary\" />\n              </div>\n            ) : companies.length === 0 ? (\n              <Card className=\"p-6 text-center border-dashed\">\n                <Building2 className=\"w-12 h-12 mx-auto mb-3 text-muted-foreground\" />\n                <p className=\"text-muted-foreground\">No companies available in this area</p>\n              </Card>\n            ) : (\n              <div className=\"space-y-3\">\n                {companies.map((company: CompanyWithCleaners) => (\n                  <motion.div\n                    key={company.id}\n                    initial={{ opacity: 0, x: -20 }}\n                    animate={{ opacity: 1, x: 0 }}\n                    whileHover={{ scale: 1.02 }}\n                    whileTap={{ scale: 0.98 }}\n                  >\n                    <Card\n                      className={`p-4 cursor-pointer transition-all border-2 ${\n                        selectedCompany?.id === company.id\n                          ? \"border-primary bg-primary/5 shadow-lg shadow-primary/20\"\n                          : \"border-border hover:border-primary/50\"\n                      }`}\n                      onClick={() => setSelectedCompany(company)}\n                      data-testid={`company-card-${company.id}`}\n                    >\n                      <div className=\"flex items-start justify-between\">\n                        <div className=\"flex-1\">\n                          <div className=\"flex items-center gap-2\">\n                            <h3 className=\"font-semibold text-lg\">{company.name}</h3>\n                            {selectedCompany?.id === company.id && (\n                              <motion.div\n                                initial={{ scale: 0 }}\n                                animate={{ scale: 1 }}\n                                className=\"w-6 h-6 rounded-full bg-primary flex items-center justify-center\"\n                              >\n                                <Check className=\"w-4 h-4 text-primary-foreground\" />\n                              </motion.div>\n                            )}\n                          </div>\n                          <p className=\"text-sm text-muted-foreground mt-1\">\n                            {company.onDutyCleanersCount || 0} cleaner{company.onDutyCleanersCount !== 1 ? 's' : ''} on duty\n                          </p>\n                        </div>\n                        <div className=\"text-right\">\n                          <p className=\"text-sm text-muted-foreground\">\n                            {(() => {\n                              const carWashPrice = Number(company.pricePerWash);\n                              const feePackageType = (company.feePackageType || \"custom\") as FeePackageType;\n                              const platformFee = Number(company.platformFee);\n                              const fees = calculateFees({\n                                carWashPrice,\n                                feePackageType,\n                                platformFee,\n                              });\n                              return fees.displayBreakdown;\n                            })()}\n                          </p>\n                          <p className=\"text-2xl font-bold text-primary\">\n                            {(() => {\n                              const carWashPrice = Number(company.pricePerWash);\n                              const feePackageType = (company.feePackageType || \"custom\") as FeePackageType;\n                              const platformFee = Number(company.platformFee);\n                              const fees = calculateFees({\n                                carWashPrice,\n                                feePackageType,\n                                platformFee,\n                              });\n                              return fees.totalAmount.toFixed(2);\n                            })()} AED\n                          </p>\n                        </div>\n                      </div>\n                    </Card>\n                  </motion.div>\n                ))}\n              </div>\n            )}\n          </motion.div>\n        )}\n      </Card>\n    </motion.div>\n  );\n}\n","path":null,"size_bytes":45490,"size_tokens":null},"client/src/components/checkout-form-step.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useStripe, useElements, PaymentElement, PaymentRequestButtonElement } from \"@stripe/react-stripe-js\";\nimport type { PaymentRequest } from \"@stripe/stripe-js\";\nimport { motion } from \"framer-motion\";\nimport { useLocation } from \"wouter\";\nimport { Card } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Loader2, Check, Sparkles, Car, MapPin, CreditCard } from \"lucide-react\";\nimport { apiRequest } from \"@/lib/queryClient\";\n\nexport default function CheckoutForm({\n  paymentIntentId,\n  clientSecret,\n  jobData,\n  selectedCompany,\n  formData,\n  locationData,\n}: any) {\n  const stripe = useStripe();\n  const elements = useElements();\n  const { toast } = useToast();\n  const [, setLocation] = useLocation();\n  \n  const [processing, setProcessing] = useState(false);\n  const [paymentRequest, setPaymentRequest] = useState<PaymentRequest | null>(null);\n  const [tipAmount, setTipAmount] = useState(0);\n  const [customTip, setCustomTip] = useState(\"\");\n  const [updatingTip, setUpdatingTip] = useState(false);\n  const [fees, setFees] = useState(jobData.fees || {\n    baseJobAmount: Number(selectedCompany.pricePerWash),\n    platformFeeAmount: 3,\n    taxAmount: Number(selectedCompany.pricePerWash) * 0.05 + 0.15,\n    totalAmount: Number(selectedCompany.pricePerWash) + 3.15,\n  });\n\n  const predefinedTips = [0, 5, 10, 15];\n\n  // Setup Payment Request for Apple Pay / Google Pay\n  useEffect(() => {\n    if (!stripe || !jobData) {\n      return;\n    }\n\n    const pr = stripe.paymentRequest({\n      country: 'AE',\n      currency: 'aed',\n      total: {\n        label: 'Car Wash Service',\n        amount: Math.round(fees.totalAmount * 100),\n      },\n      requestPayerName: true,\n      requestPayerPhone: true,\n    });\n\n    pr.canMakePayment().then(result => {\n      if (result) {\n        setPaymentRequest(pr);\n      }\n    });\n\n    pr.on('paymentmethod', async (e) => {\n      if (!elements) {\n        e.complete('fail');\n        return;\n      }\n      \n      const { error: confirmError } = await stripe.confirmPayment({\n        elements,\n        clientSecret,\n        confirmParams: {\n          return_url: `${window.location.origin}/customer/track/${formData.carPlateNumber}`,\n        },\n      });\n\n      if (confirmError) {\n        e.complete('fail');\n        toast({\n          title: \"Payment Failed\",\n          description: confirmError.message,\n          variant: \"destructive\",\n        });\n      } else {\n        e.complete('success');\n        setLocation(`/customer/track/${formData.carPlateNumber}`);\n      }\n    });\n  }, [stripe, jobData, fees, elements, clientSecret, formData.carPlateNumber]);\n\n  const updateTip = async (newTip: number) => {\n    if (!paymentIntentId) return;\n    \n    setUpdatingTip(true);\n    try {\n      const response = await apiRequest(\"PATCH\", `/api/payment-intents/${paymentIntentId}`, {\n        tipAmount: newTip,\n      });\n      const updatedFees = await response.json();\n      \n      setFees(updatedFees);\n      \n      if (paymentRequest) {\n        paymentRequest.update({\n          total: {\n            label: 'Car Wash Service',\n            amount: Math.round(updatedFees.totalAmount * 100),\n          },\n        });\n      }\n      \n      setTipAmount(newTip);\n      setCustomTip(\"\");\n    } catch (error) {\n      toast({\n        title: \"Error\",\n        description: \"Failed to update tip amount\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setUpdatingTip(false);\n    }\n  };\n\n  const handleCustomTipSubmit = () => {\n    const tip = parseFloat(customTip);\n    if (!isNaN(tip) && tip >= 0) {\n      updateTip(tip);\n    }\n  };\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n\n    if (!stripe || !elements) {\n      return;\n    }\n\n    setProcessing(true);\n\n    const { error } = await stripe.confirmPayment({\n      elements,\n      confirmParams: {\n        return_url: `${window.location.origin}/customer/track/${formData.carPlateNumber}`,\n      },\n      redirect: 'if_required',\n    });\n\n    if (error) {\n      toast({\n        title: \"Payment Failed\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n      setProcessing(false);\n    } else {\n      setLocation(`/customer/track/${formData.carPlateNumber}`);\n    }\n  };\n\n  return (\n    <form onSubmit={handleSubmit} className=\"space-y-6\">\n      {/* Order Summary */}\n      <Card className=\"p-6 space-y-4 border-2 bg-gradient-to-br from-card to-primary/5\">\n        <div className=\"flex items-center gap-2 mb-4\">\n          <Sparkles className=\"w-5 h-5 text-primary\" />\n          <h3 className=\"font-semibold text-lg\">Booking Summary</h3>\n        </div>\n        \n        <motion.div\n          initial={{ opacity: 0 }}\n          animate={{ opacity: 1 }}\n          className=\"space-y-3 text-sm\"\n        >\n          <div className=\"flex items-start gap-2 text-muted-foreground\">\n            <Car className=\"w-4 h-4 mt-0.5 flex-shrink-0\" />\n            <span>{formData.carPlateNumber}</span>\n          </div>\n          \n          <div className=\"flex items-start gap-2 text-muted-foreground\">\n            <MapPin className=\"w-4 h-4 mt-0.5 flex-shrink-0\" />\n            <span className=\"line-clamp-2\">{locationData.address}</span>\n          </div>\n          \n          <div className=\"flex items-center gap-2 pt-2 border-t\">\n            <div className=\"flex-1 text-muted-foreground\">\n              Service ({selectedCompany.name})\n            </div>\n            <div className=\"font-medium\">\n              {fees.baseJobAmount.toFixed(2)} AED\n            </div>\n          </div>\n          \n          <div className=\"flex items-center gap-2\">\n            <div className=\"flex-1 text-muted-foreground\">Platform Fee</div>\n            <div className=\"font-medium\">{fees.platformFeeAmount.toFixed(2)} AED</div>\n          </div>\n          \n          <div className=\"flex items-center gap-2\">\n            <div className=\"flex-1 text-muted-foreground\">VAT (5%)</div>\n            <div className=\"font-medium\">{fees.taxAmount.toFixed(2)} AED</div>\n          </div>\n          \n          {tipAmount > 0 && (\n            <motion.div\n              initial={{ opacity: 0, height: 0 }}\n              animate={{ opacity: 1, height: \"auto\" }}\n              className=\"flex items-center gap-2 text-emerald-600\"\n            >\n              <div className=\"flex-1\">Tip</div>\n              <div className=\"font-medium\">{tipAmount.toFixed(2)} AED</div>\n            </motion.div>\n          )}\n          \n          <div className=\"flex items-center gap-2 pt-2 border-t text-lg font-bold\">\n            <div className=\"flex-1\">Total</div>\n            <div className=\"text-primary\">{fees.totalAmount.toFixed(2)} AED</div>\n          </div>\n        </motion.div>\n      </Card>\n\n      {/* Tip Section */}\n      <Card className=\"p-6 space-y-4 border-2 hover-elevate\">\n        <Label className=\"text-base font-medium flex items-center gap-2\">\n          <Sparkles className=\"w-4 h-4 text-primary\" />\n          Add a tip (Optional)\n        </Label>\n        \n        <div className=\"grid grid-cols-4 gap-2\">\n          {predefinedTips.map((amount) => (\n            <Button\n              key={amount}\n              type=\"button\"\n              variant={tipAmount === amount ? \"default\" : \"outline\"}\n              size=\"sm\"\n              onClick={() => updateTip(amount)}\n              disabled={updatingTip}\n              data-testid={`button-tip-${amount}`}\n              className={tipAmount === amount ? \"bg-gradient-to-r from-primary to-blue-600\" : \"\"}\n            >\n              {amount === 0 ? \"None\" : `${amount} AED`}\n            </Button>\n          ))}\n        </div>\n        \n        <div className=\"flex gap-2\">\n          <Input\n            type=\"number\"\n            placeholder=\"Custom amount\"\n            value={customTip}\n            onChange={(e) => setCustomTip(e.target.value)}\n            disabled={updatingTip}\n            min=\"0\"\n            step=\"0.01\"\n            className=\"flex-1\"\n            data-testid=\"input-custom-tip\"\n          />\n          <Button\n            type=\"button\"\n            variant=\"outline\"\n            onClick={handleCustomTipSubmit}\n            disabled={!customTip || updatingTip}\n            data-testid=\"button-apply-tip\"\n          >\n            {updatingTip ? (\n              <Loader2 className=\"h-4 w-4 animate-spin\" />\n            ) : (\n              \"Apply\"\n            )}\n          </Button>\n        </div>\n      </Card>\n\n      {/* Payment Methods */}\n      {paymentRequest && (\n        <motion.div\n          initial={{ opacity: 0, y: 10 }}\n          animate={{ opacity: 1, y: 0 }}\n        >\n          <PaymentRequestButtonElement options={{ paymentRequest }} />\n        </motion.div>\n      )}\n\n      <Card className=\"p-6 space-y-4 border-2 hover-elevate\">\n        <Label className=\"text-base font-medium flex items-center gap-2\">\n          <CreditCard className=\"w-4 h-4 text-primary\" />\n          Payment Details\n        </Label>\n        <PaymentElement />\n      </Card>\n\n      <motion.div whileHover={{ scale: 1.02 }} whileTap={{ scale: 0.98 }}>\n        <Button\n          type=\"submit\"\n          disabled={!stripe || processing}\n          className=\"w-full h-14 text-lg bg-gradient-to-r from-primary to-blue-600 hover:from-primary/90 hover:to-blue-600/90\"\n          data-testid=\"button-pay\"\n        >\n          {processing ? (\n            <>\n              <Loader2 className=\"mr-2 h-5 w-5 animate-spin\" />\n              Processing Payment...\n            </>\n          ) : (\n            <>\n              <Check className=\"mr-2 h-5 w-5\" />\n              Pay {fees.totalAmount.toFixed(2)} AED\n            </>\n          )}\n        </Button>\n      </motion.div>\n    </form>\n  );\n}\n","path":null,"size_bytes":9867,"size_tokens":null},"server/utils/emailService.ts":{"content":"import { Resend } from 'resend';\n\ninterface EmailCredentials {\n  apiKey: string;\n  fromEmail: string;\n}\n\nasync function getEmailCredentials(): Promise<EmailCredentials> {\n  const hostname = process.env.REPLIT_CONNECTORS_HOSTNAME;\n  const xReplitToken = process.env.REPL_IDENTITY\n    ? 'repl ' + process.env.REPL_IDENTITY\n    : process.env.WEB_REPL_RENEWAL\n    ? 'depl ' + process.env.WEB_REPL_RENEWAL\n    : null;\n\n  if (!xReplitToken) {\n    throw new Error('X_REPLIT_TOKEN not found for repl/depl');\n  }\n\n  const connectionSettings = await fetch(\n    'https://' + hostname + '/api/v2/connection?include_secrets=true&connector_names=resend',\n    {\n      headers: {\n        'Accept': 'application/json',\n        'X_REPLIT_TOKEN': xReplitToken\n      }\n    }\n  ).then(res => res.json()).then(data => data.items?.[0]);\n\n  if (!connectionSettings || !connectionSettings.settings.api_key) {\n    throw new Error('Resend not connected');\n  }\n\n  return {\n    apiKey: connectionSettings.settings.api_key,\n    fromEmail: connectionSettings.settings.from_email || 'noreply@washapp.ae'\n  };\n}\n\nexport interface SendEmailParams {\n  to: string;\n  subject: string;\n  html: string;\n  attachments?: Array<{\n    filename: string;\n    path: string;\n  }>;\n}\n\n/**\n * Send an email using Resend\n */\nexport async function sendEmail({ to, subject, html, attachments }: SendEmailParams): Promise<void> {\n  try {\n    const { apiKey, fromEmail } = await getEmailCredentials();\n    const resend = new Resend(apiKey);\n\n    const emailData: any = {\n      from: fromEmail,\n      to,\n      subject,\n      html,\n    };\n\n    if (attachments && attachments.length > 0) {\n      emailData.attachments = attachments;\n    }\n\n    await resend.emails.send(emailData);\n  } catch (error) {\n    console.error('Failed to send email:', error);\n    throw error;\n  }\n}\n\n/**\n * Generate email HTML for job status updates\n */\nexport function generateJobStatusEmail(params: {\n  carPlateNumber: string;\n  status: string;\n  jobId: number;\n  companyName: string;\n  cleanerName?: string;\n  completedAt?: Date;\n}): string {\n  const { carPlateNumber, status, jobId, companyName, cleanerName, completedAt } = params;\n\n  const statusMessages: Record<string, { title: string; message: string; color: string }> = {\n    paid: {\n      title: '✅ Payment Confirmed',\n      message: 'Your payment has been received. We\\'re finding a cleaner for you!',\n      color: '#10B981'\n    },\n    assigned: {\n      title: '👨‍🔧 Cleaner Assigned',\n      message: cleanerName\n        ? `${cleanerName} has been assigned to your car wash.`\n        : 'A cleaner has been assigned to your car wash.',\n      color: '#3B82F6'\n    },\n    in_progress: {\n      title: '🚿 Wash in Progress',\n      message: cleanerName\n        ? `${cleanerName} is now washing your car.`\n        : 'Your car wash is in progress.',\n      color: '#8B5CF6'\n    },\n    completed: {\n      title: '✨ Wash Completed',\n      message: 'Your car wash is complete! Thank you for using Washapp.ae',\n      color: '#059669'\n    },\n    refunded: {\n      title: '💰 Refund Processed',\n      message: 'Your payment has been refunded. We apologize for any inconvenience.',\n      color: '#DC2626'\n    }\n  };\n\n  const statusInfo = statusMessages[status] || {\n    title: 'Job Update',\n    message: `Your car wash status has been updated to: ${status}`,\n    color: '#6B7280'\n  };\n\n  return `\n    <!DOCTYPE html>\n    <html>\n    <head>\n      <meta charset=\"utf-8\">\n      <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n      <title>${statusInfo.title}</title>\n    </head>\n    <body style=\"margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6;\">\n      <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background-color: #f3f4f6; padding: 40px 20px;\">\n        <tr>\n          <td align=\"center\">\n            <table width=\"600\" cellpadding=\"0\" cellspacing=\"0\" style=\"background-color: #ffffff; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);\">\n              <!-- Header with gradient -->\n              <tr>\n                <td style=\"background: linear-gradient(135deg, #1E40AF 0%, #3B82F6 100%); padding: 40px 30px; text-align: center;\">\n                  <h1 style=\"margin: 0; color: #ffffff; font-size: 32px; font-weight: bold;\">Washapp.ae</h1>\n                </td>\n              </tr>\n              \n              <!-- Status badge -->\n              <tr>\n                <td style=\"padding: 30px 30px 20px 30px; text-align: center;\">\n                  <div style=\"display: inline-block; background-color: ${statusInfo.color}; color: #ffffff; padding: 12px 24px; border-radius: 24px; font-size: 18px; font-weight: 600;\">\n                    ${statusInfo.title}\n                  </div>\n                </td>\n              </tr>\n              \n              <!-- Message -->\n              <tr>\n                <td style=\"padding: 0 30px 30px 30px; text-align: center;\">\n                  <p style=\"margin: 0; font-size: 16px; color: #4b5563; line-height: 1.6;\">\n                    ${statusInfo.message}\n                  </p>\n                </td>\n              </tr>\n              \n              <!-- Job details -->\n              <tr>\n                <td style=\"padding: 0 30px 30px 30px;\">\n                  <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background-color: #f9fafb; border-radius: 8px; padding: 20px;\">\n                    <tr>\n                      <td style=\"padding: 8px 0;\">\n                        <span style=\"color: #6b7280; font-size: 14px;\">Job ID:</span>\n                        <span style=\"color: #111827; font-size: 14px; font-weight: 600; float: right;\">#${jobId}</span>\n                      </td>\n                    </tr>\n                    <tr>\n                      <td style=\"padding: 8px 0; border-top: 1px solid #e5e7eb;\">\n                        <span style=\"color: #6b7280; font-size: 14px;\">Car Plate:</span>\n                        <span style=\"color: #111827; font-size: 14px; font-weight: 600; float: right;\">${carPlateNumber}</span>\n                      </td>\n                    </tr>\n                    <tr>\n                      <td style=\"padding: 8px 0; border-top: 1px solid #e5e7eb;\">\n                        <span style=\"color: #6b7280; font-size: 14px;\">Company:</span>\n                        <span style=\"color: #111827; font-size: 14px; font-weight: 600; float: right;\">${companyName}</span>\n                      </td>\n                    </tr>\n                    ${completedAt ? `\n                    <tr>\n                      <td style=\"padding: 8px 0; border-top: 1px solid #e5e7eb;\">\n                        <span style=\"color: #6b7280; font-size: 14px;\">Completed At:</span>\n                        <span style=\"color: #111827; font-size: 14px; font-weight: 600; float: right;\">${new Date(completedAt).toLocaleString('en-AE')}</span>\n                      </td>\n                    </tr>\n                    ` : ''}\n                  </table>\n                </td>\n              </tr>\n              \n              <!-- Footer -->\n              <tr>\n                <td style=\"padding: 30px; text-align: center; border-top: 1px solid #e5e7eb;\">\n                  <p style=\"margin: 0; font-size: 14px; color: #6b7280;\">\n                    Thank you for choosing Washapp.ae\n                  </p>\n                  <p style=\"margin: 10px 0 0 0; font-size: 12px; color: #9ca3af;\">\n                    This is an automated email. Please do not reply.\n                  </p>\n                </td>\n              </tr>\n            </table>\n          </td>\n        </tr>\n      </table>\n    </body>\n    </html>\n  `;\n}\n","path":null,"size_bytes":7699,"size_tokens":null},"server/utils/receiptGenerator.ts":{"content":"import PDFDocument from 'pdfkit';\nimport { createWriteStream } from 'fs';\nimport { mkdir } from 'fs/promises';\nimport { join } from 'path';\nimport { existsSync } from 'fs';\nimport type { PlatformSetting } from '@shared/schema';\n\nexport interface ReceiptData {\n  receiptNumber: string;\n  jobId: number;\n  carPlateNumber: string; // Already formatted (e.g. \"Abu Dhabi A 12345\")\n  customerPhone: string;\n  customerEmail?: string;\n  locationAddress: string;\n  servicePrice: number; // Base car wash price\n  platformFee: number; // Platform fee amount\n  tipAmount: number; // Tip amount (VAT-exempt)\n  vatAmount: number; // Total VAT amount (on service only, NOT on tip)\n  totalAmount: number; // Total paid (service + VAT + tip)\n  paymentMethod: string;\n  completedAt: Date;\n}\n\nexport interface GenerateReceiptOptions {\n  receiptData: ReceiptData;\n  platformSettings: PlatformSetting;\n}\n\n/**\n * Generate a PDF receipt and save it to the uploads folder\n * @returns Promise<string> - Path to the generated PDF file\n */\nexport async function generateReceipt({ receiptData, platformSettings }: GenerateReceiptOptions): Promise<string> {\n  // Ensure uploads directory exists\n  const uploadsDir = join(process.cwd(), 'uploads', 'receipts');\n  await mkdir(uploadsDir, { recursive: true });\n\n  const filename = `receipt-${receiptData.receiptNumber}.pdf`;\n  const filePath = join(uploadsDir, filename);\n\n  // Fetch logo if needed (before creating the PDF)\n  let logoSource: string | Buffer | null = null;\n  \n  if (platformSettings.logoUrl) {\n    try {\n      const isRemoteUrl = platformSettings.logoUrl.startsWith('http://') || \n                         platformSettings.logoUrl.startsWith('https://');\n      \n      if (isRemoteUrl) {\n        // Fetch remote logo and convert to Buffer\n        const response = await fetch(platformSettings.logoUrl);\n        if (!response.ok) {\n          throw new Error(`Failed to fetch remote logo: ${response.statusText}`);\n        }\n        const arrayBuffer = await response.arrayBuffer();\n        logoSource = Buffer.from(arrayBuffer);\n      } else {\n        // Local file path - remove leading slash and join with process.cwd()\n        const relativePath = platformSettings.logoUrl.startsWith('/') \n          ? platformSettings.logoUrl.slice(1) \n          : platformSettings.logoUrl;\n        const localPath = join(process.cwd(), relativePath);\n        \n        // Verify local file exists\n        if (existsSync(localPath)) {\n          logoSource = localPath;\n        } else {\n          console.warn('Logo file not found:', localPath);\n        }\n      }\n    } catch (error) {\n      console.error('Error loading logo for receipt:', error);\n      // Continue without logo if there's an error\n    }\n  }\n\n  return new Promise((resolve, reject) => {\n    try {\n      // Create a PDF document\n      const doc = new PDFDocument({ size: 'A4', margin: 50 });\n      const stream = createWriteStream(filePath);\n\n      doc.pipe(stream);\n\n      // Add logo at the top if it was successfully loaded\n      if (logoSource) {\n        try {\n          // Calculate center position for logo\n          const logoWidth = 80;\n          const logoHeight = 80;\n          const pageWidth = doc.page.width;\n          const logoX = (pageWidth - logoWidth) / 2;\n          \n          // Add logo image (PDFKit accepts both file paths and Buffers)\n          doc.image(logoSource, logoX, doc.y, {\n            fit: [logoWidth, logoHeight],\n            align: 'center',\n          });\n          \n          doc.moveDown(5); // Add space after logo\n        } catch (error) {\n          console.error('Error adding logo to receipt:', error);\n          // Continue without logo if there's an error\n        }\n      }\n\n      // Header with company name\n      doc.fontSize(24)\n        .font('Helvetica-Bold')\n        .text(platformSettings.companyName, { align: 'center' });\n\n      doc.moveDown(0.5);\n\n      // Company details\n      doc.fontSize(10)\n        .font('Helvetica')\n        .text(platformSettings.companyAddress, { align: 'center' });\n\n      if (platformSettings.vatRegistrationNumber) {\n        doc.text(`VAT Registration Number: ${platformSettings.vatRegistrationNumber}`, { align: 'center' });\n      }\n\n      doc.moveDown(1.5);\n\n      // Receipt title\n      doc.fontSize(18)\n        .font('Helvetica-Bold')\n        .text('RECEIPT', { align: 'center' });\n\n      doc.moveDown(1);\n\n      // Receipt details in two columns\n      const leftColumn = 70;\n      const rightColumn = 320;\n      let yPos = doc.y;\n\n      // Left column - Receipt info\n      doc.fontSize(10)\n        .font('Helvetica-Bold')\n        .text('Receipt Number:', leftColumn, yPos);\n      doc.font('Helvetica')\n        .text(receiptData.receiptNumber, leftColumn + 100, yPos);\n\n      yPos += 20;\n      doc.font('Helvetica-Bold')\n        .text('Receipt Date:', leftColumn, yPos);\n      doc.font('Helvetica')\n        .text(new Date(receiptData.completedAt).toLocaleString('en-AE', {\n          year: 'numeric',\n          month: 'long',\n          day: 'numeric',\n          hour: '2-digit',\n          minute: '2-digit',\n          hour12: true,\n          timeZone: 'Asia/Dubai'\n        }), leftColumn + 100, yPos);\n\n      yPos += 20;\n      doc.font('Helvetica-Bold')\n        .text('Payment Method:', leftColumn, yPos);\n      doc.font('Helvetica')\n        .text(receiptData.paymentMethod === 'card' ? 'Card' : receiptData.paymentMethod, leftColumn + 100, yPos);\n\n      // Right column - Car & customer info\n      yPos = doc.y - 60; // Reset to top\n\n      doc.font('Helvetica-Bold')\n        .text('Car Plate:', rightColumn, yPos);\n      doc.font('Helvetica')\n        .text(receiptData.carPlateNumber, rightColumn + 80, yPos);\n\n      yPos += 20;\n      doc.font('Helvetica-Bold')\n        .text('Phone:', rightColumn, yPos);\n      doc.font('Helvetica')\n        .text(receiptData.customerPhone, rightColumn + 80, yPos);\n\n      if (receiptData.customerEmail) {\n        yPos += 20;\n        doc.font('Helvetica-Bold')\n          .text('Email:', rightColumn, yPos);\n        doc.font('Helvetica')\n          .text(receiptData.customerEmail, rightColumn + 80, yPos, { width: 200 });\n      }\n\n      doc.moveDown(3);\n\n      // Location\n      yPos = doc.y;\n      doc.font('Helvetica-Bold')\n        .text('Service Location:', leftColumn, yPos);\n      doc.font('Helvetica')\n        .text(receiptData.locationAddress, leftColumn, yPos + 15, { width: 470 });\n\n      doc.moveDown(2);\n\n      // Service details table\n      const tableTop = doc.y;\n      const tableLeft = 70;\n      const tableWidth = 470;\n\n      // Table header background\n      doc.rect(tableLeft, tableTop, tableWidth, 25)\n        .fillAndStroke('#1E40AF', '#1E40AF');\n\n      // Table header text\n      doc.fontSize(11)\n        .font('Helvetica-Bold')\n        .fillColor('#FFFFFF')\n        .text('Description', tableLeft + 10, tableTop + 8, { width: 240 })\n        .text('Amount (AED)', tableLeft + 260, tableTop + 8, { width: 200, align: 'right' });\n\n      // Reset fill color for table body\n      doc.fillColor('#000000');\n\n      let currentY = tableTop + 25;\n\n      // Service cost row (car wash price + platform fee)\n      const serviceCost = receiptData.servicePrice + receiptData.platformFee;\n      \n      doc.fontSize(10)\n        .font('Helvetica')\n        .text('Car Wash Service', tableLeft + 10, currentY + 8, { width: 240 })\n        .text(serviceCost.toFixed(2), tableLeft + 260, currentY + 8, { width: 200, align: 'right' });\n\n      doc.rect(tableLeft, currentY, tableWidth, 25).stroke('#CCCCCC');\n      currentY += 25;\n\n      // VAT row (use actual VAT amount from financials - only on service, NOT on tip)\n      doc.font('Helvetica')\n        .text('VAT (5%)', tableLeft + 10, currentY + 8, { width: 240 })\n        .text(receiptData.vatAmount.toFixed(2), tableLeft + 260, currentY + 8, { width: 200, align: 'right' });\n\n      doc.rect(tableLeft, currentY, tableWidth, 25).stroke('#CCCCCC');\n      currentY += 25;\n\n      // Tip row (separate line, VAT-exempt)\n      if (receiptData.tipAmount > 0) {\n        doc.font('Helvetica')\n          .text('Tip for Cleaner', tableLeft + 10, currentY + 8, { width: 240 })\n          .text(receiptData.tipAmount.toFixed(2), tableLeft + 260, currentY + 8, { width: 200, align: 'right' });\n\n        doc.rect(tableLeft, currentY, tableWidth, 25).stroke('#CCCCCC');\n        currentY += 25;\n      }\n\n      // Total row with background\n      doc.rect(tableLeft, currentY, tableWidth, 30)\n        .fillAndStroke('#F3F4F6', '#CCCCCC');\n\n      doc.fontSize(12)\n        .font('Helvetica-Bold')\n        .fillColor('#000000')\n        .text('Total', tableLeft + 10, currentY + 10, { width: 240 })\n        .text(`AED ${receiptData.totalAmount.toFixed(2)}`, tableLeft + 260, currentY + 10, { width: 200, align: 'right' });\n\n      doc.moveDown(3);\n\n      // Footer\n      doc.fontSize(9)\n        .font('Helvetica')\n        .fillColor('#666666')\n        .text('Thank you for using Washapp.ae!', { align: 'center' });\n\n      doc.moveDown(0.5);\n      doc.fontSize(8)\n        .text('This is a computer-generated receipt and does not require a signature.', { align: 'center' });\n\n      // Finalize the PDF\n      doc.end();\n\n      stream.on('finish', () => {\n        resolve(filePath);\n      });\n\n      stream.on('error', (error) => {\n        reject(error);\n      });\n    } catch (error) {\n      reject(error);\n    }\n  });\n}\n\n/**\n * Generate a unique receipt number\n * Format: RCP-YYYYMMDD-XXXXX\n */\nexport function generateReceiptNumber(): string {\n  const date = new Date();\n  const year = date.getFullYear();\n  const month = String(date.getMonth() + 1).padStart(2, '0');\n  const day = String(date.getDate()).padStart(2, '0');\n  const random = Math.floor(Math.random() * 99999).toString().padStart(5, '0');\n  \n  return `RCP-${year}${month}${day}-${random}`;\n}\n","path":null,"size_bytes":9788,"size_tokens":null},"server/utils/ensureAdmin.ts":{"content":"import { db } from \"../db\";\nimport { users } from \"@shared/schema\";\nimport { eq } from \"drizzle-orm\";\nimport bcrypt from \"bcryptjs\";\n\nexport async function ensureAdminExists() {\n  const adminAccounts = [\n    {\n      email: \"omer.eldirdiri@gmail.com\",\n      password: \"Network#123\",\n      displayName: \"Omer Eldirdieri\"\n    },\n    {\n      email: \"test.admin@example.com\",\n      password: \"TestAdmin123!\",\n      displayName: \"Test Admin\"\n    }\n  ];\n  \n  for (const account of adminAccounts) {\n    try {\n      const hashedPassword = await bcrypt.hash(account.password, 10);\n      \n      const existing = await db.select().from(users).where(eq(users.email, account.email)).limit(1);\n      \n      if (existing.length > 0) {\n        await db.update(users)\n          .set({ passwordHash: hashedPassword })\n          .where(eq(users.email, account.email));\n        console.log(`✓ Admin password updated: ${account.email}`);\n      } else {\n        await db.insert(users).values({\n          email: account.email,\n          passwordHash: hashedPassword,\n          displayName: account.displayName,\n          role: \"admin\",\n        });\n        console.log(`✓ Admin user created: ${account.email}`);\n      }\n    } catch (error) {\n      console.error(`Failed to ensure admin exists for ${account.email}:`, error);\n    }\n  }\n}\n","path":null,"size_bytes":1316,"size_tokens":null},"shared/fee-calculator.ts":{"content":"/**\n * Fee calculation utilities for Washapp.ae\n * Supports three fee package types with consistent VAT calculations\n */\n\nexport type FeePackageType = \"custom\" | \"package1\" | \"package2\";\n\nexport interface FeeCalculationInput {\n  carWashPrice: number;\n  feePackageType: FeePackageType;\n  platformFee: number; // Custom amount for \"custom\" type, ignored for package1/package2\n}\n\nexport interface FeeCalculationResult {\n  carWashPrice: number;\n  platformFeeAmount: number;\n  servicePrice: number; // Combined: carWash + platformFee (for customer display)\n  subtotal: number; // carWash + platformFee (same as servicePrice, kept for backend)\n  vatAmount: number; // 5% of subtotal\n  totalAmount: number; // subtotal + VAT\n  displayBreakdown: string; // What to show customer\n}\n\nconst VAT_RATE = 0.05; // 5% VAT\n\n/**\n * Calculate all fees based on package type\n * \n * Custom: platformFee is the custom amount (e.g., 3 AED)\n * Package1: 2 AED + 5% of car wash price\n * Package2: 0 AED (offline payment, only car wash + VAT)\n */\nexport function calculateFees(input: FeeCalculationInput): FeeCalculationResult {\n  const { carWashPrice, feePackageType, platformFee } = input;\n  \n  // Normalize package type to handle case sensitivity and undefined values\n  const packageType = ((feePackageType ?? \"custom\") as string).toLowerCase() as FeePackageType;\n  \n  let platformFeeAmount: number;\n  \n  switch (packageType) {\n    case \"custom\":\n      // Custom fee amount set by admin\n      platformFeeAmount = platformFee;\n      break;\n      \n    case \"package1\":\n      // 2 AED + 5% of car wash price\n      platformFeeAmount = 2 + (carWashPrice * 0.05);\n      break;\n      \n    case \"package2\":\n      // Offline payment - no platform fee charged to customer\n      platformFeeAmount = 0;\n      break;\n      \n    default:\n      platformFeeAmount = platformFee;\n  }\n  \n  // Round platform fee to 2 decimals\n  platformFeeAmount = Math.round(platformFeeAmount * 100) / 100;\n  \n  // Calculate subtotal (car wash + platform fee)\n  const subtotal = carWashPrice + platformFeeAmount;\n  \n  // Calculate service price (same as subtotal, for customer display)\n  const servicePrice = subtotal;\n  \n  // Calculate VAT (5% of subtotal)\n  const vatAmount = Math.round(subtotal * VAT_RATE * 100) / 100;\n  \n  // Calculate total\n  const totalAmount = Math.round((subtotal + vatAmount) * 100) / 100;\n  \n  // Create display breakdown - show combined service price for customer\n  const displayBreakdown = `Service price is ${servicePrice.toFixed(2)} AED + VAT 5%`;\n  \n  return {\n    carWashPrice,\n    platformFeeAmount,\n    servicePrice,\n    subtotal,\n    vatAmount,\n    totalAmount,\n    displayBreakdown,\n  };\n}\n\n/**\n * Helper to get fee package display name\n */\nexport function getFeePackageDisplayName(type: FeePackageType): string {\n  switch (type) {\n    case \"custom\":\n      return \"Custom Fee\";\n    case \"package1\":\n      return \"Package 1 (2 AED + 5%)\";\n    case \"package2\":\n      return \"Package 2 (Offline Payment)\";\n    default:\n      return \"Unknown\";\n  }\n}\n\n/**\n * Helper to get fee package description\n */\nexport function getFeePackageDescription(type: FeePackageType, customAmount?: number): string {\n  switch (type) {\n    case \"custom\":\n      return `Custom platform fee of ${customAmount?.toFixed(2) || \"0.00\"} AED + VAT`;\n    case \"package1\":\n      return \"2 AED + 5% of car wash price + VAT\";\n    case \"package2\":\n      return \"Offline payment - company pays platform fees separately\";\n    default:\n      return \"\";\n  }\n}\n","path":null,"size_bytes":3499,"size_tokens":null},"server/utils/updateVersion.ts":{"content":"import { writeFileSync } from 'fs';\nimport path from 'path';\n\nexport function updateVersionFile() {\n  const versionData = {\n    version: '1.0.0',\n    buildTimestamp: Date.now()\n  };\n  \n  const versionPath = path.join(process.cwd(), 'client', 'public', 'version.json');\n  \n  try {\n    writeFileSync(versionPath, JSON.stringify(versionData));\n    console.log('✓ Version file updated');\n  } catch (error) {\n    console.error('Failed to update version file:', error);\n  }\n}\n","path":null,"size_bytes":472,"size_tokens":null},"client/src/hooks/useVersionCheck.ts":{"content":"import { useEffect } from 'react';\n\nexport function useVersionCheck() {\n  useEffect(() => {\n    if ('serviceWorker' in navigator) {\n      navigator.serviceWorker.addEventListener('message', (event) => {\n        if (event.data && event.data.type === 'NEW_VERSION_AVAILABLE') {\n          console.log('New version available, reloading...');\n          window.location.reload();\n        }\n      });\n    }\n  }, []);\n}\n","path":null,"size_bytes":412,"size_tokens":null},"client/src/pages/admin-settings.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Settings, Upload, Image as ImageIcon } from \"lucide-react\";\nimport type { PlatformSetting } from \"@shared/schema\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\n\nexport default function AdminSettings() {\n  const { toast } = useToast();\n  const [companyName, setCompanyName] = useState(\"\");\n  const [companyAddress, setCompanyAddress] = useState(\"\");\n  const [vatNumber, setVatNumber] = useState(\"\");\n  const [logoFile, setLogoFile] = useState<File | null>(null);\n  const [logoPreview, setLogoPreview] = useState<string | null>(null);\n\n  const { data: settings, isLoading } = useQuery<PlatformSetting>({\n    queryKey: [\"/api/admin/platform-settings\"],\n    refetchOnWindowFocus: false,\n  });\n\n  // Initialize form fields when settings are loaded\n  useEffect(() => {\n    if (settings) {\n      setCompanyName(settings.companyName || \"\");\n      setCompanyAddress(settings.companyAddress || \"\");\n      setVatNumber(settings.vatRegistrationNumber || \"\");\n      if (settings.logoUrl) {\n        setLogoPreview(settings.logoUrl);\n      }\n    }\n  }, [settings]);\n\n  const updateSettingsMutation = useMutation({\n    mutationFn: async (data: {\n      companyName: string;\n      companyAddress: string;\n      vatRegistrationNumber: string;\n      logoUrl?: string;\n    }) => {\n      return await apiRequest(\"PATCH\", \"/api/admin/platform-settings\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/platform-settings\"] });\n      toast({\n        title: \"Settings Updated\",\n        description: \"Platform settings have been updated successfully.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleLogoChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const file = e.target.files?.[0];\n    if (file) {\n      if (!file.type.startsWith('image/')) {\n        toast({\n          title: \"Invalid File\",\n          description: \"Please select an image file.\",\n          variant: \"destructive\",\n        });\n        return;\n      }\n      if (file.size > 5 * 1024 * 1024) {\n        toast({\n          title: \"File Too Large\",\n          description: \"Logo must be less than 5MB.\",\n          variant: \"destructive\",\n        });\n        return;\n      }\n      setLogoFile(file);\n      const reader = new FileReader();\n      reader.onloadend = () => {\n        setLogoPreview(reader.result as string);\n      };\n      reader.readAsDataURL(file);\n    }\n  };\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n\n    let logoUrl = settings?.logoUrl;\n\n    // Upload logo if changed\n    if (logoFile) {\n      const formData = new FormData();\n      formData.append(\"logo\", logoFile);\n\n      try {\n        const response = await fetch(\"/api/upload/logo\", {\n          method: \"POST\",\n          body: formData,\n          credentials: \"include\",\n        });\n\n        if (!response.ok) {\n          throw new Error(\"Failed to upload logo\");\n        }\n\n        const { url } = await response.json();\n        logoUrl = url;\n      } catch (error) {\n        toast({\n          title: \"Upload Failed\",\n          description: \"Failed to upload logo. Please try again.\",\n          variant: \"destructive\",\n        });\n        return;\n      }\n    }\n\n    updateSettingsMutation.mutate({\n      companyName,\n      companyAddress,\n      vatRegistrationNumber: vatNumber,\n      logoUrl,\n    });\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"container mx-auto p-6 space-y-6\">\n        <Skeleton className=\"h-8 w-64\" />\n        <Skeleton className=\"h-96 w-full\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"container mx-auto p-6 space-y-6\">\n      <div className=\"flex items-center gap-3\">\n        <Settings className=\"h-8 w-8 text-primary\" data-testid=\"icon-settings\" />\n        <h1 className=\"text-3xl font-bold\" data-testid=\"text-page-title\">Platform Settings</h1>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Receipt & Branding Settings</CardTitle>\n          <CardDescription>\n            Update company information that appears on receipts and the PWA home screen\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <form onSubmit={handleSubmit} className=\"space-y-6\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"companyName\">Company Name</Label>\n              <Input\n                id=\"companyName\"\n                data-testid=\"input-company-name\"\n                value={companyName}\n                onChange={(e) => setCompanyName(e.target.value)}\n                placeholder=\"Washapp.ae\"\n                required\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"companyAddress\">Company Address</Label>\n              <Textarea\n                id=\"companyAddress\"\n                data-testid=\"input-company-address\"\n                value={companyAddress}\n                onChange={(e) => setCompanyAddress(e.target.value)}\n                placeholder=\"Dubai, United Arab Emirates\"\n                rows={3}\n                required\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"vatNumber\">VAT Registration Number</Label>\n              <Input\n                id=\"vatNumber\"\n                data-testid=\"input-vat-number\"\n                value={vatNumber}\n                onChange={(e) => setVatNumber(e.target.value)}\n                placeholder=\"Enter VAT registration number\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"logo\">Platform Logo</Label>\n              <div className=\"flex items-start gap-4\">\n                <div className=\"flex-1\">\n                  <Input\n                    id=\"logo\"\n                    data-testid=\"input-logo-upload\"\n                    type=\"file\"\n                    accept=\"image/*\"\n                    onChange={handleLogoChange}\n                    className=\"cursor-pointer\"\n                  />\n                  <p className=\"text-sm text-muted-foreground mt-2\">\n                    Upload a square logo (recommended 512x512px). Used in receipts and PWA home screen.\n                  </p>\n                </div>\n                {logoPreview && (\n                  <div className=\"shrink-0\">\n                    <div className=\"w-24 h-24 border rounded-lg overflow-hidden bg-white flex items-center justify-center\">\n                      <img\n                        src={logoPreview}\n                        alt=\"Logo preview\"\n                        className=\"max-w-full max-h-full object-contain\"\n                        data-testid=\"img-logo-preview\"\n                      />\n                    </div>\n                  </div>\n                )}\n                {!logoPreview && (\n                  <div className=\"w-24 h-24 border rounded-lg bg-muted flex items-center justify-center\">\n                    <ImageIcon className=\"h-8 w-8 text-muted-foreground\" />\n                  </div>\n                )}\n              </div>\n            </div>\n\n            <div className=\"flex justify-end\">\n              <Button\n                type=\"submit\"\n                data-testid=\"button-save-settings\"\n                disabled={updateSettingsMutation.isPending}\n              >\n                {updateSettingsMutation.isPending ? (\n                  <>\n                    <Upload className=\"mr-2 h-4 w-4 animate-spin\" />\n                    Saving...\n                  </>\n                ) : (\n                  <>\n                    <Upload className=\"mr-2 h-4 w-4\" />\n                    Save Settings\n                  </>\n                )}\n              </Button>\n            </div>\n          </form>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":8390,"size_tokens":null},"client/src/pages/reset-password.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useLocation, useSearch } from \"wouter\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Button } from \"@/components/ui/button\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Loader2, CheckCircle2, XCircle } from \"lucide-react\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport logoUrl from \"@assets/IMG_2508_1762619079711.png\";\n\nexport default function ResetPasswordPage() {\n  const [, setLocation] = useLocation();\n  const searchParams = new URLSearchParams(useSearch());\n  const token = searchParams.get(\"token\");\n  \n  const { toast } = useToast();\n  const [newPassword, setNewPassword] = useState(\"\");\n  const [confirmPassword, setConfirmPassword] = useState(\"\");\n  const [submitting, setSubmitting] = useState(false);\n  const [validating, setValidating] = useState(true);\n  const [isValidToken, setIsValidToken] = useState(false);\n  const [resetSuccess, setResetSuccess] = useState(false);\n\n  useEffect(() => {\n    const validateToken = async () => {\n      if (!token) {\n        setValidating(false);\n        setIsValidToken(false);\n        return;\n      }\n\n      try {\n        const response = await fetch(`/api/auth/verify-reset-token/${token}`);\n        const data = await response.json();\n        \n        setIsValidToken(data.valid);\n        \n        if (!data.valid) {\n          toast({\n            title: \"Invalid Token\",\n            description: data.message || \"This reset link is invalid or has expired\",\n            variant: \"destructive\",\n          });\n        }\n      } catch (error) {\n        setIsValidToken(false);\n        toast({\n          title: \"Error\",\n          description: \"Failed to validate reset token\",\n          variant: \"destructive\",\n        });\n      } finally {\n        setValidating(false);\n      }\n    };\n\n    validateToken();\n  }, [token, toast]);\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (newPassword !== confirmPassword) {\n      toast({\n        title: \"Error\",\n        description: \"Passwords do not match\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (newPassword.length < 6) {\n      toast({\n        title: \"Error\",\n        description: \"Password must be at least 6 characters long\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setSubmitting(true);\n    \n    try {\n      const response = await apiRequest(\"POST\", \"/api/auth/reset-password\", {\n        token,\n        newPassword,\n      });\n      const data = await response.json();\n      \n      setResetSuccess(true);\n      toast({\n        title: \"Success\",\n        description: data.message,\n      });\n    } catch (error: any) {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to reset password\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setSubmitting(false);\n    }\n  };\n\n  if (validating) {\n    return (\n      <div className=\"min-h-screen bg-background flex items-center justify-center\">\n        <div className=\"text-center\">\n          <Loader2 className=\"h-8 w-8 animate-spin text-primary mx-auto mb-4\" />\n          <p className=\"text-muted-foreground\">Validating reset token...</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (!isValidToken) {\n    return (\n      <div className=\"min-h-screen bg-background flex items-center justify-center p-4\">\n        <Card className=\"w-full max-w-md\">\n          <CardHeader className=\"text-center space-y-2\">\n            <div className=\"flex items-center justify-center mb-4\">\n              <div className=\"h-16 w-16 rounded-full bg-destructive/10 flex items-center justify-center\">\n                <XCircle className=\"h-8 w-8 text-destructive\" />\n              </div>\n            </div>\n            <CardTitle>Invalid Reset Link</CardTitle>\n            <CardDescription className=\"text-base\">\n              This password reset link is invalid or has expired\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <Button\n              onClick={() => setLocation(\"/forgot-password\")}\n              className=\"w-full\"\n              data-testid=\"button-request-new\"\n            >\n              Request New Reset Link\n            </Button>\n            <Button\n              onClick={() => setLocation(\"/login\")}\n              variant=\"ghost\"\n              className=\"w-full\"\n              data-testid=\"button-back-login\"\n            >\n              Back to Login\n            </Button>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  if (resetSuccess) {\n    return (\n      <div className=\"min-h-screen bg-background flex items-center justify-center p-4\">\n        <Card className=\"w-full max-w-md\">\n          <CardHeader className=\"text-center space-y-2\">\n            <div className=\"flex items-center justify-center mb-4\">\n              <div className=\"h-16 w-16 rounded-full bg-primary/10 flex items-center justify-center\">\n                <CheckCircle2 className=\"h-8 w-8 text-primary\" />\n              </div>\n            </div>\n            <CardTitle>Password Reset Successful</CardTitle>\n            <CardDescription className=\"text-base\">\n              Your password has been successfully reset\n            </CardDescription>\n          </CardHeader>\n          <CardContent>\n            <Button\n              onClick={() => setLocation(\"/login\")}\n              className=\"w-full\"\n              data-testid=\"button-login\"\n            >\n              Continue to Login\n            </Button>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-background flex items-center justify-center p-4\">\n      <Card className=\"w-full max-w-md\">\n        <CardHeader className=\"text-center space-y-2\">\n          <div className=\"flex items-center justify-center mb-4\">\n            <img src={logoUrl} alt=\"Washapp.ae\" className=\"h-24 w-auto\" data-testid=\"img-logo\" />\n          </div>\n          <CardTitle>Reset Password</CardTitle>\n          <CardDescription className=\"text-base\">\n            Enter your new password\n          </CardDescription>\n        </CardHeader>\n        <form onSubmit={handleSubmit}>\n          <CardContent className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"newPassword\">New Password</Label>\n              <Input\n                id=\"newPassword\"\n                type=\"password\"\n                placeholder=\"••••••••\"\n                value={newPassword}\n                onChange={(e) => setNewPassword(e.target.value)}\n                required\n                minLength={6}\n                data-testid=\"input-new-password\"\n              />\n            </div>\n            \n            <div className=\"space-y-2\">\n              <Label htmlFor=\"confirmPassword\">Confirm Password</Label>\n              <Input\n                id=\"confirmPassword\"\n                type=\"password\"\n                placeholder=\"••••••••\"\n                value={confirmPassword}\n                onChange={(e) => setConfirmPassword(e.target.value)}\n                required\n                minLength={6}\n                data-testid=\"input-confirm-password\"\n              />\n            </div>\n            \n            <Button\n              type=\"submit\"\n              className=\"w-full\"\n              size=\"lg\"\n              disabled={submitting}\n              data-testid=\"button-reset-password\"\n            >\n              {submitting ? (\n                <>\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                  Resetting Password...\n                </>\n              ) : (\n                \"Reset Password\"\n              )}\n            </Button>\n          </CardContent>\n        </form>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":7958,"size_tokens":null},"client/src/pages/forgot-password.tsx":{"content":"import { useState } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Button } from \"@/components/ui/button\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Loader2, ArrowLeft, Mail } from \"lucide-react\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport logoUrl from \"@assets/IMG_2508_1762619079711.png\";\n\nexport default function ForgotPasswordPage() {\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  const [email, setEmail] = useState(\"\");\n  const [submitting, setSubmitting] = useState(false);\n  const [emailSent, setEmailSent] = useState(false);\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    setSubmitting(true);\n    \n    try {\n      const response = await apiRequest(\"POST\", \"/api/auth/forgot-password\", { email });\n      const data = await response.json();\n      \n      setEmailSent(true);\n      toast({\n        title: \"Email sent\",\n        description: data.message,\n      });\n    } catch (error: any) {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to send reset email\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setSubmitting(false);\n    }\n  };\n\n  if (emailSent) {\n    return (\n      <div className=\"min-h-screen bg-background flex items-center justify-center p-4\">\n        <Card className=\"w-full max-w-md\">\n          <CardHeader className=\"text-center space-y-2\">\n            <div className=\"flex items-center justify-center mb-4\">\n              <div className=\"h-16 w-16 rounded-full bg-primary/10 flex items-center justify-center\">\n                <Mail className=\"h-8 w-8 text-primary\" />\n              </div>\n            </div>\n            <CardTitle>Check Your Email</CardTitle>\n            <CardDescription className=\"text-base\">\n              We've sent password reset instructions to {email}\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <p className=\"text-sm text-muted-foreground text-center\">\n              If you don't see the email, check your spam folder or try again.\n            </p>\n            <Button\n              onClick={() => setLocation(\"/login\")}\n              className=\"w-full\"\n              data-testid=\"button-back-login\"\n            >\n              Back to Login\n            </Button>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-background flex items-center justify-center p-4\">\n      <Card className=\"w-full max-w-md\">\n        <CardHeader className=\"text-center space-y-2\">\n          <div className=\"flex items-center justify-center mb-4\">\n            <img src={logoUrl} alt=\"Washapp.ae\" className=\"h-24 w-auto\" data-testid=\"img-logo\" />\n          </div>\n          <CardTitle>Forgot Password</CardTitle>\n          <CardDescription className=\"text-base\">\n            Enter your email address and we'll send you a link to reset your password\n          </CardDescription>\n        </CardHeader>\n        <form onSubmit={handleSubmit}>\n          <CardContent className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"email\">Email</Label>\n              <Input\n                id=\"email\"\n                type=\"email\"\n                placeholder=\"your@email.com\"\n                value={email}\n                onChange={(e) => setEmail(e.target.value)}\n                required\n                data-testid=\"input-email\"\n              />\n            </div>\n            \n            <Button\n              type=\"submit\"\n              className=\"w-full\"\n              size=\"lg\"\n              disabled={submitting}\n              data-testid=\"button-send-reset\"\n            >\n              {submitting ? (\n                <>\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                  Sending...\n                </>\n              ) : (\n                \"Send Reset Link\"\n              )}\n            </Button>\n            \n            <Button\n              type=\"button\"\n              variant=\"ghost\"\n              onClick={() => setLocation(\"/login\")}\n              className=\"w-full\"\n              data-testid=\"button-back-login\"\n            >\n              <ArrowLeft className=\"mr-2 h-4 w-4\" />\n              Back to Login\n            </Button>\n          </CardContent>\n        </form>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":4585,"size_tokens":null},"client/src/pages/admin-complaints.tsx":{"content":"import { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Complaint } from \"@shared/schema\";\nimport { useState, useMemo } from \"react\";\nimport { CheckCircle2, DollarSign, Search } from \"lucide-react\";\n\nexport default function AdminComplaints() {\n  const { toast } = useToast();\n  const [selectedComplaint, setSelectedComplaint] = useState<Complaint | null>(null);\n  const [statusFilter, setStatusFilter] = useState<string>(\"all\");\n  const [searchReference, setSearchReference] = useState<string>(\"\");\n\n  const { data: complaints = [], isLoading } = useQuery<Complaint[]>({\n    queryKey: [\"/api/admin/complaints\"],\n  });\n\n  // Filter complaints based on status and search\n  const filteredComplaints = useMemo(() => {\n    return complaints.filter((complaint) => {\n      const matchesStatus = statusFilter === \"all\" || complaint.status === statusFilter;\n      const matchesSearch = searchReference === \"\" || \n        complaint.referenceNumber.toLowerCase().includes(searchReference.toLowerCase());\n      return matchesStatus && matchesSearch;\n    });\n  }, [complaints, statusFilter, searchReference]);\n\n  const refundMutation = useMutation({\n    mutationFn: async (complaintId: number) => {\n      const response = await fetch(`/api/complaints/${complaintId}/refund`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n      });\n      \n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.message || \"Failed to process refund\");\n      }\n      \n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/complaints\"] });\n      setSelectedComplaint(null);\n      toast({\n        title: \"Refund Processed\",\n        description: \"The refund has been processed successfully.\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Refund Failed\",\n        description: error.message || \"Failed to process refund\",\n      });\n    },\n  });\n\n  const getStatusBadge = (status: string) => {\n    const variants: Record<string, any> = {\n      pending: \"secondary\",\n      in_progress: \"default\",\n      resolved: \"outline\",\n      refunded: \"outline\",\n    };\n    const labels: Record<string, string> = {\n      pending: \"Pending\",\n      in_progress: \"In Progress\",\n      resolved: \"Resolved\",\n      refunded: \"Refunded\",\n    };\n    return <Badge variant={variants[status] || \"secondary\"}>{labels[status] || status}</Badge>;\n  };\n\n  const getTypeBadge = (type: string) => {\n    return type === 'refund_request' ? (\n      <Badge variant=\"destructive\">Refund Request</Badge>\n    ) : (\n      <Badge variant=\"secondary\">General</Badge>\n    );\n  };\n\n  return (\n    <div className=\"min-h-screen bg-background p-4 pb-20\">\n      <div className=\"max-w-7xl mx-auto\">\n        <div className=\"mb-6 pt-4\">\n          <h1 className=\"text-2xl font-bold text-foreground mb-1\">\n            Platform Complaints\n          </h1>\n          <p className=\"text-muted-foreground\">\n            Review and manage all customer complaints\n          </p>\n        </div>\n\n        <Card>\n          <CardHeader>\n            <CardTitle>All Complaints</CardTitle>\n            <CardDescription>\n              {filteredComplaints.length} of {complaints.length} complaints\n            </CardDescription>\n          </CardHeader>\n          <CardContent>\n            {/* Filters */}\n            <div className=\"flex flex-col sm:flex-row gap-3 mb-4\">\n              <div className=\"flex-1\">\n                <div className=\"relative\">\n                  <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                  <Input\n                    placeholder=\"Search by reference number...\"\n                    value={searchReference}\n                    onChange={(e) => setSearchReference(e.target.value)}\n                    className=\"pl-9\"\n                    data-testid=\"input-search-reference\"\n                  />\n                </div>\n              </div>\n              <Select value={statusFilter} onValueChange={setStatusFilter}>\n                <SelectTrigger className=\"w-full sm:w-48\" data-testid=\"select-status-filter\">\n                  <SelectValue placeholder=\"Filter by status\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">All Statuses</SelectItem>\n                  <SelectItem value=\"pending\">Pending</SelectItem>\n                  <SelectItem value=\"in_progress\">In Progress</SelectItem>\n                  <SelectItem value=\"resolved\">Resolved</SelectItem>\n                  <SelectItem value=\"refunded\">Refunded</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n\n            {isLoading ? (\n              <p className=\"text-center py-8 text-muted-foreground\">Loading...</p>\n            ) : filteredComplaints.length === 0 ? (\n              <div className=\"text-center py-12\">\n                <CheckCircle2 className=\"h-12 w-12 mx-auto text-muted-foreground mb-4\" />\n                <p className=\"text-muted-foreground\">\n                  {complaints.length === 0 ? \"No complaints yet\" : \"No complaints match your filters\"}\n                </p>\n              </div>\n            ) : (\n              <div className=\"overflow-x-auto\">\n                <Table>\n                  <TableHeader>\n                    <TableRow>\n                      <TableHead>Reference</TableHead>\n                      <TableHead>Job ID</TableHead>\n                      <TableHead>Company ID</TableHead>\n                      <TableHead>Type</TableHead>\n                      <TableHead>Status</TableHead>\n                      <TableHead>Customer</TableHead>\n                      <TableHead>Date</TableHead>\n                      <TableHead>Actions</TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {filteredComplaints.map((complaint) => (\n                      <TableRow key={complaint.id} data-testid={`complaint-row-${complaint.id}`}>\n                        <TableCell className=\"font-mono text-sm\">\n                          {complaint.referenceNumber}\n                        </TableCell>\n                        <TableCell>#{complaint.jobId}</TableCell>\n                        <TableCell>#{complaint.companyId}</TableCell>\n                        <TableCell>{getTypeBadge(complaint.type)}</TableCell>\n                        <TableCell>{getStatusBadge(complaint.status)}</TableCell>\n                        <TableCell className=\"text-sm\">\n                          {complaint.customerPhone}\n                        </TableCell>\n                        <TableCell className=\"text-sm\">\n                          {new Date(complaint.createdAt).toLocaleDateString('en-AE', {\n                            timeZone: 'Asia/Dubai',\n                            year: 'numeric',\n                            month: 'short',\n                            day: 'numeric'\n                          })}\n                        </TableCell>\n                        <TableCell>\n                          <Button\n                            size=\"sm\"\n                            variant=\"outline\"\n                            onClick={() => setSelectedComplaint(complaint)}\n                            data-testid={`button-view-${complaint.id}`}\n                          >\n                            View\n                          </Button>\n                        </TableCell>\n                      </TableRow>\n                    ))}\n                  </TableBody>\n                </Table>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n\n        {/* Complaint Detail Dialog */}\n        {selectedComplaint && (\n          <Dialog open={!!selectedComplaint} onOpenChange={() => setSelectedComplaint(null)}>\n            <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n              <DialogHeader>\n                <DialogTitle>Complaint Details</DialogTitle>\n                <DialogDescription>\n                  Reference: {selectedComplaint.referenceNumber}\n                </DialogDescription>\n              </DialogHeader>\n\n              <div className=\"space-y-4\">\n                {/* Complaint Info */}\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div>\n                    <p className=\"text-sm font-medium text-muted-foreground\">Job ID</p>\n                    <p className=\"text-lg\">#{selectedComplaint.jobId}</p>\n                  </div>\n                  <div>\n                    <p className=\"text-sm font-medium text-muted-foreground\">Company ID</p>\n                    <p className=\"text-lg\">#{selectedComplaint.companyId}</p>\n                  </div>\n                  <div>\n                    <p className=\"text-sm font-medium text-muted-foreground\">Type</p>\n                    <div className=\"mt-1\">{getTypeBadge(selectedComplaint.type)}</div>\n                  </div>\n                  <div>\n                    <p className=\"text-sm font-medium text-muted-foreground\">Status</p>\n                    <div className=\"mt-1\">{getStatusBadge(selectedComplaint.status)}</div>\n                  </div>\n                  <div>\n                    <p className=\"text-sm font-medium text-muted-foreground\">Customer</p>\n                    <p>{selectedComplaint.customerPhone}</p>\n                    {selectedComplaint.customerEmail && (\n                      <p className=\"text-sm text-muted-foreground\">{selectedComplaint.customerEmail}</p>\n                    )}\n                  </div>\n                  <div>\n                    <p className=\"text-sm font-medium text-muted-foreground\">Date</p>\n                    <p>{new Date(selectedComplaint.createdAt).toLocaleString('en-AE', {\n                      timeZone: 'Asia/Dubai',\n                    })}</p>\n                  </div>\n                </div>\n\n                {/* Description */}\n                <div>\n                  <p className=\"text-sm font-medium text-muted-foreground mb-1\">Description</p>\n                  <p className=\"text-sm bg-muted p-3 rounded-lg\">{selectedComplaint.description}</p>\n                </div>\n\n                {/* Resolution if available */}\n                {selectedComplaint.resolution && (\n                  <div>\n                    <p className=\"text-sm font-medium text-muted-foreground mb-1\">Resolution</p>\n                    <p className=\"text-sm bg-green-50 dark:bg-green-950 p-3 rounded-lg\">\n                      {selectedComplaint.resolution}\n                    </p>\n                  </div>\n                )}\n\n                {/* Refund Action */}\n                {selectedComplaint.type === 'refund_request' && selectedComplaint.status !== 'refunded' && (\n                  <div className=\"pt-4 border-t\">\n                    <Button\n                      variant=\"destructive\"\n                      onClick={() => refundMutation.mutate(selectedComplaint.id)}\n                      disabled={refundMutation.isPending}\n                      data-testid=\"button-process-refund\"\n                      className=\"w-full\"\n                    >\n                      <DollarSign className=\"h-4 w-4 mr-2\" />\n                      {refundMutation.isPending ? \"Processing Refund...\" : \"Process Refund\"}\n                    </Button>\n                    <p className=\"text-xs text-muted-foreground text-center mt-2\">\n                      This will create a full Stripe refund and notify the customer\n                    </p>\n                  </div>\n                )}\n              </div>\n            </DialogContent>\n          </Dialog>\n        )}\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":12452,"size_tokens":null},"client/src/pages/company-complaints.tsx":{"content":"import { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Complaint } from \"@shared/schema\";\nimport { useState, useMemo } from \"react\";\nimport { AlertCircle, CheckCircle2, DollarSign, Search } from \"lucide-react\";\n\nexport default function CompanyComplaints() {\n  const { toast } = useToast();\n  const [selectedComplaint, setSelectedComplaint] = useState<Complaint | null>(null);\n  const [status, setStatus] = useState(\"\");\n  const [resolution, setResolution] = useState(\"\");\n  const [statusFilter, setStatusFilter] = useState<string>(\"all\");\n  const [searchReference, setSearchReference] = useState<string>(\"\");\n\n  const { data: complaints = [], isLoading } = useQuery<Complaint[]>({\n    queryKey: [\"/api/company/complaints\"],\n  });\n\n  // Filter complaints based on status and search\n  const filteredComplaints = useMemo(() => {\n    return complaints.filter((complaint) => {\n      const matchesStatus = statusFilter === \"all\" || complaint.status === statusFilter;\n      const matchesSearch = searchReference === \"\" || \n        complaint.referenceNumber.toLowerCase().includes(searchReference.toLowerCase());\n      return matchesStatus && matchesSearch;\n    });\n  }, [complaints, statusFilter, searchReference]);\n\n  const updateStatusMutation = useMutation({\n    mutationFn: async () => {\n      if (!selectedComplaint) return;\n      \n      const response = await fetch(`/api/company/complaints/${selectedComplaint.id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ status, resolution }),\n      });\n      \n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.message || \"Failed to update complaint\");\n      }\n      \n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/company/complaints\"] });\n      setSelectedComplaint(null);\n      setStatus(\"\");\n      setResolution(\"\");\n      toast({\n        title: \"Complaint Updated\",\n        description: \"The complaint status has been updated.\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: error.message || \"Failed to update complaint\",\n      });\n    },\n  });\n\n  const refundMutation = useMutation({\n    mutationFn: async (complaintId: number) => {\n      const response = await fetch(`/api/complaints/${complaintId}/refund`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n      });\n      \n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.message || \"Failed to process refund\");\n      }\n      \n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/company/complaints\"] });\n      setSelectedComplaint(null);\n      toast({\n        title: \"Refund Processed\",\n        description: \"The refund has been processed successfully.\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Refund Failed\",\n        description: error.message || \"Failed to process refund\",\n      });\n    },\n  });\n\n  const getStatusBadge = (status: string) => {\n    const variants: Record<string, any> = {\n      pending: \"secondary\",\n      in_progress: \"default\",\n      resolved: \"outline\",\n      refunded: \"outline\",\n    };\n    const labels: Record<string, string> = {\n      pending: \"Pending\",\n      in_progress: \"In Progress\",\n      resolved: \"Resolved\",\n      refunded: \"Refunded\",\n    };\n    return <Badge variant={variants[status] || \"secondary\"}>{labels[status] || status}</Badge>;\n  };\n\n  const getTypeBadge = (type: string) => {\n    return type === 'refund_request' ? (\n      <Badge variant=\"destructive\">Refund Request</Badge>\n    ) : (\n      <Badge variant=\"secondary\">General</Badge>\n    );\n  };\n\n  const openComplaint = (complaint: Complaint) => {\n    setSelectedComplaint(complaint);\n    setStatus(complaint.status);\n    setResolution(complaint.resolution || \"\");\n  };\n\n  return (\n    <div className=\"min-h-screen bg-background p-4 pb-20\">\n      <div className=\"max-w-7xl mx-auto\">\n        <div className=\"mb-6 pt-4\">\n          <h1 className=\"text-2xl font-bold text-foreground mb-1\">\n            Customer Complaints\n          </h1>\n          <p className=\"text-muted-foreground\">\n            Manage and resolve customer issues\n          </p>\n        </div>\n\n        <Card>\n          <CardHeader>\n            <CardTitle>All Complaints</CardTitle>\n            <CardDescription>\n              {filteredComplaints.length} of {complaints.length} complaints\n            </CardDescription>\n          </CardHeader>\n          <CardContent>\n            {/* Filters */}\n            <div className=\"flex flex-col sm:flex-row gap-3 mb-4\">\n              <div className=\"flex-1\">\n                <div className=\"relative\">\n                  <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                  <Input\n                    placeholder=\"Search by reference number...\"\n                    value={searchReference}\n                    onChange={(e) => setSearchReference(e.target.value)}\n                    className=\"pl-9\"\n                    data-testid=\"input-search-reference\"\n                  />\n                </div>\n              </div>\n              <Select value={statusFilter} onValueChange={setStatusFilter}>\n                <SelectTrigger className=\"w-full sm:w-48\" data-testid=\"select-status-filter\">\n                  <SelectValue placeholder=\"Filter by status\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">All Statuses</SelectItem>\n                  <SelectItem value=\"pending\">Pending</SelectItem>\n                  <SelectItem value=\"in_progress\">In Progress</SelectItem>\n                  <SelectItem value=\"resolved\">Resolved</SelectItem>\n                  <SelectItem value=\"refunded\">Refunded</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n\n            {isLoading ? (\n              <p className=\"text-center py-8 text-muted-foreground\">Loading...</p>\n            ) : filteredComplaints.length === 0 ? (\n              <div className=\"text-center py-12\">\n                <CheckCircle2 className=\"h-12 w-12 mx-auto text-muted-foreground mb-4\" />\n                <p className=\"text-muted-foreground\">\n                  {complaints.length === 0 ? \"No complaints yet\" : \"No complaints match your filters\"}\n                </p>\n              </div>\n            ) : (\n              <div className=\"overflow-x-auto\">\n                <Table>\n                  <TableHeader>\n                    <TableRow>\n                      <TableHead>Reference</TableHead>\n                      <TableHead>Job ID</TableHead>\n                      <TableHead>Type</TableHead>\n                      <TableHead>Status</TableHead>\n                      <TableHead>Customer</TableHead>\n                      <TableHead>Date</TableHead>\n                      <TableHead>Actions</TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {filteredComplaints.map((complaint) => (\n                      <TableRow key={complaint.id} data-testid={`complaint-row-${complaint.id}`}>\n                        <TableCell className=\"font-mono text-sm\">\n                          {complaint.referenceNumber}\n                        </TableCell>\n                        <TableCell>#{complaint.jobId}</TableCell>\n                        <TableCell>{getTypeBadge(complaint.type)}</TableCell>\n                        <TableCell>{getStatusBadge(complaint.status)}</TableCell>\n                        <TableCell className=\"text-sm\">\n                          {complaint.customerPhone}\n                        </TableCell>\n                        <TableCell className=\"text-sm\">\n                          {new Date(complaint.createdAt).toLocaleDateString('en-AE', {\n                            timeZone: 'Asia/Dubai',\n                            year: 'numeric',\n                            month: 'short',\n                            day: 'numeric'\n                          })}\n                        </TableCell>\n                        <TableCell>\n                          <Button\n                            size=\"sm\"\n                            variant=\"outline\"\n                            onClick={() => openComplaint(complaint)}\n                            data-testid={`button-view-${complaint.id}`}\n                          >\n                            View\n                          </Button>\n                        </TableCell>\n                      </TableRow>\n                    ))}\n                  </TableBody>\n                </Table>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n\n        {/* Complaint Detail Dialog */}\n        {selectedComplaint && (\n          <Dialog open={!!selectedComplaint} onOpenChange={() => setSelectedComplaint(null)}>\n            <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n              <DialogHeader>\n                <DialogTitle>Complaint Details</DialogTitle>\n                <DialogDescription>\n                  Reference: {selectedComplaint.referenceNumber}\n                </DialogDescription>\n              </DialogHeader>\n\n              <div className=\"space-y-4\">\n                {/* Complaint Info */}\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div>\n                    <p className=\"text-sm font-medium text-muted-foreground\">Job ID</p>\n                    <p className=\"text-lg\">#{selectedComplaint.jobId}</p>\n                  </div>\n                  <div>\n                    <p className=\"text-sm font-medium text-muted-foreground\">Type</p>\n                    <div className=\"mt-1\">{getTypeBadge(selectedComplaint.type)}</div>\n                  </div>\n                  <div>\n                    <p className=\"text-sm font-medium text-muted-foreground\">Customer</p>\n                    <p>{selectedComplaint.customerPhone}</p>\n                    {selectedComplaint.customerEmail && (\n                      <p className=\"text-sm text-muted-foreground\">{selectedComplaint.customerEmail}</p>\n                    )}\n                  </div>\n                  <div>\n                    <p className=\"text-sm font-medium text-muted-foreground\">Date</p>\n                    <p>{new Date(selectedComplaint.createdAt).toLocaleString('en-AE', {\n                      timeZone: 'Asia/Dubai',\n                    })}</p>\n                  </div>\n                </div>\n\n                {/* Description */}\n                <div>\n                  <p className=\"text-sm font-medium text-muted-foreground mb-1\">Description</p>\n                  <p className=\"text-sm bg-muted p-3 rounded-lg\">{selectedComplaint.description}</p>\n                </div>\n\n                {/* Update Status */}\n                {selectedComplaint.status !== 'refunded' && (\n                  <>\n                    <div className=\"space-y-2\">\n                      <Label>Status</Label>\n                      <Select value={status} onValueChange={setStatus}>\n                        <SelectTrigger data-testid=\"select-status\">\n                          <SelectValue />\n                        </SelectTrigger>\n                        <SelectContent>\n                          <SelectItem value=\"pending\">Pending</SelectItem>\n                          <SelectItem value=\"in_progress\">In Progress</SelectItem>\n                          <SelectItem value=\"resolved\">Resolved</SelectItem>\n                        </SelectContent>\n                      </Select>\n                    </div>\n\n                    {status === 'resolved' && (\n                      <div className=\"space-y-2\">\n                        <Label>Resolution *</Label>\n                        <Textarea\n                          placeholder=\"Explain how the issue was resolved...\"\n                          value={resolution}\n                          onChange={(e) => setResolution(e.target.value)}\n                          rows={4}\n                          data-testid=\"textarea-resolution\"\n                        />\n                        <p className=\"text-xs text-muted-foreground\">\n                          This will be sent to the customer\n                        </p>\n                      </div>\n                    )}\n\n                    <div className=\"flex gap-2\">\n                      <Button\n                        onClick={() => updateStatusMutation.mutate()}\n                        disabled={updateStatusMutation.isPending || (status === 'resolved' && !resolution.trim())}\n                        data-testid=\"button-update-status\"\n                      >\n                        {updateStatusMutation.isPending ? \"Updating...\" : \"Update Status\"}\n                      </Button>\n\n                      {selectedComplaint.type === 'refund_request' && selectedComplaint.status !== 'refunded' && (\n                        <Button\n                          variant=\"destructive\"\n                          onClick={() => refundMutation.mutate(selectedComplaint.id)}\n                          disabled={refundMutation.isPending}\n                          data-testid=\"button-process-refund\"\n                        >\n                          <DollarSign className=\"h-4 w-4 mr-2\" />\n                          {refundMutation.isPending ? \"Processing...\" : \"Process Refund\"}\n                        </Button>\n                      )}\n                    </div>\n                  </>\n                )}\n\n                {/* Show resolution if resolved */}\n                {selectedComplaint.resolution && (\n                  <div>\n                    <p className=\"text-sm font-medium text-muted-foreground mb-1\">Resolution</p>\n                    <p className=\"text-sm bg-green-50 dark:bg-green-950 p-3 rounded-lg\">\n                      {selectedComplaint.resolution}\n                    </p>\n                  </div>\n                )}\n              </div>\n            </DialogContent>\n          </Dialog>\n        )}\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":15029,"size_tokens":null},"client/src/pages/customer-complaint.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useLocation, useRoute } from \"wouter\";\nimport { useMutation, useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Input } from \"@/components/ui/input\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { ArrowLeft, AlertCircle, Mail, CheckCircle, Loader2 } from \"lucide-react\";\nimport { Job } from \"@shared/schema\";\n\nexport default function CustomerComplaint() {\n  const [, params] = useRoute(\"/customer/complaint/:jobId\");\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  \n  const jobId = params?.jobId ? parseInt(params.jobId) : null;\n  \n  // Form states\n  const [email, setEmail] = useState(\"\");\n  const [otpCode, setOtpCode] = useState(\"\");\n  const [complaintType, setComplaintType] = useState<string>(\"\");\n  const [description, setDescription] = useState(\"\");\n  \n  // OTP verification states\n  const [isOtpSent, setIsOtpSent] = useState(false);\n  const [isEmailVerified, setIsEmailVerified] = useState(false);\n  const [otpSendCooldown, setOtpSendCooldown] = useState(0);\n\n  // Fetch job details using jobId from URL\n  const { data: job, isLoading } = useQuery<Job>({\n    queryKey: [`/api/jobs/${jobId}`],\n    enabled: !!jobId,\n  });\n\n  // Cooldown timer for OTP resend\n  useEffect(() => {\n    if (otpSendCooldown > 0) {\n      const timer = setTimeout(() => setOtpSendCooldown(otpSendCooldown - 1), 1000);\n      return () => clearTimeout(timer);\n    }\n  }, [otpSendCooldown]);\n\n  // Send OTP mutation\n  const sendOtpMutation = useMutation({\n    mutationFn: async () => {\n      if (!email.trim()) {\n        throw new Error(\"Please enter your email address\");\n      }\n      \n      return apiRequest(\"POST\", \"/api/otp/send\", {\n        email: email.trim(),\n      });\n    },\n    onSuccess: () => {\n      setIsOtpSent(true);\n      setOtpSendCooldown(60); // 60 second cooldown\n      toast({\n        title: \"Verification Code Sent\",\n        description: \"Check your email for the 6-digit code\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Failed to Send Code\",\n        description: error.message || \"Please try again\",\n      });\n    },\n  });\n\n  // Verify OTP mutation\n  const verifyOtpMutation = useMutation({\n    mutationFn: async () => {\n      if (!otpCode.trim()) {\n        throw new Error(\"Please enter the verification code\");\n      }\n      \n      return apiRequest(\"POST\", \"/api/otp/verify\", {\n        email: email.trim(),\n        code: otpCode.trim(),\n      });\n    },\n    onSuccess: () => {\n      setIsEmailVerified(true);\n      toast({\n        title: \"Email Verified\",\n        description: \"You can now submit your complaint\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Invalid Code\",\n        description: error.message || \"Please check the code and try again\",\n      });\n    },\n  });\n\n  // Submit complaint mutation\n  const submitComplaint = useMutation({\n    mutationFn: async () => {\n      if (!isEmailVerified) {\n        throw new Error(\"Please verify your email first\");\n      }\n      \n      if (!complaintType || !description.trim()) {\n        throw new Error(\"Please fill in all fields\");\n      }\n\n      return apiRequest(\"POST\", \"/api/complaints\", {\n        jobId,\n        type: complaintType,\n        description: description.trim(),\n        email: email.trim(),\n        otpCode: otpCode,\n      });\n    },\n    onSuccess: (data: any) => {\n      toast({\n        title: \"Complaint Submitted\",\n        description: `Your complaint reference is ${data.referenceNumber}. We'll review it shortly.`,\n      });\n      setLocation(\"/customer/track\");\n    },\n    onError: (error: any) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: error.message || \"Failed to submit complaint\",\n      });\n    },\n  });\n\n  if (!jobId) {\n    return (\n      <div className=\"min-h-screen bg-background p-4 flex items-center justify-center\">\n        <Card className=\"max-w-md\">\n          <CardHeader>\n            <CardTitle>Invalid Request</CardTitle>\n            <CardDescription>No job specified for complaint</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <Button onClick={() => setLocation(\"/customer/track\")} data-testid=\"button-back\">\n              Go to Tracking\n            </Button>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen bg-background flex items-center justify-center\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\n      </div>\n    );\n  }\n\n  if (!job) {\n    return (\n      <div className=\"min-h-screen bg-background p-4 flex items-center justify-center\">\n        <Card className=\"max-w-md\">\n          <CardHeader>\n            <CardTitle>Job Not Found</CardTitle>\n            <CardDescription>Unable to load job details</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <Button onClick={() => setLocation(\"/customer/track\")} data-testid=\"button-back\">\n              Go to Tracking\n            </Button>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-background p-4 pb-20\">\n      <div className=\"max-w-2xl mx-auto\">\n        {/* Header */}\n        <div className=\"flex items-center gap-3 mb-6 pt-4\">\n          <Button\n            variant=\"ghost\"\n            size=\"icon\"\n            onClick={() => setLocation(\"/customer/track\")}\n            data-testid=\"button-back\"\n          >\n            <ArrowLeft className=\"h-5 w-5\" />\n          </Button>\n          <div>\n            <h1 className=\"text-2xl font-bold text-foreground\">\n              Report Issue\n            </h1>\n            <p className=\"text-muted-foreground text-sm\">\n              Job #{job.id} • {job.carPlateEmirate} {job.carPlateCode} {job.carPlateNumber}\n            </p>\n          </div>\n        </div>\n\n        {/* Email Verification Section */}\n        {!isEmailVerified && (\n          <Card className=\"mb-6\">\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Mail className=\"h-5 w-5\" />\n                Email Verification\n              </CardTitle>\n              <CardDescription>\n                Verify your email to submit a complaint\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              {/* Email Input */}\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"email\">Email Address</Label>\n                <div className=\"flex gap-2\">\n                  <Input\n                    id=\"email\"\n                    type=\"email\"\n                    placeholder=\"your.email@example.com\"\n                    value={email}\n                    onChange={(e) => setEmail(e.target.value)}\n                    disabled={isOtpSent}\n                    data-testid=\"input-email\"\n                  />\n                  {!isOtpSent && (\n                    <Button\n                      onClick={() => sendOtpMutation.mutate()}\n                      disabled={sendOtpMutation.isPending || !email.trim()}\n                      data-testid=\"button-send-otp\"\n                    >\n                      {sendOtpMutation.isPending ? \"Sending...\" : \"Send Code\"}\n                    </Button>\n                  )}\n                </div>\n              </div>\n\n              {/* OTP Input */}\n              {isOtpSent && (\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"otpCode\">Verification Code</Label>\n                  <div className=\"flex gap-2\">\n                    <Input\n                      id=\"otpCode\"\n                      type=\"text\"\n                      placeholder=\"Enter 6-digit code\"\n                      value={otpCode}\n                      onChange={(e) => setOtpCode(e.target.value.replace(/\\D/g, '').slice(0, 6))}\n                      maxLength={6}\n                      data-testid=\"input-otp\"\n                    />\n                    <Button\n                      onClick={() => verifyOtpMutation.mutate()}\n                      disabled={verifyOtpMutation.isPending || otpCode.length !== 6}\n                      data-testid=\"button-verify-otp\"\n                    >\n                      {verifyOtpMutation.isPending ? \"Verifying...\" : \"Verify\"}\n                    </Button>\n                  </div>\n                  <div className=\"flex items-center justify-between text-sm\">\n                    <p className=\"text-muted-foreground\">\n                      Check your email for the code\n                    </p>\n                    {otpSendCooldown > 0 ? (\n                      <p className=\"text-muted-foreground\">\n                        Resend in {otpSendCooldown}s\n                      </p>\n                    ) : (\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={() => {\n                          setOtpCode(\"\");\n                          sendOtpMutation.mutate();\n                        }}\n                        data-testid=\"button-resend-otp\"\n                      >\n                        Resend Code\n                      </Button>\n                    )}\n                  </div>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        )}\n\n        {/* Verification Success Banner */}\n        {isEmailVerified && (\n          <Card className=\"mb-6 border-green-500 bg-green-50 dark:bg-green-950\">\n            <CardContent className=\"flex items-center gap-3 pt-6\">\n              <CheckCircle className=\"h-5 w-5 text-green-600 dark:text-green-400\" />\n              <div>\n                <p className=\"font-medium text-green-900 dark:text-green-100\">\n                  Email Verified\n                </p>\n                <p className=\"text-sm text-green-700 dark:text-green-300\">\n                  {email}\n                </p>\n              </div>\n            </CardContent>\n          </Card>\n        )}\n\n        {/* Complaint Form - Only shown after email verification */}\n        {isEmailVerified && (\n          <Card>\n            <CardHeader>\n              <CardTitle>Complaint Details</CardTitle>\n              <CardDescription>\n                Tell us about the issue you're experiencing\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-6\">\n              {/* Complaint Type */}\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"complaintType\">Issue Type</Label>\n                <Select value={complaintType} onValueChange={setComplaintType}>\n                  <SelectTrigger id=\"complaintType\" data-testid=\"select-type\">\n                    <SelectValue placeholder=\"Select issue type\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"refund_request\">Refund Request</SelectItem>\n                    <SelectItem value=\"general\">General Complaint</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n\n              {/* Description */}\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"description\">Description</Label>\n                <Textarea\n                  id=\"description\"\n                  placeholder=\"Please describe the issue in detail...\"\n                  value={description}\n                  onChange={(e) => setDescription(e.target.value)}\n                  rows={6}\n                  data-testid=\"input-description\"\n                />\n                <p className=\"text-xs text-muted-foreground\">\n                  Provide as much detail as possible to help us resolve your issue\n                </p>\n              </div>\n\n              {/* Submit Button */}\n              <Button\n                className=\"w-full\"\n                onClick={() => submitComplaint.mutate()}\n                disabled={submitComplaint.isPending || !complaintType || !description.trim()}\n                data-testid=\"button-submit-complaint\"\n              >\n                {submitComplaint.isPending ? \"Submitting...\" : \"Submit Complaint\"}\n              </Button>\n            </CardContent>\n          </Card>\n        )}\n\n        {/* Help Text */}\n        {!isEmailVerified && (\n          <Card className=\"mt-6 bg-muted/50\">\n            <CardContent className=\"pt-6\">\n              <div className=\"flex items-start gap-3\">\n                <AlertCircle className=\"h-5 w-5 text-muted-foreground mt-0.5\" />\n                <div className=\"space-y-2 text-sm text-muted-foreground\">\n                  <p className=\"font-medium\">Why verify email?</p>\n                  <ul className=\"list-disc list-inside space-y-1\">\n                    <li>Receive updates about your complaint</li>\n                    <li>Get notified when it's resolved</li>\n                    <li>Track complaint status via email</li>\n                  </ul>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        )}\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":13543,"size_tokens":null},"client/src/components/splash-screen.tsx":{"content":"import { useEffect, useState } from \"react\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport logoUrl from \"@assets/IMG_2508_1762619079711.png\";\n\nexport function SplashScreen({ onComplete }: { onComplete: () => void }) {\n  const [show, setShow] = useState(true);\n\n  useEffect(() => {\n    const timer = setTimeout(() => {\n      setShow(false);\n      setTimeout(onComplete, 500);\n    }, 2500);\n\n    return () => clearTimeout(timer);\n  }, [onComplete]);\n\n  return (\n    <AnimatePresence>\n      {show && (\n        <motion.div\n          initial={{ opacity: 1 }}\n          exit={{ opacity: 0 }}\n          transition={{ duration: 0.5 }}\n          className=\"fixed inset-0 z-[9999] flex items-center justify-center bg-gradient-to-br from-primary via-primary/95 to-blue-600\"\n          data-testid=\"splash-screen\"\n        >\n          <div className=\"flex flex-col items-center gap-6\">\n            <motion.div\n              initial={{ scale: 0, rotate: -180 }}\n              animate={{ scale: 1, rotate: 0 }}\n              transition={{\n                type: \"spring\",\n                stiffness: 200,\n                damping: 20,\n                duration: 0.8,\n              }}\n            >\n              <motion.img\n                src={logoUrl}\n                alt=\"Washapp.ae\"\n                className=\"h-32 w-auto\"\n                animate={{\n                  scale: [1, 1.1, 1],\n                  rotate: [0, 5, -5, 0],\n                }}\n                transition={{\n                  duration: 2,\n                  repeat: 1,\n                  repeatDelay: 0.2,\n                }}\n                data-testid=\"splash-logo\"\n              />\n            </motion.div>\n\n            <motion.div\n              initial={{ opacity: 0, y: 20 }}\n              animate={{ opacity: 1, y: 0 }}\n              transition={{ delay: 0.5, duration: 0.5 }}\n              className=\"text-center\"\n            >\n              <h1 className=\"text-3xl font-bold text-white mb-2\">Washapp.ae</h1>\n              <p className=\"text-white/90 text-sm\">Professional Car Wash Service</p>\n            </motion.div>\n\n            <motion.div\n              initial={{ opacity: 0 }}\n              animate={{ opacity: 1 }}\n              transition={{ delay: 1, duration: 0.5 }}\n              className=\"flex gap-1.5\"\n            >\n              {[0, 1, 2].map((i) => (\n                <motion.div\n                  key={i}\n                  className=\"w-2 h-2 rounded-full bg-white\"\n                  animate={{\n                    scale: [1, 1.3, 1],\n                    opacity: [1, 0.5, 1],\n                  }}\n                  transition={{\n                    duration: 1,\n                    repeat: Infinity,\n                    delay: i * 0.2,\n                  }}\n                />\n              ))}\n            </motion.div>\n          </div>\n        </motion.div>\n      )}\n    </AnimatePresence>\n  );\n}\n","path":null,"size_bytes":2893,"size_tokens":null},"client/src/pages/privacy.tsx":{"content":"import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { Info } from \"lucide-react\";\n\nexport default function Privacy() {\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-blue-50 via-white to-indigo-50 dark:from-gray-900 dark:via-gray-800 dark:to-gray-900\">\n      <div className=\"max-w-4xl mx-auto px-4 py-8 sm:py-12\">\n        {/* Header */}\n        <div className=\"text-center mb-8\">\n          <h1 className=\"text-3xl sm:text-4xl font-bold mb-2\">Privacy Policy</h1>\n          <p className=\"text-muted-foreground\">Last Updated: November 23, 2025</p>\n        </div>\n\n        {/* Important Notice */}\n        <Alert className=\"mb-8 border-blue-500/50 bg-blue-50 dark:bg-blue-950/20\">\n          <Info className=\"h-5 w-5 text-blue-600 dark:text-blue-500\" />\n          <AlertDescription className=\"text-blue-900 dark:text-blue-200\">\n            <strong>Important:</strong> Car wash booking data is publicly searchable by phone number and car plate number. This data is not considered confidential and is necessary for our service to function. By using Washapp.ae, you consent to this data being accessible to authorized users.\n          </AlertDescription>\n        </Alert>\n\n        <div className=\"space-y-6\">\n          {/* 1. Introduction */}\n          <Card>\n            <CardHeader>\n              <CardTitle>1. Introduction</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4 text-sm text-muted-foreground\">\n              <p>\n                Washapp.ae (\"we\", \"us\", or \"our\") is committed to protecting your privacy. This Privacy Policy explains how we collect, use, disclose, and safeguard your information when you use our car wash booking platform.\n              </p>\n              <p>\n                Please read this Privacy Policy carefully. By accessing or using the Platform, you acknowledge that you have read, understood, and agree to be bound by this Privacy Policy.\n              </p>\n            </CardContent>\n          </Card>\n\n          {/* 2. Information We Collect */}\n          <Card>\n            <CardHeader>\n              <CardTitle>2. Information We Collect</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4 text-sm text-muted-foreground\">\n              <p>\n                <strong>2.1 Customer Information:</strong>\n              </p>\n              <ul className=\"list-disc pl-6 space-y-2\">\n                <li><strong>Phone Number:</strong> Used for booking identification and communication</li>\n                <li><strong>Car Details:</strong> Plate number, car type, make, and color</li>\n                <li><strong>Location Data:</strong> Geographic coordinates of service delivery location</li>\n                <li><strong>Payment Information:</strong> Processed securely through Stripe (we do not store card details)</li>\n                <li><strong>Device Information:</strong> Browser type, IP address, and device identifiers</li>\n                <li><strong>Push Notification Tokens:</strong> If you enable notifications</li>\n              </ul>\n              <p>\n                <strong>2.2 Company Information:</strong>\n              </p>\n              <ul className=\"list-disc pl-6 space-y-2\">\n                <li>Company name, email, phone, and address</li>\n                <li>Trade license documents</li>\n                <li>Service area (geofence) boundaries</li>\n                <li>Pricing and fee structure</li>\n                <li>Financial transaction history</li>\n              </ul>\n              <p>\n                <strong>2.3 Cleaner Information:</strong>\n              </p>\n              <ul className=\"list-disc pl-6 space-y-2\">\n                <li>Name, email, and phone number</li>\n                <li>Company association and service area assignments</li>\n                <li>Location data when on duty</li>\n                <li>Job completion photos</li>\n              </ul>\n            </CardContent>\n          </Card>\n\n          {/* 3. Public Data Disclosure */}\n          <Card>\n            <CardHeader>\n              <CardTitle>3. Public Data and Searchability</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4 text-sm text-muted-foreground\">\n              <p>\n                <strong>3.1 Non-Confidential Data:</strong> The following information is NOT considered confidential and may be accessed by authorized users of the Platform:\n              </p>\n              <ul className=\"list-disc pl-6 space-y-2\">\n                <li>Phone numbers used for bookings</li>\n                <li>Car plate numbers</li>\n                <li>Car type, make, and color</li>\n                <li>Job status and history</li>\n                <li>Service locations (approximate area, not exact coordinates)</li>\n              </ul>\n              <p>\n                <strong>3.2 Search Functionality:</strong> Any user can search for car wash bookings using:\n              </p>\n              <ul className=\"list-disc pl-6 space-y-2\">\n                <li>Phone number - Returns all bookings associated with that phone number</li>\n                <li>Car plate number - Returns all bookings for that vehicle</li>\n              </ul>\n              <p>\n                <strong>3.3 Purpose of Public Access:</strong> This searchability is essential for:\n              </p>\n              <ul className=\"list-disc pl-6 space-y-2\">\n                <li>Allowing customers to track their bookings without creating accounts</li>\n                <li>Enabling auto-fill of car details for repeat customers</li>\n                <li>Facilitating service delivery by companies and cleaners</li>\n                <li>Providing transparency in service history</li>\n              </ul>\n              <p>\n                <strong>3.4 Your Consent:</strong> By using Washapp.ae, you explicitly consent to your car wash booking data being searchable and accessible as described above. If you do not agree with this policy, please do not use the Platform.\n              </p>\n            </CardContent>\n          </Card>\n\n          {/* 4. How We Use Your Information */}\n          <Card>\n            <CardHeader>\n              <CardTitle>4. How We Use Your Information</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4 text-sm text-muted-foreground\">\n              <p>We use the collected information to:</p>\n              <ul className=\"list-disc pl-6 space-y-2\">\n                <li>Facilitate car wash bookings and service delivery</li>\n                <li>Process payments and manage financial transactions</li>\n                <li>Match customers with car wash companies based on location</li>\n                <li>Send notifications about job status updates</li>\n                <li>Enable search and tracking of bookings</li>\n                <li>Auto-fill booking forms for repeat customers</li>\n                <li>Verify company credentials and approve registrations</li>\n                <li>Generate analytics and usage reports</li>\n                <li>Improve platform functionality and user experience</li>\n                <li>Comply with legal obligations</li>\n              </ul>\n            </CardContent>\n          </Card>\n\n          {/* 5. Data Sharing */}\n          <Card>\n            <CardHeader>\n              <CardTitle>5. Data Sharing and Disclosure</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4 text-sm text-muted-foreground\">\n              <p>\n                <strong>5.1 Service Providers:</strong> We share data with third-party service providers:\n              </p>\n              <ul className=\"list-disc pl-6 space-y-2\">\n                <li><strong>Stripe:</strong> For payment processing</li>\n                <li><strong>Resend:</strong> For email notifications</li>\n                <li><strong>Web Push Services:</strong> For push notifications</li>\n              </ul>\n              <p>\n                <strong>5.2 Car Wash Companies:</strong> When you book a service, we share your phone number, car details, and location with the selected company and assigned cleaner to enable service delivery.\n              </p>\n              <p>\n                <strong>5.3 Legal Requirements:</strong> We may disclose your information if required by law or in response to valid requests by public authorities.\n              </p>\n              <p>\n                <strong>5.4 Business Transfers:</strong> If Washapp.ae is involved in a merger, acquisition, or sale of assets, your information may be transferred as part of that transaction.\n              </p>\n            </CardContent>\n          </Card>\n\n          {/* 6. Data Retention */}\n          <Card>\n            <CardHeader>\n              <CardTitle>6. Data Retention</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4 text-sm text-muted-foreground\">\n              <p>\n                We retain your personal information for as long as necessary to provide our services and comply with legal obligations. Booking history and transaction records may be retained indefinitely for:\n              </p>\n              <ul className=\"list-disc pl-6 space-y-2\">\n                <li>Financial auditing and tax compliance</li>\n                <li>Dispute resolution</li>\n                <li>Service history tracking</li>\n                <li>Platform analytics and improvements</li>\n              </ul>\n            </CardContent>\n          </Card>\n\n          {/* 7. Data Security */}\n          <Card>\n            <CardHeader>\n              <CardTitle>7. Data Security</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4 text-sm text-muted-foreground\">\n              <p>\n                We implement reasonable security measures to protect your information from unauthorized access, alteration, disclosure, or destruction. These measures include:\n              </p>\n              <ul className=\"list-disc pl-6 space-y-2\">\n                <li>Encrypted connections (HTTPS/SSL)</li>\n                <li>Secure session management</li>\n                <li>Password hashing with bcrypt</li>\n                <li>Regular security updates and monitoring</li>\n              </ul>\n              <p>\n                However, no method of transmission over the internet is 100% secure. While we strive to protect your information, we cannot guarantee absolute security.\n              </p>\n            </CardContent>\n          </Card>\n\n          {/* 8. Your Rights */}\n          <Card>\n            <CardHeader>\n              <CardTitle>8. Your Rights and Choices</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4 text-sm text-muted-foreground\">\n              <p>\n                <strong>8.1 Access and Correction:</strong> You may access and update your account information through your profile settings.\n              </p>\n              <p>\n                <strong>8.2 Data Deletion:</strong> Due to the public nature of booking data and legal retention requirements, we cannot delete all your data upon request. However, you may request deletion of your account and personal details by contacting us.\n              </p>\n              <p>\n                <strong>8.3 Push Notifications:</strong> You can disable push notifications at any time through your browser settings.\n              </p>\n              <p>\n                <strong>8.4 Marketing Communications:</strong> You can opt out of promotional emails by clicking the unsubscribe link in any marketing email.\n              </p>\n            </CardContent>\n          </Card>\n\n          {/* 9. Cookies and Tracking */}\n          <Card>\n            <CardHeader>\n              <CardTitle>9. Cookies and Tracking Technologies</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4 text-sm text-muted-foreground\">\n              <p>\n                We use cookies and similar tracking technologies to:\n              </p>\n              <ul className=\"list-disc pl-6 space-y-2\">\n                <li>Maintain user sessions and authentication</li>\n                <li>Remember user preferences (e.g., theme settings)</li>\n                <li>Analyze platform usage and performance</li>\n              </ul>\n              <p>\n                You can control cookies through your browser settings, but disabling cookies may affect platform functionality.\n              </p>\n            </CardContent>\n          </Card>\n\n          {/* 10. Children's Privacy */}\n          <Card>\n            <CardHeader>\n              <CardTitle>10. Children's Privacy</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4 text-sm text-muted-foreground\">\n              <p>\n                Washapp.ae is not intended for use by children under the age of 18. We do not knowingly collect personal information from children. If you believe we have collected information from a child, please contact us immediately.\n              </p>\n            </CardContent>\n          </Card>\n\n          {/* 11. International Users */}\n          <Card>\n            <CardHeader>\n              <CardTitle>11. International Data Transfers</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4 text-sm text-muted-foreground\">\n              <p>\n                Washapp.ae operates in the United Arab Emirates. If you access the Platform from outside the UAE, your information may be transferred to and processed in the UAE, which may have different data protection laws than your jurisdiction.\n              </p>\n            </CardContent>\n          </Card>\n\n          {/* 12. Changes to Privacy Policy */}\n          <Card>\n            <CardHeader>\n              <CardTitle>12. Changes to This Privacy Policy</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4 text-sm text-muted-foreground\">\n              <p>\n                We may update this Privacy Policy from time to time. Changes will be effective immediately upon posting to the Platform. We will notify you of significant changes via email or prominent notice on the Platform. Your continued use after changes constitutes acceptance of the updated Privacy Policy.\n              </p>\n            </CardContent>\n          </Card>\n\n          {/* 13. Contact Us */}\n          <Card>\n            <CardHeader>\n              <CardTitle>13. Contact Us</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4 text-sm text-muted-foreground\">\n              <p>\n                If you have questions, concerns, or requests regarding this Privacy Policy or your personal information, please contact us through the Platform's support channels or at the contact information provided on our website.\n              </p>\n            </CardContent>\n          </Card>\n        </div>\n\n        {/* Footer */}\n        <div className=\"mt-12 text-center\">\n          <p className=\"text-sm text-muted-foreground\">\n            By using Washapp.ae, you acknowledge that you have read and understood this Privacy Policy, including the public nature of booking data.\n          </p>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":15263,"size_tokens":null},"client/src/pages/terms.tsx":{"content":"import { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { AlertTriangle } from \"lucide-react\";\n\nexport default function Terms() {\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-blue-50 via-white to-indigo-50 dark:from-gray-900 dark:via-gray-800 dark:to-gray-900\">\n      <div className=\"max-w-4xl mx-auto px-4 py-8 sm:py-12\">\n        {/* Header */}\n        <div className=\"text-center mb-8\">\n          <h1 className=\"text-3xl sm:text-4xl font-bold mb-2\">Terms and Conditions</h1>\n          <p className=\"text-muted-foreground\">Last Updated: November 23, 2025</p>\n        </div>\n\n        {/* Important Notice */}\n        <Alert className=\"mb-8 border-amber-500/50 bg-amber-50 dark:bg-amber-950/20\">\n          <AlertTriangle className=\"h-5 w-5 text-amber-600 dark:text-amber-500\" />\n          <AlertDescription className=\"text-amber-900 dark:text-amber-200\">\n            <strong>Important:</strong> Washapp.ae is a marketplace platform that connects customers with independent car wash companies. We do not provide car washing services directly and take no responsibility for damages, quality issues, or service delivery.\n          </AlertDescription>\n        </Alert>\n\n        <div className=\"space-y-6\">\n          {/* 1. Acceptance of Terms */}\n          <Card>\n            <CardHeader>\n              <CardTitle>1. Acceptance of Terms</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4 text-sm text-muted-foreground\">\n              <p>\n                By accessing or using Washapp.ae (\"the Platform\", \"we\", \"us\", or \"our\"), you agree to be bound by these Terms and Conditions. If you do not agree to these terms, please do not use the Platform.\n              </p>\n              <p>\n                These terms apply to all users including customers requesting car wash services, car wash companies, cleaners, and platform administrators.\n              </p>\n            </CardContent>\n          </Card>\n\n          {/* 2. Platform Role */}\n          <Card>\n            <CardHeader>\n              <CardTitle>2. Platform Role and Responsibilities</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4 text-sm text-muted-foreground\">\n              <p>\n                <strong>2.1 Marketplace Service:</strong> Washapp.ae operates solely as a marketplace platform that facilitates connections between customers (\"Car Wash Requesters\") and registered car washing companies (\"Service Providers\"). We are a technology intermediary and not a car wash service provider.\n              </p>\n              <p>\n                <strong>2.2 No Direct Service:</strong> We do not employ cleaners, own car wash equipment, or provide car washing services. All services are performed by independent third-party companies and their employees.\n              </p>\n              <p>\n                <strong>2.3 No Liability for Services:</strong> Washapp.ae expressly disclaims all responsibility and liability for:\n              </p>\n              <ul className=\"list-disc pl-6 space-y-2\">\n                <li>Quality, timeliness, or completion of car wash services</li>\n                <li>Damages to vehicles, property, or personal items during or after service</li>\n                <li>Actions, omissions, or negligence of service providers or their employees</li>\n                <li>Loss, theft, or damage of vehicles or belongings</li>\n                <li>Injuries or accidents occurring during service delivery</li>\n                <li>Disputes between customers and service providers</li>\n              </ul>\n              <p>\n                <strong>2.4 Platform Functions:</strong> Our role is limited to:\n              </p>\n              <ul className=\"list-disc pl-6 space-y-2\">\n                <li>Providing a booking and payment interface</li>\n                <li>Facilitating communication between parties</li>\n                <li>Processing payments and managing financial transactions</li>\n                <li>Maintaining user accounts and service area information</li>\n              </ul>\n            </CardContent>\n          </Card>\n\n          {/* 3. User Responsibilities */}\n          <Card>\n            <CardHeader>\n              <CardTitle>3. User Responsibilities</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4 text-sm text-muted-foreground\">\n              <p>\n                <strong>3.1 Customers:</strong> By booking a car wash, you acknowledge that:\n              </p>\n              <ul className=\"list-disc pl-6 space-y-2\">\n                <li>You are entering into a direct service agreement with the car wash company, not Washapp.ae</li>\n                <li>You are responsible for removing valuables from your vehicle before service</li>\n                <li>You accept all risks associated with the service</li>\n                <li>You will resolve disputes directly with the service provider</li>\n                <li>The location and car details you provide are accurate</li>\n              </ul>\n              <p>\n                <strong>3.2 Service Providers:</strong> By registering as a company, you acknowledge that:\n              </p>\n              <ul className=\"list-disc pl-6 space-y-2\">\n                <li>You are an independent business and not an employee or agent of Washapp.ae</li>\n                <li>You maintain all necessary licenses, insurance, and permits to operate</li>\n                <li>You are solely responsible for service quality and customer satisfaction</li>\n                <li>You will handle customer complaints, disputes, and refunds independently</li>\n                <li>You carry appropriate liability insurance for damages or injuries</li>\n              </ul>\n            </CardContent>\n          </Card>\n\n          {/* 4. Payments and Fees */}\n          <Card>\n            <CardHeader>\n              <CardTitle>4. Payments and Fees</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4 text-sm text-muted-foreground\">\n              <p>\n                <strong>4.1 Customer Payments:</strong> All payments are processed through Stripe. The total amount includes the car wash company's service price, platform fee, and applicable VAT. Payments are non-refundable except as specified in Section 5.\n              </p>\n              <p>\n                <strong>4.2 Platform Fees:</strong> We charge service providers a platform fee based on their selected package (Custom, Package 1, or Package 2). Fee structures are determined during registration and may be updated by platform administrators.\n              </p>\n              <p>\n                <strong>4.3 Withdrawals:</strong> Service providers may request withdrawals subject to minimum balance requirements. Withdrawals are processed manually by administrators within 2-3 business days.\n              </p>\n            </CardContent>\n          </Card>\n\n          {/* 5. Cancellations and Refunds */}\n          <Card>\n            <CardHeader>\n              <CardTitle>5. Cancellations and Refunds</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4 text-sm text-muted-foreground\">\n              <p>\n                <strong>5.1 Auto-Refund:</strong> If no cleaner accepts a job within 15 minutes of payment, the booking is automatically cancelled and a full refund is issued.\n              </p>\n              <p>\n                <strong>5.2 Post-Acceptance:</strong> Once a cleaner accepts a job, cancellations and refunds are at the sole discretion of the service provider. Washapp.ae does not mediate or process refund requests after job acceptance.\n              </p>\n              <p>\n                <strong>5.3 Disputes:</strong> All service-related disputes must be resolved directly between the customer and service provider. We do not arbitrate disputes or force refunds.\n              </p>\n            </CardContent>\n          </Card>\n\n          {/* 6. Limitation of Liability */}\n          <Card>\n            <CardHeader>\n              <CardTitle>6. Limitation of Liability</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4 text-sm text-muted-foreground\">\n              <p>\n                <strong>6.1 Maximum Liability:</strong> To the fullest extent permitted by law, Washapp.ae's total liability for any claims arising from use of the Platform shall not exceed the amount of platform fees collected from the relevant transaction.\n              </p>\n              <p>\n                <strong>6.2 No Consequential Damages:</strong> We shall not be liable for any indirect, incidental, special, consequential, or punitive damages, including loss of profits, data, use, goodwill, or other intangible losses.\n              </p>\n              <p>\n                <strong>6.3 Service Provider Actions:</strong> We are not liable for the acts, errors, omissions, representations, warranties, breaches, or negligence of any service provider or for any personal injuries, death, property damage, or other damages resulting from their services.\n              </p>\n            </CardContent>\n          </Card>\n\n          {/* 7. Indemnification */}\n          <Card>\n            <CardHeader>\n              <CardTitle>7. Indemnification</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4 text-sm text-muted-foreground\">\n              <p>\n                You agree to indemnify, defend, and hold harmless Washapp.ae, its officers, directors, employees, and agents from any claims, liabilities, damages, losses, and expenses (including legal fees) arising from:\n              </p>\n              <ul className=\"list-disc pl-6 space-y-2\">\n                <li>Your use of the Platform</li>\n                <li>Your violation of these Terms</li>\n                <li>Services provided by or to you through the Platform</li>\n                <li>Any damage or injury resulting from car wash services</li>\n              </ul>\n            </CardContent>\n          </Card>\n\n          {/* 8. Account and Data */}\n          <Card>\n            <CardHeader>\n              <CardTitle>8. Account and Data</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4 text-sm text-muted-foreground\">\n              <p>\n                <strong>8.1 Account Security:</strong> You are responsible for maintaining the confidentiality of your account credentials and for all activities under your account.\n              </p>\n              <p>\n                <strong>8.2 Accurate Information:</strong> You agree to provide accurate, current, and complete information during registration and booking.\n              </p>\n              <p>\n                <strong>8.3 Data Usage:</strong> By using the Platform, you consent to the collection and use of your data as described in our Privacy Policy.\n              </p>\n            </CardContent>\n          </Card>\n\n          {/* 9. Intellectual Property */}\n          <Card>\n            <CardHeader>\n              <CardTitle>9. Intellectual Property</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4 text-sm text-muted-foreground\">\n              <p>\n                All content, features, and functionality on the Platform, including but not limited to text, graphics, logos, and software, are owned by Washapp.ae and protected by copyright, trademark, and other intellectual property laws.\n              </p>\n            </CardContent>\n          </Card>\n\n          {/* 10. Termination */}\n          <Card>\n            <CardHeader>\n              <CardTitle>10. Termination</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4 text-sm text-muted-foreground\">\n              <p>\n                We reserve the right to suspend or terminate your access to the Platform at any time, without notice, for conduct that we believe violates these Terms or is harmful to other users, us, or third parties, or for any other reason.\n              </p>\n            </CardContent>\n          </Card>\n\n          {/* 11. Governing Law */}\n          <Card>\n            <CardHeader>\n              <CardTitle>11. Governing Law</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4 text-sm text-muted-foreground\">\n              <p>\n                These Terms shall be governed by and construed in accordance with the laws of the United Arab Emirates. Any disputes arising from these Terms or use of the Platform shall be subject to the exclusive jurisdiction of the courts of the UAE.\n              </p>\n            </CardContent>\n          </Card>\n\n          {/* 12. Changes to Terms */}\n          <Card>\n            <CardHeader>\n              <CardTitle>12. Changes to Terms</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4 text-sm text-muted-foreground\">\n              <p>\n                We reserve the right to modify these Terms at any time. Changes will be effective immediately upon posting to the Platform. Your continued use of the Platform after changes constitutes acceptance of the modified Terms.\n              </p>\n            </CardContent>\n          </Card>\n\n          {/* 13. Contact */}\n          <Card>\n            <CardHeader>\n              <CardTitle>13. Contact Information</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4 text-sm text-muted-foreground\">\n              <p>\n                If you have questions about these Terms, please contact us through the Platform's support channels or email us at the contact information provided on our website.\n              </p>\n            </CardContent>\n          </Card>\n        </div>\n\n        {/* Footer */}\n        <div className=\"mt-12 text-center\">\n          <p className=\"text-sm text-muted-foreground\">\n            By using Washapp.ae, you acknowledge that you have read, understood, and agree to be bound by these Terms and Conditions.\n          </p>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":14121,"size_tokens":null},"client/src/pages/about.tsx":{"content":"import { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Accordion, AccordionContent, AccordionItem, AccordionTrigger } from \"@/components/ui/accordion\";\nimport { Car, Building2, MapPin, CreditCard, CheckCircle2, Users, Shield, Clock, Smartphone, Monitor, ChevronRight } from \"lucide-react\";\nimport { motion } from \"framer-motion\";\nimport { useInView } from \"framer-motion\";\nimport { useRef } from \"react\";\n\nfunction AnimatedSection({ children, delay = 0 }: { children: React.ReactNode; delay?: number }) {\n  const ref = useRef(null);\n  const isInView = useInView(ref, { once: true, margin: \"-100px\" });\n\n  return (\n    <motion.div\n      ref={ref}\n      initial={{ opacity: 0, y: 50 }}\n      animate={isInView ? { opacity: 1, y: 0 } : { opacity: 0, y: 50 }}\n      transition={{ duration: 0.6, delay, ease: \"easeOut\" }}\n    >\n      {children}\n    </motion.div>\n  );\n}\n\nexport default function About() {\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-blue-50 via-white to-indigo-50 dark:from-gray-900 dark:via-gray-800 dark:to-gray-900\">\n      <div className=\"max-w-6xl mx-auto px-4 py-8 sm:py-12\">\n        {/* Header */}\n        <motion.div\n          className=\"text-center mb-16\"\n          initial={{ opacity: 0, scale: 0.9 }}\n          animate={{ opacity: 1, scale: 1 }}\n          transition={{ duration: 0.8, ease: \"easeOut\" }}\n        >\n          <motion.h1\n            className=\"text-4xl sm:text-6xl font-bold bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent mb-4\"\n            initial={{ opacity: 0, y: -20 }}\n            animate={{ opacity: 1, y: 0 }}\n            transition={{ duration: 0.6, delay: 0.2 }}\n          >\n            Washapp.ae\n          </motion.h1>\n          <motion.p\n            className=\"text-lg text-muted-foreground max-w-2xl mx-auto\"\n            initial={{ opacity: 0 }}\n            animate={{ opacity: 1 }}\n            transition={{ duration: 0.6, delay: 0.4 }}\n          >\n            Your trusted platform connecting car owners with professional car wash companies across the UAE\n          </motion.p>\n        </motion.div>\n\n        {/* Mobile App Showcase */}\n        <AnimatedSection>\n          <div className=\"mb-16\">\n            <div className=\"text-center mb-8\">\n              <h2 className=\"text-3xl font-bold mb-3 flex items-center justify-center gap-2\">\n                <Smartphone className=\"w-8 h-8 text-blue-600\" />\n                Mobile Booking Experience\n              </h2>\n              <p className=\"text-muted-foreground\">Book a car wash in just 4 simple steps</p>\n            </div>\n\n            <div className=\"grid md:grid-cols-4 gap-6\">\n              {[\n                {\n                  step: 1,\n                  title: \"Email Verification\",\n                  desc: \"Verify your email with OTP or skip to enter manually\",\n                  icon: \"📧\",\n                  color: \"from-blue-500 to-blue-600\"\n                },\n                {\n                  step: 2,\n                  title: \"Car Details\",\n                  desc: \"Plate number, type, make & color with smart auto-fill\",\n                  icon: \"🚗\",\n                  color: \"from-indigo-500 to-indigo-600\"\n                },\n                {\n                  step: 3,\n                  title: \"Location\",\n                  desc: \"Pick location & choose company\",\n                  icon: \"📍\",\n                  color: \"from-purple-500 to-purple-600\"\n                },\n                {\n                  step: 4,\n                  title: \"Payment\",\n                  desc: \"Secure payment with Stripe\",\n                  icon: \"💳\",\n                  color: \"from-emerald-500 to-emerald-600\"\n                }\n              ].map((item, idx) => (\n                <motion.div\n                  key={item.step}\n                  initial={{ opacity: 0, y: 20 }}\n                  animate={{ opacity: 1, y: 0 }}\n                  transition={{ duration: 0.5, delay: 0.6 + idx * 0.1 }}\n                >\n                  <Card className=\"relative overflow-hidden hover-elevate h-full\">\n                    <div className={`absolute top-0 right-0 w-32 h-32 bg-gradient-to-br ${item.color} opacity-10 rounded-full blur-2xl`} />\n                    <CardHeader>\n                      <div className=\"flex items-center gap-3 mb-2\">\n                        <div className={`w-12 h-12 rounded-full bg-gradient-to-br ${item.color} text-white flex items-center justify-center font-bold text-lg shadow-lg`}>\n                          {item.step}\n                        </div>\n                        <div className=\"text-4xl\">{item.icon}</div>\n                      </div>\n                      <CardTitle className=\"text-lg\">{item.title}</CardTitle>\n                      <CardDescription>{item.desc}</CardDescription>\n                    </CardHeader>\n                  </Card>\n                </motion.div>\n              ))}\n            </div>\n\n            {/* Mobile App Preview Mockup */}\n            <motion.div\n              className=\"mt-12 p-8 rounded-2xl bg-gradient-to-br from-blue-100 to-indigo-100 dark:from-blue-950/30 dark:to-indigo-950/30 border-2 border-blue-200 dark:border-blue-800\"\n              initial={{ opacity: 0, scale: 0.95 }}\n              animate={{ opacity: 1, scale: 1 }}\n              transition={{ duration: 0.6, delay: 0.8 }}\n            >\n              <div className=\"flex flex-col md:flex-row items-center gap-8\">\n                <div className=\"flex-1\">\n                  <h3 className=\"text-2xl font-bold mb-4\">Mobile-First Design</h3>\n                  <ul className=\"space-y-3\">\n                    <li className=\"flex items-start gap-3\">\n                      <CheckCircle2 className=\"w-5 h-5 text-emerald-600 flex-shrink-0 mt-0.5\" />\n                      <span className=\"text-sm\">Email/OTP verification with smart auto-fill for returning customers</span>\n                    </li>\n                    <li className=\"flex items-start gap-3\">\n                      <CheckCircle2 className=\"w-5 h-5 text-emerald-600 flex-shrink-0 mt-0.5\" />\n                      <span className=\"text-sm\">Interactive map for precise location selection</span>\n                    </li>\n                    <li className=\"flex items-start gap-3\">\n                      <CheckCircle2 className=\"w-5 h-5 text-emerald-600 flex-shrink-0 mt-0.5\" />\n                      <span className=\"text-sm\">Real-time job tracking with push notifications</span>\n                    </li>\n                    <li className=\"flex items-start gap-3\">\n                      <CheckCircle2 className=\"w-5 h-5 text-emerald-600 flex-shrink-0 mt-0.5\" />\n                      <span className=\"text-sm\">Progressive Web App - install on your home screen</span>\n                    </li>\n                  </ul>\n                </div>\n                <div className=\"w-64 h-96 bg-white dark:bg-gray-800 rounded-3xl shadow-2xl border-8 border-gray-800 dark:border-gray-600 overflow-hidden relative\">\n                  <div className=\"absolute top-0 inset-x-0 h-6 bg-gray-800 dark:bg-gray-900 flex items-center justify-center\">\n                    <div className=\"w-24 h-4 bg-gray-900 dark:bg-black rounded-full\" />\n                  </div>\n                  <div className=\"pt-8 px-4 h-full bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-gray-900 dark:to-gray-800\">\n                    <div className=\"space-y-4\">\n                      <div className=\"h-12 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-lg flex items-center justify-center text-white font-bold text-sm\">\n                        Washapp.ae\n                      </div>\n                      <div className=\"space-y-2\">\n                        <div className=\"h-10 bg-white dark:bg-gray-700 rounded-lg shadow\" />\n                        <div className=\"h-20 bg-white dark:bg-gray-700 rounded-lg shadow\" />\n                        <div className=\"h-32 bg-gradient-to-br from-blue-100 to-indigo-100 dark:from-blue-950/50 dark:to-indigo-950/50 rounded-lg shadow\" />\n                      </div>\n                      <div className=\"h-12 bg-gradient-to-r from-emerald-500 to-teal-600 rounded-lg shadow-lg\" />\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </motion.div>\n          </div>\n        </AnimatedSection>\n\n        {/* Company Platform Desktop Showcase */}\n        <AnimatedSection delay={0.2}>\n          <div className=\"mb-16\">\n            <div className=\"text-center mb-8\">\n              <h2 className=\"text-3xl font-bold mb-3 flex items-center justify-center gap-2\">\n                <Monitor className=\"w-8 h-8 text-indigo-600\" />\n                Company Management Platform\n              </h2>\n              <p className=\"text-muted-foreground\">Full-featured desktop dashboard for car wash companies</p>\n            </div>\n\n            {/* Desktop Dashboard Mockup */}\n            <Card className=\"overflow-hidden\">\n              <div className=\"bg-gradient-to-br from-gray-800 to-gray-900 dark:from-gray-950 dark:to-black p-2\">\n                <div className=\"bg-white dark:bg-gray-800 rounded-lg overflow-hidden shadow-2xl\">\n                  {/* Browser Chrome */}\n                  <div className=\"bg-gray-100 dark:bg-gray-700 px-4 py-2 flex items-center gap-2 border-b\">\n                    <div className=\"flex gap-1.5\">\n                      <div className=\"w-3 h-3 rounded-full bg-red-500\" />\n                      <div className=\"w-3 h-3 rounded-full bg-yellow-500\" />\n                      <div className=\"w-3 h-3 rounded-full bg-green-500\" />\n                    </div>\n                    <div className=\"flex-1 mx-4 bg-white dark:bg-gray-600 rounded px-3 py-1 text-xs text-muted-foreground\">\n                      https://washapp.ae/company\n                    </div>\n                  </div>\n\n                  {/* Dashboard Content */}\n                  <div className=\"p-6 space-y-6\">\n                    {/* Header */}\n                    <div className=\"flex items-center justify-between pb-4 border-b\">\n                      <div>\n                        <h3 className=\"text-xl font-bold bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent\">\n                          Company Dashboard\n                        </h3>\n                        <p className=\"text-xs text-muted-foreground\">Manage your car wash business</p>\n                      </div>\n                      <div className=\"flex gap-2\">\n                        <div className=\"w-8 h-8 rounded bg-gradient-to-br from-blue-500 to-indigo-600\" />\n                        <div className=\"w-8 h-8 rounded bg-gradient-to-br from-purple-500 to-pink-600\" />\n                      </div>\n                    </div>\n\n                    {/* Stats Grid */}\n                    <div className=\"grid grid-cols-4 gap-4\">\n                      {[\n                        { label: \"Active Jobs\", value: \"12\", color: \"from-blue-500 to-blue-600\" },\n                        { label: \"Revenue\", value: \"AED 5.2K\", color: \"from-emerald-500 to-emerald-600\" },\n                        { label: \"Cleaners\", value: \"8\", color: \"from-purple-500 to-purple-600\" },\n                        { label: \"Completed\", value: \"156\", color: \"from-indigo-500 to-indigo-600\" }\n                      ].map((stat) => (\n                        <div key={stat.label} className=\"p-3 rounded-lg bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-700 dark:to-gray-800 border\">\n                          <div className={`w-10 h-10 rounded-lg bg-gradient-to-br ${stat.color} mb-2`} />\n                          <div className=\"text-lg font-bold\">{stat.value}</div>\n                          <div className=\"text-xs text-muted-foreground\">{stat.label}</div>\n                        </div>\n                      ))}\n                    </div>\n\n                    {/* Feature Sections */}\n                    <div className=\"grid md:grid-cols-2 gap-4\">\n                      <div className=\"p-4 rounded-lg border bg-card space-y-2\">\n                        <div className=\"flex items-center gap-2 text-sm font-semibold\">\n                          <MapPin className=\"w-4 h-4 text-blue-600\" />\n                          Service Areas\n                        </div>\n                        <div className=\"space-y-1\">\n                          <div className=\"h-2 bg-gradient-to-r from-blue-500 to-blue-300 rounded w-3/4\" />\n                          <div className=\"h-2 bg-gradient-to-r from-indigo-500 to-indigo-300 rounded w-full\" />\n                          <div className=\"h-2 bg-gradient-to-r from-purple-500 to-purple-300 rounded w-1/2\" />\n                        </div>\n                      </div>\n\n                      <div className=\"p-4 rounded-lg border bg-card space-y-2\">\n                        <div className=\"flex items-center gap-2 text-sm font-semibold\">\n                          <Users className=\"w-4 h-4 text-indigo-600\" />\n                          Cleaner Management\n                        </div>\n                        <div className=\"flex gap-1\">\n                          {[1, 2, 3, 4, 5].map((i) => (\n                            <div key={i} className=\"w-8 h-8 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600\" />\n                          ))}\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </Card>\n\n            {/* Company Features List */}\n            <div className=\"mt-8 grid md:grid-cols-3 gap-6\">\n              {[\n                {\n                  icon: <MapPin className=\"w-6 h-6\" />,\n                  title: \"Geofence Management\",\n                  desc: \"Define multiple service areas with custom boundaries\",\n                  color: \"from-blue-500 to-blue-600\"\n                },\n                {\n                  icon: <Users className=\"w-6 h-6\" />,\n                  title: \"Cleaner Invitations\",\n                  desc: \"Invite and manage cleaners with area assignments\",\n                  color: \"from-indigo-500 to-indigo-600\"\n                },\n                {\n                  icon: <CreditCard className=\"w-6 h-6\" />,\n                  title: \"Financial Reports\",\n                  desc: \"Track revenue, withdrawals, and transaction history\",\n                  color: \"from-purple-500 to-purple-600\"\n                },\n                {\n                  icon: <Shield className=\"w-6 h-6\" />,\n                  title: \"Trade License Verification\",\n                  desc: \"Secure registration with document upload\",\n                  color: \"from-emerald-500 to-emerald-600\"\n                },\n                {\n                  icon: <Clock className=\"w-6 h-6\" />,\n                  title: \"Real-Time Job Tracking\",\n                  desc: \"Monitor active jobs and cleaner locations\",\n                  color: \"from-teal-500 to-teal-600\"\n                },\n                {\n                  icon: <CheckCircle2 className=\"w-6 h-6\" />,\n                  title: \"Photo Verification\",\n                  desc: \"Review before/after photos for quality assurance\",\n                  color: \"from-cyan-500 to-cyan-600\"\n                }\n              ].map((feature, idx) => (\n                <motion.div\n                  key={feature.title}\n                  initial={{ opacity: 0, y: 20 }}\n                  whileInView={{ opacity: 1, y: 0 }}\n                  transition={{ duration: 0.5, delay: idx * 0.1 }}\n                  viewport={{ once: true }}\n                >\n                  <Card className=\"hover-elevate h-full\">\n                    <CardHeader>\n                      <div className={`w-12 h-12 rounded-lg bg-gradient-to-br ${feature.color} text-white flex items-center justify-center mb-3 shadow-lg`}>\n                        {feature.icon}\n                      </div>\n                      <CardTitle className=\"text-base\">{feature.title}</CardTitle>\n                      <CardDescription className=\"text-sm\">{feature.desc}</CardDescription>\n                    </CardHeader>\n                  </Card>\n                </motion.div>\n              ))}\n            </div>\n          </div>\n        </AnimatedSection>\n\n        {/* How It Works Section */}\n        <AnimatedSection delay={0.3}>\n          <Card className=\"mb-8\">\n            <CardHeader>\n              <CardTitle className=\"text-2xl flex items-center gap-2\">\n                <Users className=\"w-6 h-6 text-primary\" />\n                How It Works\n              </CardTitle>\n              <CardDescription>\n                Washapp.ae is a marketplace that connects car wash requesters with verified car washing companies\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-6\">\n              {/* For Customers */}\n              <div>\n                <h3 className=\"text-lg font-semibold mb-4 flex items-center gap-2\">\n                  <Car className=\"w-5 h-5 text-blue-600\" />\n                  For Car Owners\n                </h3>\n                <div className=\"grid gap-4\">\n                  {[\n                    {\n                      num: 1,\n                      title: \"Verify Your Email (Optional)\",\n                      desc: \"Enter your email and verify with OTP code to unlock smart auto-fill. Or skip this step and enter details manually.\",\n                      color: \"from-blue-500 to-indigo-600\"\n                    },\n                    {\n                      num: 2,\n                      title: \"Enter Car Details\",\n                      desc: \"Provide your car plate number, type, make, and color. If email verified, returning customers get auto-fill benefits.\",\n                      color: \"from-blue-500 to-indigo-600\"\n                    },\n                    {\n                      num: 3,\n                      title: \"Choose Location & Company\",\n                      desc: \"Select your car's location on the interactive map. We'll show you available companies in your area with their pricing.\",\n                      color: \"from-blue-500 to-indigo-600\"\n                    },\n                    {\n                      num: 4,\n                      title: \"Pay Securely\",\n                      desc: \"Complete payment via Stripe (card, Apple Pay, or Google Pay). Your booking is confirmed instantly.\",\n                      color: \"from-blue-500 to-indigo-600\"\n                    },\n                    {\n                      num: \"✓\",\n                      title: \"Track Your Service\",\n                      desc: \"A cleaner will be assigned to your job. Track the progress in real-time and receive push notifications and photo proof when completed.\",\n                      color: \"from-emerald-500 to-teal-600\"\n                    }\n                  ].map((step, idx) => (\n                    <motion.div\n                      key={idx}\n                      className=\"flex gap-4\"\n                      initial={{ opacity: 0, x: -20 }}\n                      whileInView={{ opacity: 1, x: 0 }}\n                      transition={{ duration: 0.5, delay: idx * 0.1 }}\n                      viewport={{ once: true }}\n                    >\n                      <div className={`flex-shrink-0 w-10 h-10 rounded-full bg-gradient-to-br ${step.color} text-white flex items-center justify-center font-semibold`}>\n                        {step.num}\n                      </div>\n                      <div>\n                        <h4 className=\"font-medium mb-1\">{step.title}</h4>\n                        <p className=\"text-sm text-muted-foreground\">{step.desc}</p>\n                      </div>\n                    </motion.div>\n                  ))}\n                </div>\n              </div>\n\n              {/* For Companies */}\n              <div className=\"pt-6 border-t\">\n                <h3 className=\"text-lg font-semibold mb-4 flex items-center gap-2\">\n                  <Building2 className=\"w-5 h-5 text-indigo-600\" />\n                  For Car Wash Companies\n                </h3>\n                <div className=\"grid gap-4\">\n                  {[\n                    {\n                      num: 1,\n                      title: \"Register Your Company\",\n                      desc: \"Sign up with your company details and upload your trade license. Admin will review and approve your account.\"\n                    },\n                    {\n                      num: 2,\n                      title: \"Define Service Areas\",\n                      desc: \"Set up geofences for areas where you operate. Only customers in these areas will see your company.\"\n                    },\n                    {\n                      num: 3,\n                      title: \"Invite Cleaners\",\n                      desc: \"Send email invitations to your cleaners. Assign them to specific service areas or all areas.\"\n                    },\n                    {\n                      num: 4,\n                      title: \"Receive Jobs\",\n                      desc: \"When customers book in your service areas, your on-duty cleaners receive notifications instantly.\"\n                    },\n                    {\n                      num: \"💰\",\n                      title: \"Get Paid\",\n                      desc: \"Earnings accumulate in your account. Request withdrawals anytime, processed manually by admin.\"\n                    }\n                  ].map((step, idx) => (\n                    <motion.div\n                      key={idx}\n                      className=\"flex gap-4\"\n                      initial={{ opacity: 0, x: -20 }}\n                      whileInView={{ opacity: 1, x: 0 }}\n                      transition={{ duration: 0.5, delay: idx * 0.1 }}\n                      viewport={{ once: true }}\n                    >\n                      <div className=\"flex-shrink-0 w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 text-white flex items-center justify-center font-semibold\">\n                        {step.num}\n                      </div>\n                      <div>\n                        <h4 className=\"font-medium mb-1\">{step.title}</h4>\n                        <p className=\"text-sm text-muted-foreground\">{step.desc}</p>\n                      </div>\n                    </motion.div>\n                  ))}\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </AnimatedSection>\n\n        {/* Features */}\n        <AnimatedSection delay={0.4}>\n          <div className=\"grid sm:grid-cols-2 gap-6 mb-8\">\n            {[\n              {\n                icon: <MapPin className=\"w-5 h-5\" />,\n                title: \"Location-Based Matching\",\n                desc: \"We use smart geofencing to match you with companies that operate in your area. No more searching through unavailable providers.\",\n                color: \"text-blue-600\"\n              },\n              {\n                icon: <Shield className=\"w-5 h-5\" />,\n                title: \"Secure Payments\",\n                desc: \"All payments are processed securely through Stripe. Your financial information is never stored on our servers.\",\n                color: \"text-emerald-600\"\n              },\n              {\n                icon: <Clock className=\"w-5 h-5\" />,\n                title: \"Real-Time Updates\",\n                desc: \"Track your car wash in real-time with push notifications. Know exactly when a cleaner is assigned and when the job is done.\",\n                color: \"text-indigo-600\"\n              },\n              {\n                icon: <CheckCircle2 className=\"w-5 h-5\" />,\n                title: \"Photo Verification\",\n                desc: \"Every completed job includes before and after photos, so you have proof that your car was washed professionally.\",\n                color: \"text-teal-600\"\n              }\n            ].map((feature, idx) => (\n              <motion.div\n                key={feature.title}\n                initial={{ opacity: 0, scale: 0.95 }}\n                whileInView={{ opacity: 1, scale: 1 }}\n                transition={{ duration: 0.5, delay: idx * 0.1 }}\n                viewport={{ once: true }}\n              >\n                <Card className=\"hover-elevate h-full\">\n                  <CardHeader>\n                    <CardTitle className={`text-lg flex items-center gap-2 ${feature.color}`}>\n                      {feature.icon}\n                      {feature.title}\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <p className=\"text-sm text-muted-foreground\">{feature.desc}</p>\n                  </CardContent>\n                </Card>\n              </motion.div>\n            ))}\n          </div>\n        </AnimatedSection>\n\n        {/* FAQs */}\n        <AnimatedSection delay={0.5}>\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"text-2xl\">Frequently Asked Questions</CardTitle>\n              <CardDescription>Common questions from customers and companies</CardDescription>\n            </CardHeader>\n            <CardContent>\n              <Accordion type=\"single\" collapsible className=\"w-full\">\n                {/* Customer FAQs */}\n                <AccordionItem value=\"faq-1\" data-testid=\"faq-payment\">\n                  <AccordionTrigger>How do I pay for a car wash?</AccordionTrigger>\n                  <AccordionContent>\n                    We accept all major credit cards, Apple Pay, and Google Pay through our secure Stripe payment gateway. Payment is required upfront when you book a car wash. The total includes the company's car wash price, platform fee, and VAT.\n                  </AccordionContent>\n                </AccordionItem>\n\n                <AccordionItem value=\"faq-2\" data-testid=\"faq-cancellation\">\n                  <AccordionTrigger>Can I cancel or get a refund?</AccordionTrigger>\n                  <AccordionContent>\n                    If no cleaner accepts your job within 15 minutes, you'll automatically receive a full refund. Once a cleaner accepts your job, cancellations may not be possible. For disputes or issues, please contact the car wash company directly.\n                  </AccordionContent>\n                </AccordionItem>\n\n                <AccordionItem value=\"faq-3\" data-testid=\"faq-tracking\">\n                  <AccordionTrigger>How do I track my car wash?</AccordionTrigger>\n                  <AccordionContent>\n                    After payment, you'll be redirected to a tracking page. You can also access it anytime by searching with your phone number or car plate number. You'll see real-time status updates: Paid → Assigned → In Progress → Completed.\n                  </AccordionContent>\n                </AccordionItem>\n\n                <AccordionItem value=\"faq-4\" data-testid=\"faq-areas\">\n                  <AccordionTrigger>What areas do you serve?</AccordionTrigger>\n                  <AccordionContent>\n                    Service areas depend on the car wash companies registered on our platform. When you select your location on the map, we'll show you all companies that operate in your area. If no companies appear, it means no providers are currently available in your location.\n                  </AccordionContent>\n                </AccordionItem>\n\n                <AccordionItem value=\"faq-5\" data-testid=\"faq-notification\">\n                  <AccordionTrigger>Will I receive notifications?</AccordionTrigger>\n                  <AccordionContent>\n                    Yes! Enable push notifications in your browser to receive real-time updates when a cleaner is assigned to your job and when your car wash is completed.\n                  </AccordionContent>\n                </AccordionItem>\n\n                {/* Company FAQs */}\n                <AccordionItem value=\"faq-6\" data-testid=\"faq-fees\">\n                  <AccordionTrigger>What fees does the platform charge companies?</AccordionTrigger>\n                  <AccordionContent>\n                    We offer three fee packages: Custom (admin-set flat fee + 5% VAT), Package 1 (2 AED base + 5% of wash price + 5% VAT), and Package 2 (offline mode with 5% VAT only). Your fee structure is determined during registration and can be updated by admin.\n                  </AccordionContent>\n                </AccordionItem>\n\n                <AccordionItem value=\"faq-7\" data-testid=\"faq-approval\">\n                  <AccordionTrigger>How long does company approval take?</AccordionTrigger>\n                  <AccordionContent>\n                    After you register and upload your trade license, our admin team will review your application. Approval typically takes 1-2 business days. You'll receive an email notification once approved or if additional information is needed.\n                  </AccordionContent>\n                </AccordionItem>\n\n                <AccordionItem value=\"faq-8\" data-testid=\"faq-cleaners\">\n                  <AccordionTrigger>How do I add cleaners to my company?</AccordionTrigger>\n                  <AccordionContent>\n                    From your company dashboard, go to \"Cleaners\" and click \"Invite Cleaner\". Enter their email and assign them to service areas. They'll receive an invitation email to register and create their account. Once registered, they can start accepting jobs.\n                  </AccordionContent>\n                </AccordionItem>\n\n                <AccordionItem value=\"faq-9\" data-testid=\"faq-geofence\">\n                  <AccordionTrigger>What are service areas (geofences)?</AccordionTrigger>\n                  <AccordionContent>\n                    Service areas are geographic zones where your company operates. You can create multiple named areas by drawing boundaries on a map. Only customers within these boundaries will see your company as an option. You can assign cleaners to specific areas or all areas.\n                  </AccordionContent>\n                </AccordionItem>\n\n                <AccordionItem value=\"faq-10\" data-testid=\"faq-withdrawal\">\n                  <AccordionTrigger>How do I withdraw my earnings?</AccordionTrigger>\n                  <AccordionContent>\n                    Go to your Financial Reports page and click \"Request Withdrawal\". Enter the amount you want to withdraw (minimum 100 AED). Admin will manually process your request and transfer funds to your registered bank account within 2-3 business days.\n                  </AccordionContent>\n                </AccordionItem>\n\n                <AccordionItem value=\"faq-11\" data-testid=\"faq-pricing\">\n                  <AccordionTrigger>Can I change my car wash pricing?</AccordionTrigger>\n                  <AccordionContent>\n                    Yes! From your company settings, you can update your car wash price anytime. The new price will apply to all future bookings. Note that the platform fee structure is managed by admin and varies by package.\n                  </AccordionContent>\n                </AccordionItem>\n\n                <AccordionItem value=\"faq-12\" data-testid=\"faq-support\">\n                  <AccordionTrigger>What if I have an issue with a customer?</AccordionTrigger>\n                  <AccordionContent>\n                    As a marketplace platform, we connect customers with companies but don't mediate disputes. You are responsible for handling customer service, refunds, and any issues that arise during service delivery. We recommend maintaining professional communication and resolving issues promptly.\n                  </AccordionContent>\n                </AccordionItem>\n              </Accordion>\n            </CardContent>\n          </Card>\n        </AnimatedSection>\n\n        {/* Call to Action */}\n        <AnimatedSection delay={0.6}>\n          <motion.div\n            className=\"mt-12 text-center p-8 rounded-2xl bg-gradient-to-r from-blue-600 to-indigo-600 text-white\"\n            whileHover={{ scale: 1.02 }}\n            transition={{ duration: 0.3 }}\n          >\n            <h3 className=\"text-2xl font-bold mb-3\">Ready to get started?</h3>\n            <p className=\"mb-6 opacity-90\">Join thousands of satisfied customers and car wash companies</p>\n            <div className=\"flex flex-col sm:flex-row gap-4 justify-center\">\n              <motion.a\n                href=\"/customer/booking\"\n                className=\"inline-flex items-center justify-center h-12 px-8 font-medium rounded-lg bg-white text-blue-600 hover:bg-gray-100 transition-colors shadow-lg\"\n                data-testid=\"link-book-wash\"\n                whileHover={{ scale: 1.05 }}\n                whileTap={{ scale: 0.95 }}\n              >\n                Book a Car Wash\n                <ChevronRight className=\"w-4 h-4 ml-2\" />\n              </motion.a>\n              <motion.a\n                href=\"/company/register\"\n                className=\"inline-flex items-center justify-center h-12 px-8 font-medium rounded-lg border-2 border-white text-white hover:bg-white/10 transition-colors\"\n                data-testid=\"link-register-company\"\n                whileHover={{ scale: 1.05 }}\n                whileTap={{ scale: 0.95 }}\n              >\n                Register as Company\n                <ChevronRight className=\"w-4 h-4 ml-2\" />\n              </motion.a>\n            </div>\n          </motion.div>\n        </AnimatedSection>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":33339,"size_tokens":null},"client/src/components/footer.tsx":{"content":"import { Link } from \"wouter\";\n\nexport function Footer() {\n  return (\n    <footer className=\"border-t bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60\">\n      <div className=\"max-w-7xl mx-auto px-4 py-6\">\n        <div className=\"flex flex-col sm:flex-row items-center justify-between gap-4\">\n          {/* Logo/Brand */}\n          <div className=\"text-center sm:text-left\">\n            <h3 className=\"font-bold text-lg bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent\">\n              Washapp.ae\n            </h3>\n            <p className=\"text-xs text-muted-foreground mt-1\">\n              Your trusted car wash marketplace\n            </p>\n          </div>\n\n          {/* Links */}\n          <nav className=\"flex flex-wrap items-center justify-center gap-4 sm:gap-6\">\n            <Link \n              href=\"/about\" \n              className=\"text-sm text-muted-foreground hover:text-foreground transition-colors\" \n              data-testid=\"link-about\"\n            >\n              About\n            </Link>\n            <Link \n              href=\"/terms\" \n              className=\"text-sm text-muted-foreground hover:text-foreground transition-colors\" \n              data-testid=\"link-terms\"\n            >\n              Terms\n            </Link>\n            <Link \n              href=\"/privacy\" \n              className=\"text-sm text-muted-foreground hover:text-foreground transition-colors\" \n              data-testid=\"link-privacy\"\n            >\n              Privacy\n            </Link>\n          </nav>\n\n          {/* Copyright */}\n          <div className=\"text-xs text-muted-foreground text-center sm:text-right\">\n            © {new Date().getFullYear()} Washapp.ae\n          </div>\n        </div>\n      </div>\n    </footer>\n  );\n}\n","path":null,"size_bytes":1790,"size_tokens":null},"server/autoShiftTimeoutService.ts":{"content":"import { db } from \"./db\";\nimport { cleaners, cleanerShifts } from \"@shared/schema\";\nimport { eq, and, lt, isNull, or } from \"drizzle-orm\";\n\nconst TEN_MINUTES_MS = 10 * 60 * 1000;\n\nexport async function checkAndEndStaleShifts() {\n  try {\n    const tenMinutesAgo = new Date(Date.now() - TEN_MINUTES_MS);\n    \n    // Find all ON_DUTY cleaners whose location hasn't been updated in 10+ minutes OR is NULL\n    const staleCleaners = await db.select()\n      .from(cleaners)\n      .where(\n        and(\n          eq(cleaners.status, 'on_duty'),\n          or(\n            isNull(cleaners.lastLocationUpdate),\n            lt(cleaners.lastLocationUpdate, tenMinutesAgo)\n          )\n        )\n      );\n\n    if (staleCleaners.length === 0) {\n      return;\n    }\n\n    console.log(`[Auto-Shift-Timeout] Found ${staleCleaners.length} cleaners with stale location (>10 min)`);\n\n    for (const cleaner of staleCleaners) {\n      try {\n        // Find active shift\n        const [activeShift] = await db.select()\n          .from(cleanerShifts)\n          .where(\n            and(\n              eq(cleanerShifts.cleanerId, cleaner.id),\n              isNull(cleanerShifts.shiftEnd)\n            )\n          )\n          .limit(1);\n\n        if (!activeShift) {\n          console.log(`[Auto-Shift-Timeout] Cleaner ${cleaner.id} has no active shift, setting OFF_DUTY`);\n          // No active shift but status is ON_DUTY - just fix status\n          await db.update(cleaners)\n            .set({ status: 'off_duty' })\n            .where(eq(cleaners.id, cleaner.id));\n          continue;\n        }\n\n        // End the shift automatically - use transaction to ensure consistency\n        const now = new Date();\n        const shiftDuration = Math.floor((now.getTime() - new Date(activeShift.shiftStart).getTime()) / (1000 * 60));\n        \n        await db.transaction(async (tx) => {\n          // Update shift record\n          await tx.update(cleanerShifts)\n            .set({\n              shiftEnd: now,\n              durationMinutes: shiftDuration,\n              endLatitude: cleaner.currentLatitude,\n              endLongitude: cleaner.currentLongitude,\n            })\n            .where(eq(cleanerShifts.id, activeShift.id));\n\n          // Set cleaner status to OFF_DUTY\n          await tx.update(cleaners)\n            .set({ status: 'off_duty' })\n            .where(eq(cleaners.id, cleaner.id));\n        });\n\n        const lastUpdate = cleaner.lastLocationUpdate \n          ? new Date(cleaner.lastLocationUpdate).toLocaleString('en-AE', { timeZone: 'Asia/Dubai' })\n          : 'never';\n\n        console.log(\n          `[Auto-Shift-Timeout] Ended shift ${activeShift.id} for cleaner ${cleaner.id} ` +\n          `(last location update: ${lastUpdate})`\n        );\n      } catch (error) {\n        console.error(`[Auto-Shift-Timeout] Error ending shift for cleaner ${cleaner.id}:`, error);\n      }\n    }\n  } catch (error) {\n    console.error('[Auto-Shift-Timeout] Error in checkAndEndStaleShifts:', error);\n  }\n}\n\nlet intervalId: NodeJS.Timeout | null = null;\n\nexport function startAutoShiftTimeoutService() {\n  if (intervalId) {\n    console.log('[Auto-Shift-Timeout] Service already running');\n    return;\n  }\n\n  // Run every minute\n  intervalId = setInterval(checkAndEndStaleShifts, 60 * 1000);\n  console.log('[Auto-Shift-Timeout] Service started - checking every minute');\n}\n\nexport function stopAutoShiftTimeoutService() {\n  if (intervalId) {\n    clearInterval(intervalId);\n    intervalId = null;\n    console.log('[Auto-Shift-Timeout] Service stopped');\n  }\n}\n","path":null,"size_bytes":3532,"size_tokens":null},"client/src/pages/cleaner-tips.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { format } from \"date-fns\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { DollarSign, Calendar, Receipt, Car } from \"lucide-react\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { PaginationControls } from \"@/components/PaginationControls\";\n\ninterface TipRecord {\n  jobId: number;\n  completedAt: string;\n  carPlateNumber: string;\n  customerEmail: string;\n  tipAmount: string;\n  cleanerStripeFeeShare: string;\n  remainingTip: string;\n  receiptNumber: string | null;\n}\n\ninterface TipsResponse {\n  tips: TipRecord[];\n  total: number;\n  summary: {\n    totalTips: number;\n    totalStripeFees: number;\n    totalReceived: number;\n    count: number;\n  };\n}\n\nexport default function CleanerTips() {\n  const { currentUser } = useAuth();\n  const [startDate, setStartDate] = useState(\"\");\n  const [endDate, setEndDate] = useState(\"\");\n  const [page, setPage] = useState(1);\n  const pageSize = 20;\n\n  // Construct query string\n  const queryParams = new URLSearchParams();\n  if (startDate) queryParams.append(\"startDate\", startDate);\n  if (endDate) queryParams.append(\"endDate\", endDate);\n  queryParams.append(\"page\", page.toString());\n  queryParams.append(\"pageSize\", pageSize.toString());\n  const queryString = queryParams.toString();\n\n  const { data, isLoading, refetch } = useQuery<TipsResponse>({\n    queryKey: [\"/api/cleaner/tips\", page, queryString],\n    enabled: !!currentUser,\n    staleTime: 0,\n  });\n\n  const totalPages = data ? Math.ceil(data.total / pageSize) : 0;\n\n  const handleFilter = () => {\n    setPage(1);\n    refetch();\n  };\n\n  const handleClearFilter = () => {\n    setStartDate(\"\");\n    setEndDate(\"\");\n    setPage(1);\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-primary/5 via-background to-background pb-24 pt-4 px-4\">\n      <div className=\"max-w-4xl mx-auto space-y-4\">\n        {/* Header */}\n        <div className=\"text-center mb-6\">\n          <h1 className=\"text-3xl font-bold bg-gradient-to-r from-primary to-primary/60 bg-clip-text text-transparent\">\n            My Tips\n          </h1>\n          <p className=\"text-muted-foreground mt-2\">\n            Track your earnings from customer tips\n          </p>\n        </div>\n\n        {/* Filter Section */}\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Calendar className=\"w-5 h-5\" />\n              Filter by Date\n            </CardTitle>\n            <CardDescription>Select a date range to view tips</CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"startDate\">From Date</Label>\n                <Input\n                  id=\"startDate\"\n                  type=\"date\"\n                  data-testid=\"input-start-date\"\n                  value={startDate}\n                  onChange={(e) => setStartDate(e.target.value)}\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"endDate\">To Date</Label>\n                <Input\n                  id=\"endDate\"\n                  type=\"date\"\n                  data-testid=\"input-end-date\"\n                  value={endDate}\n                  onChange={(e) => setEndDate(e.target.value)}\n                />\n              </div>\n            </div>\n            <div className=\"flex gap-2\">\n              <Button onClick={handleFilter} data-testid=\"button-filter\" className=\"flex-1\">\n                Apply Filter\n              </Button>\n              {(startDate || endDate) && (\n                <Button\n                  variant=\"outline\"\n                  onClick={handleClearFilter}\n                  data-testid=\"button-clear-filter\"\n                >\n                  Clear\n                </Button>\n              )}\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Summary Cards */}\n        {isLoading ? (\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n            {[1, 2, 3].map((i) => (\n              <Card key={i}>\n                <CardHeader>\n                  <Skeleton className=\"h-4 w-24\" />\n                </CardHeader>\n                <CardContent>\n                  <Skeleton className=\"h-8 w-32\" />\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        ) : data ? (\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n            <Card>\n              <CardHeader className=\"pb-3\">\n                <CardTitle className=\"text-sm font-medium text-muted-foreground\">\n                  Total Tips\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"flex items-baseline gap-2\">\n                  <span className=\"text-3xl font-bold\" data-testid=\"text-total-tips\">\n                    {data.summary.totalTips.toFixed(2)}\n                  </span>\n                  <span className=\"text-muted-foreground\">AED</span>\n                </div>\n                <p className=\"text-sm text-muted-foreground mt-1\">\n                  {data.summary.count} {data.summary.count === 1 ? 'job' : 'jobs'}\n                </p>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader className=\"pb-3\">\n                <CardTitle className=\"text-sm font-medium text-muted-foreground\">\n                  Stripe Fees\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"flex items-baseline gap-2\">\n                  <span className=\"text-3xl font-bold\" data-testid=\"text-stripe-fees\">\n                    {data.summary.totalStripeFees.toFixed(2)}\n                  </span>\n                  <span className=\"text-muted-foreground\">AED</span>\n                </div>\n                <p className=\"text-sm text-muted-foreground mt-1\">\n                  Processing fees\n                </p>\n              </CardContent>\n            </Card>\n\n            <Card className=\"border-primary/20 bg-primary/5\">\n              <CardHeader className=\"pb-3\">\n                <CardTitle className=\"text-sm font-medium text-primary flex items-center gap-2\">\n                  <DollarSign className=\"w-4 h-4\" />\n                  You Received\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"flex items-baseline gap-2\">\n                  <span className=\"text-3xl font-bold text-primary\" data-testid=\"text-total-received\">\n                    {data.summary.totalReceived.toFixed(2)}\n                  </span>\n                  <span className=\"text-muted-foreground\">AED</span>\n                </div>\n                <p className=\"text-sm text-muted-foreground mt-1\">\n                  Net earnings\n                </p>\n              </CardContent>\n            </Card>\n          </div>\n        ) : null}\n\n        {/* Tips List */}\n        <Card>\n          <CardHeader>\n            <CardTitle>Tip History</CardTitle>\n            <CardDescription>\n              {data?.tips.length === 0\n                ? \"No tips found for the selected period\"\n                : `${data?.tips.length || 0} tips received`}\n            </CardDescription>\n          </CardHeader>\n          <CardContent>\n            {isLoading ? (\n              <div className=\"space-y-3\">\n                {[1, 2, 3].map((i) => (\n                  <Skeleton key={i} className=\"h-24 w-full\" />\n                ))}\n              </div>\n            ) : data && data.tips.length > 0 ? (\n              <div className=\"space-y-3\">\n                {data.tips.map((tip) => (\n                  <Card\n                    key={tip.jobId}\n                    className=\"border-l-4 border-l-primary/40\"\n                    data-testid={`card-tip-${tip.jobId}`}\n                  >\n                    <CardContent className=\"pt-4\">\n                      <div className=\"flex flex-col md:flex-row md:items-center md:justify-between gap-3\">\n                        <div className=\"space-y-1\">\n                          <div className=\"flex items-center gap-2\">\n                            <Car className=\"w-4 h-4 text-muted-foreground\" />\n                            <span className=\"font-medium\" data-testid={`text-plate-${tip.jobId}`}>\n                              {tip.carPlateNumber}\n                            </span>\n                          </div>\n                          <div className=\"text-sm text-muted-foreground\">\n                            {format(new Date(tip.completedAt), \"MMM dd, yyyy 'at' h:mm a\")}\n                          </div>\n                          {tip.receiptNumber && (\n                            <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                              <Receipt className=\"w-3 h-3\" />\n                              {tip.receiptNumber}\n                            </div>\n                          )}\n                        </div>\n\n                        <div className=\"grid grid-cols-3 gap-4 md:gap-6 text-center md:text-right\">\n                          <div>\n                            <div className=\"text-xs text-muted-foreground\">Tip</div>\n                            <div className=\"font-semibold\" data-testid={`text-tip-amount-${tip.jobId}`}>\n                              {Number(tip.tipAmount).toFixed(2)} AED\n                            </div>\n                          </div>\n                          <div>\n                            <div className=\"text-xs text-muted-foreground\">Fee</div>\n                            <div className=\"font-semibold text-destructive\">\n                              -{Number(tip.cleanerStripeFeeShare).toFixed(2)} AED\n                            </div>\n                          </div>\n                          <div>\n                            <div className=\"text-xs text-muted-foreground\">Received</div>\n                            <div className=\"font-bold text-primary\" data-testid={`text-received-${tip.jobId}`}>\n                              {Number(tip.remainingTip).toFixed(2)} AED\n                            </div>\n                          </div>\n                        </div>\n                      </div>\n                    </CardContent>\n                  </Card>\n                ))}\n              </div>\n            ) : (\n              <div className=\"text-center py-12\">\n                <DollarSign className=\"w-12 h-12 text-muted-foreground/40 mx-auto mb-3\" />\n                <p className=\"text-muted-foreground\">\n                  {startDate || endDate\n                    ? \"No tips found for the selected date range\"\n                    : \"You haven't received any tips yet\"}\n                </p>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n\n        {/* Pagination Controls */}\n        {data && data.tips.length > 0 && (\n          <PaginationControls\n            currentPage={page}\n            totalPages={totalPages}\n            onPageChange={setPage}\n            className=\"mt-4\"\n          />\n        )}\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":11461,"size_tokens":null},"client/src/components/PaginationControls.tsx":{"content":"import {\n  Pagination,\n  PaginationContent,\n  PaginationEllipsis,\n  PaginationItem,\n  PaginationLink,\n  PaginationNext,\n  PaginationPrevious,\n} from \"@/components/ui/pagination\";\n\ninterface PaginationControlsProps {\n  currentPage: number;\n  totalPages: number;\n  onPageChange: (page: number) => void;\n  className?: string;\n}\n\nexport function PaginationControls({\n  currentPage,\n  totalPages,\n  onPageChange,\n  className,\n}: PaginationControlsProps) {\n  if (totalPages <= 1) return null;\n\n  const handlePageChange = (page: number, e: React.MouseEvent) => {\n    e.preventDefault();\n    if (page >= 1 && page <= totalPages && page !== currentPage) {\n      onPageChange(page);\n    }\n  };\n\n  // Generate page numbers to display\n  const getPageNumbers = () => {\n    const pages: (number | 'ellipsis')[] = [];\n    const maxVisible = 5; // Show max 5 page numbers\n\n    if (totalPages <= maxVisible + 2) {\n      // Show all pages if total is small\n      for (let i = 1; i <= totalPages; i++) {\n        pages.push(i);\n      }\n    } else {\n      // Always show first page\n      pages.push(1);\n\n      if (currentPage > 3) {\n        pages.push('ellipsis');\n      }\n\n      // Show pages around current page\n      const start = Math.max(2, currentPage - 1);\n      const end = Math.min(totalPages - 1, currentPage + 1);\n\n      for (let i = start; i <= end; i++) {\n        pages.push(i);\n      }\n\n      if (currentPage < totalPages - 2) {\n        pages.push('ellipsis');\n      }\n\n      // Always show last page\n      pages.push(totalPages);\n    }\n\n    return pages;\n  };\n\n  const pages = getPageNumbers();\n\n  return (\n    <Pagination className={className} data-testid=\"pagination-controls\">\n      <PaginationContent>\n        <PaginationItem>\n          <PaginationPrevious\n            href=\"#\"\n            onClick={(e) => handlePageChange(currentPage - 1, e)}\n            className={currentPage === 1 ? 'pointer-events-none opacity-50' : ''}\n            data-testid=\"pagination-previous\"\n          />\n        </PaginationItem>\n\n        {pages.map((page, index) => (\n          <PaginationItem key={index}>\n            {page === 'ellipsis' ? (\n              <PaginationEllipsis />\n            ) : (\n              <PaginationLink\n                href=\"#\"\n                onClick={(e) => handlePageChange(page, e)}\n                isActive={currentPage === page}\n                data-testid={`pagination-page-${page}`}\n              >\n                {page}\n              </PaginationLink>\n            )}\n          </PaginationItem>\n        ))}\n\n        <PaginationItem>\n          <PaginationNext\n            href=\"#\"\n            onClick={(e) => handlePageChange(currentPage + 1, e)}\n            className={currentPage === totalPages ? 'pointer-events-none opacity-50' : ''}\n            data-testid=\"pagination-next\"\n          />\n        </PaginationItem>\n      </PaginationContent>\n    </Pagination>\n  );\n}\n","path":null,"size_bytes":2886,"size_tokens":null},"client/src/pages/customer-qr-payment.tsx":{"content":"import { useEffect, useState } from \"react\";\nimport { useRoute, useLocation } from \"wouter\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Loader2, CheckCircle, XCircle } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\n\nexport default function CustomerQRPayment() {\n  const [, params] = useRoute(\"/customer/pay/:token\");\n  const [, setLocation] = useLocation();\n  const token = params?.token;\n  const { toast } = useToast();\n  const [isValidToken, setIsValidToken] = useState<boolean | null>(null);\n  const [processingPayment, setProcessingPayment] = useState(false);\n\n  const { data: tokenData, isLoading, error } = useQuery<{\n    token: string;\n    companyId: number;\n    companyName: string;\n    cleanerId: number;\n    cleanerName: string;\n    expiresAt: string;\n  }>({\n    queryKey: [\"/api/customer/payment-token\", token],\n    enabled: !!token,\n  });\n\n  // Fetch company details to get price\n  const { data: companyData } = useQuery<{\n    id: number;\n    name: string;\n    pricePerWash: string;\n    feePackageType: string;\n  }>({\n    queryKey: [\"/api/companies\", tokenData?.companyId],\n    enabled: !!tokenData?.companyId,\n  });\n\n  useEffect(() => {\n    if (error) {\n      setIsValidToken(false);\n      toast({\n        variant: \"destructive\",\n        title: \"Invalid Token\",\n        description: \"This payment link is invalid or has expired.\",\n      });\n    } else if (tokenData) {\n      setIsValidToken(true);\n    }\n  }, [error, tokenData, toast]);\n\n  // Auto-redirect to checkout when data is ready\n  useEffect(() => {\n    if (tokenData && companyData && !processingPayment) {\n      setProcessingPayment(true);\n      \n      // Create anonymous customer with minimal data\n      fetch(\"/api/customer/by-phone\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ phoneNumber: `QR-${Date.now()}` }),\n      })\n        .then(res => res.json())\n        .then(customer => {\n          // Parse price as number (comes as string from numeric column)\n          const price = parseFloat(companyData.pricePerWash) || 0;\n          \n          // Build minimal job data for checkout\n          const jobData = {\n            carPlateEmirate: \"Anonymous\",\n            carPlateCode: \"QR\",\n            carPlateNumber: `${Date.now()}`,\n            parkingNumber: \"\",\n            customerPhone: `QR-${Date.now()}`,\n            customerEmail: customer.email || \"\",\n            locationAddress: \"On-site (QR Payment)\",\n            locationLatitude: 0,\n            locationLongitude: 0,\n            companyId: tokenData.companyId,\n            customerId: customer.id,\n            price: price,\n            tipAmount: 0,\n          };\n\n          // Store in sessionStorage for checkout\n          sessionStorage.setItem(\"pendingJob\", JSON.stringify(jobData));\n\n          // Redirect to checkout with token\n          setLocation(`/customer/checkout?token=${token}`);\n        })\n        .catch(err => {\n          console.error(\"Error processing QR payment:\", err);\n          toast({\n            variant: \"destructive\",\n            title: \"Error\",\n            description: \"Failed to process payment request\",\n          });\n          setProcessingPayment(false);\n        });\n    }\n  }, [tokenData, companyData, token, processingPayment, setLocation, toast]);\n\n  if (!token) {\n    return (\n      <div className=\"min-h-screen bg-background flex items-center justify-center p-4\">\n        <Card className=\"w-full max-w-md\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2 text-destructive\">\n              <XCircle className=\"h-6 w-6\" />\n              Invalid Link\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <p className=\"text-muted-foreground\">This payment link is invalid.</p>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  if (isLoading || processingPayment) {\n    return (\n      <div className=\"min-h-screen bg-background flex items-center justify-center p-4\">\n        <Card className=\"w-full max-w-md\">\n          <CardContent className=\"flex flex-col items-center justify-center p-8\">\n            <Loader2 className=\"h-12 w-12 animate-spin text-primary mb-4\" />\n            <p className=\"text-muted-foreground\">\n              {processingPayment ? \"Preparing payment...\" : \"Verifying payment link...\"}\n            </p>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  if (isValidToken === false || !tokenData) {\n    return (\n      <div className=\"min-h-screen bg-background flex items-center justify-center p-4\">\n        <Card className=\"w-full max-w-md\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2 text-destructive\">\n              <XCircle className=\"h-6 w-6\" />\n              Invalid or Expired\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <p className=\"text-muted-foreground mb-4\">\n              This payment link is either invalid, has been used, or has expired.\n            </p>\n            <p className=\"text-sm text-muted-foreground\">\n              Please ask the cleaner for a new payment link.\n            </p>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-primary/5 via-background to-primary/10 flex items-center justify-center p-4\">\n      <Card className=\"w-full max-w-md shadow-lg\">\n        <CardHeader className=\"text-center\">\n          <div className=\"flex justify-center mb-4\">\n            <CheckCircle className=\"h-16 w-16 text-primary\" />\n          </div>\n          <CardTitle className=\"text-2xl\">Redirecting to Payment</CardTitle>\n        </CardHeader>\n        <CardContent className=\"flex flex-col items-center justify-center p-8\">\n          <Loader2 className=\"h-12 w-12 animate-spin text-primary mb-4\" />\n          <p className=\"text-muted-foreground text-center\">\n            Loading payment details for {tokenData.cleanerName} from {tokenData.companyName}...\n          </p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":6181,"size_tokens":null},"client/src/pages/company-live-report.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Link } from \"wouter\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Button } from \"@/components/ui/button\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Activity, MapPin, DollarSign, RefreshCw, ArrowLeft, Users, Briefcase } from \"lucide-react\";\nimport { Cleaner } from \"@shared/schema\";\n\ninterface LiveReportData {\n  liveCleaners: number;\n  activeLocations: number;\n  revenueToday: number;\n  tipsToday: number;\n  netToday: number;\n  completedJobsToday: number;\n  refundedJobsToday: number;\n  pendingJobsToday: number;\n  cleanerDetails: Array<{\n    id: number;\n    name: string;\n    email: string;\n    status: string;\n    currentLocation: { lat: number; lng: number } | null;\n    lastLocationUpdate: Date | null;\n    jobsCompletedToday: number;\n  }>;\n}\n\nexport default function CompanyLiveReport() {\n  const [selectedCleanerId, setSelectedCleanerId] = useState<number | null>(null);\n  const [autoRefresh, setAutoRefresh] = useState(false);\n\n  const { data: cleaners } = useQuery<Cleaner[]>({\n    queryKey: [\"/api/company/cleaners\"],\n  });\n\n  const { data: liveReport, isLoading: loadingReport, refetch } = useQuery<LiveReportData>({\n    queryKey: [\"/api/company/live-report\", selectedCleanerId],\n    queryFn: async () => {\n      const params = selectedCleanerId ? `?cleanerId=${selectedCleanerId}` : \"\";\n      const response = await fetch(`/api/company/live-report${params}`, {\n        credentials: \"include\",\n      });\n      if (!response.ok) throw new Error(\"Failed to fetch live report\");\n      return response.json();\n    },\n    refetchInterval: autoRefresh ? 30000 : false,\n  });\n\n  return (\n    <div className=\"min-h-screen bg-background p-4 pb-20\">\n      <div className=\"max-w-6xl mx-auto\">\n        <div className=\"mb-6 pt-4 flex items-start justify-between gap-4\">\n          <div className=\"flex items-center gap-4\">\n            <Link href=\"/company\">\n              <Button variant=\"ghost\" size=\"icon\" data-testid=\"button-back\">\n                <ArrowLeft className=\"h-5 w-5\" />\n              </Button>\n            </Link>\n            <div>\n              <h1 className=\"text-2xl font-bold text-foreground mb-1\">Live Report</h1>\n              <p className=\"text-muted-foreground\">Real-time operations overview</p>\n            </div>\n          </div>\n        </div>\n\n        <div className=\"space-y-6\">\n          <div className=\"flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between\">\n            <div className=\"flex items-center gap-4\">\n              <Select\n                value={selectedCleanerId?.toString() || \"all\"}\n                onValueChange={(val) => setSelectedCleanerId(val === \"all\" ? null : parseInt(val))}\n              >\n                <SelectTrigger className=\"w-[200px]\" data-testid=\"select-cleaner-filter\">\n                  <SelectValue placeholder=\"All Cleaners\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">All Cleaners</SelectItem>\n                  {cleaners?.map((cleaner: any) => (\n                    <SelectItem key={cleaner.id} value={cleaner.id.toString()}>\n                      {cleaner.displayName || cleaner.email || `Cleaner #${cleaner.id}`}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={() => refetch()}\n                data-testid=\"button-refresh-report\"\n              >\n                <RefreshCw className=\"h-4 w-4 mr-2\" />\n                Refresh\n              </Button>\n              <Button\n                variant={autoRefresh ? \"default\" : \"outline\"}\n                size=\"sm\"\n                onClick={() => setAutoRefresh(!autoRefresh)}\n                data-testid=\"button-auto-refresh\"\n              >\n                {autoRefresh ? \"Auto-Refresh ON\" : \"Auto-Refresh OFF\"}\n              </Button>\n            </div>\n          </div>\n\n          {loadingReport ? (\n            <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n              {[...Array(8)].map((_, i) => (\n                <Card key={i}>\n                  <CardHeader className=\"p-4\">\n                    <Skeleton className=\"h-4 w-20\" />\n                    <Skeleton className=\"h-6 w-12 mt-2\" />\n                  </CardHeader>\n                </Card>\n              ))}\n            </div>\n          ) : liveReport ? (\n            <>\n              <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n                <Card className=\"bg-gradient-to-br from-green-500/10 to-green-600/5 border-green-500/20\">\n                  <CardHeader className=\"p-4\">\n                    <CardDescription className=\"flex items-center gap-1\">\n                      <Activity className=\"h-4 w-4\" />\n                      Live Cleaners\n                    </CardDescription>\n                    <CardTitle className=\"text-2xl text-green-600 dark:text-green-400\" data-testid=\"text-live-cleaners\">\n                      {liveReport.liveCleaners}\n                    </CardTitle>\n                  </CardHeader>\n                </Card>\n                \n                <Card className=\"bg-gradient-to-br from-blue-500/10 to-blue-600/5 border-blue-500/20\">\n                  <CardHeader className=\"p-4\">\n                    <CardDescription className=\"flex items-center gap-1\">\n                      <MapPin className=\"h-4 w-4\" />\n                      Active Locations\n                    </CardDescription>\n                    <CardTitle className=\"text-2xl text-blue-600 dark:text-blue-400\" data-testid=\"text-active-locations\">\n                      {liveReport.activeLocations}\n                    </CardTitle>\n                  </CardHeader>\n                </Card>\n                \n                <Card className=\"bg-gradient-to-br from-emerald-500/10 to-emerald-600/5 border-emerald-500/20\">\n                  <CardHeader className=\"p-4\">\n                    <CardDescription className=\"flex items-center gap-1\">\n                      <DollarSign className=\"h-4 w-4\" />\n                      Revenue Today\n                    </CardDescription>\n                    <CardTitle className=\"text-2xl text-emerald-600 dark:text-emerald-400\" data-testid=\"text-revenue-today\">\n                      {liveReport.revenueToday.toFixed(2)} AED\n                    </CardTitle>\n                  </CardHeader>\n                </Card>\n                \n                <Card className=\"bg-gradient-to-br from-purple-500/10 to-purple-600/5 border-purple-500/20\">\n                  <CardHeader className=\"p-4\">\n                    <CardDescription className=\"flex items-center gap-1\">\n                      <DollarSign className=\"h-4 w-4\" />\n                      Net (excl. Tips)\n                    </CardDescription>\n                    <CardTitle className=\"text-2xl text-purple-600 dark:text-purple-400\" data-testid=\"text-net-today\">\n                      {liveReport.netToday.toFixed(2)} AED\n                    </CardTitle>\n                  </CardHeader>\n                </Card>\n                \n                <Card>\n                  <CardHeader className=\"p-4\">\n                    <CardDescription>Tips Today</CardDescription>\n                    <CardTitle className=\"text-2xl\" data-testid=\"text-tips-today\">\n                      {liveReport.tipsToday.toFixed(2)} AED\n                    </CardTitle>\n                  </CardHeader>\n                </Card>\n                \n                <Card className=\"bg-gradient-to-br from-green-500/10 to-green-600/5 border-green-500/20\">\n                  <CardHeader className=\"p-4\">\n                    <CardDescription className=\"flex items-center gap-1\">\n                      <Briefcase className=\"h-4 w-4\" />\n                      Completed Jobs\n                    </CardDescription>\n                    <CardTitle className=\"text-2xl text-green-600 dark:text-green-400\" data-testid=\"text-completed-jobs\">\n                      {liveReport.completedJobsToday}\n                    </CardTitle>\n                  </CardHeader>\n                </Card>\n                \n                <Card className=\"bg-gradient-to-br from-yellow-500/10 to-yellow-600/5 border-yellow-500/20\">\n                  <CardHeader className=\"p-4\">\n                    <CardDescription>Pending Jobs</CardDescription>\n                    <CardTitle className=\"text-2xl text-yellow-600 dark:text-yellow-400\" data-testid=\"text-pending-jobs\">\n                      {liveReport.pendingJobsToday}\n                    </CardTitle>\n                  </CardHeader>\n                </Card>\n                \n                <Card className=\"bg-gradient-to-br from-red-500/10 to-red-600/5 border-red-500/20\">\n                  <CardHeader className=\"p-4\">\n                    <CardDescription>Refunded Jobs</CardDescription>\n                    <CardTitle className=\"text-2xl text-red-600 dark:text-red-400\" data-testid=\"text-refunded-jobs\">\n                      {liveReport.refundedJobsToday}\n                    </CardTitle>\n                  </CardHeader>\n                </Card>\n              </div>\n\n              <Card>\n                <CardHeader>\n                  <CardTitle className=\"flex items-center gap-2\">\n                    <Users className=\"h-5 w-5\" />\n                    Cleaner Activity\n                  </CardTitle>\n                  <CardDescription>Your cleaners and their status today</CardDescription>\n                </CardHeader>\n                <CardContent>\n                  {liveReport.cleanerDetails.length === 0 ? (\n                    <p className=\"text-muted-foreground text-center py-4\">No cleaner data available</p>\n                  ) : (\n                    <div className=\"overflow-x-auto\">\n                      <Table>\n                        <TableHeader>\n                          <TableRow>\n                            <TableHead>Cleaner</TableHead>\n                            <TableHead>Status</TableHead>\n                            <TableHead>Jobs Today</TableHead>\n                            <TableHead>Last Location</TableHead>\n                          </TableRow>\n                        </TableHeader>\n                        <TableBody>\n                          {liveReport.cleanerDetails.map((cleaner) => (\n                            <TableRow key={cleaner.id} data-testid={`row-cleaner-${cleaner.id}`}>\n                              <TableCell>\n                                <div>\n                                  <div className=\"font-medium\">{cleaner.name}</div>\n                                  <div className=\"text-sm text-muted-foreground\">{cleaner.email}</div>\n                                </div>\n                              </TableCell>\n                              <TableCell>\n                                <span className={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${\n                                  cleaner.status === 'on_duty' \n                                    ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-100'\n                                    : cleaner.status === 'busy'\n                                    ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-100'\n                                    : 'bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-100'\n                                }`}>\n                                  {cleaner.status.replace('_', ' ')}\n                                </span>\n                              </TableCell>\n                              <TableCell>{cleaner.jobsCompletedToday}</TableCell>\n                              <TableCell>\n                                {cleaner.currentLocation ? (\n                                  <a\n                                    href={`https://www.google.com/maps?q=${cleaner.currentLocation.lat},${cleaner.currentLocation.lng}`}\n                                    target=\"_blank\"\n                                    rel=\"noopener noreferrer\"\n                                    className=\"text-primary hover:underline\"\n                                  >\n                                    View Map\n                                  </a>\n                                ) : (\n                                  <span className=\"text-muted-foreground\">No location</span>\n                                )}\n                              </TableCell>\n                            </TableRow>\n                          ))}\n                        </TableBody>\n                      </Table>\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            </>\n          ) : (\n            <Card>\n              <CardContent className=\"p-8 text-center text-muted-foreground\">\n                Failed to load live report data\n              </CardContent>\n            </Card>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":13352,"size_tokens":null},"client/src/pages/company-offline-jobs.tsx":{"content":"import { useState, useMemo } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Link } from \"wouter\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { ArrowLeft, Wallet, Car, Banknote, Clock, User, Search, CalendarDays, MessageCircle } from \"lucide-react\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { Cleaner } from \"@shared/schema\";\nimport { Pagination, PaginationContent, PaginationItem, PaginationLink, PaginationNext, PaginationPrevious } from \"@/components/ui/pagination\";\n\ninterface OfflineJob {\n  id: number;\n  cleanerId: number;\n  companyId: number;\n  carPlateNumber: string;\n  carPlateEmirate: string | null;\n  carPlateCode: string | null;\n  servicePrice: string;\n  vatAmount: string;\n  totalAmount: string;\n  notes: string | null;\n  createdAt: string;\n  cleanerName: string;\n}\n\ntype CleanerWithUser = Cleaner & {\n  displayName: string | null;\n  phoneNumber: string | null;\n  email: string | null;\n};\n\nexport default function CompanyOfflineJobs() {\n  const { currentUser } = useAuth();\n  const [cleanerFilter, setCleanerFilter] = useState<string>(\"all\");\n  const [startDate, setStartDate] = useState<string>(\"\");\n  const [endDate, setEndDate] = useState<string>(\"\");\n  const [page, setPage] = useState(1);\n  const pageSize = 20;\n\n  const { data: cleaners = [] } = useQuery<CleanerWithUser[]>({\n    queryKey: [\"/api/company/cleaners\"],\n    enabled: !!currentUser?.companyId,\n  });\n\n  const queryString = useMemo(() => {\n    const params = new URLSearchParams();\n    if (cleanerFilter !== \"all\") {\n      params.append(\"cleanerId\", cleanerFilter);\n    }\n    if (startDate) {\n      params.append(\"startDate\", startDate);\n    }\n    if (endDate) {\n      params.append(\"endDate\", endDate);\n    }\n    params.append(\"page\", String(page));\n    params.append(\"pageSize\", String(pageSize));\n    return params.toString();\n  }, [cleanerFilter, startDate, endDate, page]);\n\n  const { data: offlineJobsResponse, isLoading: loadingOfflineJobs } = useQuery<{ data: OfflineJob[], total: number }>({\n    queryKey: [\"/api/company/offline-jobs\", cleanerFilter, startDate, endDate, page],\n    queryFn: async () => {\n      const response = await apiRequest(\"GET\", `/api/company/offline-jobs?${queryString}`);\n      return response.json();\n    },\n    enabled: !!currentUser?.companyId,\n  });\n\n  const offlineJobs = offlineJobsResponse?.data || [];\n  const totalJobs = offlineJobsResponse?.total || 0;\n  const totalPages = Math.ceil(totalJobs / pageSize);\n\n  const totalRevenue = useMemo(() => {\n    return offlineJobs.reduce((sum, job) => sum + parseFloat(job.totalAmount), 0);\n  }, [offlineJobs]);\n\n  const totalVAT = useMemo(() => {\n    return offlineJobs.reduce((sum, job) => sum + parseFloat(job.vatAmount), 0);\n  }, [offlineJobs]);\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      <div className=\"max-w-4xl mx-auto p-4 pb-24\">\n        <div className=\"flex items-center gap-4 mb-6\">\n          <Link href=\"/company\">\n            <Button variant=\"ghost\" size=\"icon\" data-testid=\"button-back\">\n              <ArrowLeft className=\"h-5 w-5\" />\n            </Button>\n          </Link>\n          <div>\n            <h1 className=\"text-2xl font-bold\">Cash/Offline Jobs</h1>\n            <p className=\"text-muted-foreground text-sm\">Track manually recorded payments</p>\n          </div>\n        </div>\n\n        <div className=\"grid grid-cols-2 gap-4 mb-6\">\n          <Card data-testid=\"card-total-revenue\">\n            <CardContent className=\"pt-4\">\n              <div className=\"flex items-center gap-2\">\n                <Wallet className=\"h-5 w-5 text-green-600\" />\n                <div>\n                  <p className=\"text-xs text-muted-foreground\">Total Revenue</p>\n                  <p className=\"text-lg font-bold\" data-testid=\"text-total-revenue\">{totalRevenue.toFixed(2)} AED</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n          <Card data-testid=\"card-total-vat\">\n            <CardContent className=\"pt-4\">\n              <div className=\"flex items-center gap-2\">\n                <Banknote className=\"h-5 w-5 text-blue-600\" />\n                <div>\n                  <p className=\"text-xs text-muted-foreground\">Total VAT</p>\n                  <p className=\"text-lg font-bold\" data-testid=\"text-total-vat\">{totalVAT.toFixed(2)} AED</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n\n        <Card className=\"mb-6\">\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-lg flex items-center gap-2\">\n              <Search className=\"h-5 w-5\" />\n              Filters\n            </CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n              <div>\n                <label className=\"text-sm font-medium mb-2 block\">Cleaner</label>\n                <Select value={cleanerFilter} onValueChange={(val) => { setCleanerFilter(val); setPage(1); }}>\n                  <SelectTrigger data-testid=\"select-cleaner-filter\">\n                    <SelectValue placeholder=\"All Cleaners\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"all\">All Cleaners</SelectItem>\n                    {cleaners.map((cleaner) => (\n                      <SelectItem key={cleaner.id} value={String(cleaner.id)}>\n                        {cleaner.displayName || `Cleaner #${cleaner.id}`}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n              <div>\n                <label className=\"text-sm font-medium mb-2 block\">Start Date</label>\n                <Input\n                  type=\"date\"\n                  value={startDate}\n                  onChange={(e) => { setStartDate(e.target.value); setPage(1); }}\n                  data-testid=\"input-start-date\"\n                />\n              </div>\n              <div>\n                <label className=\"text-sm font-medium mb-2 block\">End Date</label>\n                <Input\n                  type=\"date\"\n                  value={endDate}\n                  onChange={(e) => { setEndDate(e.target.value); setPage(1); }}\n                  data-testid=\"input-end-date\"\n                />\n              </div>\n            </div>\n            {(cleanerFilter !== \"all\" || startDate || endDate) && (\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={() => {\n                  setCleanerFilter(\"all\");\n                  setStartDate(\"\");\n                  setEndDate(\"\");\n                  setPage(1);\n                }}\n                data-testid=\"button-clear-filters\"\n              >\n                Clear Filters\n              </Button>\n            )}\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-lg flex items-center justify-between gap-2\">\n              <span className=\"flex items-center gap-2\">\n                <CalendarDays className=\"h-5 w-5\" />\n                Recorded Jobs\n              </span>\n              <Badge variant=\"secondary\">{totalJobs} total</Badge>\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            {loadingOfflineJobs ? (\n              <div className=\"space-y-4\">\n                {[1, 2, 3].map((i) => (\n                  <Card key={i}>\n                    <CardContent className=\"pt-4\">\n                      <Skeleton className=\"h-6 w-1/2 mb-2\" />\n                      <Skeleton className=\"h-4 w-full mb-1\" />\n                      <Skeleton className=\"h-4 w-3/4\" />\n                    </CardContent>\n                  </Card>\n                ))}\n              </div>\n            ) : offlineJobs.length === 0 ? (\n              <div className=\"text-center py-12\">\n                <Wallet className=\"h-16 w-16 mx-auto text-muted-foreground mb-4 opacity-50\" />\n                <p className=\"text-muted-foreground font-medium\">No offline jobs found</p>\n                <p className=\"text-sm text-muted-foreground mt-1\">\n                  {cleanerFilter !== \"all\" || startDate || endDate \n                    ? \"Try adjusting your filters\" \n                    : \"Cleaners can record cash payments from their dashboard\"}\n                </p>\n              </div>\n            ) : (\n              <div className=\"space-y-4\">\n                {offlineJobs.map((job) => (\n                  <Card key={job.id} data-testid={`card-offline-job-${job.id}`}>\n                    <CardContent className=\"pt-4\">\n                      <div className=\"flex items-center justify-between mb-3\">\n                        <div className=\"flex items-center gap-2\">\n                          <Car className=\"h-5 w-5 text-primary\" />\n                          <span className=\"font-bold\">\n                            {job.carPlateEmirate && job.carPlateCode \n                              ? `${job.carPlateEmirate} ${job.carPlateCode} ${job.carPlateNumber}`\n                              : job.carPlateNumber}\n                          </span>\n                        </div>\n                        <Badge variant=\"secondary\" className=\"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-100\">\n                          <Banknote className=\"h-3 w-3 mr-1\" />\n                          Cash\n                        </Badge>\n                      </div>\n                      \n                      <div className=\"grid grid-cols-2 gap-2 text-sm mb-3\">\n                        <div className=\"flex items-center gap-2\">\n                          <User className=\"h-4 w-4 text-muted-foreground\" />\n                          <span>{job.cleanerName}</span>\n                        </div>\n                        <div className=\"flex items-center gap-2\">\n                          <Clock className=\"h-4 w-4 text-muted-foreground\" />\n                          <span>\n                            {new Date(job.createdAt).toLocaleString('en-AE', { \n                              timeZone: 'Asia/Dubai',\n                              dateStyle: 'short',\n                              timeStyle: 'short'\n                            })}\n                          </span>\n                        </div>\n                      </div>\n\n                      {job.notes && (\n                        <div className=\"text-sm text-muted-foreground mb-3 flex items-start gap-2\">\n                          <MessageCircle className=\"h-4 w-4 mt-0.5 flex-shrink-0\" />\n                          <span>{job.notes}</span>\n                        </div>\n                      )}\n\n                      <div className=\"flex items-center justify-between border-t pt-3 text-sm\">\n                        <div className=\"flex gap-4\">\n                          <span>Service: <strong>{job.servicePrice} AED</strong></span>\n                          <span>VAT: <strong>{job.vatAmount} AED</strong></span>\n                        </div>\n                        <span className=\"text-primary font-bold\">Total: {job.totalAmount} AED</span>\n                      </div>\n                    </CardContent>\n                  </Card>\n                ))}\n\n                {totalPages > 1 && (\n                  <div className=\"mt-6\">\n                    <Pagination>\n                      <PaginationContent>\n                        <PaginationItem>\n                          <PaginationPrevious\n                            onClick={() => setPage(Math.max(1, page - 1))}\n                            className={page <= 1 ? \"pointer-events-none opacity-50\" : \"cursor-pointer\"}\n                            data-testid=\"button-prev-page\"\n                          />\n                        </PaginationItem>\n                        {Array.from({ length: Math.min(5, totalPages) }, (_, i) => {\n                          let pageNum: number;\n                          if (totalPages <= 5) {\n                            pageNum = i + 1;\n                          } else if (page <= 3) {\n                            pageNum = i + 1;\n                          } else if (page >= totalPages - 2) {\n                            pageNum = totalPages - 4 + i;\n                          } else {\n                            pageNum = page - 2 + i;\n                          }\n                          return (\n                            <PaginationItem key={pageNum}>\n                              <PaginationLink\n                                onClick={() => setPage(pageNum)}\n                                isActive={page === pageNum}\n                                className=\"cursor-pointer\"\n                                data-testid={`button-page-${pageNum}`}\n                              >\n                                {pageNum}\n                              </PaginationLink>\n                            </PaginationItem>\n                          );\n                        })}\n                        <PaginationItem>\n                          <PaginationNext\n                            onClick={() => setPage(Math.min(totalPages, page + 1))}\n                            className={page >= totalPages ? \"pointer-events-none opacity-50\" : \"cursor-pointer\"}\n                            data-testid=\"button-next-page\"\n                          />\n                        </PaginationItem>\n                      </PaginationContent>\n                    </Pagination>\n                    <p className=\"text-center text-sm text-muted-foreground mt-2\">\n                      Page {page} of {totalPages} ({totalJobs} jobs)\n                    </p>\n                  </div>\n                )}\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":14174,"size_tokens":null}},"version":2}